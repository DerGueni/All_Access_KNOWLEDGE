<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menü 2 - Personal & Lohn</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arimo', 'Calibri', Arial, sans-serif;
            background-color: #FFFFFF;
            color: #333;
            padding: 0;
            overflow-x: hidden;
        }

        .form-container {
            width: 180px;
            background: #FFFFFF;
            position: relative;
            padding: 0;
            margin: 0;
        }

        /* Rechtecke als Container */
        .rectangle-container {
            border: 1px solid #A6A6A6;
            background: #FFFFFF;
            margin: 4px;
            padding: 8px;
            position: relative;
        }

        .rectangle-18 {
            /* Oberer Container: Vorlagen & Telefonliste */
            min-height: 170px;
        }

        .rectangle-19 {
            /* Mittlerer Container: Personal/Lohn Funktionen */
            min-height: 268px;
        }

        .rectangle-20 {
            /* Unterer Container: Abwesenheiten & Stunden */
            min-height: 210px;
        }

        /* Button Styling */
        .menu-button {
            width: 160px;
            height: 20px;
            margin: 4px 0;
            padding: 4px 8px;
            background: linear-gradient(180deg, #D9D9D9 0%, #BFBFBF 100%);
            border: none;
            border-radius: 2px;
            font-family: 'Arimo', Arial, sans-serif;
            font-size: 11px;
            color: #000000;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }

        .menu-button:hover {
            background: linear-gradient(180deg, #E6E6E6 0%, #CCCCCC 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .menu-button:active {
            background: linear-gradient(180deg, #BFBFBF 0%, #A6A6A6 100%);
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .menu-button.hidden {
            display: none;
        }

        /* Close Button */
        .close-button {
            width: 164px;
            height: 24px;
            margin: 8px 4px 4px 4px;
            background: linear-gradient(180deg, #D9D9D9 0%, #BFBFBF 100%);
            border: 1px solid #D9D9D9;
            font-weight: 600;
        }

        /* Label */
        .menu-label {
            position: absolute;
            left: 44px;
            top: 3px;
            width: 80px;
            height: 20px;
            font-size: 11px;
            color: #000000;
            background: transparent;
            border: none;
            pointer-events: none;
        }

        /* Utility Classes */
        .mt-1 { margin-top: 4px; }
        .mt-2 { margin-top: 8px; }
        .mb-1 { margin-bottom: 4px; }
    </style>
</head>
<body>
    <div class="form-container">
        <!-- Label (positioniert wie im Original) -->
        <div class="menu-label"></div>

        <!-- Rechteck 18: Oberer Bereich -->
        <div class="rectangle-container rectangle-18">
            <button type="button" class="menu-button" data-action="openForm" data-target="frmTop_neue_Vorlagen">
                Vorlagen
            </button>
            <button type="button" class="menu-button mt-1" data-action="openReport" data-target="rpt_telefonliste">
                Telefonliste
            </button>
        </div>

        <!-- Rechteck 19: Mittlerer Bereich (Personal/Lohn) -->
        <div class="rectangle-container rectangle-19">
            <button type="button" class="menu-button" data-action="openForm" data-target="zfrm_Lohnabrechnungen">
                Lohnabrechnungen
            </button>
            <button type="button" class="menu-button mt-1" data-action="openQuery" data-target="qry_MA_letzter _Einsatz_Gueni">
                Letzter Einsatz MA
            </button>
            <button type="button" class="menu-button mt-1" data-action="exportFCNMeldeliste">
                FCN Meldeliste
            </button>
            <button type="button" class="menu-button mt-1" data-action="exportNamensliste">
                Fürth Namensliste
            </button>
            <button type="button" class="menu-button mt-1" data-action="exportSubStunden">
                Sub Stunden
            </button>
            <button type="button" class="menu-button mt-1" data-action="exportMAStamm">
                Mitarbeiterstamm Excel
            </button>
            <button type="button" class="menu-button mt-1" data-action="openForm" data-target="frm_Lex_Aktiv">
                Lex Aktiv
            </button>
        </div>

        <!-- Rechteck 20: Unterer Bereich (Sync & Abwesenheiten) -->
        <div class="rectangle-container rectangle-20">
            <button type="button" class="menu-button" data-action="syncLoewensaal">
                Aufträge sync
            </button>
            <button type="button" class="menu-button mt-1" data-action="syncLoewensaalHP">
                Löwensaal Sync HP
            </button>
            <button type="button" class="menu-button mt-1" data-action="openForm" data-target="zfrm_ZK_Lohnarten_Zuschlag">
                Lohnarten
            </button>
            <button type="button" class="menu-button mt-1" data-action="openAbwesenheiten">
                Abwesenheiten
            </button>
            <button type="button" class="menu-button mt-1" data-action="openQuery" data-target="zqry_MA_VA_Stunden_Plan_Ist_aktJahr_Kreuztabelle">
                Stunden Mitarbeiter
            </button>
        </div>

        <!-- Close Button -->
        <button type="button" class="menu-button close-button" data-action="close">
            Menü 2 schliessen
        </button>
    </div>

    <script type="module">
        // Bridge Client Import (wenn vorhanden)
        let Bridge = null;
        try {
            const module = await import('../api/bridgeClient.js');
            Bridge = module.Bridge;
        } catch (e) {
            console.warn('Bridge client not available:', e);
        }

        // Button Event Handlers
        document.addEventListener('click', async (e) => {
            const button = e.target.closest('.menu-button');
            if (!button) return;

            const action = button.dataset.action;
            const target = button.dataset.target;

            try {
                switch(action) {
                    case 'openForm':
                        await openForm(target);
                        break;

                    case 'openReport':
                        await openReport(target);
                        break;

                    case 'openQuery':
                        await openQuery(target);
                        break;

                    case 'exportFCNMeldeliste':
                        await exportFCNMeldeliste();
                        break;

                    case 'exportNamensliste':
                        await exportNamensliste();
                        break;

                    case 'exportSubStunden':
                        await exportSubStunden();
                        break;

                    case 'exportMAStamm':
                        await exportMAStamm();
                        break;

                    case 'syncLoewensaal':
                        await syncLoewensaal();
                        break;

                    case 'syncLoewensaalHP':
                        await syncLoewensaalHP();
                        break;

                    case 'openAbwesenheiten':
                        await openAbwesenheiten();
                        break;

                    case 'close':
                        closeForm();
                        break;

                    default:
                        console.warn('Unknown action:', action);
                }
            } catch (error) {
                console.error('Error executing action:', action, error);
                showError(`Fehler bei ${button.textContent.trim()}: ${error.message}`);
            }
        });

        // Navigation Functions
        async function openForm(formName) {
            if (Bridge) {
                await Bridge.execute('openForm', { formName });
            } else {
                // Fallback: Nachricht an Parent/Access
                notifyAccess('OpenForm', { name: formName });
            }
        }

        async function openReport(reportName) {
            if (Bridge) {
                await Bridge.execute('openReport', { reportName, view: 'acViewPreview' });
            } else {
                notifyAccess('OpenReport', { name: reportName, view: 'acViewPreview' });
            }
        }

        async function openQuery(queryName) {
            if (Bridge) {
                await Bridge.execute('openQuery', { queryName });
            } else {
                notifyAccess('OpenQuery', { name: queryName });
            }
        }

        // Export Functions
        async function exportFCNMeldeliste() {
            // FCN Meldeliste Excel Export
            const va_id = prompt('VA_ID für FCN Meldeliste:');
            if (!va_id) return;

            if (Bridge) {
                await Bridge.execute('exportFCNMeldeliste', { va_id: parseInt(va_id) });
            } else {
                notifyAccess('ExportFCNMeldeliste', { va_id: parseInt(va_id) });
            }
        }

        async function exportNamensliste() {
            // Fürth Namensliste Excel Export
            const va_id = prompt('VA_ID für Namensliste:');
            if (!va_id) return;

            if (Bridge) {
                await Bridge.execute('exportNamensliste', { va_id: parseInt(va_id) });
            } else {
                notifyAccess('ExportNamensliste', { va_id: parseInt(va_id) });
            }
        }

        async function exportSubStunden() {
            // Sub Stunden Excel Export
            const dateiname = `Stunden_Sub_${new Date().toISOString().split('T')[0]}.xlsx`;

            if (Bridge) {
                await Bridge.execute('exportSubStunden', { dateiname });
            } else {
                notifyAccess('ExportSubStunden', { dateiname });
            }
        }

        async function exportMAStamm() {
            // Mitarbeiterstamm Excel Export
            const dateiname = `Mitarbeiterstamm_${new Date().toISOString().split('T')[0]}.xlsx`;
            const oeffnen = confirm(`Datei: ${dateiname}\nwird erstellt - direkt öffnen?`);

            if (Bridge) {
                await Bridge.execute('exportMAStamm', { dateiname, oeffnen });
            } else {
                notifyAccess('ExportMAStamm', { dateiname, oeffnen });
            }
        }

        // Sync Functions
        async function syncLoewensaal() {
            if (Bridge) {
                await Bridge.execute('syncLoewensaal', { webUpdate: false });
            } else {
                notifyAccess('SyncLoewensaal', { webUpdate: false });
            }
        }

        async function syncLoewensaalHP() {
            const confirm_sync = confirm('Möchten Sie die Löwensaal-Events von der Homepage synchronisieren?\n\nDies kann einige Sekunden dauern.');
            if (!confirm_sync) return;

            if (Bridge) {
                await Bridge.execute('syncLoewensaalHP');
            } else {
                notifyAccess('SyncLoewensaalHP');
            }
        }

        // Abwesenheiten
        async function openAbwesenheiten() {
            const jahr = prompt('Jahr:', '');

            if (jahr === null) return; // Abgebrochen

            if (jahr === '') {
                // Kein Jahr angegeben - Standard-Formular
                await openForm('frm_MA_Abwesenheiten_Urlaub_Gueni');
            } else {
                // Jahres-spezifisches Formular
                await openForm(`frm_MA_Abwesenheiten_krank_gueni_${jahr}`);
            }
        }

        // Close Form
        function closeForm() {
            if (Bridge) {
                Bridge.execute('closeForm', { formName: 'frm_Menuefuehrung1' });
            } else {
                notifyAccess('CloseForm', { name: 'frm_Menuefuehrung1' });
            }

            // Fallback: window.close()
            window.close();
        }

        // Notify Access/Parent
        function notifyAccess(command, data) {
            // PostMessage to parent window (if embedded)
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'ACCESS_COMMAND',
                    command,
                    data
                }, '*');
            }

            // Console log for debugging
            console.log('Access Command:', command, data);
        }

        // Error Display
        function showError(message) {
            alert(message);
        }

        // Initialization
        console.log('frm_Menuefuehrung1 initialized');
    </script>
</body>
</html>
