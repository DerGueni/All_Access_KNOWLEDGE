<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kundenstammblatt - CONSEC</title>
    <link rel="stylesheet" href="../css/app-layout.css">
    <link rel="stylesheet" href="../theme/consys_theme.css">
    <style>
        :root {
            --header-gray: #D0D0D0;
            --btn-beige: #D7B395;
            --btn-green: #90EE90;
            --btn-blue: #6495ED;
            --bg-white: #FFFFFF;
            --bg-gray: #F0F0F0;
            --text-dark: #000000;
            --border-gray: #A6A6A6;
            --list-width: 18%;
            --list-min-width: 250px;
            --list-max-width: 320px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-white);
        }

        .form-header {
            background: #4316B2;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 94px;
            height: 94px;
            max-height: 94px;
        }

        .nav-arrows {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #666;
            padding: 5px;
            border-radius: 3px;
        }

        .nav-arrows-row { display: flex; gap: 2px; }

        .nav-arrow {
            width: 24px;
            height: 24px;
            background: #4a4a4a;
            border: 1px solid #333;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .nav-arrow:hover { background: #5a5a5a; }

        .header-title {
            color: #fff;
            font-size: 18px;
            font-weight: bold;
        }

        .header-nav-btns {
            display: flex;
            background: #a0a0a0;
            padding: 3px;
            border-radius: 2px;
            gap: 1px;
        }

        .header-nav-btn {
            width: 22px;
            height: 22px;
            background: white;
            border: 1px solid #666;
            cursor: pointer;
            font-size: 10px;
        }

        .header-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 20px;
        }

        .header-btn {
            padding: 6px 12px;
            border: 1px solid #666;
            cursor: pointer;
            font-size: 11px;
            background: var(--btn-beige);
        }

        .header-btn.blue { background: var(--btn-blue); color: white; }
        .header-btn.delete { background: #c44; color: white; }
        .header-btn.new { background: #4a4; color: white; }

        .customer-info {
            background: var(--header-gray);
            padding: 5px 15px 10px 15px;
            display: flex;
            justify-content: center;
        }

        .customer-name-box {
            background: white;
            padding: 10px 15px;
            max-width: 600px;
            width: 100%;
            flex: 1;
        }

        .customer-firma {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .customer-contact { font-size: 14px; }

        .form-area {
            display: flex;
            flex: 1;
            position: relative;
        }

        .tab-container {
            flex: 1;
            padding: 10px;
        }

        .tab-headers {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #ccc;
            background: #e8e8e8;
        }

        .tab-header {
            padding: 6px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 2px;
            margin-bottom: -1px;
            background: #d0d0d0;
            font-size: 10px;
        }

        .tab-header.active {
            background: white;
            border-bottom: 1px solid white;
        }

        .tab-header:hover:not(.active) { background: #c0c0c0; }

        .tab-content {
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            padding: 15px;
            min-height: 450px;
        }

        .tab-page { display: none; }
        .tab-page.active { display: block; }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .form-label {
            min-width: 120px;
            width: 120px;
            font-size: 11px;
            padding-right: 10px;
            flex-shrink: 0;
        }

        .form-input {
            flex: 1;
            min-width: 0;
            height: 22px;
            border: 1px solid var(--border-gray);
            padding: 2px 5px;
            font-size: 11px;
        }

        .form-input.wide { flex: 1; max-width: none; }
        .form-input.small { width: 80px; max-width: 80px; flex: none; }

        .form-checkbox { width: 15px; height: 15px; }

        .form-select {
            flex: 1;
            min-width: 0;
            height: 22px;
            border: 1px solid var(--border-gray);
            font-size: 11px;
        }

        .two-columns { display: flex; gap: 2%; flex-wrap: wrap; }
        .column { flex: 1; min-width: 400px; }

        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f8f8;
            border: 1px solid #ddd;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .right-list {
            width: var(--list-width);
            min-width: var(--list-min-width);
            max-width: var(--list-max-width);
            border-left: 1px solid #ccc;
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
        }

        .list-header {
            padding: 8px;
            background: #e8e8e8;
            border-bottom: 1px solid #ccc;
        }

        .list-options {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .list-search {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .list-search input {
            width: 120px;
            height: 22px;
            border: 1px solid var(--border-gray);
            padding: 2px 5px;
            font-size: 11px;
        }

        .list-content {
            flex: 1;
            overflow-y: auto;
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: auto;
        }

        .list-table th {
            background: #d0d0d0;
            padding: 4px;
            text-align: left;
            border: 1px solid #a0a0a0;
            position: sticky;
            top: 0;
        }

        .list-table td {
            padding: 3px 4px;
            border: 1px solid #d0d0d0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 0;
        }

        .list-table tr:hover { background: #e8f4e8; }
        .list-table tr.selected { background: #4a90d9; color: white; }

        .status-bar {
            background: #E8E8E8;
            color: #666;
            padding: 2px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            min-height: 19px;
            border-top: 1px solid #CCC;
        }

        /* Responsive Design */
        @media (max-width: 1366px) {
            .right-list { min-width: 200px; }
            .column { min-width: 350px; }
        }
        @media (min-width: 1920px) {
            .right-list { width: 16%; }
        }
        @media (min-width: 2560px) {
            .right-list { width: 14%; max-width: 380px; }
        }
    </style>
</head>
<body data-active-menu="kunden">
    <div class="app-container">
        <aside class="app-sidebar"></aside>

        <main class="app-main">
            <div class="form-header">
                <div class="nav-arrows">
                    <div class="nav-arrow" id="btnUp">▲</div>
                    <div class="nav-arrows-row">
                        <div class="nav-arrow" id="btnFirst">◄◄</div>
                        <div class="nav-arrow" id="btnPrev">◄</div>
                        <div class="nav-arrow" id="btnNext">►</div>
                        <div class="nav-arrow" id="btnLast">►►</div>
                    </div>
                    <div class="nav-arrow" id="btnDown">▼</div>
                </div>

                <span class="header-title">Kundenstammblatt</span>

                <div class="header-nav-btns">
                    <button class="header-nav-btn">⏮</button>
                    <button class="header-nav-btn">◄</button>
                    <button class="header-nav-btn">►</button>
                    <button class="header-nav-btn">⏭</button>
                </div>

                <div class="header-buttons">
                    <button class="header-btn blue">Verrechnungssätze</button>
                    <button class="header-btn blue">Umsatzauswertung</button>
                </div>

                <div style="margin-left: auto; display: flex; align-items: center; gap: 10px; color: #fff;">
                    <label>Kunden-Nr.</label>
                    <input type="text" id="kundenNr" style="width: 50px; height: 22px; text-align: center;">
                </div>

                <div class="header-buttons">
                    <button class="header-btn delete">Kunden löschen</button>
                    <button class="header-btn new">Neuer Kunde</button>
                </div>
            </div>

            <div class="customer-info">
                <div class="customer-name-box">
                    <div class="customer-firma" id="displayFirma">Firmenname</div>
                    <div class="customer-contact" id="displayContact">Ansprechpartner</div>
                    <div style="font-size:12px;margin-top:3px;" id="displayBezeichnung"></div>
                </div>
            </div>

            <div class="form-area">
                <div class="tab-container">
                    <div class="tab-headers">
                        <div class="tab-header active" data-tab="pgMain">Stammdaten</div>
                        <div class="tab-header" data-tab="pgPreise">Konditionen</div>
                        <div class="tab-header" data-tab="pgAuftrUeb">Auftragsübersicht</div>
                        <div class="tab-header" data-tab="pgAnsprech">Ansprechpartner</div>
                        <div class="tab-header" data-tab="pgAttach">Zusatzdateien</div>
                        <div class="tab-header" data-tab="pgBemerk">Bemerkungen</div>
                        <div class="tab-header" data-tab="pg_Ang">Angebote</div>
                    </div>

                    <div class="tab-content">
                        <div class="tab-page active" id="tab-pgMain">
                            <div class="checkbox-group">
                                <div class="checkbox-item"><input type="checkbox" class="form-checkbox" id="kun_IstAktiv" data-field="kun_IstAktiv" checked><label>Ist aktiv</label></div>
                                <div class="checkbox-item"><input type="checkbox" class="form-checkbox" id="kun_IstSammelRechnung" data-field="kun_IstSammelRechnung"><label>Sammelrechnung</label></div>
                                <div class="checkbox-item"><input type="checkbox" class="form-checkbox" id="kun_ans_manuell" data-field="kun_ans_manuell"><label>Anschrift manuell</label></div>
                            </div>

                            <div class="two-columns">
                                <div class="column">
                                    <div class="form-row"><label class="form-label">Firma</label><input type="text" class="form-input wide" id="kun_Firma" data-field="kun_Firma"></div>
                                    <div class="form-row"><label class="form-label">Bezeichnung</label><input type="text" class="form-input wide" id="kun_bezeichnung" data-field="kun_bezeichnung"></div>
                                    <div class="form-row"><label class="form-label">Kunden-Kürzel</label><input type="text" class="form-input wide" id="kun_Matchcode" data-field="kun_Matchcode"></div>
                                    <div class="form-row"><label class="form-label">Straße</label><input type="text" class="form-input wide" id="kun_Strasse" data-field="kun_Strasse"></div>
                                    <div class="form-row"><label class="form-label">PLZ</label><input type="text" class="form-input wide" id="kun_PLZ" data-field="kun_PLZ"></div>
                                    <div class="form-row"><label class="form-label">Ort</label><input type="text" class="form-input wide" id="kun_Ort" data-field="kun_Ort"></div>
                                    <div class="form-row"><label class="form-label">Land</label><select class="form-select" id="kun_LKZ" data-field="kun_LKZ"><option value="DE">DE</option><option value="AT">AT</option><option value="CH">CH</option></select></div>
                                    <div class="form-row"><label class="form-label">Telefon</label><input type="text" class="form-input wide" id="kun_telefon" data-field="kun_telefon"></div>
                                    <div class="form-row"><label class="form-label">Mobil</label><input type="text" class="form-input wide" id="kun_mobil" data-field="kun_mobil"></div>
                                    <div class="form-row"><label class="form-label">Telefax</label><input type="text" class="form-input wide" id="kun_telefax" data-field="kun_telefax"></div>
                                    <div class="form-row"><label class="form-label">E-Mail</label><input type="text" class="form-input wide" id="kun_email" data-field="kun_email"></div>
                                    <div class="form-row"><label class="form-label">Homepage</label><input type="text" class="form-input wide" id="kun_URL" data-field="kun_URL"></div>
                                </div>

                                <div class="column">
                                    <div class="form-row"><label class="form-label">Kreditinstitut</label><input type="text" class="form-input wide" id="kun_kreditinstitut" data-field="kun_kreditinstitut"></div>
                                    <div class="form-row"><label class="form-label">BLZ</label><input type="text" class="form-input wide" id="kun_blz" data-field="kun_blz"></div>
                                    <div class="form-row"><label class="form-label">Kontonummer</label><input type="text" class="form-input wide" id="kun_kontonummer" data-field="kun_kontonummer"></div>
                                    <div class="form-row"><label class="form-label">IBAN</label><input type="text" class="form-input wide" id="kun_iban" data-field="kun_iban"></div>
                                    <div class="form-row"><label class="form-label">BIC</label><input type="text" class="form-input wide" id="kun_bic" data-field="kun_bic"></div>
                                    <div class="form-row"><label class="form-label">UStIDNr.</label><input type="text" class="form-input wide" id="kun_ustidnr" data-field="kun_ustidnr"></div>
                                    <div class="form-row"><label class="form-label">Zahlungsbedingung</label><select class="form-select" id="kun_Zahlbed" data-field="kun_Zahlbed"><option value="6">Netto 6 Tage</option><option value="7">Netto 7 Tage</option><option value="14">Netto 14 Tage</option><option value="30">Netto 30 Tage</option></select></div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-page" id="tab-pgPreise">
                            <p style="padding:20px; color:#666;">Konditionen - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgAuftrUeb">
                            <p style="padding:20px; color:#666;">Auftragsübersicht - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgAnsprech">
                            <p style="padding:20px; color:#666;">Ansprechpartner - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgAttach">
                            <p style="padding:20px; color:#666;">Zusatzdateien - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgBemerk">
                            <h3 style="margin-bottom:10px;">Bemerkungen</h3>
                            <div class="form-row">
                                <label class="form-label">Anschreiben</label>
                                <textarea class="form-input wide" id="kun_Anschreiben" data-field="kun_Anschreiben" rows="3" style="height:auto;width:500px;"></textarea>
                            </div>
                            <div class="form-row">
                                <label class="form-label">Briefkopf</label>
                                <textarea class="form-input wide" id="kun_BriefKopf" data-field="kun_BriefKopf" rows="4" style="height:auto;width:500px;"></textarea>
                            </div>
                            <div class="form-row">
                                <label class="form-label">Memo</label>
                                <textarea class="form-input wide" id="kun_memo" data-field="kun_memo" rows="8" style="height:auto;width:500px;"></textarea>
                            </div>
                        </div>

                        <div class="tab-page" id="tab-pg_Ang">
                            <p style="padding:20px; color:#666;">Angebote - Daten werden geladen...</p>
                        </div>
                    </div>
                </div>

                <div class="right-list">
                    <div class="list-header">
                        <div class="list-options">
                            <input type="checkbox" id="nurAktive" checked>
                            <label for="nurAktive">Nur Aktive</label>
                        </div>
                        <div class="list-search">
                            <label>Suche:</label>
                            <input type="text" id="searchInput">
                        </div>
                    </div>
                    <div class="list-content">
                        <table class="list-table">
                            <thead>
                                <tr>
                                    <th>Nr</th>
                                    <th>Firma</th>
                                    <th>Ort</th>
                                </tr>
                            </thead>
                            <tbody id="kdListBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <footer class="app-footer">
                <span>Erstellt am: <span id="erstelltAm">-</span> von <span id="erstelltVon">-</span></span>
                <span>Geändert am: <span id="geaendertAm">-</span> von <span id="geaendertVon">-</span></span>
            </footer>
        </main>
    </div>

    <script src="../js/sidebar.js"></script>
    <script>
        const API_URL = 'http://localhost:5000/api';

        let kundenList = [];
        let currentIndex = 0;
        let currentRecord = null;

        // Tab switching
        document.querySelectorAll('.tab-header').forEach(header => {
            header.addEventListener('click', () => {
                const tabId = header.dataset.tab;
                document.querySelectorAll('.tab-header').forEach(h => h.classList.remove('active'));
                header.classList.add('active');
                document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        async function loadKunden() {
            try {
                const aktiv = document.getElementById('nurAktive').checked;
                const url = `${API_URL}/kunden?aktiv=${aktiv}`;

                const response = await fetch(url);
                const result = await response.json();
                kundenList = result.data || [];

                renderKundenList();
                if (kundenList.length > 0) {
                    await showRecord(0);
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        function renderKundenList() {
            const tbody = document.getElementById('kdListBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            tbody.innerHTML = '';

            kundenList.forEach((kd, index) => {
                const firma = kd.kun_Firma || '';
                if (search && !firma.toLowerCase().includes(search)) return;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${kd.kun_Id || ''}</td>
                    <td>${firma}</td>
                    <td>${(kd.kun_Ort || '').substring(0, 8)}</td>
                `;
                tr.addEventListener('click', async () => {
                    document.querySelectorAll('.list-table tr').forEach(r => r.classList.remove('selected'));
                    tr.classList.add('selected');
                    await showRecord(index);
                });
                tbody.appendChild(tr);
            });
        }

        async function showRecord(index) {
            if (index < 0 || index >= kundenList.length) return;

            currentIndex = index;
            const kunId = kundenList[index].kun_Id;

            try {
                const response = await fetch(`${API_URL}/kunden/${kunId}`);
                const result = await response.json();
                currentRecord = result.data?.kunde || result.data || kundenList[index];
            } catch (error) {
                console.error('Fehler:', error);
                currentRecord = kundenList[index];
            }

            document.getElementById('displayFirma').textContent = currentRecord.kun_Firma || '';
            document.getElementById('displayContact').textContent = currentRecord.kun_Bezeichnung || '';
            document.getElementById('displayBezeichnung').textContent = currentRecord.kun_bezeichnung || '';
            document.getElementById('kundenNr').value = currentRecord.kun_Id || '';

            document.querySelectorAll('[data-field]').forEach(el => {
                const field = el.dataset.field;
                let value = currentRecord[field];

                // Clean HTML from URL field
                if (field === 'kun_URL' && value) {
                    const match = value.match(/href="([^"]+)"/);
                    value = match ? match[1] : value.replace(/<[^>]+>/g, '').trim();
                }

                if (el.type === 'checkbox') {
                    el.checked = !!value;
                } else if (el.tagName === 'SELECT') {
                    el.value = value || '';
                } else if (el.tagName === 'TEXTAREA') {
                    el.value = value || '';
                } else {
                    el.value = value || '';
                }
            });

            if (currentRecord.Erst_am) {
                const d = new Date(currentRecord.Erst_am);
                document.getElementById('erstelltAm').textContent = d.toLocaleDateString('de-DE', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'});
            }
            document.getElementById('erstelltVon').textContent = currentRecord.Erst_von || '-';

            if (currentRecord.Aend_am) {
                const d = new Date(currentRecord.Aend_am);
                document.getElementById('geaendertAm').textContent = d.toLocaleDateString('de-DE', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'});
            }
            document.getElementById('geaendertVon').textContent = currentRecord.Aend_von || '-';

            const rows = document.querySelectorAll('.list-table tbody tr');
            rows.forEach((row, i) => row.classList.toggle('selected', i === index));
        }

        document.getElementById('btnFirst')?.addEventListener('click', () => showRecord(0));
        document.getElementById('btnPrev')?.addEventListener('click', () => showRecord(currentIndex - 1));
        document.getElementById('btnNext')?.addEventListener('click', () => showRecord(currentIndex + 1));
        document.getElementById('btnLast')?.addEventListener('click', () => showRecord(kundenList.length - 1));

        document.getElementById('searchInput')?.addEventListener('input', renderKundenList);
        document.getElementById('nurAktive')?.addEventListener('change', loadKunden);

        document.addEventListener('DOMContentLoaded', loadKunden);
    </script>
</body>
</html>
