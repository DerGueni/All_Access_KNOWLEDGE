{"id":"MOD_zmd_Zuschlagskalkulation","name":"zmd_Zuschlagskalkulation","kind":"standard","procedures":["Function Stunden_Zuschlag(ByVal Datum As Date, ByVal Beginn As Date, ByVal Ende As Date, ByVal Art As String) As Double","Function zuschlagNacht(Datum, Beginn, Ende, Optional Wechsel As Boolean)","Function zuschlagSonn(Datum, Beginn, Ende, Optional Wechsel As Boolean)","Function zuschlagFeier(Datum, Beginn, Ende, Optional Wechsel As Boolean)","Function zuschlagSNacht(Datum, Beginn, Ende, Optional Wechsel As Boolean)","Function zuschlagFNacht(Datum, Beginn, Ende, Optional Wechsel As Boolean)","Function calc_ZUO_Stunden(ZUO_ID As Long, MA_ID As Long, VA_ID As Long)","SubKZ = TLookup(\"IstSubunternehmer\", MASTAMM, \"ID = \" & MA_ID)","Function update_ZUO_Stunden(ZUO_ID As Long, MA_ID As Long, VA_ID As Long, Bez As String, stunden As Double, VADatum As Date, _","Function detect_Preisart(MA_ID As Long, Bez As String, ZUO_ID As Long) As Long","Function detect_Lohnart(MA_ID As Long, Bez As String, Optional ZUO_ID As Long) As Long","Function calc_Lohn(Lohnart_ID As Long, stunden As Double, VADatum As Date, Bez As String, Grundlohn As Double, Satz As Double) As Double","Function detect_Spreis(Kunnr As Long, PreisArt_ID As Long) As Double","Function calc_Preis(MA_ID, PreisArt_ID As Long, stunden As Double, VADatum As Date, spreis As Double) As Double","Function detect_grundlohn(Lohnart_ID As Long, VADatum As Date) As Double","Function detect_satz(Lohnart_ID As Long, Grundlohn As Double, VADatum As Date) As Double","Function calc_NV_Stunden(NV_ID As Long, MA_ID As Long)","Function update_NV_Stunden(NV_ID As Long, MA_ID As Long, Lohnart_ID As Long, Bez As String, stunden As Double, Datum As Date, Grundlohn As Double, bruttoKZ As Boolean)","Function calc_ZUO_Stunden_complete()","Function calc_NV_Stunden_complete()","Function calc_ZUO_Stunden_sub(VA_ID As Long, MA_ID As Long)"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":["DELETE FROM ","DELETE FROM "],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\n\nOption Explicit\n\nType TAG\n    Datum As Date\n    WTag As Integer 'Wochentag\n    fTag As Boolean 'Feiertag\nEnd Type\n\nDim Tage() As TAG\n\n\n'Zuschlag Stunden\nFunction Stunden_Zuschlag(ByVal Datum As Date, ByVal Beginn As Date, ByVal Ende As Date, ByVal Art As String) As Double\n       \n    'Mögliche Zuschläge(Art):\n        'NACHT\n        'SONNTAG\n        'FEIERTAG\n        'SONNTAGNACHT\n        'FEIERTAGNACHT\n        \nDim FDatum1 As Boolean 'Feiertag?\nDim FDatum2 As Boolean 'Folgetag Feiertag?\nDim SDatum1 As Boolean 'Sonntag?\nDim SDatum2 As Boolean 'Folgetag Sonntag?\nDim TagEnde As Date    'Endzeit Zuschlag\nDim Wechsel As Boolean 'Tagesübergreifend?\n\n    'Aussteigen, wenn Werte fehlen\n    If Datum = \"00:00:00\" Then Exit Function\n    \n    'Prüfung Zeiten\n    Beginn = Format(Beginn, \"HH:MM:SS\")\n    Ende = Format(Ende, \"HH:MM:SS\")\n    \n    'Beginn anpassen sofern um Mitternacht\n    If Beginn = \"00:00:00\" Or Beginn = \"23:59:00\" Then Beginn = \"23:59:59\"\n    \n    'Ende anpassen sofern um Mitternacht\n    If Ende = \"00:00:00\" Or Ende = \"23:59:00\" Then Ende = \"23:59:59\"\n    \n    'Prüfung Feiertag\n    If Feiertag(Datum) <> \"\" Then FDatum1 = True\n    If Feiertag(Datum + 1) <> \"\" Then FDatum2 = True\n    \n    'Prüfung Sonntag -> Sonntag = 1!\n    If Weekday(Datum) = 1 Then SDatum1 = True\n    If Weekday(Datum + 1) = 1 Then SDatum2 = True\n    \n    \n    'Prüfung Endzeit am Folgetag\n    If Ende < Beginn Then\n        TagEnde = \"23:59:59\"\n        Wechsel = True\n    Else\n        TagEnde = Ende\n    End If\n    \n\n    'Art des Zuschlags\n    Select Case Art\n    \n        Case \"NACHT\"\n            'Veranstaltungstag weder Sonn- noch Feiertag\n            If FDatum1 = False And SDatum1 = False Then\n                'Folgetag weder Sonn- noch Feiertag\n                If FDatum2 = False And SDatum2 = False Then\n                    'Nachtzuschlag ganze Nacht\n                    Stunden_Zuschlag = zuschlagNacht(Datum, Beginn, Ende, Wechsel)\n                Else\n                    'Nachtzuschlag bis Mitternacht\n                    Stunden_Zuschlag = zuschlagNacht(Datum, Beginn, TagEnde)\n                End If\n            'Veranstaltungstag Sonn- oder Feiertag\n            Else\n                'Folgetag weder Sonn- noch Feiertag -> Nachtzuschlag ab Mitternacht\n                If FDatum2 = False And SDatum2 = False Then\n                    If Wechsel = True Then Stunden_Zuschlag = zuschlagNacht(Datum, \"00:00:00\", Ende, Wechsel)\n                End If\n            End If\n            \n            \n        Case \"SONNTAG\"\n            'Veranstatltungstag Sonntag aber kein Feiertag -> Sonntagszuschlag\n            If FDatum1 = False And SDatum1 = True And Wechsel = True Then _\n                Stunden_Zuschlag = zuschlagSonn(Datum, Beginn, TagEnde)\n            If FDatum1 = False And SDatum1 = True And Wechsel = False Then _\n                Stunden_Zuschlag = zuschlagSonn(Datum, Beginn, Ende)\n            If FDatum2 = False And SDatum2 = True And Wechsel = True Then _\n                Stunden_Zuschlag = zuschlagSonn(Datum, \"00:00:01\", Ende)\n\n\n        Case \"FEIERTAG\"\n            'Veranstatltungstag Feiertag -> Feiertagszuschlag\n            If FDatum1 = True And Wechsel = True Then _\n                Stunden_Zuschlag = zuschlagFeier(Datum, Beginn, TagEnde)\n            If FDatum1 = True And Wechsel = False Then _\n                Stunden_Zuschlag = Stunden_Zuschlag + zuschlagFeier(Datum, Beginn, Ende)\n            If FDatum2 = True And Wechsel = True Then _\n                Stunden_Zuschlag = Stunden_Zuschlag + zuschlagFeier(Datum, \"00:00:01\", Ende)\n              \n            \n        Case \"SONNTAGNACHT\"\n            'Veranstatltungstag Sonntag aber kein Feiertag -> Sonntagsnachtzuschlag bis max. Mitternacht\n            If FDatum1 = False And SDatum1 = True Then _\n                Stunden_Zuschlag = zuschlagSNacht(Datum, Beginn, TagEnde)\n            \n            'Folgetag Sonntag aber kein Feiertag -> Sonntagsnachtzuschlag ab Mitternacht\n            If FDatum2 = False And SDatum2 = True And Wechsel = True Then _\n                Stunden_Zuschlag = zuschlagSNacht(Datum, \"00:00:01\", Ende, Wechsel)\n        \n            \n        Case \"FEIERTAGNACHT\"\n            'Veranstatltungstag Feiertag -> Feiertagsnachzuschlag bis max. Mitternacht\n            If FDatum1 = True And FDatum2 = False Then _\n                Stunden_Zuschlag = zuschlagFNacht(Datum, Beginn, TagEnde)\n                \n            'Folgetag Feiertag -> Feiertagsnachzuschlag ab Mitternacht\n            If FDatum1 = False And FDatum2 = True And Wechsel = True Then _\n                Stunden_Zuschlag = zuschlagFNacht(Datum, \"00:00:01\", Ende, Wechsel)\n            \n            'Beide Tage Feiertage\n                If FDatum1 = True And FDatum2 = True Then _\n                Stunden_Zuschlag = zuschlagNacht(Datum, Beginn, Ende, Wechsel)\n        \n        \n        Case \"NACHT_GESAMT\"\n                'Nachtzuschlag ganze Nacht\n                Stunden_Zuschlag = zuschlagNacht(Datum, Beginn, Ende, Wechsel)\n        \n        \n        Case Else\n            Stunden_Zuschlag = \"0,00\"\n            \n            \n    End Select\n\n    \nEnd Function\n\n\n'NACHTZUSCHLAG\nFunction zuschlagNacht(Datum, Beginn, Ende, Optional Wechsel As Boolean)\n    Dim zbeginn As Date 'Uhrzeit, ab der der Zuschlag beginnt\n    Dim ZEnde As Date   'Uhrzeit, ab der der Zuschlag endet\n    \n    zbeginn = Datum & \" 20:00:00\"\n    ZEnde = Datum + 1 & \" 06:00:00\"\n    \n    'Wenn Arbeitsende vor Zuschlagsbeginn\n    If Datum & \" \" & Ende < zbeginn And Wechsel = False Then\n        'Arbeitsbeginn nach Mitternacht?\n        If Datum & \" \" & Beginn < ZEnde - 1 Then\n            Ende = Right(ZEnde, 8)\n            zuschlagNacht = stunden(Beginn, Ende)\n        End If\n        Exit Function\n    End If\n    \n    'Wenn Startzeit vor Zuschlagsbeginn\n    If Datum & \" \" & Beginn < zbeginn And Beginn <> \"00:00:00\" Then Beginn = Right(zbeginn, 8)\n    \n    'Wenn Endzeit nach Zuschlagsende\n    'Ende am gleichen Tag\n    If Wechsel = False Then\n        If Datum & \" \" & Ende > ZEnde Then Ende = Right(ZEnde, 8)\n    'Ende am Folgetag\n    Else\n        If Datum + 1 & \" \" & Ende > ZEnde Then Ende = Right(ZEnde, 8)\n    End If\n    \n    zuschlagNacht = stunden(Beginn, Ende)\n\nEnd Function\n\n\n'SONNTAGSZUSCHLAG\nFunction zuschlagSonn(Datum, Beginn, Ende, Optional Wechsel As Boolean)\n    Dim zbeginn As Date 'Uhrzeit, ab der der Zuschlag beginnt\n    Dim ZEnde As Date   'Uhrzeit, ab der der Zuschlag endet\n    \n    zbeginn = \"06:00:00\"\n    ZEnde = \"20:00:00\"\n    \n    'Wenn Ende vor Zuschlagsbeginn\n    If Ende < zbeginn Then Exit Function\n    \n    'Wenn Beginn nach Zuschlagsende\n    If Beginn > ZEnde Then Exit Function\n    \n    'Wenn Startzeit vor Zuschlagsbeginn\n    If Datum & \" \" & Beginn < Datum & \" \" & zbeginn And Beginn <> \"00:00:00\" Then Beginn = zbeginn\n    \n    'Wenn Endzeit nach Zuschlagsende\n    'Ende am gleichen Tag\n    If Wechsel = False Then\n        If Datum & \" \" & Ende > Datum & \" \" & ZEnde Then Ende = ZEnde\n    'Ende am Folgetag\n    Else\n        If Datum + 1 & \" \" & Ende > Datum + 1 & \" \" & ZEnde Then Ende = ZEnde\n    End If\n    \n    zuschlagSonn = stunden(Beginn, Ende)\n    \n    \nEnd Function\n\n\n'FEIERTAGSZUSCHLAG\nFunction zuschlagFeier(Datum, Beginn, Ende, Optional Wechsel As Boolean)\n    Dim zbeginn As Date 'Uhrzeit, ab der der Zuschlag beginnt\n    Dim ZEnde As Date   'Uhrzeit, ab der der Zuschlag endet\n    \n    zbeginn = \"06:00:00\"\n    ZEnde = \"20:00:00\"\n    \n    'Wenn Ende vor Zuschlagsbeginn\n    If Ende < zbeginn Then Exit Function\n    \n    'Wenn Beginn nach Zuschlagsende\n    If Beginn > ZEnde Then Exit Function\n    \n    'Wenn Startzeit vor Zuschlagsbeginn\n    If Datum & \" \" & Beginn < Datum & \" \" & zbeginn And Beginn <> \"00:00:00\" Then Beginn = zbeginn\n    \n    'Wenn Endzeit nach Zuschlagsende\n    'Ende am gleichen Tag\n    If Wechsel = False Then\n        If Datum & \" \" & Ende > Datum & \" \" & ZEnde Then Ende = ZEnde\n    'Ende am Folgetag\n    Else\n        If Datum + 1 & \" \" & Ende > Datum + 1 & \" \" & ZEnde Then Ende = ZEnde\n    End If\n    \n    zuschlagFeier = stunden(Beginn, Ende)\n    \nEnd Function\n\n\n'NACHTZUSCHLAG-SONNTAG bis max. Mitternacht / ab Mitternacht\nFunction zuschlagSNacht(Datum, Beginn, Ende, Optional Wechsel As Boolean)\n    Dim zbeginn As Date 'Uhrzeit, ab der der Zuschlag beginnt\n    Dim ZEnde As Date   'Uhrzeit, ab der der Zuschlag endet\n    \n    'Wenn Arbeitsbeginn nachts\n    If Beginn >= \"00:00:00\" And Beginn <= \"06:00:00\" Then\n        zbeginn = \"00:00:00\"\n        ZEnde = \"06:00:00\"      ' -----> effektives Zuschlagsende\n    'Wenn Arbeitsbeginn nachmittags/abends und Datum = Sonntag\n    ElseIf Weekday(Datum) = 1 Then\n        zbeginn = \"20:00:00\"    ' -----> effektiver Zuschlagsbeginn\n        ZEnde = \"23:59:59\"\n    'Tag ist nicht Sonntag\n    Else\n        Exit Function\n    End If\n    \n    'Wenn Arbeitsende vor Zuschlagsbeginn\n    If Ende < zbeginn Then Exit Function\n    \n    'Wenn Startzeit vor Zuschlagsbeginn\n    If Datum & \" \" & Beginn < Datum & \" \" & zbeginn And Beginn <> \"00:00:00\" Then Beginn = zbeginn\n    \n    'Wenn Endzeit nach Zuschlagsende\n    'Ende am gleichen Tag\n    If Wechsel = False Then\n        If Datum & \" \" & Ende > Datum & \" \" & ZEnde Then Ende = ZEnde\n    'Ende am Folgetag\n    Else\n        If Datum + 1 & \" \" & Ende > Datum + 1 & \" \" & ZEnde Then Ende = ZEnde\n    End If\n    \n    zuschlagSNacht = stunden(Beginn, Ende)\n     \n    \nEnd Function\n\n\n'NACHTZUSCHLAG-FEIERTAG bis max. Mitternacht /ab Mitternacht\nFunction zuschlagFNacht(Datum, Beginn, Ende, Optional Wechsel As Boolean)\n    Dim zbeginn As Date 'Uhrzeit, ab der der Zuschlag beginnt\n    Dim ZEnde As Date   'Uhrzeit, ab der der Zuschlag endet\n    \n    'Wenn Arbeitsbeginn nachts\n    If Beginn >= \"00:00:00\" And Beginn <= \"06:00:00\" Then\n        zbeginn = \"00:00:00\"\n        ZEnde = \"06:00:00\"      ' -----> effektives Zuschlagsende\n    'Wenn Arbeitsbeginn nachmittags/abends\n    Else\n        zbeginn = \"20:00:00\"    ' -----> effektiver Zuschlagsbeginn\n        ZEnde = \"23:59:59\"\n    End If\n    \n    'Wenn Arbeitsbeginn nachts\n    If Beginn >= \"00:00:00\" And Beginn <= \"06:00:00\" Then\n        zbeginn = \"00:00:00\"\n        ZEnde = \"06:00:00\"      ' -----> effektives Zuschlagsende\n    'Wenn Arbeitsbeginn nachmittags/abends und Datum = Feiertag\n    ElseIf Feiertag(Datum) <> \"\" Then\n        zbeginn = \"20:00:00\"    ' -----> effektiver Zuschlagsbeginn\n        ZEnde = \"23:59:59\"\n    'Tag ist kein Feiertag\n    Else\n        Exit Function\n    End If\n    \n    \n    'Wenn Arbeitsende vor Zuschlagsbeginn\n    If Ende < zbeginn Then Exit Function\n        \n    'Wenn Startzeit vor Zuschlagsbeginn und ende nach Zuschlagsbeginn\n    If Datum & \" \" & Beginn < Datum & \" \" & zbeginn And Beginn <> \"00:00:00\" Then Beginn = zbeginn\n    \n    'Wenn Endzeit nach zuschlagsende\n    'Ende am gleichen Tag\n    If Wechsel = False Then\n        If Datum & \" \" & Ende > Datum & \" \" & ZEnde Then Ende = ZEnde\n    'Ende am Folgetag\n    Else\n        If Datum + 1 & \" \" & Ende > Datum + 1 & \" \" & ZEnde Then Ende = ZEnde\n    End If\n    \n    zuschlagFNacht = stunden(Beginn, Ende)\n    \n    \nEnd Function\n\n\n'Stunden- & Kostenberechnung\nFunction calc_ZUO_Stunden(ZUO_ID As Long, MA_ID As Long, VA_ID As Long)\n\nDim sql             As String\nDim tbl             As String\nDim ABF             As String\nDim WHERE           As String\nDim Normal          As Double\nDim Nacht           As Double\nDim Sonntag         As Double\nDim SonntagNacht    As Double\nDim Feiertag        As Double\nDim FeiertagNacht   As Double\nDim Lohnart_grund   As Long\nDim Grundlohn       As Double\nDim bruttoKZ        As Boolean\nDim SubKZ           As Boolean\nDim VADatum         As Date\nDim MA_Start        As String\nDim MA_Ende         As String\n\nOn Error GoTo err\n    \n\n    tbl = ZUO_STD\n    ABF = \"zqry_ZUO_ZK_Stunden_prepare\"\n    WHERE = \"ZUO_ID = \" & ZUO_ID\n    VADatum = TLookup(\"VADatum\", ZUORDNUNG, \"ID = \" & ZUO_ID)\n    MA_Start = Nz(TLookup(\"MA_Start\", ZUORDNUNG, \"ID = \" & ZUO_ID), \"\")\n    MA_Ende = Nz(TLookup(\"MA_Ende\", ZUORDNUNG, \"ID = \" & ZUO_ID), \"\")\n\n    'Nur berechnen, wenn MA_ID, Start und Ende vorhanden sind!\n    If MA_ID <> 0 And MA_Start <> \"\" And MA_Ende <> \"\" Then\n        'ACHTUNG: Stundenberechnung Subunternehmner läuft anders!\n        SubKZ = TLookup(\"IstSubunternehmer\", MASTAMM, \"ID = \" & MA_ID)\n        If SubKZ = False Then\n            Normal = Nz(TLookup(\"Stunden\", ABF, WHERE), 0)\n            Nacht = Nz(TLookup(\"Nacht\", ABF, WHERE), 0)\n            Sonntag = Nz(TLookup(\"Sonntag\", ABF, WHERE), 0)\n            SonntagNacht = Nz(TLookup(\"SonntagNacht\", ABF, WHERE), 0)\n            Feiertag = Nz(TLookup(\"Feiertag\", ABF, WHERE), 0)\n            FeiertagNacht = Nz(TLookup(\"FeiertagNacht\", ABF, WHERE), 0)\n            Lohnart_grund = detect_Lohnart(MA_ID, \"Normal\", ZUO_ID)\n            If Lohnart_grund <> 0 Then Grundlohn = detect_grundlohn(Lohnart_grund, VADatum)\n        Else\n            ABF = \"zqry_ZUO_Stunden_Sub_lb\"\n            Normal = Nz(TLookup(\"Stunden\", ABF, WHERE), 0)\n            Nacht = Nz(TLookup(\"Nacht\", ABF, WHERE), 0)\n            Sonntag = Nz(TLookup(\"Sonntag\", ABF, WHERE), 0)\n            Feiertag = Nz(TLookup(\"Feiertag\", ABF, WHERE), 0)\n        End If\n        \n        bruttoKZ = TLookup(\"IstNSB\", MASTAMM, \"ID = \" & MA_ID)\n    \n        If Normal <> 0 Then Call update_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID, \"Normal\", Normal, VADatum, Lohnart_grund, Grundlohn, bruttoKZ, SubKZ)\n        If Nacht <> 0 Then Call update_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID, \"Nacht\", Nacht, VADatum, Lohnart_grund, Grundlohn, bruttoKZ, SubKZ)\n        If Sonntag <> 0 Then Call update_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID, \"Sonntag\", Sonntag, VADatum, Lohnart_grund, Grundlohn, bruttoKZ, SubKZ)\n        If SonntagNacht <> 0 Then Call update_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID, \"SonntagNacht\", SonntagNacht, VADatum, Lohnart_grund, Grundlohn, bruttoKZ, SubKZ)\n        If Feiertag <> 0 Then Call update_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID, \"Feiertag\", Feiertag, VADatum, Lohnart_grund, Grundlohn, bruttoKZ, SubKZ)\n        If FeiertagNacht <> 0 Then Call update_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID, \"FeiertagNacht\", FeiertagNacht, VADatum, Lohnart_grund, Grundlohn, bruttoKZ, SubKZ)\n        \n    Else\n        'eventuell vorhandene Sätze löschen\n        CurrentDb.Execute \"DELETE FROM \" & tbl & \" WHERE \" & WHERE\n        \n    End If\n    \nEnde:\n    Exit Function\nerr:\n    writelog Server & \"Database\\Log\\ztbl_ZUO_Stunden.txt\", Now & \"  \" & Environ(\"UserName\") & \", ZUO_ID: \" & ZUO_ID & \", \" & err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n'Werte in ztbl_ZUO_Stunden updaten\nFunction update_ZUO_Stunden(ZUO_ID As Long, MA_ID As Long, VA_ID As Long, Bez As String, stunden As Double, VADatum As Date, _\n    Lohnart_grund As Long, Grundlohn As Double, bruttoKZ As Boolean, SubKZ As Boolean, Optional iPreisArt_ID As Long, Optional iLohnart_ID As Long)\n\n\nDim sql             As String\nDim tbl             As String\nDim rs              As Recordset\nDim WHERE           As String\nDim Lohnart_ID      As Long\n\nOn Error GoTo err\n\n    tbl = ZUO_STD\n    WHERE = \"ZUO_ID = \" & ZUO_ID & \" AND Bezeichnung_kurz = '\" & Bez & \"'\"\n\n    sql = \"SELECT * FROM \" & tbl & \" WHERE \" & WHERE\n    \n    Set rs = CurrentDb.OpenRecordset(sql)\n    \n    If rs.EOF = True Then\n        rs.AddNew\n        rs.fields(\"ZUO_ID\") = ZUO_ID\n        rs.fields(\"VA_ID\") = VA_ID\n        rs.fields(\"Bezeichnung_kurz\") = Bez\n    Else\n        rs.Edit\n    End If\n    'Mitarbeiterwechsel?\n    If rs.fields(\"MA_ID\") <> MA_ID Then\n        rs.fields(\"Satz\") = Null\n        rs.fields(\"Bemerkung\") = Null\n    End If\n    rs.fields(\"MA_ID\") = MA_ID\n    rs.fields(\"Stunden_brutto\") = stunden\n    rs.fields(\"Stunden_netto\") = Round(stunden * 0.91, 2)\n    rs.fields(\"Lohnstunden_brutto\") = bruttoKZ\n    'If bruttoKZ = True And IsInitial(iLohnart_ID) Then\n    If SubKZ = True Then\n        rs.fields(\"Lohn\") = Null\n        rs.fields(\"Lohnart_ID\") = Null\n        If iPreisArt_ID = 0 Then\n            rs.fields(\"Preisart_ID\") = detect_Preisart(MA_ID, Bez, ZUO_ID)\n        Else\n            rs.fields(\"Preisart_ID\") = iPreisArt_ID\n        End If\n        If IsInitial(rs.fields(\"Satz\")) Then rs.fields(\"Satz\") = detect_Spreis(rs.fields(\"MA_ID\"), rs.fields(\"Preisart_ID\"))\n        If Not IsInitial(rs.fields(\"Preisart_ID\")) Then rs.fields(\"Preis\") = calc_Preis(MA_ID, rs.fields(\"Preisart_ID\"), stunden, VADatum, Nz(rs.fields(\"Satz\"), 0))\n        rs.fields(\"Bemerkung\") = TLookup(\"Bemerkungen\", ZUORDNUNG, \"ID = \" & ZUO_ID)\n    Else\n        rs.fields(\"Preisart_ID\") = Null\n        rs.fields(\"Preis\") = Null\n        If Lohnart_grund <> 0 Then\n            If Bez = \"Normal\" Then\n                rs.fields(\"Lohnart_ID\") = Lohnart_grund\n            Else\n                If iLohnart_ID = 0 Then\n                    rs.fields(\"Lohnart_ID\") = detect_Lohnart(MA_ID, Bez, ZUO_ID)\n                Else\n                    rs.fields(\"Lohnart_ID\") = iLohnart_ID\n                End If\n            End If\n            If IsInitial(rs.fields(\"Satz\")) Then rs.fields(\"Satz\") = detect_satz(rs.fields(\"Lohnart_ID\"), Grundlohn, VADatum)\n            If bruttoKZ = True Then\n                rs.fields(\"Lohn\") = calc_Lohn(rs.fields(\"Lohnart_ID\"), stunden, VADatum, Bez, Grundlohn, Nz(rs.fields(\"Satz\"), 0))\n            Else\n                rs.fields(\"Lohn\") = calc_Lohn(rs.fields(\"Lohnart_ID\"), rs.fields(\"Stunden_netto\"), VADatum, Bez, Grundlohn, Nz(rs.fields(\"Satz\"), 0))\n            End If\n        End If\n    End If\n    rs.update\n    rs.Close\n    Set rs = Nothing\n    \n    \nEnde:\n    Exit Function\nerr:\n    writelog Server & \"Database\\Log\\ztbl_ZUO_Stunden.txt\", Now & \"  \" & Environ(\"UserName\") & \", ZUO_ID: \" & ZUO_ID & \", \" & err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n'Preisart_ID ermitteln\nFunction detect_Preisart(MA_ID As Long, Bez As String, ZUO_ID As Long) As Long\n\n    Select Case Bez\n        Case \"Normal\"\n            detect_Preisart = 1\n            \n        Case \"Nacht\"\n            detect_Preisart = 11\n            \n        Case \"Sonntag\"\n            detect_Preisart = 12\n            \n        Case \"SonntagNacht\"\n            detect_Preisart = 11\n            \n        Case \"Feiertag\"\n            detect_Preisart = 13\n            \n        Case \"FeiertagNacht\"\n            detect_Preisart = 11\n            \n    End Select\n    \n\n    'ggf Sonderlocken nach ZUO_ID\n    \nEnd Function\n\n\n'Lohnart_ID ermitteln\nFunction detect_Lohnart(MA_ID As Long, Bez As String, Optional ZUO_ID As Long) As Long\n\nDim Lohnart_ID As Long\n\n    Select Case Bez\n        Case \"Normal\"\n            Lohnart_ID = Nz(TLookup(\"Stundenlohn_brutto\", MASTAMM, \"ID = \" & MA_ID), 0)\n            If Lohnart_ID <> 0 Then detect_Lohnart = Lohnart_ID\n            \n        Case \"Nacht\"\n            detect_Lohnart = 14\n            \n        Case \"Sonntag\"\n            detect_Lohnart = 15\n            \n        Case \"SonntagNacht\"\n            detect_Lohnart = 20\n            \n        Case \"Feiertag\"\n            detect_Lohnart = 21\n            \n        Case \"FeiertagNacht\"\n            detect_Lohnart = 22\n        \n        Case \"Urlaub\"\n            detect_Lohnart = 27\n        \n        Case \"Krank\"\n            detect_Lohnart = 28\n        \n        Case \"Intern\"\n            Lohnart_ID = Nz(TLookup(\"Stundenlohn_brutto\", MASTAMM, \"ID = \" & MA_ID), 0)\n            If Lohnart_ID <> 0 Then detect_Lohnart = Lohnart_ID\n            \n        Case Else 'Dummy\n            detect_Lohnart = 59\n            \n    End Select\n    \n    'ggf Sonderlocken nach ZUO_ID\n    \nEnd Function\n\n\n'Lohn Berechnen\nFunction calc_Lohn(Lohnart_ID As Long, stunden As Double, VADatum As Date, Bez As String, Grundlohn As Double, Satz As Double) As Double\n\n    If Bez = \"Normal\" Then\n        calc_Lohn = stunden * Grundlohn\n    Else\n'        If Satz = 0 Then Satz = detect_satz(Lohnart_ID, Grundlohn, VADatum)\n        calc_Lohn = Round(stunden * Satz, 2)\n    End If\n\nEnd Function\n\n\n'Standardpreis ermitteln\nFunction detect_Spreis(Kunnr As Long, PreisArt_ID As Long) As Double\n\n    Dim spreis As String\n    \n    spreis = Nz(TLookup(\"StdPreis\", \"tbl_KD_Standardpreise\", \"kun_ID = \" & Kunnr & \" AND Preisart_ID = \" & PreisArt_ID), 0)\n    If IsNumeric(spreis) Then detect_Spreis = spreis\n    \nEnd Function\n\n\n'Preis Berechnen\nFunction calc_Preis(MA_ID, PreisArt_ID As Long, stunden As Double, VADatum As Date, spreis As Double) As Double\n\nDim Kunnr   As Long\n    \n    Kunnr = MA_ID\n'    If kunnr <> 0 Then\n'        If Spreis <> 0 Then Spreis = Nz(TLookup(\"StdPreis\", \"tbl_KD_Standardpreise\", \"kun_ID = \" & kunnr & \" AND Preisart_ID = \" & PreisArt_ID), 0)\n'    End If\n\n    calc_Preis = Runden(spreis * stunden, 2)\n    \nEnd Function\n\n\n'Grundlohn ermitteln\nFunction detect_grundlohn(Lohnart_ID As Long, VADatum As Date) As Double\n\nDim WHERE    As String\n\n    'zum Datum gültiger Satz der Lohnart\n    WHERE = \" AND DatumBis >= \" & datumSQL(VADatum) & \" AND Datumvon <= \" & datumSQL(VADatum)\n    detect_grundlohn = Nz(TLookup(\"Grundlohn\", LOHNARTEN, \"ID = \" & Lohnart_ID & WHERE), 0)\n    \nEnd Function\n\n\n'Satz ermitteln\nFunction detect_satz(Lohnart_ID As Long, Grundlohn As Double, VADatum As Date) As Double\n\nDim WHERE    As String\n\n    'zum Datum gültiger Satz der Lohnart\n    WHERE = \" AND DatumBis >= \" & datumSQL(VADatum) & \" AND Datumvon <= \" & datumSQL(VADatum)\n     \n    detect_satz = Grundlohn * Nz(TLookup(\"Faktor\", LOHNARTEN, \"ID = \" & Lohnart_ID & WHERE), 0)\n    \nEnd Function\n\n'Stunden- & Kostenberechnung NV\nFunction calc_NV_Stunden(NV_ID As Long, MA_ID As Long)\n\nDim sql             As String\nDim tbl             As String\nDim ABF             As String\nDim WHERE           As String\nDim Lohnart_grund   As Long\nDim Lohnart_ID      As Long\nDim Grundlohn       As Double\nDim bruttoKZ        As Boolean\nDim Bez             As String\nDim Datum           As Date\nDim vonZeit         As Date\nDim bisZeit         As Date\nDim Stunden_brutto  As Double\n\nOn Error GoTo err\n    \n\n    tbl = ZUO_STD\n    WHERE = \"NV_ID = \" & NV_ID\n    ABF = \"zqry_ZUO_ZK_Stunden_prepare\"\n    Datum = TLookup(\"vonDat\", NVERFUEG, \"ID = \" & NV_ID)\n    Bez = TLookup(\"Zeittyp_ID\", NVERFUEG, \"ID = \" & NV_ID)\n    \n    If MA_ID <> 0 And (Bez = \"Urlaub\" Or Bez = \"Krank\" Or Bez = \"Intern\") Then\n        Lohnart_grund = detect_Lohnart(MA_ID, \"Normal\")\n        Grundlohn = detect_grundlohn(Lohnart_grund, Datum)\n        Lohnart_ID = detect_Lohnart(MA_ID, Bez)\n        bruttoKZ = True 'TLookup(\"IstNSB\", MASTAMM, \"ID = \" & MA_ID)\n        vonZeit = TLookup(\"vonZeit\", NVERFUEG, \"ID = \" & NV_ID)\n        bisZeit = TLookup(\"bisZeit\", NVERFUEG, \"ID = \" & NV_ID)\n        Stunden_brutto = stunden(vonZeit, bisZeit)\n        If Stunden_brutto = 0 Or Round(Stunden_brutto, 0) = 24 Then Stunden_brutto = ArbStundenProTag(MA_ID)\n        \n        Call update_NV_Stunden(NV_ID, MA_ID, Lohnart_ID, Bez, Stunden_brutto, Datum, Grundlohn, bruttoKZ)\n  \n    Else\n        'eventuell vorhandene Sätze löschen\n        CurrentDb.Execute \"DELETE FROM \" & tbl & \" WHERE \" & WHERE\n        \n    End If\n    \nEnde:\n    Exit Function\nerr:\n    writelog Server & \"Database\\Log\\ztbl_ZUO_Stunden.txt\", Now & \"  \" & Environ(\"UserName\") & \", NV_ID: \" & NV_ID & \", \" & err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n'Werte NV in ztbl_ZUO_Stunden updaten\nFunction update_NV_Stunden(NV_ID As Long, MA_ID As Long, Lohnart_ID As Long, Bez As String, stunden As Double, Datum As Date, Grundlohn As Double, bruttoKZ As Boolean)\n\n\nDim sql             As String\nDim tbl             As String\nDim rs              As Recordset\n\nOn Error GoTo err\n\n    tbl = ZUO_STD\n\n    sql = \"SELECT * FROM \" & tbl & \" WHERE NV_ID = \" & NV_ID\n    \n    Set rs = CurrentDb.OpenRecordset(sql)\n    \n    If rs.EOF = True Then\n        rs.AddNew\n        rs.fields(\"NV_ID\") = NV_ID\n        rs.fields(\"Bezeichnung_kurz\") = Bez\n    Else\n        rs.Edit\n    End If\n    'Mitarbeiterwechsel?\n    If rs.fields(\"MA_ID\") <> MA_ID Then rs.fields(\"Satz\") = Null\n    rs.fields(\"MA_ID\") = MA_ID\n    rs.fields(\"Stunden_brutto\") = stunden\n    rs.fields(\"Stunden_netto\") = Round(stunden * 0.91, 2)\n    rs.fields(\"Lohnstunden_brutto\") = bruttoKZ\n    rs.fields(\"Lohnart_ID\") = Lohnart_ID\n    If IsInitial(rs.fields(\"Satz\")) Then rs.fields(\"Satz\") = Grundlohn\n    If bruttoKZ = True Then\n        rs.fields(\"Lohn\") = calc_Lohn(rs.fields(\"Lohnart_ID\"), stunden, Datum, Bez, Grundlohn, Nz(rs.fields(\"Satz\"), 0))\n    Else\n        rs.fields(\"Lohn\") = calc_Lohn(rs.fields(\"Lohnart_ID\"), rs.fields(\"Stunden_netto\"), Datum, Bez, Grundlohn, Nz(rs.fields(\"Satz\"), 0))\n    End If\n        \n    rs.update\n    rs.Close\n    Set rs = Nothing\n    \n    \nEnde:\n    Exit Function\nerr:\n    writelog Server & \"Database\\Log\\ztbl_ZUO_Stunden.txt\", Now & \"  \" & Environ(\"UserName\") & \", NV_ID: \" & NV_ID & \", \" & err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n'Stunden- & Kostenberechnung komplett\nFunction calc_ZUO_Stunden_complete()\n\nDim rs      As Recordset\nDim MA_ID   As Long\nDim ZUO_ID  As Long\nDim VA_ID   As Long\nDim sql     As String\n    \n    sql = \"SELECT * FROM \" & ZUORDNUNG & \" WHERE VADatum >= \" & datumSQL(\"01.01.2023\")\n    Set rs = CurrentDb.OpenRecordset(sql)\nOn Error Resume Next\n    rs.MoveLast\n    rs.MoveFirst\nOn Error GoTo 0\n    Do While Not rs.EOF\n        Debug.Print rs.AbsolutePosition\n        MA_ID = Nz(rs.fields(\"MA_ID\"), 0)\n        ZUO_ID = rs.fields(\"ID\")\n        VA_ID = rs.fields(\"VA_ID\")\n        If MA_ID <> 0 Then _\n            Call calc_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID)\n            'Debug.Print VAStart_ID & \"  \" & ZUO_ID & \"  \" & MA_ID\n        rs.MoveNext\n    Loop\n\nEnd Function\n\n\n'Stunden- & Kostenberechnung komplett NV\nFunction calc_NV_Stunden_complete()\n\nDim rs      As Recordset\nDim MA_ID   As Long\nDim NV_ID   As Long\nDim sql     As String\n    \n    sql = \"SELECT * FROM \" & NVERFUEG & \" WHERE vonDat >= \" & datumSQL(\"01.01.2023\")\n    Set rs = CurrentDb.OpenRecordset(sql)\nOn Error Resume Next\n    rs.MoveLast\n    rs.MoveFirst\nOn Error GoTo 0\n    Do While Not rs.EOF\n        Debug.Print rs.AbsolutePosition\n        MA_ID = Nz(rs.fields(\"MA_ID\"), 0)\n        NV_ID = rs.fields(\"ID\")\n        If MA_ID <> 0 Then _\n            Call calc_NV_Stunden(NV_ID, MA_ID)\n        rs.MoveNext\n    Loop\n\nEnd Function\n\n\n'Stunden- & Kostenberechnung für subunternehmer\nFunction calc_ZUO_Stunden_sub(VA_ID As Long, MA_ID As Long)\n\nDim rs      As Recordset\nDim ZUO_ID  As Long\nDim sql     As String\nDim ids     As String\n    \n    ids = select_in_string(ZUORDNUNG, \"ID\", \"VA_ID = \" & VA_ID & \" AND MA_ID = \" & MA_ID)\n    Debug.Print ids\n    \n    sql = \"SELECT * FROM \" & ZUORDNUNG & \" WHERE VA_ID = \" & VA_ID & \" AND MA_ID = \" & MA_ID\n    Set rs = CurrentDb.OpenRecordset(sql)\nOn Error Resume Next\n    rs.MoveLast\n    rs.MoveFirst\nOn Error GoTo 0\n    Do While Not rs.EOF\n        ZUO_ID = rs.fields(\"ID\")\n        Call calc_ZUO_Stunden(ZUO_ID, MA_ID, VA_ID)\n        rs.MoveNext\n    Loop\n\nEnd Function\n"}
