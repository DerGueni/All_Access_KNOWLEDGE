{"id":"MOD_zmd_Sync","name":"zmd_Sync","kind":"standard","procedures":[],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":["DELETE * FROM "],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n    \n''Zusagen/Absagen synchronisieren   -> Nicht mehr in Verwendung, läuft per Job\n'Function synchronisieren() As String\n'\n'Dim SQL         As String\n'Dim CRITERIA    As String\n'Dim rst         As Recordset\n'Dim MA_ID       As String\n'Dim VA_ID       As String\n'Dim VADatum_ID  As String\n'Dim VAStart_ID  As String\n'\n'\n'On Error GoTo Err_Sync\n'\n'    'SyncDb leeren\n'    SQL = \"DELETE * FROM \" & SYNC\n'    CurrentDb.Execute SQL\n'\n'    'Daten aus SyncDB laden\n'    SQL = \"INSERT INTO \" & SYNC & _\n'                \" SELECT * FROM \" & SYNC & \" IN '\" & SyncPfad & SYNCDB & \"'\" & _\n'                \" WHERE [Sync] = FALSE AND MA_ID <> 0 \"\n'    CurrentDb.Execute SQL\n'\n'    'Zusagen/Absagen eintragen, wenn Synchronisation erfolgreich\n'    Set rst = CurrentDb.OpenRecordset(SYNC)\n'\n'    'Daten zum Synchronisieren vorhanden?\n'    If rst.RecordCount > 0 Then\n'        Do\n'            MA_ID = rst.Fields(\"MA_ID\")\n'            VA_ID = rst.Fields(\"VA_ID\")\n'            VADatum_ID = rst.Fields(\"VADatum_ID\")\n'            VAStart_ID = rst.Fields(\"VAStart_ID\")\n'\n'            CRITERIA = \"MA_ID = \" & MA_ID & \" AND VA_ID = \" & VA_ID & _\n'                        \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID\n'\n'            Select Case rst.Fields(\"Zusage\")\n'                Case True\n'                    'Planungstabelle updaten\n'                    TUpdate \"Status_ID = 3\", PLANUNG, CRITERIA\n'\n'                    'Satz in Zuordnungstabelle schreiben\n'                    synchronisieren = einplanen(MA_ID, VA_ID, VADatum_ID, VAStart_ID)\n'\n'                    'Rückgabewert aufbereiten, wenn nötig\n'                    If synchronisieren <> \"OK\" Then synchronisieren = synchronisieren & vbCrLf & _\n'                        \"Mitarbeiter \" & MA_ID & \" konnte nicht eingeplant werden!\"\n'\n'                Case False\n'                    'Planungstabelle updaten\n'                    TUpdate \"Status_ID = 4\", PLANUNG, CRITERIA\n'            End Select\n'\n'            'Datensatz in SyncDB als synchronisiert markieren\n'            If synchronisieren = \"OK\" Or synchronisieren = \"\" Then\n'                SQL = \"UPDATE \" & SYNC & \" IN '\" & SyncPfad & SYNCDB & \"'\" & _\n'                    \" SET [Sync] = TRUE\" & \" WHERE \" & CRITERIA\n'                CurrentDb.Execute SQL\n'            End If\n'\n'            rst.MoveNext\n'\n'        Loop Until rst.EOF\n'\n'        'Synchronisierte Sätze im Backend löschen\n'        CurrentDb.Execute \"DELETE * FROM \" & SYNC\n'\n'    End If\n'\n'    'Wenn Absage -> kein Einplanen -> OK\n'    If synchronisieren = \"\" Then synchronisieren = \"OK\"\n'\n'End_Sync:\n'    Exit Function\n'Err_Sync:\n'    synchronisieren = Err.Number & \" \" & Err.Description\n'    Resume End_Sync\n'End Function\n\n\n''Mitarbeiter von Planungstabelle in Zuordnungstabelle übertragen\n'Function einplanen(MA_ID As String, VA_ID As String, VADatum_ID As String, VAStart_ID As String) As String\n'\n'Dim SQL         As String\n'Dim rst         As Recordset\n'Dim CRITERIA    As String\n'Dim CRITERIA2   As String 'Vorbelegungssätze mit MA_ID = 0\n'\n''Benötigte Felder\n'Dim MVA_Start       As Date\n'Dim MVA_Ende        As Date\n'Dim VADatum         As Date\n'Dim RL34a           As Boolean\n'Dim PosNr           As Integer\n'\n'\n'On Error GoTo Err_Einplan\n'\n'    CRITERIA = \"MA_ID = \" & MA_ID & \" AND VA_ID = \" & VA_ID & \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID\n'    CRITERIA2 = \"MA_ID = 0 AND VA_ID = \" & VA_ID & \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID\n'\n'    'Felder aus Planung lesen\n'On Error Resume Next\n'    MVA_Start = TLookup(\"MVA_Start\", PLANUNG, CRITERIA)\n'    MVA_Ende = TLookup(\"MVA_Start\", PLANUNG, CRITERIA)\n'    VADatum = TLookup(\"VADatum \", PLANUNG, CRITERIA)\n'    RL34a = TLookup(\"Hat_keine_34a\", MASTAMM, \"ID = \" & MA_ID)\n'On Error GoTo Err_Einplan\n'\n'\n'\n'    'Wenn bereits Sätze mit MA_ID = 0 (Vorbelegungen) in der Zuordnung sind, müssen diese verwendet werden!\n'    'Wenn nicht, müssen neue Sätze angelegt werden!\n'    SQL = \"SELECT * FROM [\" & ZUORDNUNG & \"] WHERE \" & CRITERIA2\n'\n'    'Recordset über Vorbelegungssätze in der Zuordnung\n'    Set rst = CurrentDb.OpenRecordset(SQL)\n'\n'    'Fall 1: Es sind (noch) Vorbelegungssätze vorhanden -> nächsten freien Satz Verwenden!\n'    If rst.RecordCount > 0 Then\n'        rst.Edit\n'        rst.Fields(\"MA_ID\") = MA_ID\n'        rst.Update\n'        rst.Close\n'\n'    'Fall 2: Keine Vorbelegungen (mehr) vorhanden -> neuen Satz anlegen\n'    Else\n'        PosNr = TMax(\"PosNr\", ZUORDNUNG, \"VA_ID = \" & VA_ID) + 1\n'        rst.Close\n'        Set rst = Nothing\n'\n'        Set rst = CurrentDb.OpenRecordset(ZUORDNUNG)\n'        rst.Edit\n'        rst.AddNew\n'\n'        'Datensatz füllen\n'        rst.Fields(\"MA_ID\") = MA_ID\n'        rst.Fields(\"VA_ID\") = VA_ID\n'        rst.Fields(\"VADatum_ID\") = VADatum_ID\n'        rst.Fields(\"VAStart_ID\") = VAStart_ID\n'        rst.Fields(\"VADatum\") = VADatum\n'        rst.Fields(\"MA_Start\") = MVA_Start\n'        rst.Fields(\"MA_Ende\") = MVA_Ende\n'        rst.Fields(\"PosNr\") = PosNr\n'        rst.Fields(\"Info\") = \"Überschuss\"\n'        'RST.Fields(\"RL34a\") = RL34a    ' --> WÄHRUNG !!! Muss anhand der Stunden kalkuliert werden\n'\n'        rst.Update\n'        rst.Close\n'\n'    End If\n'\n'\n'     einplanen = \"OK\"\n'\n'\n'End_Einplan:\n'    Set rst = Nothing\n'    Exit Function\n'Err_Einplan:\n'    einplanen = Err.Number & \" \" & Err.Description\n'    Resume End_Einplan\n'End Function\n\n\n''Positionsnummer ermitteln\n'Function detect_posnr(VA_ID As String) As Integer\n'\n'    detect_posnr = TMax(\"PosNr\", ZUORDNUNG, \"VA_ID = \" & VA_ID) + 1\n'\n'End Function"}
