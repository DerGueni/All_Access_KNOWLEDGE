{"id":"MOD_mdl_CONSEC_Excel","name":"mdl_CONSEC_Excel","kind":"standard","procedures":["Function dirkurz(da As String)","Function Cons_XL_Import_1()","Function Cons_XL_Import_2(dtName As String, iAufArt As Long)","Function Cons_XL_Import_Test()"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\nDim db As DAO.Database\nDim rst1 As DAO.Recordset\nDim rst2 As DAO.Recordset\nDim rst3 As DAO.Recordset\nDim xl As New clsExcel\n\nFunction dirkurz(da As String)\ndirkurz = Dir(da)\nEnd Function\n\nFunction Cons_XL_Import_1()\n\nDim dtName As String\nDim sPath As String\nDim sName As String\nDim iAufArt As Long\n\nCurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag;\")\nCurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_ZeitVorgabe;\")\nCurrentDb.Execute (\"DELETE * FROM tbl_XL_Auftrag_Einsatz;\")\n\nDoEvents\n\nSet db = CurrentDb\n\nSet rst1 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag;\")\nSet rst2 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_ZeitVorgabe;\")\nSet rst3 = db.OpenRecordset(\"SELECT * FROM tbl_XL_Auftrag_Einsatz;\")\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, iZl As Long, iCol As Long\nrecsetSQL1 = \"Select Path, FDName, AuftrArt FROM tbl_XL_Auftrag_ZZZ_Dateinamen;\"\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\nIf ArrFill_DAO_OK1 Then\n    For iZl = 0 To iZLMax1\n        sPath = DAOARRAY1(0, iZl)\n        sName = DAOARRAY1(1, iZl)\n        iAufArt = DAOARRAY1(2, iZl)\n        dtName = sPath & sName\n        If File_exist(dtName) Then\n            Call Cons_XL_Import_2(dtName, iAufArt)\n            \n            DoEvents\n            DBEngine.Idle dbRefreshCache\n            DBEngine.Idle dbFreeLocks\n            DoEvents\n\n        End If\n    Next iZl\n    Set DAOARRAY1 = Nothing\nEnd If\n\nrst1.Close\nrst2.Close\nrst3.Close\n\nSet rst1 = Nothing\nSet rst2 = Nothing\nSet rst3 = Nothing\n\n\nEnd Function\n\nFunction Cons_XL_Import_2(dtName As String, iAufArt As Long)\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, iZl As Long, iCol As Long\nDim i As Long, jj As Long, j As Long\nDim iAufNr As Long\nDim rg\nDim iZeile As Long, iSpalte As Long\nDim iKorr As Long\nDim istOk As Boolean\n\nDim rst As Object\nDim iLauf As Long\nDim iStart As Long\n'rg = Row, column\n'################\n\nxl.XL_Wkb_Open_RDOnly (dtName)\nSleep 20\nDoEvents\n\nIf xl.SelectSheet_Test(\"Liste\") = False Then GoTo XL_Ende\n'If XL.xlSheetCount <> 2 Then GoTo XL_Ende\n\nxl.SelectSheet (\"Liste\")\nDoEvents\n\n'Public Function SetRange(IRow As Long, iCol As Long, IRowEnd As Long, IColEnd As Long) As Object\n' Set rg = XL.SetRange(1, 1, ilarow, 3)\n\n' Test auf Zeile 17 und Spalte 41 \"PKW\"\n\niZeile = 17\niSpalte = 41\nSet rg = xl.SetRange(iZeile, iSpalte, iZeile + 1, iSpalte)\n\nistOk = False\nIf Nz(rg(1, 1)) = \"PKW\" Then\n    istOk = True\n    iKorr = 0\nElseIf Nz(rg(2, 1)) = \"PKW\" Then\n    istOk = True\n    iKorr = 1\nEnd If\n\nIf istOk Then\n    For jj = 1 To 3\n        If jj = 1 Then\n            Set rst = rst1\n        ElseIf jj = 2 Then\n            Set rst = rst2\n        ElseIf jj = 3 Then\n            Set rst = rst3\n        End If\n        recsetSQL1 = \"Select Feldname, AnzZeilen, Zeile, Spalte FROM tbl_XL_Auftrag_ZZ_Interne_PositionsNr WHERE TabTyp = \" & jj & \";\"\n        \n        ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n        'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n        iStart = 1\n        If ArrFill_DAO_OK1 Then\n            iLauf = DAOARRAY1(1, 0)\n            If jj = 2 Then\n                iLauf = iLauf + iKorr\n            End If\n            If jj = 3 Then\n                iStart = iStart + iKorr\n                iLauf = iLauf - iKorr\n            End If\n            With rst\n                For j = iStart To iLauf\n                   .AddNew\n                        If jj = 1 Then\n                            .fields(\"ImpArt\") = iAufArt\n                            .fields(\"Dateiname\") = dtName\n                        Else\n                            .fields(\"Auf_ID\") = iAufNr\n                        End If\n                        For iZl = 0 To iZLMax1\n                            iZeile = DAOARRAY1(2, iZl) + j - 1\n                            iSpalte = DAOARRAY1(3, iZl)\n                            Set rg = xl.SetRange(iZeile, iSpalte, iZeile, iSpalte)\n                            .fields(DAOARRAY1(0, iZl)) = Nz(rg(1, 1))\n                            If DAOARRAY1(0, iZl) = \"Gname\" And Len(Trim(Nz(rg(1, 1)))) = 0 Then\n                                Exit For\n                            End If\n                        Next iZl\n                   If jj = 3 Then\n                        If Len(Trim(Nz(.fields(\"Gname\")))) > 0 Then\n                            .update\n                        End If\n                   ElseIf jj = 2 Then\n                        If Len(Trim(Nz(.fields(\"Anz\")))) > 0 Then\n                            .update\n                        End If\n                   Else\n                       .update\n                    End If\n                Next j\n                DoEvents\n                If jj = 1 Then\n                    iAufNr = TMax(\"ID\", \"tblZZZ_XL_Auftrag\")\n                End If\n                Set DAOARRAY1 = Nothing\n            End With\n        End If\n    Next jj\nEnd If\n\nXL_Ende:\n\nxl.XL_Close_Sure\n\nEnd Function\n\n\nFunction Cons_XL_Import_Test()\n\nCurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag;\")\nCurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_ZeitVorgabe;\")\nCurrentDb.Execute (\"DELETE * FROM tbl_XL_Auftrag_Einsatz;\")\n\nDoEvents\n\nSet db = CurrentDb\n\nSet rst1 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag;\")\nSet rst2 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_ZeitVorgabe;\")\nSet rst3 = db.OpenRecordset(\"SELECT * FROM tbl_XL_Auftrag_Einsatz;\")\n\n\n    Cons_XL_Import_2 \"C:\\Kunden\\CONSEC (Siegert)\\Aufträge_alt\\01-05-15 Single Party Terminal 90.xlsm\", 1\n    Cons_XL_Import_2 \"C:\\Kunden\\CONSEC (Siegert)\\Aufträge_alt\\03-04-15 IWA 2015.xls\", 1\n    \nrst1.Close\nrst2.Close\nrst3.Close\n\nSet rst1 = Nothing\nSet rst2 = Nothing\nSet rst3 = Nothing\n\nEnd Function"}
