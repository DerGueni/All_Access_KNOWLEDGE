{"id":"MOD_mdl_Textbaustein","name":"mdl_Textbaustein","kind":"standard","procedures":["Function Fill_TB_Array()","Function Textbau_Ersetz(Inpstring As String, Optional P1 As Variant, Optional P2 As Variant, Optional p3 As Variant) As String","Function P3_Test(p3 As Variant) As Boolean","Function Suche_Textbaustein(Suchstr As String, Suchfeld As String, iStart As Long, iLen As Long, Optional P1 As Variant, Optional P2 As Variant, Optional p3 As Variant) As String","Function Textbau_Replace_Felder_Fuellen(iDocNr As Long)","Function fReplace_Table_Felder_Ersetzen(iRch_KopfID As Long, kun_ID As Long, MA_ID As Long, VA_ID As Long)"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n\n\n'Flexible Ersetzung von [xxx] Feldern in Word und in Fliesstexten\n'################################################################\n\n' Dazu gibt es auf der >Word-Vorlagen-Seite< die Tabellen \"_tblEigeneFirma_TB_Dok_Dateinamen\"  \"_tblEigeneFirma_TB_Dok_Feldnamen\"  und \"_tblEigeneFirma_TB_Dok_Typ\"\n'  ...Dateinamen beschreibt die aktuell gespeicherte Word-Textvorlage, aus der die zu ersetzenden Werte stammen\n'  ...Feldnamen beschreibt die in den einzelnen Vorlagen aktuell verwendeten Eresetzungsnamen  [R_Hugo]\n'  ...Dok_Typ beschreibt die Art der Vorlage (Kunde / Mitarbeiter - auch für Sonderbehandung / Rechnung / Angebotz / Mahnung notwendig)\n\n' Zusätzlich existieren für die >Access-Tabellen-Seite< die Tabellen \"tbl_Textbaustein_Namen\", \"tbl_Textbaustein_Herkunft\",\"tbl_Textbaustein_Namen\"\n' ...Namen beschreibt die Zuordnung zwischen Ersetzungsnamen [R_Rg_Nr] und dem Feldnamen\n' ...Herkunft beschreibt die Herkunftsabfrage der Feldnamen\n' ...Typen beschreibt den Feldtypen und das prinzipielle \"ToDo\" für den Feldtyp\n\n'Grundidee: Zu jeder der 5 derzeit abgebildeten Tabellengrundtypen ...\n'   a) Kunde         kun_ID\n'   b) Mitarbeiter   MA_ID\n'   c) Auftrag       VA_ID   - Wenn kun_ID hinterlegt auch alle Felder aus Kunde\n'   d) Rechnung      iRch_KopfID - interne Rechnungsnummer - Wenn kun_ID hinterlegt auch alle Felder aus Kunde\n'                       Mahnungsdaten sind Teil des Rechnungskopfes\n'   e) Intern        Eigene Firma & Büro-Mitarbeiter (Ausnahme) Statt PK wird hier atcNames(1) als PK verwendet\n\n'   ...existiert eine Abfrage \"qty_Textbaustein_xxx\", die alle Felder aus der jeweiligen Tabelle bereits als Text aufbereitet enthält.\n\n' Jede Word-Vorlage muss dem System vorher bekanntgemacht werden, damit deren Ersetzungswerte in die og Tabellen aufgenommen werden.\n' Dafür gibt es das Formular : \"frmTop_Neue_Vorlagen\"\n\n' Das Feld \"P1\" enthält den Feldnamen des Primärschlüssels\n' Parallel dazu existiert ein Control mit dem aktiellen Wert des PK und dem gleichen Namen wie \"P1\"\n\n' Derzeit erlaubte PK-Felder und Werte sind:\n\n'  Numerisch Long   .Fields(\"P1Typ\") <> 0\n'###########\n'   kun_ID\n'   MA_ID\n'   iRch_KopfID\n'   VA_ID\n\n'  Ausnahme als String  .Fields(\"P1Typ\") = 0\n'#####################\n'  Loginname = atcNames(1)\n\n' In die lokale Temp-Tabelle \"tbltmp_Textbaustein_Ersetzung\" werden die für die jeweilige Wordvorlage passenden Werte eingetragen\n' Die wichtgsten sind\n'       Dok_Nr              Die Nummer unter der die Vorlage geunden wird\n'       Tb_Name_Kl          Der \"[SuchString]\" mit Klammern\n'       Feldname            Der Feldname, der die Ersetzung erhält\n'       Ersetzung           Der zu ersetzende Wert\n'       QryFeldname         die Abfrage, in der die Ersetzung zu finden ist\n'       P1                  Sowohl Feld- als auch Controlname des Primary Keys\n'       P1Typ               0 = atcnames(1)     1 = Long-Wert für P1\n'\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, TextBau_ARRAY1, TextBau_ARRAY_Name1, iZl As Long, iCol As Long\n\nFunction Fill_TB_Array()\n\nIf Not IsArray(TextBau_ARRAY1) Then\n    recsetSQL1 = \"qry_Textbaustein_Pgm\"\n    '''Zusatztabelle mit Feldnamen (Zeile 0) und Feldtypen als Long (Zeile 1) und als Text (Zeile 2)\n    'ArrFill_DAO_OK1 = ArrFill_DAO(recsetSQL1, iZLMax1, iColMax1, TextBau_ARRAY1, TextBau_ARRAY_Name1)\n    ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, TextBau_ARRAY1)\n    'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\nEnd If\n\nEnd Function\n\n\nFunction Textbau_Ersetz(Inpstring As String, Optional P1 As Variant, Optional P2 As Variant, Optional p3 As Variant) As String\n\nDim Suchfeld As String\nDim Suchfeld1 As String\nDim Suchfeld2 As String\nDim ergebnis As String\nDim iSuchfeld_len As Long\nDim iStart As Long\nDim iEnde As Long\nDim iLen As Long\nDim iZlAkt As Long\nDim iArr As Long\n\n\nTextbau_Ersetz = Nz(Inpstring)\nIf Len(Trim(Nz(Inpstring))) = 0 Then Exit Function\n\nFill_TB_Array\nIf Not ArrFill_DAO_OK1 Then Exit Function\n\n'TextBau_ARRAY1\n'Field Name\n'==========\n' 0            Herkunftsname                10           Text\n' 1            TextBausteinName             10           Text\n' 2            Feldname                     10           Text\n' 3            Feldtyp                       4           Long Integer\n' 4            Todo                          4           Long Integer\n' 5            ToDo_Info                    10           Text\n' 6            P1                           10           Text\n' 7            P2                           10           Text\n' 8            P3                           10           Text\n' 9            Herkunft_ID                   4           Long Integer\n' 10           P1Typ                         4           Long Integer\n' 11           P2Typ                         4           Long Integer\n' 12           P3Typ                         4           Long Integer\n'==========\n\n\n'CurrentDb.Execute (\"DELETE * FROM Textbaustein_Replace\")\nDoEvents\n\niStart = 0\n\nergebnis = Inpstring\n    \n'Suche den Text nach [ ab\nSuchfeld1 = \"[\"\nSuchfeld2 = \"]\"\n\niStart = 1\nDo\n    iStart = Nz(InStr(iStart, ergebnis, Suchfeld1, vbTextCompare), 0)\n    If iStart > 0 Then\n        iEnde = Nz(InStr(iStart, ergebnis, Suchfeld2, vbTextCompare), 0)\n        If iEnde > 0 Then\n' Für jede gefundene [Text] Kombination suche, ob dieser String als Textbaustein definiert ist\n            Suchfeld = Mid(ergebnis, iStart, iEnde - iStart + 1)\n            iLen = Len(Suchfeld)\n            For iZl = 0 To iZLMax1\n                If UCase(CStr(Nz(TextBau_ARRAY1(1, iZl)))) = UCase(Suchfeld) Then ' Ersetze\n                    ergebnis = Suche_Textbaustein(ergebnis, Suchfeld, iStart, iLen, P1, P2, Nz(p3))\n                    Exit For\n                End If\n            Next iZl\n        End If\n        iStart = iStart + 1\n    End If\nLoop While iStart > 0\n\nTextbau_Ersetz = ergebnis\n\nEnd Function\n\nFunction P3_Test(p3 As Variant) As Boolean\nDim i As Long\n\n   On Error GoTo P3_Test_Error\n   i = Len(Trim(Nz(p3)))\n    P3_Test = True\n\n   On Error GoTo 0\n   Exit Function\n\nP3_Test_Error:\n    P3_Test = False\nEnd Function\n\n\nFunction Suche_Textbaustein(Suchstr As String, Suchfeld As String, iStart As Long, iLen As Long, Optional P1 As Variant, Optional P2 As Variant, Optional p3 As Variant) As String\n\n'TextBau_ARRAY1\n'Field Name\n'==========\n' 0            Herkunftsname                10           Text\n' 1            TextBausteinName             10           Text\n' 2            Feldname                     10           Text\n' 3            Feldtyp                       4           Long Integer\n' 4            Todo                          4           Long Integer\n' 5            ToDo_Info                    10           Text\n' 6            P1                           10           Text\n' 7            P2                           10           Text\n' 8            P3                           10           Text\n' 9            Herkunft_ID                   4           Long Integer\n' 10           P1Typ                         4           Long Integer\n' 11           P2Typ                         4           Long Integer\n' 12           P3Typ                         4           Long Integer\n'==========\n\n'ToDo Liste\n'   1 = integerzahl\n'   2 = Nachkommazahl\n'   3 = Datum\n'   4 = Text\n'   5 = Ja/Nein\n\nDim varErg As Variant\nDim ergebnis As String\nDim ErsetztDurch As String\nDim WhereStr As String\nDim i As Long\nDim p(1 To 3)\nDim j As Long\n\nFill_TB_Array\nIf Not ArrFill_DAO_OK1 Then Exit Function\n\nj = 2\np(1) = Nz(P1)\np(2) = Nz(P2)\nIf P3_Test(p3) Then\n    p(3) = Nz(p3)\n    j = 3\nEnd If\n    \nIf TextBau_ARRAY1(9, iZl) = 1 Then  'hart codiert auf den Login des Users wenn ein Textbaustein aus qry_Textbaustein_Firma_Mitarbeiter ...\n    If TCount(\"Int_Login\", \"_tblEigeneFirma_Mitarbeiter\", \"Int_Login = '\" & atCNames(1) & \"'\") = 0 Then\n        i = Get_Priv_Property(\"prp_Notfall_Int_PersonalNr\")\n        WhereStr = \"Int_PersonalNr = '\" & i & \"'\"\n    Else\n        WhereStr = \"int_login = '\" & atCNames(1) & \"'\"\n    End If\nElse\n    'Feld entweder Numerisch oder Text oder Datum (im moment kein Datum)\n    WhereStr = \"1 = 1\"\n    \n    For i = 1 To j\n        If Len(Trim(Nz(TextBau_ARRAY1(i + 5, iZl)))) > 0 And Len(Trim(Nz(p(i)))) > 0 And TextBau_ARRAY1(i + 9, iZl) > 0 Then  ' Wenn Paramter P1 bis 3 und Parametertyp nicht leer\n            If TextBau_ARRAY1(i + 9, iZl) = 4 Then\n                WhereStr = WhereStr & \" AND \" & CStr(TextBau_ARRAY1(i + 5, iZl)) & \" = '\" & p(i) & \"'\"\n            ElseIf TextBau_ARRAY1(i + 9, iZl) < 3 Then\n                WhereStr = WhereStr & \" AND \" & CStr(TextBau_ARRAY1(i + 5, iZl)) & \" = \" & str(p(i))\n            ElseIf TextBau_ARRAY1(i + 9, iZl) = 3 Then\n                WhereStr = WhereStr & \" AND \" & CStr(TextBau_ARRAY1(i + 5, iZl)) & \" = \" & SQLDatum(p(i))\n            End If\n        End If\n    Next i\nEnd If\n\nvarErg = Nz(TLookup(CStr(TextBau_ARRAY1(2, iZl)), CStr(TextBau_ARRAY1(0, iZl)), WhereStr))\n\nSelect Case TextBau_ARRAY1(4, iZl)  ' Behandlung abhängig vom Feldtyp\n    Case 5  ' Ja/Nein\n    \n        If varErg = True Then\n            ErsetztDurch = \"Ja\"\n        Else\n            ErsetztDurch = \"Nein\"\n        End If\n    \n    Case 4  ' Text\n        ErsetztDurch = varErg\n    \n    Case 3  ' Datum - kommt nicht vor - bereits in Abfrage nach Text umgewandelt, da es durchaus verschiedene gewünschte Formate sein können\n        ErsetztDurch = Format(varErg, \"dd.mm.yyyy\")\n    \n    Case 2  ' Zahl mit Nachkomma\n        ErsetztDurch = str(varErg)\n        \n    Case 1  ' Integer\n        ErsetztDurch = str(varErg)\n    \n    Case Else\n        ErsetztDurch = varErg\n\nEnd Select\n    \n'Suchstr As String, Suchfeld As String, iStart As Long, iLen As Long,\n\nergebnis = Left(Suchstr, iStart - 1) & ErsetztDurch & Mid(Suchstr, iStart + iLen)\nSuche_Textbaustein = ergebnis\nEnd Function\n\nFunction Textbau_Replace_Felder_Fuellen(iDocNr As Long)\n\n'Füllt die Tabelle tbltmp_Textbaustein_Ersetzung mit den Feldnamen aus dem Dokument mit der übergebenenen Nr\n\nDim strSQL As String\n\nCurrentDb.Execute (\"DELETE * FROM tbltmp_Textbaustein_Ersetzung\")\nDoEvents\n\nstrSQL = \"\"\n\nstrSQL = strSQL & \"INSERT INTO tbltmp_Textbaustein_Ersetzung ( DokNr, TB_Name_Kl, Feldname, QryFeldname, P1, P1Typ )\"\nstrSQL = strSQL & \" SELECT qry_Textbaustein_Replace_Insert_Vorlage.DokNr, TB_Name_Kl, qry_Textbaustein_Replace_Insert_Vorlage.Feldname,\"\nstrSQL = strSQL & \" qry_Textbaustein_Replace_Insert_Vorlage.Herkunftsname, qry_Textbaustein_Replace_Insert_Vorlage.P1,\"\nstrSQL = strSQL & \" qry_Textbaustein_Replace_Insert_Vorlage.P1Typ\"\nstrSQL = strSQL & \" FROM qry_Textbaustein_Replace_Insert_Vorlage\"\nstrSQL = strSQL & \" WHERE (((qry_Textbaustein_Replace_Insert_Vorlage.DokNr)= \" & iDocNr & \"));\"\n\nCurrentDb.Execute (strSQL)\n\nEnd Function\n\n\nFunction fReplace_Table_Felder_Ersetzen(iRch_KopfID As Long, kun_ID As Long, MA_ID As Long, VA_ID As Long)\n' Die zu ersetzenden Werte aus der Tabelle tbltmp_Textbaustein_Ersetzung werden hier ersetzt.\n' Dazu muss der PK-Wert der jeweiligen Tabelle bekannt sein.\n\n\n'   QryFeldnameQryFeldname\n\nDim Loginname As String\nDim iWert As Long\n\n'Dim iRch_KopfID As Long\n'Dim kun_ID As Long\n'Dim MA_ID As Long\n'Dim VA_ID As Long\n\nDim db As DAO.Database\nDim rst As DAO.Recordset\n\nDim qryName As String\nDim fldName As String\nDim strWHERE As String\nDim sufld As String\n\nLoginname = atCNames(1)\n\nSet db = CurrentDb\nSet rst = db.OpenRecordset(\"SELECT * FROM tbltmp_Textbaustein_Ersetzung ORDER BY ID\", dbOpenDynaset)\n    \n    With rst\n        Do While Not .EOF\n            .Edit\n                Select Case .fields(\"P1\")\n                    Case \"kun_ID\"\n                        iWert = kun_ID\n                    Case \"MA_ID\"\n                        iWert = MA_ID\n                    Case \"Rch_ID\"\n                        iWert = iRch_KopfID\n                    Case \"VA_ID\"\n                        iWert = VA_ID\n                    Case Else\n                End Select\n            \n                If .fields(\"P1Typ\") = 0 Then ' int_Login Sonderfall atcnames(1) verwenden\n                    qryName = .fields(\"QryFeldname\")\n                    fldName = .fields(\"Feldname\")\n                    strWHERE = .fields(\"P1\") & \" = '\" & Loginname & \"'\"\n                    sufld = Nz(TLookup(fldName, qryName, strWHERE))\n                Else\n                    qryName = .fields(\"QryFeldname\")\n                    fldName = .fields(\"Feldname\")\n                    strWHERE = .fields(\"P1\") & \" = \" & iWert\n                    sufld = Nz(TLookup(fldName, qryName, strWHERE))\n                End If\n                .fields(\"Ersetzung\") = sufld\n                \n            .update\n            .MoveNext\n        Loop\n        .Close\n    End With\n    Set rst = Nothing\n\n\nEnd Function"}
