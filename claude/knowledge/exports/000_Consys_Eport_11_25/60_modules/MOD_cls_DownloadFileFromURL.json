{"id":"MOD_cls_DownloadFileFromURL","name":"cls_DownloadFileFromURL","kind":"standard","procedures":["Private Sub Class_Initialize()","Private Sub Class_Terminate()","Public Sub DoDownload()","Private Function CheckPrerequisites() As Boolean","Private Function getInternetSession() As Long","Private Function getFileHandle(ByRef hInternetSession As Long) As Long","Private Function getFileSize(ByRef hInternetSession As Long, ByRef hFile As Long) As Long","Private Sub WriteFileToDisk(ByVal strFileData As String)","Private Sub VorhandeneDateiLoeschen()"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n'################################################################\n'    Autor:  Thomas Möller\n' Homepage:  www.team-Moeller.de\n'   E-Mail:  Access@Team-Moeller.de\n'################################################################\n\n'################################################################\n' Version:  1.0\n'   Stand:  31.03.2011\n'################################################################\n\n'################################################################\n' Quelle:\n' Diese Klasse basiert auf dem Code von Jonathan Haas\n' http://www.activevb.de/rubriken/klassen/internet/cdownload.html\n'################################################################\n\n'################################################################\n' Geplante Erweiterungen:\n'  - prüfen, ob Dateigröße übereinstimmt, sonst Fehler\n'    Len(strFileData) < lgnFileSize\n'  - prüfen, ob Datei bereits existiert, wenn ja\n'    + Wenn OverrideExistingFile = False => Fehler\n'    + sonst Datei löschen\n'################################################################\n\n\n'API-Deklarationen\n\nPrivate Declare PtrSafe Function InternetOpen Lib \"wininet.dll\" Alias \"InternetOpenA\" _\n        (ByVal lpszAgent As String, ByVal dwAccessType As Long, _\n        ByVal lpszProxyName As String, ByVal lpszProxyBypass As String, _\n        ByVal dwFlags As Long) As Long\n        \nPrivate Declare PtrSafe Function InternetOpenUrl Lib \"wininet.dll\" Alias \"InternetOpenUrlA\" _\n        (ByVal hInternetSession As Long, ByVal lpszUrl As String, _\n        ByVal lpszHeaders As String, ByVal dwHeadersLength As Long, _\n        ByVal dwFlags As Long, ByVal dwContext As Long) As Long\n        \nPrivate Declare PtrSafe Function InternetCloseHandle Lib \"wininet.dll\" _\n        (ByVal hInet As Long) As Integer\n        \nPrivate Declare PtrSafe Function InternetReadFile Lib \"wininet.dll\" _\n        (ByVal hFile As Long, ByVal lpBuffer As String, _\n        ByVal dwNumberOfBytesToRead As Long, _\n        lNumberOfBytesRead As Long) As Integer\n     \nPrivate Declare PtrSafe Function HttpQueryInfo Lib \"wininet.dll\" Alias \"HttpQueryInfoA\" _\n        (ByVal hHttpRequest As Long, ByVal lInfoLevel As Long, _\n        ByRef sBuffer As Any, ByRef lBufferLength As Long, _\n        ByRef lIndex As Long) As Boolean\n\n\n'Konstanten\n\nPrivate Const INTERNET_OPEN_TYPE_PRECONFIG As Long = 0\nPrivate Const INTERNET_FLAG_EXISTING_CONNECT As Long = &H20000000\nPrivate Const HTTP_QUERY_CONTENT_LENGTH As Long = 5\n\n\n'Enums\n\nPublic Enum DownloadState\n    Ready\n    Connecting\n    Downloading\n    Canceled\n    ErrorOccurred\nEnd Enum\n\nPublic Enum DownloadError\n    URLisMissing\n    FilenameIsMissing\n    ErrorOnConnecting\n    ErrorOnFileHandle\n    FileNotFound\n    TargetFileAlreadyExists\n    Unknown\nEnd Enum\n\n\n'Ereignisse\n\nPublic Event StartDownloading(ByVal Size As Long)\nPublic Event ProgressChanged(ByVal Progress As Double, ByRef Cancel As Boolean)\nPublic Event StateChanged(ByVal State As DownloadState)\n\n\n'Members\n\nPrivate mpstrURL As String\nPrivate mpstrFileName As String\nPrivate mpfOverrideExistingFile As Boolean\nPrivate mplngBufferSize As Long\nPrivate mplngError As Long\n\n\n'Properties\n\nPublic Property Let url(ByVal strURL As String)\n\n    mpstrURL = strURL\n\nEnd Property\n\nPublic Property Let fileName(ByVal strFilename As String)\n\n    mpstrFileName = strFilename\n\nEnd Property\n\nPublic Property Let OverrideExistingFile(ByVal fOverrideExistingFile As Boolean)\n\n    mpfOverrideExistingFile = fOverrideExistingFile\n\nEnd Property\n\nPublic Property Let BufferSize(ByVal lngBuffersize As Long)\n\n    mplngBufferSize = lngBuffersize\n\nEnd Property\n\nPublic Property Get Error() As Long\n\n    Error = mplngError\n\nEnd Property\n\n\n'Klasse verwalten\n\nPrivate Sub Class_Initialize()\n\n    'Standardwert vorbelegen\n    mpfOverrideExistingFile = False\n    mplngBufferSize = 1024\n\nEnd Sub\n\nPrivate Sub Class_Terminate()\n\n    'Keine Aktion\n\nEnd Sub\n\n\n'Methoden\n\nPublic Sub DoDownload()\nOn Error GoTo Error_Handler\n    \n    'Variablen deklarieren\n    Dim hInternetSession As Long\n    Dim hFile As Long\n    Dim lngFileSize As Long\n    Dim Buffer As String\n    Dim ByteAnz As Long\n    Dim strFileData As String\n    Dim dblProgress As Double\n    Dim fCancel As Boolean\n\n    If CheckPrerequisites = False Then Exit Sub\n    \n    'Internet-Session öffnen\n    hInternetSession = getInternetSession\n    If hInternetSession = 0 Then Exit Sub\n    \n    'Download-Datei öffnen\n    hFile = getFileHandle(hInternetSession)\n    If hFile = 0 Then Exit Sub\n    \n    'Dateigröße ermitteln\n    lngFileSize = getFileSize(hInternetSession, hFile)\n    If lngFileSize = 0 Then Exit Sub\n\n    'Buffer vorbelegen\n    Buffer = Space$(mplngBufferSize)\n    \n    'Daten sammeln\n    RaiseEvent StartDownloading(lngFileSize)\n    RaiseEvent StateChanged(Downloading)\n    Do While Not fCancel\n        InternetReadFile hFile, Buffer, Len(Buffer), ByteAnz\n        If ByteAnz = 0 Then Exit Do\n        strFileData = strFileData & Left$(Buffer, ByteAnz)\n        dblProgress = Len(strFileData) / lngFileSize * 100\n        RaiseEvent ProgressChanged(dblProgress, fCancel)\n        If fCancel = True Then RaiseEvent StateChanged(Canceled)\n    Loop\n    \n    'Datei speichern\n    If fCancel = False Then\n        Call WriteFileToDisk(strFileData)\n    End If\n\nExit_Here:\n    On Error Resume Next\n    If hFile Then InternetCloseHandle hFile\n    If hInternetSession Then InternetCloseHandle hInternetSession\n    Exit Sub\n\nError_Handler:\n    Select Case err.Number\n        Case 0\n            Resume Next\n        Case Else\n            mplngError = DownloadError.Unknown\n            RaiseEvent StateChanged(ErrorOccurred)\n            Resume Exit_Here\n    End Select\n\nEnd Sub\n\n\n'Hilfsfunktionen\n\nPrivate Function CheckPrerequisites() As Boolean\n\n    If Len(mpstrURL) = 0 Then\n        mplngError = DownloadError.URLisMissing\n        RaiseEvent StateChanged(ErrorOccurred)\n        Exit Function\n    End If\n\n    If Len(mpstrFileName) = 0 Then\n        mplngError = DownloadError.FilenameIsMissing\n        RaiseEvent StateChanged(ErrorOccurred)\n        Exit Function\n    End If\n    \n    CheckPrerequisites = True\n\nEnd Function\n\nPrivate Function getInternetSession() As Long\n    \n    Dim result As Long\n    \n    RaiseEvent StateChanged(Connecting)\n    result = InternetOpen(\"Download\", INTERNET_OPEN_TYPE_PRECONFIG, _\n                                      vbNullString, vbNullString, 0)\n    If result = 0 Then\n        mplngError = DownloadError.ErrorOnConnecting\n        RaiseEvent StateChanged(ErrorOccurred)\n        Exit Function\n    End If\n\n    getInternetSession = result\n\nEnd Function\n\nPrivate Function getFileHandle(ByRef hInternetSession As Long) As Long\n    \n    Dim result As Long\n    \n    result = InternetOpenUrl(hInternetSession, mpstrURL, vbNullString, 0, _\n                             INTERNET_FLAG_EXISTING_CONNECT, 0)\n    If result = 0 Then\n        mplngError = DownloadError.ErrorOnFileHandle\n        RaiseEvent StateChanged(ErrorOccurred)\n        If hInternetSession Then InternetCloseHandle hInternetSession\n        Exit Function\n    End If\n\n    getFileHandle = result\n\nEnd Function\n\nPrivate Function getFileSize(ByRef hInternetSession As Long, ByRef hFile As Long) As Long\n\n    Dim Buffer As String * 100\n    Dim lngFileSize As Long\n    \n    Call HttpQueryInfo(ByVal hFile, HTTP_QUERY_CONTENT_LENGTH, ByVal Buffer, Len(Buffer), 0)\n    \n    lngFileSize = val(Buffer)\n    \n    If lngFileSize = 0 Then\n        mplngError = DownloadError.FileNotFound\n        RaiseEvent StateChanged(ErrorOccurred)\n        If hInternetSession Then InternetCloseHandle hInternetSession\n        If hFile Then InternetCloseHandle hFile\n        Exit Function\n    End If\n\n    getFileSize = lngFileSize\n\nEnd Function\n\nPrivate Sub WriteFileToDisk(ByVal strFileData As String)\n\n    Dim DatNum As Integer\n\n    ' evtl vorhandene Datei löschen\n    Call VorhandeneDateiLoeschen\n    \n    ' Datei schreiben\n    DatNum = FreeFile\n    Open mpstrFileName For Output As #DatNum\n    Print #DatNum, strFileData;\n    Close #DatNum\n    \n    RaiseEvent StateChanged(Ready)\n\nEnd Sub\n\nPrivate Sub VorhandeneDateiLoeschen()\n\n    On Error Resume Next\n    \n    Kill mpstrFileName\n\nEnd Sub\n"}
