{"id":"MOD_mdl_CONSEC_eMail_Autoimport","name":"mdl_CONSEC_eMail_Autoimport","kind":"standard","procedures":["Function f_eMail_Test()","Function All_eMail_Update()","Function Manuelle_eMail_MA_Zuordnung() As Boolean","Function All_eMail_tbl_MA_VA_Zuordnung_Merge()","Function xemltst()","Function eMail_Ausles(iTyp As Long, strbody As String, strSender As String) As Variant"],"calls":{"DoCmd.OpenForm":["frmTop_eMail_MA_ID_NGef"],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n\nFunction f_eMail_Test()\n\nAll_eMail_Update\nIf Manuelle_eMail_MA_Zuordnung() = False Then\n    MsgBox \"Keine manuelle eMail-Zuordnung erforderlich\"\nEnd If\n\nEnd Function\n\nFunction All_eMail_Update()\n\nDim i As Long\n\n'Alle einträge ohne \"Intern:\" im Betreff als Schrott kennzeichnen\nCurrentDb.Execute (\"qry_eMail_Update99_Rest_ohne_Intern\")\n\n'Alle Einträge von Consec selbst ignorieren\nCurrentDb.Execute (\"qry_eMail_Update90_Sender_Consec\")\n\n' Alle Einträge von Vorgestern und früher löschen - keine Leichen\nCurrentDb.Execute (\"qry_eMail_Delete_OldDate\")\n\n'Absage tbl_eMail_Import Feld Zu_Absage = 0\nCurrentDb.Execute (\"qry_Email_finden_Absage\")\n'Zusage tbl_eMail_Import Feld Zu_Absage = -1\nCurrentDb.Execute (\"qry_Email_finden_Zusage\")\n\nDoEvents\n' Datensätze, die keine Zu- oder Absagen sind, löschen (Datensätze, die im Betreff kein \"intern:\" beinhalten)\nCurrentDb.Execute (\"qry_eMail_Delete_Rest\")\nDoEvents\n\n'MA_ID, VA_ID, VADatum_ID, VAStart_ID setzen\nCurrentDb.Execute (\"qry_eMail_finden_MA_VA_Zuordnung\")\nDoEvents\n\n'tbl_MA_VA_Planung update\nCurrentDb.Execute (\"qry_eMail_Update_Absage\")\n\n'tbl_MA_VA_Planung update\nCurrentDb.Execute (\"qry_eMail_Update_Zusage\")\n\n'tbl_MA_VA_Zuordnung update\nAll_eMail_tbl_MA_VA_Zuordnung_Merge\n\n'Alle Zugeordneten löschen\nCurrentDb.Execute (\"DELETE * FROM tbl_eMail_Import WHERE MA_ID > 0 AND Zu_Absage > -2;\")\n\n'Alle Zugeordneten auf \"Erledigt\" setzen\nCurrentDb.Execute (\"qry_eMail_Update_Erledigt\")\n\nIf isFormLoad(\"frm_VA_Auftragstamm\") Then Forms!frm_va_auftragstamm.Requery\nIf isFormLoad(\"frm_MA_VA_Schnellauswahl\") Then Forms!frm_MA_VA_Schnellauswahl.Requery\n\nDoEvents\nDBEngine.Idle dbRefreshCache\nDBEngine.Idle dbFreeLocks\nDoEvents\n\nEnd Function\n\n\nFunction Manuelle_eMail_MA_Zuordnung() As Boolean\n\nDim i As Long\nDim j As Long\n\n    Manuelle_eMail_MA_Zuordnung = False\n\n    'Nicht zuordenbare eMails manuell zuordnen\n    i = Nz(TCount(\"*\", \"qry_eMail_MA_ID_not_found\"), 0)\n    j = Nz(TCount(\"*\", \"tbl_eMail_Import\", \"IstErledigt = 0\"), 0)\n    \n    If i > 0 Or j > 0 Then\n        Manuelle_eMail_MA_Zuordnung = True\n        DoCmd.OpenForm \"frmTop_eMail_MA_ID_NGef\"\n    End If\n\nEnd Function\n\n'-------- interne Funktionen\n\nFunction All_eMail_tbl_MA_VA_Zuordnung_Merge()\nDim iZuo As Long\nDim snetto As Single\nDim iPosNr As Long\nDim iZuo1 As Long\nDim iVA_ID As Long\nDim iVADatum_ID As Long\nDim iVAStart_ID As Long\nDim iMA_ID As Long\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, iZl As Long, iCol As Long\n\nDim strSQL As String\n\nrecsetSQL1 = \"SELECT VA_ID, VADatum_ID, VAStart_ID, MA_ID FROM qry_eMail_Grouping_Zusage WHERE Zu_Absage = -1;\"\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\nIf ArrFill_DAO_OK1 Then\n    For iZl = 0 To iZLMax1\n\n        iVA_ID = Nz(DAOARRAY1(0, iZl), 0)\n        iVADatum_ID = Nz(DAOARRAY1(1, iZl), 0)\n        iVAStart_ID = Nz(DAOARRAY1(2, iZl), 0)\n        iMA_ID = Nz(DAOARRAY1(3, iZl), 0)\n\n        'Zuordnung vorhanden - update\n        iZuo1 = Nz(TCount(\"*\", \"tbl_MA_VA_Zuordnung\", \"VA_ID = \" & iVA_ID & \" AND VADatum_ID = \" & iVADatum_ID & \" AND VAStart_ID = \" & iVAStart_ID & \" AND MA_ID = 0\"), 0)\n        If iZuo1 > 0 Then\n            iZuo = Nz(TLookup(\"ID\", \"tbl_MA_VA_Zuordnung\", \"VA_ID = \" & iVA_ID & \" AND VADatum_ID = \" & iVADatum_ID & \" AND VAStart_ID = \" & iVAStart_ID & \" AND MA_ID = 0\"), 0)\n            If iZuo1 > 0 Then\n                snetto = Nz(TLookup(\"MA_Netto_Std2\", \"tbl_MA_VA_Zuordnung\", \"ID = \" & iZuo), 0)\n                iPosNr = Nz(TLookup(\"PosNr\", \"tbl_MA_VA_Zuordnung\", \"ID = \" & iZuo), 0)\n            \n                strSQL = \"\"\n                strSQL = strSQL & \"UPDATE tbl_MA_VA_Zuordnung, tbl_MA_VA_Planung SET\"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.MA_ID = \" & iMA_ID & \", \"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.RL_34a = \" & str(fctround(RL34a_pro_Std(iMA_ID) * snetto)) & \", \"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.Aend_von = '\" & atCNames(1) & \"', \"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.Aend_am = Now()\"\n                strSQL = strSQL & \" WHERE (((tbl_MA_VA_Zuordnung.ID)= \" & iZuo & \"));\"\n                \n                CurrentDb.Execute (strSQL)\n                \n                'tbl_VA_AnzTage Updaten\n                DoEvents\n                Call VA_AnzTage_Upd(iVA_ID, iVADatum_ID)\n                DoEvents\n            End If\n            \n        Else\n            iZuo = Nz(TLookup(\"ID\", \"tbl_MA_VA_Zuordnung\", \"VA_ID = \" & iVA_ID & \" AND VADatum_ID = \" & iVADatum_ID & \" AND VAStart_ID = \" & iVAStart_ID), 0)\n            If iZuo > 0 Then\n                iPosNr = Nz(TMax(\"PosNr\", \"tbl_MA_VA_Zuordnung\", \"VA_ID = \" & iVA_ID & \" AND VADatum_ID = \" & iVADatum_ID), 0) + 1\n                strSQL = \"\"\n                strSQL = strSQL & \"INSERT INTO tbl_MA_VA_Zuordnung ( VA_ID, VADatum_ID, VAStart_ID, PosNr, MA_ID, MA_Start, MA_Ende, MA_Brutto_Std2,\"\n                strSQL = strSQL & \" MA_Netto_Std2, RL_34a, Erst_von, Erst_am, Aend_von, Aend_am, VADatum, MVA_Start, MVA_Ende )\"\n                strSQL = strSQL & \" SELECT tbl_MA_VA_Zuordnung.VA_ID, tbl_MA_VA_Zuordnung.VADatum_ID, tbl_MA_VA_Zuordnung.VAStart_ID, \" & iPosNr & \" AS Ausdr1,\"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.MA_ID, tbl_MA_VA_Zuordnung.MA_Start, tbl_MA_VA_Zuordnung.MA_Ende,\"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.MA_Brutto_Std2, tbl_MA_VA_Zuordnung.MA_Netto_Std2,\"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.RL_34a, tbl_MA_VA_Zuordnung.Erst_von, tbl_MA_VA_Zuordnung.Erst_am, tbl_MA_VA_Zuordnung.Aend_von,\"\n                strSQL = strSQL & \" tbl_MA_VA_Zuordnung.Aend_am , tbl_MA_VA_Zuordnung.VADatum, tbl_MA_VA_Zuordnung.MVA_Start, tbl_MA_VA_Zuordnung.MVA_Ende\"\n                strSQL = strSQL & \" FROM tbl_MA_VA_Zuordnung WHERE (((tbl_MA_VA_Zuordnung.ID)= \" & iZuo & \"));\"\n    \n                CurrentDb.Execute (strSQL)\n                \n                DoEvents\n                iZuo = Nz(TLookup(\"ID\", \"tbl_MA_VA_Zuordnung\", \"VA_ID = \" & iVA_ID & \" AND VADatum_ID = \" & iVADatum_ID & \" AND VAStart_ID = \" & iVAStart_ID & \" AND PosNr = \" & iPosNr), 0)\n                If iZuo > 0 Then\n                    strSQL = \"\"\n                    strSQL = strSQL & \"UPDATE tbl_MA_VA_Zuordnung, tbl_MA_VA_Planung SET\"\n                    strSQL = strSQL & \" tbl_MA_VA_Zuordnung.MA_ID = \" & iMA_ID & \", \"\n                    strSQL = strSQL & \" tbl_MA_VA_Zuordnung.RL_34a = \" & str(fctround(RL34a_pro_Std(iMA_ID) * snetto)) & \", \"\n                    strSQL = strSQL & \" tbl_MA_VA_Zuordnung.Aend_von = '\" & atCNames(1) & \"', \"\n                    strSQL = strSQL & \" tbl_MA_VA_Zuordnung.Aend_am = Now()\"\n                    strSQL = strSQL & \" WHERE (((tbl_MA_VA_Zuordnung.ID)= \" & iZuo & \"));\"\n                    \n                    CurrentDb.Execute (strSQL)\n                    \n                    'tbl_VA_AnzTage Updaten\n                    DoEvents\n                    Call VA_AnzTage_Upd(iVA_ID, iVADatum_ID)\n                End If\n                DoEvents\n            End If\n        \n        End If\n\n    Next iZl\n    Set DAOARRAY1 = Nothing\nEnd If\n\nEnd Function\n\nFunction xemltst()\nDebug.Print eMail_Ausles(1, \"RE: CONSEC Dienstanfrage -  Di 15.12.2015  - email test email test email test    - Intern: 567 - 132127 - 2215\", \"siegert@consec-nuernberg.de\")\nDebug.Print eMail_Ausles(2, \"RE: CONSEC Dienstanfrage -  Di 15.12.2015  - email test email test email test    - Intern: 567 - 132127 - 2215\", \"siegert@consec-nuernberg.de\")\nDebug.Print eMail_Ausles(3, \"RE: CONSEC Dienstanfrage -  Di 15.12.2015  - email test email test email test    - Intern: 567 - 132127 - 2215\", \"siegert@consec-nuernberg.de\")\nDebug.Print eMail_Ausles(4, \"RE: CONSEC Dienstanfrage -  Di 15.12.2015  - email test email test email test    - Intern: 567 - 132127 - 2215\", \"siegert@consec-nuernberg.de\")\nEnd Function\n\n'Function für Query qry_eMail_finden_MA_VA_Zuordnung\nFunction eMail_Ausles(iTyp As Long, strbody As String, strSender As String) As Variant\n\n'ITyp = 1 = iMA_ID\n'iTyp = 2 = iVA_ID\n'iTyp = 3 = iVADatum_ID\n'iTyp = 4 = iVAStart_ID\n\n'Intern:  203 -  363 -  317 - kobd@gmx.de\n'Intern:  iVA_ID - iVADatum_ID - iVAStart_ID\n\n'\"    - intern: \" & iVA_ID & \" - \" & iVADatum_ID & \" - \" & iVAStart_ID\n'\"    - intern: \" & 1234 & \" - \" & 5678 & \" - \" & 9012\n'\"    - intern: 1234 - 5678 - 9012\"\n\nConst CONST_INTERN As String = \"Intern:\"\n\nDim iMA_ID As Long\nDim iVA_ID As Long\nDim iVADatum_ID As Long\nDim iVAStart_ID As Long\nDim bIsOK As Boolean\nDim iRueck(2) As Long\nDim s As String\nDim s1 As String\nDim il As Long\n\nDim i As Long, j As Long, k As Long\nDim sx As String\n\nbIsOK = False\n    \nil = Len(CONST_INTERN)\ni = InStr(1, strbody, CONST_INTERN, vbTextCompare)\n\nFor k = 0 To 2\n    iRueck(k) = 0\nNext k\n\nIf i > 0 Then\n    \n    s = Mid(strbody, i + il, 35)\n'    Debug.Print \"Start: \" & s\n    For k = 0 To 2\n        j = InStr(1, s, \" - \", vbTextCompare)\n        If j > 0 Then\n            sx = Left(s, j)\n'            Debug.Print \"sx: \" & sx\n            iRueck(k) = CLng(Trim(sx))\n            s = Mid(s, j + 3)\n'            Debug.Print k, iRueck(k), s\n        End If\n    Next k\n    iRueck(2) = s\n    bIsOK = True\nEnd If\n\nSelect Case iTyp\n    Case 1\n        iMA_ID = Nz(TLookup(\"MA_ID\", \"qry_ReplayEmail\", \"Email = '\" & strSender & \"'\"), 0)\n        eMail_Ausles = iMA_ID\n    \n    Case 2, 3, 4\n        If bIsOK Then\n            eMail_Ausles = Nz(iRueck(iTyp - 2), 0)\n        End If\n    \n    Case Else\nEnd Select\n\nEnd Function"}
