{"id":"MOD_zmd_Zeitkonten","name":"zmd_Zeitkonten","kind":"standard","procedures":["Function import_Zeitkonten(Monat As Integer, Jahr As Integer)","Function loeschen_import(Monat As Integer, Jahr As Integer, Optional ByVal Lex_ID As Integer)","Function get_Satz(Satz As String) As Double","Function get_PersNr(Name As String) As Integer","Function hinzufuegen(PersNr, LexID, Jahr, Monat, LArt, Wert, Satz)","Function erfasse_Fehler(fehler As String, Optional Datei As String, Optional Jahr As Integer, _","Function ZK_Daten_uebertragen(MA_ID As Integer, von As Date, bis As Date, Optional ZK_offen As Boolean, Optional abrechnung As Boolean) As String","Function ZK_eintragen(xlWB As Object, zk() As ZK_Satz, Optional abrechnung As Boolean) As String","Function ZK_Datei_ermitteln(MA_ID As Integer) As String","Function ZK_schreibe_Fehler(zk As ZK_Satz)","Function zk_sortieren(zk() As ZK_Satz)","Function ZK_einlesen(xlWB As Object, von As Date, bis As Date) As ZK_Satz()","Function ZK_Import_einzel(xlWB As Object, Jahr As Integer, Monat As Integer, ByVal MA_ID As Integer) As String","Function ZK_Bereiche_benennen()","Function ermittle_Benutzer() As String","Function ermittle_Lohnart_ID(MA_ID, Optional bez_kurz As String) As Integer","Function ermittle_Lohnart(Optional MA_ID As Integer, Optional grund As String, Optional Lohnart_ID As Integer) As String","Function ermittle_Stunden(Lohnart_ID As Integer, Datum As Date, Start As Date, Ende As Date, Optional MA_ID As Integer, Optional bez_kurz As String) As Double","Function Stunden_Urlaub(MA_ID As Integer) As Double","Function Stunden_Krank(MA_ID As Integer) As Double","Function ermittle_Stundensatz(Optional Lohnart_ID As Long, Optional MA_ID As Integer, Optional Datum As Date, Optional bez_kurz As String) As Double","Function ermittle_ZK_Daten(Jahr As Integer, Monat As Integer, Optional MA_ID As Long, Optional Anst_ID As Integer)","Function maxEuro_MJ(Monat As Integer, Jahr As Integer, MA_ID As Long)","Function ref_korr_anlegen(ByVal MA_ID As Long, ByVal Jahr As Integer, ByVal Monat As Integer, Korr_ID_ref As Integer, _","Function calc_RL34a(Monat As Integer, Jahr As Integer, MA_ID As Long)","Function korrektur_anlegen_wert(ByVal MA_ID As Long, ByVal Lohnart_ID As Long, ByVal Jahr As Integer, ByVal Monat As Integer, ByVal Wert As Double, Optional ByVal Bemerkung As String) As String","Function Urlaubsanspruch(MA_ID As Long) As Double","Function AnzTageGesamt(MA_ID As Long) As Double","Function AnzTageProWoche(ByVal MA_ID As String) As Double","Function ArbStundenProTag(ByVal MA_ID As String) As Double","Function create_Tage_Zeitraum(ByVal MA_ID As Long, ByVal Jahr As Integer, ByVal Monat As Integer, Optional ByVal append As Boolean)","Function weekday_short(ByVal Datum As Date) As String","Function pruefeLohnart(MA_ID As Long, Lohnart_ID As Long, Lohnartnummer As String) As String"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":["DELETE * FROM [ztbl_ZK_Importfehler] WHERE [Jahr] = ","DELETE * FROM "," DELETE FROM [","INSERT INTO [","DELETE FROM [ztbl_ZK_Stunden_prepare] ","INSERT INTO [ztbl_ZK_Stunden_prepare] SELECT * FROM ","DELETE FROM [ztbl_ZK_Stunden] ","INSERT INTO [ztbl_ZK_Stunden] SELECT * FROM "," DELETE FROM [","INSERT INTO [","DELETE FROM [ztbl_ZK_Stunden_prepare] ","INSERT INTO [ztbl_ZK_Stunden_prepare] SELECT * FROM ","DELETE FROM [ztbl_ZK_Stunden] ","INSERT INTO [ztbl_ZK_Stunden] SELECT * FROM "," DELETE FROM [","INSERT INTO [","DELETE FROM [ztbl_ZK_Stunden_prepare] ","INSERT INTO [ztbl_ZK_Stunden_prepare] SELECT * FROM ","DELETE FROM [ztbl_ZK_Stunden] ","INSERT INTO [ztbl_ZK_Stunden] SELECT * FROM ","DELETE * FROM "],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n'Zeitkonto\nType ZK_Satz\n    MA_ID           As String\n    Datum           As Date\n    Veranstaltung   As String\n    Beginn          As Date\n    Ende            As Date\n    AW              As Double\n    AZ              As Double\n    AZ_andere       As Double\n    AZ_Reinigung    As Double\n    U               As Double\n    AU              As Double\n    WerktagNacht    As Double\n    Sonntag         As Double\n    SonntagNacht    As Double\n    Feiertag        As Double\n    FeiertagNacht   As Double\n    andere_Nacht    As Double\n    andere_So_FT    As Double\n    Reiseko         As Double\n    p_Fahrk         As Double\n    Abzüge          As Double\n    Auszahlung      As Double\nEnd Type\n\n\n'Lexware Import\nType Import_Lex\n    Jahr    As Integer\n    Monat   As Integer\n    MA_ID   As Integer\n    Lex_ID  As Integer\n    L_ART   As Long\n    Wert    As Double\n    Satz    As Double\n    'AnstArt As Integer\nEnd Type\n\n\nConst SatzNormal        As Double = 13.5\nConst SatzNacht         As Double = SatzNormal * 0.23\nConst SatzSonn          As Double = SatzNormal * 0.26\nConst SatzSonnNacht     As Double = SatzNormal * 0.03\nConst SatzFeier         As Double = SatzNormal * 1\nConst SatzFeierNacht    As Double = SatzNormal * 0.77\nConst SatzFGUZu         As Double = 1.5\nConst SatzFGUZu2        As Double = 1.5\n\nDim lex()           As Import_Lex\nDim c               As Integer\n\n\nFunction import_Zeitkonten(Monat As Integer, Jahr As Integer)\n\nDim xlApp           As Object, xlWB As Object\nDim fso             As New Scripting.FileSystemObject\nDim fol             As folder\nDim Fil             As file\nDim PfadZeitkonten  As String\nDim Name            As String\nDim PersNr          As Variant\nDim LexID           As Variant\nDim Wert            As Double\nDim rs              As Recordset\nDim i               As Integer\nDim Bereich         As Variant\nDim strMonat        As String\nDim Lohnart         As String\nDim Sheet           As String\nDim Satz            As String\n\n\nOn Error GoTo err\n\n    c = 0\n    ReDim lex(c)\n    \n    PfadZeitkonten = PfadZK\n    \n    'Wenn Pfad nicht existiert -> letztes Jahr\n    If Dir(PfadZeitkonten, vbDirectory) = \"\" Then PfadZeitkonten = PfadZuBerechnen & year(Date) - 1 & \" Zeitkonten\"\n    \n    'Wenn Pfad nicht existiert -> Fehler\n    If Dir(PfadZeitkonten, vbDirectory) = \"\" Then err.Raise 76, , PfadZeitkonten & vbCrLf & \" nicht gefunden!\"\n    \n    Set fol = fso.GetFolder(PfadZeitkonten)\n    Set xlApp = CreateObject(\"Excel.Application\")\n    xlApp.DisplayAlerts = False\n    xlApp.Visible = True\n            \n    'Importfehler löschen\n    CurrentDb.Execute \"DELETE * FROM [ztbl_ZK_Importfehler] WHERE [Jahr] = \" & Jahr & \" AND [Monat] = \" & Monat & \";\"\n    \n    'Zeitkonto suchen\n    For Each Fil In fol.Files\n        'Name des Kollegen\n        Name = UCase(Left(Fil.Name, Len(Fil.Name) - (Len(Fil.Name) - InStrRev(Fil.Name, \".\")) - 1))\n        PersNr = get_PersNr(Name)\n        \n        'Wenn keine Personalnummer aus dem Namen ermittelt werden konnte,\n        'Datei öffnen und mit Wert aus Blatt 1 Zelle B1 versuchen\n        If PersNr = 0 And InStr(Fil.Name, \".xl\") Then\n            Set xlWB = xlApp.Workbooks.Open(Fil.path, False, False)\n            Name = xlWB.Sheets(1).Range(\"B1\")\n            PersNr = get_PersNr(Name)\n            xlWB.Close False\n        End If\n        \n        If PersNr <> 0 Then\n            'Lexware-ID\n            LexID = TLookup(\"LEXWare_ID\", MASTAMM, \"ID = \" & PersNr)\n            If IsNull(LexID) Then LexID = 9999\n            'Prüfung Monat Zelle A2???\n            Set xlWB = xlApp.Workbooks.Open(Fil.path, False, True)\n            \n            'Lohnarten aus Bereichen auslesen\n            strMonat = Monat\n            If Len(strMonat) = 1 Then strMonat = \"0\" & strMonat\n            \n            'Loop über benannte Bereiche im Workbook\n            For Each Bereich In xlWB.names\n                If InStr(Bereich.Name, \"_\" & strMonat & \"_\") Then\n                    'clear Lohnart, Wert, Satz, Sheet\n                    Satz = Mid(Bereich.Name, InStr(Bereich.Name, \"Satz\"), InStr(10, Bereich.Name, \"_\") - InStr(Bereich.Name, \"Satz\"))\n                    Satz = get_Satz(Satz)\n                    'Lohnart aus Bereich\n                    Lohnart = Right(Bereich.Name, Len(Bereich.Name) - InStrRev(Bereich.Name, \"_\"))\n                    'Tabellenblatt im Zeitkonto\n                    Sheet = Mid(Bereich.RefersTo, 2, InStr(Bereich.RefersTo, \"!\") - 2)\n                    'Stundenwert im benannten Bereich\n                    Wert = xlWB.Sheets(Sheet).Range(Bereich).Value\n                    'Daten Array puffern\n                    If Wert <> 0 Then\n                        Call hinzufuegen(PersNr, LexID, Jahr, strMonat, Lohnart, Wert, Satz)\n                    Else\n                        'erfasse_Fehler \"WERT 0 im Zeitkonto!\", fil.Name, Jahr, Monat, PersNr, \"keine Stunden in Zeitkonto, \" & Bereich.Name & \", \" & Bereich.RefersTo\n                    End If\n                    \n                End If\n            Next Bereich\n        \n            xlWB.Close False\n        Else\n            erfasse_Fehler \"Keine Personalnummer zu Name \" & Name & \" gefunden\", Fil.Name, Jahr, Monat, PersNr, \"prüfen\"\n        End If\n        \n    Next Fil\n    \n    \n    'Bereits importierte Werte löschen\n    loeschen_import Monat, Jahr\n            \n    'Daten in Tabelle schreiben\n    Set rs = CurrentDb.OpenRecordset(\"ztbl_Stunden_Lexware\", dbOpenDynaset)\n    For i = LBound(lex) To UBound(lex)\n        rs.AddNew\n        rs.fields(0) = lex(i).Jahr\n        rs.fields(1) = lex(i).Monat\n        rs.fields(2) = lex(i).Lex_ID\n        rs.fields(3) = lex(i).L_ART\n        rs.fields(4) = Runden(lex(i).Wert, 2)\n        rs.fields(5) = lex(i).Satz\n        rs.update\n    Next i\n    \n    \nEnde:\nOn Error Resume Next\n    rs.Close\n    xlApp.DisplayAlerts = True\n    xlApp.Quit\n    Set xlApp = Nothing\n    Set xlWB = Nothing\n    Set rs = Nothing\n    Exit Function\nerr:\n    If Not Bereich Is Nothing Then\n        erfasse_Fehler err.Number & \" \" & err.description, Fil.Name, Jahr, Monat, PersNr, \"übersprungen - prüfen! -> \" & Bereich.Name & \", \" & Bereich.RefersTo\n    Else\n        erfasse_Fehler err.Number & \" \" & err.description, Fil.Name, Jahr, Monat, PersNr, \"übersprungen - prüfen! \"\n    End If\n    Resume Next\nEnd Function\n\n\n'Importierte Daten löschen\nFunction loeschen_import(Monat As Integer, Jahr As Integer, Optional ByVal Lex_ID As Integer)\n    \nDim sql       As String\n    \n    If Lex_ID = 0 Then\n        'Import löschen Monat alle MA\n        sql = \"DELETE * FROM [ztbl_Stunden_Lexware] WHERE [Jahr] = \" & Jahr & \" AND [Monat] = \" & Monat & \";\"\n    Else\n        'Import löschen ein MA\n        sql = \"DELETE * FROM [ztbl_Stunden_Lexware] WHERE [Jahr] = \" & Jahr & \" AND [Monat] = \" & Monat & \" AND [Personalnummer] = \" & Lex_ID & \";\"\n    End If\n    CurrentDb.Execute sql\n    \nEnd Function\n\n\n'Satz ermitteln\nFunction get_Satz(Satz As String) As Double\n\n    Select Case Satz\n        Case \"SatzNormal\"\n            get_Satz = SatzNormal\n        Case \"SatzNacht\"\n            get_Satz = SatzNacht\n        Case \"SatzSonn\"\n            get_Satz = SatzSonn\n        Case \"SatzSonnNacht\"\n            get_Satz = SatzSonnNacht\n        Case \"SatzFeier\"\n            get_Satz = SatzFeier\n        Case \"SatzFeierNacht\"\n            get_Satz = SatzFeierNacht\n        Case \"SatzFGUZu\"\n            get_Satz = SatzFGUZu\n        Case \"SatzFGUZu2\"\n            get_Satz = SatzFGUZu2\n        Case Else\n            Satz = 0\n    End Select\n    \nEnd Function\n\n\n'Personalnummer ermitteln\nFunction get_PersNr(Name As String) As Integer\n\nDim Vorname     As String\nDim Nachname    As String\nDim sql         As String\n\nOn Error GoTo err\n\n    sql = \"SELECT [ID] FROM [zqry_hlp_MA_Zeitkonten] WHERE [Name] LIKE '\" & Name & \"';\"\n    get_PersNr = DBEngine(0)(0).OpenRecordset(sql, dbOpenSnapshot)(0)\n    Exit Function\n \nerr:\n    get_PersNr = 0\n \nEnd Function\n\n\n'Eintrag hinzufügen (Lexware)\nFunction hinzufuegen(PersNr, LexID, Jahr, Monat, LArt, Wert, Satz)\n\nDim Monat_str As String\n    \n    Monat_str = Monat\n    If Len(Monat_str) = 1 Then Monat_str = 0 & Monat_str\n    \n    ReDim Preserve lex(c)\n    lex(c).MA_ID = PersNr\n    lex(c).Lex_ID = LexID\n    lex(c).Jahr = Jahr\n    lex(c).Monat = Monat_str\n    lex(c).L_ART = LArt\n    lex(c).Wert = Wert\n    lex(c).Satz = Satz\n    'LEX(c).AnstArt = TLookup(\"Anstellungsart_ID\", MASTAMM, \"ID = \" & PersNr)\n    c = c + 1\n    \nEnd Function\n\n\n'Importfehler erfassen\nFunction erfasse_Fehler(fehler As String, Optional Datei As String, Optional Jahr As Integer, _\n    Optional Monat As Integer, Optional ByVal MA_ID As Integer, Optional Bemerkung As String)\n\nDim rs As Recordset\n\nOn Error Resume Next\n\n    'Daten in Tabelle schreiben\n    Set rs = CurrentDb.OpenRecordset(\"ztbl_ZK_Importfehler\", dbOpenDynaset)\n    rs.AddNew\n    rs.fields(0) = Datei\n    rs.fields(1) = Jahr\n    rs.fields(2) = Monat\n    rs.fields(3) = MA_ID\n    rs.fields(4) = fehler\n    rs.fields(5) = Bemerkung\n    rs.fields(6) = Environ(\"UserName\")\n    rs.fields(7) = Now\n    rs.update\n    rs.Close\n    Set rs = Nothing\n    \nEnd Function\n\n\n\n'###############################################\n' AB HIER FORTSCHREIBUNG DER ZEITKONTEN\n'###############################################\n\n'Test: ZK_Daten_uebertragen 204, \"01.04.2022\",\"30.04.2022\"\n'Daten in Zeitkonto uebertragen\nFunction ZK_Daten_uebertragen(MA_ID As Integer, von As Date, bis As Date, Optional ZK_offen As Boolean, Optional abrechnung As Boolean) As String\n\nDim xlApp       As Object\nDim xlWB        As Object\nDim DateiZK     As String\nDim rs          As Recordset\nDim sql         As String\nDim zk()        As ZK_Satz\nDim c           As Integer\nDim rc          As String\nDim StdAbw      As Double  'Stunden Abwesenheit\nDim Warnung     As String\nDim IstNSB      As Boolean\nDim anzTageU    As Integer 'Anzahl Urlaubstage\nDim anzTageAU   As Integer 'Anzahl Krankheitstage\nDim StProTag    As Double  'Stunden pro Tag\nDim TagProWoch  As Double  'Arbeitstage pro Woche\nDim AnteilTage  As Double  'Prozentualer Anteil Arbeitstage\nDim IstTageAbw  As Double  'Zähler eingetragene Tage Abwesenheit\nDim SollTageAbw As Double  'Anzahl einzutragende Tage Abwesenheit\n\nOn Error GoTo err\n\n    'Datei Zeitkonto ermitteln\n    DateiZK = ZK_Datei_ermitteln(MA_ID)\n    \n    'Exit, wenn Zeitkonto nicht gefunden\n    If DateiZK = \"\" Then err.Raise 76, , \"Excel-Datei Zeitkonto \" & MA_ID & \" nicht gefunden!\"\n    \n    'Brutto Std = Netto Std?\n    IstNSB = TLookup(\"IstNSB\", MASTAMM, \"ID = \" & MA_ID)\n    \n    'Excel starten\n    Set xlApp = CreateObject(\"Excel.Application\")\n'    If ZK_offen = False Then\n'        xlApp.Visible = True\n'        'xlApp.DisplayFullScreen = True           'blendet nur Menüleiste aus\n'        'xlApp.ActiveWindow.WindowState = -4137   'WIRFT FEHLER 91!!!!!\n'    Else\n        xlApp.Visible = False\n'    End If\n    \n    Set xlWB = xlApp.Workbooks.Open(DateiZK, False, False)\n    \n    'Array leeren\n    Erase zk\n    c = 0\n    \n'    'Werte aus Zeitkonto einlesen - WIRD NICHT VERWENDET!\n'    zk() = ZK_einlesen(xlWB, von, bis)\n'    'Werte zur Übernahme vorhanden?\n'    If zk(0).Datum <> 0 Then\n'        c = UBound(zk) + 1\n'    Else\n'        c = 0\n'    End If\n    \n    'EINTRÄGE AUS VERANSTALTUNGEN ERMITTELN (PRIO1)\n    sql = \"SELECT * FROM [qry_MA_VA_Plan_All_AufUeber2_Zuo] WHERE MA_ID = \" & MA_ID & _\n        \" AND VADatum BETWEEN \" & datumSQL(von) & \" AND \" & datumSQL(bis) & \";\"\n    \n    Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n    \n    Do While Not rs.EOF\n        ReDim Preserve zk(c)\n        \n        zk(c).MA_ID = MA_ID\n        zk(c).Veranstaltung = rs.fields(\"Auftrag\") & \" \" & rs.fields(\"Objekt\") & \" \" & rs.fields(\"Ort\")\n        zk(c).Datum = rs.fields(\"VADatum\")\n        zk(c).Beginn = rs.fields(\"Beginn\")\n        zk(c).Ende = rs.fields(\"Ende\")\n        zk(c).AW = stunden(zk(c).Beginn, zk(c).Ende)\n        'Brutto = Netto Std?\n        If IstNSB = False Then\n            zk(c).AZ = zk(c).AW * 0.91\n        Else\n            zk(c).AZ = zk(c).AW\n        End If\n        \n        zk(c).WerktagNacht = Stunden_Zuschlag(rs.fields(\"VADatum\"), rs.fields(\"Beginn\"), rs.fields(\"Ende\"), \"NACHT_GESAMT\")\n        zk(c).Sonntag = Stunden_Zuschlag(rs.fields(\"VADatum\"), rs.fields(\"Beginn\"), rs.fields(\"Ende\"), \"SONNTAG\")\n        zk(c).SonntagNacht = Stunden_Zuschlag(rs.fields(\"VADatum\"), rs.fields(\"Beginn\"), rs.fields(\"Ende\"), \"SONNTAGNACHT\")\n        zk(c).Feiertag = Stunden_Zuschlag(rs.fields(\"VADatum\"), rs.fields(\"Beginn\"), rs.fields(\"Ende\"), \"FEIERTAG\")\n        zk(c).FeiertagNacht = Stunden_Zuschlag(rs.fields(\"VADatum\"), rs.fields(\"Beginn\"), rs.fields(\"Ende\"), \"FEIERTAGNACHT\")\n        If Not IsInitial(rs.fields(\"PKW\")) Then zk(c).p_Fahrk = rs.fields(\"PKW\")\n        \n        'Sonderfall Flüchtlingsunterkunft\n        If InStr(zk(c).Veranstaltung, \"Flüchtlingsunterkunft\") <> 0 Then zk(c).AZ_andere = zk(c).AZ\n         \n        rs.MoveNext\n        c = c + 1\n    Loop\n    \n    \n    'EINTRÄGE AUS URLAUB/KRANKHEIT/INTERN ERMITTELN (Prio2)\n    sql = \"SELECT * FROM [zqry_ZK_MA_Urlaub_Krank_Intern] WHERE MA_ID = \" & MA_ID & _\n        \" AND vonTag BETWEEN \" & datumSQL(von) & \" AND \" & datumSQL(bis) & \";\"\n    \n    Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n    \n    StProTag = Nz(TLookup(\"Arbst_pro_Arbeitstag\", MASTAMM, \"ID = \" & MA_ID), 0)\n    TagProWoch = Nz(TLookup(\"Arbeitstage_pro_Woche\", MASTAMM, \"ID = \" & MA_ID), 0)\n    \n    'Anzahl Abwesenheitstage\n    anzTageU = TCount(\"*\", \"zqry_ZK_MA_Urlaub_Krank_Intern\", \"MA_ID = \" & MA_ID & \" AND vonTag BETWEEN \" & datumSQL(von) & \" AND \" & datumSQL(bis) & \" AND Zeittyp_ID = 'Urlaub';\")\n    anzTageAU = TCount(\"*\", \"zqry_ZK_MA_Urlaub_Krank_Intern\", \"MA_ID = \" & MA_ID & \" AND vonTag BETWEEN \" & datumSQL(von) & \" AND \" & datumSQL(bis) & \" AND Zeittyp_ID = 'Krank';\")\n    \n    'Berechnung (Ausgehend von 5 Arbeitstagen pro Woche)\n    If TagProWoch <> 0 Then\n        AnteilTage = TagProWoch / 5\n        SollTageAbw = (anzTageU + anzTageAU) * AnteilTage\n    Else\n        SollTageAbw = anzTageU + anzTageAU\n    End If\n    \n    IstTageAbw = 0\n    \n    Do While Not rs.EOF\n        \n        'Wenn mehrere Tage in Abwesenheit -> WARNUNG\n        If rs.fields(\"vonTag\") <> rs.fields(\"bisTag\") Then Warnung = \"Urlaub/Krankheit/AZ_andere prüfen!\"\n        \n        ReDim Preserve zk(c)\n        \n        zk(c).MA_ID = MA_ID\n        zk(c).Veranstaltung = rs.fields(\"Zeittyp_ID\") & \" \" & rs.fields(\"Bemerkung\")\n        zk(c).Datum = rs.fields(\"vonTag\")\n        \n        'Urlaub / Krankheit -> Werte aus MAStamm, sofern gepflegt, sonst eingetragene Zeit (Max 12h)\n        StdAbw = 0\n        StdAbw = stunden(rs.fields(\"vonZeit\"), rs.fields(\"bisZeit\")) '\n        If StdAbw > 12 Then StdAbw = 12\n        \n        'Zuweisung Abwesenheit\n        Select Case rs.fields(\"Zeittyp_ID\")\n            Case \"Urlaub\"         'EINTRAG URLAUB OHNE STUNDEN, ZU VIELE SONDERFÄLLE :(\n'                If IstTageAbw < SollTageAbw Then\n                    If StProTag <> 0 Then\n                        zk(c).U = StProTag\n                    Else\n                        zk(c).U = StdAbw\n                    End If\n'                    IstTageAbw = IstTageAbw + 1\n'                End If\n            Case \"Krank\"         'EINTRAG KRANK OHNE STUNDEN, ZU VIELE SONDERFÄLLE :(\n'                If IstTageAbw < SollTageAbw Then\n                    If StProTag <> 0 Then\n                        zk(c).AU = StProTag\n                    Else\n                        zk(c).AU = StdAbw\n                    End If\n'                    IstTageAbw = IstTageAbw + 1\n'                End If\n            Case \"Intern\"\n                zk(c).AZ_Reinigung = StdAbw\n                If zk(c).AZ_andere = 0 Then zk(c).AZ_andere = StdAbw\n                zk(c).Beginn = rs.fields(\"vonZeit\")\n                zk(c).Ende = rs.fields(\"bisZeit\")\n        End Select\n        \n        rs.MoveNext\n        c = c + 1\n    Loop\n    \n    'Daten in Zeitkonto eintragen (wenn vorhanden)\n    'If zk(0).Datum <> 0 Then rc = ZK_eintragen(xlWB, zk)\n    If (0 / 1) + (Not Not zk) Then\n        rc = ZK_eintragen(xlWB, zk, abrechnung)\n    Else\n        rc = \"Zeitkonto  \" & Left(xlWB.Name, Len(xlWB.Name) - 4) & \": Keine Einsätze!\"\n    End If\n    \n    ZK_Daten_uebertragen = rc & Warnung\n    \n    'Zeitkonto sichern + schließen bei Massenbearbeitung\n    If ZK_offen = False Then\n        If xlWB.ReadOnly = False Then\n            xlWB.Close True\n        Else\n            xlWB.Close False\n            ZK_Daten_uebertragen = \"Zeitkonto \" & xlWB.Name & \" speichern nicht möglich!!!\"\n        End If\n    Else\n        xlApp.Visible = True\n        xlApp.ActiveWindow.WindowState = -4137\n        xlWB.Save\n    End If\n\n    \nEnde:\n    If ZK_offen = False Then\nOn Error Resume Next\n        xlWB.Close False\n        xlApp.Quit\n    End If\n    Set xlApp = Nothing\n    Set xlWB = Nothing\n    Exit Function\nerr:\n    ZK_Daten_uebertragen = err.Number & \" \" & err.description\n    ZK_offen = False\n    Resume Ende\nEnd Function\n\n\n\n'Eintrag in Zeitkonto\nFunction ZK_eintragen(xlWB As Object, zk() As ZK_Satz, Optional abrechnung As Boolean) As String\n\nDim ws          As Object\nDim i           As Integer\nDim zeile       As Integer\nDim Monat       As Integer\nDim Jahr        As Integer\nDim clear       As Integer 'Zeitkonto leeren?\n   \nOn Error GoTo err\n    \n    'Workbook nicht übergeben\n    If xlWB Is Nothing Then err.Raise 76, , \"Excel Workbook nicht gefunden!\"\n    \n    'übergebenes Array Sortieren\n    zk_sortieren zk\n    \n    For i = LBound(zk) To UBound(zk)\n        Monat = Month(zk(i).Datum)\n        Jahr = year(zk(i).Datum)\n        \n        Set ws = xlWB.Sheets(Monat)\n        \n        With ws\n            .Select\n            .Range(\"A4\").Select\n            'Prüfen, ob Zeitkonto gesperrt ist (Zelle C1 leer!)\n            If .Range(\"C1\") = \"\" Then\n            \n                'Einträge im Zeitkonto löschen(xlCellTypeConstants = 2)\n                If clear <> Monat Then\nOn Error Resume Next 'Fehler, wenn Bereich komplett leer ist!!!\n                    .Range(\"B4:U65\").SpecialCells(2).ClearContents 'bis Reisekosten leeren\nOn Error GoTo err\n                    clear = Monat\n                End If\n            \n                'Zeile (Tag) ermitteln\n                zeile = .Range(\"A:A\").Find(Day(zk(i).Datum)).row\n                'besetzt? -> Versuch in Zeile 2\n                If .Range(\"B\" & zeile) <> \"\" Then zeile = zeile + 1\n                'besetzt? -> Fehlereintrag\n                If .Range(\"B\" & zeile) <> \"\" Then\n                    ZK_schreibe_Fehler zk(i)\n                \n                Else 'eintragen\n                    .Range(\"B\" & zeile) = zk(i).Veranstaltung\n                    .Range(\"C\" & zeile) = zk(i).Beginn\n                    .Range(\"D\" & zeile) = zk(i).Ende\n                    .Range(\"E\" & zeile) = zk(i).AW\n                    .Range(\"F\" & zeile) = zk(i).AZ\n\n                    .Range(\"G\" & zeile) = zk(i).U\n                    .Range(\"H\" & zeile) = zk(i).AU\n                    If zk(i).AZ_andere <> 0 Then\n                        If InStr(zk(i).Veranstaltung, \"Büro\") <> 0 Then ws.Range(\"I\" & zeile) = zk(i).AZ_andere\n                        If InStr(zk(i).Veranstaltung, \"München\") <> 0 Then ws.Range(\"J\" & zeile) = zk(i).AZ_andere\n                        If InStr(zk(i).Veranstaltung, \"Mannheim\") <> 0 Then ws.Range(\"K\" & zeile) = zk(i).AZ_andere\n                        If InStr(zk(i).Veranstaltung, \"Flüchtling\") <> 0 Then ws.Range(\"L\" & zeile) = zk(i).AZ_andere\n                    End If\n                    .Range(\"M\" & zeile) = zk(i).WerktagNacht\n                    .Range(\"N\" & zeile) = zk(i).Sonntag\n                    .Range(\"O\" & zeile) = zk(i).SonntagNacht\n                    .Range(\"P\" & zeile) = zk(i).Feiertag\n                    .Range(\"Q\" & zeile) = zk(i).FeiertagNacht\n                    .Range(\"Q\" & zeile) = zk(i).FeiertagNacht\n                    .Range(\"R\" & zeile) = zk(i).andere_Nacht\n                    \n                    If zk(i).p_Fahrk <> 0 Then .Range(\"U\" & zeile) = zk(i).p_Fahrk\n                    \n                    ZK_eintragen = \"Zeitkonto  \" & .Range(\"B1\") & \"  Monat \" & Monat & \"-\" & .Name & \" fortgeschrieben\"\n                     \n                End If\n                \n            Else 'Zeitkonto gelocked\n                    ZK_eintragen = \"Zeitkonto  \" & .Range(\"B1\") & \"  Monat \" & Monat & \"-\" & .Name & \" gesperrt!!!\"\n                    GoTo Ende\n            End If\n        End With\n    Next i\n    \n    '\"Knopf drücken\" (Makro ausführen), wenn Zelle F80 leer -> funktioniert so nicht -> Werte direkt übertragen\n    With ws\n        If .Range(\"F97\") = \"\" Or .Range(\"F97\") = 0 Or abrechnung = True Then\n            .Range(\"D1\") = Date\n            .Range(\"F97\").Value = .Range(\"F96\").Value   'Gesamtstunden\n            .Range(\"M94\").Value = .Range(\"M85\").Value   'Nacht\n            .Range(\"N94\").Value = .Range(\"N85\").Value   'So\n            .Range(\"O94\").Value = .Range(\"O85\").Value   'So Nacht\n            .Range(\"P94\").Value = .Range(\"P85\").Value   'Feier\n            .Range(\"Q94\").Value = .Range(\"Q85\").Value   'Feier Nacht\n            .Range(\"R94\").Value = .Range(\"R85\").Value   'Andere Nacht\n        End If\n\n        'Währungsfelder Formatierung überschreiben\n        .Range(\"V3:V85\").NumberFormat = \"#,##0.00 $\"\n        .Range(\"E86:E104\").NumberFormat = \"#,##0.00 $\"\n        .Range(\"M86:Q86\").NumberFormat = \"#,##0.00 $\"\n        .Range(\"U4:U85\").NumberFormat = \"#,##0.00 $\"\n        .Range(\"W4:W85\").NumberFormat = \"#,##0.00 $\"\n        .Range(\"W99:W106\").NumberFormat = \"#,##0.00 $\"\n        .Range(\"B109:B115\").NumberFormat = \"#,##0.00 $\"\n        \n        'Negative Beträge rot\n        .Range(\"E4:X106\").FormatConditions.Delete\n        .Range(\"E4:X106\").FormatConditions.Add Type:=1, Operator:=6, Formula1:=\"=0\"\n        .Range(\"E4:X106\").FormatConditions(1).Font.color = -16776961\n        .Range(\"E4:X106\").FormatConditions(1).StopIfTrue = False\n        \n    End With\n    'Werte aus Zeitkonto für Lexware importieren\n    ZK_eintragen = ZK_eintragen & \" \" & ZK_Import_einzel(xlWB, Jahr, Monat, zk(0).MA_ID)\n    \nEnde:\n    Set ws = Nothing\n    Exit Function\nerr:\n    ZK_eintragen = err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n\n'Datei Zeitkonto ermitteln\nFunction ZK_Datei_ermitteln(MA_ID As Integer) As String\n\nDim fso As New Scripting.FileSystemObject\nDim fol As folder\nDim Fil As file\nDim PfadZeitkonten As String\nDim Name As String\n\nOn Error GoTo err\n    \n    PfadZeitkonten = PfadZK\n    \n    'Wenn Pfad nicht existiert -> letztes Jahr\n    If Dir(PfadZeitkonten, vbDirectory) = \"\" Then PfadZeitkonten = PfadZuBerechnen & year(Date) - 1 & \" Zeitkonten\"\n    \n    'Wenn Pfad nicht existiert -> Fehler\n    If Dir(PfadZeitkonten, vbDirectory) = \"\" Then err.Raise 76, , PfadZeitkonten & vbCrLf & \" nicht gefunden!\"\n    \n    Name = TLookup(\"Nachname\", MASTAMM, \"ID = \" & MA_ID) & \" \" & TLookup(\"Vorname\", MASTAMM, \"ID = \" & MA_ID)\n    \n    'Wenn MA_ID nicht existiert -> Fehler\n    If Name = \" \" Then err.Raise 76, , \"Mitarbeiter \" & MA_ID & vbCrLf & \" nicht gefunden!\"\n    \n    Set fol = fso.GetFolder(PfadZeitkonten)\n    \n    'Zeitkonto suchen\n    For Each Fil In fol.Files\n        If InStr(UCase(Fil.Name), UCase(Name)) <> 0 Then\n            ZK_Datei_ermitteln = Fil.path\n            Exit For\n        End If\n    Next Fil\n\nEnde:\n    Exit Function\nerr:\n    ZK_Datei_ermitteln = \"\"\n    Resume Ende\nEnd Function\n\n\n'Fehler bei Übertragung in Zeitkonto\nFunction ZK_schreibe_Fehler(zk As ZK_Satz)\n\nDim rs As Recordset\n\n    Set rs = CurrentDb.OpenRecordset(\"ztbl_ZK_Fehler\")\n    rs.AddNew\n    rs.fields(\"MA_ID\") = zk.MA_ID\n    rs.fields(\"Datum\") = zk.Datum\n    rs.fields(\"Veranstaltung\") = zk.Veranstaltung\n    rs.fields(\"Beginn\") = zk.Beginn\n    rs.fields(\"Ende\") = zk.Ende\n    rs.fields(\"AW\") = zk.AW\n    rs.fields(\"AZ\") = zk.AZ\n    rs.fields(\"U\") = zk.U\n    rs.fields(\"AU\") = zk.AU\n    rs.fields(\"WerktagNacht\") = zk.WerktagNacht\n    rs.fields(\"Sonntag\") = zk.Sonntag\n    rs.fields(\"SonntagNacht\") = zk.SonntagNacht\n    rs.fields(\"Feiertag\") = zk.Feiertag\n    rs.fields(\"FeiertagNacht\") = zk.FeiertagNacht\n    rs.fields(\"andere_Nacht\") = zk.andere_Nacht\n    rs.fields(\"andere_So_FT\") = zk.andere_So_FT\n    rs.fields(\"Reiseko\") = zk.Reiseko\n    rs.fields(\"p_Fahrk\") = zk.p_Fahrk\n    rs.fields(\"Abzüge\") = zk.Abzüge\n    rs.fields(\"Auszahlung\") = zk.Auszahlung\n    rs.update\n    rs.Close\n    Set rs = Nothing\n\nEnd Function\n\n\n'Sätze Zeitkonto sortieren\nFunction zk_sortieren(zk() As ZK_Satz)\n\nDim rs      As Recordset\nDim tmpTBL  As String\nDim i       As Integer\n\n    tmpTBL = \"tmptbl_ZK\"\n    \n    If TableExists(tmpTBL) = False Then _\n        DoCmd.TransferDatabase acImport, \"Microsoft Access\", PfadProd & Backend, , \"ztbl_ZK_Fehler\", tmpTBL, True\n    \n    Set rs = CurrentDb.OpenRecordset(tmpTBL)\n    For i = LBound(zk) To UBound(zk)\n        rs.AddNew\n        rs.fields(\"MA_ID\") = zk(i).MA_ID\n        rs.fields(\"Datum\") = zk(i).Datum\n        rs.fields(\"Veranstaltung\") = zk(i).Veranstaltung\n        rs.fields(\"Beginn\") = zk(i).Beginn\n        rs.fields(\"Ende\") = zk(i).Ende\n        rs.fields(\"AW\") = zk(i).AW\n        rs.fields(\"AZ\") = zk(i).AZ\n        rs.fields(\"AZ_andere\") = zk(i).AZ_andere\n        rs.fields(\"AZ_Reinigung\") = zk(i).AZ_Reinigung\n        rs.fields(\"U\") = zk(i).U\n        rs.fields(\"AU\") = zk(i).AU\n        rs.fields(\"WerktagNacht\") = zk(i).WerktagNacht\n        rs.fields(\"Sonntag\") = zk(i).Sonntag\n        rs.fields(\"SonntagNacht\") = zk(i).SonntagNacht\n        rs.fields(\"Feiertag\") = zk(i).Feiertag\n        rs.fields(\"FeiertagNacht\") = zk(i).FeiertagNacht\n        rs.fields(\"andere_Nacht\") = zk(i).andere_Nacht\n        rs.fields(\"andere_So_FT\") = zk(i).andere_So_FT\n        rs.fields(\"Reiseko\") = zk(i).Reiseko\n        rs.fields(\"p_Fahrk\") = zk(i).p_Fahrk\n        rs.fields(\"Abzüge\") = zk(i).Abzüge\n        rs.fields(\"Auszahlung\") = zk(i).Auszahlung\n        rs.update\n    Next i\n    rs.Close\n    \n    Erase zk\n    i = 0\n    Set rs = CurrentDb.OpenRecordset(\"SELECT * FROM \" & tmpTBL & \" ORDER BY Datum ASC;\")\n    Do While Not rs.EOF\n        ReDim Preserve zk(i)\n        zk(i).MA_ID = rs.fields(\"MA_ID\")\n        zk(i).Datum = rs.fields(\"Datum\")\n        zk(i).Veranstaltung = rs.fields(\"Veranstaltung\")\n        zk(i).Beginn = rs.fields(\"Beginn\")\n        zk(i).Ende = rs.fields(\"Ende\")\n        zk(i).AW = rs.fields(\"AW\")\n        zk(i).AZ = rs.fields(\"AZ\")\n        zk(i).AZ_andere = rs.fields(\"AZ_andere\")\n        zk(i).AZ_Reinigung = rs.fields(\"AZ_Reinigung\")\n        zk(i).U = rs.fields(\"U\")\n        zk(i).AU = rs.fields(\"AU\")\n        zk(i).WerktagNacht = rs.fields(\"WerktagNacht\")\n        zk(i).Sonntag = rs.fields(\"Sonntag\")\n        zk(i).SonntagNacht = rs.fields(\"SonntagNacht\")\n        zk(i).Feiertag = rs.fields(\"Feiertag\")\n        zk(i).FeiertagNacht = rs.fields(\"FeiertagNacht\")\n        zk(i).andere_Nacht = rs.fields(\"andere_Nacht\")\n        zk(i).andere_So_FT = rs.fields(\"andere_So_FT\")\n        zk(i).Reiseko = rs.fields(\"Reiseko\")\n        zk(i).p_Fahrk = rs.fields(\"p_Fahrk\")\n        zk(i).Abzüge = rs.fields(\"Abzüge\")\n        zk(i).Auszahlung = rs.fields(\"Auszahlung\")\n        rs.MoveNext\n        i = i + 1\n    Loop\n    rs.Close\n    Set rs = Nothing\n    CurrentDb.Execute \"DELETE * FROM \" & tmpTBL\n    \nEnd Function\n\n\n'Zeitkonto einlesen (NICHT IN VERWENDUNG)\nFunction ZK_einlesen(xlWB As Object, von As Date, bis As Date) As ZK_Satz()\n\nDim Monat   As Integer\nDim zeile   As Integer\nDim xlWS    As Object\nDim i       As Integer\nDim zk()    As ZK_Satz\n\n    'Monat des Startdatums ermitteln\n    Monat = Month(von)\n    \n    'Tabellenblatt des Monats zuweisen\n    Set xlWS = xlWB.Sheets(Monat)\n    \n    'Sätze zu übergeben (beginnend bei 0)\n    i = 0\n    ReDim Preserve zk(i)\n    \n    'Zeilen der Tage im Zeitkonto\n    With xlWS\n        For zeile = 4 To 65\n            ' U oder AU eingetragen\n            If .Range(\"G\" & zeile) <> 0 Or .Range(\"H\" & zeile) <> 0 Or .Range(\"I\" & zeile) <> 0 Then\n                ReDim Preserve zk(i)\n                zk(i).Datum = CDate(.Range(\"A\" & zeile) & \".\" & Monat & \".\" & year(von))\n                zk(i).Veranstaltung = .Range(\"B\" & zeile)\n                zk(i).Beginn = .Range(\"C\" & zeile)\n                zk(i).Ende = .Range(\"D\" & zeile)\n                zk(i).AW = .Range(\"E\" & zeile)\n                zk(i).AZ = .Range(\"F\" & zeile)\n                'zk(i).AZ_andere = .Range(\"G\" & zeile)\n                zk(i).U = .Range(\"G\" & zeile)\n                zk(i).AU = .Range(\"H\" & zeile)\n                zk(i).WerktagNacht = .Range(\"M\" & zeile)\n                zk(i).Sonntag = .Range(\"N\" & zeile)\n                zk(i).SonntagNacht = .Range(\"O\" & zeile)\n                zk(i).Feiertag = .Range(\"P\" & zeile)\n                zk(i).FeiertagNacht = .Range(\"Q\" & zeile)\n                i = i + 1\n            End If\n        Next zeile\n    End With\n\n    ZK_einlesen = zk\n    Set xlWS = Nothing\n\nEnd Function\n\n\n'Einzelimport Zeitkonto -> direkt nach dem Schreiben der Werte!\nFunction ZK_Import_einzel(xlWB As Object, Jahr As Integer, Monat As Integer, ByVal MA_ID As Integer) As String\n\n\nDim PersNr          As Variant\nDim LexID           As Variant\nDim Wert            As Double\nDim rs              As Recordset\nDim i               As Integer\nDim Bereich         As Variant\nDim strMonat        As String\nDim Lohnart         As String\nDim Sheet           As String\nDim Satz            As String\n\n\nOn Error GoTo err\n\n    c = 0\n    ReDim lex(c)\n    \n    PersNr = MA_ID\n    LexID = TLookup(\"LEXWare_ID\", MASTAMM, \"ID = \" & PersNr)\n    If IsNull(LexID) Then LexID = 9999\n    \n    'Lohnarten aus Bereichen auslesen\n    strMonat = Monat\n    If Len(strMonat) = 1 Then strMonat = \"0\" & strMonat\n            \n    'Loop über benannte Bereiche im Workbook\n    For Each Bereich In xlWB.names\n        If InStr(Bereich.Name, \"_\" & strMonat & \"_\") Then\n            'clear Lohnart, Wert, Satz, Sheet\n            Satz = Mid(Bereich.Name, InStr(Bereich.Name, \"Satz\"), InStr(10, Bereich.Name, \"_\") - InStr(Bereich.Name, \"Satz\"))\n            Satz = get_Satz(Satz)\n            'Lohnart aus Bereich\n            Lohnart = Right(Bereich.Name, Len(Bereich.Name) - InStrRev(Bereich.Name, \"_\"))\n            'Tabellenblatt im Zeitkonto\n            Sheet = Mid(Bereich.RefersTo, 2, InStr(Bereich.RefersTo, \"!\") - 2)\n            'Stundenwert im benannten Bereich\n            Wert = xlWB.Sheets(Sheet).Range(Bereich).Value\n            'Daten Array puffern\n            If Wert <> 0 Then Call hinzufuegen(PersNr, LexID, Jahr, strMonat, Lohnart, Wert, Satz)\n        End If\n    Next Bereich\n    \n    'Bereits importierte Werte löschen\n    loeschen_import Monat, Jahr, LexID\n    \n    'Daten in Tabelle schreiben\n    Set rs = CurrentDb.OpenRecordset(\"ztbl_Stunden_Lexware\", dbOpenDynaset)\n    For i = LBound(lex) To UBound(lex)\n        rs.AddNew\n        rs.fields(0) = lex(i).Jahr\n        rs.fields(1) = lex(i).Monat\n        rs.fields(2) = lex(i).Lex_ID\n        rs.fields(3) = lex(i).L_ART\n        rs.fields(4) = Runden(lex(i).Wert, 2)\n        rs.fields(5) = lex(i).Satz\n        rs.update\n    Next i\n    \n    ZK_Import_einzel = \" und Werte importiert\"\n    \nEnde:\n    Exit Function\nerr:\n    ZK_Import_einzel = \"ZK_Import_einzel: \" & err.Number & err.description\n    Resume Ende\nEnd Function\n\n\n'########################################################\n'Bereiche in den Zeitkonten für Lohnarten etc benennen\n'########################################################\nFunction ZK_Bereiche_benennen()\n\nDim xlApp           As Object, xlWB As Object, xlWS As Object\nDim fso             As New Scripting.FileSystemObject\nDim fol             As folder\nDim Fil             As file\nDim PfadZeitkonten  As String\nDim i               As Integer\nDim Monat           As String\nDim Name            As String\nDim PersNr          As Integer\nDim n               As Variant\n\nOn Error GoTo err\n    \n    PfadZeitkonten = PfadZK\n    \n    Set fol = fso.GetFolder(PfadZeitkonten)\n    Set xlApp = CreateObject(\"Excel.Application\")\n    xlApp.DisplayAlerts = False\n    xlApp.Visible = True\n    xlApp.ScreenUpdating = False\n            \n    'Zeitkonto suchen\n    For Each Fil In fol.Files\n        Name = UCase(Left(Fil.Name, Len(Fil.Name) - (Len(Fil.Name) - InStrRev(Fil.Name, \".\")) - 1))\n        PersNr = get_PersNr(Name)\n    Debug.Print Name\n        'Wenn keine Persnummer ermittelt werden konnte,\n        'Datei öffnen und mit Wert aus Blatt 1 Zelle B1 versuchen\n        If PersNr = 0 And InStr(Fil.Name, \".xl\") Then\n            Set xlWB = xlApp.Workbooks.Open(Fil.path, False, False)\n            Name = xlWB.Sheets(1).Range(\"B1\")\n            PersNr = get_PersNr(Name)\n            xlWB.Close False\n        End If\n        \n        If PersNr <> 0 Or InStr(Fil.Name, \" Vorlage \") Then\n            Set xlWB = xlApp.Workbooks.Open(Fil.path, False, False)\n            'Bestehende Bereichsnamen löschen\n            For Each n In xlWB.names\n              n.Delete\n            Next\n            'Bereiche benennen\n            For i = 1 To 12\n                Set xlWS = xlWB.Sheets(i)\n                Monat = i\n                If Len(Monat) = 1 Then Monat = \"0\" & Monat\n                'Spalte C\n                xlWS.Range(\"C86\").Name = \"_\" & Monat & \"_SatzNormal_LArt_33\"        'Stundenlohn 2a MJ\n                xlWS.Range(\"C94\").Name = \"_\" & Monat & \"_SatzNormal_LArt_64\"        'LFZ Krankheit MJ\n                xlWS.Range(\"C93\").Name = \"_\" & Monat & \"_SatzNormal_LArt_66\"        'LFZ Urlaub MJ\n                xlWS.Range(\"C92\").Name = \"_\" & Monat & \"_SatzFGUZu_LArt_42\"         'FGU Zulage  MJ\n                'Spalte D\n                xlWS.Range(\"D86\").Name = \"_\" & Monat & \"_SatzNormal_LArt_30\"        'Lohn 2ab FA\n                'xlWS.Range(\"D86\").Name = \"_\" & Monat & \"_SatzNormal_LArt_51\"        'Lohn 2b FA     inaktiv\n                xlWS.Range(\"D87\").Name = \"_\" & Monat & \"_SatzNormal_LArt_31\"        'Lohn 2c FA\n                xlWS.Range(\"D91\").Name = \"_\" & Monat & \"_SatzNormal_LArt_32\"        'Freiw. Pers. Zulage\n                xlWS.Range(\"D94\").Name = \"_\" & Monat & \"_SatzNormal_LArt_64\"        'LFZ Krankheit (FA)\n                xlWS.Range(\"D93\").Name = \"_\" & Monat & \"_SatzNormal_LArt_66\"        'Urlaub (FA)\n                xlWS.Range(\"C92\").Name = \"_\" & Monat & \"_SatzFGUZu2_LArt_42\"        'FGU Zulage    (FA)\n                'Spalte F\n                xlWS.Range(\"F95\").Name = \"_\" & Monat & \"_SatzOhne_LArt_77777\"       'Overload\n                xlWS.Range(\"F96\").Name = \"_\" & Monat & \"_SatzOhne_LArt_99999\"       'Stunden gesamt   Nur Auswertung!\n                xlWS.Range(\"F97\").Name = \"_\" & Monat & \"_SatzOhne_LArt_88888\"       'Stunden abgerechnet    Nur Auswertung!\n                'Spalte M\n                xlWS.Range(\"M85\").Name = \"_\" & Monat & \"_SatzNacht_LArt_35\"         ' Nachtzuschlag werktags\n                'Spalte N\n                xlWS.Range(\"N85\").Name = \"_\" & Monat & \"_SatzSonn_LArt_36\"          'Sonntagszuschlag Tag\n                'xlWS.range(\"K83\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6055\"        '€  Vorschuss -> alt! -> T74 alt\n                'xlWS.Range(\"K84\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6018\"        '€  Abschlag alt\n                'xlWS.range(\"K85\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6009\"        '€  Dienstkl -> alt!\n                'xlWS.range(\"K86\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6006\"        '€  IHK RL -> alt!\n                'Spalte O\n                xlWS.Range(\"O85\").Name = \"_\" & Monat & \"_SatzSonnNacht_LArt_37\"     'Sonntagzuschlag Nacht\n                'Spalte P\n                xlWS.Range(\"P85\").Name = \"_\" & Monat & \"_SatzFeier_LArt_38\"         'Feiertagszuschlag Tag\n                'Spalte Q\n                xlWS.Range(\"Q85\").Name = \"_\" & Monat & \"_SatzFeierNacht_LArt_39\"    'Feiertagszuschlag Nacht\n                'Spalte R\n                xlWS.Range(\"R85\").Name = \"_\" & Monat & \"_SatzNormal_LArt_45\"        'Nachtzuschlag andere\n                'Spalte S\n                xlWS.Range(\"S85\").Name = \"_\" & Monat & \"_SatzNormal_LArt_46\"        'Sonntagszuschlag andere\n                'Spalte T\n                xlWS.Range(\"T85\").Name = \"_\" & Monat & \"_SatzOhne_LArt_48\"          'Feiertagszuschlag andere\n                'Spalte U\n                xlWS.Range(\"U85\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6024\"        '€  Reisekosten\n                'Spalte V Abzüge\n                'xlWS.Range(\"V66\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6004\"       '€  Pfändungsgebetrag wird manuell eingetragen\n                xlWS.Range(\"V67\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6006\"        '€  Pfändungsgebühr wird manuell eingetragen\n                xlWS.Range(\"V68\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6007\"        '€  Strom\n                xlWS.Range(\"V69\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6008\"        '€  Miete\n                xlWS.Range(\"V70\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6009\"        '€  Telefon\n                xlWS.Range(\"V71\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6010\"        '€  Erstattung Kaution\n                xlWS.Range(\"V72\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6011\"        '€  Kaution Dienstkl.\n                xlWS.Range(\"V73\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6012\"        '€  Ordnungsamt\n                xlWS.Range(\"V74\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6013\"        '€  Rückzahlung IHK\n                xlWS.Range(\"V75\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6014\"        '€  IHK RL\n                xlWS.Range(\"V76\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6015\"        '€  AGD\n                 'Spalte W\n                xlWS.Range(\"W77\").Name = \"_\" & Monat & \"_SatzOhne_LArt_6016\"        '€  Vorschuss\n\n               \n           Next i\n           xlWB.Close True\n        Else\n            erfasse_Fehler \"Keine Personalnummer zu Name \" & Name & \" gefunden\", Fil.Name, , , , \"Bereiche in Zeitkonten eintragen\"\n        End If\n    Next Fil\n   \nEnde:\nOn Error Resume Next\n    xlApp.DisplayAlerts = True\n    xlApp.Quit\n    Set xlApp = Nothing\n    Set xlWB = Nothing\n    Set xlWS = Nothing\n    Exit Function\nerr:\n    MsgBox err.Number & \" \" & err.description, vbCritical\n    Resume Ende\nEnd Function\n\n\n'################################\n'Funktionen für Abfragen\n'################################\n\n'Aktuellen Benutzer ermitteln\nFunction ermittle_Benutzer() As String\n    ermittle_Benutzer = Environ(\"UserName\")\nEnd Function\n\n''Nettowert für Zeitkonto ermitteln -> aus zuo_Stunden !!!!\n'Function ermittle_Nettowert(Anz_Std_Netto As Variant, Satz As Variant, Wert As Variant, Lohnart_ID As Integer) As Double\n'\n'' ggf. nach Lohnart unterscheiden...\n'    Select Case True\n'        'Wert ist Netto ohne Std & Satz\n'        Case IsNumeric(Wert) = True And IsNumeric(Anz_Std_Netto) = False And IsNumeric(Satz) = False\n'            ermittle_Nettowert = Wert\n'\n'        'Nettowert aus Netto-Std & Satz\n'        Case IsNumeric(Anz_Std_Netto) = True And IsNumeric(Satz) = True\n'            ermittle_Nettowert = Anz_Std_Netto * Satz\n'\n'        Case Else\n'            ermittle_Nettowert = 0\n'\n'    End Select\n'\n'End Function\n\n'Lohnart_ID ermitteln\nFunction ermittle_Lohnart_ID(MA_ID, Optional bez_kurz As String) As Integer\n\n    Select Case bez_kurz\n        Case \"Normal\"\n            ermittle_Lohnart_ID = Nz(TLookup(\"Stundenlohn_brutto\", MASTAMM, \"ID = \" & MA_ID), 0)\n            'Sonderlocken\n            'If ermittle_Lohnart_ID = 0 Then ermittle_Lohnart_ID = 1\n            \n        Case \"Nacht\"\n            ermittle_Lohnart_ID = 14\n            \n        Case \"Sonntag\"\n            ermittle_Lohnart_ID = 15\n            \n        Case \"SonntagNacht\"\n            ermittle_Lohnart_ID = 20\n            \n        Case \"Feiertag\"\n            ermittle_Lohnart_ID = 21\n            \n        Case \"FeiertagNacht\"\n            ermittle_Lohnart_ID = 22\n            \n        Case Else\n            ermittle_Lohnart_ID = 0\n            \n    End Select\n    \n    \nEnd Function\n\n'Lohnart ermitteln (für Abwesenheiten)\nFunction ermittle_Lohnart(Optional MA_ID As Integer, Optional grund As String, Optional Lohnart_ID As Integer) As String\n\n'Dim AnstArt    As Integer\n\n\n' Lohnart aus Mitarbeiterstamm\n    If grund = \"\" Then\n        If Lohnart_ID = 0 Then Lohnart_ID = Nz(TLookup(\"Stundenlohn_brutto\", MASTAMM, \"ID = \" & MA_ID), 0)\n        'If Lohnart_ID = 0 Then Lohnart_ID = 1 'WIEDER RAUSNEHMEN!!!\n        If Lohnart_ID <> 0 Then ermittle_Lohnart = Nz(TLookup(\"Nummer\", LOHNARTEN, \"ID = \" & Lohnart_ID), 0)\n\n    Else\n        Select Case grund\n            Case \"Urlaub\"\n                ermittle_Lohnart = Nz(TLookup(\"Nummer\", LOHNARTEN, \"ID = 27\"), 0)\n                \n            Case \"Krank\"\n                ermittle_Lohnart = Nz(TLookup(\"Nummer\", LOHNARTEN, \"ID = 28\"), 0)\n                \n            Case Else\n            \n        End Select\n        \n    End If\n\n\n'' Lohnart nach Anstellungsart?\n'On Error Resume Next\n'    AnstArt = TLookup(\"Anstellungsart_ID\", MASTAMM, \"ID =\" & MA_ID)\n'On Error GoTo 0\n'\n'    Select Case AnstArt\n'        Case 3 'Festangestellter\n'            Select Case grund\n'                'Case \"\"\n'                    'ermittle_Lohnart = \"NormalFest\" 'Tlookup(\"Nummer\",\"ztbl_ZK_Lohnarten\",\"ID = 1\")\n'                Case \"Urlaub\"\n'                    ermittle_Lohnart = \"UrlaubFest\" 'Tlookup(\"Nummer\",\"ztbl_ZK_Lohnarten\",\"ID = 1\")\n'                Case \"Krank\"\n'                    ermittle_Lohnart = \"krankFest\" 'Tlookup(\"Nummer\",\"ztbl_ZK_Lohnarten\",\"ID = 1\")\n'            End Select\n'\n'        Case 5 'Minijobber\n'                    Select Case grund\n'                'Case \"\"\n'                    'ermittle_Lohnart = \"NormalMini\" 'Tlookup(\"Nummer\",\"ztbl_ZK_Lohnarten\",\"ID = 1\")\n'                Case \"Urlaub\"\n'                    ermittle_Lohnart = \"UrlaubMini\" 'Tlookup(\"Nummer\",\"ztbl_ZK_Lohnarten\",\"ID = 1\")\n'                Case \"Krank\"\n'                    ermittle_Lohnart = \"krankMini\" 'Tlookup(\"Nummer\",\"ztbl_ZK_Lohnarten\",\"ID = 1\")\n'            End Select\n'\n'\n'        Case Else 'Evtl Protokollieren\n'            'ermittle_Lohnart = \"ERROR\"\n'\n'    End Select\n'\nEnd Function\n\n\n'Anzahl Stunden nach Lohnart ermitteln -> Nur Urlaub, Krank, Zulage!\nFunction ermittle_Stunden(Lohnart_ID As Integer, Datum As Date, Start As Date, Ende As Date, Optional MA_ID As Integer, Optional bez_kurz As String) As Double\n\nOn Error GoTo err\n    \n    If bez_kurz = \"\" Then bez_kurz = Nz(TLookup(\"Bezeichnung_kurz\", LOHNARTEN, \"ID = \" & Lohnart_ID), \"\")\n\n    Select Case bez_kurz\n        Case \"Normal\"\n            ermittle_Stunden = stunden(Start, Ende)\n            \n        Case \"Nacht\"\n            ermittle_Stunden = Stunden_Zuschlag(Datum, Start, Ende, \"Nacht\")\n            \n        Case \"Sonntag\"\n            ermittle_Stunden = Stunden_Zuschlag(Datum, Start, Ende, \"Sonntag\")\n            \n        Case \"SonntagNacht\"\n            ermittle_Stunden = Stunden_Zuschlag(Datum, Start, Ende, \"SonntagNacht\")\n            \n        Case \"Feiertag\"\n            ermittle_Stunden = Stunden_Zuschlag(Datum, Start, Ende, \"Feiertag\")\n            \n        Case \"FeiertagNacht\"\n            ermittle_Stunden = Stunden_Zuschlag(Datum, Start, Ende, \"FeiertagNacht\")\n            \n        Case \"Urlaub\"\n            ermittle_Stunden = Stunden_Urlaub(MA_ID)\n            \n        Case \"Krank\"\n            ermittle_Stunden = Stunden_Krank(MA_ID)\n            \n        Case \"Zulage\"\n            'Zulage Euro oder Stunden?\n            If TLookup(\"Euro\", LOHNARTEN, \"ID = \" & Lohnart_ID) = False Then\n                ermittle_Stunden = stunden(Start, Ende)\n            Else\n                ermittle_Stunden = Null  'PAUSCHAL  -> ANPASSEN!!!\n            End If\n            \n        Case Else\n            ermittle_Stunden = Null  'PAUSCHAL  -> ANPASSEN!!!\n            \n    End Select\n        \n    \nExit Function\nerr:\n    Debug.Print err.Number & \"\" & err.description\nEnd Function\n\n'Stunden Urlaub ermitteln\nFunction Stunden_Urlaub(MA_ID As Integer) As Double\n\n    ' Stunden pro Arbeitstag aus Mitarbeiterstamm\n    Stunden_Urlaub = Nz(TLookup(\"Arbst_pro_Arbeitstag\", MASTAMM, \"ID = \" & MA_ID), 0)\n\n    'Berechnung, falls kein Eintrag\n    If Stunden_Urlaub = 0 Then\n        Stunden_Urlaub = ArbStundenProTag(MA_ID)\n    End If\n    \n    'ggf. Stundenberechnung analog NV-Stunden?\n    \nEnd Function\n\n'Stunden Krank ermitteln\nFunction Stunden_Krank(MA_ID As Integer) As Double\n\n    ' Stunden pro Arbeitstag aus Mitarbeiterstamm\n    Stunden_Krank = Nz(TLookup(\"Arbst_pro_Arbeitstag\", MASTAMM, \"ID = \" & MA_ID), 0)\n    \n    'Berechnung, falls kein Eintrag\n    If Stunden_Krank = 0 Then\n        Stunden_Krank = ArbStundenProTag(MA_ID)\n    End If\n    \n    'ggf. Stundenberechnung analog NV-Stunden?\n\nEnd Function\n\n'Stundensatz nach Lohnart (und Zeitraum) ermitteln\nFunction ermittle_Stundensatz(Optional Lohnart_ID As Long, Optional MA_ID As Integer, Optional Datum As Date, Optional bez_kurz As String) As Double\n\nDim Lohnart_ID_MA As Integer\nDim Satz_MA       As Double\nDim Faktor        As Double\nDim SQLWHERE      As String\n\n\n    'zum Datum gültiger Satz\n    If Datum <> \"00.00.00\" Then\n        SQLWHERE = \" AND DatumBis >= \" & datumSQL(Datum) & \" AND Datumvon <= \" & datumSQL(Datum)\n    Else\n        SQLWHERE = \" AND DatumBis = \" & datumSQL(\"31.12.9999\")\n    End If\n    \n    'Kein Satz hinterlegt -> Krank? Urlaub? -> Lohnart_ID aus MAStamm\n    If MA_ID <> 0 Then\n        Lohnart_ID_MA = Nz(TLookup(\"Stundenlohn_brutto\", MASTAMM, \"ID = \" & MA_ID), 0)\n        If Lohnart_ID_MA <> 0 Then _\n            Satz_MA = Nz(TLookup(\"Satz\", LOHNARTEN, \"ID = \" & Lohnart_ID_MA & SQLWHERE), 0)\n    End If\n    \n    \n    Select Case bez_kurz\n        Case \"Normal\"\n            ermittle_Stundensatz = Satz_MA\n            \n        Case \"Nacht\"\n            Faktor = Nz(TLookup(\"Faktor\", LOHNARTEN, \"ID = \" & Lohnart_ID & SQLWHERE), 0)\n            ermittle_Stundensatz = Satz_MA * Faktor\n            \n        Case \"Sonntag\"\n            Faktor = Nz(TLookup(\"Faktor\", LOHNARTEN, \"ID = \" & Lohnart_ID & SQLWHERE), 0)\n            ermittle_Stundensatz = Satz_MA * Faktor\n            \n        Case \"SonntagNacht\"\n            Faktor = Nz(TLookup(\"Faktor\", LOHNARTEN, \"ID = \" & Lohnart_ID & SQLWHERE), 0)\n            ermittle_Stundensatz = Satz_MA * Faktor\n            \n        Case \"Feiertag\"\n            Faktor = Nz(TLookup(\"Faktor\", LOHNARTEN, \"ID = \" & Lohnart_ID & SQLWHERE), 0)\n            ermittle_Stundensatz = Satz_MA * Faktor\n            \n        Case \"FeiertagNacht\"\n            Faktor = Nz(TLookup(\"Faktor\", LOHNARTEN, \"ID = \" & Lohnart_ID & SQLWHERE), 0)\n            ermittle_Stundensatz = Satz_MA * Faktor\n            \n        Case \"Urlaub\"\n            ermittle_Stundensatz = Satz_MA\n            \n        Case \"Krank\"\n            ermittle_Stundensatz = Satz_MA\n            \n        Case \"Zulage\"\n            'Zulage Euro oder Stunden?\n            If TLookup(\"Euro\", LOHNARTEN, \"ID = \" & Lohnart_ID) = False Then\n                Faktor = Nz(TLookup(\"Faktor\", LOHNARTEN, \"ID = \" & Lohnart_ID & SQLWHERE), 0)   'PRÜFEN!!!\n                ermittle_Stundensatz = Satz_MA * Faktor\n            Else\n                ermittle_Stundensatz = 0  'PAUSCHAL  -> ANPASSEN!!!\n            End If\n        Case Else\n            ermittle_Stundensatz = 0  'PAUSCHAL  -> ANPASSEN!!!\n            \n    End Select\n    \n    \n    \n    'ggf. pauschaler Satz / pauschale Lohnart bei Urlaub oder Krank???\n    \n    \nEnd Function\n\n'Daten zusammenfügen\nFunction ermittle_ZK_Daten(Jahr As Integer, Monat As Integer, Optional MA_ID As Long, Optional Anst_ID As Integer)\n\nDim sql         As String\nDim WHERE       As String\nDim where2      As String\nDim tmpTBL      As String\nDim tbl         As String\nDim ABF         As String\nDim AnstArtMA   As Integer\n\nOn Error GoTo err\n    \n    DoCmd.Hourglass True\n    \n    'Anstellungsart des Kollegen\n    If MA_ID <> 0 Then AnstArtMA = Nz(TLookup(\"Anstellungsart_ID\", MASTAMM, \"ID = \" & MA_ID), 0)\n        \n    'Daten im FE aktualisieren -> relevanter Monat\n    SysCmd acSysCmdInitMeter, \"Aktualisiere...\", 1\n    refresh_zuoplanfe , \"BETWEEN \" & datumSQL(DateSerial(Jahr, Monat, 1)) & \" AND \" & datumSQL(DateSerial(Jahr, Monat + 1, 0))\n    \n    tmpTBL = \"[ztbl_ZK_Stunden_prepare]\"\n    tbl = \"[ztbl_ZK_Stunden]\"\n    \n    'Nicht übertragene und nicht gesperrte sätze löschen\n    sql = \"DELETE * FROM \" & tbl & \" WHERE [gesperrt] = FALSE AND [exportiert] = FALSE\"\n    CurrentDb.Execute sql\n    \n    'Temp Tabelle löschen\n    sql = \"DELETE * FROM \" & tmpTBL\n    CurrentDb.Execute sql\n    \n    WHERE = \" [Jahr] = \" & Jahr & \" AND [Monat] = \" & Monat\n    If MA_ID <> 0 Then WHERE = WHERE & \" AND [MA_ID] = \" & MA_ID\n    If Anst_ID <> 0 Then WHERE = WHERE & \" AND [Anstellungsart_ID] = \" & Anst_ID\n    where2 = \" AND [exportiert] = FALSE AND [gesperrt] = FALSE\"\n    \n    \n    'Datum puffern\n    Set_Priv_Property \"prp_ZK_Datum\", DateSerial(Jahr, Monat + 1, 0)\n    \n    'noch nicht übertragene Daten + nicht gesperrte Daten entfernen\n    sql = \"DELETE FROM \" & tbl & \"WHERE \" & WHERE & where2\n    \n    'Stunden Gesamt\n    SysCmd acSysCmdInitMeter, \"Ermittle Gesamtstunden...\", 1\n    ABF = \"[zqry_ZUO_ZK_Stunden_FE]\"\n    sql = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & ABF & \" WHERE\" & WHERE\n    CurrentDb.Execute sql\n    \n    'Urlaub Krank Intern\n    SysCmd acSysCmdInitMeter, \"Ermittle Urlaub...\", 1\n    ABF = \"[zqry_ZUO_ZK_NV_FE]\"\n    sql = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & ABF & \" WHERE\" & WHERE\n    CurrentDb.Execute sql\n    \n    'Zulagen / Abzüge laut MAStamm -> Datum über prp_ZK_Datum!\n    ABF = \"[zqry_ZUO_ZK_pers_ZuAb]\"\n    sql = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & ABF\n    CurrentDb.Execute sql\n    \n''ALLE STUNDEN KOMMEN JETZT ÜBER EINE ABFRAGE!\n'    'Stunden Normal\n'    SysCmd acSysCmdInitMeter, \"Ermittle Gesamtstunden...\", 1\n'    abf = \"[zqry_ZUO_ZK_Stunden_Normal_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Stunden Nacht\n'    SysCmd acSysCmdInitMeter, \"Ermittle Zuschlag Nacht...\", 1\n'    abf = \"[zqry_ZUO_ZK_Stunden_Nacht_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Stunden Sonntag\n'    SysCmd acSysCmdInitMeter, \"Ermittle Zuschlag Sonntag...\", 1\n'    abf = \"[zqry_ZUO_ZK_Stunden_Sonntag_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Stunden SonntagNacht\n'    SysCmd acSysCmdInitMeter, \"Ermittle Zuschlag Sonntag Nacht...\", 1\n'    abf = \"[zqry_ZUO_ZK_Stunden_SonntagNacht_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Stunden Feiertag\n'    SysCmd acSysCmdInitMeter, \"Ermittle Zuschlag Feiertag...\", 1\n'    abf = \"[zqry_ZUO_ZK_Stunden_Feiertag_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Stunden FeiertagNacht\n'    SysCmd acSysCmdInitMeter, \"Ermittle Zuschlag Feiertag Nacht...\", 1\n'    abf = \"[zqry_ZUO_ZK_Stunden_FeiertagNacht_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Urlaub\n'    SysCmd acSysCmdInitMeter, \"Ermittle Urlaub...\", 1\n'    abf = \"[zqry_ZUO_ZK_NV_Urlaub_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Krank\n'    SysCmd acSysCmdInitMeter, \"Ermittle Krankeit...\", 1\n'    abf = \"[zqry_ZUO_ZK_NV_Krank_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n'\n'    'Intern\n'    SysCmd acSysCmdInitMeter, \"Ermittle Intern...\", 1\n'    abf = \"[zqry_ZUO_ZK_Intern_FE]\"\n'    SQL = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & abf & \" WHERE\" & Where\n'    CurrentDb.Execute SQL\n    \n'    'Nullwerte entfernen (nur Zuordnungsdaten!)\n'    SysCmd acSysCmdInitMeter, \"Entferne Nullwerte...\", 1\n'    SQL = \"DELETE * FROM \" & tmpTBL & \" WHERE [Anz_Std] = 0 AND [Wert] = 0\"\n'    CurrentDb.Execute SQL\n\n    'Reisekosten -> € !! -> Wert im Stunden-Feld wird für Anzeige benötigt!!!\n    SysCmd acSysCmdInitMeter, \"Ermittle Reisekosten...\", 1\n    ABF = \"[zqry_ZUO_ZK_Reisekosten]\"\n    sql = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & ABF & \" WHERE\" & WHERE\n    CurrentDb.Execute sql\n    \n    'Korrekturen\n    SysCmd acSysCmdInitMeter, \"Ermittle Korrekturen...\", 1\n    ABF = \"[zqry_ZUO_ZK_Korrekturen_FE]\"\n    sql = \"INSERT INTO \" & tmpTBL & \" SELECT * FROM \" & ABF & \" WHERE\" & WHERE\n    CurrentDb.Execute sql\n\n    'Delta übertragen\n    SysCmd acSysCmdInitMeter, \"Übertrage Delta...\", 1\n    sql = \"INSERT INTO \" & tbl & \" SELECT * FROM [zqry_ZK_Stunden_Delta]\"\n    CurrentDb.Execute sql\n    \n    'MJ Stunden schieben\n    If MA_ID <> 0 And AnstArtMA = 5 Then\n        Call maxEuro_MJ(Monat, Jahr, MA_ID)\n    Else\n        'Funktion schreiben nach Anstellungsart?\n    End If\n    \n    'IHK-Rücklage als Korrektur\n    If MA_ID <> 0 Then\n        Call calc_RL34a(Monat, Jahr, MA_ID)\n    Else\n        'Funktion schreiben nach Anstellungsart?\n    End If\n    \nEnde:\n    SysCmd acSysCmdRemoveMeter\n    DoCmd.Hourglass False\n    Exit Function\nerr:\n    MsgBox \"Fehler bei der Aktualisierung!\" & vbCrLf & err.Number & \" \" & err.description, vbCritical\n    Resume Ende\n    \nEnd Function\n\n\n'Minijobber: Stunden über 520€ als Korrektur in Folgemonat schieben\nFunction maxEuro_MJ(Monat As Integer, Jahr As Integer, MA_ID As Long)\n\nDim rs      As Recordset\nDim WHERE   As String   'Werte nach MA, Jahr und Monat\nDim where2  As String   'mit Stundenkorrektur nicht exportiert\nDim sql     As String\nDim Wert    As Double\nDim maxWert As Double\nDim zJahr   As Integer\nDim zMonat  As Integer\nDim LIDMA   As Integer  'Lohnart des Mitarbeiters\nDim Satz    As Currency\nDim AnzStd  As Double\n    \n    maxWert = 520\n\n    'Dezember?\n    If Monat < 12 Then\n        zJahr = Jahr\n        zMonat = Monat + 1\n    Else\n        zJahr = Jahr + 1\n        zMonat = 1\n    End If\n    \n    WHERE = \"[MA_ID] = \" & MA_ID & \" AND [Jahr] = \" & Jahr & \" AND [Monat] = \" & Monat\n    where2 = \" AND [Lohnart_ID] = 55 AND [exportiert] = FALSE\"\n    sql = \"SELECT * FROM [\" & KORR & \"] WHERE \" & WHERE & where2\n    \n    'Gesamtwert Netto lesen (ohne Zuschläge und Std in Folgemonat)\n    'Wert = Nz(TSum(\"Wert_Netto\", \"zqry_ZK_Stunden_Zusatz\", WHERE & \" AND [Lohnart_ID] <> 55\"), 0)\n    Wert = Round(Nz(TSum(\"Wert\", \"zqry_ZK_Stunden_Zusatz\", WHERE & \" AND [Lohnart_ID] <> 55 AND ([Bezeichnung_kurz] = 'Normal' OR [Bezeichnung_kurz] Is Null)\"), 0), 2)\n    \n    If Wert > maxWert Then\n        LIDMA = Nz(TLookup(\"Stundenlohn_brutto\", MASTAMM, \"ID = \" & MA_ID), 0)\n        Satz = Nz(TLookup(\"Satz\", LOHNARTEN, \"ID = \" & LIDMA), 0)\n        \n        If Satz = 0 Then Exit Function\n        \n        'Stunden berechnen mit 0,01 Sicherheitsabstand\n        AnzStd = Round((maxWert - Wert) / Satz, 2) - 0.01\n        \n        Set rs = CurrentDb.OpenRecordset(sql)\n        'noch nicht exportierte Stundenkorrektur vorhanden?\n        If Not rs.EOF Then\n            rs.Edit\n            rs.fields(\"Aenderer\") = Environ(\"UserName\")\n            rs.fields(\"geaendert\") = Now\n            rs.fields(\"Anz_Std\") = AnzStd\n            rs.fields(\"Satz\") = Satz\n            rs.fields(\"Wert\") = Round(AnzStd * Satz, 2)\n            rs.fields(\"Korr_ID_ref\") = ref_korr_anlegen(MA_ID, zJahr, zMonat, rs.fields(\"ID\"), , Abs(AnzStd), Satz, 54, rs.fields(\"Bemerkung\"))\n            If IsNull(rs.fields(\"Bemerkung\")) Then rs.fields(\"Bemerkung\") = TLookup(\"Bezeichnung\", LOHNARTEN, \"ID = 55\")\n        Else\n            'neue Korrektur anlegen\n            rs.AddNew\n            rs.fields(\"MA_ID\") = MA_ID\n            rs.fields(\"Jahr\") = Jahr\n            rs.fields(\"Monat\") = Monat\n            rs.fields(\"Lohnart_ID\") = 55\n            rs.fields(\"Ersteller\") = Environ(\"UserName\")\n            rs.fields(\"erstellt\") = Now\n            rs.fields(\"Bemerkung\") = TLookup(\"Bezeichnung\", LOHNARTEN, \"ID = 55\")\n            rs.fields(\"exportieren\") = True\n            rs.fields(\"Anz_Std\") = AnzStd\n            rs.fields(\"Satz\") = Satz\n            rs.fields(\"Wert\") = Round(AnzStd * Satz, 2)\n            rs.fields(\"Korr_ID_ref\") = ref_korr_anlegen(MA_ID, zJahr, zMonat, rs.fields(\"ID\"), , Abs(AnzStd), Satz, 54, rs.fields(\"Bemerkung\"))\n            \n        End If\n           \n        rs.update\n        rs.Close\n        Set rs = Nothing\n            \n        'im FE aktualisieren\n        CurrentDb.Execute \" DELETE FROM [\" & KORR & \"_FE] WHERE \" & WHERE & where2\n        CurrentDb.Execute \"INSERT INTO [\" & KORR & \"_FE] SELECT * FROM [zqry_MA_ZK_Korrekturen] WHERE \" & WHERE & where2\n        \n        'Korrektur aufbereiten\n        CurrentDb.Execute \"DELETE FROM [ztbl_ZK_Stunden_prepare] \" & \" WHERE\" & WHERE & where2\n        CurrentDb.Execute \"INSERT INTO [ztbl_ZK_Stunden_prepare] SELECT * FROM \" & \"[zqry_ZUO_ZK_Korrekturen_FE]\" & \" WHERE\" & WHERE & where2\n        \n        'Korrektur übertragen\n        CurrentDb.Execute \"DELETE FROM [ztbl_ZK_Stunden] \" & \" WHERE\" & WHERE & where2\n        CurrentDb.Execute \"INSERT INTO [ztbl_ZK_Stunden] SELECT * FROM \" & \"[zqry_ZK_Stunden_Delta]\" & \" WHERE\" & WHERE & where2\n\n    End If\n\n\nEnd Function\n\n\n'Korrektur für Folgemonat oder MA + Monat anlegen\nFunction ref_korr_anlegen(ByVal MA_ID As Long, ByVal Jahr As Integer, ByVal Monat As Integer, Korr_ID_ref As Integer, _\n    Optional ByVal Wert As Double, Optional ByVal Anz_Std As Double, Optional ByVal Satz As Double, _\n        Optional Lohnart_ID As Integer, Optional ByVal Bez As Variant, Optional ByVal refMA_ID As Long) As Integer\n        \nDim sql     As String\nDim rs      As Recordset\n\n\n    sql = \"SELECT * FROM [\" & KORR & \"] WHERE [Korr_ID_ref] = \" & Korr_ID_ref '& \" AND [MA_ID] = \" & MA_ID & _\n        \" AND [Monat] = \" & Monat & \" AND [Jahr] = \" & Jahr\n        \n    Set rs = CurrentDb.OpenRecordset(sql)\n    \n    If Not rs.EOF Then\n        rs.Edit\n    Else\n        rs.AddNew\n    End If\n    \n    'MA_ID gleich?\n    If MA_ID <> refMA_ID And refMA_ID <> 0 Then\n        rs.fields(\"MA_ID\") = refMA_ID\n        If Lohnart_ID <> 0 Then rs.fields(\"Lohnart_ID\") = Lohnart_ID\n        'Bemerkung\n        Bez = TLookup(\"Nachname\", MASTAMM, \"ID = \" & MA_ID) & \" \" & TLookup(\"Vorname\", MASTAMM, \"ID = \" & MA_ID)\n        rs.fields(\"Bemerkung\") = \"von \" & Monat & \"/\" & Jahr & \" \" & Bez\n    Else\n        rs.fields(\"MA_ID\") = MA_ID\n        'Bemerkung\n        If Lohnart_ID <> 0 Then\n            rs.fields(\"Lohnart_ID\") = Lohnart_ID\n            rs.fields(\"Bemerkung\") = TLookup(\"Bezeichnung\", LOHNARTEN, \"ID = \" & Lohnart_ID)\n        Else 'keine Folgelohnart??\n            rs.fields(\"Bemerkung\") = Bez & \" aus \" & Monat & \".\" & Jahr\n        End If\n    End If\n    \n    rs.fields(\"Jahr\") = Jahr\n    rs.fields(\"Monat\") = Monat\n    \n    'Stunden?\n    If Anz_Std <> 0 Then\n        rs.fields(\"Anz_Std\") = Anz_Std\n        rs.fields(\"Satz\") = Satz\n        If Wert = 0 Then Wert = Anz_Std * Satz\n    End If\n    'Euro?\n    If Wert <> 0 Then\n        rs.fields(\"Wert\") = Wert\n    End If\n    rs.fields(\"Korr_ID_ref\") = Korr_ID_ref\n    rs.fields(\"exportieren\") = True\n    rs.fields(\"erstellt\") = Now\n    rs.fields(\"Ersteller\") = Environ(\"UserName\")\n    \n    'ID des neuen Satzes zurückgeben\n    ref_korr_anlegen = rs.fields(\"ID\")\n    \n    rs.update\n    rs.Close\n    Set rs = Nothing\n\nEnd Function\n\n\n'IHK Rücklage berechnen (10% vom Gesamtbetrag €)\nFunction calc_RL34a(Monat As Integer, Jahr As Integer, MA_ID As Long)\n\nDim rs      As Recordset\nDim WHERE   As String   'Werte nach MA, Jahr und Monat\nDim where2  As String   'Wert IHK RL nicht exportiert\nDim WHERE3  As String   'Gesamtwert nicht exportiert ohne IHK RL\nDim sql     As String\nDim Wert    As Double\n    \n    \n    WHERE = \"[MA_ID] = \" & MA_ID & \" AND [Jahr] = \" & Jahr & \" AND [Monat] = \" & Monat\n    where2 = \" AND [Lohnart_ID] = 40 AND [exportiert] = FALSE\"\n    WHERE3 = \" AND [Lohnart_ID] <> 40 AND [exportiert] = FALSE\"\n    sql = \"SELECT * FROM [\" & KORR & \"] WHERE \" & WHERE & where2\n    \n    'Rücklage bilden?\n    If TLookup(\"Hat_keine_34a\", MASTAMM, \"ID = \" & MA_ID) = False Then\n        \n       'Gesamtwert ohne IHK-Rücklage\n        Wert = Nz(TSum(\"Wert\", \"zqry_ZK_Stunden\", WHERE & WHERE3), 0)\n        \n        If Wert > 0 Then\n            Set rs = CurrentDb.OpenRecordset(sql)\n            \n            If Not rs.EOF Then\n                rs.Edit\n                rs.fields(\"Aenderer\") = Environ(\"UserName\")\n                rs.fields(\"geaendert\") = Now\n                \n            Else\n                rs.AddNew\n                rs.fields(\"MA_ID\") = MA_ID\n                rs.fields(\"Jahr\") = Jahr\n                rs.fields(\"Monat\") = Monat\n                rs.fields(\"Lohnart_ID\") = 40\n                rs.fields(\"Ersteller\") = Environ(\"UserName\")\n                rs.fields(\"erstellt\") = Now\n                rs.fields(\"Bemerkung\") = \"IHK Rücklage\"\n                rs.fields(\"exportieren\") = True\n                   \n            End If\n\n            'IHK Rücklage 10%\n            rs.fields(\"Wert\") = -Round(Wert / 10, 2)\n            rs.update\n            rs.Close\n            Set rs = Nothing\n            \n            'im FE aktualisieren\n            CurrentDb.Execute \" DELETE FROM [\" & KORR & \"_FE] WHERE \" & WHERE & where2\n            CurrentDb.Execute \"INSERT INTO [\" & KORR & \"_FE] SELECT * FROM [zqry_MA_ZK_Korrekturen] WHERE \" & WHERE & where2\n            \n            'Korrektur aufbereiten\n            CurrentDb.Execute \"DELETE FROM [ztbl_ZK_Stunden_prepare] \" & \" WHERE\" & WHERE & where2\n            CurrentDb.Execute \"INSERT INTO [ztbl_ZK_Stunden_prepare] SELECT * FROM \" & \"[zqry_ZUO_ZK_Korrekturen_FE]\" & \" WHERE\" & WHERE & where2\n            \n            'Korrektur übertragen\n            CurrentDb.Execute \"DELETE FROM [ztbl_ZK_Stunden] \" & \" WHERE\" & WHERE & where2\n            CurrentDb.Execute \"INSERT INTO [ztbl_ZK_Stunden] SELECT * FROM \" & \"[zqry_ZK_Stunden_Delta]\" & \" WHERE\" & WHERE & where2\n        End If\n    End If\n    \nEnd Function\n\n\n'Korrektur anlegen (automatisch, wennn noch nicht exportiert)\nFunction korrektur_anlegen_wert(ByVal MA_ID As Long, ByVal Lohnart_ID As Long, ByVal Jahr As Integer, ByVal Monat As Integer, ByVal Wert As Double, Optional ByVal Bemerkung As String) As String\n\nDim rs      As Recordset\nDim WHERE   As String   'Werte nach MA, Jahr, Monat & Lohnart\nDim sql     As String\n    \n    \n    WHERE = \"[MA_ID] = \" & MA_ID & \" AND [Jahr] = \" & Jahr & \" AND [Monat] = \" & Monat & _\n        \" AND [Lohnart_ID] = \" & Lohnart_ID '& \" AND [exportiert] = FALSE\"\n\n    sql = \"SELECT * FROM [\" & KORR & \"] WHERE \" & WHERE\n    \n    If Wert > 0 Then\n        Select Case TLookup(\"Vorzeichen\", LOHNARTEN, \"ID = \" & Lohnart_ID)\n            Case \"+\"\n                Wert = Abs(Wert)\n                \n            Case \"-\"\n                Wert = -Abs(Wert)\n                \n            Case Else\n                korrektur_anlegen_wert = \"Fehler Vorzeichen!\"\n                Exit Function\n            \n        End Select\n        \n        Set rs = CurrentDb.OpenRecordset(sql)\n        \n        If Not rs.EOF Then\n            If rs.fields(\"exportiert\") = True Then 'Differenz exportieren oder Fehlermeldung?\n'                rs.Edit\n'                rs.Fields(\"Aenderer\") = Environ(\"UserName\")\n'                rs.Fields(\"geaendert\") = Now\n                MsgBox \"Wert wurde bereits exportiert!\", vbCritical\n                Exit Function\n            Else\n                'Wert korrigieren\n                rs.Edit\n                rs.fields(\"Aenderer\") = Environ(\"UserName\")\n                rs.fields(\"geaendert\") = Now\n            End If\n            \n        Else\n            rs.AddNew\n            rs.fields(\"MA_ID\") = MA_ID\n            rs.fields(\"Jahr\") = Jahr\n            rs.fields(\"Monat\") = Monat\n            rs.fields(\"Lohnart_ID\") = Lohnart_ID\n            rs.fields(\"Ersteller\") = Environ(\"UserName\")\n            rs.fields(\"erstellt\") = Now\n            If Bemerkung = \"\" Then\n                rs.fields(\"Bemerkung\") = TLookup(\"Bezeichnung\", LOHNARTEN, \"ID = \" & Lohnart_ID)\n            Else\n                rs.fields(\"Bemerkung\") = Bemerkung\n            End If\n            rs.fields(\"exportieren\") = True\n               \n        End If\n\n        'IHK Rücklage 10%\n        rs.fields(\"Wert\") = Round(Wert, 2)\n        rs.update\n        rs.Close\n        Set rs = Nothing\n        \n        'im FE aktualisieren\n        CurrentDb.Execute \" DELETE FROM [\" & KORR & \"_FE] WHERE \" & WHERE\n        CurrentDb.Execute \"INSERT INTO [\" & KORR & \"_FE] SELECT * FROM [zqry_MA_ZK_Korrekturen] WHERE \" & WHERE\n        \n        'Korrektur aufbereiten\n        CurrentDb.Execute \"DELETE FROM [ztbl_ZK_Stunden_prepare] \" & \" WHERE\" & WHERE\n        CurrentDb.Execute \"INSERT INTO [ztbl_ZK_Stunden_prepare] SELECT * FROM \" & \"[zqry_ZUO_ZK_Korrekturen_FE]\" & \" WHERE\" & WHERE\n        \n        'Korrektur übertragen\n        CurrentDb.Execute \"DELETE FROM [ztbl_ZK_Stunden] \" & \" WHERE\" & WHERE\n        CurrentDb.Execute \"INSERT INTO [ztbl_ZK_Stunden] SELECT * FROM \" & \"[zqry_ZK_Stunden_Delta]\" & \" WHERE\" & WHERE\n    End If\n\nEnd Function\n\n\n'Urlaubsanspruch berechnen\nFunction Urlaubsanspruch(MA_ID As Long) As Double\n\nDim TageGesamt    As Double\nDim TageProWoche  As Double\nDim Stundenprotag As Double\n\n    TageGesamt = AnzTageGesamt(MA_ID)\n    TageProWoche = AnzTageProWoche(MA_ID)\n    Stundenprotag = ArbStundenProTag(MA_ID)\n    \n    If TageGesamt / 7 > TageProWoche Then\n        ' Fall 1\n        Urlaubsanspruch = TageGesamt * TageProWoche * Stundenprotag\n    ElseIf TageGesamt <> 0 Then\n        ' Fall 2\n        Urlaubsanspruch = TageGesamt / 7 * Stundenprotag\n    Else\n        ' Fall 3\n        Urlaubsanspruch = Nz(TLookup(\"Urlaubsanspr_pro_Jahr\", MASTAMM, \"ID = \" & MA_ID), 0)\n    End If\n    \nEnd Function\n\n\n'Anzahl Tage gesamt berechnen\nFunction AnzTageGesamt(MA_ID As Long) As Double\n\nDim DatVon    As Date\nDim DatBis    As Date\n\n    'letzter Tag der letzten Woche\n    DatBis = Date + (7 - Weekday(Date, vbMonday)) - 7\n    'erster Tag der Woche vor 13 Wochen\n    DatVon = DatBis - 90\n    \n    AnzTageGesamt = Nz(TCount(\"VADatum\", ZUORDNUNG, \"MA_ID =\" & MA_ID & \" AND VADatum >= \" & datumSQL(DatVon) & \" AND VADatum <= \" & datumSQL(DatBis)), 0)\n    \nEnd Function\n\n\n'Arbeitstage pro Woche berechnen\nFunction AnzTageProWoche(ByVal MA_ID As String) As Double\n\nDim DatVon    As Date\nDim DatBis    As Date\nDim AnzWochen As Double\nDim AnzATage  As Integer\n\n    'Schritt 1: Feld aus Mitarbeiterstamm\n    AnzTageProWoche = Nz(TLookup(\"Arbeitstage_pro_Woche\", MASTAMM, \"ID = \" & MA_ID), 0)\n    If AnzTageProWoche <> 0 Then Exit Function\n    \n    'Schritt 2: Ermittlung aus Vergangenheit, wenn feld leer ist\n    \n    'Monatserster = DateAdd(\"d\", -Day(Date) + 1, Date)5\n    'Monatsletzter = DateSerial(Year(Date), Month(Date), 1 - 1)\n    'FirstDayOfWeek = dtDate - (Weekday(dtDate, vbMonday) - 1)\n    'LastDayOfWeek = dtDate + (7 - Weekday(dtDate, vbMonday))\n    \n    'letzter Tag der letzten Woche\n    DatBis = Date + (7 - Weekday(Date, vbMonday)) - 7\n    'erster Tag der Woche vor 13 Wochen\n    DatVon = DatBis - 90\n\n    AnzWochen = DateDiff(\"ww\", DatVon, DatBis)\n    AnzATage = Nz(TCount(\"VADatum\", ZUORDNUNG, \"MA_ID =\" & MA_ID & \" AND VADatum >= \" & datumSQL(DatVon) & \" AND VADatum <= \" & datumSQL(DatBis)), 0)\n    AnzTageProWoche = Nz(Round(AnzATage / AnzWochen, 2), 0)\n    \n    \n    'Schritt 3: Ermittlung aus Vorjahr, wenn Wert zu gering\n    If AnzTageProWoche < 1.5 Then\n        'letzter Tag des letzten Jahres\n        DatBis = \"31.12.\" & year(Date) - 1\n        'erster Tag des letzten Jahres\n        DatVon = \"01.01.\" & year(Date) - 1\n    \n        AnzWochen = DateDiff(\"ww\", DatVon, DatBis)\n        AnzATage = Nz(TCount(\"VADatum\", ZUORDNUNG, \"MA_ID =\" & MA_ID & \" AND VADatum >= \" & datumSQL(DatVon) & \" AND VADatum <= \" & datumSQL(DatBis)), 0)\n        AnzTageProWoche = Nz(Round(AnzATage / AnzWochen, 2), 0)\n    End If\n    \nEnd Function\n\n\n'Arbeitsstunden pro Arbeitstag berechnen\nFunction ArbStundenProTag(ByVal MA_ID As String) As Double\n\nDim DatVon      As Date\nDim DatBis      As Date\nDim AnzStunden  As Double\nDim AnzATage    As Integer\nDim rs          As Recordset\nDim sql         As String\n    \n    'Schritt 1: Feld aus Mitarbeiterstamm\n    ArbStundenProTag = Nz(TLookup(\"Arbst_pro_Arbeitstag\", MASTAMM, \"ID = \" & MA_ID), 0)\n    If ArbStundenProTag <> 0 Then Exit Function\n    \n    'Schritt 2: Ermittlung aus Vergangenheit, wenn feld leer ist\n    \n    'letzter Tag der letzten Woche\n    DatBis = Date + (7 - Weekday(Date, vbMonday)) - 7\n    'erster Tag der Woche vor 13 Wochen\n    DatVon = DatBis - 90\n    \n    AnzATage = Nz(TCount(\"VADatum\", ZUORDNUNG, \"MA_ID =\" & MA_ID & \" AND VADatum >= \" & datumSQL(DatVon) & \" AND VADatum <= \" & datumSQL(DatBis)), 0)\n    sql = \"SELECT * FROM [\" & ZUORDNUNG & \"] WHERE MA_ID = \" & MA_ID & \" AND VADatum >= \" & datumSQL(DatVon) & \" AND VADatum <= \" & datumSQL(DatBis)\n    Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n    Do While Not rs.EOF\n        'AnzStunden = AnzStunden + Stunden(rs.Fields(\"MA_Start\"), rs.Fields(\"MA_Ende\"))\n        AnzStunden = AnzStunden + rs.fields(\"MA_Netto_Std2\")\n        rs.MoveNext\n    Loop 'Until rs.EOF\n    rs.Close\n    Set rs = Nothing\n    'Stunden Netto!\n    If AnzATage <> 0 Then ArbStundenProTag = Nz(Round(AnzStunden / AnzATage, 2), 0) '* 0.91\n     \n    'Schritt 3: Ermittlung aus Vorjahr, wenn Wert zu gering\n    If ArbStundenProTag < 2 Then\n        'letzter Tag des letzten Jahres\n        DatBis = \"31.12.\" & year(Date) - 1\n        'erster Tag des letzten Jahres\n        DatVon = \"01.01.\" & year(Date) - 1\n        \n        AnzATage = Nz(TCount(\"VADatum\", ZUORDNUNG, \"MA_ID =\" & MA_ID & \" AND VADatum >= \" & datumSQL(DatVon) & \" AND VADatum <= \" & datumSQL(DatBis)), 0)\n        sql = \"SELECT * FROM [\" & ZUORDNUNG & \"] WHERE MA_ID = \" & MA_ID & \" AND VADatum >= \" & datumSQL(DatVon) & \" AND VADatum <= \" & datumSQL(DatBis)\n        Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n        Do While Not rs.EOF\n            'AnzStunden = AnzStunden + Stunden(rs.Fields(\"MA_Start\"), rs.Fields(\"MA_Ende\"))\n            AnzStunden = AnzStunden + rs.fields(\"MA_Netto_Std2\")\n            rs.MoveNext\n        Loop\n        rs.Close\n        Set rs = Nothing\n        'Stunden Netto!\n        If Not IsInitial(AnzStunden) And Not IsInitial(AnzATage) Then\n            ArbStundenProTag = Nz(Round(AnzStunden / AnzATage, 2), 0) '* 0.91\n        End If\n    End If\nEnd Function\n\n\n'Gesamten Monat für das Zeitkonto erzeugen\nFunction create_Tage_Zeitraum(ByVal MA_ID As Long, ByVal Jahr As Integer, ByVal Monat As Integer, Optional ByVal append As Boolean)\n\nDim anzTage     As Integer\nDim ErsterTag   As Date\nDim tbl         As String\nDim i           As Integer\nDim rs          As Recordset\n\n    tbl = \"ztbl_ZK_Tage_Zeitraum\"\n    ErsterTag = CDate(\"01.\" & Monat & \".\" & Jahr)\n    anzTage = DateDiff(\"d\", ErsterTag, DateSerial(year(ErsterTag), Month(ErsterTag) + 1, 1))\n    \n    If append = False Then CurrentDb.Execute \"DELETE * FROM \" & tbl\n    Set rs = CurrentDb.OpenRecordset(tbl)\n\n    For i = 0 To anzTage - 1\n        rs.AddNew\n        rs.fields(\"ZK_MA_ID\") = MA_ID\n        rs.fields(\"ZKDatum\") = ErsterTag + i\n        rs.update\n    Next i\n\nEnd Function\n\n\n'Wochentag kurz für Zeitkonto\nFunction weekday_short(ByVal Datum As Date) As String\n\nDim tag_zahl As Integer\n\n    tag_zahl = Weekday(Datum)\n    Select Case tag_zahl\n        Case 1\n            weekday_short = \"So\"\n        Case 2\n            weekday_short = \"Mo\"\n        Case 3\n            weekday_short = \"Di\"\n        Case 4\n            weekday_short = \"Mi\"\n        Case 5\n            weekday_short = \"Do\"\n        Case 6\n            weekday_short = \"Fr\"\n        Case 7\n            weekday_short = \"Sa\"\n    End Select\n    \nEnd Function\n\n\n'Lohnart prüfen und ggf. anpassen\nFunction pruefeLohnart(MA_ID As Long, Lohnart_ID As Long, Lohnartnummer As String) As String\n\nDim Lohnart_ID_MA As Long\nDim Lohnartnr_MA  As String\n\n    Select Case Lohnart_ID\n        'Korrekturen\n        Case 54, 55, 56\n            Lohnart_ID_MA = Nz(TLookup(\"Stundenlohn_brutto\", MASTAMM, \"ID =\" & MA_ID), 0)\n            If Not IsInitial(Lohnart_ID_MA) Then\n                Lohnartnr_MA = TLookup(\"Nummer\", LOHNARTEN, \"ID = \" & Lohnart_ID_MA)\n            Else\n                Lohnartnr_MA = 0\n            End If\n            pruefeLohnart = Lohnartnr_MA\n            \n        '\"Normalfall\"\n        Case Else\n            pruefeLohnart = Lohnartnummer\n            \n    End Select\n\nEnd Function"}
