{"id":"MOD_mod_N_Loewensaal_HP","name":"mod_N_Loewensaal_HP","kind":"standard","procedures":["Private Function DatumFuerSQL(ByVal Datum As Date) As String","Private Function DatumZeitFuerSQL(ByVal datumZeit As Date) As String","Public Sub SyncLoewensaalEventsFromHomepage()","Private Function EventExistsInDatabase(eventDatum As Date, _","Private Function CreateAuftragMitSchichten(ByVal eventDatum As Date, _","Private Sub KorrigiereAuftragBooleans(ByVal AuftragsID As Long)","Private Sub SetzeAllePflichtfelder(ByVal AuftragsID As Long, _","Private Sub ErstelleSchichtenFuerLocation(ByVal AuftragsID As Long, _","Private Sub SchichtEintragErstellen(ByVal AuftragsID As Long, _","Private Function LoadEventsFromHomepage(websiteURL As String, minDatum As Date) As EventInfo()","Private Function DownloadHTML(url As String) As String","Private Function ParseEventsFromHTML(htmlContent As String, ByRef allEvents() As EventInfo, minDatum As Date) As Integer","Private Function CleanLocationString(locationStr As String) As String","Private Function FindNextDatePosition(html As String, startPos As Long) As Long","Private Function ExtractDateFromBlock(blockText As String) As String","Private Function ExtractTitleFromBlock(blockText As String) As String","Private Function IsAllCaps(Text As String) As Boolean","Private Function ExtractLocationFromBlock(blockText As String) As String","Private Function ExtractCityFromBlock(blockText As String) As String","Private Function ExtractEinlasszeitFromBlock(blockText As String) As String","Private Function ParseEinlasszeit(zeitStr As String, eventDate As Date) As Date","Private Function RemoveHTMLTags(html As String) As String","Private Sub SaveHTMLForDebug(htmlContent As String)","Private Function IsRelevantLocation(Objekt As String) As Boolean","Private Function ToTitleCase(Text As String) As String","Private Function Nz(Value As Variant, Optional valueIfNull As Variant = \"\") As Variant","Public Sub DiagnoseHomepageImport()"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"'Attribute VB_Name = \"mod_N_Loewensaal_HP\"\nOption Compare Database\nOption Explicit\n\n' ============================================================================\n' Modul: mod_N_Loewensaal_HP\n' Version: 5.1 - DATUMSFORMAT KORRIGIERT\n' ============================================================================\n' ÄNDERUNGEN V5.1:\n' - KRITISCHER FIX: Datumsformat für SQL korrigiert (mm/dd/yyyy)\n' - DatumFuerSQL() Hilfsfunktion für garantiert korrekte Datumsformatierung\n' - Garantiert Sichtbarkeit in qry_lst_Row_Auftrag\n' ============================================================================\n' VORHERIGE ÄNDERUNGEN V5.0:\n' - Garantiert korrekte tbl_VA_AnzTage Erstellung (TVA_Soll = 1)\n' - Ort-Feld wird IMMER korrekt gefüllt\n' - Erweiterte Location-Liste (12 Orte)\n' - Verbesserte Query-Sichtbarkeit\n' - Direkt-Import ohne Formular\n' - Korrigierte HTML-Parsing-Logik\n' ============================================================================\n\nPrivate Const WEBSITE_URL As String = \"https://www.concertbuero-franken.de/\"\nPrivate Const TREFFPUNKT_DEFAULT As String = \"15 min vor DB vor Ort\"\nPrivate Const DIENSTKLEIDUNG_DEFAULT As String = \"Consec\"\nPrivate Const VERANSTALTER_ID_DEFAULT As Long = 10233\n\n' ERWEITERTE LOCATION-LISTE (12 ORTE)\nPrivate Const RELEVANT_LOCATIONS As String = \"Löwensaal|Loewensaal|Meistersingerhalle|Markgrafensaal|Stadthalle|\" & _\n                                             \"Heinrich-Lades-Halle|Lux-Kirche|KIA Metropol Arena|\" & _\n                                             \"PSB Bank Arena|Donau-Arena|Brose Arena|Stadionpark\"\n\nPublic Type EventInfo\n    Datum As Date\n    DatumStr As String\n    titel As String\n    Ort As String\n    Objekt As String\n    VeranstalterID As Long\n    ExistiertInDB As Boolean\n    SheetQuelle As String\n    Treffpunkt As String\n    einlasszeit As Date\n    EinlasszeitStr As String\nEnd Type\n\nPrivate Type SchichtInfo\n    AnzahlMA As Integer\n    MinutenVorEinlass As Integer\n    FixeStartzeit As String\nEnd Type\n\n' ================================================================================================\n' HILFSFUNKTION: Konvertiert Datum für Access SQL (MM/DD/YYYY)\n' ================================================================================================\nPrivate Function DatumFuerSQL(ByVal Datum As Date) As String\n    DatumFuerSQL = Month(Datum) & \"/\" & Day(Datum) & \"/\" & year(Datum)\nEnd Function\n\nPrivate Function DatumZeitFuerSQL(ByVal datumZeit As Date) As String\n    DatumZeitFuerSQL = Month(datumZeit) & \"/\" & Day(datumZeit) & \"/\" & year(datumZeit) & _\n                       \" \" & Format(datumZeit, \"hh:nn:ss\")\nEnd Function\n\n' ============================================================================\n' HAUPTFUNKTION - DIREKT-IMPORT VON HOMEPAGE\n' ============================================================================\nPublic Sub SyncLoewensaalEventsFromHomepage()\n    On Error GoTo ErrorHandler\n    \n    Dim allEvents() As EventInfo\n    Dim eventCount As Integer\n    Dim newCount As Integer\n    Dim i As Integer\n    Dim heutesDatum As Date\n    \n    heutesDatum = Date\n    \n    DoCmd.Hourglass True\n    Debug.Print String(80, \"=\")\n    Debug.Print \"=== Homepage-Import (DIREKT) gestartet ===\"\n    Debug.Print \"Zeitpunkt: \" & Format(Now(), \"dd.mm.yyyy hh:nn:ss\")\n    Debug.Print \"Filter: Ab \" & Format(heutesDatum, \"dd.mm.yyyy\")\n    Debug.Print \"Locations: \" & Replace(RELEVANT_LOCATIONS, \"|\", \", \")\n    Debug.Print \"Import-Modus: DIREKT (ohne Benutzerauswahl)\"\n    Debug.Print String(80, \"=\")\n    \n    ' *** SCHRITT 1: EVENTS VON WEBSITE LADEN ***\n    Debug.Print vbCrLf & \">>> Schritt 1/4: Lade Events von Homepage...\"\n    allEvents = LoadEventsFromHomepage(WEBSITE_URL, heutesDatum)\n    eventCount = UBound(allEvents) - LBound(allEvents) + 1\n    \n    If eventCount = 0 Or (eventCount = 1 And Len(Trim(allEvents(0).titel)) = 0) Then\n        DoCmd.Hourglass False\n        \n        MsgBox \"Keine relevanten Events auf der Homepage gefunden.\" & vbCrLf & vbCrLf & _\n               \"Website: \" & WEBSITE_URL & vbCrLf & _\n               \"Locations: \" & Replace(RELEVANT_LOCATIONS, \"|\", \", \"), _\n               vbExclamation, \"Kein Import\"\n        \n        Debug.Print \"!!! Keine Events gefunden\"\n        Exit Sub\n    End If\n    \n    Debug.Print \"? Gefunden: \" & eventCount & \" Events\"\n    \n    ' *** SCHRITT 2: DATENBANK-ABGLEICH ***\n    Debug.Print vbCrLf & \">>> Schritt 2/4: Prüfe Datenbank-Status...\"\n    \n    newCount = 0\n    For i = LBound(allEvents) To UBound(allEvents)\n        Debug.Print \"  [\" & i & \"] Prüfe: \" & allEvents(i).titel & \" | \" & _\n                   allEvents(i).Objekt & \" | \" & allEvents(i).DatumStr\n        \n        allEvents(i).ExistiertInDB = EventExistsInDatabase( _\n            allEvents(i).Datum, allEvents(i).titel, allEvents(i).Objekt)\n        \n        If allEvents(i).ExistiertInDB Then\n            Debug.Print \"      ? Bereits in DB vorhanden\"\n        Else\n            Debug.Print \"      ? NEU - wird importiert\"\n            newCount = newCount + 1\n        End If\n    Next i\n    \n    Debug.Print vbCrLf & \">>> Ergebnis: \" & newCount & \" neue Events | \" & _\n                (eventCount - newCount) & \" bereits vorhanden\"\n    \n    ' *** SCHRITT 3: PRÜFUNG OB NEUE EVENTS VORHANDEN ***\n    If newCount = 0 Then\n        DoCmd.Hourglass False\n        MsgBox \"Alle Events von der Homepage sind bereits in der Datenbank vorhanden.\" & vbCrLf & vbCrLf & _\n               \"Geprüfte Events: \" & eventCount, _\n               vbInformation, \"Kein Import erforderlich\"\n        Debug.Print \"? Kein Import erforderlich - alle Events vorhanden\"\n        Exit Sub\n    End If\n    \n    ' *** SCHRITT 4: NEUE EVENTS DIREKT ANLEGEN ***\n    Debug.Print vbCrLf & \">>> Schritt 3/4: Erstelle neue Events...\"\n    \n    Dim successCount As Integer\n    Dim errorCount As Integer\n    Dim successDetails As String\n    Dim errorDetails As String\n    Dim createdIDs As String\n    \n    successCount = 0\n    errorCount = 0\n    successDetails = \"\"\n    errorDetails = \"\"\n    createdIDs = \"\"\n    \n    ' Durch alle Events iterieren und neue anlegen\n    For i = LBound(allEvents) To UBound(allEvents)\n        If Not allEvents(i).ExistiertInDB Then\n            \n            Debug.Print vbCrLf & \"  [\" & i & \"] Erstelle: \" & allEvents(i).titel\n            \n            ' *** WICHTIG: ORT-FELD VALIDIERUNG ***\n            If Len(Trim(allEvents(i).Ort)) = 0 Then\n                allEvents(i).Ort = \"Nürnberg\"\n                Debug.Print \"      ? Ort-Feld leer - setze Standard: Nürnberg\"\n            End If\n            \n            Dim ergebnis As String\n            ergebnis = CreateAuftragMitSchichten( _\n                allEvents(i).Datum, _\n                allEvents(i).titel, _\n                allEvents(i).Objekt, _\n                allEvents(i).Ort, _\n                TREFFPUNKT_DEFAULT, _\n                allEvents(i).einlasszeit)\n            \n            If Left(ergebnis, 7) = \"SUCCESS\" Then\n                successCount = successCount + 1\n                \n                Dim teile() As String\n                teile = Split(ergebnis, \"|\")\n                Dim AuftragsID As String\n                If UBound(teile) >= 1 Then\n                    AuftragsID = teile(1)\n                    createdIDs = createdIDs & AuftragsID & \",\"\n                Else\n                    AuftragsID = \"?\"\n                End If\n                \n                successDetails = successDetails & \"• ID \" & AuftragsID & \": \" & _\n                                Format(allEvents(i).Datum, \"dd.mm.yyyy\") & \" - \" & _\n                                Left(allEvents(i).titel, 40) & \" (\" & _\n                                allEvents(i).Objekt & \")\" & vbCrLf\n                \n                Debug.Print \"      ? Erfolgreich erstellt (ID: \" & AuftragsID & \")\"\n            Else\n                errorCount = errorCount + 1\n                errorDetails = errorDetails & \"• \" & allEvents(i).titel & \": \" & _\n                              Right(ergebnis, Len(ergebnis) - 7) & vbCrLf\n                Debug.Print \"      ? FEHLER: \" & ergebnis\n            End If\n        End If\n    Next i\n    \n    DoCmd.Hourglass False\n    \n    ' *** SCHRITT 5: ZUSAMMENFASSUNG ***\n    Debug.Print vbCrLf & String(80, \"=\")\n    Debug.Print \"=== Homepage-Import abgeschlossen ===\"\n    Debug.Print \"Erfolgreich: \" & successCount & \" | Fehler: \" & errorCount\n    Debug.Print String(80, \"=\")\n    \n    ' Benutzer-Meldung\n    If errorCount = 0 Then\n        MsgBox \"? Homepage-Import erfolgreich abgeschlossen!\" & vbCrLf & vbCrLf & _\n               \"Neue Events angelegt: \" & successCount & vbCrLf & vbCrLf & _\n               successDetails & vbCrLf & _\n               \"Details im Debug-Fenster (Strg+G)\", _\n               vbInformation, \"Import erfolgreich\"\n    Else\n        MsgBox \"? Import teilweise erfolgreich!\" & vbCrLf & vbCrLf & _\n               \"Erfolgreich: \" & successCount & vbCrLf & _\n               \"Fehler: \" & errorCount & vbCrLf & vbCrLf & _\n               \"ERFOLGREICH:\" & vbCrLf & successDetails & vbCrLf & _\n               \"FEHLER:\" & vbCrLf & errorDetails, _\n               vbExclamation, \"Import mit Fehlern\"\n    End If\n    \n    Exit Sub\n    \nErrorHandler:\n    DoCmd.Hourglass False\n    MsgBox \"Kritischer Fehler beim Homepage-Import:\" & vbCrLf & vbCrLf & _\n           \"Fehler-Nr: \" & err.Number & vbCrLf & _\n           \"Beschreibung: \" & err.description, vbCritical, \"Fehler\"\n    Debug.Print \"!!! KRITISCHER FEHLER: \" & err.Number & \" - \" & err.description\nEnd Sub\n\n' ============================================================================\n' Prüft ob Event in DB existiert - DATUMSFORMAT KORRIGIERT\n' ============================================================================\nPrivate Function EventExistsInDatabase(eventDatum As Date, _\n                                       eventTitel As String, _\n                                       eventObjekt As String) As Boolean\n    On Error Resume Next\n    \n    Dim rs As DAO.Recordset\n    Dim sql As String\n    Dim DatumVon As String\n    Dim DatumBis As String\n    \n    ' KORRIGIERT: Datum-Bereich mit DatumFuerSQL()\n    DatumVon = DatumFuerSQL(DateAdd(\"d\", -1, eventDatum))\n    DatumBis = DatumFuerSQL(DateAdd(\"d\", 1, eventDatum))\n    \n    ' Titel und Objekt für SQL bereinigen\n    eventTitel = Replace(eventTitel, \"'\", \"''\")\n    eventObjekt = Replace(eventObjekt, \"'\", \"''\")\n    \n    sql = \"SELECT COUNT(*) AS Anzahl FROM tbl_VA_Auftragstamm \" & _\n          \"WHERE Auftrag LIKE '%\" & eventTitel & \"%' \" & _\n          \"AND Objekt LIKE '%\" & eventObjekt & \"%' \" & _\n          \"AND Dat_VA_Von >= #\" & DatumVon & \"# \" & _\n          \"AND Dat_VA_Von <= #\" & DatumBis & \"#\"\n    \n    Set rs = CurrentDb.OpenRecordset(sql)\n    \n    If Not rs.EOF Then\n        EventExistsInDatabase = (rs!Anzahl > 0)\n    Else\n        EventExistsInDatabase = False\n    End If\n    \n    rs.Close\n    Set rs = Nothing\nEnd Function\n\n' ============================================================================\n' Erstellt Auftrag mit Schichten - KORRIGIERT\n' ============================================================================\nPrivate Function CreateAuftragMitSchichten(ByVal eventDatum As Date, _\n                                           ByVal eventTitel As String, _\n                                           ByVal eventObjekt As String, _\n                                           ByVal eventOrt As String, _\n                                           ByVal eventTreffpunkt As String, _\n                                           ByVal eventEinlasszeit As Date) As String\n    On Error GoTo ErrorHandler\n    \n    Dim titelFormatiert As String\n    Dim objektFormatiert As String\n    Dim ortFormatiert As String\n    \n    titelFormatiert = ToTitleCase(eventTitel)\n    objektFormatiert = ToTitleCase(eventObjekt)\n    ortFormatiert = ToTitleCase(eventOrt)\n    \n    ' *** WICHTIG: ORT DARF NICHT LEER SEIN ***\n    If Len(Trim(ortFormatiert)) = 0 Then\n        ortFormatiert = \"Nürnberg\"\n        Debug.Print \"      ? Ort-Feld war leer - setze Standard: Nürnberg\"\n    End If\n    \n    Debug.Print \"      ? Erstelle Auftrag: \" & titelFormatiert & \" | \" & objektFormatiert & \" | \" & ortFormatiert\n    \n    Dim ergebnis As String\n    ergebnis = AuftragErstellen( _\n        auftragsName:=titelFormatiert, _\n        objektName:=objektFormatiert, _\n        ortName:=ortFormatiert, _\n        DatumVon:=eventDatum, _\n        DatumBis:=eventDatum, _\n        auftraggeber:=\"\", _\n        Treffpunkt:=eventTreffpunkt, _\n        schichten:=\"\", _\n        statusID:=1, _\n        Ersteller:=\"Homepage-Import\" _\n    )\n    \n    If Left(ergebnis, 7) = \"SUCCESS\" Then\n        Dim AuftragsID As Long\n        AuftragsID = CLng(Split(ergebnis, \"|\")(1))\n        \n        Debug.Print \"      ? Setze Pflichtfelder...\"\n        Call SetzeAllePflichtfelder(AuftragsID, eventDatum, ortFormatiert)\n        \n        Debug.Print \"      ? Erstelle Schichten...\"\n        Call ErstelleSchichtenFuerLocation(AuftragsID, eventDatum, objektFormatiert, eventEinlasszeit)\n        \n        Debug.Print \"      ? Aktiviere Boolean-Felder...\"\n        Call KorrigiereAuftragBooleans(AuftragsID)\n        \n        Debug.Print \"      ? Auftrag komplett erstellt (ID: \" & AuftragsID & \")\"\n    End If\n    \n    CreateAuftragMitSchichten = ergebnis\n    Exit Function\n    \nErrorHandler:\n    CreateAuftragMitSchichten = \"FEHLER: \" & err.description\n    Debug.Print \"      ? Fehler: \" & err.description\nEnd Function\n\n' ============================================================================\n' Aktiviert Boolean-Felder eines Auftrags\n' ============================================================================\nPrivate Sub KorrigiereAuftragBooleans(ByVal AuftragsID As Long)\n    On Error Resume Next\n    \n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT * FROM tbl_VA_Auftragstamm WHERE ID = \" & AuftragsID, dbOpenDynaset)\n    \n    If Not rs.EOF Then\n        Dim i As Integer\n        Dim hatUpdate As Boolean\n        hatUpdate = False\n        \n        For i = 0 To rs.fields.Count - 1\n            If rs.fields(i).Type = dbBoolean Then\n                If Not hatUpdate Then\n                    rs.Edit\n                    hatUpdate = True\n                End If\n                rs.fields(i).Value = True\n            End If\n        Next i\n        \n        If hatUpdate Then\n            rs.update\n            Debug.Print \"        ? \" & i & \" Boolean-Felder aktiviert\"\n        End If\n    End If\n    \n    rs.Close\n    Set rs = Nothing\nEnd Sub\n\n' ============================================================================\n' Setzt Pflichtfelder - DATUMSFORMAT KORRIGIERT\n' ============================================================================\nPrivate Sub SetzeAllePflichtfelder(ByVal AuftragsID As Long, _\n                                    ByVal eventDatum As Date, _\n                                    ByVal ortName As String)\n    On Error Resume Next\n    \n    ' *** WICHTIG: ORT-VALIDIERUNG ***\n    If Len(Trim(ortName)) = 0 Then\n        ortName = \"Nürnberg\"\n        Debug.Print \"        ? Ort-Feld leer - setze Standard: Nürnberg\"\n    End If\n    \n    Dim sql As String\n    sql = \"UPDATE tbl_VA_Auftragstamm SET \" & _\n          \"Veranstalter_ID = \" & VERANSTALTER_ID_DEFAULT & \", \" & _\n          \"Veranst_Status_ID = 1, \" & _\n          \"Erst_am = Now(), \" & _\n          \"Erst_von = '\" & Environ(\"USERNAME\") & \"', \" & _\n          \"Dienstkleidung = '\" & DIENSTKLEIDUNG_DEFAULT & \"', \" & _\n          \"Ort = '\" & Replace(ortName, \"'\", \"''\") & \"' \" & _\n          \"WHERE ID = \" & AuftragsID\n    \n    CurrentDb.Execute sql\n    Debug.Print \"        ? Pflichtfelder gesetzt (inkl. Ort: \" & ortName & \")\"\n    \n    ' *** KRITISCH: Prüfe ob tbl_VA_AnzTage existiert - WENN NICHT, ERSTELLEN! ***\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT COUNT(*) AS Anzahl FROM tbl_VA_AnzTage WHERE VA_ID = \" & AuftragsID)\n    \n    If rs!Anzahl = 0 Then\n        ' KORRIGIERT: Verwende DatumFuerSQL()\n        sql = \"INSERT INTO tbl_VA_AnzTage (VA_ID, VADatum, TVA_Soll, TVA_Ist) \" & _\n              \"VALUES (\" & AuftragsID & \", #\" & DatumFuerSQL(eventDatum) & \"#, 1, 0)\"\n        CurrentDb.Execute sql\n        Debug.Print \"        ? AnzTage-Eintrag erstellt (TVA_Soll = 1)\"\n    Else\n        ' Prüfe ob TVA_Soll gesetzt ist\n        rs.Close\n        Set rs = CurrentDb.OpenRecordset( _\n            \"SELECT TVA_Soll FROM tbl_VA_AnzTage WHERE VA_ID = \" & AuftragsID)\n        \n        If Not rs.EOF Then\n            If Nz(rs!TVA_Soll, 0) = 0 Then\n                ' Korrigiere TVA_Soll\n                sql = \"UPDATE tbl_VA_AnzTage SET TVA_Soll = 1 WHERE VA_ID = \" & AuftragsID\n                CurrentDb.Execute sql\n                Debug.Print \"        ? TVA_Soll korrigiert auf 1\"\n            Else\n                Debug.Print \"        ? AnzTage-Eintrag bereits vorhanden und korrekt\"\n            End If\n        End If\n    End If\n    \n    rs.Close\n    Set rs = Nothing\nEnd Sub\n\n' ============================================================================\n' Erstellt Schichten - ERWEITERT MIT ALLEN 12 LOCATIONS\n' ============================================================================\nPrivate Sub ErstelleSchichtenFuerLocation(ByVal AuftragsID As Long, _\n                                          ByVal eventDatum As Date, _\n                                          ByVal location As String, _\n                                          ByVal einlasszeit As Date)\n    On Error GoTo ErrorHandler\n    \n    Dim schichten() As SchichtInfo\n    Dim locationUpper As String\n    Dim schichtCount As Integer\n    \n    locationUpper = UCase(Trim(location))\n    \n    ' LÖWENSAAL / LOEWENSAAL\n    If InStr(locationUpper, \"LÖWENSAAL\") > 0 Or InStr(locationUpper, \"LOEWENSAAL\") > 0 Then\n        ReDim schichten(0 To 2)\n        schichten(0).AnzahlMA = 11\n        schichten(0).MinutenVorEinlass = 30\n        schichten(1).AnzahlMA = 1\n        schichten(1).MinutenVorEinlass = 60\n        schichten(2).AnzahlMA = 1\n        schichten(2).MinutenVorEinlass = 90\n        schichtCount = 3\n        \n    ' MEISTERSINGERHALLE\n    ElseIf InStr(locationUpper, \"MEISTERSINGERHALLE\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 2\n        schichten(0).MinutenVorEinlass = 30\n        schichtCount = 1\n        \n    ' MARKGRAFENSAAL\n    ElseIf InStr(locationUpper, \"MARKGRAFENSAAL\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 2\n        schichten(0).MinutenVorEinlass = 30\n        schichtCount = 1\n        \n    ' STADTHALLE\n    ElseIf InStr(locationUpper, \"STADTHALLE\") > 0 Then\n        ReDim schichten(0 To 2)\n        schichten(0).AnzahlMA = 15\n        schichten(0).MinutenVorEinlass = 30\n        schichten(1).AnzahlMA = 1\n        schichten(1).MinutenVorEinlass = 0\n        schichten(1).FixeStartzeit = \"09:00\"\n        schichten(2).AnzahlMA = 1\n        schichten(2).MinutenVorEinlass = 60\n        schichtCount = 3\n        \n    ' HEINRICH-LADES-HALLE\n    ElseIf InStr(locationUpper, \"HEINRICH-LADES-HALLE\") > 0 Or InStr(locationUpper, \"LADES-HALLE\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 3\n        schichten(0).MinutenVorEinlass = 30\n        schichtCount = 1\n        \n    ' LUX-KIRCHE\n    ElseIf InStr(locationUpper, \"LUX-KIRCHE\") > 0 Or InStr(locationUpper, \"LUXKIRCHE\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 2\n        schichten(0).MinutenVorEinlass = 30\n        schichtCount = 1\n        \n    ' KIA METROPOL ARENA\n    ElseIf InStr(locationUpper, \"KIA METROPOL\") > 0 Or InStr(locationUpper, \"METROPOL ARENA\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 20\n        schichten(0).MinutenVorEinlass = 45\n        schichtCount = 1\n        \n    ' PSB BANK ARENA\n    ElseIf InStr(locationUpper, \"PSB BANK\") > 0 Or InStr(locationUpper, \"PSB-ARENA\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 15\n        schichten(0).MinutenVorEinlass = 45\n        schichtCount = 1\n        \n    ' DONAU-ARENA\n    ElseIf InStr(locationUpper, \"DONAU-ARENA\") > 0 Or InStr(locationUpper, \"DONAUARENA\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 12\n        schichten(0).MinutenVorEinlass = 45\n        schichtCount = 1\n        \n    ' BROSE ARENA\n    ElseIf InStr(locationUpper, \"BROSE ARENA\") > 0 Or InStr(locationUpper, \"BROSE-ARENA\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 15\n        schichten(0).MinutenVorEinlass = 45\n        schichtCount = 1\n        \n    ' STADIONPARK\n    ElseIf InStr(locationUpper, \"STADIONPARK\") > 0 Then\n        ReDim schichten(0 To 0)\n        schichten(0).AnzahlMA = 5\n        schichten(0).MinutenVorEinlass = 30\n        schichtCount = 1\n        \n    Else\n        Debug.Print \"        ? Keine Schichten-Vorlage für: \" & location\n        Exit Sub\n    End If\n    \n    Debug.Print \"        ? \" & schichtCount & \" Schicht-Typen für: \" & location\n    \n    Dim i As Integer\n    Dim j As Integer\n    Dim startzeit As Date\n    Dim endzeit As Date\n    \n    endzeit = DateSerial(year(eventDatum), Month(eventDatum), Day(eventDatum)) + TimeSerial(23, 30, 0)\n    \n    For i = 0 To schichtCount - 1\n        If Len(schichten(i).FixeStartzeit) > 0 Then\n            startzeit = DateSerial(year(eventDatum), Month(eventDatum), Day(eventDatum)) + _\n                       TimeSerial(val(Left(schichten(i).FixeStartzeit, 2)), _\n                                 val(Right(schichten(i).FixeStartzeit, 2)), 0)\n        Else\n            startzeit = DateAdd(\"n\", -schichten(i).MinutenVorEinlass, einlasszeit)\n        End If\n        \n        For j = 1 To schichten(i).AnzahlMA\n            Call SchichtEintragErstellen(AuftragsID, eventDatum, startzeit, endzeit)\n        Next j\n        \n        Debug.Print \"          ? \" & schichten(i).AnzahlMA & \" MA: \" & _\n                   Format(startzeit, \"hh:nn\") & \"-\" & Format(endzeit, \"hh:nn\")\n    Next i\n    \n    Exit Sub\n    \nErrorHandler:\n    Debug.Print \"        ? Schicht-Fehler: \" & err.description\nEnd Sub\n\n' ============================================================================\n' Erstellt Schicht-Eintrag - DATUMSFORMAT KORRIGIERT\n' ============================================================================\nPrivate Sub SchichtEintragErstellen(ByVal AuftragsID As Long, _\n                                    ByVal eventDatum As Date, _\n                                    ByVal startzeit As Date, _\n                                    ByVal endzeit As Date)\n    On Error Resume Next\n    \n    ' KORRIGIERT: Verwende DatumFuerSQL() und DatumZeitFuerSQL()\n    Dim sql As String\n    sql = \"INSERT INTO tbl_VA_AnzTage (VA_ID, VADatum, VAbeginn, VAende, TVA_Soll, TVA_Ist) \" & _\n          \"VALUES (\" & AuftragsID & \", \" & _\n          \"#\" & DatumFuerSQL(eventDatum) & \"#, \" & _\n          \"#\" & DatumZeitFuerSQL(startzeit) & \"#, \" & _\n          \"#\" & DatumZeitFuerSQL(endzeit) & \"#, 1, 0)\"\n    \n    CurrentDb.Execute sql\nEnd Sub\n\n' ============================================================================\n' HTML-Funktionen\n' ============================================================================\nPrivate Function LoadEventsFromHomepage(websiteURL As String, minDatum As Date) As EventInfo()\n    On Error GoTo ErrorHandler\n    \n    Dim htmlContent As String\n    Dim allEvents() As EventInfo\n    Dim totalCount As Integer\n    \n    htmlContent = DownloadHTML(websiteURL)\n    \n    If Len(htmlContent) = 0 Then\n        ReDim allEvents(0 To 0)\n        allEvents(0).titel = \"\"\n        LoadEventsFromHomepage = allEvents\n        Exit Function\n    End If\n    \n    Call SaveHTMLForDebug(htmlContent)\n    \n    ReDim allEvents(0 To 999)\n    totalCount = ParseEventsFromHTML(htmlContent, allEvents, minDatum)\n    \n    If totalCount > 0 Then\n        ReDim Preserve allEvents(0 To totalCount - 1)\n    Else\n        ReDim allEvents(0 To 0)\n        allEvents(0).titel = \"\"\n    End If\n    \n    LoadEventsFromHomepage = allEvents\n    Exit Function\n    \nErrorHandler:\n    ReDim allEvents(0 To 0)\n    allEvents(0).titel = \"\"\n    LoadEventsFromHomepage = allEvents\nEnd Function\n\nPrivate Function DownloadHTML(url As String) As String\n    On Error GoTo ErrorHandler\n    \n    Dim http As Object\n    Set http = CreateObject(\"MSXML2.XMLHTTP\")\n    \n    http.Open \"GET\", url, False\n    http.setRequestHeader \"User-Agent\", \"Mozilla/5.0\"\n    http.Send\n    \n    If http.Status = 200 Then\n        DownloadHTML = http.responseText\n    Else\n        DownloadHTML = \"\"\n    End If\n    \n    Set http = Nothing\n    Exit Function\n    \nErrorHandler:\n    DownloadHTML = \"\"\nEnd Function\n\nPrivate Function ParseEventsFromHTML(htmlContent As String, ByRef allEvents() As EventInfo, minDatum As Date) As Integer\n    On Error GoTo ErrorHandler\n    \n    Debug.Print \"  ? Parse HTML (Regex-basiert)...\"\n    \n    Dim currentIndex As Integer\n    Dim pos As Long\n    Dim searchPos As Long\n    Dim blockText As String\n    Dim eventDate As Date\n    Dim titleStr As String\n    Dim locationStr As String\n    Dim cityStr As String\n    Dim einlassStr As String\n    Dim eventEinlass As Date\n    \n    currentIndex = 0\n    searchPos = 1\n    \n    Do While searchPos < Len(htmlContent)\n        pos = FindNextDatePosition(htmlContent, searchPos)\n        \n        If pos = 0 Then Exit Do\n        \n        Dim blockStart As Long\n        Dim blockEnd As Long\n        blockStart = IIf(pos - 500 > 0, pos - 500, 1)\n        blockEnd = IIf(pos + 500 < Len(htmlContent), pos + 500, Len(htmlContent))\n        blockText = Mid(htmlContent, blockStart, blockEnd - blockStart)\n        \n        Dim dateStr As String\n        dateStr = ExtractDateFromBlock(blockText)\n        \n        If Len(dateStr) > 0 And IsDate(dateStr) Then\n            eventDate = CDate(dateStr)\n            \n            If eventDate >= minDatum And eventDate < #1/1/2100# Then\n                \n                titleStr = ExtractTitleFromBlock(blockText)\n                locationStr = ExtractLocationFromBlock(blockText)\n                cityStr = ExtractCityFromBlock(blockText)\n                einlassStr = ExtractEinlasszeitFromBlock(blockText)\n                \n                locationStr = CleanLocationString(locationStr)\n                cityStr = CleanLocationString(cityStr)\n                \n                ' *** ORT-VALIDIERUNG ***\n                If Len(Trim(cityStr)) = 0 Then\n                    cityStr = \"Nürnberg\"\n                End If\n                \n                If Len(einlassStr) > 0 Then\n                    eventEinlass = ParseEinlasszeit(einlassStr, eventDate)\n                Else\n                    eventEinlass = DateSerial(year(eventDate), Month(eventDate), Day(eventDate)) + TimeSerial(19, 0, 0)\n                End If\n                \n                If Len(titleStr) > 0 And Len(locationStr) > 0 And IsRelevantLocation(locationStr) Then\n                    \n                    allEvents(currentIndex).Datum = eventDate\n                    allEvents(currentIndex).DatumStr = Format(eventDate, \"dd.mm.yyyy\")\n                    allEvents(currentIndex).titel = Trim(titleStr)\n                    allEvents(currentIndex).Ort = cityStr\n                    allEvents(currentIndex).Objekt = Trim(locationStr)\n                    allEvents(currentIndex).VeranstalterID = VERANSTALTER_ID_DEFAULT\n                    allEvents(currentIndex).ExistiertInDB = False\n                    allEvents(currentIndex).SheetQuelle = \"Homepage\"\n                    allEvents(currentIndex).Treffpunkt = TREFFPUNKT_DEFAULT\n                    allEvents(currentIndex).einlasszeit = eventEinlass\n                    allEvents(currentIndex).EinlasszeitStr = Format(eventEinlass, \"hh:nn\")\n                    \n                    Debug.Print \"    [\" & currentIndex & \"] \" & allEvents(currentIndex).DatumStr & \" | \" & _\n                               allEvents(currentIndex).titel & \" | \" & allEvents(currentIndex).Objekt & _\n                               \" | \" & allEvents(currentIndex).Ort\n                    \n                    currentIndex = currentIndex + 1\n                    \n                    If currentIndex > UBound(allEvents) Then\n                        ReDim Preserve allEvents(0 To UBound(allEvents) + 100)\n                    End If\n                End If\n            End If\n        End If\n        \n        searchPos = pos + 100\n    Loop\n    \n    ParseEventsFromHTML = currentIndex\n    Exit Function\n    \nErrorHandler:\n    ParseEventsFromHTML = currentIndex\nEnd Function\n\n' ============================================================================\n' HTML-Parsing-Hilfsfunktionen\n' ============================================================================\nPrivate Function CleanLocationString(locationStr As String) As String\n    Dim cleaned As String\n    cleaned = Trim(locationStr)\n    \n    cleaned = Replace(cleaned, \">\", \"\")\n    cleaned = Replace(cleaned, \"<\", \"\")\n    cleaned = Replace(cleaned, \"\"\"\", \"\")\n    cleaned = Replace(cleaned, \"'\", \"\")\n    cleaned = Replace(cleaned, \"/\", \"\")\n    cleaned = Replace(cleaned, \"&bull;\", \"\")\n    cleaned = Replace(cleaned, \"&nbsp;\", \" \")\n    cleaned = Replace(cleaned, vbTab, \" \")\n    \n    Do While InStr(cleaned, \"  \") > 0\n        cleaned = Replace(cleaned, \"  \", \" \")\n    Loop\n    \n    CleanLocationString = Trim(cleaned)\nEnd Function\n\nPrivate Function FindNextDatePosition(html As String, startPos As Long) As Long\n    Dim regEx As Object\n    Dim matches As Object\n    \n    Set regEx = CreateObject(\"VBScript.RegExp\")\n    regEx.Pattern = \"\\b\\d{2}\\.\\d{2}\\.\\d{4}\\b\"\n    regEx.Global = True\n    \n    Set matches = regEx.Execute(Mid(html, startPos))\n    \n    If matches.Count > 0 Then\n        FindNextDatePosition = startPos + matches(0).firstIndex\n    Else\n        FindNextDatePosition = 0\n    End If\nEnd Function\n\nPrivate Function ExtractDateFromBlock(blockText As String) As String\n    Dim regEx As Object\n    Set regEx = CreateObject(\"VBScript.RegExp\")\n    regEx.Pattern = \"\\b\\d{2}\\.\\d{2}\\.\\d{4}\\b\"\n    \n    Dim matches As Object\n    Set matches = regEx.Execute(blockText)\n    \n    If matches.Count > 0 Then\n        ExtractDateFromBlock = matches(0).Value\n    Else\n        ExtractDateFromBlock = \"\"\n    End If\nEnd Function\n\nPrivate Function ExtractTitleFromBlock(blockText As String) As String\n    Dim lines() As String\n    Dim line As String\n    Dim i As Integer\n    \n    blockText = RemoveHTMLTags(blockText)\n    lines = Split(blockText, vbLf)\n    \n    For i = LBound(lines) To UBound(lines)\n        line = Trim(Replace(lines(i), vbCr, \"\"))\n        \n        If Len(line) >= 5 And Len(line) <= 80 Then\n            If UCase(line) = line And IsAllCaps(line) Then\n                If InStr(line, \".\") = 0 And InStr(line, \"•\") = 0 And _\n                   InStr(line, \"Einlass\") = 0 And InStr(line, \"Beginn\") = 0 Then\n                    ExtractTitleFromBlock = line\n                    Exit Function\n                End If\n            End If\n        End If\n    Next i\n    \n    ExtractTitleFromBlock = \"\"\nEnd Function\n\nPrivate Function IsAllCaps(Text As String) As Boolean\n    Dim i As Integer\n    Dim char As String\n    Dim hasLetter As Boolean\n    \n    hasLetter = False\n    \n    For i = 1 To Len(Text)\n        char = Mid(Text, i, 1)\n        \n        If char >= \"A\" And char <= \"Z\" Then\n            hasLetter = True\n        ElseIf char >= \"a\" And char <= \"z\" Then\n            IsAllCaps = False\n            Exit Function\n        End If\n    Next i\n    \n    IsAllCaps = hasLetter\nEnd Function\n\nPrivate Function ExtractLocationFromBlock(blockText As String) As String\n    Dim lines() As String\n    Dim line As String\n    Dim i As Integer\n    Dim parts() As String\n    \n    blockText = RemoveHTMLTags(blockText)\n    lines = Split(blockText, vbLf)\n    \n    For i = LBound(lines) To UBound(lines)\n        line = Trim(Replace(lines(i), vbCr, \"\"))\n        \n        If InStr(line, \"•\") > 0 Then\n            parts = Split(line, \"•\")\n            If UBound(parts) >= 1 Then\n                ExtractLocationFromBlock = Trim(parts(1))\n                Exit Function\n            End If\n        End If\n    Next i\n    \n    ExtractLocationFromBlock = \"\"\nEnd Function\n\nPrivate Function ExtractCityFromBlock(blockText As String) As String\n    Dim lines() As String\n    Dim line As String\n    Dim i As Integer\n    Dim parts() As String\n    \n    blockText = RemoveHTMLTags(blockText)\n    lines = Split(blockText, vbLf)\n    \n    For i = LBound(lines) To UBound(lines)\n        line = Trim(Replace(lines(i), vbCr, \"\"))\n        \n        If InStr(line, \"•\") > 0 Then\n            parts = Split(line, \"•\")\n            If UBound(parts) >= 0 Then\n                Dim city As String\n                city = Trim(parts(0))\n                If Len(city) = 0 Then city = \"Nürnberg\"\n                ExtractCityFromBlock = city\n                Exit Function\n            End If\n        End If\n    Next i\n    \n    ExtractCityFromBlock = \"Nürnberg\"\nEnd Function\n\nPrivate Function ExtractEinlasszeitFromBlock(blockText As String) As String\n    Dim lines() As String\n    Dim line As String\n    Dim i As Integer\n    \n    blockText = RemoveHTMLTags(blockText)\n    lines = Split(blockText, vbLf)\n    \n    For i = LBound(lines) To UBound(lines)\n        line = Trim(Replace(lines(i), vbCr, \"\"))\n        \n        If InStr(1, line, \"Einlass:\", vbTextCompare) > 0 Then\n            Dim pos As Integer\n            pos = InStr(1, line, \"Einlass:\", vbTextCompare)\n            ExtractEinlasszeitFromBlock = Trim(Mid(line, pos + 8))\n            Exit Function\n        End If\n    Next i\n    \n    ExtractEinlasszeitFromBlock = \"\"\nEnd Function\n\nPrivate Function ParseEinlasszeit(zeitStr As String, eventDate As Date) As Date\n    Dim stunde As Integer\n    Dim minute As Integer\n    Dim parts() As String\n    \n    zeitStr = Replace(zeitStr, \"Uhr\", \"\")\n    zeitStr = Trim(zeitStr)\n    \n    If InStr(zeitStr, \":\") > 0 Then\n        parts = Split(zeitStr, \":\")\n        If UBound(parts) >= 1 Then\n            stunde = val(Trim(parts(0)))\n            minute = val(Trim(Left(parts(1), 2)))\n            \n            If stunde >= 0 And stunde <= 23 And minute >= 0 And minute <= 59 Then\n                ParseEinlasszeit = DateSerial(year(eventDate), Month(eventDate), Day(eventDate)) + _\n                                  TimeSerial(stunde, minute, 0)\n                Exit Function\n            End If\n        End If\n    End If\n    \n    ParseEinlasszeit = DateSerial(year(eventDate), Month(eventDate), Day(eventDate)) + TimeSerial(19, 0, 0)\nEnd Function\n\nPrivate Function RemoveHTMLTags(html As String) As String\n    Dim regEx As Object\n    Set regEx = CreateObject(\"VBScript.RegExp\")\n    \n    regEx.Pattern = \"<[^>]+>\"\n    regEx.Global = True\n    \n    RemoveHTMLTags = regEx.Replace(html, vbLf)\n    RemoveHTMLTags = Replace(RemoveHTMLTags, vbLf & vbLf, vbLf)\nEnd Function\n\nPrivate Sub SaveHTMLForDebug(htmlContent As String)\n    On Error Resume Next\n    \n    Dim fso As Object\n    Dim textFile As Object\n    \n    Set fso = CreateObject(\"Scripting.FileSystemObject\")\n    If Not fso.FolderExists(\"C:\\Temp\") Then fso.CreateFolder \"C:\\Temp\"\n    \n    Set textFile = fso.CreateTextFile(\"C:\\Temp\\Homepage_Debug.html\", True, True)\n    textFile.Write htmlContent\n    textFile.Close\nEnd Sub\n\nPrivate Function IsRelevantLocation(Objekt As String) As Boolean\n    If Len(Trim(Objekt)) = 0 Then\n        IsRelevantLocation = False\n        Exit Function\n    End If\n    \n    Dim locations As Variant\n    Dim location As Variant\n    Dim objektUpper As String\n    \n    objektUpper = UCase(Trim(Objekt))\n    locations = Split(RELEVANT_LOCATIONS, \"|\")\n    \n    For Each location In locations\n        If InStr(1, objektUpper, UCase(Trim(CStr(location))), vbTextCompare) > 0 Then\n            IsRelevantLocation = True\n            Exit Function\n        End If\n    Next location\n    \n    IsRelevantLocation = False\nEnd Function\n\n' ============================================================================\n' Hilfsfunktionen\n' ============================================================================\nPrivate Function ToTitleCase(Text As String) As String\n    Dim words() As String\n    Dim i As Integer\n    Dim result As String\n    \n    If Len(Trim(Text)) = 0 Then\n        ToTitleCase = \"\"\n        Exit Function\n    End If\n    \n    words = Split(LCase(Trim(Text)), \" \")\n    \n    For i = LBound(words) To UBound(words)\n        If Len(words(i)) > 0 Then\n            words(i) = UCase(Left(words(i), 1)) & Mid(words(i), 2)\n        End If\n    Next i\n    \n    ToTitleCase = Join(words, \" \")\nEnd Function\n\nPrivate Function Nz(Value As Variant, Optional valueIfNull As Variant = \"\") As Variant\n    If IsNull(Value) Or IsEmpty(Value) Then\n        Nz = valueIfNull\n    Else\n        Nz = Value\n    End If\nEnd Function\n\n' ============================================================================\n' Diagnose-Funktion\n' ============================================================================\nPublic Sub DiagnoseHomepageImport()\n    On Error Resume Next\n    \n    Debug.Print String(80, \"=\")\n    Debug.Print \"=== DIAGNOSE ===\"\n    Debug.Print String(80, \"=\")\n    \n    Dim html As String\n    html = DownloadHTML(WEBSITE_URL)\n    \n    If Len(html) = 0 Then\n        MsgBox \"HTML-Download fehlgeschlagen!\", vbCritical\n        Exit Sub\n    End If\n    \n    Call SaveHTMLForDebug(html)\n    \n    Dim testEvents() As EventInfo\n    ReDim testEvents(0 To 999)\n    \n    Dim Count As Integer\n    Count = ParseEventsFromHTML(html, testEvents, Date)\n    \n    Debug.Print vbCrLf & \"Gefundene Events: \" & Count\n    \n    If Count > 0 Then\n        Dim i As Integer\n        For i = 0 To IIf(Count > 5, 4, Count - 1)\n            Debug.Print \"  [\" & i & \"] \" & testEvents(i).DatumStr & \" | \" & _\n                       testEvents(i).titel & \" | \" & testEvents(i).Objekt & \" | \" & _\n                       testEvents(i).Ort\n        Next i\n    End If\n    \n    MsgBox \"Diagnose abgeschlossen!\" & vbCrLf & vbCrLf & _\n           \"Events gefunden: \" & Count & vbCrLf & vbCrLf & _\n           \"Details im Debug-Fenster (Strg+G)\", vbInformation\nEnd Sub\n\n"}
