{"id":"MOD_mod_N_Loewensaal","name":"mod_N_Loewensaal","kind":"standard","procedures":["Private Function DatumFuerSQL(ByVal Datum As Date) As String","Private Function NormalisiereTitel(ByVal titel As String) As String","Public Sub SyncLoewensaalEvents()","Private Function CreateNewAuftragViaUniversalModul(evt As EventInfo) As String","Private Function IsRelevantLocation(Objekt As String) As Boolean","Private Function LoadEventsFromExcel(filePath As String, minDatum As Date) As EventInfo()","Private Function ProcessExcelSheet(xlSheet As Object, sheetName As String, ByRef allEvents() As EventInfo, startIndex As Integer, minDatum As Date) As Integer","Private Function IsDuplicateEvent(events() As EventInfo, Count As Integer, eventDate As Date, titel As String, Objekt As String) As Boolean","Public Function EventExistsInDatabase(ByVal eventDatum As Date, ByVal eventTitel As String, ByVal eventObjekt As String) As Boolean","Public Sub KorrigiereAuftragBooleans(ByVal AuftragsID As Long)","Public Function ToTitleCase(inputText As String) As String","Private Function Nz(Value As Variant, Optional valueIfNull As Variant = \"\") As Variant"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"'Attribute VB_Name = \"mod_N_loewensaal\"\nOption Compare Database\nOption Explicit\n\n' ============================================================================\n' Modul: mod_N_loewensaal\n' Version: 5.2 - TITEL-NORMALISIERUNG HINZUGEFÜGT\n' ============================================================================\n' ÄNDERUNGEN v5.2:\n' - Titel-Normalisierung: GROSSBUCHSTABEN ? Normale Schreibweise\n' - NormalisiereTitel() Funktion hinzugefügt\n' - Automatische Anwendung bei Event-Erstellung\n' ============================================================================\n\nPrivate Const EXCEL_FILE_PATH As String = \"\\\\vConSYS01-NBG\\Consys\\CONSEC\\CONSEC PLANUNG AKTUELL\\ZZ  CBF Veranstaltungen 2025  2026.xlsm\"\nPrivate Const TREFFPUNKT_DEFAULT As String = \"15 min vor DB vor Ort\"\nPrivate Const DIENSTKLEIDUNG_DEFAULT As String = \"Consec\"\nPrivate Const VERANSTALTER_ID_DEFAULT As Long = 10233\nPrivate Const RELEVANT_LOCATIONS As String = \"Löwensaal|Loewensaal|Heinrich-Lades-Halle|Meistersingerhalle|Serenadenhof|Stadionpark|Markgrafensaal|Stadthalle\"\n\nPublic Type EventInfo\n    Datum As Date\n    DatumStr As String\n    titel As String\n    Ort As String\n    Objekt As String\n    VeranstalterID As Long\n    ExistiertInDB As Boolean\n    SheetQuelle As String\n    Treffpunkt As String\n    einlasszeit As Date\n    EinlasszeitStr As String\nEnd Type\n\nPrivate Function DatumFuerSQL(ByVal Datum As Date) As String\n    DatumFuerSQL = Month(Datum) & \"/\" & Day(Datum) & \"/\" & year(Datum)\nEnd Function\n\nPrivate Function NormalisiereTitel(ByVal titel As String) As String\n    If titel = UCase$(titel) Then\n        NormalisiereTitel = ToTitleCase(titel)\n        Debug.Print \"      ? Titel normalisiert: \" & titel & \" ? \" & NormalisiereTitel\n    Else\n        NormalisiereTitel = titel\n    End If\nEnd Function\n\nPublic Sub SyncLoewensaalEvents()\n    On Error GoTo ErrorHandler\n    \n    Dim allEvents() As EventInfo\n    Dim eventCount As Integer\n    Dim newCount As Integer\n    Dim i As Integer\n    Dim heutesDatum As Date\n    \n    heutesDatum = Date\n    \n    If Dir(EXCEL_FILE_PATH) = \"\" Then\n        MsgBox \"Excel-Datei nicht gefunden:\" & vbCrLf & EXCEL_FILE_PATH, vbCritical, \"Datei nicht gefunden\"\n        Exit Sub\n    End If\n    \n    DoCmd.Hourglass True\n    Debug.Print String(80, \"=\")\n    Debug.Print \"=== Excel-Import Synchronisation gestartet ===\"\n    Debug.Print \"Titel-Normalisierung: AKTIV\"\n    Debug.Print String(80, \"=\")\n    \n    allEvents = LoadEventsFromExcel(EXCEL_FILE_PATH, heutesDatum)\n    eventCount = UBound(allEvents) - LBound(allEvents) + 1\n    \n    If eventCount = 0 Or (eventCount = 1 And Len(Trim(allEvents(0).titel)) = 0) Then\n        DoCmd.Hourglass False\n        MsgBox \"Keine relevanten Events gefunden.\", vbInformation\n        Exit Sub\n    End If\n    \n    newCount = 0\n    For i = LBound(allEvents) To UBound(allEvents)\n        allEvents(i).ExistiertInDB = EventExistsInDatabase(allEvents(i).Datum, allEvents(i).titel, allEvents(i).Objekt)\n        If Not allEvents(i).ExistiertInDB Then newCount = newCount + 1\n    Next i\n    \n    If newCount = 0 Then\n        DoCmd.Hourglass False\n        MsgBox \"Alle Events bereits vorhanden.\", vbInformation\n        Exit Sub\n    End If\n    \n    Dim successCount As Integer, errorCount As Integer\n    Dim successDetails As String, errorMessages As String\n    successCount = 0: errorCount = 0\n    \n    For i = LBound(allEvents) To UBound(allEvents)\n        If Not allEvents(i).ExistiertInDB Then\n            Dim ergebnis As String\n            ergebnis = CreateNewAuftragViaUniversalModul(allEvents(i))\n            \n            If Left(ergebnis, 7) = \"SUCCESS\" Then\n                successCount = successCount + 1\n                Dim teile() As String\n                teile = Split(ergebnis, \"|\")\n                If UBound(teile) >= 1 Then\n                    Call KorrigiereAuftragBooleans(CLng(teile(1)))\n                    successDetails = successDetails & \"• ID \" & teile(1) & \": \" & Left(allEvents(i).titel, 50) & vbCrLf\n                End If\n            Else\n                errorCount = errorCount + 1\n                errorMessages = errorMessages & \"• \" & allEvents(i).titel & vbCrLf\n            End If\n        End If\n    Next i\n    \n    DoCmd.Hourglass False\n    \n    If errorCount = 0 Then\n        MsgBox \"? Import erfolgreich!\" & vbCrLf & vbCrLf & \"Neue Events: \" & successCount & vbCrLf & vbCrLf & successDetails, vbInformation\n    Else\n        MsgBox \"? Import mit Fehlern:\" & vbCrLf & vbCrLf & \"Erfolgreich: \" & successCount & vbCrLf & \"Fehler: \" & errorCount, vbExclamation\n    End If\n    \n    Exit Sub\n    \nErrorHandler:\n    DoCmd.Hourglass False\n    MsgBox \"Fehler: \" & err.description, vbCritical\nEnd Sub\n\nPrivate Function CreateNewAuftragViaUniversalModul(evt As EventInfo) As String\n    On Error GoTo ErrorHandler\n    \n    Dim ortName As String\n    ortName = evt.Ort\n    If Len(Trim(ortName)) = 0 Then ortName = \"Nürnberg\"\n    \n    Dim titelNormalisiert As String\n    titelNormalisiert = NormalisiereTitel(evt.titel)\n    \n    Dim ergebnis As String\n    ergebnis = AuftragErstellen( _\n        auftragsName:=titelNormalisiert, _\n        objektName:=evt.Objekt, _\n        ortName:=ortName, _\n        DatumVon:=evt.Datum, _\n        DatumBis:=evt.Datum, _\n        auftraggeber:=\"\", _\n        Treffpunkt:=evt.Treffpunkt, _\n        schichten:=\"\", _\n        statusID:=1, _\n        Ersteller:=\"Excel-Import\" _\n    )\n    \n    If Left(ergebnis, 7) = \"SUCCESS\" Then\n        Dim teile() As String\n        teile = Split(ergebnis, \"|\")\n        If UBound(teile) >= 1 Then\n            Dim sql As String\n            sql = \"UPDATE tbl_VA_Auftragstamm SET Veranstalter_ID = \" & VERANSTALTER_ID_DEFAULT & \" WHERE ID = \" & CLng(teile(1))\n            CurrentDb.Execute sql\n        End If\n    End If\n    \n    CreateNewAuftragViaUniversalModul = ergebnis\n    Exit Function\n    \nErrorHandler:\n    CreateNewAuftragViaUniversalModul = \"FEHLER: \" & err.description\nEnd Function\n\nPrivate Function IsRelevantLocation(Objekt As String) As Boolean\n    If Len(Trim(Objekt)) = 0 Then\n        IsRelevantLocation = False\n        Exit Function\n    End If\n    \n    Dim locations As Variant, location As Variant\n    locations = Split(RELEVANT_LOCATIONS, \"|\")\n    \n    For Each location In locations\n        If InStr(1, UCase(Trim(Objekt)), UCase(Trim(CStr(location))), vbTextCompare) > 0 Then\n            IsRelevantLocation = True\n            Exit Function\n        End If\n    Next location\n    IsRelevantLocation = False\nEnd Function\n\nPrivate Function LoadEventsFromExcel(filePath As String, minDatum As Date) As EventInfo()\n    On Error GoTo ErrorHandler\n    \n    Dim xlApp As Object, xlBook As Object, xlSheet As Object\n    Dim allEvents() As EventInfo\n    Dim totalCount As Integer\n    Dim sheetsToProcess As Variant\n    Dim i As Integer\n    \n    Set xlApp = CreateObject(\"Excel.Application\")\n    xlApp.Visible = False\n    xlApp.DisplayAlerts = False\n    Set xlBook = xlApp.Workbooks.Open(filePath, ReadOnly:=True)\n    \n    sheetsToProcess = Array(\"CBF Loewensaal\", \"CBF Hirsch\", \"CBF Serenadenhof\", \"CBF Diverse Locations\", \"CBF Veranstaltungen 2025-2026\")\n    \n    ReDim allEvents(0 To 999)\n    totalCount = 0\n    \n    For i = LBound(sheetsToProcess) To UBound(sheetsToProcess)\n        On Error Resume Next\n        Set xlSheet = xlBook.Worksheets(CStr(sheetsToProcess(i)))\n        If err.Number = 0 And Not xlSheet Is Nothing Then\n            On Error GoTo ErrorHandler\n            totalCount = ProcessExcelSheet(xlSheet, CStr(sheetsToProcess(i)), allEvents, totalCount, minDatum)\n        End If\n        Set xlSheet = Nothing\n    Next i\n    \n    xlBook.Close SaveChanges:=False\n    xlApp.Quit\n    Set xlSheet = Nothing: Set xlBook = Nothing: Set xlApp = Nothing\n    \n    If totalCount > 0 Then\n        ReDim Preserve allEvents(0 To totalCount - 1)\n    Else\n        ReDim allEvents(0 To 0)\n        allEvents(0).titel = \"\"\n    End If\n    \n    LoadEventsFromExcel = allEvents\n    Exit Function\n    \nErrorHandler:\n    On Error Resume Next\n    If Not xlBook Is Nothing Then xlBook.Close SaveChanges:=False\n    If Not xlApp Is Nothing Then xlApp.Quit\n    ReDim allEvents(0 To 0)\n    allEvents(0).titel = \"\"\n    LoadEventsFromExcel = allEvents\nEnd Function\n\nPrivate Function ProcessExcelSheet(xlSheet As Object, sheetName As String, ByRef allEvents() As EventInfo, startIndex As Integer, minDatum As Date) As Integer\n    On Error GoTo ErrorHandler\n    \n    Dim row As Long, Datum As Variant, titel As String, Ort As String, Objekt As String\n    Dim currentIndex As Integer, lastRow As Long, eventDate As Date\n    Dim startCol As Long, maxCol As Long\n    \n    currentIndex = startIndex\n    lastRow = xlSheet.UsedRange.rows.Count\n    maxCol = xlSheet.UsedRange.Columns.Count\n    \n    If lastRow < 2 Then\n        ProcessExcelSheet = currentIndex\n        Exit Function\n    End If\n    \n    For startCol = 1 To maxCol Step 5\n        On Error Resume Next\n        If xlSheet.Cells(1, startCol).Value = \"Datum\" Then\n            On Error GoTo ErrorHandler\n            \n            For row = 2 To lastRow\n                On Error Resume Next\n                Datum = xlSheet.Cells(row, startCol).Value\n                titel = Trim(CStr(Nz(xlSheet.Cells(row, startCol + 1).Value, \"\")))\n                Ort = Trim(CStr(Nz(xlSheet.Cells(row, startCol + 2).Value, \"\")))\n                Objekt = Trim(CStr(Nz(xlSheet.Cells(row, startCol + 3).Value, \"\")))\n                On Error GoTo ErrorHandler\n                \n                If Not IsEmpty(Datum) And Len(titel) > 0 And Len(Objekt) > 0 Then\n                    If IsRelevantLocation(Objekt) Then\n                        If IsDate(Datum) Then\n                            eventDate = CDate(Datum)\n                            If eventDate >= minDatum And eventDate <= #12/31/2099# Then\n                                If Not IsDuplicateEvent(allEvents, currentIndex, eventDate, titel, Objekt) Then\n                                    If Len(Trim(Ort)) = 0 Then Ort = \"Nürnberg\"\n                                    \n                                    allEvents(currentIndex).Datum = eventDate\n                                    allEvents(currentIndex).DatumStr = Format(eventDate, \"dd.mm.yyyy\")\n                                    allEvents(currentIndex).titel = titel\n                                    allEvents(currentIndex).Ort = Ort\n                                    allEvents(currentIndex).Objekt = Objekt\n                                    allEvents(currentIndex).VeranstalterID = VERANSTALTER_ID_DEFAULT\n                                    allEvents(currentIndex).ExistiertInDB = False\n                                    allEvents(currentIndex).SheetQuelle = sheetName\n                                    allEvents(currentIndex).Treffpunkt = TREFFPUNKT_DEFAULT\n                                    \n                                    currentIndex = currentIndex + 1\n                                    If currentIndex > UBound(allEvents) Then\n                                        ReDim Preserve allEvents(0 To UBound(allEvents) + 500)\n                                    End If\n                                End If\n                            End If\n                        End If\n                    End If\n                End If\n            Next row\n        End If\n    Next startCol\n    \n    ProcessExcelSheet = currentIndex\n    Exit Function\n    \nErrorHandler:\n    ProcessExcelSheet = currentIndex\nEnd Function\n\nPrivate Function IsDuplicateEvent(events() As EventInfo, Count As Integer, eventDate As Date, titel As String, Objekt As String) As Boolean\n    Dim i As Integer\n    For i = 0 To Count - 1\n        If events(i).Datum = eventDate And StrComp(events(i).titel, titel, vbTextCompare) = 0 And StrComp(events(i).Objekt, Objekt, vbTextCompare) = 0 Then\n            IsDuplicateEvent = True\n            Exit Function\n        End If\n    Next i\n    IsDuplicateEvent = False\nEnd Function\n\nPublic Function EventExistsInDatabase(ByVal eventDatum As Date, ByVal eventTitel As String, ByVal eventObjekt As String) As Boolean\n    On Error GoTo ErrorHandler\n    \n    Dim rs As DAO.Recordset, sql As String, found As Boolean\n    sql = \"SELECT Auftrag FROM tbl_VA_Auftragstamm WHERE Dat_VA_Von = #\" & DatumFuerSQL(eventDatum) & \"# AND Objekt = '\" & Replace(eventObjekt, \"'\", \"''\") & \"'\"\n    Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n    \n    found = False\n    Do While Not rs.EOF\n        If StrComp(Trim(Nz(rs!Auftrag, \"\")), eventTitel, vbTextCompare) = 0 Then\n            found = True\n            Exit Do\n        End If\n        rs.MoveNext\n    Loop\n    \n    rs.Close\n    Set rs = Nothing\n    EventExistsInDatabase = found\n    Exit Function\n    \nErrorHandler:\n    EventExistsInDatabase = False\nEnd Function\n\nPublic Sub KorrigiereAuftragBooleans(ByVal AuftragsID As Long)\n    On Error Resume Next\n    Dim rs As DAO.Recordset, i As Integer, hatUpdate As Boolean\n    Set rs = CurrentDb.OpenRecordset(\"SELECT * FROM tbl_VA_Auftragstamm WHERE ID = \" & AuftragsID, dbOpenDynaset)\n    \n    If Not rs.EOF Then\n        hatUpdate = False\n        For i = 0 To rs.fields.Count - 1\n            If rs.fields(i).Type = dbBoolean Then\n                If Not hatUpdate Then\n                    rs.Edit\n                    hatUpdate = True\n                End If\n                rs.fields(i).Value = True\n            End If\n        Next i\n        If hatUpdate Then rs.update\n    End If\n    rs.Close\nEnd Sub\n\nPublic Function ToTitleCase(inputText As String) As String\n    If Len(Trim(inputText)) = 0 Then\n        ToTitleCase = \"\"\n        Exit Function\n    End If\n    \n    Dim words() As String, i As Integer, result As String\n    words = Split(LCase(Trim(inputText)), \" \")\n    result = \"\"\n    \n    For i = LBound(words) To UBound(words)\n        If Len(words(i)) > 0 Then\n            words(i) = UCase(Left(words(i), 1)) & Mid(words(i), 2)\n            result = result & IIf(Len(result) > 0, \" \", \"\") & words(i)\n        End If\n    Next i\n    ToTitleCase = result\nEnd Function\n\nPrivate Function Nz(Value As Variant, Optional valueIfNull As Variant = \"\") As Variant\n    Nz = IIf(IsNull(Value) Or IsEmpty(Value), valueIfNull, Value)\nEnd Function\n\n"}
