{"id":"MOD_modProtokoll","name":"modProtokoll","kind":"standard","procedures":["Public Function Änderungsprotokoll()","Public Function Datensatzlöschung()","Function NetworkComputerName() As String","Function NetworkUserName() As String","Public Function Protokollieren()","Function ProtokollEnde()","Function Protokollstart()"],"calls":{"DoCmd.OpenForm":["Änderungsprotokoll"],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\nDeclare PtrSafe Function GetUserName Lib \"advapi32.dll\" _\n        Alias \"GetUserNameA\" _\n        (ByVal lpBuffer As String, nSize As Long) As Long\n\nDeclare PtrSafe Function GetComputerName Lib \"kernel32\" _\n        Alias \"GetComputerNameA\" _\n        (ByVal lpBuffer As String, nSize As Long) As Long\n\nPublic arrProtokoll(1 To 250, 1 To 8) As String\nPublic cntProtokoll As Integer\n\nPublic Function Änderungsprotokoll()\n\n  On Error Resume Next\n  DoCmd.OpenForm \"Änderungsprotokoll\", , , , , acDialog\n  If err <> 0 Then\n    Beep\n    MsgBox \"Formular 'Änderungsprotokoll' nicht gefunden!\", _\n           vbOKOnly + vbCritical, \"Änderungsprotokoll:\"\n    Exit Function\n  End If\n  \nEnd Function\n\nPublic Function Datensatzlöschung()\n  Dim db As DAO.Database\n  Dim rs As DAO.Recordset\n  Dim f As Form, ctl As control\n  Dim strText As String\n  \n  On Error Resume Next\n  Set db = CurrentDb()\n  Set rs = db.OpenRecordset(\"Protokoll\", dbOpenDynaset)\n  If err <> 0 Then\n    Beep\n    MsgBox \"Fehler beim Zugriff auf Tabelle 'Protokoll'...\", _\n           vbOKOnly + vbExclamation, \"Protokollieren:\"\n    Exit Function\n  End If\n  err = 0\n  Set f = Screen.ActiveForm\n  If err <> 0 Then\n    Beep\n    MsgBox \"Kein Formular geöffnet...\", _\n           vbOKOnly + vbExclamation, \"Protokollieren:\"\n    Exit Function\n  End If\n  \n  For Each ctl In f.controls\n    If TypeOf ctl Is TextBox Or _\n       TypeOf ctl Is ListBox Or _\n       TypeOf ctl Is CheckBox Or _\n       TypeOf ctl Is OptionGroup Or _\n       TypeOf ctl Is ToggleButton Or _\n       TypeOf ctl Is ComboBox Then\n    strText = strText & ctl.Name & \": \" & CStr(ctl.Value) & vbCrLf\n    End If\n  Next ctl\n  \n  rs.AddNew\n  rs(\"pDatenbank\") = db.Name\n  rs(\"pFormularName\") = f.Name\n  rs(\"pFeldName\") = \"Datensatzlöschung!\"\n  rs(\"pAlterWert\") = strText\n  rs(\"pNeuerWert\") = \"Gelöscht!\"\n  rs(\"pGeaendertAm\") = Now\n  rs(\"pGeaendertVon\") = NetworkUserName() & \"/\" & NetworkComputerName()\n  rs.update\n  rs.Close\n  \n  Set rs = Nothing\n  Set db = Nothing\n\nEnd Function\n\nFunction NetworkComputerName() As String\n  Dim lngMaxLen As Long, lngResult As Long\n  Dim strComputerName As String\n  \n  lngMaxLen = 16\n  strComputerName = String$(lngMaxLen, 0)\n  lngResult = GetComputerName(strComputerName, lngMaxLen)\n  If lngResult <> 0 Then\n    NetworkComputerName = Trim$(Left$(strComputerName, lngMaxLen))\n  Else\n    NetworkComputerName = \"???\"\n  End If\n\nEnd Function\n\nFunction NetworkUserName() As String\n  Dim lngMaxLen As Long, lngResult As Long\n  Dim strUserName As String\n\n  strUserName = String$(254, 0)\n  lngMaxLen = 255\n  lngResult = GetUserName(strUserName, lngMaxLen)\n  If lngResult <> 0 Then\n    NetworkUserName = Left$(strUserName, lngMaxLen - 1)\n  Else\n    NetworkUserName = \"\"\n  End If\n\nEnd Function\n\n\n\nPublic Function Protokollieren()\n  Dim f As Form, c As control, ctl As control\n  Dim strID As String\n  \n  On Error Resume Next\n  Set f = Screen.ActiveForm\n  Set c = Screen.ActiveControl\n  If err <> 0 Then\n    Beep\n    MsgBox \"Kein Formular geöffnet oder kein Steuerelement aktiviert...\", _\n           vbOKOnly + vbExclamation, \"Protokollieren:\"\n    Exit Function\n  End If\n  \n  strID = \"\"\n  For Each ctl In f.controls\n    If ctl.TAG = \"DSID\" Then\n      strID = strID & CStr(ctl.Value)\n    End If\n  Next ctl\n  If strID = \"\" Then\n    Beep\n    MsgBox \"Kein Feld als 'DSID' gekennzeichnet!\", _\n           vbOKOnly + vbExclamation, \"Protokollieren:\"\n    Exit Function\n  End If\n  \n  cntProtokoll = cntProtokoll + 1\n  arrProtokoll(cntProtokoll, 1) = CurrentDb.Name\n  arrProtokoll(cntProtokoll, 2) = f.Name\n  arrProtokoll(cntProtokoll, 3) = c.Name\n  arrProtokoll(cntProtokoll, 4) = CStr(c.OldValue)\n  arrProtokoll(cntProtokoll, 5) = CStr(c.Value)\n  arrProtokoll(cntProtokoll, 6) = Now\n  arrProtokoll(cntProtokoll, 7) = NetworkUserName() & \"/\" & NetworkComputerName()\n  arrProtokoll(cntProtokoll, 8) = strID\n  \nEnd Function\n\nFunction ProtokollEnde()\n  Dim db As DAO.Database\n  Dim rs As DAO.Recordset\n  Dim i As Long\n  \n  On Error Resume Next\n  Set db = CurrentDb()\n  Set rs = db.OpenRecordset(\"Protokoll\", dbOpenDynaset)\n  If err <> 0 Then\n    Beep\n    MsgBox \"Fehler beim Zugriff auf Tabelle 'Protokoll'...\", _\n           vbOKOnly + vbExclamation, \"Protokollieren:\"\n    cntProtokoll = 0  'Neue Protokollierung starten\n    Exit Function\n  End If\n  \n  For i = 1 To cntProtokoll\n    rs.AddNew\n    rs(\"pDatenbank\") = arrProtokoll(i, 1)\n    rs(\"pFormularName\") = arrProtokoll(i, 2)\n    rs(\"pFeldName\") = arrProtokoll(i, 3)\n    rs(\"pAlterWert\") = arrProtokoll(i, 4)\n    rs(\"pNeuerWert\") = arrProtokoll(i, 5)\n    rs(\"pGeaendertAm\") = arrProtokoll(i, 6)\n    rs(\"pGeaendertVon\") = arrProtokoll(i, 7)\n    rs(\"pDSID\") = arrProtokoll(i, 8)\n    rs.update\n  Next i\n  rs.Close\n  \n  Set rs = Nothing\n  Set db = Nothing\n  \n  Erase arrProtokoll  'Temporäres Protokoll löschen\n  cntProtokoll = 0    'Neue Protokollierung starten\n\nEnd Function\n\n\n\nFunction Protokollstart()\n\n  Erase arrProtokoll  'Temporäres Protokoll löschen\n  cntProtokoll = 0    'Neue Protokollierung starten\n  \nEnd Function\n\n"}
