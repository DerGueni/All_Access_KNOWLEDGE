{"id":"MOD_mdl_Exl_Import2","name":"mdl_Exl_Import2","kind":"standard","procedures":["Function dirkurz(da As String)","Function Cons_XL_Import_1()","Function Cons_XL_Import_2(dtName As String, iID As Long)","Function Cons_XL_Import_Test()","Function Cons_XL_Import_Einzel(DateinamePfad As String) As Long","Function Cons_XL_Import_3(ID As Long) As Boolean","Function Cons_XL_Import_3_Test() As Boolean","Function fget_kunID(s As String) As Variant","Function Import_Teil2(ID As Long, bExists As Boolean)"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\nDim db As DAO.Database\nDim rst1 As DAO.Recordset\nDim rst2 As DAO.Recordset\nDim rst3 As DAO.Recordset\nDim xl As New clsExcel\n\nFunction dirkurz(da As String)\ndirkurz = Dir(da)\nEnd Function\n\nFunction Cons_XL_Import_1()\n\nDim dtName As String\nDim sPath As String\nDim sName As String\nDim iID As Long\n\nDoEvents\n\nSet db = CurrentDb\n\nSet rst1 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag;\")\nSet rst2 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_ZeitVorgabe;\")\nSet rst3 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_MA_Einsatz;\")\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, iZl As Long, iCol As Long\nrecsetSQL1 = \"Select strPath, Dateiname, ID FROM Import_Auftraege_2015_09_09 WHERE IstNichtImportiert = False AND IstErledigt = False;\"\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\nIf ArrFill_DAO_OK1 Then\n    For iZl = 0 To iZLMax1\n        sPath = DAOARRAY1(0, iZl)\n        sName = DAOARRAY1(1, iZl)\n        iID = DAOARRAY1(2, iZl)\n        dtName = sPath & sName\n        If File_exist(dtName) Then\n        \n            CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_ZeitVorgabe WHERE VA_ID = \" & iID & \";\")\n            CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_MA_Einsatz WHERE VA_ID = \" & iID & \";\")\n            DoEvents\n\n            Call Cons_XL_Import_2(dtName, iID)\n            \n            DoEvents\n            DBEngine.Idle dbRefreshCache\n            DBEngine.Idle dbFreeLocks\n            DoEvents\n            \n'            CurrentDb.Execute (\"UPDATE Import_Auftraege_2015_09_09 SET Import_Auftraege_2015_09_09.IstErledigt = True WHERE (((Import_Auftraege_2015_09_09.ID)=\" & iID & \"));\")\n\n        End If\n    Next iZl\n    Set DAOARRAY1 = Nothing\nEnd If\n\nrst1.Close\nrst2.Close\nrst3.Close\n\nSet rst1 = Nothing\nSet rst2 = Nothing\nSet rst3 = Nothing\n\n\nEnd Function\n\nFunction Cons_XL_Import_2(dtName As String, iID As Long)\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, iZl As Long, iCol As Long\nDim i As Long, jj As Long, j As Long, k As Long, L As Long, iwd As Long\nDim iAufNr As Long\nDim rg\nDim iZeile As Long, iSpalte As Long\nDim iKorr As Long\nDim iKorrAuf As Long\nDim istOk As Boolean\nDim FldInh\nDim iZeileOrg As Long\nDim iWieder As Long\nDim fldName As String\n\nDim rst As Object\nDim iLauf As Long\nDim iStart As Long\n\nDim stxlLstNam As String\n\n'rg = Row, column\n'################\n\nOn Error Resume Next\n\nxl.XL_Wkb_Open_RDOnly (dtName)\nSleep 20\nDoEvents\n\niWieder = 1\n\nIf xl.SelectSheet_Test(\"Liste\") = False Then\n    GoTo XL_Ende\nEnd If\n\n'If XL.xlSheetCount <> 2 Then GoTo XL_Ende\n\nIf xl.SelectSheet_Test(\"Liste 2\") = True Then iWieder = 2\nIf xl.SelectSheet_Test(\"Liste 3\") = True Then iWieder = 3\n\niwd = 1\n\nRepeatDat:\n\nIf iwd <= iWieder Then\n    If iwd = 1 Then\n        stxlLstNam = \"Liste\"\n    Else\n        stxlLstNam = \"Liste \" & iwd\n    End If\n    iwd = iwd + 1\nElse\n    GoTo XL_Ende\nEnd If\n\nxl.SelectSheet (stxlLstNam)\nDoEvents\n\nIf Not xl.SelectSheet_Test(stxlLstNam) Then GoTo RepeatDat\n    \n    'Public Function SetRange(IRow As Long, iCol As Long, IRowEnd As Long, IColEnd As Long) As Object\n    ' Set rg = XL.SetRange(1, 1, ilarow, 3)\n    \n    ' Test auf Zeile 17 und Spalte 41 \"PKW\"\n    \n    iZeile = 9\n    iSpalte = 34\n    Set rg = xl.SetRange(iZeile, iSpalte, iZeile + 1, iSpalte)\n    \n    istOk = False\n    If Left(Nz(rg(2, 1)), 10) = \"Auftraggeb\" Then\n        istOk = True\n        iKorrAuf = 1\n    ElseIf Left(Nz(rg(1, 1)), 10) = \"Auftraggeb\" Then\n        istOk = True\n        iKorrAuf = 0\n    End If\n    \n    If istOk Then\n        iZeile = 17\n        iSpalte = 41\n        Set rg = xl.SetRange(iZeile, iSpalte, iZeile + 9, iSpalte)\n        \n        istOk = False\n        \n        'Max 10 Schichten - pro Schicht eine Zeile\n        For i = 0 To 9\n            If Nz(rg(1 + i, 1)) = \"PKW\" Then\n                istOk = True\n                iKorr = i\n                Exit For\n            End If\n        Next i\n    End If\n    \n    \n    jj = 1\n    If istOk And iwd = 2 Then\n        recsetSQL1 = \"Select Feldname, AnzZeilen, Zeile, Spalte FROM qry_Excel_Sel_Import_Felder WHERE TabTyp = \" & jj & \";\"\n        Set rst = rst1\n        With rst\n            ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n        \n            'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n            If ArrFill_DAO_OK1 Then\n                .FindFirst \"ID = \" & iID\n                .Edit\n                For iZl = 0 To iZLMax1\n                    fldName = DAOARRAY1(0, iZl)\n                    iZeile = DAOARRAY1(2, iZl)\n                    iSpalte = DAOARRAY1(3, iZl)\n                    If fldName = \"Auftraggeber\" Then iZeile = iZeile + iKorrAuf\n                    Set rg = xl.SetRange(iZeile, iSpalte, iZeile, iSpalte)\n                    FldInh = Nz(rg(1, 1))\n                    If Not (fldName = \"DatumVonStr\" And Len(Trim(Nz(FldInh))) = 0) Then\n                        .fields(fldName) = FldInh\n                    End If\n                Next iZl\n                .fields(\"Import_OK_Stufe_1\") = True\n                Set DAOARRAY1 = Nothing\n                .update\n            End If\n        End With\n    End If\n    \n    jj = 2\n    k = 2\n    If istOk And iwd = 2 Then\n        recsetSQL1 = \"Select Feldname, AnzZeilen, Zeile, Spalte FROM qry_Excel_Sel_Import_Felder WHERE TabTyp = \" & jj & \";\"\n        Set rst = rst2\n        With rst\n            ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n        \n            'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n            If ArrFill_DAO_OK1 Then\n                For i = 0 To k\n                    Set rg = xl.SetRange(13 + i, 2, 13 + i, 2) ' Anzahl Ma absolute Spalte Zeile\n                    FldInh = Nz(rg(1, 1))\n                    If Len(Trim(Nz(FldInh))) > 0 Then\n                        .AddNew\n                            .fields(\"VA_ID\") = iID\n                            For iZl = 0 To iZLMax1\n                                iZeile = 0\n                                iZeileOrg = DAOARRAY1(2, iZl)\n                                fldName = DAOARRAY1(0, iZl)\n                                iSpalte = DAOARRAY1(3, iZl)\n                                iZeile = iZeileOrg + i\n                                Set rg = xl.SetRange(iZeile, iSpalte, iZeile, iSpalte)\n                                FldInh = Nz(rg(1, 1))\n                                .fields(fldName) = FldInh\n                            Next iZl\n                        .update\n                    End If\n                Next i\n                Set DAOARRAY1 = Nothing\n            End If\n        End With\n    End If\n    \n    jj = 3\n    k = 99\n    If istOk Then\n        recsetSQL1 = \"Select Feldname, AnzZeilen, Zeile, Spalte FROM qry_Excel_Sel_Import_Felder WHERE TabTyp = \" & jj & \";\"\n        Set rst = rst3\n        With rst\n            ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n        \n            'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n            If ArrFill_DAO_OK1 Then\n                L = 0 + iKorr\n                For i = L To k\n                    Set rg = xl.SetRange(18 + i, 16, 18 + i, 16)  ' Pos Nr absolute Spalte Zeile\n                    FldInh = Nz(rg(1, 1))\n                    If Len(Trim(Nz(FldInh))) > 0 And FldInh > 0 Then\n                      .AddNew\n                          .fields(\"VA_ID\") = iID\n                           For iZl = 0 To iZLMax1\n                                iZeile = 0\n                                iZeileOrg = DAOARRAY1(2, iZl)\n                                fldName = DAOARRAY1(0, iZl)\n                                iSpalte = DAOARRAY1(3, iZl)\n                                iZeile = iZeileOrg + i\n                                Set rg = xl.SetRange(iZeile, iSpalte, iZeile, iSpalte)\n                                FldInh = Nz(rg(1, 1))\n                                .fields(fldName) = FldInh\n                            Next iZl\n                      .update\n                    End If\n                Next i\n                Set DAOARRAY1 = Nothing\n            End If\n        End With\n    End If\n    \nIf iWieder > 1 And iwd <= iWieder Then GoTo RepeatDat\n    \nXL_Ende:\n\nxl.XL_Close_Sure\n\nEnd Function\n\n\nFunction Cons_XL_Import_Test()\n\nDoEvents\n\nSet db = CurrentDb\n\n        CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_ZeitVorgabe WHERE VA_ID In(355, 312)\")\n        CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_MA_Einsatz WHERE VA_ID In(355, 312)\")\n        DoEvents\n\nSet rst1 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag;\")\nSet rst2 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_ZeitVorgabe;\")\nSet rst3 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_MA_Einsatz;\")\n\n    Cons_XL_Import_2 \"C:\\Kunden\\CONSEC (Siegert)\\PGM\\Import\\10-03-15 Greuther Fürth -Bochum.xls\", 355\n    Cons_XL_Import_2 \"C:\\Kunden\\CONSEC (Siegert)\\PGM\\Import\\09-17-15 Streetfood im Parks.xls\", 312\n    \nrst1.Close\nrst2.Close\nrst3.Close\n\nSet rst1 = Nothing\nSet rst2 = Nothing\nSet rst3 = Nothing\n\nEnd Function\n\n\nFunction Cons_XL_Import_Einzel(DateinamePfad As String) As Long\n\nDim stPfad As String\nDim stDateiname As String\nDim stDatumvon As String\nDim dtDatum As Date\nDim stObjekt As String\n\nDim db As DAO.Database\nDim rst As DAO.Recordset\nDim ID As Long\nDim ID1 As Long\nDim bImportOK As Boolean\n\nDim bIDNeu As Boolean\n\nDim i As Long\n\nDoEvents\n\ni = InStrRev(DateinamePfad, \"\\\")\nstPfad = Left(DateinamePfad, i)\nstDateiname = Mid(DateinamePfad, i + 1)\nstObjekt = Mid(stDateiname, 10)\ni = InStrRev(stObjekt, \".\")\nstObjekt = Left(stObjekt, i - 1)\nstDatumvon = Mid(stDateiname, 4, 2) & \".\" & Left(stDateiname, 2) & \".20\" & Mid(stDateiname, 7, 2)\n\ndtDatum = DateSerial(CLng(\"20\" & Mid(stDateiname, 7, 2)), CLng(Left(stDateiname, 2)), CLng(Mid(stDateiname, 4, 2)))\n\nID = Nz(TLookup(\"ID\", \"tblZZZ_XL_Auftrag\", \"Dateiname = '\" & stDateiname & \"'\"), 0)\nID1 = Nz(TLookup(\"ID\", \"tbl_VA_Auftragstamm\", \"ID = \" & ID), 0)\nIf ID1 = 0 Then\n    ID1 = Nz(TLookup(\"ID\", \"tbl_VA_Auftragstamm\", \"Excel_Dateiname = '\" & stDateiname & \"'\"), 0)\nEnd If\nSet db = CurrentDb\n\nIf ID > 0 Then\n    CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_ZeitVorgabe WHERE VA_ID = \" & ID)\n    CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Auftrag_MA_Einsatz WHERE VA_ID = \" & ID)\n    CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_AnzTage WHERE VA_ID = \" & ID)\n    CurrentDb.Execute (\"DELETE * FROM tblZZZ_XL_Start WHERE VA_ID = \" & ID)\n    CurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.Fehlerprotokoll = '', tblZZZ_XL_Auftrag.Aend_von = atcnames(1), tblZZZ_XL_Auftrag.Aend_am = Now(), tblZZZ_XL_Auftrag.ImportAlt_Vorhanden = True, tblZZZ_XL_Auftrag.NeuImport = False WHERE (((tblZZZ_XL_Auftrag.ID)= \" & ID & \"));\")\n\n    DoEvents\n    bIDNeu = False\n    \n    If ID1 = 0 Then ' Auftrag\n        Set rst = db.OpenRecordset(\"SELECT TOP 1 * FROM tbl_VA_Auftragstamm;\")\n        With rst\n        'Add Kopfzeile leer tbl_VA_Auftragstamm\n            .AddNew\n                .fields(\"Auftrag\") = stObjekt\n                .fields(\"Dat_VA_Von\") = dtDatum\n                .fields(\"Dat_VA_Bis\") = dtDatum\n                .fields(\"Excel_Path\") = stPfad\n                .fields(\"Excel_Dateiname\") = stDateiname\n                .fields(\"Erst_von\") = \"System\"\n                .fields(\"Erst_am\") = Now()\n            .update\n            DoEvents\n            .Close\n        End With\n        Set rst = Nothing\n        ID = Nz(TMax(\"ID\", \"tbl_VA_Auftragstamm\"), 0)\n    End If\n    \nElse\n    bIDNeu = True\n    Set rst = db.OpenRecordset(\"SELECT TOP 1 * FROM tbl_VA_Auftragstamm;\")\n    With rst\n    'Add Kopfzeile leer tbl_VA_Auftragstamm\n        .AddNew\n            .fields(\"Auftrag\") = stObjekt\n            .fields(\"Dat_VA_Von\") = dtDatum\n            .fields(\"Dat_VA_Bis\") = dtDatum\n            .fields(\"Excel_Path\") = stPfad\n            .fields(\"Excel_Dateiname\") = stDateiname\n            .fields(\"Erst_von\") = \"System\"\n            .fields(\"Erst_am\") = Now()\n        .update\n        DoEvents\n        .Close\n    End With\n    Set rst = Nothing\n    ID = Nz(TMax(\"ID\", \"tbl_VA_Auftragstamm\"), 0)\n \n    'Add Kopfzeile leer tblZZZ_XL_Auftrag\n    Set rst = db.OpenRecordset(\"SELECT TOP 1 * FROM tblZZZ_XL_Auftrag;\")\n    With rst\n        ID = Nz(TMax(\"ID\", \"tblZZZ_XL_Auftrag\"), 0) + 1\n        .AddNew\n            .fields(\"ID\") = ID\n            .fields(\"Auftrag\") = stObjekt\n            .fields(\"DatumVonStr\") = stDatumvon\n            .fields(\"Dateipfad\") = stPfad\n            .fields(\"Dateiname\") = stDateiname\n            .fields(\"NeuImport\") = True\n            .fields(\"Erst_von\") = \"System\"\n            .fields(\"Erst_am\") = Now()\n        .update\n        .Close\n    End With\n    Set rst = Nothing\nEnd If\n\nSet rst1 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag;\")\nSet rst2 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_ZeitVorgabe;\")\nSet rst3 = db.OpenRecordset(\"SELECT * FROM tblZZZ_XL_Auftrag_MA_Einsatz;\")\n\n'########################################################################\n'  import in Temp-Tabellen\n'########################################################################\n    Cons_XL_Import_2 DateinamePfad, ID\n    DoEvents\n'########################################################################\n    \nrst1.Close\nrst2.Close\nrst3.Close\n\nSet rst1 = Nothing\nSet rst2 = Nothing\nSet rst3 = Nothing\n\n'########################################################################\n'  Berechnen der Übertragswerte der XL_Temp-Tabellen ...\n'########################################################################\n    bImportOK = Cons_XL_Import_3(ID)\n'########################################################################\n    \nCons_XL_Import_Einzel = ID\n\nEnd Function\n\n\nFunction Cons_XL_Import_3(ID As Long) As Boolean\n\nDim strLog As String\nDim strSQL As String\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.DatumVon = CDate([DatumvonStr]) WHERE (((Len(Trim(Nz([DatumVonStr]))))<>0) AND (tblZZZ_XL_Auftrag.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.DatumBis = CDate([DatumbisStr]) WHERE (((Len(Trim(Nz([DatumBisStr]))))<>0) AND (tblZZZ_XL_Auftrag.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.DatumBis = [Datumvon] WHERE (((Len(Trim(Nz([DatumBisStr]))))=0) AND (tblZZZ_XL_Auftrag.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.Auftraggeber_ID = fget_kunID(NZ([Auftraggeber])) WHERE ((tblZZZ_XL_Auftrag.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.TreffpZeit = CDate(CDbl([TreffpZeitStr])) WHERE (((Left(Trim(Nz([TreffpZeitStr])),2))='0,') AND (tblZZZ_XL_Auftrag.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.TreffpOrt = [TreffpOrtstr] & ' ' & [TreffpZeitstr] WHERE (((Len(Trim(Nz([TreffpZeit]))))=0) AND ((Len(Trim(Nz([TreffpZeitstr]))))>0) AND (tblZZZ_XL_Auftrag.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.Std_satz_KD_1_Netto = Str(Nz([Std_satz_KD_1_Nettostr])), tblZZZ_XL_Auftrag.Std_satz_KD_3_Netto = Str(Nz([Std_satz_KD_3_Nettostr])), tblZZZ_XL_Auftrag.Std_Lohn_netto = Str(Nz([Std_Lohn_nettostr])), tblZZZ_XL_Auftrag.Fahrtkost_MA_Netto = Str(Nz([Fahrtkost_MA_Nettostr])), tblZZZ_XL_Auftrag.Fahrtkost_KD_Netto = Str(Nz([Fahrtkost_KD_Nettostr])) WHERE ((tblZZZ_XL_Auftrag.ID = \" & ID & \"));\")\n\nDateVervoll ID\n\nstrSQL = \"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.VA_Datum = CDate([VA_Datumstr]) WHERE (((Len(Trim(Nz([VA_Datumstr]))))<>0) AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\"\nCurrentDb.Execute (strSQL)\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Beginnstr = '0' & Mid([Beginnstr],2) WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Beginnstr = '0,0' WHERE ((Len(Trim(Nz([Beginnstr])))=0 OR tblZZZ_XL_Auftrag_MA_Einsatz.Beginnstr='1') AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Beginn = CDate(CDbl([Beginnstr])) WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Endestr = '0' & Mid([Endestr],2) WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Endestr = '0,0' WHERE ((Len(Trim(Nz([Endestr])))=0 OR tblZZZ_XL_Auftrag_MA_Einsatz.Endestr='1') AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Ende = CDate(CDbl([Endestr])) WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE qry_MA_ID INNER JOIN tblZZZ_XL_Auftrag_MA_Einsatz ON qry_MA_ID.NName = tblZZZ_XL_Auftrag_MA_Einsatz.Mitarbeiter SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID = [qry_MA_ID].[ID]  WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_NZug = 0 WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_NZug = 1 WHERE (((Len(Trim(Nz([Mitarbeiter]))))>0) AND ((tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID)=0) AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_NZug = 2 WHERE (((Len(Trim(Nz([Mitarbeiter]))))=0) AND ((tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID)=0) AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_PKWAnz = 0 WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_PKWAnz = 1 WHERE ((MA_PKW LIKE '*A*') AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_PKWAnz = [MA_PKWAnz]+Nz([MA_PKW],0) WHERE (((IsNumeric(Nz([MA_PKW],0)))=True) AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_Std = cdbl(Nz([MA_Stdstr],0)) WHERE ((IsNumeric(Nz([MA_Stdstr],0))=True) AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_Std = FA_Runden(timeberech_G([VA_Datum],[Beginn],[Ende])) WHERE (([MA_Std] = 0) AND (tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\n\n'-------------\n\nCurrentDb.Execute (\"INSERT INTO tblZZZ_XL_AnzTage ( VA_ID, VA_Datum, Anz_Soll ) SELECT tblZZZ_XL_Auftrag_MA_Einsatz.VA_ID, tblZZZ_XL_Auftrag_MA_Einsatz.VA_Datum, tblZZZ_XL_Auftrag_MA_Einsatz.ID AS Anz_Soll FROM tblZZZ_XL_Auftrag_MA_Einsatz WHERE ((tblZZZ_XL_Auftrag_MA_Einsatz.ID = \" & ID & \"));\")\n\nCurrentDb.Execute (\"INSERT INTO tblZZZ_XL_Start ( VA_ID, VA_Datum, Beginn, MinEnde, MaxEnde, Anz_MA ) SELECT VA_ID, VA_Datum, Beginn, MinvonEnde, MaxvonEnde, Anz_MA FROM qry_XL_Start_Add WHERE ((VA_ID = \" & ID & \"));\")\n\n\n\nCons_XL_Import_3 = True\n\nEnd Function\n\n\n\nFunction Cons_XL_Import_3_Test() As Boolean\n' UpdateArt 1 = Nur MA, Zeiten und PKW, d.h. Part 3 des Imports\n'           2 = 1 + Schichten d.h. Part 2 und 3 des Imports\n'           3 = 2 + Kopf  d.h. Alles - Kopf, Part 2 und 3 des Imports\n\nDim strLog As String\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.DatumVon = CDate([DatumvonStr]) WHERE (((Len(Trim(Nz([DatumVonStr]))))<>0) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.DatumBis = CDate([DatumbisStr]) WHERE (((Len(Trim(Nz([DatumBisStr]))))<>0) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.DatumBis = [Datumvon] WHERE (((Len(Trim(Nz([DatumBisStr]))))=0) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.Auftraggeber_ID = fget_kunID(NZ([Auftraggeber])) WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.TreffpZeit = CDate(CDbl([TreffpZeitStr])) WHERE (((Left(Trim(Nz([TreffpZeitStr])),2))='0,') AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.TreffpOrt = [TreffpOrtstr] & ' ' & [TreffpZeitstr] WHERE (((Len(Trim(Nz([TreffpZeit]))))=0) AND ((Len(Trim(Nz([TreffpZeitstr]))))>0) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag SET tblZZZ_XL_Auftrag.Std_satz_KD_1_Netto = Str(Nz([Std_satz_KD_1_Nettostr])), tblZZZ_XL_Auftrag.Std_satz_KD_3_Netto = Str(Nz([Std_satz_KD_3_Nettostr])), tblZZZ_XL_Auftrag.Std_Lohn_netto = Str(Nz([Std_Lohn_nettostr])), tblZZZ_XL_Auftrag.Fahrtkost_MA_Netto = Str(Nz([Fahrtkost_MA_Nettostr])), tblZZZ_XL_Auftrag.Fahrtkost_KD_Netto = Str(Nz([Fahrtkost_KD_Nettostr])) WHERE ((1=1));\")\n\nDateVervoll\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.VA_Datum = CDate([VA_Datumstr]) WHERE (((Len(Trim(Nz([VA_Datumstr]))))<>0) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Beginnstr = '0' & Mid([Beginnstr],2) WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Beginnstr = '0,0' WHERE ((Len(Trim(Nz([Beginnstr])))=0 OR tblZZZ_XL_Auftrag_MA_Einsatz.Beginnstr='1') AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Beginn = CDate(CDbl([Beginnstr])) WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Endestr = '0' & Mid([Endestr],2) WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Endestr = '0,0' WHERE ((Len(Trim(Nz([Endestr])))=0 OR tblZZZ_XL_Auftrag_MA_Einsatz.Endestr='1') AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.Ende = CDate(CDbl([Endestr])) WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE qry_MA_ID INNER JOIN tblZZZ_XL_Auftrag_MA_Einsatz ON qry_MA_ID.NName = tblZZZ_XL_Auftrag_MA_Einsatz.Mitarbeiter SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID = [qry_MA_ID].[ID]  WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_NZug = 0 WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_NZug = 1 WHERE (((Len(Trim(Nz([Mitarbeiter]))))>0) AND ((tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID)=0) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_NZug = 2 WHERE (((Len(Trim(Nz([Mitarbeiter]))))=0) AND ((tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID)=0) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_PKWAnz = 0 WHERE ((1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_PKWAnz = 1 WHERE ((MA_PKW LIKE '*A*') AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_PKWAnz = [MA_PKWAnz]+Nz([MA_PKW],0) WHERE (((IsNumeric(Nz([MA_PKW],0)))=True) AND ((1)=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_Std = cdbl(Nz([MA_Stdstr],0)) WHERE ((IsNumeric(Nz([MA_Stdstr],0))=True) AND (1=1));\")\n\nCurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz SET tblZZZ_XL_Auftrag_MA_Einsatz.MA_Std = FA_Runden(timeberech_G([VA_Datum],[Beginn],[Ende])) WHERE (([MA_Std] = 0) AND (1=1));\")\n\n\n\n'-------------\n\nCurrentDb.Execute (\"INSERT INTO tblZZZ_XL_AnzTage ( VA_ID, VA_Datum, Anz_Soll ) SELECT tblZZZ_XL_Auftrag_MA_Einsatz.VA_ID, tblZZZ_XL_Auftrag_MA_Einsatz.VA_Datum, tblZZZ_XL_Auftrag_MA_Einsatz.ID AS Anz_Soll FROM tblZZZ_XL_Auftrag_MA_Einsatz WHERE ((1=1));\")\n\nCurrentDb.Execute (\"INSERT INTO tblZZZ_XL_Start ( VA_ID, VA_Datum, Beginn, MinEnde, MaxEnde, Anz_MA ) SELECT VA_ID, VA_Datum, Beginn, MinvonEnde, MaxvonEnde, Anz_MA FROM qry_XL_Start_Add WHERE ((1=1));\")\n\n\n\nCons_XL_Import_3_Test = True\n\nEnd Function\n\nFunction fget_kunID(s As String) As Variant\nDim i As Long\nfget_kunID = 0\nIf Len(Trim(Nz(s))) > 0 Then\n    i = Nz(TLookup(\"kun_ID\", \"tbl_KD_Kundenstamm\", \"kun_Firma Like '*\" & s & \"*'\"))\nEnd If\nIf i = 0 Then\n    i = Nz(TLookup(\"kun_ID\", \"tbl_KD_Kundenstamm\", \"kun_Matchcode Like '*\" & s & \"*'\"))\nEnd If\n\nIf i > 0 Then fget_kunID = i\n\nEnd Function\n\n\nFunction Import_Teil2(ID As Long, bExists As Boolean)\n\nDim strSQL As String\n\n    strSQL = \"\"\n    strSQL = strSQL & \"INSERT INTO tbl_MA_VA_Zuordnung ( VA_ID, VADatum, VAStart_ID, VADatum_ID, PosNr, MA_ID, Bemerkungen, MA_Start, MA_Ende, PreisArt_ID, PKW_Anzahl )\"\n    strSQL = strSQL & \" SELECT tblZZZ_XL_Auftrag_MA_Einsatz.VA_ID, tblZZZ_XL_Auftrag_MA_Einsatz.VA_Datum, tbl_VA_Start.ID AS VAStart_ID, tbl_VA_Start.VADatum_ID, tblZZZ_XL_Auftrag_MA_Einsatz.VA_Lfd, tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID, \"\n    strSQL = strSQL & \" tblZZZ_XL_Auftrag_MA_Einsatz.Mitarbeiter, tblZZZ_XL_Auftrag_MA_Einsatz.Beginn, tblZZZ_XL_Auftrag_MA_Einsatz.Ende, 1 AS Ausdr1, tblZZZ_XL_Auftrag_MA_Einsatz.MA_PKWAnz\"\n    strSQL = strSQL & \" FROM tblZZZ_XL_Auftrag_MA_Einsatz INNER JOIN tbl_VA_Start ON (tbl_VA_Start.VA_Start = tblZZZ_XL_Auftrag_MA_Einsatz.Beginn) AND (tbl_VA_Start.VADatum = tblZZZ_XL_Auftrag_MA_Einsatz.VA_Datum) AND (tblZZZ_XL_Auftrag_MA_Einsatz.VA_ID = tbl_VA_Start.VA_ID)\"\n    strSQL = strSQL & \" WHERE (((tblZZZ_XL_Auftrag_MA_Einsatz.VA_ID)= \" & ID & \"));\"\n\n    If bExists = False Then   ' Neuer Auftrag\n    \n 'Neuer Auftrag\n '##############################\n ' Insert AnzTage\n        CurrentDb.Execute (\"INSERT INTO tbl_VA_AnzTage ( VA_ID, VADatum, TVA_Soll, TVA_Ist, PKW_Anzahl ) SELECT tblZZZ_XL_AnzTage.VA_ID, tblZZZ_XL_AnzTage.VA_Datum, tblZZZ_XL_AnzTage.Anz_Soll, 0 AS Ausdr1, 0 AS Ausdr2 FROM tblZZZ_XL_AnzTage WHERE (((tblZZZ_XL_AnzTage.VA_ID)= \" & ID & \"));\")\n ' Insert VA_Start\n        CurrentDb.Execute (\"INSERT INTO tbl_VA_Start ( VA_ID, VADatum, MA_Anzahl, VA_Start, VA_Ende ) SELECT tblZZZ_XL_Start.VA_ID, tblZZZ_XL_Start.VA_Datum, tblZZZ_XL_Start.Anz_MA, tblZZZ_XL_Start.Beginn, fTimeReuck([MinEnde],[MaxEnde]) AS Endez FROM tblZZZ_XL_Start WHERE (((tblZZZ_XL_Start.VA_ID)= \" & ID & \"));\")\n ' Update Ziel VA_Start mit ID von VA_Datum\n        CurrentDb.Execute (\"UPDATE tbl_VA_AnzTage INNER JOIN tbl_VA_Start ON (tbl_VA_Start.VADatum = tbl_VA_AnzTage.VADatum) AND (tbl_VA_AnzTage.VA_ID = tbl_VA_Start.VA_ID) SET tbl_VA_Start.VADatum_ID = [tbl_VA_AnzTage].[ID] WHERE (((tbl_VA_Start.VA_ID)= \" & ID & \"));\")\n ' Update Quelle  tblZZZ_XL_Auftrag_MA_Einsatz mit ID von VA_Datum und ID von VA_Start\n        CurrentDb.Execute (\"UPDATE tbl_VA_Start INNER JOIN tblZZZ_XL_Auftrag_MA_Einsatz ON (tbl_VA_Start.VA_Start = tblZZZ_XL_Auftrag_MA_Einsatz.Beginn) AND (tbl_VA_Start.VA_ID = tblZZZ_XL_Auftrag_MA_Einsatz.VA_ID) AND (tbl_VA_Start.VADatum = tblZZZ_XL_Auftrag_MA_Einsatz.VA_Datum) SET tblZZZ_XL_Auftrag_MA_Einsatz.VADatum_ID = [tbl_VA_Start].[VADatum_ID], tblZZZ_XL_Auftrag_MA_Einsatz.VAStart_ID = [tbl_VA_Start].[ID] WHERE (((tblZZZ_XL_Auftrag_MA_Einsatz.ID)= \" & ID & \"));\")\n        DoEvents\n                \n'Insert MA in tbl_MA_VA_Zuordnung\n        CurrentDb.Execute (strSQL)\n    \n    Else\n' Bestehender Auftrag\n'##############################\n'Update bestehende Zeiten\n        CurrentDb.Execute (\"UPDATE tblZZZ_XL_Auftrag_MA_Einsatz INNER JOIN tbl_MA_VA_Zuordnung ON (tblZZZ_XL_Auftrag_MA_Einsatz.VAStart_ID = tbl_MA_VA_Zuordnung.VAStart_ID) AND (tblZZZ_XL_Auftrag_MA_Einsatz.VADatum_ID = tbl_MA_VA_Zuordnung.VADatum_ID) AND (tblZZZ_XL_Auftrag_MA_Einsatz.MA_ID = tbl_MA_VA_Zuordnung.MA_ID) AND (tblZZZ_XL_Auftrag_MA_Einsatz.VA_ID = tbl_MA_VA_Zuordnung.VA_ID) SET tbl_MA_VA_Zuordnung.MA_Start = [Beginn], tbl_MA_VA_Zuordnung.MA_Ende = [Ende], tbl_MA_VA_Zuordnung.PKW_Anzahl = [MA_PKWAnz] WHERE (((tbl_MA_VA_Zuordnung.VA_ID)= \" & ID & \"));\")\n\n 'Wegen Unique Key nur Neue inserten, bestehende sollten den Unique Key verletzen\n        CurrentDb.Execute (strSQL)\n        \n'Auftragsstatus auf abgeschlossen setzen\n        CurrentDb.Execute (\"UPDATE tbl_VA_Auftragstamm SET tbl_VA_Auftragstamm.Veranst_Status_ID = 3 WHERE (((tbl_VA_Auftragstamm.ID)=\" & ID & \"));\")\n    \n    End If\n\nEnd Function"}
