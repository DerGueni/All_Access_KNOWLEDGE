{"id":"MOD_mdl_Maintainance","name":"mdl_Maintainance","kind":"standard","procedures":["Function f_Zuord_Korrektur()","Function f_Anfangs_Ende_Zeit_korrigieren()","Function f_Schicht_Tag_Anz_Ist_Korr(Optional bIstAutoFreigabe As Boolean = True)","Function f_KD_Adr_Korrektur()","Function f_MA_Adr_Korrektur()","Function fExcel_Vorlagen_Schreiben()"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n' 1. Schritt\nFunction f_Zuord_Korrektur()\n\nSleep 20\nDoEvents\n\n'Alle Zuordnungen ohne korrekte Schicht-Zuordnung löschen\nCall CurrentDb.Execute(\"Delete * FROM tbl_MA_VA_Zuordnung WHERE ID IN (SELECT Zuo_ID From qry_Falsche_Nr)\")\n'Alle Schichten ohne korrekte Zuordnung zu Tagen löschen\nCall CurrentDb.Execute(\"DELETE tbl_VA_AnzTage.ID, tbl_VA_Start.* FROM tbl_VA_Start LEFT JOIN tbl_VA_AnzTage ON tbl_VA_Start.VADatum_ID = tbl_VA_AnzTage.ID WHERE (((tbl_VA_AnzTage.ID) Is Null));\")\n\nSleep 20\nDoEvents\n\n'tbl_MA_NVerfuegZeiten: Korrektur der Zusatzwerte für Zeiten\nCall CurrentDb.Execute(\"qry_MA_NVerfueg_ZeitUpdate\")\n\nSleep 20\nDoEvents\n\n'tbl_MA_NVerfuegZeiten: Korrektur bei Mehrtagesabwesenheiten von Zeit auf 00:00 bis Zeit auf 23:59\nCall CurrentDb.Execute(\"qry_MA_NVerfueg_ZeitUpdate_2\")\n\nSleep 20\nDoEvents\n\n'fVA_AnzTage_Update\n'fVAUpd_AllSI\n\nEnd Function\n\n'2. Schritt\nFunction f_Anfangs_Ende_Zeit_korrigieren()\n\nCurrentDb.Execute (\"UPDATE tbl_MA_VA_Zuordnung SET tbl_MA_VA_Zuordnung.MVA_Start = Startzeit_G([VADatum],[MA_Start]);\")\nCurrentDb.Execute (\"UPDATE tbl_MA_VA_Planung SET tbl_MA_VA_Planung.MVA_Start = Startzeit_G([VADatum],[VA_Start]);\")\nCurrentDb.Execute (\"UPDATE tbl_VA_Start SET tbl_VA_Start.MVA_Start = Startzeit_G([VADatum],[VA_Start]);\")\n\nSleep 20\nDoEvents\n\nCurrentDb.Execute (\"UPDATE tbl_MA_VA_Zuordnung SET tbl_MA_VA_Zuordnung.MVA_Ende = Endezeit_G([VADatum],[MA_Start],[MA_Ende]);\")\nCurrentDb.Execute (\"UPDATE tbl_MA_VA_Planung SET tbl_MA_VA_Planung.MVA_Ende = Endezeit_G([VADatum],[VA_Start],[VA_Ende]);\")\nCurrentDb.Execute (\"UPDATE tbl_VA_Start SET tbl_VA_Start.MVA_Ende = Endezeit_G([VADatum],[VA_Start],[VA_Ende]);\")\n\nCurrentDb.Execute (\"UPDATE tbl_MA_VA_Planung SET tbl_MA_VA_Planung.VADatum = f_VAdat_Pl([VADatum_ID])\")\n\nCurrentDb.Execute (\"UPDATE tbl_MA_Mitarbeiterstamm SET tbl_MA_Mitarbeiterstamm.IstSubunternehmer = True, tbl_MA_Mitarbeiterstamm.Anstellungsart_ID = 11 WHERE (((tbl_MA_Mitarbeiterstamm.IstSubunternehmer)=True)) OR (((tbl_MA_Mitarbeiterstamm.Anstellungsart_ID)=11));\")\n\nSleep 20\nDoEvents\n\nEnd Function\n\n'3. Schritt - Ist Anzahl MA bei allen Schichten und Tagen\nFunction f_Schicht_Tag_Anz_Ist_Korr(Optional bIstAutoFreigabe As Boolean = True)\n\nDim strSQL As String\n\n' 1. Schritt\nf_Zuord_Korrektur\n\n'2. Schritt\nf_Anfangs_Ende_Zeit_korrigieren\n\n'qry_MA_Leere_Tageszusatzwerte_loeschen\nCurrentDb.Execute (\"qry_MA_Leere_Tageszusatzwerte_loeschen\")\n\n'Anzahl Ist MA pro Schicht\nIf table_exist(\"tbltmp_XXX_Schicht_Ist_Anz\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_Schicht_Ist_Anz\"\nDoEvents\n\nstrSQL = \"\"\nstrSQL = strSQL & \"SELECT tbl_MA_VA_Zuordnung.VAStart_ID, Count(tbl_MA_VA_Zuordnung.ID) AS AnzahlvonID INTO tbltmp_XXX_Schicht_Ist_Anz\"\nstrSQL = strSQL & \" FROM tbl_MA_VA_Zuordnung WHERE (((tbl_MA_VA_Zuordnung.MA_ID) > 0)) GROUP BY tbl_MA_VA_Zuordnung.VAStart_ID;\"\nCurrentDb.Execute (strSQL)\nDoEvents\n\n'tbl_VA_Start - Anazahl Ist pro Schicht Setzen\nstrSQL = \"\"\nstrSQL = \"UPDATE tbltmp_XXX_Schicht_Ist_Anz INNER JOIN tbl_VA_Start ON tbltmp_XXX_Schicht_Ist_Anz.VAStart_ID = tbl_VA_Start.ID SET tbl_VA_Start.MA_Anzahl_Ist = [AnzahlvonID];\"\nCurrentDb.Execute (strSQL)\nDoEvents\n\nIf table_exist(\"tbltmp_XXX_Schicht_Ist_Anz\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_Schicht_Ist_Anz\"\nDoEvents\n\nIf table_exist(\"tbltmp_XXX_Tag_Ist_Anz\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_Tag_Ist_Anz\"\nDoEvents\n\nstrSQL = \"\"\nstrSQL = strSQL & \"SELECT tbl_MA_VA_Zuordnung.VADatum_ID, Count(tbl_MA_VA_Zuordnung.ID) AS AnzahlvonID INTO tbltmp_XXX_Tag_Ist_Anz\"\nstrSQL = strSQL & \" FROM tbl_MA_VA_Zuordnung WHERE (((tbl_MA_VA_Zuordnung.MA_ID) > 0)) GROUP BY tbl_MA_VA_Zuordnung.VADatum_ID;\"\nCurrentDb.Execute (strSQL)\nDoEvents\n\n'tbl_VA_AnzTage - Anzahl Ist MA pro Tag\nstrSQL = \"\"\nstrSQL = \"UPDATE tbltmp_XXX_Tag_Ist_Anz INNER JOIN tbl_VA_AnzTage ON tbltmp_XXX_Tag_Ist_Anz.VADatum_ID = tbl_VA_AnzTage.ID SET tbl_VA_AnzTage.TVA_Ist = [AnzahlvonID];\"\nCurrentDb.Execute (strSQL)\nDoEvents\n\nIf table_exist(\"tbltmp_XXX_Tag_Ist_Anz\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_Tag_Ist_Anz\"\nDoEvents\n\n'Anzahl Soll MA pro Tag\nIf table_exist(\"tbltmp_XXX_Tag_Soll_Anz\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_Tag_Soll_Anz\"\nDoEvents\n\nstrSQL = \"\"\nstrSQL = strSQL & \"SELECT tbl_VA_Start.VADatum_ID, Sum(tbl_VA_Start.MA_Anzahl) AS SummevonMA_Anzahl INTO tbltmp_XXX_Tag_Soll_Anz\"\nstrSQL = strSQL & \" FROM tbl_VA_Start GROUP BY tbl_VA_Start.VADatum_ID;\"\nCurrentDb.Execute (strSQL)\nDoEvents\n\n'tbl_VA_AnzTage Auftrags Ist setzen\nstrSQL = \"\"\nstrSQL = \"UPDATE tbltmp_XXX_Tag_Soll_Anz INNER JOIN tbl_VA_AnzTage ON tbltmp_XXX_Tag_Soll_Anz.VADatum_ID = tbl_VA_AnzTage.ID SET tbl_VA_AnzTage.TVA_SOll = [SummevonMA_Anzahl];\"\nCurrentDb.Execute (strSQL)\nDoEvents\n'######################\n\nIf table_exist(\"tbltmp_XXX_Tag_Soll_Anz\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_Tag_Soll_Anz\"\nDoEvents\n\n'Auftrag pro Tag abgeschlossen\n'tbl_VA_AnzTage Auftrags Soll und Abgeschlossen setzen\n'Alle Aufträge mit Null als Soll auf \"0\" setzen\nCurrentDb.Execute (\"UPDATE tbl_VA_AnzTage SET tbl_VA_AnzTage.TVA_Soll = 0 WHERE (((tbl_VA_AnzTage.TVA_Soll) Is Null));\")\n\n'Alle Aufträge sind offen\nCurrentDb.Execute (\"UPDATE tbl_VA_AnzTage SET tbl_VA_AnzTage.TVA_Offen = True;\")\n\n'Alle Aufträge pro Tag auf geschlossen setzen, wenn ist - soll >= 0 und soll > 0\nCurrentDb.Execute (\"UPDATE tbl_VA_AnzTage SET tbl_VA_AnzTage.TVA_Offen = False WHERE (((tbl_VA_AnzTage.TVA_Soll)>0) AND ((Nz([TVA_Ist],0)-[TVA_Soll])>=0));\")\n'###################\n\n'tbltmp_XXX_Veranst_Status_Setzen\n\nIf table_exist(\"tbltmp_XXX_VA_Alle_Status\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_VA_Alle_Status\"\nDoEvents\n\nIf table_exist(\"tbltmp_XXX_VA_Alle_Status_Aus_Tag\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_VA_Alle_Status_Aus_Tag\"\nDoEvents\n\n'Temp Tabelle Auftrag erzeugen\nCurrentDb.Execute (\"SELECT tbl_VA_Auftragstamm.ID, tbl_VA_Auftragstamm.Veranst_Status_ID, 1 AS Status_Soll, 0 AS Status_Zeit INTO tbltmp_XXX_VA_Alle_Status FROM tbl_VA_Auftragstamm;\")\nDoEvents\n\n'Temp Tabelle Auftrag mit nur abgeschlossenen Schichten erzeugen\nCurrentDb.Execute (\"SELECT tbl_VA_AnzTage.VA_ID, Sum(tbl_VA_AnzTage.TVA_Offen) AS SummevonTVA_Offen INTO tbltmp_XXX_VA_Alle_Status_Aus_Tag FROM tbl_VA_AnzTage GROUP BY tbl_VA_AnzTage.VA_ID HAVING (((Sum(tbl_VA_AnzTage.TVA_Offen))=0));\")\nDoEvents\n\n'Temp Tabelle Auftrag Update abgeschlossene Schichten\nCurrentDb.Execute (\"UPDATE tbltmp_XXX_VA_Alle_Status_Aus_Tag INNER JOIN tbltmp_XXX_VA_Alle_Status ON tbltmp_XXX_VA_Alle_Status_Aus_Tag.VA_ID = tbltmp_XXX_VA_Alle_Status.ID SET tbltmp_XXX_VA_Alle_Status.Status_Soll = 2;\")\nDoEvents\n\n'Temp Tabelle Auftrag Update auf abgeschlossene Zeiten setzen, wenn Schichten abgeschlossen\nCurrentDb.Execute (\"UPDATE tbltmp_XXX_VA_Alle_Status INNER JOIN tbl_MA_VA_Zuordnung ON tbltmp_XXX_VA_Alle_Status.ID = tbl_MA_VA_Zuordnung.VA_ID SET tbltmp_XXX_VA_Alle_Status.Status_Zeit = 3 WHERE (((tbltmp_XXX_VA_Alle_Status.Status_Soll)=2) AND ((Len(Trim(Nz([MA_Ende]))))>0));\")\nDoEvents\n\n'Temp Tabelle - Verhindern, dass Aufträge freigegeben werden, bei denen kein Auftraggeber eingetragen ist.\nCurrentDb.Execute (\"UPDATE tbltmp_XXX_VA_Alle_Status INNER JOIN tbl_VA_Auftragstamm ON tbltmp_XXX_VA_Alle_Status.ID = tbl_VA_Auftragstamm.ID SET tbltmp_XXX_VA_Alle_Status.Status_Zeit = 0 WHERE (((tbltmp_XXX_VA_Alle_Status.Status_Zeit)=3) AND ((Nz(tbl_VA_Auftragstamm.Veranstalter_ID,0)=0)));\")\nDoEvents\n\n'Temp Tabelle - Verhindern, dass Aufträge freigegeben werden, bei denen noch nicht alle Zeiten gesetzt sind\nCurrentDb.Execute (\"UPDATE tbltmp_XXX_VA_Alle_Status INNER JOIN tbl_MA_VA_Zuordnung ON tbltmp_XXX_VA_Alle_Status.ID = tbl_MA_VA_Zuordnung.VA_ID SET tbltmp_XXX_VA_Alle_Status.Status_Zeit = 0 WHERE (((Len(Trim(Nz([MA_Start]))))=0) AND ((tbltmp_XXX_VA_Alle_Status.Status_Zeit)=3)) OR (((Len(Trim(Nz([MA_Ende]))))=0) AND ((tbltmp_XXX_VA_Alle_Status.Status_Zeit)=3));\")\nDoEvents\n\n'Temp Tabelle - Verhindern, dass Aufträge freigegeben werden, bei denen noch nicht alle Tage in der Vergangenheit liegen\nCurrentDb.Execute (\"UPDATE tbl_VA_AnzTage INNER JOIN tbltmp_XXX_VA_Alle_Status ON tbl_VA_AnzTage.VA_ID = tbltmp_XXX_VA_Alle_Status.ID SET tbltmp_XXX_VA_Alle_Status.Status_Zeit = 0 WHERE (((tbl_VA_AnzTage.VADatum)>=Date()));\")\nDoEvents\n\n'Update tbl_VA_Auftragstamm\n'Auftrag auf Status 1 'in Planung' bzw 2 'abgeschlossen' setzen\nCurrentDb.Execute (\"UPDATE tbl_VA_Auftragstamm INNER JOIN tbltmp_XXX_VA_Alle_Status ON tbl_VA_Auftragstamm.ID = tbltmp_XXX_VA_Alle_Status.ID SET tbl_VA_Auftragstamm.Veranst_Status_ID = [Status_Soll] WHERE (((tbl_VA_Auftragstamm.Veranst_Status_ID)<4));\")\nDoEvents\n\n'Update tbl_VA_Auftragstamm\n'Wenn Auto-Freigabe erfolgen soll, alle abgeschlossenen Aufträge auf 'Freigabe' setzen, wenn alle Zeiten gefüllt UND der Auftraggeber gesetzt ist\nIf bIstAutoFreigabe Then\n    CurrentDb.Execute (\"UPDATE tbl_VA_Auftragstamm INNER JOIN tbltmp_XXX_VA_Alle_Status ON tbl_VA_Auftragstamm.ID = tbltmp_XXX_VA_Alle_Status.ID SET tbl_VA_Auftragstamm.Veranst_Status_ID = [Status_Zeit] WHERE (((tbl_VA_Auftragstamm.Veranst_Status_ID)<4) AND ((tbltmp_XXX_VA_Alle_Status.Status_Zeit)=3));\")\n    DoEvents\nEnd If\n'##########################\n\nIf table_exist(\"tbltmp_XXX_VA_Alle_Status\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_VA_Alle_Status\"\nDoEvents\n'\nIf table_exist(\"tbltmp_XXX_VA_Alle_Status_Aus_Tag\") Then DoCmd.DeleteObject acTable, \"tbltmp_XXX_VA_Alle_Status_Aus_Tag\"\nDoEvents\n\nMsgBox \" Alle Auftragsstati < 4 korrigiert, d.h. 'Planung' 'Vollständig Disponiert' und 'Abgeschlossen' (nur wenn gewünscht) wurden gesetzt\"\n\nEnd Function\n\nFunction f_KD_Adr_Korrektur()\n'qry_KD_Adresse_Korr\nDim db As DAO.Database\nDim rst As DAO.Recordset\n\nDim s As String\nDim s1 As String\n\n'qry_KD_Adresse_Korr\n'Field Name\n'==========\n' 0            kun_Id         4            Long Integer\n' 1            kun_Firma      10           Text\n' 2            kun_Bezeichnung              10           Text\n' 3            adr_Name1      10           Text\n' 4            kun_Strasse    10           Text\n' 5            kun_PLZ        10           Text\n' 6            kun_Ort        10           Text\n' 7            kun_BriefKopf  12           Memo\n' 8            kun_LKZ        10           Text\n' 9            Landesname_deu               10           Text\n\nSet db = CurrentDb\nSet rst = db.OpenRecordset(\"qry_KD_Adresse_Korr\")\nWith rst\n    Do Until .EOF\n        .Edit\n            s = .fields(\"kun_Firma\")\n            s1 = Nz(.fields(\"kun_Bezeichnung\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & vbCrLf & s1\n            End If\n            s1 = Nz(.fields(\"adr_Name1\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & vbCrLf & s1\n            End If\n            s1 = Nz(.fields(\"kun_Strasse\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & vbCrLf & s1 & vbCrLf\n            End If\n            s1 = Nz(.fields(\"kun_PLZ\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & vbCrLf & s1 & \" \"\n            End If\n            s1 = Nz(.fields(\"kun_Ort\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & s1\n            End If\n            s1 = Nz(.fields(\"kun_LKZ\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                If UCase(s1) <> \"DE\" Then\n                    s1 = Nz(.fields(\"Landesname_deu\"))\n                    If Len(Trim(Nz(s1))) > 0 Then\n                        s = s & vbCrLf & s1 & \" \"\n                    End If\n                End If\n            End If\n            .fields(\"kun_BriefKopf\").Value = s\n        .update\n        .MoveNext\n    Loop\n    .Close\nEnd With\nSet rst = Nothing\nMsgBox \"Briefköpfe der Kunden wurden aktualisiert\"\n\nEnd Function\n\nFunction f_MA_Adr_Korrektur()\nDim db As DAO.Database\nDim rst As DAO.Recordset\n\nDim s As String\nDim s1 As String\nDim s2 As String\n\n'qry_MA_Adresskorrektur\n'Field Name\n'==========\n' 0            ID             4            Long Integer\n' 1            Anr            10           Text\n' 2            Name           10           Text\n' 3            Strasse        10           Text\n' 4            Nr             10           Text\n' 5            PLZOrt         10           Text\n' 6            Briefkopf      12           Memo\n'==========\nSet db = CurrentDb\nSet rst = db.OpenRecordset(\"qry_MA_Adresskorrektur\")\nWith rst\n    Do Until .EOF\n        .Edit\n            s = Nz(.fields(\"Anr\"))\n            s1 = Nz(.fields(\"Name\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & vbCrLf & s1\n            End If\n            s2 = Nz(.fields(\"Nr\"))\n            s1 = Nz(.fields(\"Strasse\"))\n            If Len(Trim(Nz(s2))) > 0 And Len(Trim(Nz(s1))) > 0 Then\n                If Right(s1, Len(s2)) = s2 Then s2 = \"\"\n            End If\n            s1 = s1 + \" \" + s2\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & vbCrLf & s1\n            End If\n            s1 = Nz(.fields(\"PLZOrt\"))\n            If Len(Trim(Nz(s1))) > 0 Then\n                s = s & vbCrLf & vbCrLf & s1\n            End If\n            .fields(\"BriefKopf\").Value = s\n        .update\n        .MoveNext\n    Loop\n    .Close\nEnd With\nSet rst = Nothing\nMsgBox \"Briefköpfe der Mitarbeiter wurden aktualisiert\"\n\nEnd Function\n\n\n\n\nFunction fExcel_Vorlagen_Schreiben()\n\nDim sysPfad As String\nDim DocPfad As String\nDim DocVorlage As String\n\nDim strSQL As String\n\nDocPfad = Get_Priv_Property(\"prp_CONSYS_GrundPfad\") & Nz(TLookup(\"Pfad\", \"_tblEigeneFirma_Pfade\", \"ID = 12\"))\nDocVorlage = DocPfad & \"VORLAGE_EINSATZLISTE.xls\"\nCall BinExport(\"___Vorlagen_einlesen\", DocVorlage, \"Picture\", 9)\nCall Set_Priv_Property(\"prp_XL_DocVorlage\", DocVorlage)\n\nSleep 20\nDoEvents\n\nDocPfad = Get_Priv_Property(\"prp_CONSYS_GrundPfad\") & Nz(TLookup(\"Pfad\", \"_tblEigeneFirma_Pfade\", \"ID = 12\"))\nDocVorlage = DocPfad & \"Vorlage_Dienstplanübersicht_Objekte.xls\"\nCall BinExport(\"___Vorlagen_einlesen\", DocVorlage, \"Picture\", 12)\nCall Set_Priv_Property(\"prp_XL_DienstObjVorlage\", DocVorlage)\n\nSleep 20\nDoEvents\n\nDocPfad = Get_Priv_Property(\"prp_CONSYS_GrundPfad\") & Nz(TLookup(\"Pfad\", \"_tblEigeneFirma_Pfade\", \"ID = 12\"))\nDocVorlage = DocPfad & \"Vorlage_Dienstplanübersicht_MA.xls\"\nCall BinExport(\"___Vorlagen_einlesen\", DocVorlage, \"Picture\", 11)\nCall Set_Priv_Property(\"prp_XL_DienstMAVorlage\", DocVorlage)\n\nSleep 20\nDoEvents\n\nDocPfad = Get_Priv_Property(\"prp_CONSYS_GrundPfad\") & Nz(TLookup(\"Pfad\", \"_tblEigeneFirma_Pfade\", \"ID = 12\"))\nDocVorlage = DocPfad & \"Vorlage_Dienstplan_Mitarbeiter_einzeln_pro_KW.xls\"\nCall BinExport(\"___Vorlagen_einlesen\", DocVorlage, \"Picture\", 13)\nCall Set_Priv_Property(\"prp_XL_DienstMAVorlage_Einzel\", DocVorlage)\n\nSleep 20\nDoEvents\n\nEnd Function"}
