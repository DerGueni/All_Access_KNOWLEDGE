{"id":"MOD_mod_N_Messezettel","name":"mod_N_Messezettel","kind":"standard","procedures":["Public Function FuelleMessezettel(AuftragsID As Long) As Boolean","Private Function FuelleMessezettel_Intern(AuftragsID As Long, NurMarkierte As Boolean) As Boolean","Private Function ExtrahiereStandnummerAusBemerkungen(Bemerkungen As String) As String","Private Function FindePDF_NachDatumUndStand(AuftragsDatum As Date, Standnummer As String) As String","Private Sub ErstelleBackup(pdfPfad As String)"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"'Attribute VB_Name = \"mod_N_Messezettel\"\n' ========================================\n' CONSEC Messezettel - FINAL VERSION\n' ========================================\n' - Sicherere MsgBox\n' - Auswahl wird automatisch zurückgesetzt\n' - Alte Stempel werden überschrieben\n' ========================================\n\nOption Compare Database\nOption Explicit\n\nPrivate Const PDF_ORDNER As String = \"\\\\vConSYS01-NBG\\Consys\\CONSEC\\CONSEC PLANUNG AKTUELL\\D - Messezettel\"\nPrivate Const PYTHON_SCRIPT As String = \"\\\\vConSYS01-NBG\\Consys\\CONSEC\\CONSEC PLANUNG AKTUELL\\D - Messezettel\\pdf_stempel.py\"\n\n\nPublic Function FuelleMessezettel(AuftragsID As Long) As Boolean\n    Dim intAntwort As Integer\n    \n    intAntwort = MsgBox(\"Nur ausgewählte Standwachen bearbeiten?\", vbYesNoCancel + vbQuestion, \"Auswahl bestätigen\")\n\n    Select Case intAntwort\n        Case vbYes\n            FuelleMessezettel = FuelleMessezettel_Intern(AuftragsID, True)\n        Case vbNo\n            FuelleMessezettel = FuelleMessezettel_Intern(AuftragsID, False)\n        Case vbCancel\n            FuelleMessezettel = False\n    End Select\nEnd Function\n\n\nPrivate Function FuelleMessezettel_Intern(AuftragsID As Long, NurMarkierte As Boolean) As Boolean\n    \n    Dim db As DAO.Database\n    Dim rs As DAO.Recordset\n    Dim rsDatum As DAO.Recordset\n    Dim rsMA As DAO.Recordset\n    \n    Dim dictPDFs As Object\n    Set dictPDFs = CreateObject(\"Scripting.Dictionary\")\n    \n    Dim strMitarbeiterVorname As String\n    Dim strMitarbeiterNachname As String\n    Dim strMitarbeiterName As String\n    Dim strStandnummer As String\n    Dim strBemerkungen As String\n    Dim datArbeitsdatum As Date\n    Dim lngVADatumID As Long\n    Dim lngMAID As Long\n    Dim strPDFPfad As String\n    Dim strCommand As String\n    Dim strSQL As String\n    \n    Dim intErfolg As Integer, intFehler As Integer\n    Dim arrMA() As String\n    Dim vKey As Variant, arrMitarbeiter As Variant\n    \n    On Error GoTo Err_Handler\n    \n    Debug.Print \"=== START \" & IIf(NurMarkierte, \"(NUR MARKIERTE)\", \"(ALLE)\") & \" ===\"\n    Debug.Print \"Auftrag: \" & AuftragsID\n    Debug.Print \"\"\n    \n    Set db = CurrentDb\n    intErfolg = 0: intFehler = 0\n    \n    ' === SQL AUFBAUEN ===\n    strSQL = \"SELECT MA_ID, VADatum_ID, Bemerkungen FROM tbl_MA_VA_Zuordnung \" & _\n             \"WHERE VA_ID = \" & AuftragsID\n    \n    If NurMarkierte Then\n        strSQL = strSQL & \" AND Auswahl = True\"\n    End If\n    \n    Set rs = db.OpenRecordset(strSQL, dbOpenSnapshot)\n    \n    If rs.EOF Then\n        If NurMarkierte Then\n            MsgBox \"Keine markierten Standwachen gefunden!\" & vbCrLf & vbCrLf & _\n                   \"Bitte setzen Sie bei den gewünschten Standwachen\" & vbCrLf & _\n                   \"das Feld 'Auswahl' auf Ja.\", vbExclamation, \"Keine Auswahl\"\n        Else\n            MsgBox \"Keine Mitarbeiter gefunden!\", vbExclamation\n        End If\n        rs.Close: Set rs = Nothing: Set db = Nothing\n        FuelleMessezettel_Intern = False\n        Exit Function\n    End If\n    \n    Debug.Print \"=== SAMMLE MITARBEITER PRO PDF ===\"\n    Debug.Print \"\"\n    \n    ' === JEDEN MA VERARBEITEN ===\n    Do While Not rs.EOF\n        \n        lngMAID = Nz(rs!MA_ID, 0)\n        lngVADatumID = Nz(rs!VADatum_ID, 0)\n        strBemerkungen = Trim(Nz(rs!Bemerkungen, \"\"))\n        \n        If lngMAID > 0 And lngVADatumID > 0 And Len(strBemerkungen) > 0 Then\n            \n            Set rsDatum = db.OpenRecordset( _\n                \"SELECT VADatum FROM tbl_VA_AnzTage WHERE [ID] = \" & lngVADatumID, _\n                dbOpenSnapshot)\n            \n            If Not rsDatum.EOF Then\n                datArbeitsdatum = rsDatum!VADatum\n                rsDatum.Close: Set rsDatum = Nothing\n                \n                Set rsMA = db.OpenRecordset( _\n                    \"SELECT Vorname, Nachname FROM tbl_MA_Mitarbeiterstamm WHERE [ID] = \" & lngMAID, _\n                    dbOpenSnapshot)\n                \n                If Not rsMA.EOF Then\n                    strMitarbeiterVorname = Trim(Nz(rsMA!Vorname, \"\"))\n                    strMitarbeiterNachname = Trim(Nz(rsMA!Nachname, \"\"))\n                    rsMA.Close: Set rsMA = Nothing\n                    \n                    ' OHNE KOMMA\n                    strMitarbeiterName = strMitarbeiterNachname & \" \" & strMitarbeiterVorname\n                    strStandnummer = ExtrahiereStandnummerAusBemerkungen(strBemerkungen)\n                    \n                    Debug.Print \"MA: \" & strMitarbeiterName\n                    Debug.Print \"  Datum: \" & Format(datArbeitsdatum, \"dd.mm.yyyy\")\n                    Debug.Print \"  Stand: \" & strStandnummer\n                    \n                    If Len(strStandnummer) > 0 Then\n                        \n                        strPDFPfad = FindePDF_NachDatumUndStand(datArbeitsdatum, strStandnummer)\n                        \n                        If Len(strPDFPfad) > 0 Then\n                            \n                            Debug.Print \"  PDF: \" & Dir(strPDFPfad)\n                            \n                            If dictPDFs.exists(strPDFPfad) Then\n                                arrMA = dictPDFs(strPDFPfad)\n                                If UBound(arrMA) < 1 Then\n                                    ReDim Preserve arrMA(UBound(arrMA) + 1)\n                                    arrMA(UBound(arrMA)) = strMitarbeiterName\n                                    dictPDFs(strPDFPfad) = arrMA\n                                    Debug.Print \"  -> Pos \" & UBound(arrMA) + 1\n                                Else\n                                    Debug.Print \"  ! Max 2 MA\"\n                                End If\n                            Else\n                                ReDim arrMA(0)\n                                arrMA(0) = strMitarbeiterName\n                                dictPDFs.Add strPDFPfad, arrMA\n                                Debug.Print \"  -> Pos 1\"\n                            End If\n                        Else\n                            Debug.Print \"  ! Kein PDF\"\n                        End If\n                    Else\n                        Debug.Print \"  ! Kein Stand\"\n                    End If\n                    Debug.Print \"\"\n                Else\n                    If Not rsMA Is Nothing Then rsMA.Close: Set rsMA = Nothing\n                End If\n            Else\n                If Not rsDatum Is Nothing Then rsDatum.Close: Set rsDatum = Nothing\n            End If\n        End If\n        \n        rs.MoveNext\n    Loop\n    \n    rs.Close: Set rs = Nothing\n    \n    Debug.Print \"=== BEARBEITE PDFs ===\"\n    Debug.Print \"\"\n    \n    ' === PDFs BEARBEITEN ===\n    For Each vKey In dictPDFs.Keys\n        \n        strPDFPfad = CStr(vKey)\n        arrMitarbeiter = dictPDFs(vKey)\n        \n        Debug.Print \"PDF: \" & Dir(strPDFPfad)\n        Debug.Print \"  MA: \" & UBound(arrMitarbeiter) + 1\n        \n        Call ErstelleBackup(strPDFPfad)\n        \n        ' COMMAND MIT SAUBEREN QUOTES\n        If UBound(arrMitarbeiter) = 0 Then\n            Debug.Print \"  1. \" & arrMitarbeiter(0)\n            ' NUR 1 MITARBEITER\n            strCommand = \"python \"\"\" & PYTHON_SCRIPT & \"\"\" \"\"\" & _\n                         strPDFPfad & \"\"\" \"\"\" & strPDFPfad & \"\"\" \"\"\" & _\n                         Replace(arrMitarbeiter(0), \"\"\"\", \"\"\"\"\"\") & \"\"\" 1\"\n        Else\n            Debug.Print \"  1. \" & arrMitarbeiter(0)\n            Debug.Print \"  2. \" & arrMitarbeiter(1)\n            ' 2 MITARBEITER\n            strCommand = \"python \"\"\" & PYTHON_SCRIPT & \"\"\" \"\"\" & _\n                         strPDFPfad & \"\"\" \"\"\" & strPDFPfad & \"\"\" \"\"\" & _\n                         Replace(arrMitarbeiter(0), \"\"\"\", \"\"\"\"\"\") & \"\"\" \"\"\" & _\n                         Replace(arrMitarbeiter(1), \"\"\"\", \"\"\"\"\"\") & \"\"\"\"\n        End If\n        \n        Debug.Print \"  CMD: \" & strCommand\n        \n        Dim objShell As Object\n        Set objShell = CreateObject(\"WScript.Shell\")\n        Dim intResult As Integer\n        intResult = objShell.Run(strCommand, 0, True)\n        Set objShell = Nothing\n        \n        If intResult = 0 Then\n            Debug.Print \"  OK\"\n            intErfolg = intErfolg + 1\n        Else\n            Debug.Print \"  Fehler (Code: \" & intResult & \")\"\n            intFehler = intFehler + 1\n        End If\n        Debug.Print \"\"\n    Next vKey\n    \n    ' === AUSWAHL ZURÜCKSETZEN ===\n    If NurMarkierte And intErfolg > 0 Then\n        Debug.Print \"=== SETZE AUSWAHL ZURÜCK ===\"\n        db.Execute \"UPDATE tbl_MA_VA_Zuordnung SET Auswahl = False WHERE VA_ID = \" & AuftragsID & \" AND Auswahl = True\", dbFailOnError\n        Debug.Print \"Auswahl-Checkboxen zurückgesetzt\"\n        Debug.Print \"\"\n    End If\n    \n    Set db = Nothing\n    \n    Debug.Print \"=== ENDE ===\"\n    Debug.Print \"PDFs: \" & dictPDFs.Count\n    Debug.Print \"Erfolg: \" & intErfolg\n    Debug.Print \"Fehler: \" & intFehler\n    \n    Dim strMsg As String\n    strMsg = \"Fertig!\" & vbCrLf & vbCrLf\n    If NurMarkierte Then\n        strMsg = strMsg & \"Markierte Standwachen\" & vbCrLf\n    Else\n        strMsg = strMsg & \"Alle Standwachen\" & vbCrLf\n    End If\n    strMsg = strMsg & vbCrLf & _\n             \"PDFs bearbeitet: \" & dictPDFs.Count & vbCrLf & _\n             \"Erfolgreich: \" & intErfolg\n    \n    If intFehler > 0 Then\n        strMsg = strMsg & vbCrLf & \"Fehler: \" & intFehler\n    End If\n    \n   \n    \n    MsgBox strMsg, IIf(intFehler = 0, vbInformation, vbExclamation), \"Messezettel\"\n    \n    FuelleMessezettel_Intern = (intErfolg > 0)\n    Exit Function\n    \nErr_Handler:\n    Debug.Print \"FEHLER \" & err.Number & \": \" & err.description\n    MsgBox \"Fehler \" & err.Number & \": \" & err.description, vbCritical\n    On Error Resume Next\n    If Not rs Is Nothing Then rs.Close: Set rs = Nothing\n    If Not rsDatum Is Nothing Then rsDatum.Close: Set rsDatum = Nothing\n    If Not rsMA Is Nothing Then rsMA.Close: Set rsMA = Nothing\n    Set db = Nothing\n    FuelleMessezettel_Intern = False\nEnd Function\n\n\nPrivate Function ExtrahiereStandnummerAusBemerkungen(Bemerkungen As String) As String\n    Dim strHalle As String, strNummer As String, intPos As Integer\n    Dim i As Integer, strChar As String, strRest As String\n    intPos = InStr(1, Bemerkungen, \"Halle \", vbTextCompare)\n    If intPos = 0 Then: ExtrahiereStandnummerAusBemerkungen = \"\": Exit Function\n    strRest = Mid(Bemerkungen, intPos + 6)\n    strHalle = \"\"\n    For i = 1 To Len(strRest)\n        strChar = Mid(strRest, i, 1)\n        If strChar >= \"0\" And strChar <= \"9\" Then strHalle = strHalle & strChar Else Exit For\n    Next i\n    intPos = InStr(1, strRest, \"-\")\n    If intPos > 0 Then\n        strRest = Mid(strRest, intPos + 1): strNummer = \"\"\n        For i = 1 To Len(strRest)\n            strChar = Mid(strRest, i, 1)\n            If strChar >= \"0\" And strChar <= \"9\" Then strNummer = strNummer & strChar Else Exit For\n        Next i\n    End If\n    If Len(strHalle) > 0 And Len(strNummer) > 0 Then\n        ExtrahiereStandnummerAusBemerkungen = \"H\" & strHalle & \" \" & strNummer\n    Else\n        ExtrahiereStandnummerAusBemerkungen = \"\"\n    End If\nEnd Function\n\n\nPrivate Function FindePDF_NachDatumUndStand(AuftragsDatum As Date, Standnummer As String) As String\n    Dim strDatei As String, strDatum As String, arrDateien() As String, intAnzahl As Integer\n    strDatum = Format(AuftragsDatum, \"dd.mm.yyyy\")\n    strDatei = Dir(PDF_ORDNER & \"\\*.pdf\"): intAnzahl = 0\n    Do While Len(strDatei) > 0\n        If InStr(1, strDatei, strDatum, vbTextCompare) > 0 And _\n           InStr(1, strDatei, Standnummer, vbTextCompare) > 0 Then\n            intAnzahl = intAnzahl + 1: ReDim Preserve arrDateien(1 To intAnzahl)\n            arrDateien(intAnzahl) = strDatei\n        End If\n        strDatei = Dir()\n    Loop\n    If intAnzahl = 0 Then FindePDF_NachDatumUndStand = \"\" Else FindePDF_NachDatumUndStand = PDF_ORDNER & \"\\\" & arrDateien(1)\nEnd Function\n\n\nPrivate Sub ErstelleBackup(pdfPfad As String)\nOn Error Resume Next\n    Dim strBackup As String, strOrdner As String\n    strOrdner = PDF_ORDNER & \"\\Z - abgerechnet\"\n    If Dir(strOrdner, vbDirectory) = \"\" Then MkDir strOrdner\n    strBackup = strOrdner & \"\\\" & Replace(Dir(pdfPfad), \".pdf\", \"_backup_\" & Format(Now, \"yyyymmdd_hhnnss\") & \".pdf\")\n    FileCopy pdfPfad, strBackup\nOn Error GoTo 0\nEnd Sub\n\n"}
