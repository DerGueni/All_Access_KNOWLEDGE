{"id":"MOD_modAccessFE_Exporter","name":"modAccessFE_Exporter","kind":"standard","procedures":["Private Function EXPORT_BASE() As String","Private Sub EnsureDir(ByVal path As String)","Private Function JoinPath(base As String, subp As String) As String","Private Sub AppendExportError(kind As String, target As String, eno As Long, eds As String)","Private Sub WriteTextSafe(path As String, content As String)","Private Sub WriteText(path As String, content As String): WriteTextSafe path, content: End Sub","Private Sub WriteTextOrLog(path As String, content As String): WriteTextSafe path, content: End Sub","Private Sub WriteEmptyIfMissing(path As String, emptyJson As String)","Private Function ReadAllSafe(path As String, Optional timeoutMs As Long = 5000) As String","Private Function ReadAll(path As String) As String","Private Function SaveObjectAsTextToString(objType As AcObjectType, objName As String) As String","Private Function JsonEscape(ByVal s As String) As String","Private Function SafeId(prefix As String, objName As String) As String","Private Function BoolJson(v As Variant) As String: BoolJson = LCase$(CStr(CBool(v))):","Private Function NzStr(v As Variant) As String: If IsNull(v) Then NzStr = \"\" Else NzStr = CStr(v):","Private Function PropKV(k As String, v As Variant) As String","Private Function FieldTypeName(t As DAO.DataTypeEnum) As String","Private Function ChooseViewName(v As Variant) As String","Private Function EventJson(v As Variant) As String","Private Function GetEventSafe(obj As Object, propName As String) As Variant","Private Function GuessHandler(kind As String, formName As String, evt As String, Optional ctl As String = \"\") As String","Private Function CleanupName(n As String) As String","Private Function NextWord(s As String, startPos As Long) As String","Private Function ExtractSourcesFromSql(sql As String) As String","Private Function SqlSelectFields(sql As String) As String","Private Function SqlSources(sql As String) As String","Private Function MaskSensitive(s As String) As String","Private Function ParseConnectKV(s As String) As Object","Private Function NzObj(d As Object, key As String) As String","Private Function DetectSourceKind(connect As String) As String","Private Function ConnectSummary(connect As String) As String","Public Sub Export_AllPlus()","Private Sub Export_TablesFull(root As String)","Private Sub Export_Relations(root As String)","Private Sub Export_QueriesFull(root As String)","Private Sub Export_FormsFull(root As String)","Private Function Build_FormJsonFull(f As Form) As String","Private Function Build_ControlsJson(col As controls) As String","Private Function ControlJsonFull(c As control) As String","Private Function QuoteSplitSemicolon(s As String) As String","Private Function IsQueryName(src As String) As Boolean","Private Function MapSourceId(t As String, ref As String) As String","Private Function Build_SubformJson(f As Form) As String","Private Sub Export_ReportsFull(root As String)","Private Function Build_ReportJsonFull(r As Report) As String","Private Sub Export_MacrosFull(root As String)","Private Function MacroActionsFromXml(xml As String) As String","Private Sub AppendMacroAction(s As String, actionName As String, argName As String, ByRef out As String, ByRef first As Boolean)","Private Function ExtractXmlArg(block As String, argName As String) As String","Private Sub Export_ModulesFull(root As String)","Private Function ModuleText(modName As String) As String","Private Function ExtractCallsRich(src As String) As String","Private Function ExtractProcedures(src As String) As String","Private Function ExtractListQuoted(ByVal src As String, ByVal prefix As String, ByVal term As String) As String","Private Function ExtractSqlString(src As String, prefix As String) As String","Private Function ExtractDomainFunc(src As String, fname As String) As String","Private Sub Build_CrossRefs_Full(root As String)","Private Function Build_RS_Map_Forms() As String","Private Function Build_RS_Map_Reports() As String","Private Function Build_ControlSource_Map() As String","Private Function Build_VBA_Targets() As String","Private Function Build_EventHandlers_Map() As String","Private Sub Build_InvertedIndexes_Full(root As String)","Private Sub Export_Datasources(root As String)","Private Function IsTableName(Name As String) As Boolean","Private Function IsQueryName2(Name As String) As Boolean","Private Function GetJsonArray(sqlJson As String, prop As String) As String","Private Function JsonArrayToList(arrText As String) As Object","Private Sub ResolveQueryBaseSources(qName As String, ByRef accDict As Object, ByRef visited As Object)","Private Sub Build_DataLineage_Full(root As String)","Private Function Build_Query_Lineage() As String","Private Function Build_Form_Lineage() As String","Private Function Build_Report_Lineage() As String","Private Sub Build_Manifest_Full(root As String)","Private Function ListTablesIds() As String","Private Function ListQueriesIds() As String","Private Function ListAccessObjects(col As Object, prefix As String) As String","Public Sub Smoke_TestExport()"],"calls":{"DoCmd.OpenForm":["",""],"DoCmd.OpenReport":["",""],"DoCmd.RunSQL":[""],"CurrentDb.Execute":[") & "],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"'=========================== modAccessFE_Exporter.bas ========================\nOption Compare Database\nOption Explicit\n\n' ============================================================================\n'  ACCESS FE FULL EXPORTER (64-bit) – FINAL (v2.5)\n'  - Robustes I/O + Logging\n'  - Nie-leere Ordner durch Summary/Platzhalter\n'  - Module + CodeBehind + Makros (fehlertolerant)\n'  - SaveAsText nutzt ExportRoot\\__tmp\\\n'  - Fix: Index-Felder korrekt typisiert\n' ============================================================================\n\n'=========================== Pfad / Ordner ==================================\nPrivate Function EXPORT_BASE() As String\n    EXPORT_BASE = \"C:\\Users\\guenther.siegert\\Documents\\000_Consys_Eport_11_25\\\"\nEnd Function\n\nPrivate Sub EnsureDir(ByVal path As String)\n    On Error Resume Next\n    If Len(Dir(path, vbDirectory)) = 0 Then MkDir path\n    On Error GoTo 0\nEnd Sub\n\nPrivate Function JoinPath(base As String, subp As String) As String\n    If Right$(base, 1) <> \"\\\" Then base = base & \"\\\"\n    JoinPath = base & subp\nEnd Function\n\n'=========================== Logging / Schreiben =============================\nPrivate Sub AppendExportError(kind As String, target As String, eno As Long, eds As String)\n    On Error Resume Next\n    Dim root As String: root = EXPORT_BASE()\n    Dim logDir As String: logDir = JoinPath(root, \"99_logs\")\n    If Len(Dir(logDir, vbDirectory)) = 0 Then MkDir logDir\n    Dim flog As String: flog = JoinPath(logDir, \"export_errors.log\")\n    Dim f As Integer: f = FreeFile\n    Open flog For Append As #f\n    Print #f, Format(Now, \"yyyy-mm-dd hh:nn:ss\") & \" | \" & kind & \" | \" & target & \" | \" & eno & \" | \" & eds\n    Close #f\nEnd Sub\n\n' --- robuster Writer ---\nPrivate Sub WriteTextSafe(path As String, content As String)\n    On Error GoTo EH\n    Dim p As Long, folder As String, f As Integer\n    p = InStrRev(path, \"\\\")\n    If p > 0 Then\n        folder = Left$(path, p - 1)\n        If Len(Dir(folder, vbDirectory)) = 0 Then MkDir folder\n    End If\n    f = FreeFile\n    Open path For Output As #f\n    Print #f, content\n    Close #f\n    Exit Sub\nEH:\n    AppendExportError \"WRITE_FAIL\", path, err.Number, err.description\nEnd Sub\n\n' Kompat/Convenience\nPrivate Sub WriteText(path As String, content As String): WriteTextSafe path, content: End Sub\nPrivate Sub WriteTextOrLog(path As String, content As String): WriteTextSafe path, content: End Sub\nPrivate Sub WriteEmptyIfMissing(path As String, emptyJson As String)\n    On Error Resume Next\n    If Dir(path, vbNormal) <> \"\" Then Exit Sub\n    On Error GoTo 0\n    WriteTextSafe path, emptyJson\nEnd Sub\n\n'=========================== Robustes Lesen ==================================\n' Verhindert \"Einlesen hinter Dateiende\" (Err 62) durch Warten bis Datei > 0B\nPrivate Function ReadAllSafe(path As String, Optional timeoutMs As Long = 5000) As String\n    On Error GoTo EH\n    Dim Start As Single: Start = Timer\n    Do While True\n        If Dir(path, vbNormal) <> \"\" Then\n            If fileLen(path) > 0 Then\n                Dim fi As Integer: fi = FreeFile\n                Dim buf As String, line As String\n                buf = \"\"\n                Open path For Input As #fi\n                Do While Not EOF(fi)\n                    Line Input #fi, line\n                    If Len(buf) > 0 Then buf = buf & vbCrLf\n                    buf = buf & line\n                Loop\n                Close #fi\n                ReadAllSafe = buf\n                Exit Function\n            End If\n        End If\n        If (Timer - Start) * 1000 > timeoutMs Then Exit Do\n        DoEvents\n    Loop\n    ReadAllSafe = \"\"\n    Exit Function\nEH:\n    ReadAllSafe = \"\"\nEnd Function\n\n' Kompat-Name falls Altaufrufe existieren\nPrivate Function ReadAll(path As String) As String\n    ReadAll = ReadAllSafe(path)\nEnd Function\n\n' SaveAsText schreibt in ExportRoot\\__tmp\\ statt %TEMP%, danach robust lesen\nPrivate Function SaveObjectAsTextToString(objType As AcObjectType, objName As String) As String\n    On Error GoTo EH\n    Dim root As String: root = EXPORT_BASE()\n    Dim tmpDir As String: tmpDir = JoinPath(root, \"__tmp\")\n    EnsureDir tmpDir\n\n    Dim safe As String: safe = SafeId(\"TMP\", CStr(objType) & \"_\" & objName) & \".txt\"\n    Dim tmp As String: tmp = JoinPath(tmpDir, safe)\n\n    On Error Resume Next: Kill tmp: On Error GoTo 0\n\n    Application.SaveAsText objType, objName, tmp\n\n    Dim s As String: s = ReadAllSafe(tmp, 7000)\n\n    On Error Resume Next: Kill tmp: On Error GoTo 0\n\n    SaveObjectAsTextToString = s\n    Exit Function\nEH:\n    AppendExportError \"SAVEASTEXT_FAIL\", CStr(objType) & \":\" & objName, err.Number, err.description\n    SaveObjectAsTextToString = \"\"\nEnd Function\n\n'=========================== Utility / JSON =================================\nPrivate Function JsonEscape(ByVal s As String) As String\n    s = Replace(s, \"\\\", \"\\\\\")\n    s = Replace(s, \"\"\"\", \"\\\"\"\")\n    s = Replace(s, vbCrLf, \"\\n\")\n    s = Replace(s, vbCr, \"\\n\")\n    s = Replace(s, vbLf, \"\\n\")\n    JsonEscape = s\nEnd Function\n\nPrivate Function SafeId(prefix As String, objName As String) As String\n    Dim s As String\n    s = objName\n    s = Replace(s, \" \", \"\")\n    s = Replace(s, \"-\", \"_\")\n    s = Replace(s, \".\", \"_\")\n    s = Replace(s, \"/\", \"_\")\n    s = Replace(s, \"\\\", \"_\")\n    SafeId = prefix & \"_\" & s\nEnd Function\n\nPrivate Function BoolJson(v As Variant) As String: BoolJson = LCase$(CStr(CBool(v))):\n\nEnd Function\nPrivate Function NzStr(v As Variant) As String: If IsNull(v) Then NzStr = \"\" Else NzStr = CStr(v):\n\nEnd Function\nPrivate Function PropKV(k As String, v As Variant) As String\n    If IsNull(v) Then PropKV = \"\" Else PropKV = \",\"\"\" & k & \"\"\":\"\"\" & JsonEscape(CStr(v)) & \"\"\"\"\nEnd Function\n\n'=========================== Typen / Mapper =================================\nPrivate Function FieldTypeName(t As DAO.DataTypeEnum) As String\n    Select Case t\n        Case dbBoolean: FieldTypeName = \"BOOLEAN\"\n        Case dbByte: FieldTypeName = \"BYTE\"\n        Case dbInteger: FieldTypeName = \"INTEGER\"\n        Case dbLong: FieldTypeName = \"LONG\"\n        Case dbCurrency: FieldTypeName = \"CURRENCY\"\n        Case dbSingle: FieldTypeName = \"SINGLE\"\n        Case dbDouble: FieldTypeName = \"DOUBLE\"\n        Case dbDate: FieldTypeName = \"DATETIME\"\n        Case dbText: FieldTypeName = \"TEXT\"\n        Case dbLongBinary: FieldTypeName = \"LONGBINARY\"\n        Case dbMemo: FieldTypeName = \"MEMO\"\n        Case dbGUID: FieldTypeName = \"GUID\"\n        Case Else: FieldTypeName = \"OTHER\"\n    End Select\nEnd Function\n\nPrivate Function ChooseViewName(v As Variant) As String\n    Select Case v\n        Case 1: ChooseViewName = \"SingleForm\"\n        Case 2: ChooseViewName = \"ContinuousForms\"\n        Case 3: ChooseViewName = \"Datasheet\"\n        Case 4: ChooseViewName = \"SplitForm\"\n        Case Else: ChooseViewName = \"Other\"\n    End Select\nEnd Function\n\n'=========================== Event-Helper ===================================\nPrivate Function EventJson(v As Variant) As String\n    If VarType(v) = vbString Then\n        If v = \"[Event Procedure]\" Then\n            EventJson = \"{\"\"kind\"\":\"\"Procedure\"\",\"\"handler\"\":\"\"(auto)\"\"}\"\n        ElseIf Left$(v, 1) = \"=\" Then\n            EventJson = \"{\"\"kind\"\":\"\"Expression\"\",\"\"expression\"\":\"\"\" & JsonEscape(CStr(v)) & \"\"\"}\"\n        Else\n            EventJson = \"{\"\"kind\"\":\"\"Macro\"\",\"\"macro\"\":\"\"\" & JsonEscape(CStr(v)) & \"\"\"}\"\n        End If\n    Else\n        EventJson = \"null\"\n    End If\nEnd Function\n\nPrivate Function GetEventSafe(obj As Object, propName As String) As Variant\n    On Error Resume Next\n    GetEventSafe = CallByName(obj, propName, VbGet)\n    On Error GoTo 0\nEnd Function\n\nPrivate Function GuessHandler(kind As String, formName As String, evt As String, Optional ctl As String = \"\") As String\n    If kind = \"Form\" Then\n        GuessHandler = \"Form_\" & evt\n    Else\n        If Len(ctl) > 0 Then GuessHandler = ctl & \"_\" & evt Else GuessHandler = \"\"\n    End If\nEnd Function\n\n'=========================== SQL-Quellen/Felder ==============================\nPrivate Function CleanupName(n As String) As String\n    Dim s As String: s = n\n    s = Replace(s, \"[\", \"\")\n    s = Replace(s, \"]\", \"\")\n    s = Replace(s, \"$\", \"\")\n    s = Replace(s, \".\", \"_\")\n    CleanupName = Trim$(s)\nEnd Function\n\nPrivate Function NextWord(s As String, startPos As Long) As String\n    Dim i As Long, ch As String, acc As String\n    For i = startPos To Len(s)\n        ch = Mid$(s, i, 1)\n        If ch Like \"[a-z0-9_.$\\[\\]]\" Then\n            acc = acc & ch\n        ElseIf Len(acc) > 0 Then\n            Exit For\n        End If\n    Next i\n    NextWord = acc\nEnd Function\n\nPrivate Function ExtractSourcesFromSql(sql As String) As String\n    Dim s As String: s = \" \" & LCase$(sql) & \" \"\n    Dim tokens As Variant: tokens = Array(\" from \", \" join \", \" update \", \" into \", \" delete from \")\n    Dim found As New Collection\n    Dim i As Long, p As Long, n As String\n\n    On Error Resume Next\n    For i = LBound(tokens) To UBound(tokens)\n        p = 1\n        Do\n            p = InStr(p, s, tokens(i), vbTextCompare)\n            If p = 0 Then Exit Do\n            n = CleanupName(NextWord(s, p + Len(tokens(i))))\n            If Len(n) > 0 Then found.Add n, n\n            p = p + Len(tokens(i)) + 1\n        Loop\n    Next i\n    On Error GoTo 0\n\n    Dim out As String: out = \"[\"\n    Dim first As Boolean: first = True\n    Dim itm As Variant\n    For Each itm In found\n        If Not first Then out = out & \",\"\n        out = out & \"\"\"\" & JsonEscape(itm) & \"\"\"\"\n        first = False\n    Next itm\n    out = out & \"]\"\n    ExtractSourcesFromSql = out\nEnd Function\n\nPrivate Function SqlSelectFields(sql As String) As String\n    Dim ls As String: ls = LCase$(sql)\n    Dim p As Long, q As Long\n    p = InStr(1, ls, \"select \", vbTextCompare)\n    If p = 0 Then SqlSelectFields = \"[]\": Exit Function\n    q = InStr(p + 7, ls, \" from \", vbTextCompare)\n    If q = 0 Then SqlSelectFields = \"[]\": Exit Function\n\n    Dim segment As String\n    segment = Mid$(sql, p + 7, q - (p + 7))\n\n    Dim parts() As String: parts = Split(segment, \",\")\n    Dim i As Long, item As String\n    Dim out As String: out = \"[\"\n    Dim first As Boolean: first = True\n\n    For i = LBound(parts) To UBound(parts)\n        item = Trim$(parts(i))\n        If Len(item) = 0 Then GoTo NextI\n\n        Dim aliasName As String, expr As String\n        Dim asPos As Long: asPos = InStrRev(LCase$(item), \" as \")\n        If asPos > 0 Then\n            expr = Trim$(Left$(item, asPos - 1))\n            aliasName = Trim$(Mid$(item, asPos + 4))\n        Else\n            Dim tokens() As String: tokens = Split(item, \" \")\n            If UBound(tokens) >= 1 Then\n                aliasName = Trim$(tokens(UBound(tokens)))\n                expr = Trim$(Left$(item, Len(item) - Len(aliasName)))\n            Else\n                aliasName = CleanupName(item)\n                expr = item\n            End If\n        End If\n\n        If Not first Then out = out & \",\"\n        out = out & \"{\"\"alias\"\":\"\"\" & JsonEscape(aliasName) & \"\"\",\"\"expression\"\":\"\"\" & JsonEscape(expr) & \"\"\"}\"\n        first = False\nNextI:\n    Next i\n    out = out & \"]\"\n    SqlSelectFields = out\nEnd Function\n\nPrivate Function SqlSources(sql As String) As String\n    Dim srcs As String: srcs = ExtractSourcesFromSql(sql)\n    Dim fields As String: fields = SqlSelectFields(sql)\n    SqlSources = \"{\"\"raw\"\":\"\"\" & JsonEscape(sql) & \"\"\",\"\"sources\"\":\" & srcs & \",\"\"select_fields\"\":\" & fields & \"}\"\nEnd Function\n\n'=========================== Connect-Strings ================================\nPrivate Function MaskSensitive(s As String) As String\n    Dim parts() As String, i As Long, k As String, v As String, pair As String, out As String\n    If Len(s) = 0 Then MaskSensitive = s: Exit Function\n    parts = Split(s, \";\")\n    For i = LBound(parts) To UBound(parts)\n        pair = parts(i)\n        If InStr(pair, \"=\") > 0 Then\n            k = LCase$(Trim$(Left$(pair, InStr(pair, \"=\") - 1)))\n            v = Mid$(pair, InStr(pair, \"=\") + 1)\n            If k = \"pwd\" Or k = \"password\" Then v = \"****\"\n            If k = \"trusted_connection\" Then v = LCase$(v)\n            out = out & IIf(Len(out) > 0, \";\", \"\") & k & \"=\" & v\n        ElseIf Len(pair) > 0 Then\n            out = out & IIf(Len(out) > 0, \";\", \"\") & pair\n        End If\n    Next i\n    MaskSensitive = out\nEnd Function\n\nPrivate Function ParseConnectKV(s As String) As Object\n    Dim dict As Object: Set dict = CreateObject(\"Scripting.Dictionary\")\n    Dim parts() As String, i As Long, k As String, v As String, p As Long\n    parts = Split(s, \";\")\n    For i = LBound(parts) To UBound(parts)\n        p = InStr(parts(i), \"=\")\n        If p > 0 Then\n            k = LCase$(Trim$(Left$(parts(i), p - 1)))\n            v = Mid$(parts(i), p + 1)\n            If Not dict.exists(k) Then dict.Add k, v\n        End If\n    Next i\n    Set ParseConnectKV = dict\nEnd Function\n\nPrivate Function NzObj(d As Object, key As String) As String\n    On Error Resume Next\n    If d.exists(key) Then NzObj = CStr(d(key)) Else NzObj = \"\"\n    On Error GoTo 0\nEnd Function\n\nPrivate Function DetectSourceKind(connect As String) As String\n    Dim s As String: s = LCase$(connect)\n    If Len(s) = 0 Then DetectSourceKind = \"local\": Exit Function\n    If InStr(s, \"odbc;\") > 0 Then DetectSourceKind = \"odbc\": Exit Function\n    If InStr(s, \"oledb;\") > 0 Then DetectSourceKind = \"oledb\": Exit Function\n    If InStr(s, \"wss;\") > 0 Or InStr(s, \"sharepoint\") > 0 Then DetectSourceKind = \"sharepoint\": Exit Function\n    If InStr(s, \";database=\") > 0 And InStr(s, \"odbc;\") = 0 Then DetectSourceKind = \"access_file\": Exit Function\n    If InStr(s, \"excel\") > 0 Then DetectSourceKind = \"excel\": Exit Function\n    If InStr(s, \"text;\") > 0 Or InStr(s, \"text driver\") > 0 Then DetectSourceKind = \"text\": Exit Function\n    DetectSourceKind = \"other\"\nEnd Function\n\nPrivate Function ConnectSummary(connect As String) As String\n    Dim kind As String: kind = DetectSourceKind(connect)\n    Dim kv As Object: Set kv = ParseConnectKV(connect)\n    Dim obj As String: obj = \"{\"\"kind\"\":\"\"\" & kind & \"\"\"\"\n    obj = obj & \",\"\"raw_masked\"\":\"\"\" & JsonEscape(MaskSensitive(connect)) & \"\"\"\"\n    Select Case kind\n        Case \"odbc\"\n            obj = obj & \",\"\"dsn\"\":\"\"\" & JsonEscape(NzObj(kv, \"dsn\")) & \"\"\"\"\n            obj = obj & \",\"\"server\"\":\"\"\" & JsonEscape(NzObj(kv, \"server\")) & \"\"\"\"\n            obj = obj & \",\"\"database\"\":\"\"\" & JsonEscape(NzObj(kv, \"database\")) & \"\"\"\"\n            obj = obj & \",\"\"driver\"\":\"\"\" & JsonEscape(NzObj(kv, \"driver\")) & \"\"\"\"\n            obj = obj & \",\"\"trusted_connection\"\":\"\"\" & JsonEscape(NzObj(kv, \"trusted_connection\")) & \"\"\"\"\n        Case \"access_file\"\n            obj = obj & \",\"\"database_path\"\":\"\"\" & JsonEscape(NzObj(kv, \"database\")) & \"\"\"\"\n        Case \"excel\"\n            obj = obj & \",\"\"excel_info\"\":\"\"\" & JsonEscape(connect) & \"\"\"\"\n        Case \"text\"\n            obj = obj & \",\"\"text_info\"\":\"\"\" & JsonEscape(connect) & \"\"\"\"\n        Case \"sharepoint\", \"oledb\", \"other\"\n            obj = obj & \",\"\"info\"\":\"\"\" & JsonEscape(connect) & \"\"\"\"\n    End Select\n    obj = obj & \"}\"\n    ConnectSummary = obj\nEnd Function\n\n'=========================== MAIN ===========================================\nPublic Sub Export_AllPlus()\n    On Error GoTo CleanFail\n\n    AppendExportError \"TRACE\", \"Export_AllPlus\", 0, \"BEGIN\"\n\n    DoCmd.Echo False\n    DoCmd.SetWarnings False\n    Application.Echo False\n\n    Dim root As String: root = EXPORT_BASE()\n\n    EnsureDir root\n    EnsureDir JoinPath(root, \"00_manifest\")\n    EnsureDir JoinPath(root, \"10_tables\")\n    EnsureDir JoinPath(root, \"20_queries\")\n    EnsureDir JoinPath(root, \"30_forms\")\n    EnsureDir JoinPath(root, \"35_subforms\")\n    EnsureDir JoinPath(root, \"40_reports\")\n    EnsureDir JoinPath(root, \"50_macros\")\n    EnsureDir JoinPath(root, \"60_modules\")\n    EnsureDir JoinPath(root, \"70_relations\")\n    EnsureDir JoinPath(root, \"80_datasources\")\n    EnsureDir JoinPath(root, \"90_crossrefs\")\n    EnsureDir JoinPath(root, \"95_search\")\n    EnsureDir JoinPath(root, \"99_hashes\")\n    EnsureDir JoinPath(root, \"99_logs\")\n\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Tables\":      Export_TablesFull root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Relations\":   Export_Relations root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Queries\":     Export_QueriesFull root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Forms\":       Export_FormsFull root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Reports\":     Export_ReportsFull root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Macros\":      Export_MacrosFull root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Modules\":     Export_ModulesFull root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Datasources\": Export_Datasources root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"CrossRefs\":   Build_CrossRefs_Full root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"InvertedIdx\": Build_InvertedIndexes_Full root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Lineage\":     Build_DataLineage_Full root\n    AppendExportError \"TRACE\", \"STEP\", 0, \"Manifest\":    Build_Manifest_Full root\n\n    WriteTextOrLog JoinPath(root, \"99_hashes\\hashes.json\"), \"{\"\"note\"\":\"\"Run PowerShell to compute SHA-256\"\"}\"\n\n    ' Platzhalter erzwingen\n    WriteEmptyIfMissing JoinPath(root, \"00_manifest\\manifest.json\"), \"{}\"\n    WriteEmptyIfMissing JoinPath(root, \"50_macros\\_summary.json\"), \"{\"\"count\"\":0}\"\n    WriteEmptyIfMissing JoinPath(root, \"60_modules\\_summary.json\"), \"{\"\"standard_modules\"\":0,\"\"codebehind_modules\"\":0}\"\n    WriteEmptyIfMissing JoinPath(root, \"80_datasources\\datasources.json\"), \"[]\"\n    WriteEmptyIfMissing JoinPath(root, \"90_crossrefs\\XREF_recordsource_forms.json\"), \"{}\"\n    WriteEmptyIfMissing JoinPath(root, \"90_crossrefs\\XREF_recordsource_reports.json\"), \"{}\"\n    WriteEmptyIfMissing JoinPath(root, \"90_crossrefs\\XREF_control_sources.json\"), \"{}\"\n    WriteEmptyIfMissing JoinPath(root, \"90_crossrefs\\XREF_vba_targets.json\"), \"{}\"\n    WriteEmptyIfMissing JoinPath(root, \"90_crossrefs\\XREF_event_handlers.json\"), \"{}\"\n    WriteEmptyIfMissing JoinPath(root, \"95_search\\INV_field_to_table.json\"), \"{}\"\n    WriteEmptyIfMissing JoinPath(root, \"95_search\\INV_form_to_controls.json\"), \"{}\"\n\nCleanExit:\n    On Error Resume Next\n    Application.Echo True\n    DoCmd.SetWarnings True\n    DoCmd.Echo True\n    AppendExportError \"TRACE\", \"Export_AllPlus\", 0, \"END\"\n    On Error GoTo 0\n    MsgBox \"Export abgeschlossen: \" & root, vbInformation\n    Exit Sub\n\nCleanFail:\n    AppendExportError \"UNHANDLED\", \"Export_AllPlus\", err.Number, err.description\n    Resume CleanExit\nEnd Sub\n\n'=========================== TABLES & RELATIONS ==============================\nPrivate Sub Export_TablesFull(root As String)\n    Dim db As DAO.Database, td As DAO.TableDef, fld As DAO.field\n    Dim idx As DAO.Index, idxFld As DAO.field\n    Dim fields As String, indexes As String, props As String\n\n    Set db = CurrentDb\n\n    For Each td In db.TableDefs\n        If Left$(td.Name, 4) = \"MSys\" Then GoTo NextTable\n\n        Dim ID As String: ID = SafeId(\"TAB\", td.Name)\n\n        ' Felder\n        Dim first As Boolean: first = True\n        fields = \"[\"\n        For Each fld In td.fields\n            If Not first Then fields = fields & \",\"\n            fields = fields & \"{\"\"name\"\":\"\"\" & JsonEscape(fld.Name) & \"\"\",\"\"type\"\":\"\"\" & FieldTypeName(fld.Type) & \"\"\",\"\"required\"\":\" & BoolJson(Not fld.Required = False)\n            On Error Resume Next\n            If (fld.attributes And dbAutoIncrField) <> 0 Then fields = fields & \",\"\"auto_increment\"\":true\"\n            On Error GoTo 0\n            props = \"\"\n            On Error Resume Next\n            props = props & PropKV(\"DefaultValue\", fld.Properties(\"DefaultValue\"))\n            props = props & PropKV(\"ValidationRule\", fld.Properties(\"ValidationRule\"))\n            props = props & PropKV(\"ValidationText\", fld.Properties(\"ValidationText\"))\n            props = props & PropKV(\"Caption\", fld.Properties(\"Caption\"))\n            On Error GoTo 0\n            If Len(props) > 0 Then\n                If Left$(props, 1) = \",\" Then props = Mid$(props, 2)\n                fields = fields & \",\"\"properties\"\":{\" & props & \"}\"\n            End If\n            fields = fields & \"}\"\n            first = False\n        Next fld\n        fields = fields & \"]\"\n\n        ' Indizes (FIX: Index-Felder korrekt als DAO.Field)\n        indexes = \"[\"\n        first = True\n        For Each idx In td.indexes\n            If Not first Then indexes = indexes & \",\"\n            Dim flds As String: flds = \"[\"\n            Dim ixFirst As Boolean: ixFirst = True\n            For Each idxFld In idx.fields\n                If Not ixFirst Then flds = flds & \",\"\n                flds = flds & \"\"\"\" & JsonEscape(idxFld.Name) & \"\"\"\"\n                ixFirst = False\n            Next idxFld\n            flds = flds & \"]\"\n            indexes = indexes & \"{\"\"name\"\":\"\"\" & JsonEscape(idx.Name) & \"\"\",\"\"unique\"\":\" & BoolJson(idx.Unique) & \",\"\"primary\"\":\" & BoolJson(idx.Primary) & \",\"\"fields\"\":\" & flds & \"}\"\n            first = False\n        Next idx\n        indexes = indexes & \"]\"\n\n        ' Link/Connect\n        Dim link As String, linkObj As String\n        On Error Resume Next: link = td.connect: On Error GoTo 0\n        If Len(link) > 0 Or (td.attributes And dbAttachedTable) <> 0 Or (td.attributes And dbAttachedODBC) <> 0 Then\n            linkObj = ConnectSummary(link)\n        Else\n            linkObj = \"null\"\n        End If\n\n        Dim Body As String\n        Body = \"{\"\"id\"\":\"\"\" & ID & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(td.Name) & \"\"\",\"\"fields\"\":\" & fields & \",\"\"indexes\"\":\" & indexes & \",\"\"link\"\":\" & linkObj & \"}\"\n        WriteTextOrLog JoinPath(root, \"10_tables\\\" & ID & \".json\"), Body\nNextTable:\n    Next td\nEnd Sub\n\nPrivate Sub Export_Relations(root As String)\n    Dim db As DAO.Database: Set db = CurrentDb\n    Dim rel As DAO.Relation, fld As DAO.field\n    Dim arr As String: arr = \"[\"\n    Dim first As Boolean: first = True\n    For Each rel In db.Relations\n        If Not first Then arr = arr & \",\"\n        arr = arr & \"{\"\"name\"\":\"\"\" & JsonEscape(rel.Name) & \"\"\",\"\"from\"\":\"\"\" & SafeId(\"TAB\", rel.Table) & \"\"\",\"\"to\"\":\"\"\" & SafeId(\"TAB\", rel.ForeignTable) & \"\"\",\"\"fields\"\":[\"\n        Dim f1 As Boolean: f1 = True\n        For Each fld In rel.fields\n            If Not f1 Then arr = arr & \",\"\n            arr = arr & \"{\"\"from_field\"\":\"\"\" & JsonEscape(fld.Name) & \"\"\",\"\"to_field\"\":\"\"\" & JsonEscape(fld.ForeignName) & \"\"\"}\"\n            f1 = False\n        Next fld\n        arr = arr & \"],\"\"attributes\"\":{\" & _\n              \"\"\"enforce_referential_integrity\"\":\" & BoolJson((rel.attributes And dbRelationDontEnforce) = 0) & \",\" & _\n              \"\"\"cascade_update\"\":\" & BoolJson((rel.attributes And dbRelationUpdateCascade) <> 0) & \",\" & _\n              \"\"\"cascade_delete\"\":\" & BoolJson((rel.attributes And dbRelationDeleteCascade) <> 0) & \"}}\"\n        first = False\n    Next rel\n    arr = arr & \"]\"\n    WriteTextOrLog JoinPath(root, \"70_relations\\REL_all.json\"), arr\nEnd Sub\n\n'=========================== QUERIES =========================================\nPrivate Sub Export_QueriesFull(root As String)\n    Dim db As DAO.Database: Set db = CurrentDb\n    Dim qd As DAO.QueryDef, params As String, first As Boolean\n\n    For Each qd In db.QueryDefs\n        If Left$(qd.Name, 1) = \"~\" Then GoTo NextQ\n        Dim ID As String: ID = SafeId(\"QRY\", qd.Name)\n\n        params = \"[\": first = True\n        On Error Resume Next\n        Dim p As DAO.Parameter\n        For Each p In qd.Parameters\n            If Not first Then params = params & \",\"\n            params = params & \"{\"\"name\"\":\"\"\" & JsonEscape(p.Name) & \"\"\",\"\"type\"\":\"\"\" & CStr(p.Type) & \"\"\"}\"\n            first = False\n        Next p\n        On Error GoTo 0\n        params = params & \"]\"\n\n        Dim sqlJson As String: sqlJson = SqlSources(qd.sql)\n\n        Dim qConnect As String: On Error Resume Next: qConnect = qd.connect: On Error GoTo 0\n        Dim qMeta As String\n        qMeta = \"{\"\"connect\"\":\" & IIf(Len(qConnect) > 0, ConnectSummary(qConnect), \"null\") & _\n                \",\"\"returns_records\"\":\" & LCase$(CStr(qd.ReturnsRecords)) & _\n                \",\"\"odbctimeout\"\":\" & CStr(qd.ODBCTimeout) & \"}\"\n\n        Dim json As String\n        json = \"{\"\"id\"\":\"\"\" & ID & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(qd.Name) & \"\"\",\"\"sql\"\":\" & sqlJson & \",\"\"parameters\"\":\" & params & \",\"\"meta\"\":\" & qMeta & \"}\"\n        WriteTextOrLog JoinPath(root, \"20_queries\\\" & ID & \".json\"), json\nNextQ:\n    Next qd\nEnd Sub\n\n'=========================== FORMS ===========================================\nPrivate Sub Export_FormsFull(root As String)\n    Dim it As AccessObject\n    For Each it In CurrentProject.AllForms\n        Dim opened As Boolean: opened = False\n        On Error Resume Next\n        DoCmd.OpenForm it.Name, acDesign, , , , acHidden\n        If err.Number = 0 Then opened = True\n        err.clear\n        On Error GoTo 0\n\n        If opened Then\n            WriteTextOrLog JoinPath(root, \"30_forms\\\" & SafeId(\"FRM\", it.Name) & \".json\"), Build_FormJsonFull(Forms(it.Name))\n            WriteTextOrLog JoinPath(root, \"35_subforms\\\" & SafeId(\"FRM\", it.Name) & \"__subcontrols.json\"), Build_SubformJson(Forms(it.Name))\n            On Error Resume Next: DoCmd.Close acForm, it.Name, acSaveNo: On Error GoTo 0\n        Else\n            WriteTextOrLog JoinPath(root, \"30_forms\\\" & SafeId(\"FRM\", it.Name) & \".json\"), \"{\"\"id\"\":\"\"\" & SafeId(\"FRM\", it.Name) & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(it.Name) & \"\"\",\"\"error\"\":\"\"OpenForm failed\"\"}\"\n        End If\n    Next it\nEnd Sub\n\nPrivate Function Build_FormJsonFull(f As Form) As String\n    Dim recType As String, recRef As String, recMap As String\n    If Len(f.recordSource) > 0 Then\n        If IsQueryName(f.recordSource) Then recType = \"query\" Else recType = \"table\"\n        recRef = f.recordSource\n        recMap = MapSourceId(recType, recRef)\n    Else\n        recType = \"none\": recRef = \"\": recMap = \"\"\n    End If\n\n    Dim props As String\n    props = \"{\"\"AllowEdits\"\":\" & BoolJson(f.AllowEdits) & _\n        \",\"\"AllowAdditions\"\":\" & BoolJson(f.AllowAdditions) & _\n        \",\"\"AllowDeletions\"\":\" & BoolJson(f.AllowDeletions) & _\n        \",\"\"DataEntry\"\":\" & BoolJson(f.DataEntry) & _\n        \",\"\"FilterOn\"\":\" & BoolJson(f.FilterOn) & _\n        \",\"\"Filter\"\":\"\"\" & JsonEscape(NzStr(f.filter)) & \"\"\"\" & _\n        \",\"\"OrderByOn\"\":\" & BoolJson(f.OrderByOn) & _\n        \",\"\"OrderBy\"\":\"\"\" & JsonEscape(NzStr(f.OrderBy)) & \"\"\"\" & _\n        \",\"\"Cycle\"\":\"\"\" & JsonEscape(CStr(f.Cycle)) & \"\"\"\" & _\n        \",\"\"NavigationButtons\"\":\" & BoolJson(f.NavigationButtons) & _\n        \",\"\"DividingLines\"\":\" & BoolJson(f.DividingLines) & _\n        \",\"\"DefaultView\"\":\"\"\" & JsonEscape(ChooseViewName(f.DefaultView)) & \"\"\"\" & _\n        \"}\"\n\n    Dim ctrls As String: ctrls = Build_ControlsJson(f.controls)\n\n    Dim ev As String\n    ev = \"{\"\"OnOpen\"\":\" & EventJson(f.OnOpen) & _\n         \",\"\"OnLoad\"\":\" & EventJson(f.OnLoad) & _\n         \",\"\"OnClose\"\":\" & EventJson(f.OnClose) & _\n         \",\"\"OnCurrent\"\":\" & EventJson(f.OnCurrent) & _\n         \",\"\"BeforeUpdate\"\":\" & EventJson(f.BeforeUpdate) & _\n         \",\"\"AfterUpdate\"\":\" & EventJson(f.AfterUpdate) & _\n         \",\"\"OnError\"\":\" & EventJson(f.OnError) & _\n         \",\"\"OnTimer\"\":\" & EventJson(f.OnTimer) & _\n         \",\"\"OnApplyFilter\"\":\" & EventJson(f.OnApplyFilter) & _\n         \",\"\"OnFilter\"\":\" & EventJson(f.OnFilter) & _\n         \",\"\"OnUnload\"\":\" & EventJson(f.OnUnload) & \"}\"\n\n    Build_FormJsonFull = \"{\"\"id\"\":\"\"\" & SafeId(\"FRM\", f.Name) & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(f.Name) & \"\"\",\"\"record_source\"\":{\"\"type\"\":\"\"\" & recType & \"\"\",\"\"ref\"\":\"\"\" & JsonEscape(recRef) & \"\"\",\"\"ref_id\"\":\"\"\" & recMap & \"\"\"},\"\"properties\"\":\" & props & \",\"\"controls\"\":\" & ctrls & \",\"\"events\"\":\" & ev & \"}\"\nEnd Function\n\nPrivate Function Build_ControlsJson(col As controls) As String\n    Dim out As String: out = \"[\"\n    Dim first As Boolean: first = True\n    Dim c As control\n    For Each c In col\n        If Not first Then out = out & \",\"\n        out = out & ControlJsonFull(c)\n        first = False\n    Next c\n    out = out & \"]\"\n    Build_ControlsJson = out\nEnd Function\n\nPrivate Function ControlJsonFull(c As control) As String\n    Dim t As String: t = TypeName(c)\n    Dim base As String\n    base = \"{\"\"name\"\":\"\"\" & JsonEscape(c.Name) & \"\"\",\"\"type\"\":\"\"\" & t & \"\"\"\"\n\n    ' ControlSource\n    On Error Resume Next\n    Dim cs As String: cs = c.ControlSource\n    If err.Number = 0 And Len(cs) > 0 Then base = base & \",\"\"control_source\"\":\"\"\" & JsonEscape(cs) & \"\"\"\"\n    err.clear: On Error GoTo 0\n\n    ' RowSource\n    On Error Resume Next\n    Dim rst As String: rst = c.rowSource\n    Dim hasRS As Boolean: hasRS = (err.Number = 0 And Len(rst) > 0)\n    err.clear: On Error GoTo 0\n\n    If hasRS Then\n        Dim rtype As String\n        If IsQueryName(rst) Then rtype = \"query\" Else rtype = \"sql_or_table\"\n        base = base & \",\"\"row_source\"\":{\"\"type\"\":\"\"\" & rtype & \"\"\",\"\"ref\"\":\"\"\" & JsonEscape(rst) & \"\"\"}\"\n        On Error Resume Next\n        Dim lp As String: lp = \"\"\n        lp = lp & PropKV(\"ColumnCount\", c.ColumnCount)\n        lp = lp & PropKV(\"BoundColumn\", c.BoundColumn)\n        lp = lp & PropKV(\"ListRows\", c.ListRows)\n        lp = lp & PropKV(\"ColumnWidths\", c.ColumnWidths)\n        lp = lp & PropKV(\"LimitToList\", c.LimitToList)\n        On Error GoTo 0\n        If Len(lp) > 0 Then\n            If Left$(lp, 1) = \",\" Then lp = Mid$(lp, 2)\n            base = base & \",\"\"list_props\"\":{\" & lp & \"}\"\n        End If\n    End If\n\n    ' Standard-Properties (defensiv)\n    On Error Resume Next\n    Dim pbag As String: pbag = \"\"\n    pbag = pbag & PropKV(\"DefaultValue\", c.defaultValue)\n    pbag = pbag & PropKV(\"ValidationRule\", c.ValidationRule)\n    pbag = pbag & PropKV(\"ValidationText\", c.ValidationText)\n    pbag = pbag & PropKV(\"Format\", c.Format)\n    pbag = pbag & PropKV(\"InputMask\", c.InputMask)\n    pbag = pbag & PropKV(\"Enabled\", c.Enabled)\n    pbag = pbag & PropKV(\"Locked\", c.Locked)\n    pbag = pbag & PropKV(\"Visible\", c.Visible)\n    pbag = pbag & PropKV(\"TabIndex\", c.TabIndex)\n    pbag = pbag & PropKV(\"TabStop\", c.TabStop)\n    pbag = pbag & PropKV(\"ForeColor\", c.foreColor)\n    pbag = pbag & PropKV(\"BackColor\", c.backColor)\n    pbag = pbag & PropKV(\"BorderColor\", c.BorderColor)\n    pbag = pbag & PropKV(\"BorderStyle\", c.BorderStyle)\n    pbag = pbag & PropKV(\"BorderWidth\", c.BorderWidth)\n    pbag = pbag & PropKV(\"Left\", c.Left)\n    pbag = pbag & PropKV(\"Top\", c.Top)\n    pbag = pbag & PropKV(\"Width\", c.width)\n    pbag = pbag & PropKV(\"Height\", c.height)\n    On Error GoTo 0\n    If Len(pbag) > 0 Then\n        If Left$(pbag, 1) = \",\" Then pbag = Mid$(pbag, 2)\n        base = base & \",\"\"properties\"\":{\" & pbag & \"}\"\n    End If\n\n    ' Subform\n    If t = \"SubForm\" Or t = \"Subform\" Then\n        On Error Resume Next\n        Dim so As String: so = c.SourceObject\n        Dim lmf As String: lmf = c.LinkMasterFields\n        Dim lcf As String: lcf = c.LinkChildFields\n        On Error GoTo 0\n        base = base & \",\"\"subform\"\":{\"\"source_object\"\":\"\"\" & JsonEscape(so) & \"\"\",\"\"link_master_fields\"\":[\" & QuoteSplitSemicolon(lmf) & \"],\"\"link_child_fields\"\":[\" & QuoteSplitSemicolon(lcf) & \"]}\"\n    End If\n\n    ' Events\n    base = base & \",\"\"events\"\":{\" & _\n        \"\"\"OnClick\"\":\" & EventJson(GetEventSafe(c, \"OnClick\")) & \",\" & _\n        \"\"\"OnDblClick\"\":\" & EventJson(GetEventSafe(c, \"OnDblClick\")) & \",\" & _\n        \"\"\"OnMouseDown\"\":\" & EventJson(GetEventSafe(c, \"OnMouseDown\")) & \",\" & _\n        \"\"\"OnMouseUp\"\":\" & EventJson(GetEventSafe(c, \"OnMouseUp\")) & \",\" & _\n        \"\"\"OnMouseMove\"\":\" & EventJson(GetEventSafe(c, \"OnMouseMove\")) & \",\" & _\n        \"\"\"OnChange\"\":\" & EventJson(GetEventSafe(c, \"OnChange\")) & \",\" & _\n        \"\"\"OnDirty\"\":\" & EventJson(GetEventSafe(c, \"OnDirty\")) & \",\" & _\n        \"\"\"BeforeUpdate\"\":\" & EventJson(GetEventSafe(c, \"BeforeUpdate\")) & \",\" & _\n        \"\"\"AfterUpdate\"\":\" & EventJson(GetEventSafe(c, \"AfterUpdate\")) & \",\" & _\n        \"\"\"OnGotFocus\"\":\" & EventJson(GetEventSafe(c, \"OnGotFocus\")) & \",\" & _\n        \"\"\"OnLostFocus\"\":\" & EventJson(GetEventSafe(c, \"OnLostFocus\")) & \",\" & _\n        \"\"\"OnKeyDown\"\":\" & EventJson(GetEventSafe(c, \"OnKeyDown\")) & \",\" & _\n        \"\"\"OnKeyUp\"\":\" & EventJson(GetEventSafe(c, \"OnKeyUp\")) & \",\" & _\n        \"\"\"OnKeyPress\"\":\" & EventJson(GetEventSafe(c, \"OnKeyPress\")) & \"}\"\n\n    base = base & \"}\"\n    ControlJsonFull = base\nEnd Function\n\nPrivate Function QuoteSplitSemicolon(s As String) As String\n    Dim arr() As String, i As Long, out As String\n    If Len(Trim$(s)) = 0 Then QuoteSplitSemicolon = \"\": Exit Function\n    arr = Split(s, \";\")\n    For i = LBound(arr) To UBound(arr)\n        If i > LBound(arr) Then out = out & \",\"\n        out = out & \"\"\"\" & JsonEscape(Trim$(arr(i))) & \"\"\"\"\n    Next i\n    QuoteSplitSemicolon = out\nEnd Function\n\nPrivate Function IsQueryName(src As String) As Boolean\n    On Error Resume Next\n    Dim q As DAO.QueryDef: Set q = CurrentDb.QueryDefs(src)\n    IsQueryName = (err.Number = 0)\n    err.clear: On Error GoTo 0\nEnd Function\n\nPrivate Function MapSourceId(t As String, ref As String) As String\n    If t = \"table\" Then\n        MapSourceId = SafeId(\"TAB\", ref)\n    ElseIf t = \"query\" Then\n        MapSourceId = SafeId(\"QRY\", ref)\n    Else\n        MapSourceId = \"\"\n    End If\nEnd Function\n\nPrivate Function Build_SubformJson(f As Form) As String\n    Dim out As String: out = \"[\"\n    Dim first As Boolean: first = True\n    Dim c As control\n    For Each c In f.controls\n        If TypeName(c) = \"SubForm\" Or TypeName(c) = \"Subform\" Then\n            If Not first Then out = out & \",\"\n            out = out & \"{\"\"form\"\":\"\"\" & JsonEscape(f.Name) & \"\"\",\"\"control\"\":\"\"\" & JsonEscape(c.Name) & \"\"\",\"\"source_object\"\":\"\"\" & JsonEscape(c.SourceObject) & \"\"\",\"\"link_master_fields\"\":[\" & QuoteSplitSemicolon(c.LinkMasterFields) & \"],\"\"link_child_fields\"\":[\" & QuoteSplitSemicolon(c.LinkChildFields) & \"]}\"\n            first = False\n        End If\n    Next c\n    out = out & \"]\"\n    Build_SubformJson = out\nEnd Function\n\n'=========================== REPORTS =========================================\nPrivate Sub Export_ReportsFull(root As String)\n    Dim it As AccessObject\n    For Each it In CurrentProject.AllReports\n        Dim openedR As Boolean: openedR = False\n        On Error Resume Next\n        DoCmd.OpenReport it.Name, acViewDesign, , , acHidden\n        If err.Number = 0 Then openedR = True\n        err.clear: On Error GoTo 0\n\n        If openedR Then\n            Dim r As Report: Set r = Reports(it.Name)\n            WriteTextOrLog JoinPath(root, \"40_reports\\\" & SafeId(\"RPT\", it.Name) & \".json\"), Build_ReportJsonFull(r)\n            On Error Resume Next: DoCmd.Close acReport, it.Name, acSaveNo: On Error GoTo 0\n        Else\n            WriteTextOrLog JoinPath(root, \"40_reports\\\" & SafeId(\"RPT\", it.Name) & \".json\"), \"{\"\"id\"\":\"\"\" & SafeId(\"RPT\", it.Name) & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(it.Name) & \"\"\",\"\"error\"\":\"\"OpenReport failed\"\"}\"\n        End If\n    Next it\nEnd Sub\n\nPrivate Function Build_ReportJsonFull(r As Report) As String\n    Dim recType As String, recRef As String, recMap As String\n    If Len(r.recordSource) > 0 Then\n        If IsQueryName(r.recordSource) Then recType = \"query\" Else recType = \"table\"\n        recRef = r.recordSource: recMap = MapSourceId(recType, recRef)\n    Else\n        recType = \"none\": recRef = \"\": recMap = \"\"\n    End If\n\n    Dim props As String\n    props = \"{\"\"FilterOn\"\":\" & BoolJson(r.FilterOn) & _\n            \",\"\"Filter\"\":\"\"\" & JsonEscape(NzStr(r.filter)) & \"\"\"\" & _\n            \",\"\"OrderByOn\"\":\" & BoolJson(r.OrderByOn) & _\n            \",\"\"OrderBy\"\":\"\"\" & JsonEscape(NzStr(r.OrderBy)) & \"\"\"}\"\n\n    Dim ctrls As String: ctrls = Build_ControlsJson(r.controls)\n\n    Dim ev As String\n    ev = \"{\"\"OnOpen\"\":\" & EventJson(r.OnOpen) & _\n         \",\"\"OnClose\"\":\" & EventJson(r.OnClose) & _\n         \",\"\"OnNoData\"\":\" & EventJson(r.OnNoData) & _\n         \",\"\"OnError\"\":\" & EventJson(r.OnError) & \"}\"\n\n    Build_ReportJsonFull = \"{\"\"id\"\":\"\"\" & SafeId(\"RPT\", r.Name) & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(r.Name) & \"\"\",\"\"record_source\"\":{\"\"type\"\":\"\"\" & recType & \"\"\",\"\"ref\"\":\"\"\" & JsonEscape(recRef) & \"\"\",\"\"ref_id\"\":\"\"\" & recMap & \"\"\"},\"\"properties\"\":\" & props & \",\"\"controls\"\":\" & ctrls & \",\"\"events\"\":\" & ev & \"}\"\nEnd Function\n\n'=========================== MACROS ==========================================\nPrivate Sub Export_MacrosFull(root As String)\n    Dim it As AccessObject\n    Dim macCount As Long: macCount = 0\n\n    For Each it In CurrentProject.AllMacros\n        On Error GoTo MacFail\n\n        Dim ID As String: ID = SafeId(\"MAC\", it.Name)\n\n        ' SaveAsText ? String (projektinterner Temp-Ordner)\n        Dim xml As String: xml = SaveObjectAsTextToString(acMacro, it.Name)\n\n        If Len(xml) = 0 Then\n            ' Fehler/leer -> Stub schreiben\n            WriteTextOrLog JoinPath(root, \"50_macros\\\" & ID & \".json\"), _\n                \"{\"\"id\"\":\"\"\" & ID & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(it.Name) & \"\"\",\"\"error\"\":\"\"SaveAsText empty or blocked\"\"}\"\n        Else\n            Dim actions As String: actions = MacroActionsFromXml(xml)\n            Dim j As String\n            j = \"{\"\"id\"\":\"\"\" & ID & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(it.Name) & \"\"\",\"\"xml\"\":\"\"\" & JsonEscape(xml) & \"\"\",\"\"actions\"\":\" & actions & \"}\"\n            WriteTextOrLog JoinPath(root, \"50_macros\\\" & ID & \".json\"), j\n        End If\n\n        macCount = macCount + 1\n        On Error GoTo 0\n        GoTo MacNext\n\nMacFail:\n        AppendExportError \"MACRO_EXPORT_FAIL\", it.Name, err.Number, err.description\n        On Error Resume Next\n        WriteTextOrLog JoinPath(root, \"50_macros\\\" & SafeId(\"MAC\", it.Name) & \".json\"), _\n            \"{\"\"id\"\":\"\"\" & SafeId(\"MAC\", it.Name) & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(it.Name) & \"\"\",\"\"error\"\":\"\"\" & JsonEscape(err.description) & \"\"\"}\"\n        On Error GoTo 0\n        Resume MacNext\nMacNext:\n    Next it\n\n    ' Summary immer\n    WriteTextOrLog JoinPath(root, \"50_macros\\_summary.json\"), \"{\"\"count\"\":\" & CStr(macCount) & \"}\"\nEnd Sub\n\nPrivate Function MacroActionsFromXml(xml As String) As String\n    Dim s As String: s = LCase$(xml)\n    Dim out As String: out = \"[\"\n    Dim first As Boolean: first = True\n    Call AppendMacroAction(s, \"openform\", \"formname\", out, first)\n    Call AppendMacroAction(s, \"openreport\", \"reportname\", out, first)\n    Call AppendMacroAction(s, \"runsql\", \"sqlstatement\", out, first)\n    out = out & \"]\"\n    MacroActionsFromXml = out\nEnd Function\n\nPrivate Sub AppendMacroAction(s As String, actionName As String, argName As String, ByRef out As String, ByRef first As Boolean)\n    Dim p As Long, q As Long, piece As String\n    p = 1\n    Do\n        p = InStr(p, s, \"<action name=\"\"\" & actionName & \"\"\"\", vbTextCompare)\n        If p = 0 Then Exit Do\n        q = InStr(p, s, \"</action>\", vbTextCompare)\n        If q = 0 Then Exit Do\n        piece = Mid$(s, p, q - p + 9)\n        Dim argVal As String: argVal = ExtractXmlArg(piece, argName)\n        If Not first Then out = out & \",\"\n        out = out & \"{\"\"action\"\":\"\"\" & actionName & \"\"\",\"\"arg\"\":\"\"\" & JsonEscape(argVal) & \"\"\"}\"\n        first = False\n        p = q + 9\n    Loop\nEnd Sub\n\nPrivate Function ExtractXmlArg(block As String, argName As String) As String\n    Dim p As Long, q As Long\n    p = InStr(1, block, \"<argument name=\"\"\" & argName & \"\"\">\", vbTextCompare)\n    If p = 0 Then ExtractXmlArg = \"\": Exit Function\n    p = p + Len(\"<argument name=\"\"\" & argName & \"\"\">\")\n    q = InStr(p, block, \"</argument>\", vbTextCompare)\n    If q = 0 Then ExtractXmlArg = \"\" Else ExtractXmlArg = Mid$(block, p, q - p)\nEnd Function\n\n'=========================== MODULES / VBA ===================================\nPrivate Sub Export_ModulesFull(root As String)\n    Dim it As AccessObject, ao As AccessObject\n    Dim countStd As Long, countCb As Long\n\n    ' Standard-Module\n    For Each it In CurrentProject.AllModules\n        Dim ID As String: ID = SafeId(\"MOD\", it.Name)\n        Dim src As String: src = ModuleText(it.Name)\n        Dim calls As String: calls = ExtractCallsRich(src)\n        Dim procs As String: procs = ExtractProcedures(src)\n        Dim j As String\n        j = \"{\"\"id\"\":\"\"\" & ID & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(it.Name) & \"\"\",\"\"kind\"\":\"\"standard\"\",\"\"procedures\"\":\" & procs & \",\"\"calls\"\":\" & calls & \",\"\"source\"\":\"\"\" & JsonEscape(src) & \"\"\"}\"\n        WriteTextOrLog JoinPath(root, \"60_modules\\\" & ID & \".json\"), j\n        countStd = countStd + 1\n    Next it\n\n    ' CodeBehind Formulare\n    For Each ao In CurrentProject.AllForms\n        On Error Resume Next\n        DoCmd.OpenForm ao.Name, acDesign, , , , acHidden\n        If err.Number = 0 Then\n            Dim f As Form: Set f = Forms(ao.Name)\n            If f.HasModule Then\n                Dim t As String: t = SaveObjectAsTextToString(acForm, ao.Name)\n                Dim jid As String: jid = SafeId(\"MOD\", \"Form_\" & ao.Name)\n                WriteTextOrLog JoinPath(root, \"60_modules\\\" & jid & \".json\"), _\n                    \"{\"\"id\"\":\"\"\" & jid & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(ao.Name) & \"\"\",\"\"kind\"\":\"\"form_codebehind\"\",\"\"source_text\"\":\"\"\" & JsonEscape(t) & \"\"\"}\"\n                countCb = countCb + 1\n            End If\n            DoCmd.Close acForm, ao.Name, acSaveNo\n        End If\n        err.clear: On Error GoTo 0\n    Next ao\n\n    ' CodeBehind Reports\n    For Each ao In CurrentProject.AllReports\n        On Error Resume Next\n        DoCmd.OpenReport ao.Name, acViewDesign, , , acHidden\n        If err.Number = 0 Then\n            Dim r As Report: Set r = Reports(ao.Name)\n            Dim T2 As String: T2 = SaveObjectAsTextToString(acReport, ao.Name)\n            Dim jid2 As String: jid2 = SafeId(\"MOD\", \"Report_\" & ao.Name)\n            WriteTextOrLog JoinPath(root, \"60_modules\\\" & jid2 & \".json\"), _\n                \"{\"\"id\"\":\"\"\" & jid2 & \"\"\",\"\"name\"\":\"\"\" & JsonEscape(ao.Name) & \"\"\",\"\"kind\"\":\"\"report_codebehind\"\",\"\"source_text\"\":\"\"\" & JsonEscape(T2) & \"\"\"}\"\n            countCb = countCb + 1\n            DoCmd.Close acReport, ao.Name, acSaveNo\n        End If\n        err.clear: On Error GoTo 0\n    Next ao\n\n    ' Summary\n    WriteTextOrLog JoinPath(root, \"60_modules\\_summary.json\"), _\n        \"{\"\"standard_modules\"\":\" & CStr(countStd) & \",\"\"codebehind_modules\"\":\" & CStr(countCb) & \"}\"\nEnd Sub\n\nPrivate Function ModuleText(modName As String) As String\n    Dim txt As String\n    On Error Resume Next\n    DoCmd.OpenModule modName\n    If err.Number <> 0 Then ModuleText = \"\": err.clear: Exit Function\n    On Error GoTo 0\n\n    Dim m As Module\n    Set m = Modules(modName)\n    txt = m.lines(1, m.CountOfLines)\n\n    On Error Resume Next\n    DoCmd.Close acModule, modName\n    On Error GoTo 0\n\n    ModuleText = txt\nEnd Function\n\nPrivate Function ExtractCallsRich(src As String) As String\n    Dim out As String\n    out = \"{\"\"DoCmd.OpenForm\"\":[\" & ExtractListQuoted(src, \"DoCmd.OpenForm \"\"\", \"\"\"\") & \"],\" & _\n          \"\"\"DoCmd.OpenReport\"\":[\" & ExtractListQuoted(src, \"DoCmd.OpenReport \"\"\", \"\"\"\") & \"],\" & _\n          \"\"\"DoCmd.RunSQL\"\":[\" & ExtractListQuoted(src, \"DoCmd.RunSQL \"\"\", \"\"\"\") & \"],\" & _\n          \"\"\"CurrentDb.Execute\"\":[\" & ExtractSqlString(src, \"CurrentDb.Execute \") & \"],\" & _\n          \"\"\"DLookup\"\":[\" & ExtractDomainFunc(src, \"DLookup\") & \"],\" & _\n          \"\"\"DCount\"\":[\" & ExtractDomainFunc(src, \"DCount\") & \"],\" & _\n          \"\"\"DMax\"\":[\" & ExtractDomainFunc(src, \"DMax\") & \"],\" & _\n          \"\"\"DMin\"\":[\" & ExtractDomainFunc(src, \"DMin\") & \"]}\"\n    ExtractCallsRich = out\nEnd Function\n\nPrivate Function ExtractProcedures(src As String) As String\n    Dim lines() As String: lines = Split(src, vbCrLf)\n    Dim i As Long, s As String, out As String, first As Boolean\n    first = True: out = \"[\"\n    For i = LBound(lines) To UBound(lines)\n        s = Trim$(lines(i))\n        If LCase$(Left$(s, 3)) = \"sub\" Or LCase$(Left$(s, 8)) = \"function\" Or _\n           LCase$(Left$(s, 10)) = \"public sub\" Or LCase$(Left$(s, 11)) = \"private sub\" Or _\n           LCase$(Left$(s, 15)) = \"public function\" Or LCase$(Left$(s, 16)) = \"private function\" Then\n            If Not first Then out = out & \",\"\n            out = out & \"\"\"\" & JsonEscape(s) & \"\"\"\"\n            first = False\n        End If\n    Next i\n    out = out & \"]\"\n    ExtractProcedures = out\nEnd Function\n\nPrivate Function ExtractListQuoted(ByVal src As String, ByVal prefix As String, ByVal term As String) As String\n    Dim p As Long, q As Long, first As Boolean: first = True\n    Dim acc As String: acc = \"\"\n    p = InStr(1, src, prefix, vbTextCompare)\n    Do While p > 0\n        q = InStr(p + Len(prefix), src, term, vbTextCompare)\n        If q > 0 Then\n            If Not first Then acc = acc & \",\"\n            acc = acc & \"\"\"\" & JsonEscape(Mid$(src, p + Len(prefix), q - (p + Len(prefix)))) & \"\"\"\"\n            first = False\n            p = InStr(q + 1, src, prefix, vbTextCompare)\n        Else\n            Exit Do\n        End If\n    Loop\n    ExtractListQuoted = acc\nEnd Function\n\nPrivate Function ExtractSqlString(src As String, prefix As String) As String\n    ExtractSqlString = ExtractListQuoted(src, prefix & \"\"\"\", \"\"\"\")\nEnd Function\n\nPrivate Function ExtractDomainFunc(src As String, fname As String) As String\n    Dim p As Long, q As Long, acc As String, first As Boolean\n    first = True: acc = \"\"\n    p = InStr(1, src, fname & \"(\", vbTextCompare)\n    Do While p > 0\n        q = InStr(p, src, \")\", vbTextCompare)\n        If q > 0 Then\n            Dim callTxt As String: callTxt = Mid$(src, p, q - p + 1)\n            If Not first Then acc = acc & \",\"\n            acc = acc & \"\"\"\" & JsonEscape(callTxt) & \"\"\"\"\n            first = False\n            p = InStr(q + 1, src, fname & \"(\", vbTextCompare)\n        Else\n            Exit Do\n        End If\n    Loop\n    ExtractDomainFunc = acc\nEnd Function\n\n'=========================== XREF & Indizes ==================================\nPrivate Sub Build_CrossRefs_Full(root As String)\n    Dim rsForms As String:   rsForms = Build_RS_Map_Forms()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_recordsource_forms.json\"), rsForms\n\n    Dim rsReports As String: rsReports = Build_RS_Map_Reports()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_recordsource_reports.json\"), rsReports\n\n    Dim ctrlMap As String:   ctrlMap = Build_ControlSource_Map()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_control_sources.json\"), ctrlMap\n\n    Dim vbaTargets As String: vbaTargets = Build_VBA_Targets()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_vba_targets.json\"), vbaTargets\n\n    Dim handlers As String:  handlers = Build_EventHandlers_Map()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_event_handlers.json\"), handlers\nEnd Sub\n\nPrivate Function Build_RS_Map_Forms() As String\n    Dim it As AccessObject, out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    For Each it In CurrentProject.AllForms\n        Dim opened As Boolean: opened = False\n        On Error Resume Next\n        DoCmd.OpenForm it.Name, acDesign, , , , acHidden\n        If err.Number = 0 Then opened = True\n        err.clear: On Error GoTo 0\n\n        Dim recId As String: recId = \"\"\n        If opened Then\n            Dim f As Form: Set f = Forms(it.Name)\n            If Len(f.recordSource) > 0 Then\n                If IsQueryName(f.recordSource) Then recId = MapSourceId(\"query\", f.recordSource) Else recId = MapSourceId(\"table\", f.recordSource)\n            End If\n            On Error Resume Next: DoCmd.Close acForm, it.Name, acSaveNo: On Error GoTo 0\n        End If\n\n        If Not first Then out = out & \",\"\n        out = out & \"\"\"\" & SafeId(\"FRM\", it.Name) & \"\"\":\"\"\" & JsonEscape(recId) & \"\"\"\"\n        first = False\n    Next it\n    out = out & \"}\"\n    Build_RS_Map_Forms = out\nEnd Function\n\nPrivate Function Build_RS_Map_Reports() As String\n    Dim it As AccessObject, out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    For Each it In CurrentProject.AllReports\n        Dim openedR As Boolean: openedR = False\n        On Error Resume Next\n        DoCmd.OpenReport it.Name, acViewDesign, , , acHidden\n        If err.Number = 0 Then openedR = True\n        err.clear: On Error GoTo 0\n\n        Dim recId As String: recId = \"\"\n        If openedR Then\n            Dim r As Report: Set r = Reports(it.Name)\n            If Len(r.recordSource) > 0 Then\n                If IsQueryName(r.recordSource) Then recId = MapSourceId(\"query\", r.recordSource) Else recId = MapSourceId(\"table\", r.recordSource)\n            End If\n            On Error Resume Next: DoCmd.Close acReport, it.Name, acSaveNo: On Error GoTo 0\n        End If\n\n        If Not first Then out = out & \",\"\n        out = out & \"\"\"\" & SafeId(\"RPT\", it.Name) & \"\"\":\"\"\" & JsonEscape(recId) & \"\"\"\"\n        first = False\n    Next it\n    out = out & \"}\"\n    Build_RS_Map_Reports = out\nEnd Function\n\nPrivate Function Build_ControlSource_Map() As String\n    Dim out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    Dim it As AccessObject\n    For Each it In CurrentProject.AllForms\n        Dim opened As Boolean: opened = False\n        On Error Resume Next\n        DoCmd.OpenForm it.Name, acDesign, , , , acHidden\n        If err.Number = 0 Then opened = True\n        err.clear: On Error GoTo 0\n\n        If opened Then\n            Dim f As Form: Set f = Forms(it.Name)\n\n            Dim recType As String, recId As String, recRef As String\n            If Len(f.recordSource) > 0 Then\n                If IsQueryName(f.recordSource) Then recType = \"query\" Else recType = \"table\"\n                recId = MapSourceId(recType, f.recordSource)\n                recRef = f.recordSource\n            End If\n\n            Dim c As control\n            For Each c In f.controls\n                On Error Resume Next\n                Dim cs As String: cs = c.ControlSource\n                If err.Number = 0 And Len(cs) > 0 Then\n                    If Not first Then out = out & \",\"\n                    out = out & \"\"\"\" & SafeId(\"FRM\", f.Name) & \".\" & JsonEscape(c.Name) & \"\"\":{\" & _\n                          \"\"\"field\"\":\"\"\" & JsonEscape(cs) & \"\"\",\" & _\n                          \"\"\"form_id\"\":\"\"\" & SafeId(\"FRM\", f.Name) & \"\"\",\" & _\n                          \"\"\"record_source\"\":{\"\"type\"\":\"\"\" & recType & \"\"\",\"\"ref\"\":\"\"\" & JsonEscape(recRef) & \"\"\",\"\"ref_id\"\":\"\"\" & recId & \"\"\"}\" & _\n                          \"}\"\n                    first = False\n                End If\n                err.clear\n                On Error GoTo 0\n            Next c\n\n            On Error Resume Next: DoCmd.Close acForm, it.Name, acSaveNo: On Error GoTo 0\n        End If\n    Next it\n    out = out & \"}\"\n    Build_ControlSource_Map = out\nEnd Function\n\nPrivate Function Build_VBA_Targets() As String\n    Dim it As AccessObject, formsList As String, reportsList As String\n    Dim firstF As Boolean: firstF = True\n    Dim firstR As Boolean: firstR = True\n\n    formsList = \"[\": reportsList = \"[\"\n    For Each it In CurrentProject.AllModules\n        Dim src As String: src = ModuleText(it.Name)\n        Dim f As String: f = ExtractListQuoted(src, \"DoCmd.OpenForm \"\"\", \"\"\"\")\n        Dim r As String: r = ExtractListQuoted(src, \"DoCmd.OpenReport \"\"\", \"\"\"\")\n        If Len(f) > 0 Then\n            If Not firstF Then formsList = formsList & \",\"\n            formsList = formsList & f\n            firstF = False\n        End If\n        If Len(r) > 0 Then\n            If Not firstR Then reportsList = reportsList & \",\"\n            reportsList = reportsList & r\n            firstR = False\n        End If\n    Next it\n    formsList = formsList & \"]\"\n    reportsList = reportsList & \"]\"\n    Build_VBA_Targets = \"{\"\"OpenForm\"\":\" & formsList & \",\"\"OpenReport\"\":\" & reportsList & \"}\"\nEnd Function\n\nPrivate Function Build_EventHandlers_Map() As String\n    Dim it As AccessObject, out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    For Each it In CurrentProject.AllForms\n        Dim opened As Boolean: opened = False\n        On Error Resume Next\n        DoCmd.OpenForm it.Name, acDesign, , , , acHidden\n        If err.Number = 0 Then opened = True\n        err.clear: On Error GoTo 0\n\n        If opened Then\n            Dim f As Form: Set f = Forms(it.Name)\n            Dim map As String: map = \"{\"\n            map = map & \"\"\"Form_OnOpen\"\":\"\"\" & GuessHandler(\"Form\", f.Name, \"Open\") & \"\"\",\"\n            map = map & \"\"\"Form_OnLoad\"\":\"\"\" & GuessHandler(\"Form\", f.Name, \"Load\") & \"\"\",\"\n            map = map & \"\"\"Form_OnClose\"\":\"\"\" & GuessHandler(\"Form\", f.Name, \"Close\") & \"\"\",\"\n            map = map & \"\"\"Form_OnCurrent\"\":\"\"\" & GuessHandler(\"Form\", f.Name, \"Current\") & \"\"\",\"\n            map = map & \"\"\"Form_BeforeUpdate\"\":\"\"\" & GuessHandler(\"Form\", f.Name, \"BeforeUpdate\") & \"\"\",\"\n            map = map & \"\"\"Form_AfterUpdate\"\":\"\"\" & GuessHandler(\"Form\", f.Name, \"AfterUpdate\") & \"\"\"\"\n\n            Dim c As control, cfirst As Boolean: cfirst = True\n            map = map & \",\"\"Controls\"\":{\"\n            For Each c In f.controls\n                If Not cfirst Then map = map & \",\"\n                map = map & \"\"\"\" & JsonEscape(c.Name) & \"\"\":{\" & _\n                      \"\"\"OnClick\"\":\"\"\" & GuessHandler(\"Control\", f.Name, \"Click\", c.Name) & \"\"\",\" & _\n                      \"\"\"OnDblClick\"\":\"\"\" & GuessHandler(\"Control\", f.Name, \"DblClick\", c.Name) & \"\"\",\" & _\n                      \"\"\"BeforeUpdate\"\":\"\"\" & GuessHandler(\"Control\", f.Name, \"BeforeUpdate\", c.Name) & \"\"\",\" & _\n                      \"\"\"AfterUpdate\"\":\"\"\" & GuessHandler(\"Control\", f.Name, \"AfterUpdate\", c.Name) & \"\"\"}\"\n                cfirst = False\n            Next c\n            map = map & \"}\"\n\n            map = map & \"}\"\n\n            If Not first Then out = out & \",\"\n            out = out & \"\"\"\" & SafeId(\"FRM\", f.Name) & \"\"\":\" & map\n            first = False\n\n            On Error Resume Next: DoCmd.Close acForm, it.Name, acSaveNo: On Error GoTo 0\n        End If\n    Next it\n    out = out & \"}\"\n    Build_EventHandlers_Map = out\nEnd Function\n\nPrivate Sub Build_InvertedIndexes_Full(root As String)\n    Dim db As DAO.Database: Set db = CurrentDb\n    Dim fldMap As Object: Set fldMap = CreateObject(\"Scripting.Dictionary\")\n\n    Dim td As DAO.TableDef, f As DAO.field\n    For Each td In db.TableDefs\n        If Left$(td.Name, 4) = \"MSys\" Then GoTo NextT\n        For Each f In td.fields\n            Dim k As String: k = f.Name\n            If Not fldMap.exists(k) Then fldMap.Add k, \"[\"\"\" & SafeId(\"TAB\", td.Name) & \"\"\"]\" Else _\n                fldMap(k) = Left$(fldMap(k), Len(fldMap(k)) - 1) & \", \"\"\" & SafeId(\"TAB\", td.Name) & \"\"\"]\"\n        Next f\nNextT:\n    Next td\n\n    Dim out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    Dim key As Variant\n    For Each key In fldMap.Keys\n        If Not first Then out = out & \",\"\n        out = out & \"\"\"\" & JsonEscape(CStr(key)) & \"\"\":\" & fldMap(key)\n        first = False\n    Next key\n    out = out & \"}\"\n    If Len(out) = 2 Then out = \"{}\"\n    WriteTextOrLog JoinPath(root, \"95_search\\INV_field_to_table.json\"), out\n\n    Dim it As AccessObject\n    out = \"{\": first = True\n    For Each it In CurrentProject.AllForms\n        Dim opened As Boolean: opened = False\n        On Error Resume Next\n        DoCmd.OpenForm it.Name, acDesign, , , , acHidden\n        If err.Number = 0 Then opened = True\n        err.clear: On Error GoTo 0\n\n        If opened Then\n            Dim frm As Form: Set frm = Forms(it.Name)\n            Dim c As control, list As String: list = \"[\": Dim lf As Boolean: lf = True\n            For Each c In frm.controls\n                If Not lf Then list = list & \",\"\n                list = list & \"\"\"\" & JsonEscape(c.Name) & \"\"\"\"\n                lf = False\n            Next c\n            list = list & \"]\"\n            If Not first Then out = out & \",\"\n            out = out & \"\"\"\" & SafeId(\"FRM\", frm.Name) & \"\"\":\" & list\n            first = False\n\n            On Error Resume Next: DoCmd.Close acForm, it.Name, acSaveNo: On Error GoTo 0\n        End If\n    Next it\n    out = out & \"}\"\n    If Len(out) = 2 Then out = \"{}\"\n    WriteTextOrLog JoinPath(root, \"95_search\\INV_form_to_controls.json\"), out\nEnd Sub\n\n'=========================== DATASOURCES & LINEAGE ===========================\nPrivate Sub Export_Datasources(root As String)\n    Dim sources As Object: Set sources = CreateObject(\"Scripting.Dictionary\")\n\n    Dim td As DAO.TableDef\n    For Each td In CurrentDb.TableDefs\n        If Left$(td.Name, 4) = \"MSys\" Then GoTo NextT\n        On Error Resume Next\n        Dim c As String: c = td.connect\n        On Error GoTo 0\n        If Len(c) > 0 Then\n            Dim key As String: key = LCase$(MaskSensitive(c))\n            If Not sources.exists(key) Then sources.Add key, ConnectSummary(c)\n        End If\nNextT:\n    Next td\n\n    Dim q As DAO.QueryDef\n    For Each q In CurrentDb.QueryDefs\n        If Left$(q.Name, 1) = \"~\" Then GoTo NextQ\n        On Error Resume Next\n        Dim qc As String: qc = q.connect\n        On Error GoTo 0\n        If Len(qc) > 0 Then\n            Dim key2 As String: key2 = LCase$(MaskSensitive(qc))\n            If Not sources.exists(key2) Then sources.Add key2, ConnectSummary(qc)\n        End If\nNextQ:\n    Next q\n\n    Dim out As String: out = \"[\"\n    Dim first As Boolean: first = True\n    Dim k As Variant\n    For Each k In sources.Keys\n        If Not first Then out = out & \",\"\n        out = out & sources(k)\n        first = False\n    Next k\n    out = out & \"]\"\n\n    If Len(out) = 2 Then out = \"[]\"\n    WriteTextOrLog JoinPath(root, \"80_datasources\\datasources.json\"), out\nEnd Sub\n\n' --- lineage helpers ---\nPrivate Function IsTableName(Name As String) As Boolean\n    On Error Resume Next\n    Dim td As DAO.TableDef: Set td = CurrentDb.TableDefs(Name)\n    IsTableName = (err.Number = 0)\n    err.clear: On Error GoTo 0\nEnd Function\n\nPrivate Function IsQueryName2(Name As String) As Boolean\n    On Error Resume Next\n    Dim q As DAO.QueryDef: Set q = CurrentDb.QueryDefs(Name)\n    IsQueryName2 = (err.Number = 0 And Left$(Name, 1) <> \"~\")\n    err.clear: On Error GoTo 0\nEnd Function\n\nPrivate Function GetJsonArray(sqlJson As String, prop As String) As String\n    Dim p As Long, q As Long, k As String\n    k = \"\"\"\" & prop & \"\"\":[\"\n    p = InStr(1, sqlJson, k, vbTextCompare)\n    If p = 0 Then GetJsonArray = \"[]\": Exit Function\n    p = p + Len(k) - 1\n    q = InStr(p + 1, sqlJson, \"]\", vbTextCompare)\n    If q = 0 Then GetJsonArray = \"[]\": Exit Function\n    GetJsonArray = Mid$(sqlJson, p + 1, q - p)\nEnd Function\n\nPrivate Function JsonArrayToList(arrText As String) As Object\n    Dim col As Collection: Set col = New Collection\n    Dim s As String: s = Trim$(arrText)\n    If Len(s) = 0 Or s = \"[]\" Then Set JsonArrayToList = col: Exit Function\n\n    Dim items() As String, i As Long, v As String\n    items = Split(s, \",\")\n    For i = LBound(items) To UBound(items)\n        v = Trim$(items(i))\n        If Left$(v, 1) = \"\"\"\" And Right$(v, 1) = \"\"\"\" Then v = Mid$(v, 2, Len(v) - 2)\n        On Error Resume Next: col.Add v: On Error GoTo 0\n    Next i\n    Set JsonArrayToList = col\nEnd Function\n\nPrivate Sub ResolveQueryBaseSources(qName As String, ByRef accDict As Object, ByRef visited As Object)\n    If visited.exists(LCase$(qName)) Then Exit Sub\n    visited.Add LCase$(qName), True\n\n    On Error Resume Next\n    Dim q As DAO.QueryDef: Set q = CurrentDb.QueryDefs(qName)\n    If err.Number <> 0 Then Exit Sub\n    err.clear: On Error GoTo 0\n\n    Dim Info As String: Info = SqlSources(q.sql)\n    Dim srcList As Object: Set srcList = JsonArrayToList(GetJsonArray(Info, \"sources\"))\n\n    Dim i As Long, s As String\n    For i = 1 To srcList.Count\n        s = CStr(srcList(i))\n        If IsTableName(s) Then\n            If Not accDict.exists(s) Then accDict.Add s, True\n        ElseIf IsQueryName2(s) Then\n            ResolveQueryBaseSources s, accDict, visited\n        Else\n            If Not accDict.exists(s) Then accDict.Add s, True\n        End If\n    Next i\nEnd Sub\n\nPrivate Sub Build_DataLineage_Full(root As String)\n    Dim qMap As String: qMap = Build_Query_Lineage()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_query_lineage.json\"), qMap\n\n    Dim fMap As String: fMap = Build_Form_Lineage()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_form_lineage.json\"), fMap\n\n    Dim rMap As String: rMap = Build_Report_Lineage()\n    WriteTextOrLog JoinPath(root, \"90_crossrefs\\XREF_report_lineage.json\"), rMap\nEnd Sub\n\nPrivate Function Build_Query_Lineage() As String\n    Dim out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    Dim q As DAO.QueryDef\n\n    For Each q In CurrentDb.QueryDefs\n        If Left$(q.Name, 1) = \"~\" Then GoTo NextQ\n        Dim acc As Object: Set acc = CreateObject(\"Scripting.Dictionary\")\n        Dim visited As Object: Set visited = CreateObject(\"Scripting.Dictionary\")\n        ResolveQueryBaseSources q.Name, acc, visited\n\n        Dim list As String: list = \"[\"\n        Dim f As Boolean: f = True\n        Dim k As Variant\n        For Each k In acc.Keys\n            If Not f Then list = list & \",\"\n            list = list & \"\"\"\" & JsonEscape(CStr(k)) & \"\"\"\"\n            f = False\n        Next k\n        list = list & \"]\"\n\n        If Not first Then out = out & \",\"\n        out = out & \"\"\"\" & SafeId(\"QRY\", q.Name) & \"\"\":\" & list\n        first = False\nNextQ:\n    Next q\n\n    out = out & \"}\"\n    Build_Query_Lineage = out\nEnd Function\n\nPrivate Function Build_Form_Lineage() As String\n    Dim out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    Dim it As AccessObject\n\n    For Each it In CurrentProject.AllForms\n        Dim opened As Boolean: opened = False\n        On Error Resume Next\n        DoCmd.OpenForm it.Name, acDesign, , , , acHidden\n        If err.Number = 0 Then opened = True\n        err.clear: On Error GoTo 0\n\n        If opened Then\n            Dim f As Form: Set f = Forms(it.Name)\n\n            Dim acc As Object: Set acc = CreateObject(\"Scripting.Dictionary\")\n            If Len(f.recordSource) > 0 Then\n                If IsQueryName2(f.recordSource) Then\n                    Dim visited As Object: Set visited = CreateObject(\"Scripting.Dictionary\")\n                    ResolveQueryBaseSources f.recordSource, acc, visited\n                ElseIf IsTableName(f.recordSource) Then\n                    If Not acc.exists(f.recordSource) Then acc.Add f.recordSource, True\n                End If\n            End If\n            Dim c As control\n            For Each c In f.controls\n                On Error Resume Next\n                Dim cs As String: cs = c.ControlSource\n                If err.Number = 0 And Len(cs) > 0 Then\n                    If Not acc.exists(\"(field)\" & cs) Then acc.Add \"(field)\" & cs, True\n                End If\n                err.clear\n                On Error GoTo 0\n            Next c\n\n            Dim list As String: list = \"[\": Dim ff As Boolean: ff = True\n            Dim k As Variant\n            For Each k In acc.Keys\n                If Not ff Then list = list & \",\"\n                list = list & \"\"\"\" & JsonEscape(CStr(k)) & \"\"\"\"\n                ff = False\n            Next k\n            list = list & \"]\"\n\n            If Not first Then out = out & \",\"\n            out = out & \"\"\"\" & SafeId(\"FRM\", f.Name) & \"\"\":\" & list\n            first = False\n\n            On Error Resume Next: DoCmd.Close acForm, it.Name, acSaveNo: On Error GoTo 0\n        End If\n    Next it\n\n    out = out & \"}\"\n    Build_Form_Lineage = out\nEnd Function\n\nPrivate Function Build_Report_Lineage() As String\n    Dim out As String: out = \"{\"\n    Dim first As Boolean: first = True\n    Dim it As AccessObject\n\n    For Each it In CurrentProject.AllReports\n        Dim openedR As Boolean: openedR = False\n        On Error Resume Next\n        DoCmd.OpenReport it.Name, acViewDesign, , , acHidden\n        If err.Number = 0 Then openedR = True\n        err.clear: On Error GoTo 0\n\n        If openedR Then\n            Dim r As Report: Set r = Reports(it.Name)\n\n            Dim acc As Object: Set acc = CreateObject(\"Scripting.Dictionary\")\n            If Len(r.recordSource) > 0 Then\n                If IsQueryName2(r.recordSource) Then\n                    Dim visited As Object: Set visited = CreateObject(\"Scripting.Dictionary\")\n                    ResolveQueryBaseSources r.recordSource, acc, visited\n                ElseIf IsTableName(r.recordSource) Then\n                    If Not acc.exists(r.recordSource) Then acc.Add r.recordSource, True\n                End If\n            End If\n\n            Dim list As String: list = \"[\": Dim ff As Boolean: ff = True\n            Dim k As Variant\n            For Each k In acc.Keys\n                If Not ff Then list = list & \",\"\n                list = list & \"\"\"\" & JsonEscape(CStr(k)) & \"\"\"\"\n                ff = False\n            Next k\n            list = list & \"]\"\n\n            If Not first Then out = out & \",\"\n            out = out & \"\"\"\" & SafeId(\"RPT\", r.Name) & \"\"\":\" & list\n            first = False\n\n            On Error Resume Next: DoCmd.Close acReport, it.Name, acSaveNo: On Error GoTo 0\n        End If\n    Next it\n\n    out = out & \"}\"\n    Build_Report_Lineage = out\nEnd Function\n\n'=========================== MANIFEST ========================================\nPrivate Sub Build_Manifest_Full(root As String)\n    Dim j As String\n    j = \"{\"\"project\"\":\"\"\" & JsonEscape(CurrentProject.Name) & \"\"\",\"\"version\"\":\"\"\" & Format(Now, \"yyyy-mm-dd hh:nn:ss\") & \"\"\",\"\"export_tool\"\":\"\"AccessFE Exporter v2.5\"\",\"\"objects\"\":{\"\n    j = j & \"\"\"tables\"\":[\" & ListTablesIds & \"],\"\n    j = j & \"\"\"queries\"\":[\" & ListQueriesIds & \"],\"\n    j = j & \"\"\"forms\"\":[\" & ListAccessObjects(CurrentProject.AllForms, \"FRM\") & \"],\"\n    j = j & \"\"\"reports\"\":[\" & ListAccessObjects(CurrentProject.AllReports, \"RPT\") & \"],\"\n    j = j & \"\"\"macros\"\":[\" & ListAccessObjects(CurrentProject.AllMacros, \"MAC\") & \"],\"\n    j = j & \"\"\"modules\"\":[\" & ListAccessObjects(CurrentProject.AllModules, \"MOD\") & \"]},\"\n    j = j & \"\"\"xref_files\"\":[\"\"90_crossrefs/XREF_recordsource_forms.json\"\",\"\"90_crossrefs/XREF_recordsource_reports.json\"\",\"\"90_crossrefs/XREF_control_sources.json\"\",\"\"90_crossrefs/XREF_event_handlers.json\"\",\"\"90_crossrefs/XREF_vba_targets.json\"\",\"\"90_crossrefs/XREF_query_lineage.json\"\",\"\"90_crossrefs/XREF_form_lineage.json\"\",\"\"90_crossrefs/XREF_report_lineage.json\"\"],\"\n    j = j & \"\"\"search_indexes\"\":[\"\"95_search/INV_field_to_table.json\"\",\"\"95_search/INV_form_to_controls.json\"\"],\"\n    j = j & \"\"\"datasources_file\"\":\"\"80_datasources/datasources.json\"\",\"\n    j = j & \"\"\"hashes_file\"\":\"\"99_hashes/hashes.json\"\"}\"\n    WriteTextOrLog JoinPath(root, \"00_manifest\\manifest.json\"), j\nEnd Sub\n\nPrivate Function ListTablesIds() As String\n    Dim db As DAO.Database: Set db = CurrentDb\n    Dim td As DAO.TableDef, s As String, first As Boolean: first = True\n    For Each td In db.TableDefs\n        If Left$(td.Name, 4) <> \"MSys\" Then\n            If Not first Then s = s & \",\"\n            s = s & \"\"\"\" & SafeId(\"TAB\", td.Name) & \"\"\"\"\n            first = False\n        End If\n    Next td\n    ListTablesIds = s\nEnd Function\n\nPrivate Function ListQueriesIds() As String\n    Dim db As DAO.Database: Set db = CurrentDb\n    Dim q As DAO.QueryDef, s As String, first As Boolean: first = True\n    For Each q In db.QueryDefs\n        If Left$(q.Name, 1) <> \"~\" Then\n            If Not first Then s = s & \",\"\n            s = s & \"\"\"\" & SafeId(\"QRY\", q.Name) & \"\"\"\"\n            first = False\n        End If\n    Next q\n    ListQueriesIds = s\nEnd Function\n\nPrivate Function ListAccessObjects(col As Object, prefix As String) As String\n    Dim s As String: s = \"\"\n    Dim first As Boolean: first = True\n    Dim it As AccessObject\n    For Each it In col\n        If Not first Then s = s & \",\"\n        s = s & \"\"\"\" & SafeId(prefix, it.Name) & \"\"\"\"\n        first = False\n    Next it\n    ListAccessObjects = s\nEnd Function\n\n'=========================== Smoke-Test ======================================\nPublic Sub Smoke_TestExport()\n    On Error GoTo E\n    Dim root As String: root = EXPORT_BASE()\n    EnsureDir root\n    EnsureDir JoinPath(root, \"zz_smoke\")\n    WriteTextOrLog JoinPath(root, \"zz_smoke\\hello.json\"), \"{\"\"ok\"\":true,\"\"ts\"\":\"\"\" & Format(Now, \"yyyy-mm-dd hh:nn:ss\") & \"\"\"}\"\n    MsgBox \"Smoke-Test geschrieben nach: \" & JoinPath(root, \"zz_smoke\\hello.json\"), vbInformation\n    Exit Sub\nE:\n    AppendExportError \"SMOKE_FAIL\", \"Smoke_TestExport\", err.Number, err.description\n    MsgBox \"Smoke-Test FEHLER: \" & err.Number & \" - \" & err.description, vbCritical\nEnd Sub\n\n'=========================== END MODULE ======================================\n\n"}
