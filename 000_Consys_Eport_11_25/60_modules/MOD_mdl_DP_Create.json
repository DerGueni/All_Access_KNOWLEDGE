{"id":"MOD_mdl_DP_Create","name":"mdl_DP_Create","kind":"standard","procedures":["Function fSuchZl(i As Long) As Long","Function fObtstxx()","Function fCreate_DP_tmptable(dtstartdat As Date, bNurIstNichtZugeordnet As Boolean, iPosAusblendAb As Long)","Function fcolw()","Function fcolw_MA()","Function fSuchZl2(i As Long, iMA_ID As Long, dt As Date) As Long","Function ftstxx()","Function fCreate_DP_MA_tmptable(dtstartdat As Date, iNurAktiveMA As Long)"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":["Dcount(\"*\", strSQL)"],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, iZl As Long, iCol As Long\n\nFunction fSuchZl(i As Long) As Long\nfSuchZl = -1\nFor iZl = 0 To iZLMax1\n    If DAOARRAY1(0, iZl) = i Then\n        fSuchZl = iZl\n        Exit For\n    End If\nNext iZl\nEnd Function\n\nFunction fObtstxx()\n    Call fCreate_DP_tmptable(DateSerial(2015, 11, 4), 0, 0)\n    \nEnd Function\n\n\nFunction fCreate_DP_tmptable(dtstartdat As Date, bNurIstNichtZugeordnet As Boolean, iPosAusblendAb As Long)\n\nDim dt(6) As Date\nDim strdtPkt(6) As String\nDim strdtUdl(6) As String\nDim i As Long\nDim strSQL As String\nDim chr34 As String\nDim OrtVgl As String\n\nDim iZuoID As Long\nDim iMA_ID As Long\nDim strMAName As String\nDim bfraglich As Boolean\nDim strvon As String\nDim strbis As String\nDim ztV As Variant\nDim zt As Date\n\nDim db As DAO.Database\nDim rst As DAO.Recordset\n\n   On Error GoTo fCreate_DP_tmptable_Error\n\nchr34 = Chr$(34)\n'Datum füllen\nFor i = 0 To 6\n    dt(i) = dtstartdat + i\n    strdtPkt(i) = Format(dt(i), \"Short Date\")\n    strdtUdl(i) = Replace(strdtPkt(i), \".\", \"_\")\nNext i\n\n' Erzeugen Query \"qry_DP_Alle_Zt\"\nstrSQL = \"\"\nstrSQL = strSQL & \"SELECT qry_DP_Alle_Obj.* FROM qry_DP_Alle_Obj WHERE (((VADatum)\"\nstrSQL = strSQL & \" Between \" & SQLDatum(dt(0)) & \" AND \" & SQLDatum(dt(6)) & \"))\"\nIf bNurIstNichtZugeordnet = True Then\n    strSQL = strSQL & \" AND (MA_ID = 0) \"\nEnd If\nIf iPosAusblendAb > 0 Then\n    strSQL = strSQL & \" AND (Anz_MA < \" & iPosAusblendAb & \") \"\nEnd If\nstrSQL = strSQL & \" ORDER BY VADatum, ObjOrt, Pos_Nr;\"\nIf Not CreateQuery(strSQL, \"qry_DP_Alle_Zt\") Then\n    MsgBox strSQL, vbCritical, \"Fehler beim Create der Tabelle 'qry_DP_Alle_Zt'\"\n    Exit Function\nEnd If\n\n' Erzeugen Query \"qry_DP_Kreuztabelle\"\nstrSQL = \"\"\nstrSQL = strSQL & \"TRANSFORM First([qry_DP_Alle_Zt].ZuordID) AS ErsterWertvonZuordID SELECT [qry_DP_Alle_Zt].ObjOrt, [qry_DP_Alle_Zt].Pos_Nr\"\nstrSQL = strSQL & \" FROM qry_DP_Alle_Zt GROUP BY [qry_DP_Alle_Zt].ObjOrt, [qry_DP_Alle_Zt].Pos_Nr PIVOT Format([VADatum], 'Short Date')\"\nstrSQL = strSQL & \" IN ('\" & strdtPkt(0) & \"','\" & strdtPkt(1) & \"', '\" & strdtPkt(2) & \"', '\" & strdtPkt(3) & \"', '\" & strdtPkt(4) & \"', '\" & strdtPkt(5) & \"', '\" & strdtPkt(6) & \"');\"\n\n'strSQL = Replace(strSQL, \"'\", chr34)\nIf Not CreateQuery(strSQL, \"qry_DP_Kreuztabelle\") Then\n    MsgBox strSQL, vbCritical, \"Fehler beim Create der Tabelle 'qry_DP_Kreuztabelle'\"\n    Exit Function\nEnd If\n\n'tbltmp_DP_Grund fuellen\nCurrentDb.Execute (\"DELETE * FROM tbltmp_DP_Grund\")\nDoEvents\n\nstrSQL = \"\"\nstrSQL = strSQL & \"INSERT INTO tbltmp_DP_Grund SELECT qry_DP_Kreuztabelle.ObjOrt, qry_DP_Kreuztabelle.ObjOrt AS ObjOrt_Anzeige, qry_DP_Kreuztabelle.Pos_Nr,\"\nstrSQL = strSQL & \" qry_DP_Kreuztabelle.[\" & strdtUdl(0) & \"] AS Tag1_Zuo_ID,\"\nstrSQL = strSQL & \" qry_DP_Kreuztabelle.[\" & strdtUdl(1) & \"] AS Tag2_Zuo_ID,\"\nstrSQL = strSQL & \" qry_DP_Kreuztabelle.[\" & strdtUdl(2) & \"] AS Tag3_Zuo_ID,\"\nstrSQL = strSQL & \" qry_DP_Kreuztabelle.[\" & strdtUdl(3) & \"] AS Tag4_Zuo_ID,\"\nstrSQL = strSQL & \" qry_DP_Kreuztabelle.[\" & strdtUdl(4) & \"] AS Tag5_Zuo_ID,\"\nstrSQL = strSQL & \" qry_DP_Kreuztabelle.[\" & strdtUdl(5) & \"] AS Tag6_Zuo_ID,\"\nstrSQL = strSQL & \" qry_DP_Kreuztabelle.[\" & strdtUdl(6) & \"] AS Tag7_Zuo_ID\"\nstrSQL = strSQL & \" FROM qry_DP_Kreuztabelle ORDER BY qry_DP_Kreuztabelle.ObjOrt, qry_DP_Kreuztabelle.Pos_Nr;\"\nCurrentDb.Execute (strSQL)\nDoEvents\n\n'tbltmp_DP_Grund_2 und tbltmp_DP_Grund_sort fuellen\nCurrentDb.Execute (\"DELETE * FROM tbltmp_DP_Grund_2\")\nCurrentDb.Execute (\"DELETE * FROM tbltmp_DP_Grund_Sort\")\n\nCurrentDb.Execute (\"qry_DP_Alle_Add_temp\")\n\nCurrentDb.Execute (\"UPDATE tbltmp_DP_Grund INNER JOIN tbltmp_DP_Grund_Sort ON tbltmp_DP_Grund.ObjOrt = tbltmp_DP_Grund_Sort.ObjOrt SET tbltmp_DP_Grund.sortID = [tbltmp_DP_Grund_Sort].[ID];\")\n\nCurrentDb.Execute (\"qry_DP_Allw_Ins_2\")\n\nCurrentDb.Execute (\"UPDATE tbltmp_DP_Grund_2 SET tbltmp_DP_Grund_2.Startdat = \" & SQLDatum(dtstartdat) & \";\")\nDoEvents\n\nrecsetSQL1 = \"qry_DP_Alle_Zt_Fill\"\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n\nIf Not ArrFill_DAO_OK1 Then\n    MsgBox \"Keine Projekte in diesem Zeitraum\"\n    Exit Function\nEnd If\n\n'ZuoID = 0\n'MA_ID = 1\n'Name = 2\n'MA_Start = 3\n'MA_Ende = 4\n'Istfraglich = 5\n\nSet db = CurrentDb\nSet rst = db.OpenRecordset(\"SELECT * FROM tbltmp_DP_Grund_2 ORDER BY ID\")\nWith rst\n    OrtVgl = \"\"\n    Do While Not .EOF\n        .Edit\n            If OrtVgl = .fields(\"ObjOrt_Anzeige\") Then\n                .fields(\"ObjOrt_Anzeige\") = \"\"\n            Else\n                OrtVgl = .fields(\"ObjOrt_Anzeige\")\n            End If\n            For i = 1 To 7\n               iZuoID = Nz(.fields(\"Tag\" & i & \"_Zuo_ID\"), 0)\n               If iZuoID > 0 Then\n                    iZl = fSuchZl(iZuoID)\n                    If iZl < 0 Then\n                        MsgBox \"Probleme bei der Tabellenzuordnung - \" & iZuoID\n                        Exit Function\n                    End If\n                    ztV = Nz(DAOARRAY1(3, iZl))\n                    If Len(Trim(ztV)) > 0 Then\n                        strvon = Format(ztV, \"hh:nn\")\n                    End If\n                    If IsNull(DAOARRAY1(3, iZl)) Then\n                        strvon = \"\"\n                    End If\n                    ztV = Nz(DAOARRAY1(4, iZl))\n                    If Len(Trim(ztV)) > 0 Then\n                        strbis = Format(ztV, \"hh:nn\")\n                    End If\n                    If IsNull(DAOARRAY1(4, iZl)) Then\n                        strbis = \"\"\n                    End If\n                    iMA_ID = Nz(DAOARRAY1(1, iZl), 0)\n                    strMAName = Nz(DAOARRAY1(2, iZl))\n                    bfraglich = Nz(DAOARRAY1(5, iZl), 0)\n                    \n                    .fields(\"Tag\" & i & \"_MA_ID\") = iMA_ID\n                    .fields(\"Tag\" & i & \"_Name\") = strMAName\n                    .fields(\"Tag\" & i & \"_fraglich\") = bfraglich\n                    .fields(\"Tag\" & i & \"_von\") = strvon\n                    .fields(\"Tag\" & i & \"_bis\") = strbis\n                    \n                End If\n            Next i\n    \n        .update\n        .MoveNext\n    Loop\n    .Close\nEnd With\nSet rst = Nothing\nSet DAOARRAY1 = Nothing\nCall Set_Priv_Property(\"prp_Dienstpl_StartDatum_Vgl\", dtstartdat)\n\n   On Error GoTo 0\n   Exit Function\n\nfCreate_DP_tmptable_Error:\n\n    MsgBox \"Error \" & err.Number & \" (\" & err.description & \") in procedure fCreate_DP_tmptable of Modul mdl_DP_Create\"\nEnd Function\n\n\nFunction fcolw()\n\n  Dim frm As Form\n  Dim ctl As control\n  Dim frmName As String\n\n  Dim i As Long\n  Dim j As Long\n  Dim st As String\n  \n  Dim iLeft As Long\n  \n  Dim Twips2cm As Long\n\nTwips2cm = 567\nfrmName = \"sub_DP_Grund\"\n\n  DoCmd.OpenForm frmName, acDesign\n  Set frm = Forms(frmName)\n  frm.controls(\"ID\").ColumnWidth = 0\n  frm.controls(\"Startdat\").ColumnWidth = 0\n  frm.controls(\"ObjOrt\").ColumnWidth = 0\n  frm.controls(\"PosNr\").ColumnWidth = 0\n  frm.controls(\"ObjOrt_Anzeige\").ColumnWidth = 3.8 * Twips2cm\n  For i = 1 To 7\n    st = \"Tag\" & i & \"_\"\n    frm.controls(st & \"Zuo_ID\").ColumnWidth = 0\n    frm.controls(st & \"MA_ID\").ColumnWidth = 0\n    frm.controls(st & \"Name\").ColumnWidth = 3.5 * Twips2cm\n    frm.controls(st & \"fraglich\").ColumnWidth = 0 ' 0.7 * Twips2cm\n    frm.controls(st & \"von\").ColumnWidth = 1 * Twips2cm\n    frm.controls(st & \"bis\").ColumnWidth = 1 * Twips2cm\n  Next i\n  \n  DoCmd.Close acForm, frmName, acSaveYes\n  Set frm = Nothing\n\nfrmName = \"frm_DP_Dienstplan_Objekt\"\n  DoCmd.OpenForm frmName, acDesign\n  Set frm = Forms(frmName)\n  \n  iLeft = 5.2 * Twips2cm\n  frm.controls(\"lbl_Auftrag\").width = 4.2 * Twips2cm\n  frm.controls(\"lbl_Auftrag\").Left = iLeft\n  iLeft = iLeft + 4.3 * Twips2cm\n  For i = 1 To 7\n    frm.controls(\"lbl_Tag_\" & i).width = 5.5 * Twips2cm\n    frm.controls(\"lbl_Tag_\" & i).Left = iLeft\n    iLeft = iLeft + 5.5 * Twips2cm\n  Next i\n  \n  DoCmd.Close acForm, frmName, acSaveYes\n  Set frm = Nothing\n\nEnd Function\n\nFunction fcolw_MA()\n\n  Dim frm As Form\n  Dim ctl As control\n  Dim frmName As String\n\n  Dim i As Long\n  Dim j As Long\n  Dim st As String\n  \n  Dim Twips2cm As Long\n  Dim iLeft As Long\n\nTwips2cm = 567\nfrmName = \"sub_DP_Grund_MA\"\n\n  DoCmd.OpenForm frmName, acDesign\n  Set frm = Forms(frmName)\n  frm.controls(\"ID\").ColumnWidth = 0\n  frm.controls(\"Startdat\").ColumnWidth = 0\n  frm.controls(\"MA_ID\").ColumnWidth = 0\n  frm.controls(\"Hlp\").ColumnWidth = 0\n  frm.controls(\"MAName\").ColumnWidth = 3.8 * Twips2cm\n  For i = 1 To 7\n    st = \"Tag\" & i & \"_\"\n    frm.controls(st & \"Zuo_ID\").ColumnWidth = 0\n    frm.controls(st & \"MA_ID\").ColumnWidth = 0\n    frm.controls(st & \"Name\").ColumnWidth = 3.5 * Twips2cm\n    frm.controls(st & \"fraglich\").ColumnWidth = 0 ' 0.7 * Twips2cm\n    frm.controls(st & \"von\").ColumnWidth = 1 * Twips2cm\n    frm.controls(st & \"bis\").ColumnWidth = 1 * Twips2cm\n  Next i\n  \n  DoCmd.Close acForm, frmName, acSaveYes\n  Set frm = Nothing\n\nfrmName = \"frm_DP_Dienstplan_MA\"\n  DoCmd.OpenForm frmName, acDesign\n  Set frm = Forms(frmName)\n  \n  iLeft = 5.2 * Twips2cm\n  frm.controls(\"lbl_Auftrag\").width = 4.2 * Twips2cm\n  frm.controls(\"lbl_Auftrag\").Left = iLeft\n  iLeft = iLeft + 4.3 * Twips2cm\n  For i = 1 To 7\n    frm.controls(\"lbl_Tag_\" & i).width = 5.5 * Twips2cm\n    frm.controls(\"lbl_Tag_\" & i).Left = iLeft\n    iLeft = iLeft + 5.5 * Twips2cm\n  Next i\n  \n  DoCmd.Close acForm, frmName, acSaveYes\n  Set frm = Nothing\n\nEnd Function\n\n\nFunction fSuchZl2(i As Long, iMA_ID As Long, dt As Date) As Long\nfSuchZl2 = -1000\n'ZuoID = 0\n'MA_ID = 1\n'Name = 2 ' objOrt\n'MA_Start = 3\n'MA_Ende = 4\n'Istfraglich = 5\n'VADatum = 6\n\nFor iZl = 0 To iZLMax1\n    If DAOARRAY1(0, iZl) = i And DAOARRAY1(1, iZl) = iMA_ID And CDate(DAOARRAY1(6, iZl)) = dt Then\n        fSuchZl2 = iZl\n        Exit For\n    End If\nNext iZl\nEnd Function\n\n\n'Function fCreate_DP_MA_tmptable(dtstartdat As Date, iNurAktiveMA As Long)\n' Falsche V68 Version\n'\n'' iNurAktiveMA  -- 0 = Alle, 1 = Nur Aktive, 2 = Nur Festangestellte, 3 = Nur Minijobber, 4 = Nur Subs\n'\n'Dim dt(6) As Date\n'Dim strdtPkt(6) As String\n'Dim strdtUdl(6) As String\n'Dim i As Long, j As Long, k As Long\n'Dim strSQL As String\n'Dim chr34 As String\n'Dim OrtVgl As String\n'\n'Dim iZuoID As Long\n'Dim iMA_ID As Long\n'Dim strMAName As String\n'Dim bfraglich As Boolean\n'Dim strvon As String\n'Dim strbis As String\n'Dim ztV As Variant\n'Dim zt As Date\n'\n'Dim db As DAO.Database\n'Dim rst As DAO.Recordset\n'Dim Dttmp As Date\n'\n'Dim strSQLWhere As String\n'Dim strSQLOrderBy As String\n'\n'' tbltmp_DP_MA_Neu_1 = Tabelle einzelne Werte untereinander - Alle MA die im Zeitraum zugeordnet oder nicht verfügbar sind, darunter der Rest\n''d.h. i  Summe alle MA\n'\n'' tbltmp_DP_MA_Neu_2 = Tabelle einzelne Werte untereinander - Nur die MA die der übergebenen Selektion entsprechen\n'\n'' tbltmp_DP_MA_Grund - Pivotierte Tabelle basierend auf tbltmp_DP_MA_Neu_2\n'\n'' tbltmp_DP_MA_Grund_FI - Tabelle sortiert nach Datum\n'\n'\n'Set db = CurrentDb\n'\n'chr34 = Chr$(34)\n''Datum füllen\n'For i = 0 To 6\n'    dt(i) = dtstartdat + i\n'    strdtPkt(i) = Format(dt(i), \"Short Date\")\n'    strdtUdl(i) = Replace(strdtPkt(i), \".\", \"_\")\n'Next i\n'\n'strSQL = \"SELECT * FROM qry_DP_MA_Neu_1 WHERE (((VADatum) Between \" & SQLDatum(dt(0)) & \" AND \" & SQLDatum(dt(6)) & \") AND ((MA_ID)>0))\"\n'If Not CreateQuery(strSQL, \"qry_DP_MA_Neu_2\") Then\n'    MsgBox strSQL, vbCritical, \"Fehler beim Create der Abfrage 'qry_DP_MA_Neu_2'\"\n'    Exit Function\n'End If\n'\n'Select Case iNurAktiveMA\n'' 0 Alle\n'' 1 Nur aktive - IstAktiv = True\n'' 2 Nur Feste  - Anstellungsart_ID = 3\n'' 3 Minijobber - Anstellungsart_ID = 5\n'' 4 Nur Subs   - IstSubunternehmer = True\n'\n'Case 1\n'    strSQLWhere = \" WHERE IstAktiv = True\"\n'Case 2\n'    strSQLWhere = \" WHERE Anstellungsart_ID = 3\"\n'Case 3\n'    strSQLWhere = \" WHERE Anstellungsart_ID = 5\"\n'Case 4\n'    strSQLWhere = \" WHERE IstSubunternehmer = True\"\n'Case Else\n'    strSQLWhere = \" WHERE 1 = 1\"\n'\n'End Select\n'\n'' Tabelle tbltmp_DP_MA_Neu_1 leeren und füllen\n'CurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_Neu_1;\")\n'CurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_Neu_2;\")\n'\n'DoEvents\n'\n''Neu 1 - Alle MA Füllen\n'' Tabelle tbltmp_DP_MA_Neu_1 leeren und füllen\n'CurrentDb.Execute (\"qry_DP_MA_Neu_2_Import\") ' Nur die Selektierten\n'DoEvents\n'CurrentDb.Execute (\"qry_DP_MA_Neu_3_Import\") ' Nur die ohne Job\n'\n''Neu 2 - Selektierte MA Selektion aus Übergabe füllen\n'' Tabelle tbltmp_DP_MA_Neu_2 füllen\n'strSQL = \"\"\n'strSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Neu_2 ( VADatum, MAName, Pos_Nr, ObjOrt, MA_ID, IstAktiv, IstSubunternehmer, Anstellungsart_ID, IstFraglich, ZuordID, VA_ID, VADatum_ID, VAStart_ID, MA_Start, MA_Ende, MVA_Start, Hlp )\"\n'strSQL = strSQL & \" SELECT tbltmp_DP_MA_Neu_1.VADatum, tbltmp_DP_MA_Neu_1.MAName, tbltmp_DP_MA_Neu_1.Pos_Nr, tbltmp_DP_MA_Neu_1.ObjOrt, tbltmp_DP_MA_Neu_1.MA_ID, tbltmp_DP_MA_Neu_1.IstAktiv, tbltmp_DP_MA_Neu_1.IstSubunternehmer,\"\n'strSQL = strSQL & \" tbltmp_DP_MA_Neu_1.Anstellungsart_ID, tbltmp_DP_MA_Neu_1.IstFraglich, tbltmp_DP_MA_Neu_1.ZuordID, tbltmp_DP_MA_Neu_1.VA_ID, tbltmp_DP_MA_Neu_1.VADatum_ID, tbltmp_DP_MA_Neu_1.VAStart_ID, tbltmp_DP_MA_Neu_1.MA_Start,\"\n'strSQL = strSQL & \" tbltmp_DP_MA_Neu_1.MA_Ende , tbltmp_DP_MA_Neu_1.MVA_Start, 1\"\n'strSQL = strSQL & \" FROM tbltmp_DP_MA_Neu_1\" & strSQLWhere\n'\n'CurrentDb.Execute (strSQL)\n'\n'DoEvents\n'\n'\n'' tbltmp_DP_ZWI11 - Anzahl der MA finden, die pro Tag mehr als einen Einsatz haben.\n'' Update des Feldes hlp in der Tabelle tbltmp_DP_MA_Neu_2\n'\n'If table_exist(\"tbltmp_DP_ZWI11\") Then DoCmd.DeleteObject acTable, \"tbltmp_DP_ZWI11\"\n'\n'strSQL = \"\"\n'\n'strSQL = strSQL & \"SELECT tbltmp_DP_MA_Neu_2.MA_ID, tbltmp_DP_MA_Neu_2.VADatum, Count(tbltmp_DP_MA_Neu_2.MA_ID) AS Anzahl INTO tbltmp_DP_ZWI11\"\n'strSQL = strSQL & \" FROM tbltmp_DP_MA_Neu_2 GROUP BY tbltmp_DP_MA_Neu_2.MA_ID, tbltmp_DP_MA_Neu_2.VADatum HAVING (((Count(tbltmp_DP_MA_Neu_2.MA_ID))>1));\"\n'CurrentDb.Execute (strSQL)\n'\n'CurrentDb.Execute (\"UPDATE tbltmp_DP_MA_Neu_2 INNER JOIN tbltmp_DP_ZWI11 ON (tbltmp_DP_ZWI11.VADatum = tbltmp_DP_MA_Neu_2.VADatum) AND (tbltmp_DP_MA_Neu_2.MA_ID = tbltmp_DP_ZWI11.MA_ID) SET tbltmp_DP_MA_Neu_2.Hlp = [Anzahl];\")\n'\n'If table_exist(\"tbltmp_DP_ZWI11\") Then DoCmd.DeleteObject acTable, \"tbltmp_DP_ZWI11\"\n'\n''In Tabelle tbltmp_DP_MA_Neu_2 die hlp-Werte für Pivottabelle in aufsteigende Reihenfolge bringen (statt 3 3 3  - 1 2 3)\n'strSQL = \"SELECT tbltmp_DP_MA_Neu_2.MAName, tbltmp_DP_MA_Neu_2.Hlp FROM tbltmp_DP_MA_Neu_2 WHERE (((tbltmp_DP_MA_Neu_2.Hlp) > 1)) ORDER BY tbltmp_DP_MA_Neu_2.MAName, MA_Start, MA_Ende;\"\n'\n'i = rstDcount(\"*\", strSQL)\n'If i > 0 Then\n'    Set rst = db.OpenRecordset(strSQL)\n'    With rst\n'        j = .Fields(\"Hlp\")\n'        i = 1\n'        Do While Not .EOF\n'            If i > .Fields(\"Hlp\") Then\n'                i = 1\n'                j = .Fields(\"Hlp\")\n'            End If\n'            .Edit\n'                .Fields(\"Hlp\") = i\n'            .Update\n'            i = i + 1\n'            .MoveNext\n'        Loop\n'        .Close\n'    End With\n'    Set rst = Nothing\n'End If\n''Kreuztabellen-Pivot-Abfrage erstellen\n'\n'strSQL = \"\"\n'strSQL = strSQL & \"TRANSFORM First(tbltmp_DP_MA_Neu_2.ZuordID) AS ErsterWertvonZuordID\"\n'strSQL = strSQL & \" SELECT tbltmp_DP_MA_Neu_2.MA_ID, tbltmp_DP_MA_Neu_2.MAName, tbltmp_DP_MA_Neu_2.Hlp\"\n'strSQL = strSQL & \" FROM tbltmp_DP_MA_Neu_2 GROUP BY tbltmp_DP_MA_Neu_2.MA_ID, tbltmp_DP_MA_Neu_2.MAName, tbltmp_DP_MA_Neu_2.Hlp\"\n'strSQL = strSQL & \" ORDER BY tbltmp_DP_MA_Neu_2.MAName, tbltmp_DP_MA_Neu_2.Hlp\"\n'strSQL = strSQL & \" PIVOT Format([VADatum],'Short Date')\"\n'strSQL = strSQL & \" IN ('\" & strdtPkt(0) & \"','\" & strdtPkt(1) & \"', '\" & strdtPkt(2) & \"', '\" & strdtPkt(3) & \"', '\" & strdtPkt(4) & \"', '\" & strdtPkt(5) & \"', '\" & strdtPkt(6) & \"');\"\n'\n''strSQL = Replace(strSQL, \"'\", chr34)\n'If Not CreateQuery(strSQL, \"qry_DP_MA_Kreuztabelle\") Then\n'    MsgBox strSQL, vbCritical, \"Fehler beim Create der Abfrage 'qry_DP_MA_Kreuztabelle'\"\n'    Exit Function\n'End If\n'\n'CurrentDb.Execute (\"Delete * FROM tbltmp_DP_MA_Grund;\")\n'DoEvents\n'\n'strSQL = \"\"\n'strSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Grund SELECT MA_ID, MAName, Hlp,\"\n'strSQL = strSQL & \" [\" & strdtUdl(0) & \"] AS Tag1_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(1) & \"] AS Tag2_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(2) & \"] AS Tag3_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(3) & \"] AS Tag4_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(4) & \"] AS Tag5_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(5) & \"] AS Tag6_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(6) & \"] AS Tag7_Zuo_ID\"\n'strSQL = strSQL & \" FROM qry_DP_MA_Kreuztabelle ORDER BY MAName, Hlp;\"\n'CurrentDb.Execute (strSQL)\n'DoEvents\n'\n'CurrentDb.Execute (\"UPDATE tbltmp_DP_MA_Grund SET tbltmp_DP_MA_Grund.Startdat = \" & SQLDatum(dtstartdat) & \";\")\n'DoEvents\n'\n'CurrentDb.Execute (\"delete * FROM tbltmp_DP_Grund_Sort_MA\")\n'DoEvents\n'\n'CurrentDb.Execute (\"qry_DP_Alle_Add_Temp_MA\")\n'DoEvents\n'\n'CurrentDb.Execute (\"UPDATE tbltmp_DP_Grund_Sort_MA INNER JOIN tbltmp_DP_MA_Grund ON tbltmp_DP_Grund_Sort_MA.MA_ID = tbltmp_DP_MA_Grund.MA_ID SET tbltmp_DP_MA_Grund.IDSort = [tbltmp_DP_Grund_Sort_MA].[ID];\")\n'DoEvents\n'\n'CurrentDb.Execute (\"delete * FROM tbltmp_DP_MA_Grund_FI\")\n'DoEvents\n'\n'CurrentDb.Execute (\"qry_DP_MA_Grund_FI_Fill\")\n'DoEvents\n'\n'Set DAOARRAY1 = Nothing\n'DoEvents\n'\n'recsetSQL1 = \"SELECT * FROM qry_DP_Alle_MA_Zt\"\n'ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n''Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n'\n'If Not ArrFill_DAO_OK1 Then\n'    MsgBox \"Probleme beim füllen von qry_DP_Alle_MA_Zt_Fill\"\n'    Exit Function\n'End If\n'\n''ZuoID = 0\n''MA_ID = 1\n''Name = 2 ' objOrt\n''MA_Start = 3\n''MA_Ende = 4\n''Istfraglich = 5\n''VADatum = 6\n'\n'Set rst = db.OpenRecordset(\"SELECT * FROM tbltmp_DP_MA_Grund_FI ORDER BY ID\")\n'With rst\n'    OrtVgl = \"\"\n'    Do While Not .EOF\n'        .Edit\n'            iMA_ID = .Fields(\"MA_ID\")\n'            If OrtVgl = .Fields(\"MAName\") Then\n'                .Fields(\"MAName\") = \"\"\n'            Else\n'                OrtVgl = .Fields(\"MAName\")\n'            End If\n'            For i = 1 To 7\n'               iZuoID = Nz(.Fields(\"Tag\" & i & \"_Zuo_ID\"), 0)\n'               strvon = \"\"\n'               strbis = \"\"\n'               strMAName = \"\"\n'               bfraglich = 0\n'               If iZuoID <> 0 Then\n'                    iZl = fSuchZl2(iZuoID, iMA_ID, dt(i - 1))\n'                    If ArrFill_DAO_OK1 And iZl <> -1000 Then\n'                        ztV = Nz(DAOARRAY1(3, iZl))\n'                        If Len(Trim(ztV)) > 0 Then\n'                            strvon = Format(ztV, \"hh:nn\")\n'                        End If\n'                        ztV = Nz(DAOARRAY1(4, iZl))\n'                        If Len(Trim(ztV)) > 0 Then\n'                            strbis = Format(ztV, \"hh:nn\")\n'                            End If\n'                        iMA_ID = Nz(DAOARRAY1(1, iZl), 0)\n'                        strMAName = Nz(DAOARRAY1(2, iZl))\n'                        bfraglich = Nz(DAOARRAY1(5, iZl), 0)\n'                    End If\n'\n'                    .Fields(\"Tag\" & i & \"_MA_ID\") = iMA_ID\n'                    .Fields(\"Tag\" & i & \"_Name\") = strMAName\n'                    .Fields(\"Tag\" & i & \"_fraglich\") = bfraglich\n'                    .Fields(\"Tag\" & i & \"_von\") = strvon\n'                    .Fields(\"Tag\" & i & \"_bis\") = strbis\n'\n'                 Else\n'                    strvon = \"\"\n'                    strbis = \"\"\n'                    iMA_ID = .Fields(\"MA_ID\")\n'                    strMAName = \"\"\n'                    bfraglich = 0\n'                    .Fields(\"Tag\" & i & \"_MA_ID\") = iMA_ID\n'                    .Fields(\"Tag\" & i & \"_Name\") = strMAName\n'                    .Fields(\"Tag\" & i & \"_fraglich\") = bfraglich\n'                    .Fields(\"Tag\" & i & \"_von\") = strvon\n'                    .Fields(\"Tag\" & i & \"_bis\") = strbis\n'                End If\n'            Next i\n'\n'        .Update\n'        .MoveNext\n'    Loop\n'    .Close\n'End With\n'Set rst = Nothing\n'\n'Call Set_Priv_Property(\"prp_Dienstpl_StartDatum_Vgl\", dtstartdat)\n'Set DAOARRAY1 = Nothing\n'\n'End Function\n\n\n'Function fCreate_DP_MA_tmptable(dtstartdat As Date, iNurAktiveMA As Long)\n'Original V60 Version\n'\n'Dim dt(6) As Date\n'Dim strdtPkt(6) As String\n'Dim strdtUdl(6) As String\n'Dim i As Long, j As Long, k As Long\n'Dim strSQL As String\n'Dim chr34 As String\n'Dim OrtVgl As String\n'\n'Dim iZuoID As Long\n'Dim iMA_ID As Long\n'Dim strMAName As String\n'Dim bfraglich As Boolean\n'Dim strvon As String\n'Dim strbis As String\n'Dim ztV As Variant\n'Dim zt As Date\n'\n'\n'Dim db As DAO.Database\n'Dim rst As DAO.Recordset\n'Dim Dttmp As Date\n'\n'Dim strSQLWhere As String\n'Dim strSQLOrderBy As String\n'\n'Set db = CurrentDb\n'\n'chr34 = Chr$(34)\n''Datum füllen\n'For i = 0 To 6\n'    dt(i) = dtstartdat + i\n'    strdtPkt(i) = Format(dt(i), \"Short Date\")\n'    strdtUdl(i) = Replace(strdtPkt(i), \".\", \"_\")\n'Next i\n'\n'' Erzeugen Query \"qry_DP_Alle_MA_Zt\"\n'\n'\n'strSQL = \"\"\n'strSQL = strSQL & \"SELECT qry_DP_Alle.*, 1 AS Hlp FROM qry_DP_Alle WHERE (((qry_DP_Alle.VADatum)\"\n'strSQL = strSQL & \" Between \" & SQLDatum(dt(0)) & \" AND \" & SQLDatum(dt(6)) & \") AND ((qry_DP_Alle.MA_ID)>0))\"\n'strSQL = strSQL & \" ORDER BY qry_DP_Alle.MAName, qry_DP_Alle.VADatum, qry_DP_Alle.MA_Start\"\n'strSQL = strSQL & \" UNION \"\n'strSQL = strSQL & \" SELECT -1 AS VA_ID, -1 AS ZuordID, 1 AS Anz_MA, tbl_MA_Zeittyp.ZeitTyp AS ObjOrt, CDate(Fix(CDbl([vonDat]))) AS VADatum,\"\n'strSQL = strSQL & \" 1 AS Pos_Nr, tbl_MA_NVerfuegZeiten.vonDat AS MA_Start, tbl_MA_NVerfuegZeiten.bisDat AS MA_Ende, tbl_MA_NVerfuegZeiten.MA_ID,\"\n'strSQL = strSQL & \" [Nachname] & ' ' & [Vorname] AS MAName, 0 AS IstFraglich, 1 AS Hlp\"\n'strSQL = strSQL & \" FROM tbl_MA_Zeittyp INNER JOIN (tbl_MA_Mitarbeiterstamm RIGHT JOIN tbl_MA_NVerfuegZeiten ON tbl_MA_Mitarbeiterstamm.ID = tbl_MA_NVerfuegZeiten.MA_ID) ON tbl_MA_Zeittyp.Kuerzel_Datev = tbl_MA_NVerfuegZeiten.Zeittyp_ID\"\n'strSQL = strSQL & \" WHERE (((CDate(Fix(CDbl([vonDat])))) Between \" & SQLDatum(dt(0)) & \" AND \" & SQLDatum(dt(6)) & \"));\"\n'If Not CreateQuery(strSQL, \"qry_DP_Alle_MA_Zt\") Then\n'    MsgBox strSQL, vbCritical, \"Fehler beim Create der Tabelle 'qry_DP_Alle_MA_Zt'\"\n'    Exit Function\n'End If\n'\n''In tmp Taberlle speichern um Anzahl Einsätze pro Tag > 1 zu setzen\n'CurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_1;\")\n'DoEvents\n'CurrentDb.Execute (\"qry_DP_MA_1\")\n'DoEvents\n'\n'' Wenn MA Name leer, Anzeige der MA_ID\n'CurrentDb.Execute (\"UPDATE tbltmp_DP_MA_1 SET tbltmp_DP_MA_1.MAName = [MA_ID] WHERE (((Len(Trim(Nz([MAName]))))=0));\")\n'\n'\n'recsetSQL1 = \"qry_DP_MA_2\"\n'ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n''Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n'\n''Hlp = Anzahl Jobs pro Tag korrigieren (für Kreuztabelle)\n'If ArrFill_DAO_OK1 Then\n'    For iZl = 0 To iZLMax1\n'        i = 1\n'        strSQL = \"\"\n'        strSQL = strSQL & \"SELECT tbltmp_DP_MA_1.* FROM tbltmp_DP_MA_1\"\n'        strSQL = strSQL & \" WHERE (((tbltmp_DP_MA_1.MA_ID)=\" & CLng(DAOARRAY1(0, iZl)) & \" ) AND ((tbltmp_DP_MA_1.VADatum)= \" & SQLDatum(DAOARRAY1(1, iZl)) & \")) ORDER BY MA_Start ASC ;\"\n'        Set rst = db.OpenRecordset(strSQL)\n'        With rst\n'            Do While Not .EOF\n'                .Edit\n'                    .Fields(\"Hlp\") = i\n'                .Update\n'                i = i + 1\n'                .MoveNext\n'            Loop\n'            .Close\n'        End With\n'        Set rst = Nothing\n'    Next iZl\n'End If\n'DoEvents\n'\n'' Erzeugen Query \"qry_DP_MA_Kreuztabelle\"\n'strSQL = \"\"\n'\n'strSQL = strSQL & \"TRANSFORM First(tbltmp_DP_MA_1.ZuordID) AS ErsterWertvonZuordID SELECT tbltmp_DP_MA_1.MAName, tbltmp_DP_MA_1.MA_ID, tbltmp_DP_MA_1.Hlp\"\n'strSQL = strSQL & \" FROM tbltmp_DP_MA_1 GROUP BY tbltmp_DP_MA_1.MAName, tbltmp_DP_MA_1.MA_ID, tbltmp_DP_MA_1.Hlp PIVOT Format([VADatum],'Short Date')\"\n'strSQL = strSQL & \" IN ('\" & strdtPkt(0) & \"','\" & strdtPkt(1) & \"', '\" & strdtPkt(2) & \"', '\" & strdtPkt(3) & \"', '\" & strdtPkt(4) & \"', '\" & strdtPkt(5) & \"', '\" & strdtPkt(6) & \"');\"\n'\n''strSQL = Replace(strSQL, \"'\", chr34)\n'If Not CreateQuery(strSQL, \"qry_DP_MA_Kreuztabelle\") Then\n'    MsgBox strSQL, vbCritical, \"Fehler beim Create der Tabelle 'qry_DP_MA_Kreuztabelle'\"\n'    Exit Function\n'End If\n'\n'CurrentDb.Execute (\"Delete * FROM tbltmp_DP_MA_Grund;\")\n'DoEvents\n'\n'strSQL = \"\"\n'strSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Grund SELECT MA_ID, MAName, Hlp,\"\n'strSQL = strSQL & \" [\" & strdtUdl(0) & \"] AS Tag1_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(1) & \"] AS Tag2_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(2) & \"] AS Tag3_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(3) & \"] AS Tag4_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(4) & \"] AS Tag5_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(5) & \"] AS Tag6_Zuo_ID,\"\n'strSQL = strSQL & \" [\" & strdtUdl(6) & \"] AS Tag7_Zuo_ID\"\n'strSQL = strSQL & \" FROM qry_DP_MA_Kreuztabelle ORDER BY MAName, Hlp;\"\n'CurrentDb.Execute (strSQL)\n'DoEvents\n'\n'CurrentDb.Execute (\"UPDATE tbltmp_DP_MA_Grund SET tbltmp_DP_MA_Grund.Startdat = \" & SQLDatum(dtstartdat) & \";\")\n'DoEvents\n'\n'recsetSQL1 = \"qry_DP_Alle_MA_Zt_Fill\"\n'ArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n''Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n'\n'If Not ArrFill_DAO_OK1 Then\n''    MsgBox \"Probleme beim füllen von qry_DP_Alle_MA_Zt_Fill\"\n''    Exit Function\n'End If\n'\n''ZuoID = 0\n''MA_ID = 1\n''Name = 2\n''MA_Start = 3\n''MA_Ende = 4\n''Istfraglich = 5\n'\n'Set rst = db.OpenRecordset(\"SELECT * FROM tbltmp_DP_MA_Grund ORDER BY ID\")\n'With rst\n'    OrtVgl = \"\"\n'    Do While Not .EOF\n'        .Edit\n''            If OrtVgl = .Fields(\"MAName\") Then\n''                .Fields(\"MAName\") = \"\"\n''            Else\n''                OrtVgl = .Fields(\"MAName\")\n''            End If\n'            For i = 1 To 7\n'               iZuoID = Nz(.Fields(\"Tag\" & i & \"_Zuo_ID\"), 0)\n'               strvon = \"\"\n'               strbis = \"\"\n'               iMA_ID = 0\n'               strMAName = \"\"\n'               bfraglich = 0\n'               If iZuoID > 0 Then\n'                    iZl = fSuchZl(iZuoID)\n'                    If ArrFill_DAO_OK1 Then\n'                        ztV = Nz(DAOARRAY1(3, iZl))\n'                        If Len(Trim(ztV)) > 0 Then\n'                            strvon = Format(ztV, \"hh:nn\")\n'                        End If\n'                        ztV = Nz(DAOARRAY1(4, iZl))\n'                        If Len(Trim(ztV)) > 0 Then\n'                            strbis = Format(ztV, \"hh:nn\")\n'                            End If\n'                        iMA_ID = Nz(DAOARRAY1(2, iZl), 0)\n'                        strMAName = Nz(DAOARRAY1(1, iZl))\n'                        bfraglich = Nz(DAOARRAY1(5, iZl), 0)\n'                    End If\n'\n'                    .Fields(\"Tag\" & i & \"_MA_ID\") = iMA_ID\n'                    .Fields(\"Tag\" & i & \"_Name\") = strMAName\n'                    .Fields(\"Tag\" & i & \"_fraglich\") = bfraglich\n'                    .Fields(\"Tag\" & i & \"_von\") = strvon\n'                    .Fields(\"Tag\" & i & \"_bis\") = strbis\n'\n'                ElseIf iZuoID < 0 Then\n'                    strvon = \"\"\n'                    strbis = \"\"\n'                    iMA_ID = .Fields(\"MA_ID\")\n'                    Dttmp = dt(i - 1)\n'                    strMAName = \"\"\n'                    bfraglich = 0\n'                    If ArrFill_DAO_OK1 Then\n'                        ztV = Nz(DAOARRAY1(3, iZl))\n'                        If Len(Trim(ztV)) > 0 Then\n'                            strvon = Format(ztV, \"hh:nn\")\n'                        End If\n'                        If IsNull(DAOARRAY1(3, iZl)) Then\n'                            strvon = \"\"\n'                        End If\n'                        ztV = Nz(DAOARRAY1(4, iZl))\n'                        If Len(Trim(ztV)) > 0 Then\n'                            strbis = Format(ztV, \"hh:nn\")\n'                        End If\n'                        If IsNull(DAOARRAY1(4, iZl)) Then\n'                            strbis = \"\"\n'                        End If\n'                    End If\n'                    strMAName = Nz(TLookup(\"ObjOrt\", \"tbltmp_DP_MA_1\", \"ZuordID = -1 AND Vadatum = \" & SQLDatum(Dttmp) & \" AND MA_ID = \" & iMA_ID))\n'                    .Fields(\"Tag\" & i & \"_MA_ID\") = iMA_ID\n'                    .Fields(\"Tag\" & i & \"_Name\") = strMAName\n'                    .Fields(\"Tag\" & i & \"_fraglich\") = bfraglich\n'                    .Fields(\"Tag\" & i & \"_von\") = strvon\n'                    .Fields(\"Tag\" & i & \"_bis\") = strbis\n'                End If\n'            Next i\n'\n'        .Update\n'        .MoveNext\n'    Loop\n'    .Close\n'End With\n'Set rst = Nothing\n'Set DAOARRAY1 = Nothing\n'\n'Select Case iNurAktiveMA\n'    Case 1 ' Nur Aktive\n'        strSQLWhere = \" AND IstAktiv = True \"\n'    Case 2 ' Nur Festangestellte  'Anstellungsart 3\n'        strSQLWhere = \" AND Anstellungsart_ID = 3 \"\n'    Case 3 ' Nur Minijobber  ' Anstellungsart 5\n'        strSQLWhere = \" AND Anstellungsart_ID = 5 \"\n'    Case 4 ' Nur Unternehmer  ' IstSubunternehmer = True\n'        strSQLWhere = \" AND IstSubunternehmer = True \"\n'    Case Else ' Alle\n'        strSQLWhere = \"\"\n'\n'End Select\n'strSQLOrderBy = \" ORDER BY Nachname, Vorname\"\n'\n'strSQL = \"\"\n'strSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Grund ( MA_ID, MAName, Startdat, Hlp )\"\n'strSQL = strSQL & \" SELECT tbl_MA_Mitarbeiterstamm.ID, [Nachname] & ' ' & [Vorname] AS NName, \" & SQLDatum(dtstartdat) & \" AS Ausdr1, 1 AS Ausdr2\"\n'strSQL = strSQL & \" FROM tbl_MA_Mitarbeiterstamm WHERE (((tbl_MA_Mitarbeiterstamm.ID) Not In (Select Distinct MA_ID FROM tbltmp_DP_MA_1))\"\n'strSQL = strSQL & strSQLWhere & \")\" & strSQLOrderBy\n'CurrentDb.Execute (strSQL)\n'\n'DoEvents\n'CurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_Grund_FI;\")\n'DoEvents\n'\n'strSQLOrderBy = \" ORDER BY MAName\"\n'\n'strSQL = \"\"\n'strSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Grund_FI ( Startdat, MA_ID, MAName, Hlp, Tag1_Zuo_ID, Tag1_MA_ID, Tag1_Name, Tag1_fraglich, Tag1_von, Tag1_bis,\"\n'strSQL = strSQL & \" Tag2_Zuo_ID, Tag2_MA_ID, Tag2_Name, Tag2_fraglich, Tag2_von, Tag2_bis, Tag3_Zuo_ID, Tag3_MA_ID, Tag3_Name, Tag3_fraglich, Tag3_von, Tag3_bis,\"\n'strSQL = strSQL & \" Tag4_Zuo_ID, Tag4_MA_ID, Tag4_Name, Tag4_fraglich, Tag4_von, Tag4_bis, Tag5_Zuo_ID, Tag5_MA_ID, Tag5_Name, Tag5_fraglich, Tag5_von,\"\n'strSQL = strSQL & \" Tag5_bis, Tag6_Zuo_ID, Tag6_MA_ID, Tag6_Name, Tag6_fraglich, Tag6_von, Tag6_bis, Tag7_Zuo_ID, Tag7_MA_ID, Tag7_Name, Tag7_fraglich, Tag7_von, Tag7_bis )\"\n'strSQL = strSQL & \" SELECT Startdat, MA_ID, MAName, Hlp, Tag1_Zuo_ID, Tag1_MA_ID, Tag1_Name, Tag1_fraglich, Tag1_von, Tag1_bis, Tag2_Zuo_ID, Tag2_MA_ID,\"\n'strSQL = strSQL & \" Tag2_Name, Tag2_fraglich, Tag2_von, Tag2_bis, Tag3_Zuo_ID, Tag3_MA_ID, Tag3_Name, Tag3_fraglich, Tag3_von, Tag3_bis, Tag4_Zuo_ID,\"\n'strSQL = strSQL & \" Tag4_MA_ID, Tag4_Name, Tag4_fraglich, Tag4_von, Tag4_bis, Tag5_Zuo_ID, Tag5_MA_ID, Tag5_Name, Tag5_fraglich, Tag5_von, Tag5_bis,\"\n'strSQL = strSQL & \" Tag6_Zuo_ID , Tag6_MA_ID, Tag6_Name, Tag6_fraglich, Tag6_von, Tag6_bis, Tag7_Zuo_ID, Tag7_MA_ID, Tag7_Name, Tag7_fraglich, Tag7_von, Tag7_bis\"\n'strSQL = strSQL & \" FROM qry_DP_Temp_Imp_MA WHERE (1 = 1\"\n'strSQL = strSQL & strSQLWhere & \")\" & strSQLOrderBy\n'CurrentDb.Execute (strSQL)\n'\n'DoEvents\n'\n'Set rst = db.OpenRecordset(\"SELECT * FROM tbltmp_DP_MA_Grund_FI ORDER BY ID\")\n'With rst\n'    OrtVgl = \"\"\n'    Do While Not .EOF\n'        .Edit\n'            If OrtVgl = .Fields(\"MAName\") Then\n'                .Fields(\"MAName\") = \"\"\n'            Else\n'                OrtVgl = .Fields(\"MAName\")\n'            End If\n'        .Update\n'        .MoveNext\n'    Loop\n'    .Close\n'End With\n'Set rst = Nothing\n'\n'DoEvents\n'\n''CurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_Grund;\")\n'\n'DoEvents\n'\n'\n'Call Set_Priv_Property(\"prp_Dienstpl_StartDatum_Vgl\", dtstartdat)\n'End Function\n\n'\n\nFunction ftstxx()\n    Call fCreate_DP_MA_tmptable(DateSerial(2015, 11, 23), 2)\n    \nEnd Function\n\n\n'Function fSuchZl2(i As Long, iMA_ID As Long, dt As Date) As Long\n'fSuchZl2 = -1000\n''ZuoID = 0\n''MA_ID = 1\n''Name = 2 ' objOrt\n''MA_Start = 3\n''MA_Ende = 4\n''Istfraglich = 5\n''VADatum = 6\n'\n'For iZl = 0 To iZLMax1\n'    If DAOARRAY1(0, iZl) = i And DAOARRAY1(1, iZl) = iMA_ID And CDate(DAOARRAY1(6, iZl)) = dt Then\n'        fSuchZl2 = iZl\n'        Exit For\n'    End If\n'Next iZl\n'End Function\n\n\nFunction fCreate_DP_MA_tmptable(dtstartdat As Date, iNurAktiveMA As Long)\n\nDim dt(6) As Date\nDim strdtPkt(6) As String\nDim strdtUdl(6) As String\nDim i As Long, j As Long, k As Long\nDim c As Integer\nDim strSQL As String\nDim chr34 As String\nDim OrtVgl As String\n\nDim iZuoID As Long\nDim iMA_ID As Long\nDim strMAName As String\nDim bfraglich As Boolean\nDim strvon As String\nDim strbis As String\nDim ztV As Variant\nDim zt As Date\n\n\nDim db As DAO.Database\nDim rst As DAO.Recordset\nDim Dttmp As Date\n\nDim strSQLWhere As String\nDim strSQLOrderBy As String\n\nSet db = CurrentDb\n\nchr34 = Chr$(34)\n'Datum füllen\nFor i = 0 To 6\n    dt(i) = dtstartdat + i\n    strdtPkt(i) = Format(dt(i), \"Short Date\")\n    strdtUdl(i) = Replace(strdtPkt(i), \".\", \"_\")\nNext i\n\n' Erzeugen Query \"qry_DP_Alle_MA_Zt\"\n\n\nstrSQL = \"\"\nstrSQL = strSQL & \"SELECT qry_DP_Alle.*, 1 AS Hlp FROM qry_DP_Alle WHERE (((qry_DP_Alle.VADatum)\"\nstrSQL = strSQL & \" Between \" & SQLDatum(dt(0)) & \" AND \" & SQLDatum(dt(6)) & \") AND ((qry_DP_Alle.MA_ID)>0))\"\nstrSQL = strSQL & \" ORDER BY qry_DP_Alle.MAName, qry_DP_Alle.VADatum, qry_DP_Alle.MA_Start, qry_DP_Alle.MA_Ende\"\nstrSQL = strSQL & \" UNION \"\nstrSQL = strSQL & \" SELECT -1 AS VA_ID,  (([tbl_MA_Zeittyp].ID) * -1) AS ZuordID, 1 AS Anz_MA, tbl_MA_Zeittyp.ZeitTyp AS ObjOrt, CDate(Fix(CDbl([vonDat]))) AS VADatum,\"\nstrSQL = strSQL & \" 1 AS Pos_Nr, Format(tbl_MA_NVerfuegZeiten.vonDat, 'hh:nn',2) AS MA_Start, Format(tbl_MA_NVerfuegZeiten.bisDat, 'hh:nn', 2) AS MA_Ende, tbl_MA_NVerfuegZeiten.MA_ID,\"\nstrSQL = strSQL & \" [Nachname] & ' ' & [Vorname] AS MAName, 0 AS IstFraglich, 1 AS Hlp\"\nstrSQL = strSQL & \" FROM tbl_MA_Zeittyp INNER JOIN (tbl_MA_Mitarbeiterstamm RIGHT JOIN tbl_MA_NVerfuegZeiten ON tbl_MA_Mitarbeiterstamm.ID = tbl_MA_NVerfuegZeiten.MA_ID) ON tbl_MA_Zeittyp.Kuerzel_Datev = tbl_MA_NVerfuegZeiten.Zeittyp_ID\"\nstrSQL = strSQL & \" WHERE (((CDate(Fix(CDbl([vonDat])))) Between \" & SQLDatum(dt(0)) & \" AND \" & SQLDatum(dt(6)) & \"));\"\nIf Not CreateQuery(strSQL, \"qry_DP_Alle_MA_Zt\") Then\n    MsgBox strSQL, vbCritical, \"Fehler beim Create der Tabelle 'qry_DP_Alle_MA_Zt'\"\n    Exit Function\nEnd If\n\n'In tmp Taberlle speichern um Anzahl Einsätze pro Tag > 1 zu setzen\nCurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_1;\")\nDoEvents\nCurrentDb.Execute (\"qry_DP_MA_1\")\nDoEvents\n\n' Wenn MA Name leer, Anzeige der MA_ID\nCurrentDb.Execute (\"UPDATE tbltmp_DP_MA_1 SET tbltmp_DP_MA_1.MAName = [MA_ID] WHERE (((Len(Trim(Nz([MAName]))))=0));\")\n\n\nrecsetSQL1 = \"qry_DP_MA_2\"\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n\n'Hlp = Anzahl Jobs pro Tag korrigieren (für Kreuztabelle)\nIf ArrFill_DAO_OK1 Then\n    For iZl = 0 To iZLMax1\n        i = 1\n        strSQL = \"\"\n        strSQL = strSQL & \"SELECT tbltmp_DP_MA_1.* FROM tbltmp_DP_MA_1\"\n        strSQL = strSQL & \" WHERE (((tbltmp_DP_MA_1.MA_ID)=\" & CLng(DAOARRAY1(0, iZl)) & \" ) AND ((tbltmp_DP_MA_1.VADatum)= \" & SQLDatum(DAOARRAY1(1, iZl)) & \")) ORDER BY MA_Start ASC, MA_Ende ASC;\"\n        Set rst = db.OpenRecordset(strSQL)\n        With rst\n            Do While Not .EOF\n                .Edit\n                    .fields(\"Hlp\") = i\n                .update\n                i = i + 1\n                .MoveNext\n            Loop\n            .Close\n        End With\n        Set rst = Nothing\n    Next iZl\nEnd If\nDoEvents\n\n' Erzeugen Query \"qry_DP_MA_Kreuztabelle\"\nstrSQL = \"\"\n\nstrSQL = strSQL & \"TRANSFORM First(tbltmp_DP_MA_1.ZuordID) AS ErsterWertvonZuordID SELECT tbltmp_DP_MA_1.MAName, tbltmp_DP_MA_1.MA_ID, tbltmp_DP_MA_1.Hlp\"\nstrSQL = strSQL & \" FROM tbltmp_DP_MA_1 GROUP BY tbltmp_DP_MA_1.MAName, tbltmp_DP_MA_1.MA_ID, tbltmp_DP_MA_1.Hlp ORDER BY tbltmp_DP_MA_1.Hlp PIVOT Format([VADatum],'Short Date')\"\nstrSQL = strSQL & \" IN ('\" & strdtPkt(0) & \"','\" & strdtPkt(1) & \"', '\" & strdtPkt(2) & \"', '\" & strdtPkt(3) & \"', '\" & strdtPkt(4) & \"', '\" & strdtPkt(5) & \"', '\" & strdtPkt(6) & \"');\"\n\n'strSQL = Replace(strSQL, \"'\", chr34)\nIf Not CreateQuery(strSQL, \"qry_DP_MA_Kreuztabelle\") Then\n    MsgBox strSQL, vbCritical, \"Fehler beim Create der Tabelle 'qry_DP_MA_Kreuztabelle'\"\n    Exit Function\nEnd If\n\nCurrentDb.Execute (\"Delete * FROM tbltmp_DP_MA_Grund;\")\nDoEvents\n\nstrSQL = \"\"\nstrSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Grund SELECT MA_ID, MAName, Hlp,\"\nstrSQL = strSQL & \" [\" & strdtUdl(0) & \"] AS Tag1_Zuo_ID,\"\nstrSQL = strSQL & \" [\" & strdtUdl(1) & \"] AS Tag2_Zuo_ID,\"\nstrSQL = strSQL & \" [\" & strdtUdl(2) & \"] AS Tag3_Zuo_ID,\"\nstrSQL = strSQL & \" [\" & strdtUdl(3) & \"] AS Tag4_Zuo_ID,\"\nstrSQL = strSQL & \" [\" & strdtUdl(4) & \"] AS Tag5_Zuo_ID,\"\nstrSQL = strSQL & \" [\" & strdtUdl(5) & \"] AS Tag6_Zuo_ID,\"\nstrSQL = strSQL & \" [\" & strdtUdl(6) & \"] AS Tag7_Zuo_ID\"\nstrSQL = strSQL & \" FROM qry_DP_MA_Kreuztabelle ORDER BY MAName, Hlp;\"\nCurrentDb.Execute (strSQL)\nDoEvents\n\nCurrentDb.Execute (\"UPDATE tbltmp_DP_MA_Grund SET tbltmp_DP_MA_Grund.Startdat = \" & SQLDatum(dtstartdat) & \";\")\nDoEvents\n\n'recsetSQL1 = \"qry_DP_Alle_MA_Zt_Fill\"\nrecsetSQL1 = \"SELECT ZuordID, MA_ID, ObjOrt, MA_Start, MA_Ende, IstFraglich, VADatum FROM tbltmp_DP_MA_1 ORDER BY ZuordID\"\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n\nIf Not ArrFill_DAO_OK1 Then\n'    MsgBox \"Probleme beim füllen von qry_DP_Alle_MA_Zt_Fill\"\n'    Exit Function\nEnd If\n\n'ZuoID = 0\n'MA_ID = 1\n'Name = 2\n'MA_Start = 3\n'MA_Ende = 4\n'Istfraglich = 5\n'VADAtum = 6\n\nSet rst = db.OpenRecordset(\"SELECT * FROM tbltmp_DP_MA_Grund ORDER BY ID\")\nWith rst\n    OrtVgl = \"\"\n    Do While Not .EOF\n        .Edit\n'            If OrtVgl = .Fields(\"MAName\") Then\n'                .Fields(\"MAName\") = \"\"\n'            Else\n'                OrtVgl = .Fields(\"MAName\")\n'            End If\n            For i = 1 To 7\n               iZuoID = Nz(.fields(\"Tag\" & i & \"_Zuo_ID\"), 0)\n               strvon = \"\"\n               strbis = \"\"\n               iMA_ID = Nz(.fields(\"MA_ID\"), 0)\n               strMAName = \"\"\n               bfraglich = 0\n               If iZuoID <> 0 Then\n                    iZl = fSuchZl2(iZuoID, iMA_ID, dt(i - 1))\n                    If ArrFill_DAO_OK1 Then\n                        ztV = Nz(DAOARRAY1(3, iZl))\n                        If Len(Trim(ztV)) > 0 Then\n                            strvon = Format(ztV, \"hh:nn\")\n                        End If\n                        ztV = Nz(DAOARRAY1(4, iZl))\n                        If Len(Trim(ztV)) > 0 Then\n                            strbis = Format(ztV, \"hh:nn\")\n                            End If\n'                        iMA_ID = Nz(DAOARRAY1(1, iZl), 0)\n                        strMAName = Nz(DAOARRAY1(2, iZl))\n                        bfraglich = Nz(DAOARRAY1(5, iZl), 0)\n                    End If\n                    \n                    .fields(\"Tag\" & i & \"_MA_ID\") = iMA_ID\n                    .fields(\"Tag\" & i & \"_Name\") = strMAName\n                    .fields(\"Tag\" & i & \"_fraglich\") = bfraglich\n                    .fields(\"Tag\" & i & \"_von\") = strvon\n                    .fields(\"Tag\" & i & \"_bis\") = strbis\n                    \n                Else\n                    strvon = \"\"\n                    strbis = \"\"\n                    strMAName = \"\"\n                    bfraglich = 0\n                    .fields(\"Tag\" & i & \"_MA_ID\") = iMA_ID\n                    .fields(\"Tag\" & i & \"_Name\") = strMAName\n                    .fields(\"Tag\" & i & \"_fraglich\") = bfraglich\n                    .fields(\"Tag\" & i & \"_von\") = strvon\n                    .fields(\"Tag\" & i & \"_bis\") = strbis\n                End If\n            Next i\n    \n        .update\n        .MoveNext\n    Loop\n    .Close\nEnd With\nSet rst = Nothing\nSet DAOARRAY1 = Nothing\n\nSelect Case iNurAktiveMA\n    Case 1 ' Nur Aktive\n        strSQLWhere = \" AND Anstellungsart_ID = 3 or Anstellungsart_ID = 5  \"\n    Case 2 ' Nur Festangestellte  'Anstellungsart 3\n        strSQLWhere = \" AND Anstellungsart_ID = 3 \"\n    Case 3 ' Nur Minijobber  ' Anstellungsart 5\n        strSQLWhere = \" AND Anstellungsart_ID = 5 \"\n    Case 4 ' Nur Unternehmer  ' IstSubunternehmer = True\n        strSQLWhere = \" AND IstSubunternehmer = True \"\n    Case Else ' Alle\n        strSQLWhere = \" AND Anstellungsart_ID = 3 or Anstellungsart_ID = 5 or Anstellungsart_ID = 11   \"\n\nEnd Select\nstrSQLOrderBy = \" ORDER BY Nachname, Vorname\"\n\nstrSQL = \"\"\nstrSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Grund ( MA_ID, MAName, Startdat, Hlp )\"\nstrSQL = strSQL & \" SELECT tbl_MA_Mitarbeiterstamm.ID, [Nachname] & ' ' & [Vorname] AS NName, \" & SQLDatum(dtstartdat) & \" AS Ausdr1, 1 AS Ausdr2\"\nstrSQL = strSQL & \" FROM tbl_MA_Mitarbeiterstamm WHERE (((tbl_MA_Mitarbeiterstamm.ID) Not In (Select Distinct MA_ID FROM tbltmp_DP_MA_1))\"\nstrSQL = strSQL & strSQLWhere & \")\" & strSQLOrderBy\nCurrentDb.Execute (strSQL)\n\nDoEvents\nCurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_Grund_FI;\")\nDoEvents\n\nstrSQLOrderBy = \" ORDER BY MAName, hlp\"\n\nstrSQL = \"\"\nstrSQL = strSQL & \"INSERT INTO tbltmp_DP_MA_Grund_FI ( Startdat, MA_ID, MAName, Hlp, Tag1_Zuo_ID, Tag1_MA_ID, Tag1_Name, Tag1_fraglich, Tag1_von, Tag1_bis,\"\nstrSQL = strSQL & \" Tag2_Zuo_ID, Tag2_MA_ID, Tag2_Name, Tag2_fraglich, Tag2_von, Tag2_bis, Tag3_Zuo_ID, Tag3_MA_ID, Tag3_Name, Tag3_fraglich, Tag3_von, Tag3_bis,\"\nstrSQL = strSQL & \" Tag4_Zuo_ID, Tag4_MA_ID, Tag4_Name, Tag4_fraglich, Tag4_von, Tag4_bis, Tag5_Zuo_ID, Tag5_MA_ID, Tag5_Name, Tag5_fraglich, Tag5_von,\"\nstrSQL = strSQL & \" Tag5_bis, Tag6_Zuo_ID, Tag6_MA_ID, Tag6_Name, Tag6_fraglich, Tag6_von, Tag6_bis, Tag7_Zuo_ID, Tag7_MA_ID, Tag7_Name, Tag7_fraglich, Tag7_von, Tag7_bis )\"\nstrSQL = strSQL & \" SELECT Startdat, MA_ID, MAName, Hlp, Tag1_Zuo_ID, Tag1_MA_ID, Tag1_Name, Tag1_fraglich, Tag1_von, Tag1_bis, Tag2_Zuo_ID, Tag2_MA_ID,\"\nstrSQL = strSQL & \" Tag2_Name, Tag2_fraglich, Tag2_von, Tag2_bis, Tag3_Zuo_ID, Tag3_MA_ID, Tag3_Name, Tag3_fraglich, Tag3_von, Tag3_bis, Tag4_Zuo_ID,\"\nstrSQL = strSQL & \" Tag4_MA_ID, Tag4_Name, Tag4_fraglich, Tag4_von, Tag4_bis, Tag5_Zuo_ID, Tag5_MA_ID, Tag5_Name, Tag5_fraglich, Tag5_von, Tag5_bis,\"\nstrSQL = strSQL & \" Tag6_Zuo_ID , Tag6_MA_ID, Tag6_Name, Tag6_fraglich, Tag6_von, Tag6_bis, Tag7_Zuo_ID, Tag7_MA_ID, Tag7_Name, Tag7_fraglich, Tag7_von, Tag7_bis\"\nstrSQL = strSQL & \" FROM qry_DP_Temp_Imp_MA WHERE (1 = 1\"\nstrSQL = strSQL & strSQLWhere & \")\" & strSQLOrderBy\nCurrentDb.Execute (strSQL)\n\nDoEvents\n\nSet rst = db.OpenRecordset(\"SELECT * FROM tbltmp_DP_MA_Grund_FI ORDER BY ID\")\nWith rst\n    OrtVgl = \"\"\n    Do While Not .EOF\n        .Edit\n            If OrtVgl = .fields(\"MAName\") Then\n                .fields(\"MAName\") = \"\"\n            Else\n                OrtVgl = .fields(\"MAName\")\n            End If\n            'Stunden berechnen\n            For c = 1 To 7\n                If .fields(\"Tag\" & c & \"_von\") <> \"\" And .fields(\"Tag\" & c & \"_bis\") <> \"\" And .fields(\"Tag\" & c & \"_Zuo_ID\") > 0 Then _\n                    .fields(\"Stunden_gesamt\") = .fields(\"Stunden_gesamt\") + stunden(.fields(\"Tag\" & c & \"_von\"), .fields(\"Tag\" & c & \"_bis\"))\n            Next c\n        .update\n        .MoveNext\n    Loop\n    .Close\nEnd With\nSet rst = Nothing\n\nDoEvents\n\n'CurrentDb.Execute (\"DELETE * FROM tbltmp_DP_MA_Grund;\")\n\nDoEvents\n\n\nCall Set_Priv_Property(\"prp_Dienstpl_StartDatum_Vgl\", dtstartdat)\nEnd Function\n\n"}
