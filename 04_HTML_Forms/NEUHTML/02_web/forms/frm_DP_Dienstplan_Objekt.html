<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planungsuebersicht - CONSYS</title>
    <link rel="stylesheet" href="../css/app-layout.css">
    <link rel="stylesheet" href="../theme/consys_theme.css">
    <style>
        :root { --accent-color: #4316B2; }
        .app-header { background: #4316B2; min-height: 94px; }
        .dp-grid { display: grid; grid-template-columns: 200px repeat(7, 1fr); gap: 1px; background: #ccc; }
        .dp-header { background: #e8e8e8; padding: 8px 4px; font-weight: 600; text-align: center; font-size: 11px; }
        .dp-header-date { font-size: 10px; color: #666; }
        .dp-objekt { background: white; padding: 6px 8px; font-size: 11px; border-right: 2px solid #4316B2; }
        .dp-objekt-name { font-weight: 600; }
        .dp-objekt-kunde { font-size: 10px; color: #666; }
        .dp-cell { background: white; min-height: 60px; padding: 2px; font-size: 10px; }
        .dp-cell.weekend { background: #f5f5f5; }
        .dp-schicht {
            background: #f0f0f0;
            border-left: 3px solid #4316B2;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 2px;
        }
        .dp-schicht .zeit { font-weight: 600; font-size: 10px; }
        .dp-schicht .ma-count { font-size: 9px; }
        .dp-schicht.besetzt { border-left-color: #4316B2; background: #f0f0f0; }
        .dp-schicht.offen { border-left-color: #666666; background: #f0f0f0; }
    </style>
</head>
<body data-active-menu="dienstplan">
    <div class="app-container no-sidebar">
        <main class="app-main">
            <header class="app-header">
                <div class="header-left">
                    <h1 class="app-title">Planungsuebersicht</h1>
                </div>
                <div class="header-center">
                    <button class="btn btn-nav" id="btnVorwoche">&#9664;&#9664;</button>
                    <span id="lblWoche" style="min-width:200px;text-align:center;font-weight:600;">KW --</span>
                    <button class="btn btn-nav" id="btnNachwoche">&#9654;&#9654;</button>
                    <button class="btn" id="btnHeute" style="margin-left:10px;">Heute</button>
                </div>
                <div class="header-right">
                    <span id="header-date"></span>
                </div>
            </header>

            <div class="app-toolbar">
                <div class="toolbar-group">
                    <label class="toolbar-label">Zeitraum:</label>
                    <input type="date" id="datVon" class="form-control">
                    <span style="margin:0 4px;">bis</span>
                    <input type="date" id="datBis" class="form-control">
                </div>
                <div class="toolbar-separator"></div>
                <div class="toolbar-group">
                    <label class="toolbar-label">Objekt:</label>
                    <select id="cboObjekt" class="form-control" style="width:180px;">
                        <option value="">Alle Objekte</option>
                    </select>
                </div>
                <div class="toolbar-group">
                    <label class="toolbar-label">Status:</label>
                    <select id="cboStatus" class="form-control" style="width:120px;">
                        <option value="">Alle</option>
                        <option value="offen">Offen</option>
                        <option value="besetzt">Besetzt</option>
                    </select>
                </div>
                <div class="toolbar-separator"></div>
                <div class="toolbar-group">
                    <button class="btn btn-primary" id="btnAktualisieren">Aktualisieren</button>
                    <button class="btn" id="btnDrucken">Drucken</button>
                </div>
            </div>

            <div class="app-content" style="padding:8px;overflow:auto;">
                <div class="dp-grid" id="dpGrid">
                    <!-- Header -->
                    <div class="dp-header">Objekt</div>
                    <div class="dp-header">Mo<br><span class="dp-header-date">01.01.</span></div>
                    <div class="dp-header">Di<br><span class="dp-header-date">02.01.</span></div>
                    <div class="dp-header">Mi<br><span class="dp-header-date">03.01.</span></div>
                    <div class="dp-header">Do<br><span class="dp-header-date">04.01.</span></div>
                    <div class="dp-header">Fr<br><span class="dp-header-date">05.01.</span></div>
                    <div class="dp-header weekend">Sa<br><span class="dp-header-date">06.01.</span></div>
                    <div class="dp-header weekend">So<br><span class="dp-header-date">07.01.</span></div>

                    <!-- Beispiel -->
                    <div class="dp-objekt">
                        <div class="dp-objekt-name">Messe Stuttgart</div>
                        <div class="dp-objekt-kunde">Landesmesse</div>
                    </div>
                    <div class="dp-cell">
                        <div class="dp-schicht besetzt">
                            <div class="zeit">08:00-16:00</div>
                            <div class="ma-count">5/5 MA</div>
                        </div>
                    </div>
                    <div class="dp-cell">
                        <div class="dp-schicht offen">
                            <div class="zeit">08:00-16:00</div>
                            <div class="ma-count">3/5 MA</div>
                        </div>
                    </div>
                    <div class="dp-cell"></div>
                    <div class="dp-cell"></div>
                    <div class="dp-cell"></div>
                    <div class="dp-cell weekend"></div>
                    <div class="dp-cell weekend"></div>
                </div>
            </div>

            <footer class="app-footer">
                <div class="footer-left"><span id="lblStatus">Bereit</span></div>
                <div class="footer-right"><span id="lblAnzahl">0 Objekte | 0 Schichten</span></div>
            </footer>
        </main>
    </div>

    <script type="module">
        import { Bridge } from '../js/webview2-bridge.js';

        // State
        let currentWeekStart = getMonday(new Date());
        let objekte = [];
        let schichten = [];

        // DOM-Referenzen
        const dpGrid = document.getElementById('dpGrid');
        const lblWoche = document.getElementById('lblWoche');
        const lblStatus = document.getElementById('lblStatus');
        const lblAnzahl = document.getElementById('lblAnzahl');
        const datVon = document.getElementById('datVon');
        const datBis = document.getElementById('datBis');
        const cboObjekt = document.getElementById('cboObjekt');
        const cboStatus = document.getElementById('cboStatus');

        // Initialisierung
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            document.getElementById('header-date').textContent = new Date().toLocaleDateString('de-DE');

            // Event Listener
            document.getElementById('btnVorwoche').addEventListener('click', () => changeWeek(-1));
            document.getElementById('btnNachwoche').addEventListener('click', () => changeWeek(1));
            document.getElementById('btnHeute').addEventListener('click', gotoToday);
            document.getElementById('btnAktualisieren').addEventListener('click', loadData);
            document.getElementById('btnDrucken').addEventListener('click', () => window.print());
            cboObjekt.addEventListener('change', loadData);
            cboStatus.addEventListener('change', loadData);

            await loadObjektDropdown();
            updateWeekDisplay();
            await loadData();
        }

        // Objekt-Dropdown laden
        async function loadObjektDropdown() {
            try {
                const result = await Bridge.objekte.list({ aktiv: true });
                const data = result.data || result || [];
                cboObjekt.innerHTML = '<option value="">Alle Objekte</option>';
                data.forEach(obj => {
                    cboObjekt.innerHTML += `<option value="${obj.Objekt_ID}">${obj.Objekt || obj.Name}</option>`;
                });
            } catch (e) {
                console.error('Fehler beim Laden der Objekte:', e);
            }
        }

        // Woche wechseln
        function changeWeek(delta) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            updateWeekDisplay();
            loadData();
        }

        function gotoToday() {
            currentWeekStart = getMonday(new Date());
            updateWeekDisplay();
            loadData();
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function updateWeekDisplay() {
            const kw = getWeekNumber(currentWeekStart);
            const endOfWeek = new Date(currentWeekStart);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            lblWoche.textContent = `KW ${kw} (${formatDate(currentWeekStart)} - ${formatDate(endOfWeek)})`;
            datVon.value = formatDateISO(currentWeekStart);
            datBis.value = formatDateISO(endOfWeek);
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Daten laden via WebView2
        async function loadData() {
            try {
                setStatus('Lade Daten...');

                // Objekte laden
                const objektResult = await Bridge.objekte.list({ aktiv: true });
                objekte = objektResult.data || objektResult || [];

                // Filter nach Objekt
                const selectedObjekt = cboObjekt.value;
                if (selectedObjekt) {
                    objekte = objekte.filter(o => o.Objekt_ID == selectedObjekt);
                }

                // Schichten für Woche laden
                const von = formatDateISO(currentWeekStart);
                const bis = formatDateISO(new Date(currentWeekStart.getTime() + 6 * 24 * 60 * 60 * 1000));

                const schichtResult = await Bridge.execute('executeSQL', {
                    sql: `SELECT s.*, a.Objekt, a.Objekt_ID,
                          (SELECT COUNT(*) FROM tbl_MA_VA_Planung p WHERE p.VAStart_ID = s.ID) AS MA_Anzahl_Ist
                          FROM tbl_VA_Start s
                          LEFT JOIN tbl_VA_Auftragstamm a ON s.VA_ID = a.VA_ID
                          WHERE s.VADatum >= #${von}# AND s.VADatum <= #${bis}#`,
                    fetch: true
                });
                schichten = (schichtResult && schichtResult.rows) || [];

                // Filter nach Status
                const statusFilter = cboStatus.value;
                if (statusFilter === 'offen') {
                    schichten = schichten.filter(s => (s.MA_Anzahl_Ist || 0) < (s.MA_Anzahl || 0));
                } else if (statusFilter === 'besetzt') {
                    schichten = schichten.filter(s => (s.MA_Anzahl_Ist || 0) >= (s.MA_Anzahl || 0));
                }

                renderGrid();
                lblAnzahl.textContent = `${objekte.length} Objekte | ${schichten.length} Schichten`;
                setStatus('Bereit');
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                setStatus('Fehler beim Laden');
                renderGrid();
            }
        }

        // Grid rendern
        function renderGrid() {
            // Header-Zeile
            let html = '<div class="dp-header">Objekt</div>';
            for (let i = 0; i < 7; i++) {
                const day = new Date(currentWeekStart);
                day.setDate(day.getDate() + i);
                const isWeekend = i >= 5;
                const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
                html += `<div class="dp-header ${isWeekend ? 'weekend' : ''}">${dayNames[i]}<br><span class="dp-header-date">${formatDate(day)}</span></div>`;
            }

            // Objekt-Zeilen (gruppiert)
            const objektIds = [...new Set(schichten.map(s => s.Objekt_ID))];
            objektIds.forEach(objektId => {
                const objekt = objekte.find(o => o.Objekt_ID === objektId) || {};
                const objektSchichten = schichten.filter(s => s.Objekt_ID === objektId);

                html += `<div class="dp-objekt">
                    <div class="dp-objekt-name">${objekt.Objekt || objekt.Name || 'Unbekannt'}</div>
                    <div class="dp-objekt-kunde">${objekt.Kunde || ''}</div>
                </div>`;

                for (let i = 0; i < 7; i++) {
                    const day = new Date(currentWeekStart);
                    day.setDate(day.getDate() + i);
                    const dayStr = formatDateISO(day);
                    const isWeekend = i >= 5;

                    const daySchichten = objektSchichten.filter(s => formatDateISO(new Date(s.VADatum)) === dayStr);

                    html += `<div class="dp-cell ${isWeekend ? 'weekend' : ''}">`;
                    daySchichten.forEach(s => {
                        const besetzt = (s.MA_Anzahl_Ist || 0) >= (s.MA_Anzahl || 0);
                        html += `<div class="dp-schicht ${besetzt ? 'besetzt' : 'offen'}" data-va-id="${s.VA_ID}">
                            <div class="zeit">${s.VA_Start || ''}-${s.VA_Ende || ''}</div>
                            <div class="ma-count">${s.MA_Anzahl_Ist || 0}/${s.MA_Anzahl || 0} MA</div>
                        </div>`;
                    });
                    html += '</div>';
                }
            });

            dpGrid.innerHTML = html;

            // Click-Handler für Schichten
            dpGrid.querySelectorAll('.dp-schicht').forEach(el => {
                el.addEventListener('click', () => {
                    const vaId = el.dataset.vaId;
                    if (vaId) Bridge.navigate('frm_va_Auftragstamm', vaId);
                });
            });
        }

        // Helper
        function setStatus(text) { lblStatus.textContent = text; }
        function formatDate(d) { return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }); }
        function formatDateISO(d) { return d.toISOString().split('T')[0]; }
    </script>
</body>
</html>
