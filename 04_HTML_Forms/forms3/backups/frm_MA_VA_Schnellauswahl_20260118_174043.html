<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/unified-header.css">
    <link rel="stylesheet" href="css/form-titles.css">
    <script>
    // Auto-Load in Shell (Sidebar-Integration)
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const isInShell = urlParams.has('shell') || window.SHELL_PARAMS;
        const isInIframe = window.self !== window.top;
        if (!isInShell && !isInIframe) {
            const formName = window.location.pathname.split('/').pop();
            const recordId = urlParams.get('id') || urlParams.get('ma_id') || urlParams.get('kd_id') || urlParams.get('va_id');
            let shellUrl = 'shell.html?form=' + formName;
            if (recordId) shellUrl += '&id=' + recordId;
            for (const [key, value] of urlParams.entries()) {
                if (!['shell', 'id', 'ma_id', 'kd_id', 'va_id', '_t'].includes(key)) {
                    shellUrl += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(value);
                }
            }
            console.log('[Auto-Redirect] Lade mit Sidebar:', shellUrl);
            window.location.replace(shellUrl);
        }
    })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitarbeiter Auswahl - Offene Mail Anfragen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
        }

        body {
            background-color: #8080c0;
            overflow: hidden;
            height: 100vh;
        }

        .window-frame {
            background-color: #8080c0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0; /* KRITISCH: Flex-Kette für sticky header */
        }

        /* Left Menu (Sidebar) */
        .left-menu {
            width: 185px;
            background-color: #6060a0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
        }

        .menu-header {
            background-color: #000080;
            color: white;
            padding: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .menu-btn {
            background: linear-gradient(to bottom, #d0d0e0, #a0a0c0);
            padding: 8px 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            color: #000;
            font-weight: 500;
            position: relative;
            border: none;
            margin: 1px 0;
            overflow: visible;
        }

        /* Obere helle Kante - 4px nach rechts versetzt */
        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: calc(100% - 4px);
            height: 2px;
            background: #ffffff;
            z-index: 1;
        }

        /* Untere dunkle Kante - 4px nach links versetzt */
        .menu-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: calc(100% - 4px);
            height: 2px;
            background: #404070;
            z-index: 1;
        }

        .menu-btn:hover {
            background: linear-gradient(to bottom, #e0e0f0, #b0b0d0);
        }

        .menu-btn:active {
            background: linear-gradient(to bottom, #b0b0d0, #9090b0);
        }

        .menu-btn:active::before {
            background: #404070;
            left: 4px;
            width: calc(100% - 4px);
        }

        .menu-btn:active::after {
            background: #ffffff;
            right: 4px;
            width: calc(100% - 4px);
        }

        .menu-btn.active {
            background: linear-gradient(to bottom, #a0a0d0, #8080b0);
        }

        .menu-btn.active::before {
            background: #505080;
            left: 4px;
            width: calc(100% - 4px);
        }

        .menu-btn.active::after {
            background: #c0c0d8;
            right: 4px;
            width: calc(100% - 4px);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            background-color: #d3d3d3;
            padding: 3px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
            min-height: 0; /* KRITISCH: Flex-Kette für sticky header */
        }

        /* Auftrag-Auswahl Row (unterhalb unified-header) */
        .auftrag-selection-row {
            background-color: #d3d3d3;
            border: none;
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        /* Form Section */
        .form-section {
            background-color: #b8b8d8;
            border: 1px solid #606090;
            padding: 8px;
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 0; /* KRITISCH: Flex-Kette für sticky header */
        }

        /* Buttons */
        .btn {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 10px;
            white-space: nowrap;
        }

        .btn:hover {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-green {
            background: linear-gradient(to bottom, #60c060, #308030);
            color: white;
        }

        /* Form Elements */
        .form-label {
            font-size: 10px;
            font-weight: bold;
        }

        .form-select, .form-input {
            border: 1px solid #808080;
            padding: 1px 3px;
            font-size: 10px;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #000080;
            box-shadow: 0 0 2px #000080;
        }

        .form-input.readonly {
            background: #e0e0e0;
        }

        /* Filter Row */
        .filter-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
        }

        input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        /* Lists Container */
        .lists-container {
            display: flex;
            gap: 8px;
            flex: 1;
            overflow: hidden;
            min-height: 0; /* KRITISCH: Flex-Kette für sticky header */
        }

        .list-panel {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .list-panel.narrow {
            width: 200px; /* 170+30=200px breiter (14.01.2026) */
            flex-shrink: 0;
        }

        .list-panel.wide {
            flex: 1;
            min-width: 430px; /* 280+150=430px breiter (14.01.2026) */
            max-width: 570px; /* 420+150=570px breiter (14.01.2026) */
            min-height: 0; /* KRITISCH: Flex-Kette für sticky header */
        }

        .list-panel.medium {
            width: 250px; /* 220+30=250px breiter (14.01.2026) */
            flex-shrink: 0;
        }

        .button-column {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
            width: 40px;
            flex-shrink: 0;
        }

        /* Checkbox-Block Container */
        .checkbox-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Auftrag-Info Styles */
        .auftrag-label {
            font-size: 13px;
            font-weight: bold;
        }

        .auftrag-title {
            font-size: 13px;
            font-weight: bold;
        }

        .datum-display {
            font-size: 13px;
            font-weight: bold;
        }

        .grid-wrapper {
            flex: 1;
            overflow: auto;
            border: 1px solid #808080;
            background: white;
            min-height: 0; /* KRITISCH: Flex-Kette für sticky header */
        }

        /* Listbox Styles */
        .listbox-header {
            display: flex;
            background-color: #e0e0e0;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            padding: 4px;
            position: sticky;
            top: 0;
        }

        .listbox-row {
            display: flex;
            padding: 3px 4px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .listbox-row:hover {
            background-color: #e8f4fc;
        }

        .listbox-row.selected {
            background-color: #000080;
            color: white;
        }

        /* Status-Farbcodierung wie in Access (Status_ID) */
        .listbox-row.geplant {
            /* Status 1: Geplant - kein besonderer Hintergrund */
        }

        .listbox-row.benachrichtigt {
            /* Status 2: Benachrichtigt/Angefragt - Gelb */
            background-color: #fff3cd;
        }

        .listbox-row.zugesagt {
            /* Status 3: Zugesagt - Gruen */
            background-color: #d4edda;
        }

        .listbox-row.abgesagt {
            /* Status 4: Abgesagt - Rot */
            background-color: #f8d7da;
            text-decoration: line-through;
        }

        .listbox-row.krank, .listbox-row.urlaub {
            /* Status 5/6: Krank/Urlaub - Grau */
            background-color: #e2e3e5;
            color: #6c757d;
        }

        /* Entfernungs-Farbcodierung */
        .entf-gruen {
            color: #008000;
            font-weight: bold;
        }

        .entf-gelb {
            color: #B8860B;
            font-weight: bold;
        }

        .entf-rot {
            color: #CC0000;
            font-weight: bold;
        }

        .entf-unbekannt {
            color: #808080;
            font-style: italic;
        }

        /* Vollbild-Button oben rechts */
        .fullscreen-btn {
            position: fixed;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
            border: 2px solid;
            border-color: #ffffff #606060 #606060 #ffffff;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #000080;
        }

        .fullscreen-btn:hover {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
        }

        .fullscreen-btn:active {
            border-color: #606060 #ffffff #ffffff #606060;
        }

        /* ============================================
           ANFRAGE-LOG MODAL (Phase 2)
           ============================================ */
        .anfrage-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .anfrage-modal-overlay.show {
            display: flex;
        }

        .anfrage-modal {
            background: #d4d0c8;
            border: 2px solid;
            border-color: #ffffff #404040 #404040 #ffffff;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .anfrage-modal-header {
            background: linear-gradient(to right, #000080, #1084d0);
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .anfrage-modal-close {
            background: #c0c0c0;
            border: 1px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            width: 18px;
            height: 18px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .anfrage-modal-close:hover {
            background: #d0d0d0;
        }

        .anfrage-modal-body {
            padding: 12px;
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0; /* KRITISCH: Flex-Kette für sticky header */
        }

        .anfrage-progress-container {
            background: #ffffff;
            border: 1px solid #808080;
            padding: 8px;
        }

        .anfrage-progress-label {
            font-size: 11px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .anfrage-progress-bar {
            height: 20px;
            background: #e0e0e0;
            border: 1px inset #808080;
            position: relative;
        }

        .anfrage-progress-fill {
            height: 100%;
            background: linear-gradient(to bottom, #00aa00, #008800);
            width: 0%;
            transition: width 0.3s ease;
        }

        .anfrage-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
            color: #000;
        }

        .anfrage-log-table {
            width: 100%;
            border-collapse: separate; /* GEÄNDERT für sticky header */
            border-spacing: 0; /* KRITISCH: Ersetzt collapse */
            font-size: 11px;
            background: white;
        }

        .anfrage-log-table th {
            background: #000080;
            color: white;
            padding: 4px 8px;
            text-align: left;
            border: 1px solid #404040;
            position: sticky; /* KRITISCH: Sticky header */
            top: 0;
            z-index: 10;
        }

        .anfrage-log-table td {
            padding: 3px 8px;
            border: 1px solid #c0c0c0;
        }

        .anfrage-log-table tr:nth-child(even) {
            background: #f0f0f0;
        }

        .anfrage-log-table .status-ok {
            color: #008800;
            font-weight: bold;
        }

        .anfrage-log-table .status-fehler {
            color: #cc0000;
            font-weight: bold;
        }

        .anfrage-log-table .status-skip {
            color: #808080;
        }

        .anfrage-modal-footer {
            padding: 8px 12px;
            background: #d4d0c8;
            border-top: 1px solid #808080;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .anfrage-summary {
            font-size: 11px;
        }

        .anfrage-modal-btn {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            padding: 4px 16px;
            cursor: pointer;
            font-size: 11px;
        }

        .anfrage-modal-btn:hover {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
        }

        .anfrage-modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    </style>
    <link rel="stylesheet" href="consys-common.css">
    <link rel="stylesheet" href="css/fonts_override.css">
    <script src="js/performance-init.js"></script>
<link rel="stylesheet" href="css/visbug_overrides.css">
</head>
<body data-form="frm_MA_VA_Schnellauswahl">
    <button class="fullscreen-btn tiny-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="Vollbild">â›¶</button>
    <div class="window-frame">
        <!-- Unified Header -->
        <div class="header-row-wrapper">
            <div class="header-row combined-buttons">
                <div class="logo-box">C</div>
                <span class="title-text" style="font-size: 16px; font-weight: bold;">Mitarbeiterauswahl - Offene Mail Anfragen</span>
                <div class="buttons-grid">
                    <button class="btn unified-btn" id="btnAuftrag">Zurück zum Auftrag</button>
                    <span id="lbl_Datum" style="font-size: 12px; color: white;"></span>
                </div>
            </div>
            <div class="gpt-box">CONSYS<span>Web</span></div>
        </div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Left Sidebar -->

            <!-- Content Area -->
            <div class="content-area">
                <!-- Auftrag-Auswahl Row -->
                <div class="auftrag-selection-row">
                    <span class="auftrag-label">Auftrag:</span>
                    <select id="VA_ID" class="form-select" style="min-width: 280px; font-size: 12px;">
                        <option value="">-- Auftrag wählen --</option>
                    </select>
                    <span class="auftrag-label">Datum:</span>
                    <select id="cboVADatum" class="form-select datum-display" style="width: 140px; font-size: 12px;">
                        <option value="">-- Datum --</option>
                    </select>
                    <span id="lbAuftrag" style="margin-left: auto; font-weight: bold; display: none;">-- Bitte Auftrag wählen --</span>
                    <!-- cboAuftrStatus: Visible=Falsch in Access -->
                    <span class="form-label" style="margin-left: auto; display: none;">Auftragsstatus</span>
                    <select id="cboAuftrStatus" class="form-select" style="width: 50px; display: none;">
                        <option value="">-</option>
                    </select>
                    <button class="btn" id="btnPosListe" style="display: none;">Positionsliste</button>
                    <button class="btn" id="btnZuAbsage" style="display: none;">Manuelles Bearbeiten</button>
                </div>

                <!-- Form Section -->
                <div class="form-section">
                    <!-- Filter Zeile mit Checkboxen und Buttons (14.01.2026 neu angeordnet) -->
                    <div class="filter-row">
                        <span class="form-label">Mitarbeiter</span>
                        <span class="form-label">Gesamt:</span>
                        <input type="text" id="iGes_MA" class="form-input readonly" readonly value="0" style="width: 50px;">

                        <!-- Checkbox-Blöcke links -->
                        <div style="display: flex; gap: 20px; margin-left: 20px;">
                            <div class="checkbox-block">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="cbVerplantVerfuegbar">
                                    <label for="cbVerplantVerfuegbar">geplant = verfügbar</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="IstVerfuegbar">
                                    <label for="IstVerfuegbar">Nur freie anzeigen</label>
                                </div>
                            </div>
                            <!-- Aktiv/34a mit Anstellung/Kategorie zusammen -->
                            <div class="checkbox-block">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="IstAktiv" checked>
                                        <label for="IstAktiv">Nur aktive anzeigen</label>
                                    </div>
                                    <span class="form-label">Anstellung:</span>
                                    <select id="cboAnstArt" class="form-select" style="width: 100px;">
                                        <option value="13">Alle aktiven</option>
                                        <option value="3">Festangestellt</option>
                                        <option value="5" selected>Minijobber</option>
                                        <option value="9">Studenten</option>
                                        <option value="11">Praktikanten</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="cbNur34a">
                                        <label for="cbNur34a">Nur 34a</label>
                                    </div>
                                    <span class="form-label" style="margin-left: 40px;">Kategorie:</span>
                                    <select id="cboQuali" class="form-select" style="width: 100px;">
                                        <option value="">Alle</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Grüne Buttons über Block "Mitarbeiter geplant" -->
                        <div style="display: flex; flex-direction: column; gap: 4px; margin-left: auto;">
                            <button class="btn btn-green" id="btnMailSelected">Nur Selektierte anfragen</button>
                            <button class="btn btn-green" id="btnMail">Alle Mitarbeiter anfragen</button>
                        </div>
                    </div>

                    <!-- Lists Container -->
                    <div class="lists-container">
                        <!-- Zeiten Liste -->
                        <div class="list-panel narrow">
                            <span class="form-label">Dienstbeginn auswählen:</span>
                            <div class="grid-wrapper">
                                <div class="listbox-header">
                                    <span style="width: 25px;">Ist</span>
                                    <span style="width: 25px;">Soll</span>
                                    <span style="width: 50px;">Beginn</span>
                                    <span style="width: 50px;">Ende</span>
                                </div>
                                <div id="lstZeiten_Body"></div>
                            </div>
                            <span class="form-label">Endzeit:</span>
                            <input type="time" id="DienstEnde" class="form-input" style="width: 70px;">
                            <span class="form-label">Parallele Einsätze:</span>
                            <div class="grid-wrapper" style="height: 150px;">
                                <div id="Lst_Parallel_Einsatz"></div>
                            </div>
                        </div>

                        <!-- MA Liste -->
                        <div class="list-panel wide">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="form-label">Mitarbeiterauswahl durch Doppelklick</span>
                                <!-- strSchnellSuche + btnSchnellGo: Visible=Falsch in Access -->
                                <input type="text" id="strSchnellSuche" class="form-input" placeholder="Suche..." style="width: 80px; display: none;">
                                <button class="btn tiny-btn" id="btnSchnellGo" style="background-color: #8B0000; color: white; display: none;">GO</button>
                            </div>
                            <div class="grid-wrapper">
                                <div class="listbox-header">
                                    <span style="width: 120px;">Name</span>
                                    <span style="width: 35px;">Std</span>
                                    <span style="width: 50px;">Beginn</span>
                                    <span style="width: 50px;">Ende</span>
                                    <span style="flex: 1;">Grund</span>
                                    <span id="colEntfernung" style="width: 50px; display: none;">Entf.</span>
                                </div>
                                <div id="List_MA_Body"></div>
                            </div>
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button class="btn" id="cmdListMA_Standard">Standard</button>
                                <button class="btn" id="cmdListMA_Entfernung">Entfernung</button>
                            </div>
                        </div>

                        <!-- Buttons MA &rarr; Plan -->
                        <div class="button-column">
                            <button class="btn tiny-btn" id="btnAddSelected" title="Ausgewählte MA zur Planung hinzufügen">&rarr;</button>
                            <button class="btn tiny-btn" id="btnDelSelected" title="Ausgewählte MA aus Planung entfernen">&larr;</button>
                            <!-- btnDelAll: Visible=Falsch in Access -->
                            <button class="btn tiny-btn" id="btnDelAll" title="Alle aus Planung entfernen" style="display: none;">&times;</button>
                        </div>

                        <!-- Plan Liste -->
                        <div class="list-panel medium">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="form-label">Mitarbeiter geplant:</span>
                                <!-- btnSortPLan: Visible=Falsch in Access -->
                                <button class="btn" id="btnSortPLan" style="margin-left: auto; display: none;">Sortieren</button>
                            </div>
                            <div class="grid-wrapper">
                                <div class="listbox-header">
                                    <span style="width: 25px;">Lfd</span>
                                    <span style="flex: 1;">Nachname</span>
                                    <span style="flex: 1;">Vorname</span>
                                    <span style="width: 45px;">Beginn</span>
                                </div>
                                <div id="lstMA_Plan_Body"></div>
                            </div>
                        </div>

                        <!-- Buttons Plan &rarr; Zusage: Alle Visible=Falsch in Access -->
                        <div class="button-column" style="display: none;">
                            <button class="btn tiny-btn" id="btnAddZusage" title="Zur Zusage verschieben">&rarr;</button>
                            <button class="btn tiny-btn" id="btnMoveZusage" title="Zurück zur Planung">&larr;</button>
                            <button class="btn tiny-btn" id="btnDelZusage" title="Aus Zusage entfernen">&times;</button>
                        </div>

                        <!-- Zusage Liste -->
                        <div class="list-panel medium">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="form-label">Mitarbeiter zugesagt:</span>
                                <!-- btnSortZugeord: Visible=Falsch in Access -->
                                <button class="btn" id="btnSortZugeord" style="margin-left: auto; display: none;">Sortieren</button>
                            </div>
                            <div class="grid-wrapper">
                                <!-- Überschriften hinzugefügt (14.01.2026) -->
                                <div class="listbox-header">
                                    <span style="width: 25px;">Lfd</span>
                                    <span style="flex: 1;">Nachname</span>
                                    <span style="flex: 1;">Vorname</span>
                                    <span style="width: 45px;">Beginn</span>
                                </div>
                                <div id="lstMA_Zusage"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WebView2 Bridge für Access-Integration -->
    <script src="js/webview2-bridge.js"></script>

    <!-- Formular-Logik (Modul) -->
    <script type="module" src="logic/frm_MA_VA_Schnellauswahl.logic.js"></script>

    <script>
        // ============================================
        // VBA EVENT SYNCHRONISATION
        // Access VBA Events -> JavaScript Implementierung
        // ============================================

        // State für Form
        const formState = {
            VA_ID: null,
            VADatum_ID: null,
            VAStart_ID: null,
            Objekt_ID: null,
            bEntfernungsModus: false
        };

        // Guard-Flag um Endlosschleife bei dispatchEvent zu vermeiden
        let _isVAOpenLoading = false;

        // ============================================
        // HILFSFUNKTIONEN (müssen früh definiert sein)
        // ============================================

        // Hilfsfunktion: Datum formatieren (So. 11.01.2026 statt So, 11.01.2026)
        function formatDateGerman(date) {
            const weekdays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            const d = new Date(date);
            const weekday = weekdays[d.getDay()];
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${weekday}. ${day}.${month}.${year}`;
        }

        // Hilfsfunktion: Zeit formatieren (nur HH:MM)
        function formatTimeValue(timeStr) {
            if (!timeStr) return '';
            // Falls ISO-Datum, nur Zeit extrahieren
            if (timeStr.includes('T')) {
                return timeStr.split('T')[1].substring(0, 5);
            }
            // Falls bereits kurz, zurückgeben
            if (timeStr.length <= 5) return timeStr;
            // Andernfalls erste 5 Zeichen
            return timeStr.substring(0, 5);
        }

        // ============================================
        // VBA BRIDGE SERVER CHECK
        // ============================================

        let vbaBridgeAvailable = false;

        async function checkVBABridge() {
            try {
                const response = await fetch('http://localhost:5002/api/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(2000)
                });
                if (response.ok) {
                    vbaBridgeAvailable = true;
                    console.log('[VBA Bridge] Server erreichbar auf Port 5002');
                    return true;
                }
            } catch (e) {
                console.warn('[VBA Bridge] Server nicht erreichbar:', e.message);
            }
            vbaBridgeAvailable = false;
            return false;
        }

        async function ensureVBABridge() {
            const isAvailable = await checkVBABridge();
            if (!isAvailable) {
                // Server nicht erreichbar - Hinweis zeigen
                showToast('VBA Bridge Server wird gestartet...', 'info');

                // Versuche Server via Access/Shell zu starten (falls WebView2)
                if (window.chrome && window.chrome.webview) {
                    window.chrome.webview.postMessage(JSON.stringify({
                        action: 'START_VBA_BRIDGE',
                        requestId: 'start-vba-bridge-' + Date.now()
                    }));
                    // Warte kurz und pruefe erneut
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    const retryOk = await checkVBABridge();
                    if (retryOk) {
                        showToast('VBA Bridge Server gestartet', 'success');
                        return true;
                    }
                }

                // Falls immer noch nicht verfuegbar - Fehler anzeigen
                showToast('VBA Bridge Server nicht erreichbar! E-Mail-Versand nicht möglich.', 'error');
                return false;
            }
            return true;
        }

        // ============================================
        // FORM EVENTS (Form_Open, Form_Load, Form_Close)
        // ============================================

        // Form_Open - Initialisierung beim Öffnen
        async function Form_Open() {
            console.log('[VBA] Form_Open');

            // VBA Bridge Server pruefen/starten (fuer E-Mail-Anfragen)
            await ensureVBABridge();

            // Listen leeren
            const lstZeiten = document.getElementById('lstZeiten_Body');
            const lstMAPlan = document.getElementById('lstMA_Plan_Body');
            const lstMAZusage = document.getElementById('lstMA_Zusage');
            const listMA = document.getElementById('List_MA_Body');

            if (lstZeiten) lstZeiten.innerHTML = '';
            if (lstMAPlan) lstMAPlan.innerHTML = '';
            if (lstMAZusage) lstMAZusage.innerHTML = '';
            if (listMA) listMA.innerHTML = '';

            // Aktuelles Datum anzeigen (lbl_Datum: Visible=Wahr in Access)
            const lblDatum = document.getElementById('lbl_Datum');
            if (lblDatum) {
                lblDatum.textContent = formatDateGerman(new Date());
            }

            // OpenArgs auswerten (falls vorhanden via URL-Parameter oder SHELL_PARAMS)
            // Shell verwendet srcdoc, daher werden URL-Parameter als window.SHELL_PARAMS injiziert
            const urlParams = new URLSearchParams(window.location.search);
            const shellParams = window.SHELL_PARAMS || {};
            console.log('[VBA] Form_Open URL:', window.location.href);
            console.log('[VBA] Form_Open search:', window.location.search);
            console.log('[VBA] Form_Open SHELL_PARAMS:', shellParams);
            // Priorisiere URL-Parameter, dann SHELL_PARAMS
            const vaId = urlParams.get('va_id') || urlParams.get('id') || shellParams.va_id || shellParams.id;
            const vadatumId = urlParams.get('vadatum_id') || shellParams.vadatum_id;
            console.log('[VBA] Form_Open vaId:', vaId, 'vadatumId:', vadatumId);

            if (vaId) {
                // WICHTIG: formState.VA_ID sofort setzen fuer "Zurueck zum Auftrag" Button
                formState.VA_ID = parseInt(vaId);
                // Auftrag automatisch laden
                console.log('[VBA] Form_Open: Auto-Load für VA_ID', vaId);
                await VAOpen(parseInt(vaId), vadatumId ? parseInt(vadatumId) : null);
            }
        }

        // Form_Load - Nach dem Laden
        async function Form_Load() {
            console.log('[VBA] Form_Load');

            // Aufträge-Dropdown laden
            await loadAuftraegeListe();

            // Anstellungsart: Default=13 (Alle aktiven) aus Access übernommen
            // Wird im HTML bereits als selected gesetzt, daher keine Änderung nötig

            // MA-Selektion nur wenn kein Auftrag via URL übergeben wurde
            const urlParams2 = new URLSearchParams(window.location.search);
            if (!urlParams2.get('va_id') && !urlParams2.get('id')) {
                await zf_MA_Selektion();
            }
        }

        // Aufträge-Dropdown laden
        async function loadAuftraegeListe() {
            try {
                // status=aktiv verursacht 500er Fehler - Parameter entfernt
                const response = await fetch('http://localhost:5000/api/auftraege?limit=100');
                if (!response.ok) return;

                const result = await response.json();
                if (!result.success || !result.data) return;

                const vaSelect = document.getElementById('VA_ID');
                if (!vaSelect) return;

                vaSelect.innerHTML = '<option value="">-- Auftrag wählen --</option>';

                result.data.forEach(auftrag => {
                    const option = document.createElement('option');
                    // API gibt "ID" zurück, nicht "VA_ID"!
                    option.value = auftrag.ID || auftrag.VA_ID;
                    option.textContent = `${auftrag.Auftrag || ''} - ${auftrag.Objekt || auftrag.ObjektName || ''}`;
                    vaSelect.appendChild(option);
                });

                // Wenn VA_ID via URL übergeben, im Dropdown setzen
                const urlParams3 = new URLSearchParams(window.location.search);
                const vaIdFromUrl = urlParams3.get('va_id') || urlParams3.get('id');
                if (vaIdFromUrl) {
                    vaSelect.value = vaIdFromUrl;
                }

                console.log('[Form_Load] Aufträge-Dropdown geladen:', result.data.length, 'Einträge');

            } catch (err) {
                console.error('[loadAuftraegeListe] Fehler:', err);
            }
        }

        // Form_Close - Beim Schliessen sortieren
        function Form_Close() {
            console.log('[VBA] Form_Close');

            if (formState.VA_ID && formState.VADatum_ID) {
                // Zuordnung und Planung sortieren
                sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 1);
                sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 2);
            }
        }

        // ============================================
        // VAOpen - Auftrag öffnen (Hauptfunktion)
        // Lädt alle Daten automatisch via REST API
        // ============================================
        async function VAOpen(iVA_ID, iVADatum_ID) {
            console.log('[VBA] VAOpen:', iVA_ID, iVADatum_ID);

            // Guard setzen um Endlosschleife zu vermeiden
            _isVAOpenLoading = true;

            formState.VA_ID = iVA_ID;

            try {
                // 1. Auftragsdaten laden
                console.log('[VAOpen] Lade Auftragsdaten...');
                const auftragData = await loadAuftragData(iVA_ID);

                if (auftragData) {
                    // Label aktualisieren
                    updateAuftragLabelFromData(auftragData);

                    // Auftrag-Dropdown aktualisieren: Option hinzufügen falls nicht vorhanden
                    const vaSelect = document.getElementById('VA_ID');
                    if (vaSelect) {
                        let option = vaSelect.querySelector(`option[value="${iVA_ID}"]`);
                        if (!option) {
                            option = document.createElement('option');
                            option.value = iVA_ID;
                            option.textContent = `${auftragData.Auftrag || ''} - ${auftragData.Objekt || auftragData.ObjektName || ''}`;
                            vaSelect.appendChild(option);
                        }
                        vaSelect.value = iVA_ID;
                        // Change-Event dispatchen um Logic-Datei zu synchronisieren (NACH Option-Erstellung!)
                        vaSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                    // Objekt_ID speichern
                    formState.Objekt_ID = auftragData.Objekt_ID || 0;

                    // Positionsliste-Button anzeigen/verstecken
                    const btnPosListe = document.getElementById('btnPosListe');
                    if (btnPosListe) btnPosListe.style.display = formState.Objekt_ID > 0 ? '' : 'none';
                }

                // 2. Einsatztage laden und Dropdown befüllen
                console.log('[VAOpen] Lade Einsatztage...');
                const einsatztage = await loadEinsatztage(iVA_ID);

                if (einsatztage && einsatztage.length > 0) {
                    // Dropdown befüllen
                    populateEinsatztageDropdown(einsatztage);

                    // VADatum_ID ermitteln: entweder übergeben oder nächstes/erstes Datum
                    let selectedDatumId = iVADatum_ID;

                    if (!selectedDatumId) {
                        // Nächsten Einsatztag ab heute finden
                        const heute = new Date();
                        heute.setHours(0, 0, 0, 0);

                        const naechsterTag = einsatztage.find(tag => {
                            const tagDatum = new Date(tag.VADatum);
                            return tagDatum >= heute;
                        });

                        // API gibt "ID" zurück, nicht "VADatum_ID"
                        selectedDatumId = naechsterTag ? (naechsterTag.ID || naechsterTag.VADatum_ID) : (einsatztage[0].ID || einsatztage[0].VADatum_ID);
                    }

                    formState.VADatum_ID = selectedDatumId;

                    // Dropdown-Wert setzen
                    const cboVADatum = document.getElementById('cboVADatum');
                    if (cboVADatum) {
                        cboVADatum.value = selectedDatumId;
                        // Change-Event dispatchen um Logic-Datei zu synchronisieren
                        cboVADatum.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                    // 3. Schichten für das Datum laden
                    console.log('[VAOpen] Lade Schichten für VADatum_ID:', selectedDatumId);
                    const schichten = await loadSchichten(iVA_ID, selectedDatumId);

                    if (schichten && schichten.length > 0) {
                        populateSchichtenListe(schichten);

                        // Erste Schicht automatisch auswählen
                        // API gibt "ID" zurück, nicht "VAStart_ID" - beide akzeptieren
                        formState.VAStart_ID = schichten[0].VAStart_ID || schichten[0].ID;
                        const lstZeiten = document.getElementById('lstZeiten_Body');
                        const ersteZeile = lstZeiten?.querySelector('.listbox-row');
                        if (ersteZeile) {
                            ersteZeile.classList.add('selected');

                            // Dienstende setzen
                            const dienstEnde = document.getElementById('DienstEnde');
                            if (dienstEnde) dienstEnde.value = schichten[0].VA_Ende || '';
                        }
                    }

                    // 4. Mitarbeiter-Liste laden
                    console.log('[VAOpen] Lade Mitarbeiter...');
                    await loadMitarbeiterListe();

                    // 5. Geplante und zugesagte MA laden
                    await loadPlanungUndZusage(iVA_ID, selectedDatumId);

                    // 6. Parallele Einsätze laden
                    await loadParalleleEinsaetzeData(selectedDatumId);
                }

                console.log('[VAOpen] Alle Daten geladen');
                showToast('Auftrag geladen', 'success');

            } catch (err) {
                console.error('[VAOpen] Fehler:', err);
                showToast('Fehler beim Laden: ' + err.message, 'error');
            } finally {
                // Guard zurücksetzen
                _isVAOpenLoading = false;
            }
        }

        // Auftragsdaten via REST API laden
        async function loadAuftragData(vaId) {
            try {
                const response = await fetch(`http://localhost:5000/api/auftraege/${vaId}`);
                if (!response.ok) throw new Error('Auftrag nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    return result.data.auftrag || result.data;
                }
                return null;
            } catch (err) {
                console.error('[loadAuftragData] Fehler:', err);
                return null;
            }
        }

        // Einsatztage via REST API laden
        async function loadEinsatztage(vaId) {
            try {
                const response = await fetch(`http://localhost:5000/api/einsatztage?va_id=${vaId}`);
                if (!response.ok) throw new Error('Einsatztage nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    return result.data;
                }
                return [];
            } catch (err) {
                console.error('[loadEinsatztage] Fehler:', err);
                return [];
            }
        }

        // Schichten via REST API laden
        // Dedizierter Endpoint: /api/auftraege/<id>/schichten
        async function loadSchichten(vaId, vadatumId) {
            try {
                // Korrekter Endpoint für Schichten
                let url = `http://localhost:5000/api/auftraege/${vaId}/schichten`;
                if (vadatumId) {
                    url += `?vadatum_id=${vadatumId}`;
                }
                console.log('[loadSchichten] URL:', url);

                const response = await fetch(url);
                if (!response.ok) throw new Error('Schichten nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    console.log('[loadSchichten] Schichten geladen:', result.data.length);
                    // Mapping: API gibt ID, populateSchichtenListe erwartet VAStart_ID
                    return result.data.map(s => ({
                        ...s,
                        VAStart_ID: s.ID || s.VAStart_ID
                    }));
                }
                return [];
            } catch (err) {
                console.error('[loadSchichten] Fehler:', err);
                return [];
            }
        }

        // Mitarbeiter-Liste via REST API laden
        // Berücksichtigt Verfügbarkeit: nicht eingeplant, nicht krank, nicht Urlaub, nicht privat verplant
        async function loadMitarbeiterListe() {
            try {
                // Filter-Werte sammeln
                const istAktiv = document.getElementById('IstAktiv')?.checked !== false;
                const anstArt = document.getElementById('cboAnstArt')?.value || '5'; // Default: Minijobber
                const nurFreie = document.getElementById('IstVerfuegbar')?.checked;

                // Basis-URL mit korrektem Parameter-Namen
                let url = `http://localhost:5000/api/mitarbeiter?aktiv=${istAktiv}`;

                // Anstellungsart-Filter (außer "13" = alle)
                if (anstArt && anstArt !== '13') {
                    url += `&anstellungsart_id=${anstArt}`;
                }

                console.log('[loadMitarbeiterListe] URL:', url);

                const response = await fetch(url);
                if (!response.ok) throw new Error('Mitarbeiter nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    let mitarbeiter = result.data;

                    // Verfügbarkeitsprüfung wenn aktiviert
                    if (nurFreie && formState.VADatum_ID) {
                        mitarbeiter = await filterVerfuegbare(mitarbeiter, formState.VA_ID, formState.VADatum_ID);
                    }

                    populateMitarbeiterListe(mitarbeiter);

                    // Gesamt-Anzeige aktualisieren
                    const iGesMA = document.getElementById('iGes_MA');
                    if (iGesMA) iGesMA.value = mitarbeiter.length;
                }
            } catch (err) {
                console.error('[loadMitarbeiterListe] Fehler:', err);
            }
        }

        // Filtert Mitarbeiter nach Verfügbarkeit
        // Ausgeschlossen werden: bereits eingeplant, krank, Urlaub, privat verplant
        async function filterVerfuegbare(mitarbeiter, vaId, vadatumId) {
            try {
                // Aktuelles Datum aus VADatum_ID ermitteln
                const cboVADatum = document.getElementById('cboVADatum');
                const selectedOption = cboVADatum?.options[cboVADatum.selectedIndex];
                const datumText = selectedOption?.textContent || '';

                // Hole bereits eingeplante MA für diesen Auftrag/Tag
                const planungResponse = await fetch(`http://localhost:5000/api/planungen?va_id=${vaId}&vadatum_id=${vadatumId}`);
                let geplanteMAIds = new Set();
                if (planungResponse.ok) {
                    const planungResult = await planungResponse.json();
                    if (planungResult.success && planungResult.data) {
                        planungResult.data.forEach(p => geplanteMAIds.add(String(p.MA_ID)));
                    }
                }

                // Hole Nichtverfügbarkeiten (krank, urlaub, privat)
                // Konvertiere Datum für API-Aufruf
                const dateParts = datumText.match(/(\d{2})\.(\d{2})\.(\d{4})/);
                let nvMAIds = new Set();
                if (dateParts) {
                    const isoDate = `${dateParts[3]}-${dateParts[2]}-${dateParts[1]}`;
                    const nvResponse = await fetch(`http://localhost:5000/api/verfuegbarkeit?datum=${isoDate}`);
                    if (nvResponse.ok) {
                        const nvResult = await nvResponse.json();
                        if (nvResult.success && nvResult.data) {
                            nvResult.data.forEach(nv => nvMAIds.add(String(nv.MA_ID)));
                        }
                    }
                }

                console.log('[filterVerfuegbare] Geplante:', geplanteMAIds.size, 'Nicht-verfuegbar:', nvMAIds.size);

                // Filtern: nur MA die weder geplant noch nichtverfügbar sind
                return mitarbeiter.filter(ma => {
                    const maId = String(ma.ID || ma.MA_ID);
                    const istGeplant = geplanteMAIds.has(maId);
                    const istNichtVerfuegbar = nvMAIds.has(maId);
                    return !istGeplant && !istNichtVerfuegbar;
                });
            } catch (err) {
                console.error('[filterVerfuegbare] Fehler:', err);
                return mitarbeiter; // Bei Fehler alle zurückgeben
            }
        }

        // Geplante und zugesagte MA laden
        async function loadPlanungUndZusage(vaId, vadatumId) {
            try {
                // Geplante MA - API verwendet datum_id nicht vadatum_id
                const planungResponse = await fetch(`http://localhost:5000/api/planungen?va_id=${vaId}&datum_id=${vadatumId}`);
                if (planungResponse.ok) {
                    const planungResult = await planungResponse.json();
                    console.log('[loadPlanungUndZusage] Geplante MA:', planungResult.data?.length);
                    if (planungResult.success && planungResult.data) {
                        populatePlanungListe(planungResult.data);
                        // Geplante MA aus linker Liste ausblenden
                        hidePlannedMAFromList(planungResult.data);
                    }
                }

                // Zugesagte MA (Status=2 oder 3)
                const zusageResponse = await fetch(`http://localhost:5000/api/zuordnungen?va_id=${vaId}&datum_id=${vadatumId}`);
                if (zusageResponse.ok) {
                    const zusageResult = await zusageResponse.json();
                    console.log('[loadPlanungUndZusage] Zugesagte MA:', zusageResult.data?.length);
                    if (zusageResult.success && zusageResult.data) {
                        // Nur zugesagte MA (Status >= 2) in Zusage-Liste
                        const zugesagte = zusageResult.data.filter(z => (z.Status || z.Status_ID) >= 2);
                        populateZusageListe(zugesagte);
                    }
                }
            } catch (err) {
                console.error('[loadPlanungUndZusage] Fehler:', err);
            }
        }

        // Parallele Einsätze laden
        async function loadParalleleEinsaetzeData(vadatumId) {
            try {
                const response = await fetch(`http://localhost:5000/api/einsatztage?datum_id=${vadatumId}&parallel=true`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        populateParalleleEinsaetze(result.data);
                    }
                }
            } catch (err) {
                console.error('[loadParalleleEinsaetzeData] Fehler:', err);
            }
        }

        // ============================================
        // POPULATE FUNCTIONS - Listen befüllen
        // ============================================

        function populateEinsatztageDropdown(einsatztage) {
            const cboVADatum = document.getElementById('cboVADatum');
            if (!cboVADatum) return;

            cboVADatum.innerHTML = '<option value="">-- Datum --</option>';

            einsatztage.forEach(tag => {
                const option = document.createElement('option');
                // API gibt "ID" zurück, nicht "VADatum_ID"
                option.value = tag.ID || tag.VADatum_ID;

                // Datum formatieren mit Punkt statt Komma
                option.textContent = formatDateGerman(tag.VADatum);
                cboVADatum.appendChild(option);
            });
        }

        function populateSchichtenListe(schichten) {
            const lstZeiten = document.getElementById('lstZeiten_Body');
            if (!lstZeiten) return;

            lstZeiten.innerHTML = '';

            schichten.forEach(schicht => {
                const row = document.createElement('div');
                row.className = 'listbox-row';
                row.dataset.id = schicht.VAStart_ID;
                row.dataset.ende = schicht.VA_Ende || '';

                row.innerHTML = `
                    <span style="width: 25px;">${schicht.MA_Anzahl_Ist || 0}</span>
                    <span style="width: 25px;">${schicht.MA_Anzahl || 0}</span>
                    <span style="width: 50px;">${formatTimeValue(schicht.VA_Start)}</span>
                    <span style="width: 50px;">${formatTimeValue(schicht.VA_Ende)}</span>
                `;

                row.addEventListener('click', function() {
                    lstZeiten.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');
                    lstZeiten_AfterUpdate();
                });

                lstZeiten.appendChild(row);
            });
        }

        function populateMitarbeiterListe(mitarbeiter) {
            const listMA = document.getElementById('List_MA_Body');
            if (!listMA) return;

            listMA.innerHTML = '';

            mitarbeiter.forEach(ma => {
                const row = document.createElement('div');
                row.className = 'listbox-row';
                row.dataset.id = ma.ID || ma.MA_ID;
                row.dataset.maid = ma.ID || ma.MA_ID;
                row.dataset.grund = ma.Grund || '';  // Für Test_selected Prüfung
                row.dataset.issub = ma.IstSub || '0';  // Subunternehmer-Flag
                row.dataset.name = `${ma.Nachname || ''}, ${ma.Vorname || ''}`;

                const name = `${ma.Nachname || ''}, ${ma.Vorname || ''}`;
                // Name kürzen falls zu lang
                const shortName = name.length > 18 ? name.substring(0, 17) + '…' : name;

                row.innerHTML = `
                    <span style="width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${name}">${shortName}</span>
                    <span style="width: 35px;">${ma.StdMonat || ''}</span>
                    <span style="width: 50px;">${formatTimeValue(ma.Beginn)}</span>
                    <span style="width: 50px;">${formatTimeValue(ma.Ende)}</span>
                    <span style="flex: 1;">${ma.Grund || ''}</span>
                `;

                // Klick-Handler für Auswahl - WICHTIG: Auch Logic-State aktualisieren!
                row.addEventListener('click', function(e) {
                    const maId = this.dataset.id;
                    if (e.ctrlKey) {
                        // Multi-Select mit STRG
                        const isNowSelected = this.classList.toggle('selected');
                        // Logic-State synchronisieren
                        if (window.SchnellauswahlForm) {
                            if (isNowSelected) {
                                window.SchnellauswahlForm.selectMA(maId);
                            } else {
                                window.SchnellauswahlForm.deselectMA(maId);
                            }
                        }
                    } else {
                        // Einzel-Select: Andere deselektieren
                        listMA.querySelectorAll('.listbox-row').forEach(r => {
                            r.classList.remove('selected');
                            // Logic-State: Alle deselektieren
                            if (window.SchnellauswahlForm) {
                                window.SchnellauswahlForm.deselectMA(r.dataset.id);
                            }
                        });
                        this.classList.add('selected');
                        // Logic-State: Diesen selektieren
                        if (window.SchnellauswahlForm) {
                            window.SchnellauswahlForm.selectMA(maId);
                        }
                    }
                    console.log('[HTML] MA clicked:', maId, 'Selected:', window.SchnellauswahlForm?.getSelected?.() || []);
                });

                // Doppelklick-Handler - ENTFERNT, da List_MA_DblClick auf Body-Ebene bereits existiert
                // (verhindert doppelte Ausfuehrung und nutzt Test_selected Pruefung)

                listMA.appendChild(row);
            });
        }

        function populatePlanungListe(planungen) {
            const lstPlan = document.getElementById('lstMA_Plan_Body');
            if (!lstPlan) return;

            lstPlan.innerHTML = '';

            // Status_ID zu CSS-Klasse Mapping (wie in Access)
            const statusClassMap = {
                1: 'geplant',       // Geplant
                2: 'benachrichtigt', // Benachrichtigt/Angefragt
                3: 'zugesagt',       // Zugesagt
                4: 'abgesagt',       // Abgesagt
                5: 'krank',          // Krank
                6: 'urlaub'          // Urlaub
            };

            planungen.forEach((plan, index) => {
                const row = document.createElement('div');
                // API gibt Status nicht Status_ID zurück
                const statusId = plan.Status || plan.Status_ID || plan.status_id || 1;
                const statusClass = statusClassMap[statusId] || 'geplant';
                row.className = `listbox-row ${statusClass}`;
                row.dataset.id = plan.ID || plan.MVA_ID || plan.id;
                row.dataset.maid = plan.MA_ID;
                row.dataset.statusId = statusId;

                // API gibt MA_Nachname/MA_Vorname zurück, nicht Nachname/Vorname
                const nachname = plan.MA_Nachname || plan.Nachname || '';
                const vorname = plan.MA_Vorname || plan.Vorname || '';
                const startZeit = plan.MA_Start || plan.MVA_Start;

                row.innerHTML = `
                    <span style="width: 25px;">${index + 1}</span>
                    <span style="flex: 1;">${nachname}</span>
                    <span style="flex: 1;">${vorname}</span>
                    <span style="width: 45px;">${formatTimeValue(startZeit)}</span>
                `;

                row.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        this.classList.toggle('selected');
                    } else {
                        lstPlan.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });

                lstPlan.appendChild(row);
            });
        }

        function populateZusageListe(zusagen) {
            const lstZusage = document.getElementById('lstMA_Zusage');
            if (!lstZusage) return;

            lstZusage.innerHTML = '';

            zusagen.forEach((zuo, index) => {
                if (!zuo.MA_ID || zuo.MA_ID === 0) return; // Leere Zuordnungen überspringen

                const row = document.createElement('div');
                row.className = 'listbox-row zugesagt';
                row.dataset.id = zuo.ID || zuo.MVA_ID || zuo.id;
                row.dataset.maid = zuo.MA_ID;

                // API gibt MA_Nachname/MA_Vorname zurück, nicht Nachname/Vorname
                const nachname = zuo.MA_Nachname || zuo.Nachname || '';
                const vorname = zuo.MA_Vorname || zuo.Vorname || '';
                const startZeit = zuo.MA_Start || zuo.MVA_Start;

                row.innerHTML = `
                    <span style="width: 25px;">${index + 1}</span>
                    <span style="flex: 1;">${nachname}</span>
                    <span style="flex: 1;">${vorname}</span>
                    <span style="width: 45px;">${formatTimeValue(startZeit)}</span>
                `;

                row.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        this.classList.toggle('selected');
                    } else {
                        lstZusage.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });

                lstZusage.appendChild(row);
            });
        }

        function populateParalleleEinsaetze(einsaetze) {
            const lstParallel = document.getElementById('Lst_Parallel_Einsatz');
            if (!lstParallel) return;

            lstParallel.innerHTML = '';

            einsaetze.forEach(einsatz => {
                // Aktuellen Auftrag überspringen
                if (einsatz.VA_ID === formState.VA_ID) return;

                const row = document.createElement('div');
                row.className = 'listbox-row';
                row.dataset.vaid = einsatz.VA_ID;
                row.dataset.vadatumid = einsatz.VADatum_ID;

                row.innerHTML = `<span>${einsatz.Auftrag || ''} - ${einsatz.Objekt || ''}</span>`;

                lstParallel.appendChild(row);
            });
        }

        function updateAuftragLabelFromData(auftragData) {
            const label = document.getElementById('lbAuftrag');
            if (!label) return;

            const parts = [
                auftragData.Auftrag || '',
                auftragData.Objekt || auftragData.ObjektName || '',
                auftragData.Ort || auftragData.ob_Ort || ''
            ].filter(Boolean);

            label.textContent = parts.join(' - ') || '-- Auftrag geladen --';
        }

        // Legacy-Funktion für Kompatibilität
        function updateAuftragLabel(vaId, vadatumId) {
            loadAuftragData(vaId).then(data => {
                if (data) updateAuftragLabelFromData(data);
            });
        }

        // ============================================
        // BUTTON CLICK EVENTS
        // ============================================

        // btnAuftrag_Click - Zurück zum Auftragstamm
        function btnAuftrag_Click() {
            // VA_ID aus formState oder URL holen (Fallback bei Caching-Problemen)
            let vaId = formState.VA_ID;
            if (!vaId) {
                const urlParams = new URLSearchParams(window.location.search);
                vaId = urlParams.get('va_id') || urlParams.get('id');
                if (vaId) vaId = parseInt(vaId);
            }
            console.log('[VBA] btnAuftrag_Click, VA_ID =', vaId);

            if (!vaId) {
                navigateToForm('frm_va_Auftragstamm');
            } else {
                navigateToForm('frm_va_Auftragstamm', vaId);
            }
        }

        // btnPosListe_Click - Positionsliste öffnen
        function btnPosListe_Click() {
            console.log('[VBA] btnPosListe_Click');

            if (formState.Objekt_ID > 0) {
                if (window.Bridge) {
                    Bridge.sendEvent('openForm', {
                        form: 'frmTop_VA_Akt_Objekt_Kopf',
                        va_id: formState.VA_ID,
                        vadatum_id: formState.VADatum_ID,
                        objekt_id: formState.Objekt_ID
                    });
                } else {
                    alert('Positionsliste - nur in Access verfügbar');
                }
            }
        }

        // btnZuAbsage_Click - Manuelles Bearbeiten
        function btnZuAbsage_Click() {
            console.log('[VBA] btnZuAbsage_Click');

            if (window.Bridge) {
                Bridge.sendEvent('openForm', { form: 'frmTop_MA_ZuAbsage' });
            } else {
                alert('Zu-/Absage-Formular - nur in Access verfügbar');
            }
        }

        /**
         * Test_selected - Prüft ob MA bereits verplant ist (Doppelbelegungs-Warnung)
         * Entspricht VBA: Private Function Test_selected(var) As Boolean
         * @param {HTMLElement} row - Die angeklickte Zeile
         * @returns {boolean} true = darf verplant werden, false = abgebrochen
         */
        function Test_selected(row) {
            if (!row || !row.classList.contains('selected')) {
                return true; // Nicht selektiert = kein Problem
            }

            const grund = row.dataset.grund || '';
            const isSub = row.dataset.issub === '1' || row.dataset.issub === 'true';
            const maName = row.dataset.name || 'Mitarbeiter';

            // Prüfen ob bereits verplant (Grund-Spalte hat Inhalt)
            const istBereitsVerplant = grund.trim().length > 0;

            if (istBereitsVerplant && !isSub) {
                // Warnung anzeigen - wie im VBA
                const result = confirm(`Mitarbeiter ${maName} ist nicht verfügbar (${grund}), dennoch verplanen?`);
                if (!result) {
                    console.log('[Test_selected] Verplanung abgebrochen für:', maName);
                    return false;
                }
            }

            return true;
        }

        // btnAddSelected_Click - Ausgewaehlte MA zur Planung
        function btnAddSelected_Click() {
            console.log('[VBA] btnAddSelected_Click');

            const listMA = document.getElementById('List_MA_Body');
            const selected = listMA?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) {
                alert('Bitte Mitarbeiter auswählen');
                return;
            }

            selected.forEach(row => {
                // Test_selected Prüfung (Doppelbelegung)
                if (!Test_selected(row)) {
                    return; // Dieser MA wird übersprungen
                }

                const maId = row.dataset.id;
                if (maId) {
                    addMAToPlanung(parseInt(maId));
                }
            });

            // Listen aktualisieren
            refreshPlanungListe();
            zf_MA_Selektion();
        }

        async function addMAToPlanung(maId) {
            const planungData = {
                ma_id: maId,
                va_id: formState.VA_ID,
                vadatum_id: formState.VADatum_ID,
                vastart_id: formState.VAStart_ID,
                status_id: 1 // Geplant
            };

            // Immer REST-API im Browser-Modus (auch wenn Bridge existiert)
            try {
                const response = await fetch('http://localhost:5000/api/planungen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planungData)
                });
                if (response.ok) {
                    const result = await response.json();
                    console.log('[addMAToPlanung] Erfolgreich, ID:', result.id);
                    // Planungsliste aktualisieren
                    await refreshPlanungListe();
                } else {
                    console.error('[addMAToPlanung] API-Fehler:', response.status);
                }
            } catch (err) {
                console.error('[addMAToPlanung] Fehler:', err);
            }
        }

        // btnDelSelected_Click - Aus Planung entfernen (REST-API)
        async function btnDelSelected_Click() {
            console.log('[VBA] btnDelSelected_Click');

            const lstPlan = document.getElementById('lstMA_Plan_Body');
            const selected = lstPlan?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) {
                alert('Bitte Mitarbeiter aus Planung auswählen');
                return;
            }

            // Alle ausgewählten IDs sammeln und per REST-API löschen (skipRefresh=true)
            const deletePromises = [];
            selected.forEach(row => {
                const planId = row.dataset.id;
                if (planId) {
                    deletePromises.push(removeMAfromPlanung(parseInt(planId), true));
                }
            });

            // Warten bis alle Löschungen abgeschlossen sind
            await Promise.all(deletePromises);
            console.log('[btnDelSelected] Alle ausgewählten Planungen gelöscht');

            // Listen einmal am Ende aktualisieren
            refreshPlanungListe();
            zf_MA_Selektion();
        }

        // btnDelAll_Click - Alle aus Planung entfernen
        function btnDelAll_Click() {
            console.log('[VBA] btnDelAll_Click');

            if (!confirm('Alle verplanten Mitarbeiter von der Planung entfernen?')) {
                return;
            }

            if (window.Bridge) {
                Bridge.sendEvent('delete', {
                    type: 'planung_all',
                    va_id: formState.VA_ID,
                    vadatum_id: formState.VADatum_ID
                });
            }

            refreshPlanungListe();
            zf_MA_Selektion();
        }

        // btnAddZusage_Click - Von Planung zur Zusage
        function btnAddZusage_Click() {
            console.log('[VBA] btnAddZusage_Click');

            const lstPlan = document.getElementById('lstMA_Plan_Body');
            const selected = lstPlan?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) return;

            selected.forEach(row => {
                const planId = row.dataset.id;
                const maId = row.dataset.maid;

                if (planId && maId && window.Bridge) {
                    Bridge.sendEvent('zuordnung_erstellen', {
                        ma_id: parseInt(maId),
                        va_id: formState.VA_ID,
                        vadatum_id: formState.VADatum_ID,
                        vastart_id: formState.VAStart_ID,
                        planung_id: parseInt(planId) // Wird dann aus Planung gelöscht
                    });
                }
            });

            refreshPlanungListe();
            refreshZusageListe();
            updateSollPlanIst();
        }

        // btnMoveZusage_Click - Zurück zur Planung
        function btnMoveZusage_Click() {
            console.log('[VBA] btnMoveZusage_Click');

            const lstZusage = document.getElementById('lstMA_Zusage');
            const selected = lstZusage?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) return;

            selected.forEach(row => {
                const zuoId = row.dataset.id;
                const maId = row.dataset.maid;

                if (zuoId && maId && window.Bridge) {
                    // MA aus Zuordnung entfernen und zur Planung hinzufügen
                    Bridge.sendEvent('zuordnung_to_planung', {
                        zuordnung_id: parseInt(zuoId),
                        ma_id: parseInt(maId),
                        va_id: formState.VA_ID,
                        vadatum_id: formState.VADatum_ID,
                        vastart_id: formState.VAStart_ID
                    });
                }
            });

            refreshPlanungListe();
            refreshZusageListe();
            updateSollPlanIst();
        }

        // btnDelZusage_Click - Aus Zusage entfernen
        function btnDelZusage_Click() {
            console.log('[VBA] btnDelZusage_Click');

            if (!confirm('Zusagen entfernen - sind Sie sicher?')) {
                return;
            }

            const lstZusage = document.getElementById('lstMA_Zusage');
            const selected = lstZusage?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) return;

            selected.forEach(row => {
                const zuoId = row.dataset.id;
                if (zuoId && window.Bridge) {
                    // MA_ID auf 0 setzen (nicht löschen)
                    Bridge.sendEvent('zuordnung_clear', {
                        zuordnung_id: parseInt(zuoId)
                    });
                }
            });

            refreshZusageListe();
            updateSollPlanIst();
        }

        // btnSortPlan_Click - Planung sortieren
        function btnSortPlan_Click() {
            console.log('[VBA] btnSortPlan_Click');
            sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 2);
            refreshPlanungListe();
        }

        // btnSortZugeord_Click - Zuordnung sortieren
        function btnSortZugeord_Click() {
            console.log('[VBA] btnSortZugeord_Click');
            sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 1);
            refreshZusageListe();
        }

        // Sort-Funktion (ruft VBA auf)
        function sort_zuo_plan(vaId, vadatumId, tbl) {
            if (window.Bridge) {
                Bridge.sendEvent('sort_zuo_plan', {
                    va_id: vaId,
                    vadatum_id: vadatumId,
                    tbl: tbl // 1=Zuordnung, 2=Planung
                });
            }
        }

        // ============================================
        // MAIL ANFRAGEN (btnMail, btnMailSelected)
        // Ruft Access VBA Funktion via VBA Bridge auf mit Daten aus HTML-Formular
        // ============================================

        // btnMail_Click - Alle Mitarbeiter anfragen (via VBA Bridge)
        async function btnMail_Click() {
            console.log('[VBA] btnMail_Click - Alle anfragen via VBA Bridge');
            await sendeAnfragenViaVBABridge(false);
        }

        // btnMailSelected_Click - Nur selektierte anfragen (via VBA Bridge)
        async function btnMailSelected_Click() {
            console.log('[VBA] btnMailSelected_Click - Selektierte anfragen via VBA Bridge');
            await sendeAnfragenViaVBABridge(true);
        }

        /**
         * Sendet E-Mail-Anfragen via VBA Bridge
         * Die VBA-Funktion wird mit den Daten aus dem HTML-Formular aufgerufen
         * @param {boolean} selectedOnly - true = nur selektierte MA, false = alle geplanten MA
         */
        async function sendeAnfragenViaVBABridge(selectedOnly) {
            // Validierung - ALLE 3 IDs sind erforderlich!
            if (!formState.VA_ID || !formState.VADatum_ID) {
                alert('Bitte Auftrag und Datum wählen');
                return;
            }

            // VAStart_ID ist PFLICHT für VBA-Funktion!
            if (!formState.VAStart_ID) {
                console.error('[VBA Bridge] FEHLER: VAStart_ID ist nicht gesetzt!');
                alert('Bitte zuerst eine Schicht (Zeitraum) auswählen!');
                return;
            }

            console.log('[VBA Bridge] Parameter:', {
                VA_ID: formState.VA_ID,
                VADatum_ID: formState.VADatum_ID,
                VAStart_ID: formState.VAStart_ID
            });

            // MA-IDs aus Planungsliste sammeln
            const lstPlan = document.getElementById('lstMA_Plan_Body');
            const rows = selectedOnly
                ? lstPlan?.querySelectorAll('.listbox-row.selected')
                : lstPlan?.querySelectorAll('.listbox-row');

            if (!rows || rows.length === 0) {
                alert(selectedOnly ? 'Bitte Mitarbeiter in der Planungsliste auswählen' : 'Keine Mitarbeiter in der Planungsliste vorhanden');
                return;
            }

            // MA-Daten sammeln (ID und Name für Logging)
            const maList = Array.from(rows).map(r => ({
                MA_ID: parseInt(r.dataset.maid),
                Name: `${r.querySelector('span:nth-child(2)')?.textContent || ''}, ${r.querySelector('span:nth-child(3)')?.textContent || ''}`.trim()
            })).filter(m => m.MA_ID);

            const maIds = maList.map(m => m.MA_ID);
            console.log('[VBA Bridge] MA-IDs für Anfrage:', maIds);

            // Bestätigung
            if (!confirm(`${maIds.length} Mitarbeiter per E-Mail anfragen?`)) {
                return;
            }

            // VBA Bridge URL
            const vbaBridgeUrl = 'http://localhost:5002/api/vba/anfragen';
            
            try {
                // Prüfe ob VBA Bridge erreichbar - PFLICHT, kein Fallback!
                const healthCheck = await fetch('http://localhost:5002/api/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(3000)
                }).catch(() => null);

                if (!healthCheck || !healthCheck.ok) {
                    console.error('[VBA Bridge] NICHT ERREICHBAR - E-Mail-Versand nicht möglich!');
                    showToast('VBA Bridge Server nicht erreichbar! Bitte start_vba_bridge.bat starten.', 'error');
                    alert('VBA Bridge Server ist nicht erreichbar!\\n\\nE-Mail-Anfragen können nur über den VBA Bridge Server gesendet werden.\\n\\nBitte starten Sie: start_vba_bridge.bat');
                    return;
                }

                // VBA Bridge aufrufen - sendet Daten an Access VBA Funktion
                console.log('[VBA Bridge] Sende Anfrage-Daten an Access...');
                showToast('Sende E-Mail-Anfragen via Access...', 'info');

                const response = await fetch(vbaBridgeUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        // Auftragsdaten aus HTML-Formular
                        VA_ID: formState.VA_ID,
                        VADatum_ID: formState.VADatum_ID,
                        VAStart_ID: formState.VAStart_ID,
                        // Mitarbeiter-IDs die angefragt werden sollen
                        MA_IDs: maIds,
                        // Flag ob nur selektierte
                        selectedOnly: selectedOnly
                    }),
                    signal: AbortSignal.timeout(120000) // 2 Min Timeout für E-Mail-Versand
                });

                const result = await response.json();

                if (result.success) {
                    console.log('[VBA Bridge] Anfragen erfolgreich versendet:', result);
                    
                    // Erfolgsmeldung mit Details
                    const sent = result.sent || maIds.length;
                    const failed = result.failed || 0;
                    
                    if (failed > 0) {
                        showToast(`${sent} E-Mails gesendet, ${failed} fehlgeschlagen`, 'warning');
                    } else {
                        showToast(`${sent} E-Mail-Anfragen erfolgreich versendet`, 'success');
                    }
                    
                    // Listen aktualisieren (Status "Angefragt" setzen)
                    await refreshPlanungListe();
                    await zf_MA_Selektion();

                    // Optional: Zum Auftragstamm navigieren (wie in Access nach btnMail_Click)
                    if (result.navigateTo === 'frm_va_Auftragstamm' || confirm('Zurück zum Auftragstamm?')) {
                        setTimeout(() => {
                            navigateToForm('frm_va_Auftragstamm', formState.VA_ID);
                        }, 500);
                    }
                } else {
                    console.error('[VBA Bridge] Fehler:', result.error);
                    showToast('VBA-Versand fehlgeschlagen: ' + (result.error || 'Unbekannter Fehler'), 'error');
                    alert('E-Mail-Versand fehlgeschlagen!\\n\\nFehler: ' + (result.error || 'Unbekannter Fehler'));
                }

            } catch (err) {
                console.error('[VBA Bridge] Verbindungsfehler:', err);

                if (err.name === 'TimeoutError' || err.name === 'AbortError') {
                    showToast('VBA Bridge Timeout - Server antwortet nicht', 'error');
                    alert('VBA Bridge Server antwortet nicht!\\n\\nBitte prüfen Sie ob Access geöffnet ist und der Server läuft.');
                } else {
                    showToast('VBA Bridge Verbindungsfehler', 'error');
                    alert('VBA Bridge Verbindungsfehler!\\n\\nBitte prüfen Sie ob der Server läuft: start_vba_bridge.bat');
                }
            }
        }

        /**
         * Fallback: mailto: Links öffnen wenn VBA Bridge nicht verfügbar
         */
        async function fallbackMailtoAnfrage(maIds) {
            console.log('[Fallback] mailto: Anfrage für', maIds.length, 'Mitarbeiter');
            
            try {
                showToast('Lade Mitarbeiter-Daten...', 'info');

                // Auftragsdaten laden
                const auftragInfo = await getAuftragInfo(formState.VA_ID);
                
                // Mitarbeiter-E-Mails laden
                const response = await fetch(`http://localhost:5000/api/mitarbeiter?ids=${maIds.join(',')}&fields=MA_ID,Vorname,Nachname,eMail`);
                const result = await response.json();
                
                if (!result.success || !result.data) {
                    showToast('Fehler beim Laden der Mitarbeiter-Daten', 'error');
                    return;
                }

                // E-Mails filtern
                const mitarbeiterMitEmail = result.data.filter(m => m.eMail || m.Email || m.email);
                
                if (mitarbeiterMitEmail.length === 0) {
                    alert('Keine E-Mail-Adressen für die ausgewählten Mitarbeiter gefunden.');
                    return;
                }

                const emails = mitarbeiterMitEmail.map(m => m.eMail || m.Email || m.email);
                
                // E-Mail-Betreff und Body erstellen
                const datumFormatiert = auftragInfo?.VADatum 
                    ? new Date(auftragInfo.VADatum).toLocaleDateString('de-DE')
                    : 'demnächst';
                    
                const subject = encodeURIComponent(
                    `Einsatzanfrage: ${auftragInfo?.Auftrag || 'Auftrag'} am ${datumFormatiert}`
                );
                
                const body = encodeURIComponent(
                    `Hallo,\n\n` +
                    `Du hast eine neue Einsatzanfrage in Deiner CONSEC App.\n\n` +
                    `Auftrag: ${auftragInfo?.Auftrag || ''}\n` +
                    `Datum: ${datumFormatiert}\n` +
                    `Objekt: ${auftragInfo?.Objekt || auftragInfo?.ObjektName || ''}\n\n` +
                    `Bitte öffne die App um zu- oder abzusagen:\n` +
                    `https://webapp.consec-security.selfhost.eu/index.php?page=dashboard\n\n` +
                    `Mit freundlichen Grüßen\n` +
                    `CONSEC Auftragsplanung`
                );
                
                // mailto: Link öffnen
                const mailtoUrl = `mailto:${emails.join(',')}?subject=${subject}&body=${body}`;
                window.location.href = mailtoUrl;
                
                showToast(`E-Mail-Client geöffnet für ${emails.length} Empfänger`, 'success');
                
                // Anfragen in DB als "angefragt" markieren (optional)
                try {
                    await fetch('http://localhost:5000/api/anfragen/markieren', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ma_ids: maIds,
                            va_id: formState.VA_ID,
                            vadatum_id: formState.VADatum_ID,
                            status: 'angefragt'
                        })
                    });
                } catch (e) {
                    console.warn('[Fallback] Status-Update fehlgeschlagen:', e);
                }

            } catch (err) {
                console.error('[Fallback] Fehler:', err);
                showToast('Fehler beim Erstellen der E-Mail', 'error');
            }
        }

        // Hilfsfunktion: Auftragsdaten laden
        async function getAuftragInfo(vaId) {
            try {
                const response = await fetch(`http://localhost:5000/api/auftraege/${vaId}`);
                const result = await response.json();
                return result.success ? result.data.auftrag : null;
            } catch (err) {
                console.error('Fehler beim Laden der Auftragsdaten:', err);
                return null;
            }
        }

        // Hilfsfunktion: Datum formatieren
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('de-DE');
        }

        // ============================================
        // FILTER / AFTERUPDATE EVENTS
        // ============================================

        // cboVADatum_AfterUpdate
        async function cboVADatum_AfterUpdate() {
            console.log('[VBA] cboVADatum_AfterUpdate');

            const cboVADatum = document.getElementById('cboVADatum');
            formState.VADatum_ID = cboVADatum?.value;

            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                // Schichten laden via REST API
                console.log('[cboVADatum_AfterUpdate] Lade Schichten...');
                const schichten = await loadSchichten(formState.VA_ID, formState.VADatum_ID);

                if (schichten && schichten.length > 0) {
                    populateSchichtenListe(schichten);

                    // Erste Schicht automatisch auswählen
                    // API gibt "ID" zurück, nicht "VAStart_ID" - beide akzeptieren
                    formState.VAStart_ID = schichten[0].VAStart_ID || schichten[0].ID;
                    const lstZeiten = document.getElementById('lstZeiten_Body');
                    const ersteZeile = lstZeiten?.querySelector('.listbox-row');
                    if (ersteZeile) {
                        ersteZeile.classList.add('selected');

                        // Dienstende setzen
                        const dienstEnde = document.getElementById('DienstEnde');
                        if (dienstEnde) dienstEnde.value = schichten[0].VA_Ende || '';
                    }
                }

                // Geplante und zugesagte MA laden
                await loadPlanungUndZusage(formState.VA_ID, formState.VADatum_ID);

                // Parallele Einsätze laden
                await loadParalleleEinsaetzeData(formState.VADatum_ID);

                // Mitarbeiter-Liste neu laden
                await loadMitarbeiterListe();

            } catch (err) {
                console.error('[cboVADatum_AfterUpdate] Fehler:', err);
            }
        }

        // lstZeiten_AfterUpdate - Schicht ausgewaehlt
        function lstZeiten_AfterUpdate() {
            console.log('[VBA] lstZeiten_AfterUpdate');

            const lstZeiten = document.getElementById('lstZeiten_Body');
            const selected = lstZeiten?.querySelector('.listbox-row.selected');

            if (selected) {
                formState.VAStart_ID = selected.dataset.id;

                // Dienstende setzen
                const dienstEnde = document.getElementById('DienstEnde');
                const ende = selected.dataset.ende;
                if (dienstEnde && ende) {
                    dienstEnde.value = ende;
                }
            }

            // Vergleichszeiten aktualisieren und MA-Liste neu laden
            zf_MA_Selektion();
        }

        // cboAnstArt_AfterUpdate - Anstellungsart Filter
        function cboAnstArt_AfterUpdate() {
            console.log('[VBA] cboAnstArt_AfterUpdate');
            zf_MA_Selektion();
        }

        // cboQuali_AfterUpdate - Kategorie Filter
        function cboQuali_AfterUpdate() {
            console.log('[VBA] cboQuali_AfterUpdate');
            zf_MA_Selektion();
        }

        // IstVerfuegbar_AfterUpdate - Nur freie Filter
        function IstVerfuegbar_AfterUpdate() {
            console.log('[VBA] IstVerfuegbar_AfterUpdate');
            const chk = document.getElementById('IstVerfuegbar');
            const lbl = document.getElementById('lbl_NurFreie');
            if (lbl) {
                lbl.textContent = chk?.checked ? 'Nur freie anzeigen' : 'Alle anzeigen';
            }
            zf_MA_Selektion();
        }

        // IstAktiv_AfterUpdate - Nur aktive Filter
        function IstAktiv_AfterUpdate() {
            console.log('[VBA] IstAktiv_AfterUpdate');
            const chk = document.getElementById('IstAktiv');
            const lbl = document.getElementById('lbl_IstAktiv');
            if (lbl) {
                lbl.textContent = chk?.checked ? 'Nur aktive MA' : 'Alle anzeigen';
            }
            zf_MA_Selektion();
        }

        // cbVerplantVerfuegbar_AfterUpdate
        function cbVerplantVerfuegbar_AfterUpdate() {
            console.log('[VBA] cbVerplantVerfuegbar_AfterUpdate');
            const chk = document.getElementById('cbVerplantVerfuegbar');
            const lbl = document.getElementById('lbl_VerplantVerfuegbar');
            if (lbl) {
                lbl.textContent = chk?.checked ? 'geplant = verfügbar' : 'geplant = nicht verfügbar';
            }
            zf_MA_Selektion();
        }

        // cbNur34a_AfterUpdate
        function cbNur34a_AfterUpdate() {
            console.log('[VBA] cbNur34a_AfterUpdate');
            zf_MA_Selektion();
        }

        // DienstEnde_AfterUpdate - Wie VBA: Ruft f_lstZeiten_upd auf
        // Wird aufgerufen wenn der Benutzer die Dienstende-Zeit manuell aendert
        function DienstEnde_AfterUpdate() {
            console.log('[VBA] DienstEnde_AfterUpdate');
            f_lstZeiten_upd();
        }

        // f_lstZeiten_upd - Vergleichszeiten aktualisieren (wie VBA Zeile 1099-1104)
        function f_lstZeiten_upd() {
            console.log('[VBA] f_lstZeiten_upd');
            // In VBA: Call upd_Vergleichszeiten(Me.VA_ID, Me.lstZeiten.Column(2), Me.DienstEnde)
            // Dann: Call zf_MA_Selektion
            // Die Vergleichszeiten-Aktualisierung ist serverseitig komplex,
            // hier aktualisieren wir die MA-Liste direkt
            zf_MA_Selektion();
        }

        // ============================================
        // zf_MA_Selektion - Mitarbeiter-Liste aktualisieren
        // Wie Original Access: upd_qry_Verfuegbarkeit mit allen Filtern
        // ============================================
        async function zf_MA_Selektion() {
            console.log('[VBA] zf_MA_Selektion');

            // Filter-Werte sammeln (alle 6 Filter wie in Access)
            const istAktiv = document.getElementById('IstAktiv')?.checked !== false;
            const anstArt = document.getElementById('cboAnstArt')?.value || '';
            const cboQuali = document.getElementById('cboQuali')?.value || '';
            const istVerfuegbar = document.getElementById('IstVerfuegbar')?.checked || false;
            const cbVerplantVerfuegbar = document.getElementById('cbVerplantVerfuegbar')?.checked || false;
            const cbNur34a = document.getElementById('cbNur34a')?.checked || false;

            console.log('[zf_MA_Selektion] Filter:', { istAktiv, anstArt, cboQuali, istVerfuegbar, cbVerplantVerfuegbar, cbNur34a });

            try {
                // REST API aufrufen mit verfügbaren Filtern + view=table für alle Felder
                let url = `http://localhost:5000/api/mitarbeiter?aktiv=${istAktiv}&filter_anstellung=false&view=table`;

                // Anstellungsart-Filter
                if (anstArt && anstArt !== '' && anstArt !== 'Alle') {
                    url += `&anstellung=${anstArt}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Mitarbeiter nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    let mitarbeiter = result.data;

                    // Clientseitige Filter anwenden (Access-Logik nachbilden)

                    // Filter: Nur 34a (HatSachkunde = True UND Hat_keine_34a = False)
                    if (cbNur34a) {
                        mitarbeiter = mitarbeiter.filter(m =>
                            m.HatSachkunde === true && m.Hat_keine_34a !== true
                        );
                        console.log('[zf_MA_Selektion] Nach 34a-Filter:', mitarbeiter.length);
                    }

                    // Filter: Kategorie/Qualifikation (Kategorie_ID aus tbl_MA_Mitarbeiterstamm)
                    if (cboQuali && cboQuali !== '' && cboQuali !== 'Alle') {
                        const qualiId = parseInt(cboQuali);
                        mitarbeiter = mitarbeiter.filter(m =>
                            m.Kategorie_ID === qualiId || m.Kategorie === qualiId
                        );
                        console.log('[zf_MA_Selektion] Nach Quali-Filter:', mitarbeiter.length);
                    }

                    // Verfügbarkeit wird komplex in Access berechnet (upd_qry_Verfuegbarkeit)
                    // Das erfordert Datumsprüfung gegen tbl_MA_NVerfuegZeiten und tbl_MA_VA_Zuordnung
                    // Vorerst: Logging, komplexe Filterung müsste serverseitig erfolgen
                    if (istVerfuegbar) {
                        console.log('[zf_MA_Selektion] IstVerfuegbar-Filter aktiv (Serverseite erforderlich)');
                    }

                    populateMitarbeiterListe(mitarbeiter);

                    // Gesamt-Anzeige aktualisieren
                    const iGesMA = document.getElementById('iGes_MA');
                    if (iGesMA) iGesMA.value = mitarbeiter.length;
                }
            } catch (err) {
                console.error('[zf_MA_Selektion] Fehler:', err);
            }
        }

        // ============================================
        // cmdListMA_Standard / cmdListMA_Entfernung
        // ============================================

        // Standard-Ansicht
        function cmdListMA_Standard_Click() {
            console.log('[VBA] cmdListMA_Standard_Click');
            formState.bEntfernungsModus = false;

            // Entfernungs-Spalte ausblenden
            const colEntf = document.getElementById('colEntfernung');
            if (colEntf) colEntf.style.display = 'none';

            // Entfernungs-Spans aus Zeilen entfernen
            const listMA = document.getElementById('List_MA_Body');
            if (listMA) {
                listMA.querySelectorAll('.ma-entfernung').forEach(el => el.remove());
            }

            zf_MA_Selektion();
        }

        // Entfernungs-Ansicht
        function cmdListMA_Entfernung_Click() {
            console.log('[VBA] cmdListMA_Entfernung_Click');

            if (!formState.Objekt_ID || formState.Objekt_ID === 0) {
                alert('Kein Objekt fuer diesen Auftrag hinterlegt!');
                return;
            }

            formState.bEntfernungsModus = true;

            // Entfernungs-Spalte anzeigen
            const colEntf = document.getElementById('colEntfernung');
            if (colEntf) colEntf.style.display = '';

            // Entfernungen berechnen
            berechneEntfernungen();
        }

        // ============================================
        // GEO/ENTFERNUNG FEATURE
        // ============================================

        /**
         * Haversine-Formel zur Berechnung der Luftlinie zwischen zwei Koordinaten
         * Mit Null-Check wie im VBA Original (mdl_GeoDistanz.bas)
         * @param {number} lat1 - Breitengrad Punkt 1
         * @param {number} lng1 - Laengengrad Punkt 1
         * @param {number} lat2 - Breitengrad Punkt 2
         * @param {number} lng2 - Laengengrad Punkt 2
         * @returns {number} Distanz in Kilometern (9999 bei fehlenden Koordinaten)
         */
        function haversineDistance(lat1, lng1, lat2, lng2) {
            // Null-Check wie im VBA: If Lat1 = 0 Or Lon1 = 0 Or Lat2 = 0 Or Lon2 = 0 Then DistanceKm = 9999
            if (!lat1 || !lng1 || !lat2 || !lng2 || lat1 === 0 || lng1 === 0 || lat2 === 0 || lng2 === 0) {
                return 9999;
            }

            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            // Auf 1 Dezimalstelle runden wie im VBA: Round(EARTH_RADIUS_KM * c, 1)
            return Math.round(R * c * 10) / 10;
        }

        /**
         * Objekt-Koordinaten laden
         * @param {number} objektId - ID des Objekts
         * @returns {Promise<{lat: number, lng: number}|null>}
         */
        async function getObjektKoordinaten(objektId) {
            console.log('[GEO] Lade Objekt-Koordinaten fuer ID:', objektId);

            try {
                // WebView2 Modus: via Bridge
                if (window.Bridge && window.Bridge.loadData) {
                    return new Promise((resolve) => {
                        Bridge.execute('executeSQL', {
                            sql: `SELECT Geo_Lat, Geo_Lng, ob_Strasse, ob_PLZ, ob_Ort
                                  FROM tbl_OB_Objektstamm
                                  WHERE Objekt_ID = ${objektId}`
                        }).then(result => {
                            if (result && result.length > 0) {
                                const obj = result[0];
                                if (obj.Geo_Lat && obj.Geo_Lng) {
                                    resolve({ lat: parseFloat(obj.Geo_Lat), lng: parseFloat(obj.Geo_Lng) });
                                } else {
                                    // Keine Koordinaten, versuche Geocoding
                                    geocodeAdresse(obj.ob_Strasse, obj.ob_PLZ, obj.ob_Ort).then(resolve);
                                }
                            } else {
                                resolve(null);
                            }
                        }).catch(() => resolve(null));
                    });
                }

                // Browser Modus: via REST API
                const response = await fetch(`http://localhost:5000/api/objekte/${objektId}`);
                if (!response.ok) return null;

                const data = await response.json();
                if (data.success && data.data) {
                    const obj = data.data;
                    if (obj.Geo_Lat && obj.Geo_Lng) {
                        return { lat: parseFloat(obj.Geo_Lat), lng: parseFloat(obj.Geo_Lng) };
                    }
                    // Keine Koordinaten, versuche Geocoding
                    return await geocodeAdresse(obj.ob_Strasse, obj.ob_PLZ, obj.ob_Ort);
                }
                return null;
            } catch (err) {
                console.error('[GEO] Fehler beim Laden der Objekt-Koordinaten:', err);
                return null;
            }
        }

        /**
         * Geocodierung einer Adresse via OpenStreetMap Nominatim API
         * @param {string} strasse - Strassenname mit Hausnummer
         * @param {string} plz - Postleitzahl
         * @param {string} ort - Ortsname
         * @returns {Promise<{lat: number, lng: number}|null>}
         */
        async function geocodeAdresse(strasse, plz, ort) {
            if (!strasse && !plz && !ort) return null;

            const query = [strasse, plz, ort].filter(Boolean).join(', ') + ', Deutschland';
            console.log('[GEO] Geocoding Adresse:', query);

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'CONSEC-Planung/1.0'
                    }
                });

                if (!response.ok) return null;

                const results = await response.json();
                if (results && results.length > 0) {
                    return {
                        lat: parseFloat(results[0].lat),
                        lng: parseFloat(results[0].lon)
                    };
                }
                return null;
            } catch (err) {
                console.error('[GEO] Geocoding-Fehler:', err);
                return null;
            }
        }

        /**
         * Entfernungs-CSS-Klasse basierend auf Distanz
         * @param {number} distanzKm - Distanz in km
         * @returns {string} CSS-Klassenname
         */
        function getEntfernungsKlasse(distanzKm) {
            if (distanzKm === null || distanzKm === undefined || isNaN(distanzKm)) {
                return 'entf-unbekannt';
            }
            if (distanzKm < 10) return 'entf-gruen';
            if (distanzKm <= 30) return 'entf-gelb';
            return 'entf-rot';
        }

        /**
         * Formatiert die Entfernung fuer die Anzeige
         * @param {number} distanzKm - Distanz in km
         * @returns {string} Formatierter String
         */
        function formatEntfernung(distanzKm) {
            if (distanzKm === null || distanzKm === undefined || isNaN(distanzKm)) {
                return '?';
            }
            return distanzKm.toFixed(1) + ' km';
        }

        /**
         * Hauptfunktion: Berechnet Entfernungen fuer alle MA in der Liste
         * Nutzt vorberechnete Entfernungen aus tbl_MA_Objekt_Entfernung falls verfuegbar
         */
        async function berechneEntfernungen() {
            console.log('[GEO] berechneEntfernungen gestartet');

            const listMA = document.getElementById('List_MA_Body');
            if (!listMA) {
                console.warn('[GEO] List_MA_Body nicht gefunden');
                return;
            }

            showToast('Lade Entfernungsdaten...', 'info');

            // 1. Versuche vorberechnete Entfernungen zu laden (aus tbl_MA_Objekt_Entfernung)
            let vorberechneteEntfernungen = new Map();
            let objektKoords = null;

            try {
                // API-Endpoint fuer vorberechnete Entfernungen
                const response = await fetch(`http://localhost:5000/api/mitarbeiter/entfernungen?objekt_id=${formState.Objekt_ID}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        console.log('[GEO] Vorberechnete Entfernungen gefunden:', data.data.length);
                        data.data.forEach(item => {
                            vorberechneteEntfernungen.set(item.MA_ID, item.Entfernung_km);
                        });
                    }
                }
            } catch (err) {
                console.log('[GEO] Keine vorberechneten Entfernungen verfuegbar:', err);
            }

            // 2. Falls keine vorberechneten Daten: Objekt-Koordinaten laden fuer Live-Berechnung
            if (vorberechneteEntfernungen.size === 0) {
                objektKoords = await getObjektKoordinaten(formState.Objekt_ID);
                if (!objektKoords) {
                    alert('Objekt-Koordinaten konnten nicht ermittelt werden.\nBitte Adresse im Objektstamm pruefen.');
                    return;
                }
                console.log('[GEO] Objekt-Koordinaten:', objektKoords);
            }

            // 3. MA-Liste mit Geo-Daten laden (nur wenn Live-Berechnung noetig)
            let maKoordinaten = new Map();

            if (vorberechneteEntfernungen.size === 0) {
                let maListe = [];
                try {
                    if (window.Bridge && window.Bridge.execute) {
                        // WebView2 Modus
                        maListe = await Bridge.execute('executeSQL', {
                            sql: `SELECT MA_ID, Vorname, Nachname, Strasse, PLZ, Ort, Geo_Lat, Geo_Lng
                                  FROM tbl_MA_Mitarbeiterstamm
                                  WHERE IstAktiv = True`
                        });
                    } else {
                        // Browser Modus: via REST API
                        const response = await fetch('http://localhost:5000/api/mitarbeiter?fields=MA_ID,Vorname,Nachname,Strasse,PLZ,Ort,Geo_Lat,Geo_Lng');
                        const data = await response.json();
                        if (data.success) {
                            maListe = data.data || [];
                        }
                    }
                } catch (err) {
                    console.error('[GEO] Fehler beim Laden der MA-Daten:', err);
                }

                // MA-Koordinaten Map erstellen
                for (const ma of maListe) {
                    if (ma.Geo_Lat && ma.Geo_Lng) {
                        maKoordinaten.set(ma.MA_ID, {
                            lat: parseFloat(ma.Geo_Lat),
                            lng: parseFloat(ma.Geo_Lng)
                        });
                    } else if (ma.Strasse || ma.PLZ || ma.Ort) {
                        // Geocoding fuer MA ohne Koordinaten (mit Rate-Limiting)
                        // Nominatim erlaubt max 1 Request/Sekunde
                        // In Produktion: Koordinaten in DB cachen!
                        const coords = await geocodeAdresse(ma.Strasse, ma.PLZ, ma.Ort);
                        if (coords) {
                            maKoordinaten.set(ma.MA_ID, coords);
                        }
                        // Rate-Limiting: 1 Sekunde Pause zwischen Geocoding-Anfragen
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            // 4. Entfernungen berechnen und in Liste anzeigen
            const rows = listMA.querySelectorAll('.listbox-row');
            const entfernungsDaten = [];

            rows.forEach(row => {
                const maId = parseInt(row.dataset.id || row.dataset.maid);
                if (!maId) return;

                let entfernung = null;

                // Zuerst vorberechnete Entfernung pruefen
                if (vorberechneteEntfernungen.has(maId)) {
                    entfernung = vorberechneteEntfernungen.get(maId);
                } else if (objektKoords) {
                    // Falls nicht vorberechnet: Live berechnen
                    const maKoords = maKoordinaten.get(maId);
                    if (maKoords) {
                        entfernung = haversineDistance(
                            maKoords.lat, maKoords.lng,
                            objektKoords.lat, objektKoords.lng
                        );
                    }
                }

                // Entfernungs-Span hinzufuegen oder aktualisieren
                let entfSpan = row.querySelector('.ma-entfernung');
                if (!entfSpan) {
                    entfSpan = document.createElement('span');
                    entfSpan.className = 'ma-entfernung';
                    entfSpan.style.flex = '1';
                    row.appendChild(entfSpan);
                }

                entfSpan.textContent = formatEntfernung(entfernung);
                entfSpan.className = 'ma-entfernung ' + getEntfernungsKlasse(entfernung);

                // Fuer Sortierung speichern
                entfernungsDaten.push({
                    row: row,
                    entfernung: entfernung !== null && entfernung < 9999 ? entfernung : 99999
                });
            });

            // 5. Liste nach Entfernung sortieren
            entfernungsDaten.sort((a, b) => a.entfernung - b.entfernung);
            entfernungsDaten.forEach(item => {
                listMA.appendChild(item.row);
            });

            const quelle = vorberechneteEntfernungen.size > 0 ? '(aus DB)' : '(live berechnet)';
            console.log(`[GEO] Entfernungen berechnet und sortiert ${quelle}`);
            showToast(`Entfernungen berechnet ${quelle}`, 'success');
        }

        // ============================================
        // Schnellsuche (btnSchnellGo)
        // ============================================
        function btnSchnellGo_Click() {
            console.log('[VBA] btnSchnellGo_Click');

            const txtSuche = document.getElementById('strSchnellSuche');
            const suchbegriff = txtSuche?.value?.trim() || '';

            if (suchbegriff) {
                // Filterung direkt im DOM
                const listMA = document.getElementById('List_MA_Body');
                const rows = listMA?.querySelectorAll('.listbox-row');

                rows?.forEach(row => {
                    const name = row.textContent.toLowerCase();
                    row.style.display = name.includes(suchbegriff.toLowerCase()) ? '' : 'none';
                });
            } else {
                // Alle anzeigen
                const listMA = document.getElementById('List_MA_Body');
                const rows = listMA?.querySelectorAll('.listbox-row');
                rows?.forEach(row => row.style.display = '');
            }

            // Suchfeld leeren (wie VBA)
            if (txtSuche) txtSuche.value = '';
        }

        // ============================================
        // Doppelklick auf Listen
        // ============================================

        // List_MA_DblClick - MA zur Planung hinzufügen
        function List_MA_DblClick(event) {
            console.log('[VBA] List_MA_DblClick');

            // Angeklickte Zeile finden
            const row = event.target.closest('.listbox-row');
            if (!row) return;

            const maId = row.dataset.id;

            // Zeile als selected markieren (andere deselektieren) + Logic-State aktualisieren
            const listMA = document.getElementById('List_MA_Body');
            listMA?.querySelectorAll('.listbox-row.selected').forEach(r => {
                r.classList.remove('selected');
                // Logic-State: Deselektieren
                if (window.SchnellauswahlForm) {
                    window.SchnellauswahlForm.deselectMA(r.dataset.id);
                }
            });
            row.classList.add('selected');
            // Logic-State: Diesen selektieren
            if (window.SchnellauswahlForm) {
                window.SchnellauswahlForm.selectMA(maId);
            }
            console.log('[VBA] Doppelklick: MA selektiert:', maId);

            // Test_selected Prüfung (Doppelbelegung)
            if (!Test_selected(row)) {
                console.log('[VBA] Doppelklick: Verplanung abgebrochen durch Test_selected');
                return;
            }

            // MA zur Planung hinzufügen (maId bereits oben definiert)
            if (maId) {
                addMAToPlanung(parseInt(maId));
                refreshPlanungListe();
                zf_MA_Selektion();
            }
        }

        // lstMA_Plan_DblClick - Aus Planung entfernen
        function lstMA_Plan_DblClick(event) {
            console.log('[VBA] lstMA_Plan_DblClick');

            // Angeklickte Zeile finden
            const row = event.target.closest('.listbox-row');
            if (!row) return;

            // Zeile als selected markieren
            const lstPlan = document.getElementById('lstMA_Plan_Body');
            lstPlan?.querySelectorAll('.listbox-row.selected').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');

            // MA aus Planung entfernen
            const planId = row.dataset.id;
            if (planId) {
                // API-Aufruf zum Löschen
                removeMAfromPlanung(parseInt(planId));
                console.log('[VBA] Doppelklick: Planung', planId, 'entfernt');
            }
        }

        // Hilfsfunktion: MA aus Planung entfernen
        // skipRefresh=true wenn mehrere Löschungen erfolgen und Refresh am Ende gemacht wird
        async function removeMAfromPlanung(planId, skipRefresh = false) {
            try {
                const response = await fetch(`http://localhost:5000/api/planungen/${planId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    if (!skipRefresh) {
                        refreshPlanungListe();
                        zf_MA_Selektion();
                    }
                    return true;
                } else {
                    console.error('[removeMAfromPlanung] Fehler:', response.status);
                    return false;
                }
            } catch (err) {
                console.error('[removeMAfromPlanung] Fehler:', err);
                return false;
            }
        }

        // Lst_Parallel_Einsatz_DblClick - Anderen Einsatz öffnen
        function Lst_Parallel_Einsatz_DblClick(event) {
            console.log('[VBA] Lst_Parallel_Einsatz_DblClick');

            const row = event.target.closest('.listbox-row');
            if (row) {
                const vaId = row.dataset.vaid;
                const vadatumId = row.dataset.vadatumid;

                if (vaId && vadatumId) {
                    VAOpen(parseInt(vaId), parseInt(vadatumId));
                }
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        async function refreshPlanungListe() {
            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                // API verwendet datum_id nicht vadatum_id
                const response = await fetch(`http://localhost:5000/api/planungen?va_id=${formState.VA_ID}&datum_id=${formState.VADatum_ID}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        populatePlanungListe(result.data);
                        // Geplante MA aus linker Liste ausblenden
                        hidePlannedMAFromList(result.data);
                    }
                }
            } catch (err) {
                console.error('[refreshPlanungListe] Fehler:', err);
            }
        }

        // Geplante/zugesagte MA aus der linken Verfügbarkeitsliste ausblenden
        function hidePlannedMAFromList(planungen) {
            const listMA = document.getElementById('List_MA_Body');
            if (!listMA) return;

            // MA_IDs der geplanten sammeln
            const plannedMAIds = new Set(planungen.map(p => String(p.MA_ID)));

            // Alle Zeilen durchgehen und geplante ausblenden
            listMA.querySelectorAll('.listbox-row').forEach(row => {
                const maId = row.dataset.maid || row.dataset.id;
                if (plannedMAIds.has(String(maId))) {
                    row.style.display = 'none';
                } else {
                    row.style.display = '';
                }
            });

            // Anzahl aktualisieren
            const visibleCount = listMA.querySelectorAll('.listbox-row:not([style*="display: none"])').length;
            const iGesMA = document.getElementById('iGes_MA');
            if (iGesMA) iGesMA.value = visibleCount;
        }

        async function refreshZusageListe() {
            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                // API verwendet datum_id nicht vadatum_id
                const response = await fetch(`http://localhost:5000/api/zuordnungen?va_id=${formState.VA_ID}&datum_id=${formState.VADatum_ID}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        populateZusageListe(result.data);
                    }
                }
            } catch (err) {
                console.error('[refreshZusageListe] Fehler:', err);
            }
        }

        async function loadParalleleEinsaetze() {
            if (!formState.VADatum_ID) return;

            try {
                await loadParalleleEinsaetzeData(formState.VADatum_ID);
            } catch (err) {
                console.error('[loadParalleleEinsaetze] Fehler:', err);
            }
        }

        async function updateSollPlanIst() {
            // Soll/Plan/Ist Anzeige aktualisieren
            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                // Schichten-Daten für Soll-Anzahl laden
                const schichten = await loadSchichten(formState.VA_ID, formState.VADatum_ID);

                let soll = 0;
                let ist = 0;

                if (schichten && schichten.length > 0) {
                    // Summe aus allen Schichten
                    schichten.forEach(s => {
                        soll += parseInt(s.MA_Anzahl) || 0;
                        ist += parseInt(s.MA_Anzahl_Ist) || 0;
                    });
                }

                const lblGesMA = document.getElementById('iGes_MA');
                if (lblGesMA) {
                    lblGesMA.value = `${ist} / ${soll}`;
                }

                // btnAddZusage aktivieren/deaktivieren
                const btnAddZusage = document.getElementById('btnAddZusage');
                if (btnAddZusage) {
                    btnAddZusage.disabled = (ist >= soll);
                }
            } catch (err) {
                console.error('[updateSollPlanIst] Fehler:', err);
            }
        }

        function navigateToForm(formName, recordId) {
            // Verwende shell-detector.js Funktion wenn verfuegbar
            if (typeof window._shellNavigateToForm === 'function') {
                window._shellNavigateToForm(formName, recordId);
            } else if (window.parent !== window) {
                window.parent.postMessage({ type: 'NAVIGATE', formName: formName, id: recordId }, '*');
            } else {
                var url = formName + '.html';
                if (recordId) url += '?id=' + recordId;
                window.location.href = url;
            }
        }

        function showToast(message, type) {
            // Einfache Toast-Nachricht
            const toast = document.createElement('div');
            toast.className = 'toast ' + (type || '');
            toast.textContent = message;
            toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);' +
                'background:#000080;color:#fff;padding:10px 20px;border-radius:4px;z-index:9999;';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // EVENT BINDING
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[VBA Events] Initialisiere Event-Bindings...');

            // Form Events - zuerst Form_Load (lädt Dropdowns), dann Form_Open (lädt Daten)
            await Form_Load();
            await Form_Open();

            // Button Event-Listener
            document.getElementById('btnAuftrag')?.addEventListener('click', btnAuftrag_Click);
            document.getElementById('btnPosListe')?.addEventListener('click', btnPosListe_Click);
            document.getElementById('btnZuAbsage')?.addEventListener('click', btnZuAbsage_Click);
            document.getElementById('btnAddSelected')?.addEventListener('click', btnAddSelected_Click);
            document.getElementById('btnDelSelected')?.addEventListener('click', btnDelSelected_Click);
            document.getElementById('btnDelAll')?.addEventListener('click', btnDelAll_Click);
            document.getElementById('btnAddZusage')?.addEventListener('click', btnAddZusage_Click);
            document.getElementById('btnMoveZusage')?.addEventListener('click', btnMoveZusage_Click);
            document.getElementById('btnDelZusage')?.addEventListener('click', btnDelZusage_Click);
            document.getElementById('btnSortPLan')?.addEventListener('click', btnSortPlan_Click);
            document.getElementById('btnSortZugeord')?.addEventListener('click', btnSortZugeord_Click);
            // Mail-Buttons: Rufen VBA Bridge auf um Access-Buttons zu triggern
            document.getElementById('btnMail')?.addEventListener('click', btnMail_Click);
            document.getElementById('btnMailSelected')?.addEventListener('click', btnMailSelected_Click);
            document.getElementById('btnSchnellGo')?.addEventListener('click', btnSchnellGo_Click);
            document.getElementById('cmdListMA_Standard')?.addEventListener('click', cmdListMA_Standard_Click);
            document.getElementById('cmdListMA_Entfernung')?.addEventListener('click', cmdListMA_Entfernung_Click);
            document.getElementById('btnClose')?.addEventListener('click', () => {
                Form_Close();
                if (window.closeToShell) closeToShell();
                else window.close();
            });
            document.getElementById('btnHilfe')?.addEventListener('click', () => {
                alert('Hilfe für Schnellauswahl:\n\n' +
                    '1. Auftrag und Datum waehlen\n' +
                    '2. Schicht/Dienstzeit auswählen\n' +
                    '3. Mitarbeiter per Doppelklick oder Button zuordnen\n' +
                    '4. Anfragen per Mail-Button versenden');
            });

            // Filter AfterUpdate Events
            document.getElementById('cboVADatum')?.addEventListener('change', cboVADatum_AfterUpdate);
            document.getElementById('cboAnstArt')?.addEventListener('change', cboAnstArt_AfterUpdate);
            document.getElementById('cboQuali')?.addEventListener('change', cboQuali_AfterUpdate);
            document.getElementById('IstVerfuegbar')?.addEventListener('change', IstVerfuegbar_AfterUpdate);
            document.getElementById('IstAktiv')?.addEventListener('change', IstAktiv_AfterUpdate);
            document.getElementById('cbVerplantVerfuegbar')?.addEventListener('change', cbVerplantVerfuegbar_AfterUpdate);
            document.getElementById('cbNur34a')?.addEventListener('change', cbNur34a_AfterUpdate);
            document.getElementById('DienstEnde')?.addEventListener('change', DienstEnde_AfterUpdate);
            document.getElementById('VA_ID')?.addEventListener('change', async function() {
                // Guard: Nicht erneut VAOpen aufrufen wenn bereits am Laden
                if (_isVAOpenLoading) return;

                const vaId = parseInt(this.value);
                if (vaId) {
                    // VAOpen lädt alle Daten (Einsatztage, Schichten, Mitarbeiter)
                    // Objekt_ID wird bereits in VAOpen gesetzt (Zeile 1082)
                    await VAOpen(vaId, null);
                } else {
                    formState.VA_ID = null;
                    formState.VADatum_ID = null;
                }
            });

            // Schnellsuche Enter-Taste
            document.getElementById('strSchnellSuche')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    btnSchnellGo_Click();
                }
            });

            // Doppelklick-Events für Listen
            document.getElementById('List_MA_Body')?.addEventListener('dblclick', List_MA_DblClick);
            document.getElementById('lstMA_Plan_Body')?.addEventListener('dblclick', lstMA_Plan_DblClick);
            document.getElementById('Lst_Parallel_Einsatz')?.addEventListener('dblclick', Lst_Parallel_Einsatz_DblClick);
            document.getElementById('lstZeiten_Body')?.addEventListener('click', function(e) {
                const row = e.target.closest('.listbox-row');
                if (row) {
                    this.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    lstZeiten_AfterUpdate();
                }
            });

            // Window beforeunload
            window.addEventListener('beforeunload', Form_Close);

            console.log('[VBA Events] Event-Bindings abgeschlossen');
        });

        // ============================================
        // Vollbild-Toggle Funktion (Browser Fullscreen API)
        // ============================================
        function toggleFullscreen() {
            const btn = document.getElementById('fullscreenBtn');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    btn.title = 'Vollbild beenden';
                }).catch(err => console.error('Fullscreen error:', err));
            } else {
                document.exitFullscreen().then(() => {
                    btn.title = 'Vollbild';
                }).catch(err => console.error('Exit fullscreen error:', err));
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreenBtn');
            btn.title = document.fullscreenElement ? 'Vollbild beenden' : 'Vollbild';
        });
    </script>

    <!-- Shell-Detector (muss vor </body>) -->
    <script src="js/shell-detector.js"></script>
    <!-- Server Watchdog: Prüft API-Server-Verfügbarkeit -->
    <script src="js/server-watchdog.js"></script>

    <!-- ============================================
         ANFRAGE-LOG MODAL (Phase 2)
         ============================================ -->
    <div id="anfrageModalOverlay" class="anfrage-modal-overlay">
        <div class="anfrage-modal">
            <div class="anfrage-modal-header">
                <span id="anfrageModalTitle">Mitarbeiter werden angefragt...</span>
                <button class="anfrage-modal-close" id="anfrageModalCloseX" disabled>&times;</button>
            </div>
            <div class="anfrage-modal-body">
                <div class="anfrage-progress-container">
                    <div class="anfrage-progress-label">
                        <span>Fortschritt:</span>
                        <span id="anfrageProgressCount">0 / 0</span>
                    </div>
                    <div class="anfrage-progress-bar">
                        <div class="anfrage-progress-fill" id="anfrageProgressFill"></div>
                        <span class="anfrage-progress-text" id="anfrageProgressPercent">0%</span>
                    </div>
                </div>
                <div style="flex: 1; overflow: auto; max-height: 300px;">
                    <table class="anfrage-log-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">Nr</th>
                                <th>Mitarbeiter</th>
                                <th style="width: 100px;">Status</th>
                                <th style="width: 150px;">Ergebnis</th>
                            </tr>
                        </thead>
                        <tbody id="anfrageLogBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="anfrage-modal-footer">
                <span class="anfrage-summary" id="anfrageSummary"></span>
                <button class="anfrage-modal-btn" id="anfrageModalCloseBtn" disabled>Schließen</button>
            </div>
        </div>
    </div>
</body>
</html>



