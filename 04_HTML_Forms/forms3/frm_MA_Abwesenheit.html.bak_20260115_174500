<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <script>
    // Auto-Load in Shell (Sidebar-Integration)
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        const isInShell = urlParams.has('shell') || window.SHELL_PARAMS;
        const isInIframe = window.self !== window.top;
        if (!isInShell && !isInIframe) {
            const formName = window.location.pathname.split('/').pop();
            const recordId = urlParams.get('id') || urlParams.get('ma_id') || urlParams.get('kd_id') || urlParams.get('va_id');
            let shellUrl = 'shell.html?form=' + formName;
            if (recordId) shellUrl += '&id=' + recordId;
            for (const [key, value] of urlParams.entries()) {
                if (!['shell', 'id', 'ma_id', 'kd_id', 'va_id', '_t'].includes(key)) {
                    shellUrl += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(value);
                }
            }
            console.log('[Auto-Redirect] Lade mit Sidebar:', shellUrl);
            window.location.replace(shellUrl);
        }
    })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abwesenheitsplanung - CONSYS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* CONSYS Standard: Body-Hintergrund */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #8080c0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .left-menu {
            width: 185px;
            background-color: #6060a0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .menu-header {
            background-color: #000080;
            color: white;
            padding: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .menu-btn {
            background: linear-gradient(to bottom, #d0d0e0, #a0a0c0);
            padding: 8px 10px;
            font-size: 12px;
            color: #000;
            text-decoration: none;
            display: block;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            position: relative;
            border: none;
            margin: 1px 0;
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: calc(100% - 4px);
            height: 2px;
            background: #ffffff;
        }

        .menu-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: calc(100% - 4px);
            height: 2px;
            background: #404070;
        }

        .menu-btn:hover { background: linear-gradient(to bottom, #e0e0f0, #b0b0d0); }
        .menu-btn:active { background: linear-gradient(to bottom, #b0b0d0, #9090b0); }
        .menu-btn.active { background: linear-gradient(to bottom, #a0a0d0, #8080b0); }

        /* Main Container */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #b8b8d8;
            overflow: hidden;
        }

        /* Header */
        .form-header {
            background: #d3d3d3;
            color: white;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 22px; /* Formulartitel +8px (war 14px) gemaess Anforderung */
            font-weight: bold;
        }

        .header-btn-icon {
            background: linear-gradient(to bottom, #d0d0e0, #a0a0c0);
            border: 1px solid;
            border-color: #e0e0f0 #606090 #606090 #e0e0f0;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .header-btn-icon:hover { background: linear-gradient(to bottom, #e0e0f0, #b0b0d0); }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: #b8b8d8;
        }

        /* Form Controls */
        .field-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .field-row label {
            min-width: 100px;
            font-size: 11px;
        }

        .form-control, .input-large, .input-field, .input-date, .input-time {
            padding: 4px 6px;
            border: 1px solid #7070a0;
            background-color: white;
            font-size: 11px;
        }

        .input-large { width: 300px; }
        .input-field { flex: 1; }
        .input-date { width: 110px; }
        .input-time { width: 70px; }

        select.form-control { min-width: 150px; }

        /* Main Layout */
        .main-content-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Input Section - VBA: Eingabefelder */
        .input-section {
            flex: 0 0 380px;
            background-color: #c0c0d0;
            padding: 10px;
            border: 1px solid #7070a0;
        }

        fieldset {
            border: 1px solid #7070a0;
            padding: 10px;
            margin-bottom: 10px;
        }

        fieldset legend {
            font-size: 11px;
            font-weight: bold;
            padding: 0 5px;
        }

        /* Button Section */
        .button-section {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .btn {
            background: linear-gradient(to bottom, #d0d0e0, #a0a0c0);
            border: none;
            padding: 4px 12px;
            font-size: 11px;
            cursor: pointer;
        }

        .btn:hover { background: linear-gradient(to bottom, #e0e0f0, #b0b0d0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary, .btn-blue {
            background: linear-gradient(to bottom, #9090c0, #6060a0);
        }

        .btn-primary:hover, .btn-blue:hover { background: linear-gradient(to bottom, #a0a0d0, #7070b0); }

        .btn-danger, .btn-red {
            background: linear-gradient(to bottom, #c09090, #a06060);
        }

        .btn-success, .btn-green {
            background: linear-gradient(to bottom, #90c090, #60a060);
        }

        /* List Section - VBA: lsttmp_Fehlzeiten */
        .list-section {
            flex: 1;
            background-color: #c0c0d0;
            padding: 10px;
            border: 1px solid #7070a0;
            display: flex;
            flex-direction: column;
        }

        .list-header {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            background-color: white;
            border: 1px solid #7070a0;
            flex: 1;
            overflow-y: auto;
            max-height: 450px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .data-table th {
            background-color: #000080;
            color: white;
            padding: 4px;
            border: 1px solid #606090;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 4px;
            border: 1px solid #d0d0d0;
        }

        .data-table tbody tr:nth-child(even) { background-color: #f5f5f5; }
        .data-table tbody tr:hover { background-color: #e0e0f0; cursor: pointer; }
        .data-table tbody tr.selected { background-color: #c0d0f0; }

        /* Radio Button Group - VBA: AbwesenArt */
        .radio-group {
            display: flex;
            gap: 15px;
            margin: 8px 0;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        /* Checkbox */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .checkbox-row input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        /* Status Bar */
        .status-bar {
            background-color: #c0c0d0;
            border-top: 1px solid #7070a0;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        /* Fullscreen Button */
        .fullscreen-btn {
            position: fixed;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: linear-gradient(to bottom, #d0d0e0, #a0a0c0);
            border: none;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #000080;
        }

        .fullscreen-btn:hover { background: linear-gradient(to bottom, #e0e0f0, #b0b0d0); }
        .fullscreen-btn:active { background: linear-gradient(to bottom, #b0b0d0, #9090b0); }

        /* Time inputs disabled state */
        .time-inputs.disabled input {
            background-color: #e0e0e0;
            color: #808080;
        }

        .loading-cell {
            text-align: center;
            padding: 40px;
            color: #999;
        }

    </style>
    <link rel="stylesheet" href="consys-common.css">
    <link rel="stylesheet" href="css/fonts_override.css">
<link rel="stylesheet" href="css/visbug_overrides.css">
</head>
<body data-active-menu="abwesenheit" data-form="frm_MA_Abwesenheit">
    <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="Vollbild">&#x26F6;</button>

    <!-- Left Menu -->
    <nav class="left-menu">
        <div class="menu-header">CONSYS Menu</div>
        <button class="menu-btn" data-form="frm_Menuefuehrung1">Dashboard</button>
        <button class="menu-btn" data-form="frm_MA_Mitarbeiterstamm">Mitarbeiter</button>
        <button class="menu-btn" data-form="frm_KD_Kundenstamm">Kunden</button>
        <button class="menu-btn" data-form="frm_va_Auftragstamm">Aufträge</button>
        <button class="menu-btn" data-form="frm_OB_Objekt">Objekte</button>
        <button class="menu-btn" data-form="frm_N_Dienstplanübersicht">Dienstplan</button>
        <button class="menu-btn" data-form="frm_MA_Zeitkonten">Zeitkonten</button>
        <button class="menu-btn active" data-form="frm_MA_Abwesenheit">Abwesenheit</button>
        <button class="menu-btn" data-form="frm_N_Lohnabrechnungen">Lohnabrechnung</button>
    </nav>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="form-header">
            <span>Abwesenheitsplanung (Nicht-Verfügbar-Zeiten)</span>
            <span id="header-date"></span>
        </header>

        <!-- Content -->
        <div class="content-area">
            <div class="main-content-area">
                <!-- Input Section - VBA: Eingabefelder -->
                <div class="input-section">
                    <!-- Mitarbeiter Auswahl - VBA: cbo_MA_ID -->
                    <fieldset>
                        <legend>Mitarbeiter</legend>
                        <div class="field-row">
                            <label>Mitarbeiter:</label>
                            <select id="cbo_MA_ID" class="form-control" style="width:220px;">
                                <option value="">-- Mitarbeiter waehlen --</option>
                            </select>
                        </div>
                    </fieldset>

                    <!-- Abwesenheitsgrund - VBA: cboAbwGrund -->
                    <fieldset>
                        <legend>Abwesenheitsgrund</legend>
                        <div class="field-row">
                            <label>Grund:</label>
                            <select id="cboAbwGrund" class="form-control" style="width:220px;">
                                <option value="">-- Grund waehlen --</option>
                            </select>
                        </div>
                        <div class="field-row">
                            <label>Bemerkung:</label>
                            <input type="text" id="Bemerkung" class="form-control input-field">
                        </div>
                    </fieldset>

                    <!-- Zeitraum - VBA: DatVon, DatBis, AbwesenArt -->
                    <fieldset>
                        <legend>Zeitraum</legend>
                        <div class="field-row">
                            <label>Von Datum:</label>
                            <input type="date" id="DatVon" class="form-control input-date">
                            <span style="margin-left:10px;font-size:10px;color:#666;" id="lblDatVonTag"></span>
                        </div>
                        <div class="field-row">
                            <label>Bis Datum:</label>
                            <input type="date" id="DatBis" class="form-control input-date">
                            <span style="margin-left:10px;font-size:10px;color:#666;" id="lblDatBisTag"></span>
                        </div>

                        <!-- AbwesenArt Radio - VBA: AbwesenArt_AfterUpdate -->
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="AbwesenArt" id="AbwesenArt1" value="1" checked>
                                Ganztag
                            </label>
                            <label>
                                <input type="radio" name="AbwesenArt" id="AbwesenArt2" value="2">
                                Teilzeit (von-bis)
                            </label>
                        </div>

                        <!-- Zeit von/bis - VBA: TlZeitVon, TlZeitBis -->
                        <div class="field-row time-inputs" id="timeInputs">
                            <label>Zeit von:</label>
                            <input type="time" id="TlZeitVon" class="form-control input-time" value="00:00" disabled>
                            <label style="margin-left:15px;">bis:</label>
                            <input type="time" id="TlZeitBis" class="form-control input-time" value="00:00" disabled>
                        </div>

                        <!-- NurWerktags Checkbox - VBA: NurWerktags -->
                        <div class="checkbox-row">
                            <input type="checkbox" id="NurWerktags">
                            <label for="NurWerktags">Nur Werktage (Mo-Fr, keine Feiertage)</label>
                        </div>
                    </fieldset>

                    <!-- Buttons - VBA: btnAbwBerechnen_Click, bznUebernehmen_Click -->
                    <div class="button-section">
                        <button class="btn btn-primary" id="btnAbwBerechnen" title="Abwesenheiten in Vorschau berechnen">Berechnen</button>
                        <button class="btn btn-success" id="bznUebernehmen" title="Berechnete Zeiten uebernehmen">Uebernehmen</button>
                    </div>
                </div>

                <!-- List Section - VBA: lsttmp_Fehlzeiten -->
                <div class="list-section">
                    <div class="list-header">
                        <span>Berechnete Abwesenheiten (Vorschau)</span>
                        <div>
                            <!-- VBA: btnMarkLoesch_Click, btnAllLoesch_Click -->
                            <button class="btn" id="btnMarkLoesch" title="Markierte Eintraege löschen">Markierte löschen</button>
                            <button class="btn btn-danger" id="btnAllLoesch" title="Alle Eintraege löschen">Alle löschen</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="tblFehlzeiten">
                            <thead>
                                <tr>
                                    <th style="width:30px;">
                                        <input type="checkbox" id="selectAll" title="Alle auswählen">
                                    </th>
                                    <th style="width:40px;">ID</th>
                                    <th style="width:150px;">Mitarbeiter</th>
                                    <th style="width:120px;">Von</th>
                                    <th style="width:120px;">Bis</th>
                                    <th style="width:100px;">Grund</th>
                                    <th>Bemerkung</th>
                                </tr>
                            </thead>
                            <tbody id="tbody_Fehlzeiten">
                                <tr><td colspan="7" class="loading-cell">Keine Eintraege - bitte Abwesenheit berechnen</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top:8px;font-size:11px;color:#404040;">
                        <span id="lblAnzahl">0 Eintraege</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <footer class="status-bar">
            <span id="lblStatus">Bereit</span>
            <span id="lblInfo">Formular: frmTop_MA_Abwesenheitsplanung</span>
        </footer>
    </div>

    <script>
        /**
         * frm_MA_Abwesenheit - VBA Events als JavaScript
         * Basierend auf Form_frmTop_MA_Abwesenheitsplanung.bas
         */

        // ============================================
        // STATE
        // ============================================
        const state = {
            fehlzeiten: [],         // tbltmp_Fehlzeiten
            maLookup: [],           // Mitarbeiter
            gruendeLookup: [],      // Abwesenheitsgruende
            feiertage: [],          // Deutsche Feiertage (via API)
            selectedMA: null,
            selectedRows: new Set()
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const el = {};

        // ============================================
        // INITIALIZATION - VBA: Form_Open
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Abwesenheit] Form_Open Event');

            // Cache DOM elements
            el.cbo_MA_ID = document.getElementById('cbo_MA_ID');
            el.cboAbwGrund = document.getElementById('cboAbwGrund');
            el.Bemerkung = document.getElementById('Bemerkung');
            el.DatVon = document.getElementById('DatVon');
            el.DatBis = document.getElementById('DatBis');
            el.TlZeitVon = document.getElementById('TlZeitVon');
            el.TlZeitBis = document.getElementById('TlZeitBis');
            el.NurWerktags = document.getElementById('NurWerktags');
            el.timeInputs = document.getElementById('timeInputs');
            el.tbody_Fehlzeiten = document.getElementById('tbody_Fehlzeiten');
            el.lblAnzahl = document.getElementById('lblAnzahl');
            el.lblStatus = document.getElementById('lblStatus');
            el.lblDatVonTag = document.getElementById('lblDatVonTag');
            el.lblDatBisTag = document.getElementById('lblDatBisTag');

            // VBA: Form_Open - DELETE * FROM tbltmp_Fehlzeiten
            state.fehlzeiten = [];

            // VBA: Call create_Default_AlleTage(Get_Priv_Property("Default_Bundesland"))
            // JS: Laden wir Feiertage via API
            loadFeiertage(new Date().getFullYear());

            // VBA: Me.NurWerktags = False
            el.NurWerktags.checked = false;

            // VBA: Me.AbwesenArt = 1
            document.getElementById('AbwesenArt1').checked = true;

            // VBA: Call AbwesenArt_AfterUpdate
            AbwesenArt_AfterUpdate();

            // VBA: Me.TlZeitVon = "00:00", Me.TlZeitBis = "00:00"
            el.TlZeitVon.value = '00:00';
            el.TlZeitBis.value = '00:00';

            // Setup Event Listeners
            setupEventListeners();

            // Load data
            loadMitarbeiter();
            loadAbwesenheitsgruende();

            // Set header date
            document.getElementById('header-date').textContent = new Date().toLocaleDateString('de-DE');

            // Set default dates
            const heute = new Date();
            el.DatVon.value = formatDateISO(heute);
            el.DatBis.value = formatDateISO(heute);
            updateDatumTags();

            setStatus('Bereit - Bitte Mitarbeiter und Grund auswählen');
        });

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // VBA: cbo_MA_ID_AfterUpdate
            el.cbo_MA_ID.addEventListener('change', cbo_MA_ID_AfterUpdate);

            // VBA: AbwesenArt_AfterUpdate (Radio buttons)
            document.querySelectorAll('input[name="AbwesenArt"]').forEach(radio => {
                radio.addEventListener('change', AbwesenArt_AfterUpdate);
            });

            // VBA: DatVon_DblClick, DatBis_DblClick (Kalender öffnen - vereinfacht)
            el.DatVon.addEventListener('change', updateDatumTags);
            el.DatBis.addEventListener('change', updateDatumTags);

            // Button Events
            document.getElementById('btnAbwBerechnen').addEventListener('click', btnAbwBerechnen_Click);
            document.getElementById('bznUebernehmen').addEventListener('click', bznUebernehmen_Click);
            document.getElementById('btnMarkLoesch').addEventListener('click', btnMarkLoesch_Click);
            document.getElementById('btnAllLoesch').addEventListener('click', btnAllLoesch_Click);

            // Select All checkbox
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = el.tbody_Fehlzeiten.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    const id = parseInt(cb.dataset.id);
                    if (this.checked) {
                        state.selectedRows.add(id);
                    } else {
                        state.selectedRows.delete(id);
                    }
                });
            });

            // Menu navigation
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const formName = this.dataset.form;
                    if (formName) navigateToForm(formName);
                });
            });
        }

        // ============================================
        // VBA EVENT IMPLEMENTATIONS
        // ============================================

        /**
         * VBA: AbwesenArt_AfterUpdate
         * Aktiviert/Deaktiviert Zeitfelder basierend auf Abwesenheitsart
         */
        function AbwesenArt_AfterUpdate() {
            const abwesenArt = parseInt(document.querySelector('input[name="AbwesenArt"]:checked').value);

            // VBA:
            // Case 1: Ganztag -> TlZeitVon.Enabled = False, TlZeitBis.Enabled = False
            // Case 2: Partiell -> TlZeitVon.Enabled = True, TlZeitBis.Enabled = True
            if (abwesenArt === 1) {
                el.TlZeitVon.disabled = true;
                el.TlZeitBis.disabled = true;
                el.timeInputs.classList.add('disabled');
            } else if (abwesenArt === 2) {
                el.TlZeitVon.disabled = false;
                el.TlZeitBis.disabled = false;
                el.timeInputs.classList.remove('disabled');
            }
        }

        /**
         * VBA: cbo_MA_ID_AfterUpdate
         * Aktualisiert die Abwesenheitsgruende basierend auf Anstellungsart
         */
        async function cbo_MA_ID_AfterUpdate() {
            state.selectedMA = el.cbo_MA_ID.value;

            if (!state.selectedMA) {
                setStatus('Bitte Mitarbeiter auswählen');
                return;
            }

            // VBA: anstArt = TLookup("Anstellungsart_ID", MASTAMM, "ID = " & Me.cbo_MA_ID)
            // Hier vereinfacht - wir laden alle Gruende
            try {
                const ma = state.maLookup.find(m => m.ID == state.selectedMA);
                const anstArt = ma ? ma.Anstellungsart_ID : 0;

                // VBA: If anstArt = 5 Then (Minijobber) -> ohne Krank und Urlaub
                //      Else -> ohne Hauptjob
                let gruende = [...state.gruendeLookup];

                if (anstArt === 5) {
                    // Minijobber: ohne Krank (ID=6?) und Urlaub (ID=7?)
                    gruende = gruende.filter(g => g.ID > 5 && g.ID !== 7);
                } else {
                    // Andere: ohne Hauptjob (ID=11?)
                    gruende = gruende.filter(g => g.ID > 4 && g.ID !== 11);
                }

                // Update dropdown
                el.cboAbwGrund.innerHTML = '<option value="">-- Grund waehlen --</option>';
                gruende.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.Kürzel || g.Zeittyp;
                    option.textContent = g.Zeittyp || g.Kürzel;
                    el.cboAbwGrund.appendChild(option);
                });

                setStatus(`Mitarbeiter ${ma ? ma.Name : ''} ausgewaehlt`);

            } catch (error) {
                console.error('[Abwesenheit] Fehler:', error);
            }
        }

        /**
         * VBA: btnAbwBerechnen_Click
         * Berechnet die Abwesenheiten und fuellt die Vorschau-Tabelle
         */
        function btnAbwBerechnen_Click() {
            // VBA: Validation
            const iMA_ID = parseInt(el.cbo_MA_ID.value) || 0;
            const strAbwesenArt = el.cboAbwGrund.value || '';
            const Bemerk = el.Bemerkung.value || '';

            if (iMA_ID === 0) {
                alert('Bitte zuerst Mitarbeiter eingeben');
                return;
            }

            if (!strAbwesenArt) {
                alert('Bitte zuerst einen Grund eingeben');
                return;
            }

            // VBA: If Len(Trim(Nz(Me!DatVon))) = 0 Or Len(Trim(Nz(Me!DatBis))) = 0 Then Me.DatBis = Me.DatVon
            if (!el.DatVon.value || !el.DatBis.value) {
                el.DatBis.value = el.DatVon.value;
            }

            const dtDatVon = new Date(el.DatVon.value);
            const dtDatBis = new Date(el.DatBis.value);

            // VBA: If dtDatvon > dtDatBis Then MsgBox "Von- und BisDatum sind vertauscht"
            if (dtDatVon > dtDatBis) {
                alert('Von- und BisDatum sind vertauscht');
                return;
            }

            const bNurWerkTag = el.NurWerktags.checked;
            const abwesenArt = parseInt(document.querySelector('input[name="AbwesenArt"]:checked').value);

            let dtTlZeitVon, dtTlZeitBis;
            let iTag = 0;

            // VBA: Select Case Me!AbwesenArt
            if (abwesenArt === 1) {
                // Ganztag
                dtTlZeitVon = '00:00';
                dtTlZeitBis = '23:59';
            } else if (abwesenArt === 2) {
                // Partiell
                dtTlZeitVon = el.TlZeitVon.value || '00:00';
                dtTlZeitBis = el.TlZeitBis.value || '00:00';
                // Check if time crosses midnight
                if (dtTlZeitVon > dtTlZeitBis) {
                    iTag = 1;
                }
            }

            // Mitarbeiter-Name für Anzeige
            const ma = state.maLookup.find(m => m.ID == iMA_ID);
            const maName = ma ? ma.Name : `MA ${iMA_ID}`;

            // VBA: Loop through days and create entries
            const current = new Date(dtDatVon);
            let idCounter = state.fehlzeiten.length + 1;

            setStatus('Berechne Abwesenheiten...');

            while (current <= dtDatBis) {
                const dayOfWeek = current.getDay(); // 0=So, 6=Sa

                // VBA: If bNurWerkTag Then ... AND Wochentag < 6 AND Landesfeiertag = False
                let include = true;
                if (bNurWerkTag) {
                    // Exclude weekends (0=Sunday, 6=Saturday)
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        include = false;
                    }
                    // TODO: Check Feiertage (would need API or local list)
                }

                if (include) {
                    const vonDateTime = new Date(current);
                    const [vh, vm] = dtTlZeitVon.split(':').map(Number);
                    vonDateTime.setHours(vh, vm, 0);

                    const bisDateTime = new Date(current);
                    bisDateTime.setDate(bisDateTime.getDate() + iTag);
                    const [bh, bm] = dtTlZeitBis.split(':').map(Number);
                    bisDateTime.setHours(bh, bm, 0);

                    state.fehlzeiten.push({
                        ID: idCounter++,
                        MA_ID: iMA_ID,
                        MA_Name: maName,
                        AbwesenArt: strAbwesenArt,
                        Bemerk: Bemerk,
                        DatVon: vonDateTime,
                        DatBis: bisDateTime
                    });
                }

                current.setDate(current.getDate() + 1);
            }

            // VBA: Me!lsttmp_Fehlzeiten.Requery
            renderFehlzeitenTable();

            setStatus(`${state.fehlzeiten.length} Eintraege berechnet`);
        }

        /**
         * VBA: bznUebernehmen_Click
         * Uebernimmt die berechneten Zeiten in die Datenbank
         */
        async function bznUebernehmen_Click() {
            if (state.fehlzeiten.length === 0) {
                alert('Keine Eintraege zum Uebernehmen');
                return;
            }

            setStatus('Uebernehme Abwesenheiten...');

            try {
                // VBA: CurrentDb.Execute ("qry_Ins_MA_NVerfuegZeiten")
                // API call to save
                for (const fz of state.fehlzeiten) {
                    await saveAbwesenheit(fz);
                }

                // VBA: Call CurrentDb.Execute("qry_MA_NVerfueg_ZeitUpdate")
                // VBA: Call CurrentDb.Execute("qry_MA_NVerfueg_ZeitUpdate_2")
                // (Backend updates)

                // VBA: CurrentDb.Execute ("DELETE * FROM tbltmp_Fehlzeiten")
                state.fehlzeiten = [];

                // VBA: Me!lsttmp_Fehlzeiten.Requery
                renderFehlzeitenTable();

                // VBA: MsgBox "Nicht-Verfügbar-Zeiten erfolgreich uebernommen"
                alert('Nicht-Verfügbar-Zeiten erfolgreich uebernommen');

                setStatus('Abwesenheiten gespeichert');

            } catch (error) {
                console.error('[Abwesenheit] Fehler beim Speichern:', error);
                setStatus('Fehler: ' + error.message);
            }
        }

        /**
         * VBA: btnMarkLoesch_Click
         * Loescht die markierten Eintraege aus der Vorschau
         */
        function btnMarkLoesch_Click() {
            if (state.selectedRows.size === 0) {
                alert('Keine Eintraege markiert');
                return;
            }

            // VBA: For Each var In Me!lsttmp_Fehlzeiten.ItemsSelected
            //      CurrentDb.Execute ("DELETE * FROM tbltmp_Fehlzeiten WHERE ID = " & i)
            state.fehlzeiten = state.fehlzeiten.filter(fz => !state.selectedRows.has(fz.ID));
            state.selectedRows.clear();

            renderFehlzeitenTable();

            setStatus(`Markierte Eintraege gelöscht`);
        }

        /**
         * VBA: btnAllLoesch_Click
         * Loescht alle Eintraege aus der Vorschau
         */
        function btnAllLoesch_Click() {
            // VBA: CurrentDb.Execute ("DELETE * FROM tbltmp_Fehlzeiten")
            state.fehlzeiten = [];
            state.selectedRows.clear();

            renderFehlzeitenTable();

            setStatus('Alle Eintraege gelöscht');
        }

        // ============================================
        // DATA LOADING
        // ============================================

        async function loadMitarbeiter() {
            try {
                const response = await fetch('http://localhost:5000/api/mitarbeiter?aktiv=true');
                if (!response.ok) throw new Error('API nicht erreichbar');

                const data = await response.json();
                state.maLookup = (data.data || data || []).map(ma => ({
                    ID: ma.MA_ID || ma.ID,
                    Name: `${ma.MA_Nachname || ma.Nachname}, ${ma.MA_Vorname || ma.Vorname}`,
                    Anstellungsart_ID: ma.Anstellungsart_ID || 0
                }));

                // Populate dropdown
                el.cbo_MA_ID.innerHTML = '<option value="">-- Mitarbeiter waehlen --</option>';
                state.maLookup.forEach(ma => {
                    const option = document.createElement('option');
                    option.value = ma.ID;
                    option.textContent = ma.Name;
                    el.cbo_MA_ID.appendChild(option);
                });

            } catch (error) {
                console.error('[Abwesenheit] Fehler beim Laden der Mitarbeiter:', error);
                setStatus('API-Fehler: Mitarbeiter konnten nicht geladen werden');
            }
        }

        async function loadAbwesenheitsgruende() {
            try {
                const response = await fetch('http://localhost:5000/api/dienstplan/gruende');

                if (response.ok) {
                    const data = await response.json();
                    state.gruendeLookup = data.data || data || [];
                } else {
                    // Fallback: Hardcoded defaults
                    state.gruendeLookup = [
                        { ID: 5, Kürzel: 'U', Zeittyp: 'Urlaub' },
                        { ID: 6, Kürzel: 'K', Zeittyp: 'Krank' },
                        { ID: 7, Kürzel: 'G', Zeittyp: 'Gleittag' },
                        { ID: 8, Kürzel: 'S', Zeittyp: 'Schule/Weiterbildung' },
                        { ID: 9, Kürzel: 'F', Zeittyp: 'Frei (sonstige)' },
                        { ID: 10, Kürzel: 'SU', Zeittyp: 'Sonderurlaub' }
                    ];
                }

                // Initial populate (all)
                el.cboAbwGrund.innerHTML = '<option value="">-- Grund waehlen --</option>';
                state.gruendeLookup.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g.Kürzel_Datev || g.Kürzel || g.Zeittyp;
                    option.textContent = g.Zeittyp || g.Kürzel;
                    el.cboAbwGrund.appendChild(option);
                });

            } catch (error) {
                console.error('[Abwesenheit] Fehler beim Laden der Gruende:', error);
                // Use fallback
                state.gruendeLookup = [
                    { ID: 5, Kürzel: 'U', Zeittyp: 'Urlaub' },
                    { ID: 6, Kürzel: 'K', Zeittyp: 'Krank' },
                    { ID: 9, Kürzel: 'F', Zeittyp: 'Frei (sonstige)' }
                ];
            }
        }

        /**
         * Lädt Deutsche Feiertage von der API
         */
        async function loadFeiertage(jahr) {
            try {
                const response = await fetch(`http://localhost:5000/api/feiertage?jahr=${jahr}&bundesland=BY`);

                if (response.ok) {
                    const data = await response.json();
                    state.feiertage = (data.data || []).map(f => ({
                        datum: f.datum,
                        name: f.name,
                        bundesland: f.bundesland
                    }));
                    console.log(`[Abwesenheit] ${state.feiertage.length} Feiertage für ${jahr} geladen`);
                } else {
                    state.feiertage = [];
                }
            } catch (error) {
                console.error('[Abwesenheit] Fehler beim Laden der Feiertage:', error);
                state.feiertage = [];
            }
        }

        /**
         * Prüft ob ein Datum ein Feiertag ist
         */
        function isFeiertag(dateStr) {
            // dateStr im Format YYYY-MM-DD
            return state.feiertage.find(f => f.datum === dateStr);
        }

        async function saveAbwesenheit(fz) {
            try {
                const response = await fetch('http://localhost:5000/api/abwesenheiten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        MA_ID: fz.MA_ID,
                        vonDat: formatDateTimeSQL(fz.DatVon),
                        bisDat: formatDateTimeSQL(fz.DatBis),
                        Grund: fz.AbwesenArt,
                        Bemerkung: fz.Bemerk
                    })
                });

                if (!response.ok) {
                    throw new Error('Speichern fehlgeschlagen');
                }
            } catch (error) {
                console.warn('[Abwesenheit] API Save:', error.message);
                // Continue anyway - might be WebView2 mode
            }
        }

        // ============================================
        // RENDERING
        // ============================================

        function renderFehlzeitenTable() {
            if (state.fehlzeiten.length === 0) {
                el.tbody_Fehlzeiten.innerHTML = '<tr><td colspan="7" class="loading-cell">Keine Eintraege - bitte Abwesenheit berechnen</td></tr>';
                el.lblAnzahl.textContent = '0 Eintraege';
                return;
            }

            el.tbody_Fehlzeiten.innerHTML = state.fehlzeiten.map(fz => `
                <tr data-id="${fz.ID}">
                    <td>
                        <input type="checkbox" data-id="${fz.ID}" ${state.selectedRows.has(fz.ID) ? 'checked' : ''}>
                    </td>
                    <td>${fz.ID}</td>
                    <td>${fz.MA_Name}</td>
                    <td>${formatDateTimeDE(fz.DatVon)}</td>
                    <td>${formatDateTimeDE(fz.DatBis)}</td>
                    <td>${fz.AbwesenArt}</td>
                    <td>${fz.Bemerk || ''}</td>
                </tr>
            `).join('');

            // Add checkbox listeners
            el.tbody_Fehlzeiten.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', function() {
                    const id = parseInt(this.dataset.id);
                    if (this.checked) {
                        state.selectedRows.add(id);
                    } else {
                        state.selectedRows.delete(id);
                    }
                });
            });

            // Add row click listeners
            el.tbody_Fehlzeiten.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        const cb = this.querySelector('input[type="checkbox"]');
                        if (cb) {
                            cb.checked = !cb.checked;
                            cb.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });

            el.lblAnzahl.textContent = `${state.fehlzeiten.length} Eintraege`;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function formatDateISO(date) {
            if (!date) return '';
            if (typeof date === 'string') date = new Date(date);
            return date.toISOString().split('T')[0];
        }

        function formatDateDE(date) {
            if (!date) return '';
            if (typeof date === 'string') date = new Date(date);
            return date.toLocaleDateString('de-DE');
        }

        function formatDateTimeDE(date) {
            if (!date) return '';
            if (typeof date === 'string') date = new Date(date);
            const dateStr = date.toLocaleDateString('de-DE');
            const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            return `${dateStr} ${timeStr}`;
        }

        function formatDateTimeSQL(date) {
            if (!date) return '';
            if (typeof date === 'string') date = new Date(date);
            return date.toISOString();
        }

        function updateDatumTags() {
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

            if (el.DatVon.value) {
                const d = new Date(el.DatVon.value);
                let tagText = days[d.getDay()];

                // Prüfe ob Feiertag
                const feiertag = isFeiertag(el.DatVon.value);
                if (feiertag) {
                    tagText += ` 🎉 ${feiertag.name}`;
                    el.lblDatVonTag.style.color = '#d00000';
                    el.lblDatVonTag.style.fontWeight = 'bold';
                } else {
                    el.lblDatVonTag.style.color = '';
                    el.lblDatVonTag.style.fontWeight = '';
                }

                el.lblDatVonTag.textContent = tagText;
            } else {
                el.lblDatVonTag.textContent = '';
            }

            if (el.DatBis.value) {
                const d = new Date(el.DatBis.value);
                let tagText = days[d.getDay()];

                // Prüfe ob Feiertag
                const feiertag = isFeiertag(el.DatBis.value);
                if (feiertag) {
                    tagText += ` 🎉 ${feiertag.name}`;
                    el.lblDatBisTag.style.color = '#d00000';
                    el.lblDatBisTag.style.fontWeight = 'bold';
                } else {
                    el.lblDatBisTag.style.color = '';
                    el.lblDatBisTag.style.fontWeight = '';
                }

                el.lblDatBisTag.textContent = tagText;
            } else {
                el.lblDatBisTag.textContent = '';
            }
        }

        function setStatus(text) {
            el.lblStatus.textContent = text;
        }

        function navigateToForm(formName, recordId) {
            // Verwende shell-detector.js Funktion wenn verfuegbar
            if (typeof window._shellNavigateToForm === 'function') {
                window._shellNavigateToForm(formName, recordId);
            } else if (window.parent && window.parent !== window) {
                // WICHTIG: formName nicht form! Shell erwartet formName
                window.parent.postMessage({ type: 'NAVIGATE', formName: formName, id: recordId }, '*');
            } else {
                var url = formName + '.html';
                if (recordId) url += '?id=' + recordId;
                window.location.href = url;
            }
        }

        // Fullscreen toggle
        function toggleFullscreen() {
            const btn = document.getElementById('fullscreenBtn');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    btn.title = 'Vollbild beenden';
                }).catch(err => console.error('Fullscreen error:', err));
            } else {
                document.exitFullscreen().then(() => {
                    btn.title = 'Vollbild';
                }).catch(err => console.error('Exit fullscreen error:', err));
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreenBtn');
            if (btn) btn.title = document.fullscreenElement ? 'Vollbild beenden' : 'Vollbild';
        });

        // Global access
        window.Abwesenheit = {
            berechnen: btnAbwBerechnen_Click,
            uebernehmen: bznUebernehmen_Click,
            alleLöschen: btnAllLoesch_Click
        };
    </script>

    <!-- Shell-Detector für iframe-Integration -->
    <script src="js/shell-detector.js"></script>
    <!-- WebView2 Bridge für Access-Integration -->
    <script src="js/webview2-bridge.js"></script>
    <!-- API-Server Lifecycle -->
    <script src="js/api-lifecycle.js"></script>
    <!-- Server Watchdog: Prüft API-Server-Verfügbarkeit -->
    <script src="js/server-watchdog.js"></script>
</body>
</html>


