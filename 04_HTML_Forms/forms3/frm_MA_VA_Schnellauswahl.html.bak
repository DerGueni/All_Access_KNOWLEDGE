<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitarbeiter Auswahl - Offene Mail Anfragen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
        }

        body {
            background-color: #8080c0;
            overflow: hidden;
            height: 100vh;
        }

        .window-frame {
            background-color: #8080c0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Title Bar - ausgeblendet gemaess Anforderung */
        .title-bar {
            display: none;
        }

        .title-bar-left {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .title-bar-buttons {
            display: flex;
            gap: 2px;
        }

        .title-btn {
            width: 21px;
            height: 21px;
            background: #ece9d8;
            border: 1px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title-btn.close {
            background: #c75050;
            color: white;
        }

        /* Main Container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left Menu (Sidebar) */
        .left-menu {
            width: 185px;
            background-color: #6060a0;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
        }

        .menu-header {
            background-color: #000080;
            color: white;
            padding: 6px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .menu-btn {
            background: linear-gradient(to bottom, #d0d0e0, #a0a0c0);
            padding: 8px 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            color: #000;
            font-weight: 500;
            position: relative;
            border: none;
            margin: 1px 0;
            overflow: visible;
        }

        /* Obere helle Kante - 4px nach rechts versetzt */
        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: calc(100% - 4px);
            height: 2px;
            background: #ffffff;
            z-index: 1;
        }

        /* Untere dunkle Kante - 4px nach links versetzt */
        .menu-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: calc(100% - 4px);
            height: 2px;
            background: #404070;
            z-index: 1;
        }

        .menu-btn:hover {
            background: linear-gradient(to bottom, #e0e0f0, #b0b0d0);
        }

        .menu-btn:active {
            background: linear-gradient(to bottom, #b0b0d0, #9090b0);
        }

        .menu-btn:active::before {
            background: #404070;
            left: 4px;
            width: calc(100% - 4px);
        }

        .menu-btn:active::after {
            background: #ffffff;
            right: 4px;
            width: calc(100% - 4px);
        }

        .menu-btn.active {
            background: linear-gradient(to bottom, #a0a0d0, #8080b0);
        }

        .menu-btn.active::before {
            background: #505080;
            left: 4px;
            width: calc(100% - 4px);
        }

        .menu-btn.active::after {
            background: #c0c0d8;
            right: 4px;
            width: calc(100% - 4px);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            background-color: #8080c0;
            padding: 3px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        /* Header Row */
        .header-row {
            background-color: #9090c0;
            border: 1px solid #606090;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        /* Form Section */
        .form-section {
            background-color: #b8b8d8;
            border: 1px solid #606090;
            padding: 8px;
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
            border: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 10px;
            white-space: nowrap;
        }

        .btn:hover {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-green {
            background: linear-gradient(to bottom, #60c060, #308030);
            color: white;
        }

        /* Form Elements */
        .form-label {
            font-size: 10px;
            font-weight: bold;
        }

        .form-select, .form-input {
            border: 1px solid #808080;
            padding: 1px 3px;
            font-size: 10px;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #000080;
            box-shadow: 0 0 2px #000080;
        }

        .form-input.readonly {
            background: #e0e0e0;
        }

        /* Filter Row */
        .filter-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
        }

        input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        /* Lists Container */
        .lists-container {
            display: flex;
            gap: 8px;
            flex: 1;
            overflow: hidden;
        }

        .list-panel {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .list-panel.narrow {
            width: 200px;
            flex-shrink: 0;
        }

        .list-panel.wide {
            flex: 1;
            min-width: 300px;
        }

        .list-panel.medium {
            width: 320px;
            flex-shrink: 0;
        }

        .button-column {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 6px;
            width: 70px;
            flex-shrink: 0;
        }

        .grid-wrapper {
            flex: 1;
            overflow: auto;
            border: 1px solid #808080;
            background: white;
        }

        /* Listbox Styles */
        .listbox-header {
            display: flex;
            background-color: #e0e0e0;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            padding: 4px;
            position: sticky;
            top: 0;
        }

        .listbox-row {
            display: flex;
            padding: 3px 4px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .listbox-row:hover {
            background-color: #e8f4fc;
        }

        .listbox-row.selected {
            background-color: #000080;
            color: white;
        }

        .listbox-row.geplant {
            background-color: #fff3cd;
        }

        .listbox-row.zugesagt {
            background-color: #d4edda;
        }

        /* Entfernungs-Farbcodierung */
        .entf-gruen {
            color: #008000;
            font-weight: bold;
        }

        .entf-gelb {
            color: #B8860B;
            font-weight: bold;
        }

        .entf-rot {
            color: #CC0000;
            font-weight: bold;
        }

        .entf-unbekannt {
            color: #808080;
            font-style: italic;
        }

        /* Vollbild-Button oben rechts */
        .fullscreen-btn {
            position: fixed;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: linear-gradient(to bottom, #e8e8e8, #c0c0c0);
            border: 2px solid;
            border-color: #ffffff #606060 #606060 #ffffff;
            cursor: pointer;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #000080;
        }

        .fullscreen-btn:hover {
            background: linear-gradient(to bottom, #f0f0f0, #d0d0d0);
        }

        .fullscreen-btn:active {
            border-color: #606060 #ffffff #ffffff #606060;
        }

    </style>
    <link rel="stylesheet" href="consys-common.css">
    <link rel="stylesheet" href="css/fonts_override.css">
    <script src="js/performance-init.js"></script>
<link rel="stylesheet" href="css/visbug_overrides.css">
</head>
<body>
    <button class="fullscreen-btn tiny-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="Vollbild">â›¶</button>
    <div class="window-frame">
        <!-- Title Bar -->
        <div class="title-bar">
            <div class="title-bar-left">
                <span>Mitarbeiterauswahl - Offene Mail Anfragen</span>
            </div>
            <div class="title-bar-buttons">
                <button class="title-btn tiny-btn" id="btnHilfe" title="Hilfe">?</button>
                <button class="title-btn close tiny-btn" id="btnClose" title="Schließen">Ã—</button>
            </div>
        </div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Left Sidebar -->

            <!-- Content Area -->
            <div class="content-area">
                <!-- Header Row -->
                <div class="header-row">
                    <button class="btn" id="btnAuftrag">Zurück zum Auftrag</button>
                    <button class="btn" id="btnPosListe" style="display: none;">Positionsliste</button>
                    <button class="btn" id="btnZuAbsage" style="display: none;">Manuelles Bearbeiten</button>
                    <span id="lbAuftrag" style="margin-left: auto; font-weight: bold; display: none;">-- Bitte Auftrag wählen --</span>
                    <span id="lbl_Datum" style="margin-left: 10px; font-size: 11px;"></span>
                </div>

                <!-- Form Section -->
                <div class="form-section">
                    <!-- Auftrag Zeile -->
                    <div class="filter-row">
                        <span class="form-label">Auftrag:</span>
                        <select id="VA_ID" class="form-select" style="min-width: 250px;">
                            <option value="">-- Auftrag wählen --</option>
                        </select>
                        <span class="form-label">Datum:</span>
                        <select id="cboVADatum" class="form-select" style="width: 132px;">
                            <option value="">-- Datum --</option>
                        </select>
                        <button class="btn btn-green" id="btnMailSelected">Nur Selektierte anfragen</button>
                        <!-- cboAuftrStatus: Visible=Falsch in Access -->
                        <span class="form-label" style="margin-left: auto; display: none;">Auftragsstatus</span>
                        <select id="cboAuftrStatus" class="form-select" style="width: 50px; display: none;">
                            <option value="">-</option>
                        </select>
                    </div>

                    <!-- Filter Zeile 1 -->
                    <div class="filter-row">
                        <span class="form-label">Mitarbeiter</span>
                        <div class="checkbox-group">
                            <input type="checkbox" id="cbVerplantVerfügbar">
                            <label for="cbVerplantVerfügbar">geplant = verfügbar</label>
                        </div>
                        <button class="btn btn-green" id="btnMail" style="margin-left: auto;">Alle Mitarbeiter anfragen</button>
                        <span class="form-label">Anstellung:</span>
                        <select id="cboAnstArt" class="form-select" style="width: 133px;">
                            <!-- Access Default: 13 (Alle aktiven), Optionen: 3,5,9,11,13 -->
                            <option value="13" selected>Alle aktiven</option>
                            <option value="3">Festangestellt</option>
                            <option value="5">Aushilfe</option>
                            <option value="9">Studenten</option>
                            <option value="11">Praktikanten</option>
                        </select>
                    </div>

                    <!-- Filter Zeile 2 -->
                    <div class="filter-row">
                        <span class="form-label">Gesamt:</span>
                        <input type="text" id="iGes_MA" class="form-input readonly" readonly value="0" style="width: 80px;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="IstVerfügbar">
                            <label for="IstVerfügbar">Nur freie anzeigen</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="IstAktiv" checked>
                            <label for="IstAktiv">Nur aktive anzeigen</label>
                        </div>
                        <span class="form-label" style="margin-left: auto;">Kategorie:</span>
                        <select id="cboQuali" class="form-select" style="width: 133px;">
                            <option value="">Alle</option>
                        </select>
                    </div>

                    <!-- Lists Container -->
                    <div class="lists-container">
                        <!-- Zeiten Liste -->
                        <div class="list-panel narrow">
                            <span class="form-label">Dienstbeginn auswählen:</span>
                            <div class="grid-wrapper">
                                <div class="listbox-header">
                                    <span style="flex: 1;">Ist</span>
                                    <span style="flex: 1;">Soll</span>
                                    <span style="flex: 1;">Beginn</span>
                                    <span style="flex: 1;">Ende</span>
                                </div>
                                <div id="lstZeiten_Body"></div>
                            </div>
                            <span class="form-label">Endzeit:</span>
                            <input type="text" id="DienstEnde" class="form-input readonly" readonly style="width: 67px;">
                            <span class="form-label">Parallele Einsätze:</span>
                            <div class="grid-wrapper" style="height: 150px;">
                                <div id="Lst_Parallel_Einsatz"></div>
                            </div>
                        </div>

                        <!-- MA Liste -->
                        <div class="list-panel wide">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="form-label">Mitarbeiterauswahl durch Doppelklick</span>
                                <div class="checkbox-group" style="margin-left: auto;">
                                    <input type="checkbox" id="cbNur34a">
                                    <label for="cbNur34a">Nur 34a</label>
                                </div>
                                <!-- strSchnellSuche + btnSchnellGo: Visible=Falsch in Access -->
                                <input type="text" id="strSchnellSuche" class="form-input" placeholder="Suche..." style="width: 80px; display: none;">
                                <button class="btn tiny-btn" id="btnSchnellGo" style="background-color: #8B0000; color: white; display: none;">GO</button>
                            </div>
                            <div class="grid-wrapper">
                                <div class="listbox-header">
                                    <span style="flex: 2;">Name</span>
                                    <span style="flex: 1;">Std</span>
                                    <span style="flex: 1;">Beginn</span>
                                    <span style="flex: 1;">Ende</span>
                                    <span style="flex: 1;">Grund</span>
                                    <span id="colEntfernung" style="flex: 1; display: none;">Entf.</span>
                                </div>
                                <div id="List_MA_Body"></div>
                            </div>
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button class="btn" id="cmdListMA_Standard">Standard</button>
                                <button class="btn" id="cmdListMA_Entfernung">Entfernung</button>
                            </div>
                        </div>

                        <!-- Buttons MA &rarr; Plan -->
                        <div class="button-column">
                            <button class="btn tiny-btn" id="btnAddSelected" title="Ausgewählte MA zur Planung hinzufügen">&rarr;</button>
                            <button class="btn tiny-btn" id="btnDelSelected" title="Ausgewählte MA aus Planung entfernen">&larr;</button>
                            <!-- btnDelAll: Visible=Falsch in Access -->
                            <button class="btn tiny-btn" id="btnDelAll" title="Alle aus Planung entfernen" style="display: none;">&times;</button>
                        </div>

                        <!-- Plan Liste -->
                        <div class="list-panel medium">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="form-label">Mitarbeiter geplant:</span>
                                <!-- btnSortPLan: Visible=Falsch in Access -->
                                <button class="btn" id="btnSortPLan" style="margin-left: auto; display: none;">Sortieren</button>
                            </div>
                            <div class="grid-wrapper">
                                <div class="listbox-header">
                                    <span style="width: 30px;">Lfd</span>
                                    <span style="flex: 1;">Nachname</span>
                                    <span style="flex: 1;">Vorname</span>
                                    <span style="width: 50px;">Beginn</span>
                                </div>
                                <div id="lstMA_Plan_Body"></div>
                            </div>
                        </div>

                        <!-- Buttons Plan &rarr; Zusage: Alle Visible=Falsch in Access -->
                        <div class="button-column" style="display: none;">
                            <button class="btn tiny-btn" id="btnAddZusage" title="Zur Zusage verschieben">&rarr;</button>
                            <button class="btn tiny-btn" id="btnMoveZusage" title="Zurück zur Planung">&larr;</button>
                            <button class="btn tiny-btn" id="btnDelZusage" title="Aus Zusage entfernen">&times;</button>
                        </div>

                        <!-- Zusage Liste -->
                        <div class="list-panel medium">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="form-label">Mitarbeiter zugesagt:</span>
                                <!-- btnSortZugeord: Visible=Falsch in Access -->
                                <button class="btn" id="btnSortZugeord" style="margin-left: auto; display: none;">Sortieren</button>
                            </div>
                            <div class="grid-wrapper">
                                <div id="lstMA_Zusage"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WebView2 Bridge für Access-Integration -->
    <script src="js/webview2-bridge.js"></script>

    <!-- Formular-Logik (Modul) -->
    <script type="module" src="logic/frm_MA_VA_Schnellauswahl.logic.js"></script>

    <script>
        // ============================================
        // VBA EVENT SYNCHRONISATION
        // Access VBA Events -> JavaScript Implementierung
        // ============================================

        // State für Form
        const formState = {
            VA_ID: null,
            VADatum_ID: null,
            VAStart_ID: null,
            Objekt_ID: null,
            bEntfernungsModus: false
        };

        // Guard-Flag um Endlosschleife bei dispatchEvent zu vermeiden
        let _isVAOpenLoading = false;

        // ============================================
        // FORM EVENTS (Form_Open, Form_Load, Form_Close)
        // ============================================

        // Form_Open - Initialisierung beim Öffnen
        async function Form_Open() {
            console.log('[VBA] Form_Open');

            // Listen leeren
            const lstZeiten = document.getElementById('lstZeiten_Body');
            const lstMAPlan = document.getElementById('lstMA_Plan_Body');
            const lstMAZusage = document.getElementById('lstMA_Zusage');
            const listMA = document.getElementById('List_MA_Body');

            if (lstZeiten) lstZeiten.innerHTML = '';
            if (lstMAPlan) lstMAPlan.innerHTML = '';
            if (lstMAZusage) lstMAZusage.innerHTML = '';
            if (listMA) listMA.innerHTML = '';

            // Aktuelles Datum anzeigen (lbl_Datum: Visible=Wahr in Access)
            const lblDatum = document.getElementById('lbl_Datum');
            if (lblDatum) {
                const heute = new Date();
                lblDatum.textContent = heute.toLocaleDateString('de-DE', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }

            // OpenArgs auswerten (falls vorhanden via URL-Parameter)
            // Unterstuetzt sowohl va_id als auch id (Shell sendet id)
            const urlParams = new URLSearchParams(window.location.search);
            console.log('[VBA] Form_Open URL:', window.location.href);
            console.log('[VBA] Form_Open search:', window.location.search);
            const vaId = urlParams.get('va_id') || urlParams.get('id');
            const vadatumId = urlParams.get('vadatum_id');
            console.log('[VBA] Form_Open vaId:', vaId, 'vadatumId:', vadatumId);

            if (vaId) {
                // WICHTIG: formState.VA_ID sofort setzen fuer "Zurueck zum Auftrag" Button
                formState.VA_ID = parseInt(vaId);
                // Auftrag automatisch laden
                console.log('[VBA] Form_Open: Auto-Load für VA_ID', vaId);
                await VAOpen(parseInt(vaId), vadatumId ? parseInt(vadatumId) : null);
            }
        }

        // Form_Load - Nach dem Laden
        async function Form_Load() {
            console.log('[VBA] Form_Load');

            // Aufträge-Dropdown laden
            await loadAuftraegeListe();

            // Anstellungsart: Default=13 (Alle aktiven) aus Access übernommen
            // Wird im HTML bereits als selected gesetzt, daher keine Änderung nötig

            // MA-Selektion nur wenn kein Auftrag via URL übergeben wurde
            const urlParams2 = new URLSearchParams(window.location.search);
            if (!urlParams2.get('va_id') && !urlParams2.get('id')) {
                await zf_MA_Selektion();
            }
        }

        // Aufträge-Dropdown laden
        async function loadAuftraegeListe() {
            try {
                const response = await fetch('http://localhost:5000/api/auftraege?limit=100&status=aktiv');
                if (!response.ok) return;

                const result = await response.json();
                if (!result.success || !result.data) return;

                const vaSelect = document.getElementById('VA_ID');
                if (!vaSelect) return;

                vaSelect.innerHTML = '<option value="">-- Auftrag wählen --</option>';

                result.data.forEach(auftrag => {
                    const option = document.createElement('option');
                    option.value = auftrag.VA_ID;
                    option.textContent = `${auftrag.Auftrag || ''} - ${auftrag.Objekt || auftrag.ObjektName || ''}`;
                    vaSelect.appendChild(option);
                });

                // Wenn VA_ID via URL übergeben, im Dropdown setzen
                const urlParams3 = new URLSearchParams(window.location.search);
                const vaIdFromUrl = urlParams3.get('va_id') || urlParams3.get('id');
                if (vaIdFromUrl) {
                    vaSelect.value = vaIdFromUrl;
                }

                console.log('[Form_Load] Aufträge-Dropdown geladen:', result.data.length, 'Einträge');

            } catch (err) {
                console.error('[loadAuftraegeListe] Fehler:', err);
            }
        }

        // Form_Close - Beim Schliessen sortieren
        function Form_Close() {
            console.log('[VBA] Form_Close');

            if (formState.VA_ID && formState.VADatum_ID) {
                // Zuordnung und Planung sortieren
                sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 1);
                sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 2);
            }
        }

        // ============================================
        // VAOpen - Auftrag öffnen (Hauptfunktion)
        // Lädt alle Daten automatisch via REST API
        // ============================================
        async function VAOpen(iVA_ID, iVADatum_ID) {
            console.log('[VBA] VAOpen:', iVA_ID, iVADatum_ID);

            // Guard setzen um Endlosschleife zu vermeiden
            _isVAOpenLoading = true;

            formState.VA_ID = iVA_ID;

            try {
                // 1. Auftragsdaten laden
                console.log('[VAOpen] Lade Auftragsdaten...');
                const auftragData = await loadAuftragData(iVA_ID);

                if (auftragData) {
                    // Label aktualisieren
                    updateAuftragLabelFromData(auftragData);

                    // Auftrag-Dropdown aktualisieren: Option hinzufügen falls nicht vorhanden
                    const vaSelect = document.getElementById('VA_ID');
                    if (vaSelect) {
                        let option = vaSelect.querySelector(`option[value="${iVA_ID}"]`);
                        if (!option) {
                            option = document.createElement('option');
                            option.value = iVA_ID;
                            option.textContent = `${auftragData.Auftrag || ''} - ${auftragData.Objekt || auftragData.ObjektName || ''}`;
                            vaSelect.appendChild(option);
                        }
                        vaSelect.value = iVA_ID;
                        // Change-Event dispatchen um Logic-Datei zu synchronisieren (NACH Option-Erstellung!)
                        vaSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                    // Objekt_ID speichern
                    formState.Objekt_ID = auftragData.Objekt_ID || 0;

                    // Positionsliste-Button anzeigen/verstecken
                    const btnPosListe = document.getElementById('btnPosListe');
                    if (btnPosListe) btnPosListe.style.display = formState.Objekt_ID > 0 ? '' : 'none';
                }

                // 2. Einsatztage laden und Dropdown befüllen
                console.log('[VAOpen] Lade Einsatztage...');
                const einsatztage = await loadEinsatztage(iVA_ID);

                if (einsatztage && einsatztage.length > 0) {
                    // Dropdown befüllen
                    populateEinsatztageDropdown(einsatztage);

                    // VADatum_ID ermitteln: entweder übergeben oder nächstes/erstes Datum
                    let selectedDatumId = iVADatum_ID;

                    if (!selectedDatumId) {
                        // Nächsten Einsatztag ab heute finden
                        const heute = new Date();
                        heute.setHours(0, 0, 0, 0);

                        const naechsterTag = einsatztage.find(tag => {
                            const tagDatum = new Date(tag.VADatum);
                            return tagDatum >= heute;
                        });

                        // API gibt "ID" zurück, nicht "VADatum_ID"
                        selectedDatumId = naechsterTag ? (naechsterTag.ID || naechsterTag.VADatum_ID) : (einsatztage[0].ID || einsatztage[0].VADatum_ID);
                    }

                    formState.VADatum_ID = selectedDatumId;

                    // Dropdown-Wert setzen
                    const cboVADatum = document.getElementById('cboVADatum');
                    if (cboVADatum) {
                        cboVADatum.value = selectedDatumId;
                        // Change-Event dispatchen um Logic-Datei zu synchronisieren
                        cboVADatum.dispatchEvent(new Event('change', { bubbles: true }));
                    }

                    // 3. Schichten für das Datum laden
                    console.log('[VAOpen] Lade Schichten für VADatum_ID:', selectedDatumId);
                    const schichten = await loadSchichten(iVA_ID, selectedDatumId);

                    if (schichten && schichten.length > 0) {
                        populateSchichtenListe(schichten);

                        // Erste Schicht automatisch auswählen
                        formState.VAStart_ID = schichten[0].VAStart_ID;
                        const lstZeiten = document.getElementById('lstZeiten_Body');
                        const ersteZeile = lstZeiten?.querySelector('.listbox-row');
                        if (ersteZeile) {
                            ersteZeile.classList.add('selected');

                            // Dienstende setzen
                            const dienstEnde = document.getElementById('DienstEnde');
                            if (dienstEnde) dienstEnde.value = schichten[0].VA_Ende || '';
                        }
                    }

                    // 4. Mitarbeiter-Liste laden
                    console.log('[VAOpen] Lade Mitarbeiter...');
                    await loadMitarbeiterListe();

                    // 5. Geplante und zugesagte MA laden
                    await loadPlanungUndZusage(iVA_ID, selectedDatumId);

                    // 6. Parallele Einsätze laden
                    await loadParalleleEinsaetzeData(selectedDatumId);
                }

                console.log('[VAOpen] Alle Daten geladen');
                showToast('Auftrag geladen', 'success');

            } catch (err) {
                console.error('[VAOpen] Fehler:', err);
                showToast('Fehler beim Laden: ' + err.message, 'error');
            } finally {
                // Guard zurücksetzen
                _isVAOpenLoading = false;
            }
        }

        // Auftragsdaten via REST API laden
        async function loadAuftragData(vaId) {
            try {
                const response = await fetch(`http://localhost:5000/api/auftraege/${vaId}`);
                if (!response.ok) throw new Error('Auftrag nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    return result.data.auftrag || result.data;
                }
                return null;
            } catch (err) {
                console.error('[loadAuftragData] Fehler:', err);
                return null;
            }
        }

        // Einsatztage via REST API laden
        async function loadEinsatztage(vaId) {
            try {
                const response = await fetch(`http://localhost:5000/api/einsatztage?va_id=${vaId}`);
                if (!response.ok) throw new Error('Einsatztage nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    return result.data;
                }
                return [];
            } catch (err) {
                console.error('[loadEinsatztage] Fehler:', err);
                return [];
            }
        }

        // Schichten via REST API laden
        async function loadSchichten(vaId, vadatumId) {
            try {
                const response = await fetch(`http://localhost:5000/api/auftraege/${vaId}/schichten?vadatum_id=${vadatumId}`);
                if (!response.ok) throw new Error('Schichten nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    return result.data;
                }
                return [];
            } catch (err) {
                console.error('[loadSchichten] Fehler:', err);
                return [];
            }
        }

        // Mitarbeiter-Liste via REST API laden
        async function loadMitarbeiterListe() {
            try {
                // Filter-Werte sammeln
                const istAktiv = document.getElementById('IstAktiv')?.checked !== false;
                const anstArt = document.getElementById('cboAnstArt')?.value || '';

                let url = `http://localhost:5000/api/mitarbeiter?aktiv=${istAktiv}`;
                if (anstArt) url += `&anstellungsart=${anstArt}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Mitarbeiter nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    populateMitarbeiterListe(result.data);

                    // Gesamt-Anzeige aktualisieren
                    const iGesMA = document.getElementById('iGes_MA');
                    if (iGesMA) iGesMA.value = result.data.length;
                }
            } catch (err) {
                console.error('[loadMitarbeiterListe] Fehler:', err);
            }
        }

        // Geplante und zugesagte MA laden
        async function loadPlanungUndZusage(vaId, vadatumId) {
            try {
                // Geplante MA
                const planungResponse = await fetch(`http://localhost:5000/api/planungen?va_id=${vaId}&vadatum_id=${vadatumId}`);
                if (planungResponse.ok) {
                    const planungResult = await planungResponse.json();
                    if (planungResult.success && planungResult.data) {
                        populatePlanungListe(planungResult.data);
                    }
                }

                // Zugesagte MA
                const zusageResponse = await fetch(`http://localhost:5000/api/zuordnungen?va_id=${vaId}&vadatum_id=${vadatumId}`);
                if (zusageResponse.ok) {
                    const zusageResult = await zusageResponse.json();
                    if (zusageResult.success && zusageResult.data) {
                        populateZusageListe(zusageResult.data);
                    }
                }
            } catch (err) {
                console.error('[loadPlanungUndZusage] Fehler:', err);
            }
        }

        // Parallele Einsätze laden
        async function loadParalleleEinsaetzeData(vadatumId) {
            try {
                const response = await fetch(`http://localhost:5000/api/einsatztage?datum_id=${vadatumId}&parallel=true`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        populateParalleleEinsaetze(result.data);
                    }
                }
            } catch (err) {
                console.error('[loadParalleleEinsaetzeData] Fehler:', err);
            }
        }

        // ============================================
        // POPULATE FUNCTIONS - Listen befüllen
        // ============================================

        function populateEinsatztageDropdown(einsatztage) {
            const cboVADatum = document.getElementById('cboVADatum');
            if (!cboVADatum) return;

            cboVADatum.innerHTML = '<option value="">-- Datum --</option>';

            einsatztage.forEach(tag => {
                const option = document.createElement('option');
                // API gibt "ID" zurück, nicht "VADatum_ID"
                option.value = tag.ID || tag.VADatum_ID;

                // Datum formatieren
                const datum = new Date(tag.VADatum);
                const datumStr = datum.toLocaleDateString('de-DE', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                option.textContent = datumStr;
                cboVADatum.appendChild(option);
            });
        }

        function populateSchichtenListe(schichten) {
            const lstZeiten = document.getElementById('lstZeiten_Body');
            if (!lstZeiten) return;

            lstZeiten.innerHTML = '';

            schichten.forEach(schicht => {
                const row = document.createElement('div');
                row.className = 'listbox-row';
                row.dataset.id = schicht.VAStart_ID;
                row.dataset.ende = schicht.VA_Ende || '';

                row.innerHTML = `
                    <span style="flex: 1;">${schicht.MA_Anzahl_Ist || 0}</span>
                    <span style="flex: 1;">${schicht.MA_Anzahl || 0}</span>
                    <span style="flex: 1;">${schicht.VA_Start || ''}</span>
                    <span style="flex: 1;">${schicht.VA_Ende || ''}</span>
                `;

                row.addEventListener('click', function() {
                    lstZeiten.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');
                    lstZeiten_AfterUpdate();
                });

                lstZeiten.appendChild(row);
            });
        }

        function populateMitarbeiterListe(mitarbeiter) {
            const listMA = document.getElementById('List_MA_Body');
            if (!listMA) return;

            listMA.innerHTML = '';

            mitarbeiter.forEach(ma => {
                const row = document.createElement('div');
                row.className = 'listbox-row';
                row.dataset.id = ma.ID || ma.MA_ID;
                row.dataset.maid = ma.ID || ma.MA_ID;
                row.dataset.grund = ma.Grund || '';  // Für Test_selected Prüfung
                row.dataset.issub = ma.IstSub || '0';  // Subunternehmer-Flag
                row.dataset.name = `${ma.Nachname || ''}, ${ma.Vorname || ''}`;

                const name = `${ma.Nachname || ''}, ${ma.Vorname || ''}`;

                row.innerHTML = `
                    <span style="flex: 2;">${name}</span>
                    <span style="flex: 1;">${ma.StdMonat || ''}</span>
                    <span style="flex: 1;">${ma.Beginn || ''}</span>
                    <span style="flex: 1;">${ma.Ende || ''}</span>
                    <span style="flex: 1;">${ma.Grund || ''}</span>
                `;

                // Klick-Handler für Auswahl - WICHTIG: Auch Logic-State aktualisieren!
                row.addEventListener('click', function(e) {
                    const maId = this.dataset.id;
                    if (e.ctrlKey) {
                        // Multi-Select mit STRG
                        const isNowSelected = this.classList.toggle('selected');
                        // Logic-State synchronisieren
                        if (window.SchnellauswahlForm) {
                            if (isNowSelected) {
                                window.SchnellauswahlForm.selectMA(maId);
                            } else {
                                window.SchnellauswahlForm.deselectMA(maId);
                            }
                        }
                    } else {
                        // Einzel-Select: Andere deselektieren
                        listMA.querySelectorAll('.listbox-row').forEach(r => {
                            r.classList.remove('selected');
                            // Logic-State: Alle deselektieren
                            if (window.SchnellauswahlForm) {
                                window.SchnellauswahlForm.deselectMA(r.dataset.id);
                            }
                        });
                        this.classList.add('selected');
                        // Logic-State: Diesen selektieren
                        if (window.SchnellauswahlForm) {
                            window.SchnellauswahlForm.selectMA(maId);
                        }
                    }
                    console.log('[HTML] MA clicked:', maId, 'Selected:', window.SchnellauswahlForm?.getSelected?.() || []);
                });

                // Doppelklick-Handler - ENTFERNT, da List_MA_DblClick auf Body-Ebene bereits existiert
                // (verhindert doppelte Ausfuehrung und nutzt Test_selected Pruefung)

                listMA.appendChild(row);
            });
        }

        function populatePlanungListe(planungen) {
            const lstPlan = document.getElementById('lstMA_Plan_Body');
            if (!lstPlan) return;

            lstPlan.innerHTML = '';

            planungen.forEach((plan, index) => {
                const row = document.createElement('div');
                row.className = 'listbox-row geplant';
                row.dataset.id = plan.MVA_ID || plan.id;
                row.dataset.maid = plan.MA_ID;

                row.innerHTML = `
                    <span style="width: 30px;">${index + 1}</span>
                    <span style="flex: 1;">${plan.Nachname || ''}</span>
                    <span style="flex: 1;">${plan.Vorname || ''}</span>
                    <span style="width: 50px;">${plan.MVA_Start || ''}</span>
                `;

                row.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        this.classList.toggle('selected');
                    } else {
                        lstPlan.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });

                lstPlan.appendChild(row);
            });
        }

        function populateZusageListe(zusagen) {
            const lstZusage = document.getElementById('lstMA_Zusage');
            if (!lstZusage) return;

            lstZusage.innerHTML = '';

            zusagen.forEach(zuo => {
                if (!zuo.MA_ID || zuo.MA_ID === 0) return; // Leere Zuordnungen überspringen

                const row = document.createElement('div');
                row.className = 'listbox-row zugesagt';
                row.dataset.id = zuo.MVA_ID || zuo.id;
                row.dataset.maid = zuo.MA_ID;

                row.innerHTML = `
                    <span style="flex: 1;">${zuo.Nachname || ''}, ${zuo.Vorname || ''}</span>
                    <span style="width: 50px;">${zuo.MVA_Start || ''}</span>
                `;

                row.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        this.classList.toggle('selected');
                    } else {
                        lstZusage.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                        this.classList.add('selected');
                    }
                });

                lstZusage.appendChild(row);
            });
        }

        function populateParalleleEinsaetze(einsaetze) {
            const lstParallel = document.getElementById('Lst_Parallel_Einsatz');
            if (!lstParallel) return;

            lstParallel.innerHTML = '';

            einsaetze.forEach(einsatz => {
                // Aktuellen Auftrag überspringen
                if (einsatz.VA_ID === formState.VA_ID) return;

                const row = document.createElement('div');
                row.className = 'listbox-row';
                row.dataset.vaid = einsatz.VA_ID;
                row.dataset.vadatumid = einsatz.VADatum_ID;

                row.innerHTML = `<span>${einsatz.Auftrag || ''} - ${einsatz.Objekt || ''}</span>`;

                lstParallel.appendChild(row);
            });
        }

        function updateAuftragLabelFromData(auftragData) {
            const label = document.getElementById('lbAuftrag');
            if (!label) return;

            const parts = [
                auftragData.Auftrag || '',
                auftragData.Objekt || auftragData.ObjektName || '',
                auftragData.Ort || auftragData.ob_Ort || ''
            ].filter(Boolean);

            label.textContent = parts.join(' - ') || '-- Auftrag geladen --';
        }

        // Legacy-Funktion für Kompatibilität
        function updateAuftragLabel(vaId, vadatumId) {
            loadAuftragData(vaId).then(data => {
                if (data) updateAuftragLabelFromData(data);
            });
        }

        // ============================================
        // BUTTON CLICK EVENTS
        // ============================================

        // btnAuftrag_Click - Zurück zum Auftragstamm
        function btnAuftrag_Click() {
            // VA_ID aus formState oder URL holen (Fallback bei Caching-Problemen)
            let vaId = formState.VA_ID;
            if (!vaId) {
                const urlParams = new URLSearchParams(window.location.search);
                vaId = urlParams.get('va_id') || urlParams.get('id');
                if (vaId) vaId = parseInt(vaId);
            }
            console.log('[VBA] btnAuftrag_Click, VA_ID =', vaId);

            if (!vaId) {
                navigateToForm('frm_va_Auftragstamm');
            } else {
                navigateToForm('frm_va_Auftragstamm', vaId);
            }
        }

        // btnPosListe_Click - Positionsliste öffnen
        function btnPosListe_Click() {
            console.log('[VBA] btnPosListe_Click');

            if (formState.Objekt_ID > 0) {
                if (window.Bridge) {
                    Bridge.sendEvent('openForm', {
                        form: 'frmTop_VA_Akt_Objekt_Kopf',
                        va_id: formState.VA_ID,
                        vadatum_id: formState.VADatum_ID,
                        objekt_id: formState.Objekt_ID
                    });
                } else {
                    alert('Positionsliste - nur in Access verfügbar');
                }
            }
        }

        // btnZuAbsage_Click - Manuelles Bearbeiten
        function btnZuAbsage_Click() {
            console.log('[VBA] btnZuAbsage_Click');

            if (window.Bridge) {
                Bridge.sendEvent('openForm', { form: 'frmTop_MA_ZuAbsage' });
            } else {
                alert('Zu-/Absage-Formular - nur in Access verfügbar');
            }
        }

        /**
         * Test_selected - Prüft ob MA bereits verplant ist (Doppelbelegungs-Warnung)
         * Entspricht VBA: Private Function Test_selected(var) As Boolean
         * @param {HTMLElement} row - Die angeklickte Zeile
         * @returns {boolean} true = darf verplant werden, false = abgebrochen
         */
        function Test_selected(row) {
            if (!row || !row.classList.contains('selected')) {
                return true; // Nicht selektiert = kein Problem
            }

            const grund = row.dataset.grund || '';
            const isSub = row.dataset.issub === '1' || row.dataset.issub === 'true';
            const maName = row.dataset.name || 'Mitarbeiter';

            // Prüfen ob bereits verplant (Grund-Spalte hat Inhalt)
            const istBereitsVerplant = grund.trim().length > 0;

            if (istBereitsVerplant && !isSub) {
                // Warnung anzeigen - wie im VBA
                const result = confirm(`Mitarbeiter ${maName} ist nicht verfügbar (${grund}), dennoch verplanen?`);
                if (!result) {
                    console.log('[Test_selected] Verplanung abgebrochen für:', maName);
                    return false;
                }
            }

            return true;
        }

        // btnAddSelected_Click - Ausgewaehlte MA zur Planung
        function btnAddSelected_Click() {
            console.log('[VBA] btnAddSelected_Click');

            const listMA = document.getElementById('List_MA_Body');
            const selected = listMA?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) {
                alert('Bitte Mitarbeiter auswählen');
                return;
            }

            selected.forEach(row => {
                // Test_selected Prüfung (Doppelbelegung)
                if (!Test_selected(row)) {
                    return; // Dieser MA wird übersprungen
                }

                const maId = row.dataset.id;
                if (maId) {
                    addMAToPlanung(parseInt(maId));
                }
            });

            // Listen aktualisieren
            refreshPlanungListe();
            zf_MA_Selektion();
        }

        async function addMAToPlanung(maId) {
            const planungData = {
                ma_id: maId,
                va_id: formState.VA_ID,
                vadatum_id: formState.VADatum_ID,
                vastart_id: formState.VAStart_ID,
                status_id: 1 // Geplant
            };

            // Immer REST-API im Browser-Modus (auch wenn Bridge existiert)
            try {
                const response = await fetch('http://localhost:5000/api/planungen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(planungData)
                });
                if (response.ok) {
                    const result = await response.json();
                    console.log('[addMAToPlanung] Erfolgreich, ID:', result.id);
                    // Planungsliste aktualisieren
                    await refreshPlanungListe();
                } else {
                    console.error('[addMAToPlanung] API-Fehler:', response.status);
                }
            } catch (err) {
                console.error('[addMAToPlanung] Fehler:', err);
            }
        }

        // btnDelSelected_Click - Aus Planung entfernen
        function btnDelSelected_Click() {
            console.log('[VBA] btnDelSelected_Click');

            const lstPlan = document.getElementById('lstMA_Plan_Body');
            const selected = lstPlan?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) {
                alert('Bitte Mitarbeiter aus Planung auswählen');
                return;
            }

            selected.forEach(row => {
                const planId = row.dataset.id;
                if (planId && window.Bridge) {
                    Bridge.sendEvent('delete', {
                        type: 'planung',
                        id: planId
                    });
                }
            });

            refreshPlanungListe();
            zf_MA_Selektion();
        }

        // btnDelAll_Click - Alle aus Planung entfernen
        function btnDelAll_Click() {
            console.log('[VBA] btnDelAll_Click');

            if (!confirm('Alle verplanten Mitarbeiter von der Planung entfernen?')) {
                return;
            }

            if (window.Bridge) {
                Bridge.sendEvent('delete', {
                    type: 'planung_all',
                    va_id: formState.VA_ID,
                    vadatum_id: formState.VADatum_ID
                });
            }

            refreshPlanungListe();
            zf_MA_Selektion();
        }

        // btnAddZusage_Click - Von Planung zur Zusage
        function btnAddZusage_Click() {
            console.log('[VBA] btnAddZusage_Click');

            const lstPlan = document.getElementById('lstMA_Plan_Body');
            const selected = lstPlan?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) return;

            selected.forEach(row => {
                const planId = row.dataset.id;
                const maId = row.dataset.maid;

                if (planId && maId && window.Bridge) {
                    Bridge.sendEvent('zuordnung_erstellen', {
                        ma_id: parseInt(maId),
                        va_id: formState.VA_ID,
                        vadatum_id: formState.VADatum_ID,
                        vastart_id: formState.VAStart_ID,
                        planung_id: parseInt(planId) // Wird dann aus Planung gelöscht
                    });
                }
            });

            refreshPlanungListe();
            refreshZusageListe();
            updateSollPlanIst();
        }

        // btnMoveZusage_Click - Zurück zur Planung
        function btnMoveZusage_Click() {
            console.log('[VBA] btnMoveZusage_Click');

            const lstZusage = document.getElementById('lstMA_Zusage');
            const selected = lstZusage?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) return;

            selected.forEach(row => {
                const zuoId = row.dataset.id;
                const maId = row.dataset.maid;

                if (zuoId && maId && window.Bridge) {
                    // MA aus Zuordnung entfernen und zur Planung hinzufügen
                    Bridge.sendEvent('zuordnung_to_planung', {
                        zuordnung_id: parseInt(zuoId),
                        ma_id: parseInt(maId),
                        va_id: formState.VA_ID,
                        vadatum_id: formState.VADatum_ID,
                        vastart_id: formState.VAStart_ID
                    });
                }
            });

            refreshPlanungListe();
            refreshZusageListe();
            updateSollPlanIst();
        }

        // btnDelZusage_Click - Aus Zusage entfernen
        function btnDelZusage_Click() {
            console.log('[VBA] btnDelZusage_Click');

            if (!confirm('Zusagen entfernen - sind Sie sicher?')) {
                return;
            }

            const lstZusage = document.getElementById('lstMA_Zusage');
            const selected = lstZusage?.querySelectorAll('.listbox-row.selected');

            if (!selected || selected.length === 0) return;

            selected.forEach(row => {
                const zuoId = row.dataset.id;
                if (zuoId && window.Bridge) {
                    // MA_ID auf 0 setzen (nicht löschen)
                    Bridge.sendEvent('zuordnung_clear', {
                        zuordnung_id: parseInt(zuoId)
                    });
                }
            });

            refreshZusageListe();
            updateSollPlanIst();
        }

        // btnSortPlan_Click - Planung sortieren
        function btnSortPlan_Click() {
            console.log('[VBA] btnSortPlan_Click');
            sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 2);
            refreshPlanungListe();
        }

        // btnSortZugeord_Click - Zuordnung sortieren
        function btnSortZugeord_Click() {
            console.log('[VBA] btnSortZugeord_Click');
            sort_zuo_plan(formState.VA_ID, formState.VADatum_ID, 1);
            refreshZusageListe();
        }

        // Sort-Funktion (ruft VBA auf)
        function sort_zuo_plan(vaId, vadatumId, tbl) {
            if (window.Bridge) {
                Bridge.sendEvent('sort_zuo_plan', {
                    va_id: vaId,
                    vadatum_id: vadatumId,
                    tbl: tbl // 1=Zuordnung, 2=Planung
                });
            }
        }

        // ============================================
        // MAIL ANFRAGEN (btnMail, btnMailSelected)
        // ============================================

        // btnMail_Click - Alle Mitarbeiter anfragen
        function btnMail_Click() {
            console.log('[VBA] btnMail_Click - Alle anfragen');
            show_requestlog(false);
        }

        // btnMailSelected_Click - Nur selektierte anfragen
        function btnMailSelected_Click() {
            console.log('[VBA] btnMailSelected_Click - Selektierte anfragen');
            show_requestlog(true);
        }

        // Anfrage-Log anzeigen und Anfragen versenden
        async function show_requestlog(selectedOnly) {
            if (!formState.VA_ID || !formState.VADatum_ID) {
                alert('Bitte Auftrag und Datum wählen');
                return;
            }

            const lstPlan = document.getElementById('lstMA_Plan_Body');
            const rows = selectedOnly
                ? lstPlan?.querySelectorAll('.listbox-row.selected')
                : lstPlan?.querySelectorAll('.listbox-row');

            if (!rows || rows.length === 0) {
                alert('Keine Mitarbeiter zum Anfragen vorhanden');
                return;
            }

            const maIds = Array.from(rows).map(r => parseInt(r.dataset.maid)).filter(Boolean);

            if (!confirm(`${maIds.length} Mitarbeiter anfragen?`)) return;

            // WebView2-Modus: Anfragen erstellen + WhatsApp via API senden
            if (window.chrome && window.chrome.webview && window.Bridge) {
                // Zuerst Anfragen erstellen via Bridge
                Bridge.sendEvent('anfragen_erstellen', {
                    ma_ids: maIds,
                    va_id: formState.VA_ID,
                    vadatum_id: formState.VADatum_ID,
                    vastart_id: formState.VAStart_ID
                });

                showToast(`${maIds.length} Anfragen erstellt...`, 'success');

                // Dann WhatsApp via REST API senden
                try {
                    const waResponse = await fetch('http://localhost:5000/api/whatsapp/anfragen', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            va_id: formState.VA_ID,
                            ma_ids: maIds
                        })
                    });
                    const waResult = await waResponse.json();
                    if (waResult.success && waResult.sent > 0) {
                        showToast(`${waResult.sent} WhatsApp-Nachrichten gesendet`, 'success');
                    }
                } catch (waErr) {
                    console.warn('WhatsApp-Versand:', waErr);
                }

                // Nach Anfrage zum Auftragstamm wechseln (wie VBA)
                setTimeout(() => {
                    navigateToForm('frm_va_Auftragstamm', formState.VA_ID);
                }, 1000);
            } else {
                // Browser-Modus: REST API verwenden
                try {
                    showToast('Erstelle Anfragen...', 'info');

                    const response = await fetch('http://localhost:5000/api/anfragen/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ma_ids: maIds,
                            va_id: formState.VA_ID,
                            vadatum_id: formState.VADatum_ID,
                            vastart_id: formState.VAStart_ID
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showToast(`${result.created} Anfragen erstellt`, 'success');

                        // WhatsApp-Benachrichtigungen senden
                        try {
                            const waResponse = await fetch('http://localhost:5000/api/whatsapp/anfragen', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    va_id: formState.VA_ID,
                                    ma_ids: maIds
                                })
                            });

                            const waResult = await waResponse.json();

                            if (waResult.success) {
                                if (waResult.sent > 0) {
                                    showToast(`${waResult.sent} WhatsApp-Nachrichten gesendet`, 'success');
                                } else if (waResult.errors && waResult.errors.length > 0) {
                                    // API nicht konfiguriert oder Fehler
                                    const errorMsg = waResult.errors[0]?.error || 'WhatsApp nicht konfiguriert';
                                    console.warn('WhatsApp-Versand:', errorMsg);

                                    // Fallback: E-Mail anbieten
                                    if (result.ma_data && result.ma_data.length > 0) {
                                        const emails = result.ma_data.filter(m => m.eMail).map(m => m.eMail);
                                        if (emails.length > 0 && confirm('WhatsApp nicht verfügbar. Per E-Mail senden?')) {
                                            const auftragInfo = await getAuftragInfo(formState.VA_ID);
                                            const subject = encodeURIComponent(
                                                `Einsatzanfrage: ${auftragInfo?.Auftrag || 'Auftrag'} am ${formatDate(auftragInfo?.VADatum)}`
                                            );
                                            const body = encodeURIComponent(
                                                `Hallo,\n\nDu hast neue Nachrichten in Deiner Consec App.\n\n` +
                                                `Öffne die App, um Deine Einsatzanfragen zu sehen:\n` +
                                                `https://webapp.consec-security.selfhost.eu/index.php?page=dashboard\n\n` +
                                                `Mit freundlichen Grüßen\nCONSEC Auftragsplanung`
                                            );
                                            window.open(`mailto:${emails.join(',')}?subject=${subject}&body=${body}`);
                                        }
                                    }
                                }
                            } else {
                                console.error('WhatsApp-Fehler:', waResult.error);
                            }
                        } catch (waErr) {
                            console.warn('WhatsApp-Versand nicht möglich:', waErr);
                        }

                        // Listen aktualisieren
                        refreshPlanungListe();
                        zf_MA_Selektion();

                    } else {
                        showToast('Fehler: ' + result.error, 'error');
                    }
                } catch (err) {
                    console.error('Anfragen-Fehler:', err);
                    showToast('Fehler beim Erstellen der Anfragen', 'error');
                }
            }
        }

        // Hilfsfunktion: Auftragsdaten laden
        async function getAuftragInfo(vaId) {
            try {
                const response = await fetch(`http://localhost:5000/api/auftraege/${vaId}`);
                const result = await response.json();
                return result.success ? result.data.auftrag : null;
            } catch (err) {
                console.error('Fehler beim Laden der Auftragsdaten:', err);
                return null;
            }
        }

        // Hilfsfunktion: Datum formatieren
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('de-DE');
        }

        // ============================================
        // FILTER / AFTERUPDATE EVENTS
        // ============================================

        // cboVADatum_AfterUpdate
        async function cboVADatum_AfterUpdate() {
            console.log('[VBA] cboVADatum_AfterUpdate');

            const cboVADatum = document.getElementById('cboVADatum');
            formState.VADatum_ID = cboVADatum?.value;

            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                // Schichten laden via REST API
                console.log('[cboVADatum_AfterUpdate] Lade Schichten...');
                const schichten = await loadSchichten(formState.VA_ID, formState.VADatum_ID);

                if (schichten && schichten.length > 0) {
                    populateSchichtenListe(schichten);

                    // Erste Schicht automatisch auswählen
                    formState.VAStart_ID = schichten[0].VAStart_ID;
                    const lstZeiten = document.getElementById('lstZeiten_Body');
                    const ersteZeile = lstZeiten?.querySelector('.listbox-row');
                    if (ersteZeile) {
                        ersteZeile.classList.add('selected');

                        // Dienstende setzen
                        const dienstEnde = document.getElementById('DienstEnde');
                        if (dienstEnde) dienstEnde.value = schichten[0].VA_Ende || '';
                    }
                }

                // Geplante und zugesagte MA laden
                await loadPlanungUndZusage(formState.VA_ID, formState.VADatum_ID);

                // Parallele Einsätze laden
                await loadParalleleEinsaetzeData(formState.VADatum_ID);

                // Mitarbeiter-Liste neu laden
                await loadMitarbeiterListe();

            } catch (err) {
                console.error('[cboVADatum_AfterUpdate] Fehler:', err);
            }
        }

        // lstZeiten_AfterUpdate - Schicht ausgewaehlt
        function lstZeiten_AfterUpdate() {
            console.log('[VBA] lstZeiten_AfterUpdate');

            const lstZeiten = document.getElementById('lstZeiten_Body');
            const selected = lstZeiten?.querySelector('.listbox-row.selected');

            if (selected) {
                formState.VAStart_ID = selected.dataset.id;

                // Dienstende setzen
                const dienstEnde = document.getElementById('DienstEnde');
                const ende = selected.dataset.ende;
                if (dienstEnde && ende) {
                    dienstEnde.value = ende;
                }
            }

            // Vergleichszeiten aktualisieren und MA-Liste neu laden
            zf_MA_Selektion();
        }

        // cboAnstArt_AfterUpdate - Anstellungsart Filter
        function cboAnstArt_AfterUpdate() {
            console.log('[VBA] cboAnstArt_AfterUpdate');
            zf_MA_Selektion();
        }

        // cboQuali_AfterUpdate - Kategorie Filter
        function cboQuali_AfterUpdate() {
            console.log('[VBA] cboQuali_AfterUpdate');
            zf_MA_Selektion();
        }

        // IstVerfügbar_AfterUpdate - Nur freie Filter
        function IstVerfügbar_AfterUpdate() {
            console.log('[VBA] IstVerfügbar_AfterUpdate');
            const chk = document.getElementById('IstVerfügbar');
            const lbl = document.getElementById('lbl_NurFreie');
            if (lbl) {
                lbl.textContent = chk?.checked ? 'Nur freie anzeigen' : 'Alle anzeigen';
            }
            zf_MA_Selektion();
        }

        // IstAktiv_AfterUpdate - Nur aktive Filter
        function IstAktiv_AfterUpdate() {
            console.log('[VBA] IstAktiv_AfterUpdate');
            const chk = document.getElementById('IstAktiv');
            const lbl = document.getElementById('lbl_IstAktiv');
            if (lbl) {
                lbl.textContent = chk?.checked ? 'Nur aktive MA' : 'Alle anzeigen';
            }
            zf_MA_Selektion();
        }

        // cbVerplantVerfügbar_AfterUpdate
        function cbVerplantVerfügbar_AfterUpdate() {
            console.log('[VBA] cbVerplantVerfügbar_AfterUpdate');
            const chk = document.getElementById('cbVerplantVerfügbar');
            const lbl = document.getElementById('lbl_VerplantVerfügbar');
            if (lbl) {
                lbl.textContent = chk?.checked ? 'geplant = verfügbar' : 'geplant = nicht verfügbar';
            }
            zf_MA_Selektion();
        }

        // cbNur34a_AfterUpdate
        function cbNur34a_AfterUpdate() {
            console.log('[VBA] cbNur34a_AfterUpdate');
            zf_MA_Selektion();
        }

        // ============================================
        // zf_MA_Selektion - Mitarbeiter-Liste aktualisieren
        // ============================================
        async function zf_MA_Selektion() {
            console.log('[VBA] zf_MA_Selektion');

            // Filter-Werte sammeln
            const istAktiv = document.getElementById('IstAktiv')?.checked !== false;
            const anstArt = document.getElementById('cboAnstArt')?.value || '';

            try {
                // REST API aufrufen
                let url = `http://localhost:5000/api/mitarbeiter?aktiv=${istAktiv}`;
                if (anstArt) url += `&anstellungsart=${anstArt}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Mitarbeiter nicht gefunden');

                const result = await response.json();
                if (result.success && result.data) {
                    populateMitarbeiterListe(result.data);

                    // Gesamt-Anzeige aktualisieren
                    const iGesMA = document.getElementById('iGes_MA');
                    if (iGesMA) iGesMA.value = result.data.length;
                }
            } catch (err) {
                console.error('[zf_MA_Selektion] Fehler:', err);
            }
        }

        // ============================================
        // cmdListMA_Standard / cmdListMA_Entfernung
        // ============================================

        // Standard-Ansicht
        function cmdListMA_Standard_Click() {
            console.log('[VBA] cmdListMA_Standard_Click');
            formState.bEntfernungsModus = false;

            // Entfernungs-Spalte ausblenden
            const colEntf = document.getElementById('colEntfernung');
            if (colEntf) colEntf.style.display = 'none';

            // Entfernungs-Spans aus Zeilen entfernen
            const listMA = document.getElementById('List_MA_Body');
            if (listMA) {
                listMA.querySelectorAll('.ma-entfernung').forEach(el => el.remove());
            }

            zf_MA_Selektion();
        }

        // Entfernungs-Ansicht
        function cmdListMA_Entfernung_Click() {
            console.log('[VBA] cmdListMA_Entfernung_Click');

            if (!formState.Objekt_ID || formState.Objekt_ID === 0) {
                alert('Kein Objekt fuer diesen Auftrag hinterlegt!');
                return;
            }

            formState.bEntfernungsModus = true;

            // Entfernungs-Spalte anzeigen
            const colEntf = document.getElementById('colEntfernung');
            if (colEntf) colEntf.style.display = '';

            // Entfernungen berechnen
            berechneEntfernungen();
        }

        // ============================================
        // GEO/ENTFERNUNG FEATURE
        // ============================================

        /**
         * Haversine-Formel zur Berechnung der Luftlinie zwischen zwei Koordinaten
         * Mit Null-Check wie im VBA Original (mdl_GeoDistanz.bas)
         * @param {number} lat1 - Breitengrad Punkt 1
         * @param {number} lng1 - Laengengrad Punkt 1
         * @param {number} lat2 - Breitengrad Punkt 2
         * @param {number} lng2 - Laengengrad Punkt 2
         * @returns {number} Distanz in Kilometern (9999 bei fehlenden Koordinaten)
         */
        function haversineDistance(lat1, lng1, lat2, lng2) {
            // Null-Check wie im VBA: If Lat1 = 0 Or Lon1 = 0 Or Lat2 = 0 Or Lon2 = 0 Then DistanceKm = 9999
            if (!lat1 || !lng1 || !lat2 || !lng2 || lat1 === 0 || lng1 === 0 || lat2 === 0 || lng2 === 0) {
                return 9999;
            }

            const R = 6371; // Erdradius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            // Auf 1 Dezimalstelle runden wie im VBA: Round(EARTH_RADIUS_KM * c, 1)
            return Math.round(R * c * 10) / 10;
        }

        /**
         * Objekt-Koordinaten laden
         * @param {number} objektId - ID des Objekts
         * @returns {Promise<{lat: number, lng: number}|null>}
         */
        async function getObjektKoordinaten(objektId) {
            console.log('[GEO] Lade Objekt-Koordinaten fuer ID:', objektId);

            try {
                // WebView2 Modus: via Bridge
                if (window.Bridge && window.Bridge.loadData) {
                    return new Promise((resolve) => {
                        Bridge.execute('executeSQL', {
                            sql: `SELECT Geo_Lat, Geo_Lng, ob_Strasse, ob_PLZ, ob_Ort
                                  FROM tbl_OB_Objektstamm
                                  WHERE Objekt_ID = ${objektId}`
                        }).then(result => {
                            if (result && result.length > 0) {
                                const obj = result[0];
                                if (obj.Geo_Lat && obj.Geo_Lng) {
                                    resolve({ lat: parseFloat(obj.Geo_Lat), lng: parseFloat(obj.Geo_Lng) });
                                } else {
                                    // Keine Koordinaten, versuche Geocoding
                                    geocodeAdresse(obj.ob_Strasse, obj.ob_PLZ, obj.ob_Ort).then(resolve);
                                }
                            } else {
                                resolve(null);
                            }
                        }).catch(() => resolve(null));
                    });
                }

                // Browser Modus: via REST API
                const response = await fetch(`http://localhost:5000/api/objekte/${objektId}`);
                if (!response.ok) return null;

                const data = await response.json();
                if (data.success && data.data) {
                    const obj = data.data;
                    if (obj.Geo_Lat && obj.Geo_Lng) {
                        return { lat: parseFloat(obj.Geo_Lat), lng: parseFloat(obj.Geo_Lng) };
                    }
                    // Keine Koordinaten, versuche Geocoding
                    return await geocodeAdresse(obj.ob_Strasse, obj.ob_PLZ, obj.ob_Ort);
                }
                return null;
            } catch (err) {
                console.error('[GEO] Fehler beim Laden der Objekt-Koordinaten:', err);
                return null;
            }
        }

        /**
         * Geocodierung einer Adresse via OpenStreetMap Nominatim API
         * @param {string} strasse - Strassenname mit Hausnummer
         * @param {string} plz - Postleitzahl
         * @param {string} ort - Ortsname
         * @returns {Promise<{lat: number, lng: number}|null>}
         */
        async function geocodeAdresse(strasse, plz, ort) {
            if (!strasse && !plz && !ort) return null;

            const query = [strasse, plz, ort].filter(Boolean).join(', ') + ', Deutschland';
            console.log('[GEO] Geocoding Adresse:', query);

            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`;
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'CONSEC-Planung/1.0'
                    }
                });

                if (!response.ok) return null;

                const results = await response.json();
                if (results && results.length > 0) {
                    return {
                        lat: parseFloat(results[0].lat),
                        lng: parseFloat(results[0].lon)
                    };
                }
                return null;
            } catch (err) {
                console.error('[GEO] Geocoding-Fehler:', err);
                return null;
            }
        }

        /**
         * Entfernungs-CSS-Klasse basierend auf Distanz
         * @param {number} distanzKm - Distanz in km
         * @returns {string} CSS-Klassenname
         */
        function getEntfernungsKlasse(distanzKm) {
            if (distanzKm === null || distanzKm === undefined || isNaN(distanzKm)) {
                return 'entf-unbekannt';
            }
            if (distanzKm < 10) return 'entf-gruen';
            if (distanzKm <= 30) return 'entf-gelb';
            return 'entf-rot';
        }

        /**
         * Formatiert die Entfernung fuer die Anzeige
         * @param {number} distanzKm - Distanz in km
         * @returns {string} Formatierter String
         */
        function formatEntfernung(distanzKm) {
            if (distanzKm === null || distanzKm === undefined || isNaN(distanzKm)) {
                return '?';
            }
            return distanzKm.toFixed(1) + ' km';
        }

        /**
         * Hauptfunktion: Berechnet Entfernungen fuer alle MA in der Liste
         * Nutzt vorberechnete Entfernungen aus tbl_MA_Objekt_Entfernung falls verfuegbar
         */
        async function berechneEntfernungen() {
            console.log('[GEO] berechneEntfernungen gestartet');

            const listMA = document.getElementById('List_MA_Body');
            if (!listMA) {
                console.warn('[GEO] List_MA_Body nicht gefunden');
                return;
            }

            showToast('Lade Entfernungsdaten...', 'info');

            // 1. Versuche vorberechnete Entfernungen zu laden (aus tbl_MA_Objekt_Entfernung)
            let vorberechneteEntfernungen = new Map();
            let objektKoords = null;

            try {
                // API-Endpoint fuer vorberechnete Entfernungen
                const response = await fetch(`http://localhost:5000/api/mitarbeiter/entfernungen?objekt_id=${formState.Objekt_ID}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data && data.data.length > 0) {
                        console.log('[GEO] Vorberechnete Entfernungen gefunden:', data.data.length);
                        data.data.forEach(item => {
                            vorberechneteEntfernungen.set(item.MA_ID, item.Entfernung_km);
                        });
                    }
                }
            } catch (err) {
                console.log('[GEO] Keine vorberechneten Entfernungen verfuegbar:', err);
            }

            // 2. Falls keine vorberechneten Daten: Objekt-Koordinaten laden fuer Live-Berechnung
            if (vorberechneteEntfernungen.size === 0) {
                objektKoords = await getObjektKoordinaten(formState.Objekt_ID);
                if (!objektKoords) {
                    alert('Objekt-Koordinaten konnten nicht ermittelt werden.\nBitte Adresse im Objektstamm pruefen.');
                    return;
                }
                console.log('[GEO] Objekt-Koordinaten:', objektKoords);
            }

            // 3. MA-Liste mit Geo-Daten laden (nur wenn Live-Berechnung noetig)
            let maKoordinaten = new Map();

            if (vorberechneteEntfernungen.size === 0) {
                let maListe = [];
                try {
                    if (window.Bridge && window.Bridge.execute) {
                        // WebView2 Modus
                        maListe = await Bridge.execute('executeSQL', {
                            sql: `SELECT MA_ID, Vorname, Nachname, Strasse, PLZ, Ort, Geo_Lat, Geo_Lng
                                  FROM tbl_MA_Mitarbeiterstamm
                                  WHERE IstAktiv = True`
                        });
                    } else {
                        // Browser Modus: via REST API
                        const response = await fetch('http://localhost:5000/api/mitarbeiter?fields=MA_ID,Vorname,Nachname,Strasse,PLZ,Ort,Geo_Lat,Geo_Lng');
                        const data = await response.json();
                        if (data.success) {
                            maListe = data.data || [];
                        }
                    }
                } catch (err) {
                    console.error('[GEO] Fehler beim Laden der MA-Daten:', err);
                }

                // MA-Koordinaten Map erstellen
                for (const ma of maListe) {
                    if (ma.Geo_Lat && ma.Geo_Lng) {
                        maKoordinaten.set(ma.MA_ID, {
                            lat: parseFloat(ma.Geo_Lat),
                            lng: parseFloat(ma.Geo_Lng)
                        });
                    } else if (ma.Strasse || ma.PLZ || ma.Ort) {
                        // Geocoding fuer MA ohne Koordinaten (mit Rate-Limiting)
                        // Nominatim erlaubt max 1 Request/Sekunde
                        // In Produktion: Koordinaten in DB cachen!
                        const coords = await geocodeAdresse(ma.Strasse, ma.PLZ, ma.Ort);
                        if (coords) {
                            maKoordinaten.set(ma.MA_ID, coords);
                        }
                        // Rate-Limiting: 1 Sekunde Pause zwischen Geocoding-Anfragen
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            // 4. Entfernungen berechnen und in Liste anzeigen
            const rows = listMA.querySelectorAll('.listbox-row');
            const entfernungsDaten = [];

            rows.forEach(row => {
                const maId = parseInt(row.dataset.id || row.dataset.maid);
                if (!maId) return;

                let entfernung = null;

                // Zuerst vorberechnete Entfernung pruefen
                if (vorberechneteEntfernungen.has(maId)) {
                    entfernung = vorberechneteEntfernungen.get(maId);
                } else if (objektKoords) {
                    // Falls nicht vorberechnet: Live berechnen
                    const maKoords = maKoordinaten.get(maId);
                    if (maKoords) {
                        entfernung = haversineDistance(
                            maKoords.lat, maKoords.lng,
                            objektKoords.lat, objektKoords.lng
                        );
                    }
                }

                // Entfernungs-Span hinzufuegen oder aktualisieren
                let entfSpan = row.querySelector('.ma-entfernung');
                if (!entfSpan) {
                    entfSpan = document.createElement('span');
                    entfSpan.className = 'ma-entfernung';
                    entfSpan.style.flex = '1';
                    row.appendChild(entfSpan);
                }

                entfSpan.textContent = formatEntfernung(entfernung);
                entfSpan.className = 'ma-entfernung ' + getEntfernungsKlasse(entfernung);

                // Fuer Sortierung speichern
                entfernungsDaten.push({
                    row: row,
                    entfernung: entfernung !== null && entfernung < 9999 ? entfernung : 99999
                });
            });

            // 5. Liste nach Entfernung sortieren
            entfernungsDaten.sort((a, b) => a.entfernung - b.entfernung);
            entfernungsDaten.forEach(item => {
                listMA.appendChild(item.row);
            });

            const quelle = vorberechneteEntfernungen.size > 0 ? '(aus DB)' : '(live berechnet)';
            console.log(`[GEO] Entfernungen berechnet und sortiert ${quelle}`);
            showToast(`Entfernungen berechnet ${quelle}`, 'success');
        }

        // ============================================
        // Schnellsuche (btnSchnellGo)
        // ============================================
        function btnSchnellGo_Click() {
            console.log('[VBA] btnSchnellGo_Click');

            const txtSuche = document.getElementById('strSchnellSuche');
            const suchbegriff = txtSuche?.value?.trim() || '';

            if (suchbegriff) {
                // Filterung direkt im DOM
                const listMA = document.getElementById('List_MA_Body');
                const rows = listMA?.querySelectorAll('.listbox-row');

                rows?.forEach(row => {
                    const name = row.textContent.toLowerCase();
                    row.style.display = name.includes(suchbegriff.toLowerCase()) ? '' : 'none';
                });
            } else {
                // Alle anzeigen
                const listMA = document.getElementById('List_MA_Body');
                const rows = listMA?.querySelectorAll('.listbox-row');
                rows?.forEach(row => row.style.display = '');
            }

            // Suchfeld leeren (wie VBA)
            if (txtSuche) txtSuche.value = '';
        }

        // ============================================
        // Doppelklick auf Listen
        // ============================================

        // List_MA_DblClick - MA zur Planung hinzufügen
        function List_MA_DblClick(event) {
            console.log('[VBA] List_MA_DblClick');

            // Angeklickte Zeile finden
            const row = event.target.closest('.listbox-row');
            if (!row) return;

            const maId = row.dataset.id;

            // Zeile als selected markieren (andere deselektieren) + Logic-State aktualisieren
            const listMA = document.getElementById('List_MA_Body');
            listMA?.querySelectorAll('.listbox-row.selected').forEach(r => {
                r.classList.remove('selected');
                // Logic-State: Deselektieren
                if (window.SchnellauswahlForm) {
                    window.SchnellauswahlForm.deselectMA(r.dataset.id);
                }
            });
            row.classList.add('selected');
            // Logic-State: Diesen selektieren
            if (window.SchnellauswahlForm) {
                window.SchnellauswahlForm.selectMA(maId);
            }
            console.log('[VBA] Doppelklick: MA selektiert:', maId);

            // Test_selected Prüfung (Doppelbelegung)
            if (!Test_selected(row)) {
                console.log('[VBA] Doppelklick: Verplanung abgebrochen durch Test_selected');
                return;
            }

            // MA zur Planung hinzufügen (maId bereits oben definiert)
            if (maId) {
                addMAToPlanung(parseInt(maId));
                refreshPlanungListe();
                zf_MA_Selektion();
                console.log('[VBA] Doppelklick: MA', maId, 'zur Planung hinzugefügt');
            }
        }

        // lstMA_Plan_DblClick - Aus Planung entfernen
        function lstMA_Plan_DblClick(event) {
            console.log('[VBA] lstMA_Plan_DblClick');

            // Angeklickte Zeile finden
            const row = event.target.closest('.listbox-row');
            if (!row) return;

            // Zeile als selected markieren
            const lstPlan = document.getElementById('lstMA_Plan_Body');
            lstPlan?.querySelectorAll('.listbox-row.selected').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');

            // MA aus Planung entfernen
            const planId = row.dataset.id;
            if (planId) {
                // API-Aufruf zum Löschen
                removeMAfromPlanung(parseInt(planId));
                console.log('[VBA] Doppelklick: Planung', planId, 'entfernt');
            }
        }

        // Hilfsfunktion: MA aus Planung entfernen
        async function removeMAfromPlanung(planId) {
            try {
                const response = await fetch(`http://localhost:5000/api/planungen/${planId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    refreshPlanungListe();
                    zf_MA_Selektion();
                } else {
                    console.error('[removeMAfromPlanung] Fehler:', response.status);
                }
            } catch (err) {
                console.error('[removeMAfromPlanung] Fehler:', err);
            }
        }

        // Lst_Parallel_Einsatz_DblClick - Anderen Einsatz öffnen
        function Lst_Parallel_Einsatz_DblClick(event) {
            console.log('[VBA] Lst_Parallel_Einsatz_DblClick');

            const row = event.target.closest('.listbox-row');
            if (row) {
                const vaId = row.dataset.vaid;
                const vadatumId = row.dataset.vadatumid;

                if (vaId && vadatumId) {
                    VAOpen(parseInt(vaId), parseInt(vadatumId));
                }
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        async function refreshPlanungListe() {
            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                const response = await fetch(`http://localhost:5000/api/planungen?va_id=${formState.VA_ID}&vadatum_id=${formState.VADatum_ID}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        populatePlanungListe(result.data);
                    }
                }
            } catch (err) {
                console.error('[refreshPlanungListe] Fehler:', err);
            }
        }

        async function refreshZusageListe() {
            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                const response = await fetch(`http://localhost:5000/api/zuordnungen?va_id=${formState.VA_ID}&vadatum_id=${formState.VADatum_ID}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        populateZusageListe(result.data);
                    }
                }
            } catch (err) {
                console.error('[refreshZusageListe] Fehler:', err);
            }
        }

        async function loadParalleleEinsaetze() {
            if (!formState.VADatum_ID) return;

            try {
                await loadParalleleEinsaetzeData(formState.VADatum_ID);
            } catch (err) {
                console.error('[loadParalleleEinsaetze] Fehler:', err);
            }
        }

        async function updateSollPlanIst() {
            // Soll/Plan/Ist Anzeige aktualisieren
            if (!formState.VA_ID || !formState.VADatum_ID) return;

            try {
                // Schichten-Daten für Soll-Anzahl laden
                const schichten = await loadSchichten(formState.VA_ID, formState.VADatum_ID);

                let soll = 0;
                let ist = 0;

                if (schichten && schichten.length > 0) {
                    // Summe aus allen Schichten
                    schichten.forEach(s => {
                        soll += parseInt(s.MA_Anzahl) || 0;
                        ist += parseInt(s.MA_Anzahl_Ist) || 0;
                    });
                }

                const lblGesMA = document.getElementById('iGes_MA');
                if (lblGesMA) {
                    lblGesMA.value = `${ist} / ${soll}`;
                }

                // btnAddZusage aktivieren/deaktivieren
                const btnAddZusage = document.getElementById('btnAddZusage');
                if (btnAddZusage) {
                    btnAddZusage.disabled = (ist >= soll);
                }
            } catch (err) {
                console.error('[updateSollPlanIst] Fehler:', err);
            }
        }

        function navigateToForm(formName, recordId) {
            // Verwende shell-detector.js Funktion wenn verfuegbar
            if (typeof window._shellNavigateToForm === 'function') {
                window._shellNavigateToForm(formName, recordId);
            } else if (window.parent !== window) {
                window.parent.postMessage({ type: 'NAVIGATE', formName: formName, id: recordId }, '*');
            } else {
                var url = formName + '.html';
                if (recordId) url += '?id=' + recordId;
                window.location.href = url;
            }
        }

        function showToast(message, type) {
            // Einfache Toast-Nachricht
            const toast = document.createElement('div');
            toast.className = 'toast ' + (type || '');
            toast.textContent = message;
            toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);' +
                'background:#000080;color:#fff;padding:10px 20px;border-radius:4px;z-index:9999;';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // EVENT BINDING
        // ============================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[VBA Events] Initialisiere Event-Bindings...');

            // Form Events - zuerst Form_Load (lädt Dropdowns), dann Form_Open (lädt Daten)
            await Form_Load();
            await Form_Open();

            // Button Event-Listener
            document.getElementById('btnAuftrag')?.addEventListener('click', btnAuftrag_Click);
            document.getElementById('btnPosListe')?.addEventListener('click', btnPosListe_Click);
            document.getElementById('btnZuAbsage')?.addEventListener('click', btnZuAbsage_Click);
            document.getElementById('btnAddSelected')?.addEventListener('click', btnAddSelected_Click);
            document.getElementById('btnDelSelected')?.addEventListener('click', btnDelSelected_Click);
            document.getElementById('btnDelAll')?.addEventListener('click', btnDelAll_Click);
            document.getElementById('btnAddZusage')?.addEventListener('click', btnAddZusage_Click);
            document.getElementById('btnMoveZusage')?.addEventListener('click', btnMoveZusage_Click);
            document.getElementById('btnDelZusage')?.addEventListener('click', btnDelZusage_Click);
            document.getElementById('btnSortPLan')?.addEventListener('click', btnSortPlan_Click);
            document.getElementById('btnSortZugeord')?.addEventListener('click', btnSortZugeord_Click);
            document.getElementById('btnMail')?.addEventListener('click', btnMail_Click);
            // btnMailSelected Event-Handler wird von logic/frm_MA_VA_Schnellauswahl.logic.js registriert
            // Nicht doppelt registrieren!
            document.getElementById('btnSchnellGo')?.addEventListener('click', btnSchnellGo_Click);
            document.getElementById('cmdListMA_Standard')?.addEventListener('click', cmdListMA_Standard_Click);
            document.getElementById('cmdListMA_Entfernung')?.addEventListener('click', cmdListMA_Entfernung_Click);
            document.getElementById('btnClose')?.addEventListener('click', () => {
                Form_Close();
                if (window.closeToShell) closeToShell();
                else window.close();
            });
            document.getElementById('btnHilfe')?.addEventListener('click', () => {
                alert('Hilfe für Schnellauswahl:\n\n' +
                    '1. Auftrag und Datum waehlen\n' +
                    '2. Schicht/Dienstzeit auswählen\n' +
                    '3. Mitarbeiter per Doppelklick oder Button zuordnen\n' +
                    '4. Anfragen per Mail-Button versenden');
            });

            // Filter AfterUpdate Events
            document.getElementById('cboVADatum')?.addEventListener('change', cboVADatum_AfterUpdate);
            document.getElementById('cboAnstArt')?.addEventListener('change', cboAnstArt_AfterUpdate);
            document.getElementById('cboQuali')?.addEventListener('change', cboQuali_AfterUpdate);
            document.getElementById('IstVerfügbar')?.addEventListener('change', IstVerfügbar_AfterUpdate);
            document.getElementById('IstAktiv')?.addEventListener('change', IstAktiv_AfterUpdate);
            document.getElementById('cbVerplantVerfügbar')?.addEventListener('change', cbVerplantVerfügbar_AfterUpdate);
            document.getElementById('cbNur34a')?.addEventListener('change', cbNur34a_AfterUpdate);
            document.getElementById('VA_ID')?.addEventListener('change', async function() {
                // Guard: Nicht erneut VAOpen aufrufen wenn bereits am Laden
                if (_isVAOpenLoading) return;

                const vaId = parseInt(this.value);
                if (vaId) {
                    // VAOpen lädt alle Daten (Einsatztage, Schichten, Mitarbeiter)
                    await VAOpen(vaId, null);

                    // Objekt_ID laden
                    if (window.Bridge) {
                        Bridge.execute('getObjektId', { va_id: vaId }).then(id => {
                            formState.Objekt_ID = id || 0;
                            const btnPosListe = document.getElementById('btnPosListe');
                            if (btnPosListe) btnPosListe.style.display = id > 0 ? '' : 'none';
                        });
                    }
                } else {
                    formState.VA_ID = null;
                    formState.VADatum_ID = null;
                }
            });

            // Schnellsuche Enter-Taste
            document.getElementById('strSchnellSuche')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    btnSchnellGo_Click();
                }
            });

            // Doppelklick-Events für Listen
            document.getElementById('List_MA_Body')?.addEventListener('dblclick', List_MA_DblClick);
            document.getElementById('lstMA_Plan_Body')?.addEventListener('dblclick', lstMA_Plan_DblClick);
            document.getElementById('Lst_Parallel_Einsatz')?.addEventListener('dblclick', Lst_Parallel_Einsatz_DblClick);
            document.getElementById('lstZeiten_Body')?.addEventListener('click', function(e) {
                const row = e.target.closest('.listbox-row');
                if (row) {
                    this.querySelectorAll('.listbox-row').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    lstZeiten_AfterUpdate();
                }
            });

            // Window beforeunload
            window.addEventListener('beforeunload', Form_Close);

            console.log('[VBA Events] Event-Bindings abgeschlossen');
        });

        // ============================================
        // Vollbild-Toggle Funktion (Browser Fullscreen API)
        // ============================================
        function toggleFullscreen() {
            const btn = document.getElementById('fullscreenBtn');
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    btn.title = 'Vollbild beenden';
                }).catch(err => console.error('Fullscreen error:', err));
            } else {
                document.exitFullscreen().then(() => {
                    btn.title = 'Vollbild';
                }).catch(err => console.error('Exit fullscreen error:', err));
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreenBtn');
            btn.title = document.fullscreenElement ? 'Vollbild beenden' : 'Vollbild';
        });
    </script>

    <!-- Shell-Detector (muss vor </body>) -->
    <script src="js/shell-detector.js"></script>
</body>
</html>


