<!DOCTYPE html>
<html lang="de">
<head>
  <link rel="stylesheet" href="css/visbug_overrides.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONSYS - Verwaltung</title>
        <link rel="stylesheet" href="css/fonts_override.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
        }

        body {
            background-color: #8080c0;
            overflow: hidden;
            height: 100vh;
        }

        .shell-container {
            display: flex;
            height: 100vh;
            background-color: #8080c0;
        }

        /* Left Sidebar - permanent, 182px breit (18px schmäler) */
        .sidebar {
            width: 182px;
            background-color: #6060a0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-right: 2px solid #404080;
        }

        /* Main Header - CONSYS PLANUNG */
        .sidebar-header {
            background-color: #000080;
            color: white;
            padding: 8px 10px;
            font-weight: bold;
            font-size: 12px;
            text-align: left;
        }

        /* Kategorie-Container */
        .menu-categories {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 5px 0;
        }

        /* Kategorie-Block mit Abstand */
        .category-block {
            margin-bottom: 10px;
        }

        .category-block:last-child {
            margin-bottom: 0;
        }

        /* Kategorie-Header */
        .category-header {
            background-color: #000080;
            color: #c0c0ff;
            padding: 4px 10px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Menu-Buttons */
        .menu-btn {
            background: linear-gradient(to bottom, #c8c8e0, #a0a0c0);
            padding: 6px 10px;
            text-align: left;
            cursor: pointer;
            font-size: 11px;
            color: #000;
            font-weight: bold;
            border: none;
            border-top: 1px solid #e0e0f0;
            border-bottom: 1px solid #606090;
            display: block;
            width: 100%;
        }

        .menu-btn:hover {
            background: linear-gradient(to bottom, #d8d8f0, #b8b8d8);
        }

        .menu-btn:active {
            background: linear-gradient(to bottom, #9090b0, #a0a0c0);
            border-top: 1px solid #606090;
            border-bottom: 1px solid #e0e0f0;
        }

        .menu-btn.active {
            background: linear-gradient(to bottom, #8080b0, #a0a0d0);
            border-top: 1px solid #505080;
            border-bottom: 1px solid #c0c0e0;
            color: #000080;
            font-weight: 500;
        }

        /* Tooltip-Styling */
        .menu-btn[title] {
            position: relative;
        }

        .menu-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #000080;
            color: #fff;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1000;
            margin-left: 5px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .menu-btn[title]:hover::before {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: #000080;
            z-index: 1000;
        }

        /* Tab Bar - Aktiv für Tab-Navigation */
        .tab-bar {
            display: flex;
            background-color: #6060a0;
            border-bottom: 2px solid #404080;
            min-height: 28px;
            align-items: flex-end;
            padding: 0 5px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .tab {
            display: flex;
            align-items: center;
            background: linear-gradient(to bottom, #a0a0c0, #8080a0);
            border: 1px solid #606090;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            padding: 4px 8px;
            margin-right: 2px;
            cursor: pointer;
            font-size: 11px;
            color: #000;
            white-space: nowrap;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.15s;
        }

        .tab:hover {
            background: linear-gradient(to bottom, #b8b8d8, #9898b8);
        }

        .tab.active {
            background: linear-gradient(to bottom, #e0e0f0, #c0c0d8);
            border-bottom: 1px solid #e0e0f0;
            margin-bottom: -1px;
            font-weight: bold;
        }

        .tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            margin-left: 6px;
            width: 14px;
            height: 14px;
            border: none;
            background: transparent;
            color: #606090;
            font-size: 12px;
            line-height: 12px;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-close:hover {
            background: #d04040;
            color: white;
        }

        .tab.pinned .tab-close {
            display: none;
        }

        /* Iframe Container für Tabs */
        .tabs-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .tab-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .tab-iframe.active {
            display: block;
        }

        /* Right Content Area */
        .content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 182px;
            width: calc(100% - 182px);
            height: 100%;
            background: rgba(128, 128, 192, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #fff;
            border-top-color: #000080;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #c0c0c0;
        }

        ::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border: 1px solid;
            border-color: #e0e0e0 #606060 #606060 #e0e0e0;
        }

        /* Menu Popup Overlay */
        .menu-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
        }

        .menu-popup-overlay.active {
            display: block;
        }

        .menu-popup-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 182px;
            height: 100%;
            border: none;
            background: transparent;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Menu Popup Overlay (fuer Menu 2) -->
    <div class="menu-popup-overlay" id="menuPopupOverlay" onclick="closeMenuPopup(event)">
        <iframe id="menuPopupFrame" class="menu-popup-iframe" src="about:blank"></iframe>
    </div>

    <div class="shell-container">
        <!-- Sidebar - permanent -->
        <div class="sidebar">
            <!-- Main Header -->
            <div class="sidebar-header">CONSYS PLANUNG</div>

            <!-- Kategorien mit Buttons -->
            <div class="menu-categories" id="menuButtons">
                <!-- PLANUNG -->
                <div class="category-block">
                    <div class="category-header">PLANUNG</div>
                    <button class="menu-btn" data-form="frm_N_Dienstplanuebersicht" title="Dienstplan aller Mitarbeiter anzeigen">Dienstplanübersicht</button>
                    <button class="menu-btn" data-form="frm_VA_Planungsuebersicht" title="Aufträge und Einsätze planen">Planungsübersicht</button>
                </div>

                <!-- STAMMDATEN -->
                <div class="category-block">
                    <div class="category-header">STAMMDATEN</div>
                    <button class="menu-btn active" data-form="frm_va_Auftragstamm" title="Aufträge verwalten und bearbeiten">Aufträge</button>
                    <button class="menu-btn" data-form="frm_MA_Mitarbeiterstamm" title="Mitarbeiterdaten verwalten">Mitarbeiter</button>
                    <button class="menu-btn" data-form="frm_KD_Kundenstamm" title="Kundendaten verwalten">Kunden</button>
                    <button class="menu-btn" data-form="frm_OB_Objekt" title="Objekte/Standorte verwalten">Objekte</button>
                </div>

                <!-- PERSONAL -->
                <div class="category-block">
                    <div class="category-header">PERSONAL</div>
                    <button class="menu-btn" data-form="frm_MA_Zeitkonten" title="Zeitkonten der Mitarbeiter einsehen">Zeitkonten</button>
                    <button class="menu-btn" data-form="frm_N_Stundenauswertung" title="Stundenauswertung und Statistik">Stundenauswertung</button>
                    <button class="menu-btn" data-form="frm_MA_Abwesenheit" title="Urlaub, Krankheit, Abwesenheiten">Abwesenheiten</button>
                    <button class="menu-btn" data-form="frm_N_Lohnabrechnungen" title="Lohnabrechnungen erstellen">Lohn</button>
                </div>

                <!-- EXTRAS -->
                <div class="category-block">
                    <div class="category-header">EXTRAS</div>
                    <button class="menu-btn" data-form="frm_MA_VA_Schnellauswahl" title="Schnelle Mitarbeiter-Zuweisung">Schnellauswahl</button>
                    <button class="menu-btn" data-form="frm_Einsatzuebersicht" title="Alle Einsätze auf einen Blick">Einsatzübersicht</button>
                    <button class="menu-btn" id="btnMenu2" onclick="openMenuPopup()" title="Weitere Menü-Optionen anzeigen">Menü 2</button>
                </div>
            </div>
        </div>

        <!-- Content Area mit Tabs -->
        <div class="content-container">
            <!-- Tab Bar -->
            <div class="tab-bar" id="tabBar">
                <!-- Tabs werden dynamisch eingefügt -->
            </div>
            <!-- Iframe Container für alle Tabs -->
            <div class="tabs-container" id="tabsContainer">
                <!-- Iframes werden dynamisch erstellt -->
            </div>
        </div>
    </div>

    <!-- Logger (muss vor anderen Scripts geladen werden) -->
    <script src="js/debug-logger.js"></script>
    <script src="js/logger.js"></script>

    <!-- WebView2 Bridge (falls verfügbar) -->
    <script src="js/webview2-bridge.js"></script>

    <script>
        'use strict';

        // Form-Namen zu Anzeige-Namen Mapping (kurze Namen für Tabs)
        const FORM_TITLES = {
            'frm_N_Dienstplanuebersicht': 'Dienstplan',
            'frm_VA_Planungsuebersicht': 'Planung',
            'frm_va_Auftragstamm': 'Aufträge',
            'frm_MA_Mitarbeiterstamm': 'Mitarbeiter',
            'frm_KD_Kundenstamm': 'Kunden',
            'frm_OB_Objekt': 'Objekte',
            'frm_MA_Zeitkonten': 'Zeitkonten',
            'frm_N_Stundenauswertung': 'Stunden',
            'frm_MA_Abwesenheit': 'Abwesenheiten',
            'frm_N_Lohnabrechnungen': 'Lohn',
            'frm_MA_VA_Schnellauswahl': 'Schnellauswahl',
            'frm_Einsatzuebersicht': 'Einsätze',
            'frm_Menuefuehrung1': 'Menü'
        };

        // =====================================================
        // TAB STATE
        // =====================================================
        const TabState = {
            tabs: [],           // Array von { id, formName, recordId, title, iframe, tab, pinned }
            activeTabId: null,
            tabCounter: 0,
            isWebView2: false,
            initialData: null
        };

        // =====================================================
        // WEBVIEW2 INTEGRATION
        // =====================================================
        function initWebView2Bridge() {
            if (window.chrome && window.chrome.webview) {
                TabState.isWebView2 = true;

                if (window.Bridge) {
                    Bridge.on('onDataReceived', function(data) {
                        console.log('[Shell] Daten von Access:', data);
                        TabState.initialData = data;

                        if (data && data.form) {
                            openTab(data.form, data.id);
                        }
                        sendDataToActiveIframe(data);
                    });

                    Bridge.on('onRefresh', function() {
                        const activeTab = TabState.tabs.find(t => t.id === TabState.activeTabId);
                        if (activeTab && activeTab.iframe) {
                            activeTab.iframe.contentWindow.location.reload();
                        }
                    });
                }

                console.log('[Shell] WebView2 Bridge aktiv');
            } else {
                console.log('[Shell] Browser-Modus (REST API) mit Tab-Navigation');
            }
        }

        function sendDataToActiveIframe(data) {
            const activeTab = TabState.tabs.find(t => t.id === TabState.activeTabId);
            if (activeTab && activeTab.iframe && activeTab.iframe.contentWindow) {
                activeTab.iframe.contentWindow.postMessage({
                    type: 'LOAD_DATA',
                    ...data
                }, '*');
            }
        }

        // =====================================================
        // TAB MANAGEMENT
        // =====================================================

        // Tab erstellen oder zu bestehendem wechseln
        function openTab(formName, recordId) {
            if (!formName) return;

            console.log('[Shell] openTab:', formName, recordId);

            // Prüfen ob Tab bereits existiert (gleicher formName UND recordId)
            const existingTab = TabState.tabs.find(t =>
                t.formName === formName &&
                ((!t.recordId && !recordId) || String(t.recordId) === String(recordId))
            );

            if (existingTab) {
                // Tab existiert - nur aktivieren
                switchTab(existingTab.id);
                return;
            }

            // Neuen Tab erstellen
            const tabId = 'tab_' + (++TabState.tabCounter);
            let title = FORM_TITLES[formName] || formName;

            // Bei recordId: ID zum Titel hinzufügen
            if (recordId) {
                title += ' #' + recordId;
            }

            // URL erstellen (mit Cache-Buster fuer aktuelle Versionen)
            let formUrl = formName + '.html?shell=1&_t=' + Date.now();
            if (recordId) {
                formUrl += '&id=' + recordId;
            }

            showLoading();

            // Tab-Element erstellen
            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.id = tabId;
            tabElement.innerHTML = `
                <span class="tab-title" title="${title}">${title}</span>
                <button class="tab-close" title="Tab schließen">Ã—</button>
            `;

            // Click auf Tab = aktivieren
            tabElement.querySelector('.tab-title').addEventListener('click', () => {
                switchTab(tabId);
            });

            // Click auf X = schließen
            tabElement.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });

            document.getElementById('tabBar').appendChild(tabElement);

            // Iframe erstellen
            const iframe = document.createElement('iframe');
            iframe.className = 'tab-iframe';
            iframe.id = tabId + '_frame';
            iframe.src = formUrl;
            iframe.addEventListener('load', hideLoading);

            document.getElementById('tabsContainer').appendChild(iframe);

            // Tab-State speichern
            const tabData = {
                id: tabId,
                formName: formName,
                recordId: recordId,
                title: title,
                iframe: iframe,
                tab: tabElement,
                pinned: false
            };
            TabState.tabs.push(tabData);

            // Tab aktivieren
            switchTab(tabId);

            // Formular-Wechsel loggen
            if (typeof Logger !== 'undefined' && Logger.log) {
                Logger.log('TAB_OPEN', formName, null, { id: recordId || null, tabId: tabId });
            }

            // Menu-Button aktualisieren
            updateActiveMenuButton(formName);

            // Browser History
            updateBrowserHistory(formName, recordId);

            // WebView2 informieren
            if (TabState.isWebView2 && window.Bridge) {
                Bridge.sendEvent('navigate', { form: formName, id: recordId || null });
            }
        }

        // Zu Tab wechseln
        function switchTab(tabId) {
            const tabData = TabState.tabs.find(t => t.id === tabId);
            if (!tabData) return;

            console.log('[Shell] switchTab:', tabId, tabData.formName);

            // Alle Tabs deaktivieren
            TabState.tabs.forEach(t => {
                t.tab.classList.remove('active');
                t.iframe.classList.remove('active');
            });

            // Gewählten Tab aktivieren
            tabData.tab.classList.add('active');
            tabData.iframe.classList.add('active');
            TabState.activeTabId = tabId;

            // Menu-Button aktualisieren
            updateActiveMenuButton(tabData.formName);

            // Browser History
            updateBrowserHistory(tabData.formName, tabData.recordId);
        }

        // Tab schließen
        function closeTab(tabId) {
            const tabIndex = TabState.tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            const tabData = TabState.tabs[tabIndex];

            // Gepinnte Tabs können nicht geschlossen werden
            if (tabData.pinned) {
                console.log('[Shell] Tab ist gepinnt, kann nicht geschlossen werden');
                return;
            }

            console.log('[Shell] closeTab:', tabId, tabData.formName);

            // DOM-Elemente entfernen
            tabData.tab.remove();
            tabData.iframe.remove();

            // Aus State entfernen
            TabState.tabs.splice(tabIndex, 1);

            // Falls aktiver Tab geschlossen wurde: anderen aktivieren
            if (TabState.activeTabId === tabId) {
                if (TabState.tabs.length > 0) {
                    // Vorherigen Tab aktivieren, oder ersten
                    const newActiveIndex = Math.min(tabIndex, TabState.tabs.length - 1);
                    switchTab(TabState.tabs[newActiveIndex].id);
                }
            }
        }

        // Alle Tabs bis auf gepinnte schließen
        function closeAllTabs() {
            const unpinnedTabs = TabState.tabs.filter(t => !t.pinned);
            unpinnedTabs.forEach(t => closeTab(t.id));
        }

        // Tab pinnen (nicht schließbar)
        function pinTab(tabId) {
            const tabData = TabState.tabs.find(t => t.id === tabId);
            if (tabData) {
                tabData.pinned = true;
                tabData.tab.classList.add('pinned');
            }
        }

        // Menu-Button hervorheben
        function updateActiveMenuButton(formName) {
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[data-form="${formName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Browser-URL aktualisieren
        function updateBrowserHistory(formName, recordId) {
            if (window.history && window.history.replaceState) {
                const historyUrl = recordId
                    ? `?form=${formName}&id=${recordId}`
                    : `?form=${formName}`;
                window.history.replaceState({form: formName, id: recordId}, '', historyUrl);
            }
        }

        // Wrapper für alte API (loadForm -> openTab)
        function loadFormOriginal(formName, recordId) {
            openTab(formName, recordId);
        }

    // VisBug-kompatibler Form-Loader (srcdoc statt src)
    async function loadFormVisBugCompatible(formName, params = {}) {
        const iframe = document.getElementById('menuPopupFrame');
        if (!iframe) {
            console.error('iframe nicht gefunden');
            return;
        }
        
        // URL bauen
        let url = formName.endsWith('.html') ? formName : formName + '.html';
        const queryParams = new URLSearchParams(params);
        queryParams.set('shell', '1');
        queryParams.set('_t', Date.now());
        url += '?' + queryParams.toString();
        
        try {
            // Formular per fetch laden
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            let html = await response.text();
            
            // Base-Tag einfügen für relative Pfade
            const baseUrl = new URL(url, window.location.href).href;
            const baseDir = baseUrl.substring(0, baseUrl.lastIndexOf('/') + 1);
            
            if (!html.includes('<base')) {
                html = html.replace('<head>', `<head><base href="${baseDir}">`);
            }
            
            // Via srcdoc laden - damit ist es same-origin und VisBug funktioniert!
            iframe.srcdoc = html;
            
            console.log('[Shell] Formular geladen (VisBug-kompatibel):', formName);
        } catch (err) {
            console.error('[Shell] Fehler beim Laden:', err);
            iframe.srcdoc = `<html><body><h2>Fehler beim Laden</h2><p>${err.message}</p></body></html>`;
        }
    }

    // Wrapper: Verwendet VisBug-kompatible Version
    function loadForm(formName, params) { return loadFormVisBugCompatible(formName, params); }

        // =====================================================
        // IFRAME MESSAGE HANDLER
        // =====================================================
        function handleIframeMessage(event) {
            const data = event.data;
            if (!data || typeof data !== 'object') return;

            console.log('[Shell] iframe Message:', data.type);

            switch (data.type) {
                case 'NAVIGATE':
                    closeMenuPopup();
                    openTab(data.formName, data.id);
                    break;

                case 'CLOSE_MENU':
                    closeMenuPopup();
                    break;

                case 'CLOSE':
                    // Aktuellen Tab schließen
                    if (TabState.activeTabId) {
                        closeTab(TabState.activeTabId);
                    }
                    break;

                case 'REFRESH':
                    const activeTab = TabState.tabs.find(t => t.id === TabState.activeTabId);
                    if (activeTab && activeTab.iframe) {
                        activeTab.iframe.contentWindow.location.reload();
                    }
                    break;

                case 'SAVE':
                case 'DELETE':
                case 'LOAD_DATA':
                case 'SEARCH':
                    if (TabState.isWebView2 && window.Bridge) {
                        Bridge.sendEvent(data.type.toLowerCase(), data);
                    }
                    break;
            }
        }

        // =====================================================
        // UI HELPERS
        // =====================================================
        let loadingTimeout = null;

        function showLoading() {
            loadingTimeout = setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('active');
            }, 150);
        }

        function hideLoading() {
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // =====================================================
        // MENU POPUP (Menu 2)
        // =====================================================
        function openMenuPopup() {
            const overlay = document.getElementById('menuPopupOverlay');
            const frame = document.getElementById('menuPopupFrame');

            frame.src = 'frm_Menuefuehrung1.html';
            overlay.classList.add('active');
            document.getElementById('btnMenu2').classList.add('active');

            console.log('[Shell] Menu Popup geöffnet');
        }

        function closeMenuPopup(event) {
            if (event && event.target.id !== 'menuPopupOverlay') {
                return;
            }

            const overlay = document.getElementById('menuPopupOverlay');
            const frame = document.getElementById('menuPopupFrame');

            overlay.classList.remove('active');
            frame.src = 'about:blank';
            document.getElementById('btnMenu2').classList.remove('active');

            console.log('[Shell] Menu Popup geschlossen');
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Menu Button Handler
            document.querySelectorAll('.menu-btn[data-form]').forEach(btn => {
                btn.addEventListener('click', function() {
                    openTab(this.dataset.form);
                });
            });

            // iframe Messages
            window.addEventListener('message', handleIframeMessage);

            // Browser Back/Forward
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.form) {
                    openTab(event.state.form, event.state.id);
                }
            });

            // URL Parameter beim Start
            const urlParams = new URLSearchParams(window.location.search);
            const formParam = urlParams.get('form');
            // Unterstütze sowohl 'id' als auch 'va_id' (für Schnellauswahl-Kompatibilität)
            const idParam = urlParams.get('id') || urlParams.get('va_id');

            // Default-Tab: Auftragsverwaltung (gepinnt)
            openTab('frm_va_Auftragstamm');
            pinTab(TabState.tabs[0].id);

            // Falls URL-Parameter, zusätzlichen Tab öffnen
            if (formParam && formParam !== 'frm_va_Auftragstamm') {
                openTab(formParam, idParam);
            } else if (idParam) {
                // ID wurde übergeben aber gleiches Form - Tab aktualisieren
                const activeTab = TabState.tabs.find(t => t.id === TabState.activeTabId);
                if (activeTab) {
                    activeTab.recordId = idParam;
                    activeTab.iframe.src = 'frm_va_Auftragstamm.html?shell=1&_t=' + Date.now() + '&id=' + idParam;
                }
            }

            // WebView2 Bridge initialisieren
            initWebView2Bridge();

            // ESC-Taste schliesst Menu Popup
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const overlay = document.getElementById('menuPopupOverlay');
                    if (overlay.classList.contains('active')) {
                        closeMenuPopup();
                    }
                }
            });

            // Tastenkürzel für Tabs: Ctrl+W schließt Tab
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'w') {
                    e.preventDefault();
                    if (TabState.activeTabId) {
                        closeTab(TabState.activeTabId);
                    }
                }
            });

            console.log('[Shell] Tab-Navigation initialisiert');
        });
    </script>
</body>
</html>

