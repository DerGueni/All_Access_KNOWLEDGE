<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MA-VA Positionszuordnung - CONSYS</title>
    <link rel="stylesheet" href="css/app-layout.css">
    <link rel="stylesheet" href="theme/consys_theme.css">
    <link rel="stylesheet" href="css/unified-header.css">
    <style>
        :root { --accent-color: #4316B2; }
        body { background-color: #8080c0; }
        .zuordnung-grid { display: flex; gap: 16px; height: 100%; }
        .zuordnung-panel { flex: 1; display: flex; flex-direction: column; background: white; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .panel-header { padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #ccc; font-weight: 600; }
        .panel-content { flex: 1; overflow: auto; }
        .position-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .position-item:hover { background: #f5f5f5; }
        .position-item.selected { background: #e8e8e8; border-left: 3px solid #4316B2; }
        .position-name { font-weight: 500; }
        .position-info { font-size: 10px; color: #666; }
        .ma-badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: #e8e8e8; }
        .ma-badge.zugeordnet { background: #e8e8e8; color: #333333; }
    </style>
    <link rel="stylesheet" href="consys-common.css">
    <link rel="stylesheet" href="css/fonts_override.css">
    <link rel="stylesheet" href="css/form-titles.css">
<link rel="stylesheet" href="css/visbug_overrides.css">
</head>
<body data-active-menu="planung" data-menu-style="access" data-form="frm_MA_VA_Positionszuordnung">
    <div class="app-container">
        <aside class="app-sidebar"></aside>

        <main class="app-main">
            <!-- Unified Header -->
            <div class="header-row-wrapper">
                <div class="header-row combined-buttons">
                    <div class="logo-box">C</div>
                    <span class="title-text" style="font-size: 16px; font-weight: bold;">MA-VA Positionszuordnung</span>
                    <div class="buttons-grid">
                        <label class="toolbar-label" style="color:#fff; margin-right:4px;">Auftrag:</label>
                        <select id="cboAuftrag" class="form-control" style="width:200px; height:26px;">
                            <option value="">-- Auftrag waehlen --</option>
                        </select>
                        <label class="toolbar-label" style="color:#fff; margin-left:12px; margin-right:4px;">Datum:</label>
                        <select id="cboDatum" class="form-control" style="width:120px; height:26px;">
                            <option value="">-- Datum --</option>
                        </select>
                        <button class="btn unified-btn btn-primary" id="btnSpeichern">Speichern</button>
                        <button class="btn unified-btn" id="btnAktualisieren">Aktualisieren</button>
                        <button class="btn unified-btn btn-danger" id="mcobtnDelete" title="Ausgewaehlte Position loeschen">Pos. loeschen</button>
                        <button class="btn unified-btn" id="btnRepeat" title="Zuordnung auf andere Tage wiederholen">Wiederholen</button>
                    </div>
                    <span id="header-date" style="color:#fff; font-size:11px; margin-left:auto; margin-right:8px;"></span>
                </div>
                <div class="gpt-box">CONSYS<span>Web</span></div>
            </div>

            <div class="app-content" style="padding:12px;">
                <div class="zuordnung-grid">
                    <!-- Positionen -->
                    <div class="zuordnung-panel">
                        <div class="panel-header">Positionen <span id="lblPosAnzahl">(0)</span></div>
                        <div class="panel-content" id="panelPositionen">
                            <div class="position-item">
                                <div>
                                    <div class="position-name">Einlass Tor 1</div>
                                    <div class="position-info">08:00 - 16:00 | 3 MA</div>
                                </div>
                                <span class="ma-badge">0/3</span>
                            </div>
                            <div class="position-item selected">
                                <div>
                                    <div class="position-name">Streife Innen</div>
                                    <div class="position-info">08:00 - 16:00 | 2 MA</div>
                                </div>
                                <span class="ma-badge zugeordnet">2/2</span>
                            </div>
                        </div>
                    </div>

                    <!-- Verfuegbare MA -->
                    <div class="zuordnung-panel">
                        <div class="panel-header">
                            Verfuegbare Mitarbeiter <span id="lblMAAnzahl">(0)</span>
                            <!-- MA-Typ Filter (Access: OptionGroup MA_Typ) -->
                            <div style="float:right; font-size:10px; font-weight:normal;">
                                <label><input type="radio" name="maTypFilter" value="0" checked> Alle</label>
                                <label style="margin-left:6px;"><input type="radio" name="maTypFilter" value="1"> Fest</label>
                                <label style="margin-left:6px;"><input type="radio" name="maTypFilter" value="2"> Frei</label>
                            </div>
                        </div>
                        <div class="panel-content" id="panelVerfuegbar">
                            <div class="position-item">
                                <div>
                                    <div class="position-name">Mustermann, Max</div>
                                    <div class="position-info">Qualifikation: 34a</div>
                                </div>
                                <button class="btn btn-sm btn-success">&#10140;</button>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk-Buttons zwischen Panels (Access: btnAddAll, btnDelAll, btnAddSelected, btnDelSelected) -->
                    <div class="zuordnung-buttons" style="display:flex; flex-direction:column; gap:8px; justify-content:center; padding:8px;">
                        <button class="btn btn-sm btn-success" id="btnAddSelected" title="Ausgewaehlte MA zuordnen">&#10140;</button>
                        <button class="btn btn-sm btn-primary" id="btnAddAll" title="Alle verfuegbaren MA zuordnen">&#10140;&#10140;</button>
                        <button class="btn btn-sm btn-danger" id="btnDelSelected" title="Ausgewaehlte MA entfernen">&#10140;</button>
                        <button class="btn btn-sm btn-warning" id="btnDelAll" title="Alle zugeordneten MA entfernen">&#10006;&#10006;</button>
                    </div>

                    <!-- Zugeordnete MA -->
                    <div class="zuordnung-panel">
                        <div class="panel-header">Zugeordnet <span id="lblZugeordnetAnzahl">(0)</span></div>
                        <div class="panel-content" id="panelZugeordnet">
                            <div class="position-item">
                                <div>
                                    <div class="position-name">Meier, Hans</div>
                                    <div class="position-info">Position: Streife Innen</div>
                                </div>
                                <button class="btn btn-sm btn-danger">&#10006;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="app-footer">
                <div class="footer-left"><span id="lblStatus">Bereit</span></div>
                <div class="footer-right"><span id="lblSumme">0 Positionen | 0 MA zugeordnet</span></div>
            </footer>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:8px; text-align:center;">
            <div style="font-size:14px; margin-bottom:10px;">Laden...</div>
            <div style="width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto;"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" style="position:fixed; top:20px; right:20px; z-index:10000;"></div>

    <script src="js/sidebar.js"></script>
    <!-- WebView2 Bridge für Access-Integration -->
    <script src="js/webview2-bridge.js"></script>
    <script src="js/global-handlers.js"></script>

    <script>
        // ============================================================
        // frm_MA_VA_Positionszuordnung - Inline Logic
        // Access-Pendant: cbo_Akt_Objekt_Kopf_AfterUpdate, btnAddSelected_Click etc.
        // ============================================================

        document.getElementById('header-date').textContent = new Date().toLocaleDateString('de-DE', {
            weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric'
        });

        // Form Activation Handler (für Shell-Integration)
        window.onFormActivated = function() {
            console.log('[MA_VA_Positionszuordnung] Formular aktiviert');
            updateCounters();
        };

        // DOM Ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[MA_VA_Positionszuordnung] Initialisierung...');

            const cboAuftrag = document.getElementById('cboAuftrag');
            const cboDatum = document.getElementById('cboDatum');
            const btnSpeichern = document.getElementById('btnSpeichern');
            const btnAktualisieren = document.getElementById('btnAktualisieren');
            const panelPositionen = document.getElementById('panelPositionen');
            const panelVerfuegbar = document.getElementById('panelVerfuegbar');
            const panelZugeordnet = document.getElementById('panelZugeordnet');
            const lblStatus = document.getElementById('lblStatus');

            // Auftrag-Dropdown Change (Access: cbo_Akt_Objekt_Kopf_AfterUpdate)
            if (cboAuftrag) {
                cboAuftrag.addEventListener('change', function() {
                    const val = this.value;
                    const txt = this.options[this.selectedIndex]?.text || '';
                    updateStatus('Auftrag gewählt: ' + txt);
                    console.log('[MA_VA_Positionszuordnung] Auftrag:', val);
                    // TODO: Einsatztage für diesen Auftrag laden
                });
            }

            // Datum-Dropdown Change (Access: cboVADatum)
            if (cboDatum) {
                cboDatum.addEventListener('change', function() {
                    updateStatus('Datum gewählt: ' + this.value);
                    console.log('[MA_VA_Positionszuordnung] Datum:', this.value);
                });
            }

            // Speichern-Button
            if (btnSpeichern) {
                btnSpeichern.addEventListener('click', function() {
                    updateStatus('Speichere...');
                    console.log('[MA_VA_Positionszuordnung] Speichern geklickt');
                    setTimeout(() => updateStatus('Gespeichert'), 500);
                });
            }

            // Aktualisieren-Button
            if (btnAktualisieren) {
                btnAktualisieren.addEventListener('click', function() {
                    updateStatus('Aktualisiere...');
                    console.log('[MA_VA_Positionszuordnung] Aktualisieren geklickt');
                    updateCounters();
                    setTimeout(() => updateStatus('Aktualisiert'), 300);
                });
            }

            // Position auswählen (Klick auf Position-Item)
            if (panelPositionen) {
                panelPositionen.addEventListener('click', function(e) {
                    const item = e.target.closest('.position-item');
                    if (item) {
                        // Alle deselektieren, dann diese selektieren
                        panelPositionen.querySelectorAll('.position-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        const posName = item.querySelector('.position-name')?.textContent || '';
                        updateStatus('Position ausgewählt: ' + posName);
                        console.log('[MA_VA_Positionszuordnung] Position geklickt:', posName);
                    }
                });
            }

            // MA zuordnen (Klick auf grünen Pfeil-Button)
            if (panelVerfuegbar) {
                panelVerfuegbar.addEventListener('click', function(e) {
                    const btn = e.target.closest('button');
                    if (btn) {
                        const item = btn.closest('.position-item');
                        if (item) {
                            mitarbeiterZuordnen(item);
                        }
                    }
                });
            }

            // MA entfernen (Klick auf roten X-Button)
            if (panelZugeordnet) {
                panelZugeordnet.addEventListener('click', function(e) {
                    const btn = e.target.closest('button');
                    if (btn) {
                        const item = btn.closest('.position-item');
                        if (item) {
                            mitarbeiterEntfernen(item);
                        }
                    }
                });
            }

            // Bulk-Buttons Event-Listener (Access: btnAddAll, btnDelAll, btnAddSelected, btnDelSelected)
            document.getElementById('btnAddAll')?.addEventListener('click', alleHinzufuegen);
            document.getElementById('btnDelAll')?.addEventListener('click', alleEntfernen);
            document.getElementById('btnAddSelected')?.addEventListener('click', ausgewaehlteHinzufuegen);
            document.getElementById('btnDelSelected')?.addEventListener('click', ausgewaehlteEntfernen);

            // Position loeschen (Access: mcobtnDelete)
            document.getElementById('mcobtnDelete')?.addEventListener('click', positionLoeschen);

            // Wiederholung (Access: btnRepeat)
            document.getElementById('btnRepeat')?.addEventListener('click', zuordnungWiederholen);

            // MA-Typ Filter (Access: MA_Typ OptionGroup AfterUpdate)
            document.querySelectorAll('input[name="maTypFilter"]').forEach(radio => {
                radio.addEventListener('change', maTypFilterAnwenden);
            });

            // Initial Counter update
            updateCounters();
        });

        // MA vom verfügbar-Panel ins zugeordnet-Panel verschieben
        function mitarbeiterZuordnen(maItem) {
            const selectedPosition = document.querySelector('#panelPositionen .position-item.selected');
            if (!selectedPosition) {
                alert('Bitte zuerst eine Position auswählen');
                return;
            }

            const maName = maItem.querySelector('.position-name')?.textContent || '';
            const posName = selectedPosition.querySelector('.position-name')?.textContent || '';

            // Item klonen und Button ändern
            const clonedItem = maItem.cloneNode(true);
            const btn = clonedItem.querySelector('button');
            if (btn) {
                btn.className = 'btn btn-sm btn-danger';
                btn.innerHTML = '&#10006;';
            }
            const infoEl = clonedItem.querySelector('.position-info');
            if (infoEl) {
                infoEl.textContent = 'Position: ' + posName;
            }

            document.getElementById('panelZugeordnet')?.appendChild(clonedItem);
            maItem.remove();

            updateCounters();
            updateStatus('Zugeordnet: ' + maName + ' → ' + posName);
            console.log('[MA_VA_Positionszuordnung] Zugeordnet:', maName, 'zu', posName);
        }

        // MA vom zugeordnet-Panel zurück ins verfügbar-Panel
        function mitarbeiterEntfernen(maItem) {
            const maName = maItem.querySelector('.position-name')?.textContent || '';

            // Item klonen und Button ändern
            const clonedItem = maItem.cloneNode(true);
            const btn = clonedItem.querySelector('button');
            if (btn) {
                btn.className = 'btn btn-sm btn-success';
                btn.innerHTML = '&#10140;';
            }
            const infoEl = clonedItem.querySelector('.position-info');
            if (infoEl) {
                infoEl.textContent = 'Qualifikation: 34a';
            }

            document.getElementById('panelVerfuegbar')?.appendChild(clonedItem);
            maItem.remove();

            updateCounters();
            updateStatus('Entfernt: ' + maName);
            console.log('[MA_VA_Positionszuordnung] Entfernt:', maName);
        }

        // ============================================
        // BULK-OPERATIONEN (Access: btnAddAll, btnDelAll, btnAddSelected, btnDelSelected)
        // ============================================

        // Alle verfuegbaren MA zuordnen (Access: btnAddAll_Click)
        function alleHinzufuegen() {
            const selectedPosition = document.querySelector('#panelPositionen .position-item.selected');
            if (!selectedPosition) {
                alert('Bitte zuerst eine Position auswaehlen');
                return;
            }

            const panelVerfuegbar = document.getElementById('panelVerfuegbar');
            const items = panelVerfuegbar?.querySelectorAll('.position-item');
            if (!items || items.length === 0) {
                updateStatus('Keine verfuegbaren MA');
                return;
            }

            let count = 0;
            items.forEach(item => {
                mitarbeiterZuordnen(item);
                count++;
            });

            updateStatus(count + ' MA zugeordnet');
            console.log('[MA_VA_Positionszuordnung] Alle hinzugefuegt:', count);
        }

        // Alle zugeordneten MA entfernen (Access: btnDelAll_Click)
        function alleEntfernen() {
            const panelZugeordnet = document.getElementById('panelZugeordnet');
            const items = panelZugeordnet?.querySelectorAll('.position-item');
            if (!items || items.length === 0) {
                updateStatus('Keine zugeordneten MA');
                return;
            }

            if (!confirm('Wirklich alle ' + items.length + ' Zuordnungen entfernen?')) {
                return;
            }

            let count = 0;
            items.forEach(item => {
                mitarbeiterEntfernen(item);
                count++;
            });

            updateStatus(count + ' MA entfernt');
            console.log('[MA_VA_Positionszuordnung] Alle entfernt:', count);
        }

        // Ausgewaehlte MA zuordnen (Access: btnAddSelected_Click)
        function ausgewaehlteHinzufuegen() {
            const selectedPosition = document.querySelector('#panelPositionen .position-item.selected');
            if (!selectedPosition) {
                alert('Bitte zuerst eine Position auswaehlen');
                return;
            }

            const panelVerfuegbar = document.getElementById('panelVerfuegbar');
            const selectedItems = panelVerfuegbar?.querySelectorAll('.position-item.selected');
            if (!selectedItems || selectedItems.length === 0) {
                // Wenn nichts ausgewaehlt, ersten verfuegbaren MA nehmen
                const firstItem = panelVerfuegbar?.querySelector('.position-item');
                if (firstItem) {
                    mitarbeiterZuordnen(firstItem);
                    updateStatus('1 MA zugeordnet');
                }
                return;
            }

            selectedItems.forEach(item => {
                mitarbeiterZuordnen(item);
            });
            updateStatus(selectedItems.length + ' MA zugeordnet');
        }

        // Ausgewaehlte MA entfernen (Access: btnDelSelected_Click)
        function ausgewaehlteEntfernen() {
            const panelZugeordnet = document.getElementById('panelZugeordnet');
            const selectedItems = panelZugeordnet?.querySelectorAll('.position-item.selected');
            if (!selectedItems || selectedItems.length === 0) {
                // Wenn nichts ausgewaehlt, ersten zugeordneten MA entfernen
                const firstItem = panelZugeordnet?.querySelector('.position-item');
                if (firstItem) {
                    mitarbeiterEntfernen(firstItem);
                    updateStatus('1 MA entfernt');
                }
                return;
            }

            selectedItems.forEach(item => {
                mitarbeiterEntfernen(item);
            });
            updateStatus(selectedItems.length + ' MA entfernt');
        }

        // Position loeschen (Access: mcobtnDelete_Click)
        function positionLoeschen() {
            const selectedPosition = document.querySelector('#panelPositionen .position-item.selected');
            if (!selectedPosition) {
                alert('Bitte zuerst eine Position auswaehlen');
                return;
            }

            const posName = selectedPosition.querySelector('.position-name')?.textContent || 'Position';
            if (!confirm('Position "' + posName + '" wirklich loeschen?')) {
                return;
            }

            selectedPosition.remove();
            updateCounters();
            updateStatus('Position geloescht: ' + posName);
            console.log('[MA_VA_Positionszuordnung] Position geloescht:', posName);
        }

        // Zuordnung auf andere Tage wiederholen (Access: btnRepeat_Click)
        function zuordnungWiederholen() {
            const selectedPosition = document.querySelector('#panelPositionen .position-item.selected');
            if (!selectedPosition) {
                alert('Bitte zuerst eine Position auswaehlen');
                return;
            }

            const zugeordnete = document.querySelectorAll('#panelZugeordnet .position-item');
            if (zugeordnete.length === 0) {
                alert('Keine Zuordnungen zum Wiederholen vorhanden');
                return;
            }

            // TODO: Dialog fuer Datum-Auswahl oeffnen
            const zielDatum = prompt('Auf welches Datum soll die Zuordnung kopiert werden? (Format: TT.MM.JJJJ)');
            if (!zielDatum) return;

            updateStatus('Wiederhole Zuordnung auf ' + zielDatum + '...');
            console.log('[MA_VA_Positionszuordnung] Wiederhole:', zugeordnete.length, 'MA auf', zielDatum);

            // Simuliere API-Aufruf
            setTimeout(() => {
                updateStatus('Zuordnung auf ' + zielDatum + ' uebernommen');
                alert(zugeordnete.length + ' Zuordnungen wurden auf ' + zielDatum + ' kopiert.');
            }, 500);
        }

        // MA-Typ Filter anwenden (Access: MA_Typ_AfterUpdate)
        function maTypFilterAnwenden() {
            const filterValue = document.querySelector('input[name="maTypFilter"]:checked')?.value || '0';
            const panelVerfuegbar = document.getElementById('panelVerfuegbar');
            const items = panelVerfuegbar?.querySelectorAll('.position-item');

            items?.forEach(item => {
                // Hier wuerde normalerweise nach Fest/Frei gefiltert werden
                // Vorerst alle anzeigen
                item.style.display = '';
            });

            updateStatus('Filter: ' + (filterValue === '0' ? 'Alle' : filterValue === '1' ? 'Fest' : 'Frei'));
            console.log('[MA_VA_Positionszuordnung] MA-Typ Filter:', filterValue);
        }

        // Zaehler aktualisieren
        function updateCounters() {
            const posCount = document.querySelectorAll('#panelPositionen .position-item').length;
            const maCount = document.querySelectorAll('#panelVerfuegbar .position-item').length;
            const zugeordnetCount = document.querySelectorAll('#panelZugeordnet .position-item').length;

            const lblPosAnzahl = document.getElementById('lblPosAnzahl');
            const lblMAAnzahl = document.getElementById('lblMAAnzahl');
            const lblZugeordnetAnzahl = document.getElementById('lblZugeordnetAnzahl');
            const lblSumme = document.getElementById('lblSumme');

            if (lblPosAnzahl) lblPosAnzahl.textContent = '(' + posCount + ')';
            if (lblMAAnzahl) lblMAAnzahl.textContent = '(' + maCount + ')';
            if (lblZugeordnetAnzahl) lblZugeordnetAnzahl.textContent = '(' + zugeordnetCount + ')';
            if (lblSumme) lblSumme.textContent = posCount + ' Positionen | ' + zugeordnetCount + ' MA zugeordnet';
        }

        // Status-Label aktualisieren
        function updateStatus(msg) {
            const lblStatus = document.getElementById('lblStatus');
            if (lblStatus) lblStatus.textContent = msg;
        }
    </script>

    <!-- Form Logic (ES-Modul - lädt nur über HTTP, nicht file://) -->
    <script type="module" src="logic/frm_MA_VA_Positionszuordnung.logic.js"></script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>



