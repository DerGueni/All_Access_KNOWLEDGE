<!DOCTYPE html>
<html lang="de">
<head>
    <!-- Base-URL für korrekte relative Pfade (wichtig für WebView2/Redirect) -->
    <base href="/forms/">
  <link rel="stylesheet" href="css/visbug_overrides.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6040c0">
    <title>CONSYS - Verwaltung</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="img/icon-192.png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/fonts_override.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <link rel="stylesheet" href="css/responsive-sidebar.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 12px;
        }

        body {
            background-color: #8080c0;
            overflow: hidden;
            height: 100vh;
        }

        .shell-container {
            display: flex;
            height: 100vh;
            background-color: #8080c0;
        }

        /* Left Sidebar - permanent, responsive Breite (via responsive.css) */
        .sidebar {
            width: 182px; /* Fallback für Browser ohne responsive.css */
            background-color: #d3d3d3;  /* HELLGRAU */
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-right: 2px solid #404080;
            transition: width 0.3s ease; /* Sanfte Größenänderung */
        }

        /* Main Header - CONSYS PLANUNG */
        .sidebar-header {
            background-color: #000080;
            color: white;
            padding: 8px 10px;
            font-weight: bold;
            font-size: 13px;
            text-align: left;
        }

        /* Kategorie-Container */
        .menu-categories {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 5px 0;
        }

        /* Kategorie-Block mit Abstand - entzerrt */
        .category-block {
            margin-bottom: 14px;
        }

        .category-block:last-child {
            margin-bottom: 0;
        }

        /* Kategorie-Header */
        .category-header {
            background-color: #000080;
            color: #c0c0ff;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Menu-Buttons - entzerrt */
        .menu-btn {
            background: linear-gradient(to bottom, #c8c8e0, #a0a0c0);
            padding: 7px 10px;
            text-align: left;
            cursor: pointer;
            font-size: 12px;
            color: #000;
            font-weight: bold;
            border: none;
            border-top: 1px solid #e0e0f0;
            border-bottom: 1px solid #606090;
            display: block;
            width: 100%;
            margin-bottom: 1px;
        }

        .menu-btn:hover {
            background: linear-gradient(to bottom, #d8d8f0, #b8b8d8);
        }

        .menu-btn:active {
            background: linear-gradient(to bottom, #9090b0, #a0a0c0);
            border-top: 1px solid #606090;
            border-bottom: 1px solid #e0e0f0;
        }

        .menu-btn.active {
            background: linear-gradient(to bottom, #8080b0, #a0a0d0);
            border-top: 1px solid #505080;
            border-bottom: 1px solid #c0c0e0;
            color: #000080;
            font-weight: 500;
        }

        /* Tooltip-Styling */
        .menu-btn[title] {
            position: relative;
        }

        .menu-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #000080;
            color: #fff;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 1000;
            margin-left: 5px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .menu-btn[title]:hover::before {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: #000080;
            z-index: 1000;
        }

        /* Tab Bar - Aktiv für Tab-Navigation, responsive via responsive.css */
        .tab-bar {
            display: flex;
            background-color: #d3d3d3;  /* HELLGRAU */
            border-bottom: 2px solid #404080;
            min-height: 28px;
            align-items: flex-end;
            padding: 0 5px;
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap; /* responsive.css aktiviert wrap bei Bedarf */
        }

        .tab {
            display: flex;
            align-items: center;
            background: linear-gradient(to bottom, #a0a0c0, #8080a0);
            border: 1px solid #606090;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            padding: 4px 8px;
            margin-right: 2px;
            cursor: pointer;
            font-size: 12px;
            color: #000;
            white-space: nowrap;
            max-width: 180px;
            min-width: 80px; /* Verhindert zu schmale Tabs */
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.15s, font-size 0.3s, padding 0.3s; /* Responsive Transitions */
            flex-shrink: 0; /* Tabs nicht zusammenquetschen */
        }

        .tab:hover {
            background: linear-gradient(to bottom, #b8b8d8, #9898b8);
        }

        .tab.active {
            background: linear-gradient(to bottom, #e0e0f0, #c0c0d8);
            border-bottom: 1px solid #e0e0f0;
            margin-bottom: -1px;
            font-weight: bold;
        }

        .tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            margin-left: 6px;
            width: 14px;
            height: 14px;
            border: none;
            background: transparent;
            color: #606090;
            font-size: 12px;
            line-height: 12px;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-close:hover {
            background: #d04040;
            color: white;
        }

        .tab.pinned .tab-close {
            display: none;
        }

        /* Iframe Container für Tabs - 100% verfügbarer Raum */
        .tabs-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0; /* Wichtig für flex-Container mit absolut positionierten Kindern */
        }

        .tab-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .tab-iframe.active {
            display: block;
        }

        /* Right Content Area - flexibel skalierend */
        .content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0; /* Verhindert Overflow bei flex-Kindern */
        }

        /* Loading Overlay - responsive Position (via responsive.css) */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 182px; /* Fallback */
            width: calc(100% - 182px); /* Fallback */
            height: 100%;
            background: rgba(128, 128, 192, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: left 0.3s ease, width 0.3s ease; /* Sanfte Anpassung */
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #fff;
            border-top-color: #000080;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #c0c0c0;
        }

        ::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border: 1px solid;
            border-color: #e0e0e0 #606060 #606060 #e0e0e0;
        }

        /* Menu Popup Overlay */
        .menu-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
        }

        .menu-popup-overlay.active {
            display: block;
        }

        .menu-popup-iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 182px; /* Fallback, responsive.css überschreibt */
            height: 100%;
            border: none;
            background: transparent;
            transition: width 0.3s ease; /* Sanfte Größenänderung */
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Menu Popup Overlay (fuer Menu 2) -->
    <div class="menu-popup-overlay" id="menuPopupOverlay" onclick="closeMenuPopup(event)">
        <iframe id="menuPopupFrame" class="menu-popup-iframe" src="about:blank"></iframe>
    </div>

    <div class="shell-container">
        <!-- Sidebar - permanent -->
        <div class="sidebar">
            <!-- Main Header -->
            <div class="sidebar-header">CONSYS PLANUNG</div>

            <!-- Kategorien mit Buttons -->
            <div class="menu-categories" id="menuButtons">
                <!-- PLANUNG -->
                <div class="category-block">
                    <div class="category-header">PLANUNG</div>
                    <button class="menu-btn" data-form="frm_DP_Dienstplan_MA" title="Dienstplan aller Mitarbeiter anzeigen">Dienstplan MA</button>
                    <button class="menu-btn" data-form="frm_DP_Dienstplan_Objekt" title="Aufträge und Einsätze planen">Planung Objekt</button>
                </div>

                <!-- STAMMDATEN -->
                <div class="category-block">
                    <div class="category-header">STAMMDATEN</div>
                    <button class="menu-btn active" data-form="frm_va_Auftragstamm" title="Aufträge verwalten und bearbeiten">Aufträge</button>
                    <button class="menu-btn" data-form="frm_MA_Mitarbeiterstamm" title="Mitarbeiterdaten verwalten">Mitarbeiter</button>
                    <button class="menu-btn" data-form="frm_KD_Kundenstamm" title="Kundendaten verwalten">Kunden</button>
                    <button class="menu-btn" data-form="frm_OB_Objekt" title="Objekte/Standorte verwalten">Objekte</button>
                </div>

                <!-- PERSONAL -->
                <div class="category-block">
                    <div class="category-header">PERSONAL</div>
                    <button class="menu-btn" data-form="frm_MA_Zeitkonten" title="Zeitkonten der Mitarbeiter einsehen">Zeitkonten</button>
                    <button class="menu-btn" data-form="frm_MA_Abwesenheit" title="Urlaub, Krankheit, Abwesenheiten">Abwesenheiten</button>
                    <!-- Stundenauswertung, Telefonliste entfernt (18.01.2026) -->
                    <button class="menu-btn" data-action="letzterEinsatz" title="Letzten Einsatz eines MA anzeigen">Letzter Einsatz</button>
                    <button class="menu-btn" data-form="zfrm_ZK_Lohnarten_Zuschlag" title="Lohnarten verwalten">Lohnarten</button>
                </div>

                <!-- EXTRAS -->
                <!-- Schnellauswahl, Einsatzübersicht entfernt (18.01.2026) -->
                <div class="category-block">
                    <div class="category-header">EXTRAS</div>
                    <button class="menu-btn" data-form="frmTop_neue_Vorlagen" title="Vorlagen verwalten">Vorlagen</button>
                </div>

                <!-- EXPORT -->
                <div class="category-block">
                    <div class="category-header">EXPORT</div>
                    <button class="menu-btn" data-action="maStammExcel" title="Mitarbeiterstamm nach Excel exportieren">MA Stamm Excel</button>
                    <button class="menu-btn" data-action="fcnMeldeliste" title="FCN Meldeliste exportieren">FCN Meldeliste</button>
                    <button class="menu-btn" data-action="fuerthNamensliste" title="Fürth Namensliste exportieren">Fürth Namensliste</button>
                    <button class="menu-btn" data-action="subStunden" title="Stunden-Export">Sub Stunden</button>
                    <button class="menu-btn" data-action="stundenMA" title="Stunden pro Mitarbeiter">Stunden MA</button>
                </div>

                <!-- SYSTEM -->
                <div class="category-block">
                    <div class="category-header">SYSTEM</div>
                    <button class="menu-btn" data-form="frm_Lex_Aktiv" title="Lexware Aktiv-Status">Lex Aktiv</button>
                </div>

                <!-- AUFTRÄGE ANLEGEN -->
                <div class="category-block">
                    <div class="category-header">AUFTRÄGE ANLEGEN</div>
                    <button class="menu-btn" data-action="syncAuftraege" title="Aufträge vom Löwensaal synchronisieren">Aufträge sync</button>
                    <button class="menu-btn" data-action="standwachenAnlegen" title="Standwachen aus E-Mail anlegen">Standwachen anlegen</button>
                    <button class="menu-btn" data-action="hirschAnlegen" title="Hirsch Auftrag anlegen">Hirsch Auftrag anlegen</button>
                </div>
            </div>
        </div>

        <!-- Content Area mit Tabs -->
        <div class="content-container">
            <!-- Tab Bar -->
            <div class="tab-bar" id="tabBar">
                <!-- Tabs werden dynamisch eingefügt -->
            </div>
            <!-- Iframe Container für alle Tabs -->
            <div class="tabs-container" id="tabsContainer">
                <!-- Iframes werden dynamisch erstellt -->
            </div>
        </div>
    </div>

    <!-- Logger (muss vor anderen Scripts geladen werden) -->
    <script src="js/debug-logger.js"></script>
    <script src="js/logger.js"></script>

    <!-- Error Tracking System -->
    <script src="js/error-tracking.js"></script>

    <!-- Context Menu -->
    <script src="js/context-menu.js"></script>

    <!-- Responsive Sidebar -->
    <script src="js/responsive-sidebar.js"></script>

    <!-- WebSocket Client fuer Echtzeit-Updates -->
    <script src="js/websocket-client.js"></script>

    <!-- Bulk Operations -->
    <script src="js/bulk-operations.js"></script>

    <!-- Pagination -->
    <script src="js/pagination.js"></script>

    <!-- Offline Storage (IndexedDB) -->
    <script src="js/offline-storage.js"></script>

    <!-- PWA Service Worker Registration -->
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('[PWA] Service Worker registriert:', reg.scope))
                .catch(err => console.warn('[PWA] SW Registrierung fehlgeschlagen:', err));
        });
    }
    </script>

    <!-- WebView2 Bridge (falls verfügbar) -->
    <script src="js/webview2-bridge.js"></script>

    <script>
        'use strict';

        // Form-Namen zu Anzeige-Namen Mapping (kurze Namen für Tabs)
        const FORM_TITLES = {
            'frm_DP_Dienstplan_MA': 'Dienstplan MA',
            'frm_DP_Dienstplan_Objekt': 'Planung Objekt',
            'frm_VA_Planungsuebersicht': 'Planung',
            'frm_va_Auftragstamm': 'Aufträge',
            'frm_MA_Mitarbeiterstamm': 'Mitarbeiter',
            'frm_KD_Kundenstamm': 'Kunden',
            'frm_OB_Objekt': 'Objekte',
            'frm_MA_Zeitkonten': 'Zeitkonten',
            'frm_MA_Abwesenheit': 'Abwesenheiten',
            'frm_N_Lohnabrechnungen': 'Lohn',
            // Entfernt 18.01.2026: frm_N_Stundenauswertung, frm_MA_VA_Schnellauswahl, frm_Einsatzuebersicht
            'frm_Menuefuehrung1': 'Menü',
            'zfrm_ZK_Lohnarten_Zuschlag': 'Lohnarten',
            'frmTop_neue_Vorlagen': 'Vorlagen',
            'frm_Lex_Aktiv': 'Lex Aktiv'
        };

        // =====================================================
        // TAB STATE
        // =====================================================
        const TabState = {
            tabs: [],           // Array von { id, formName, recordId, title, iframe, tab, pinned }
            activeTabId: null,
            tabCounter: 0,
            isWebView2: false,
            initialData: null
        };

        // =====================================================
        // WEBVIEW2 INTEGRATION
        // =====================================================
        function initWebView2Bridge() {
            if (window.chrome && window.chrome.webview) {
                TabState.isWebView2 = true;

                if (window.Bridge) {
                    Bridge.on('onDataReceived', function(data) {
                        console.log('[Shell] Daten von Access:', data);
                        TabState.initialData = data;

                        if (data && data.form) {
                            openTab(data.form, data.id);
                        }
                        sendDataToActiveIframe(data);
                    });

                    Bridge.on('onRefresh', function() {
                        const activeTab = TabState.tabs.find(t => t.id === TabState.activeTabId);
                        if (activeTab && activeTab.iframe) {
                            activeTab.iframe.contentWindow.location.reload();
                        }
                    });
                }

                console.log('[Shell] WebView2 Bridge aktiv');
            } else {
                console.log('[Shell] Browser-Modus (REST API) mit Tab-Navigation');
            }
        }

        function sendDataToActiveIframe(data) {
            const activeTab = TabState.tabs.find(t => t.id === TabState.activeTabId);
            if (activeTab && activeTab.iframe && activeTab.iframe.contentWindow) {
                activeTab.iframe.contentWindow.postMessage({
                    type: 'LOAD_DATA',
                    ...data
                }, '*');
            }
        }

        // =====================================================
        // TAB MANAGEMENT
        // =====================================================

        // Tab erstellen oder zu bestehendem wechseln
        // params: zusätzliche URL-Parameter als Objekt {vadatum_id: 123, vastart_id: 456}
        function openTab(formName, recordId, params) {
            if (!formName) return;

            console.log('[Shell] openTab:', formName, recordId, params);

            // Prüfen ob Tab bereits existiert (gleicher formName UND recordId)
            const existingTab = TabState.tabs.find(t =>
                t.formName === formName &&
                ((!t.recordId && !recordId) || String(t.recordId) === String(recordId))
            );

            if (existingTab) {
                // Tab existiert - nur aktivieren
                switchTab(existingTab.id);
                return;
            }

            // Neuen Tab erstellen
            const tabId = 'tab_' + (++TabState.tabCounter);
            let title = FORM_TITLES[formName] || formName;

            // Bei recordId: ID zum Titel hinzufügen
            if (recordId) {
                title += ' #' + recordId;
            }

            // URL erstellen (mit Cache-Buster fuer aktuelle Versionen)
            // WICHTIG: Absoluter Pfad /forms/ fuer API-Server Kompatibilitaet
            let formUrl = '/forms/' + formName + '.html?shell=1&_t=' + Date.now();
            if (recordId) {
                formUrl += '&id=' + recordId;
            }

            // Zusätzliche Parameter anhängen (z.B. vadatum_id, vastart_id)
            if (params && typeof params === 'object') {
                for (const [key, value] of Object.entries(params)) {
                    if (value !== null && value !== undefined && value !== '') {
                        formUrl += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(value);
                    }
                }
            }

            showLoading();

            // Tab-Element erstellen
            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.id = tabId;
            tabElement.innerHTML = `
                <span class="tab-title" title="${title}">${title}</span>
                <button class="tab-close" title="Tab schließen">&times;</button>
            `;

            // Click auf Tab = aktivieren
            tabElement.querySelector('.tab-title').addEventListener('click', () => {
                switchTab(tabId);
            });

            // Click auf X = schließen
            tabElement.querySelector('.tab-close').addEventListener('click', (e) => {
                e.stopPropagation();
                closeTab(tabId);
            });

            document.getElementById('tabBar').appendChild(tabElement);

            // Iframe erstellen
            const iframe = document.createElement('iframe');
            iframe.className = 'tab-iframe';
            iframe.id = tabId + '_frame';
            // VisBug-Fix: Laden via srcdoc statt src
            (async () => {
                try {
                    const response = await fetch(formUrl, { cache: 'no-store' });
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    let html = await response.text();

                    // URL-Parameter als globale Variable injizieren (srcdoc verliert URL-Parameter)
                    const shellParams = {
                        shell: '1',
                        id: recordId || null,
                        va_id: recordId || null,
                        ...(params || {})
                    };
                    console.log('[Shell] Injiziere SHELL_PARAMS:', JSON.stringify(shellParams));

                    // Base-Tag für relative Pfade
                    const baseDir = formUrl.split('?')[0].replace(/[^/]*$/, '');
                    const baseTag = html.includes('<base') ? '' : '<base href="' + baseDir + '">';

                    // Script-Tag aufteilen um vorzeitiges Schließen zu vermeiden
                    const paramsScript = '<script>window.SHELL_PARAMS = ' + JSON.stringify(shellParams) + ';<\/script>';

                    // Injektion mit Regex der auch <head style="..."> findet
                    // Verwende Callback-Funktion statt $& für Kompatibilität
                    html = html.replace(/<head[^>]*>/i, function(match) {
                        console.log('[Shell] HEAD-Tag gefunden:', match);
                        return match + paramsScript + baseTag;
                    });
                    console.log('[Shell] SHELL_PARAMS injiziert:', html.includes('SHELL_PARAMS'));

                    iframe.srcdoc = html;
                } catch(e) {
                    console.error('[Shell] Ladefehler:', e);
                    iframe.srcdoc = '<html><body><h2>Fehler</h2><p>' + e.message + '</p></body></html>';
                }
            })();
            iframe.addEventListener('load', hideLoading);

            document.getElementById('tabsContainer').appendChild(iframe);

            // Tab-State speichern
            const tabData = {
                id: tabId,
                formName: formName,
                recordId: recordId,
                title: title,
                iframe: iframe,
                tab: tabElement,
                pinned: false
            };
            TabState.tabs.push(tabData);

            // Tab aktivieren
            switchTab(tabId);

            // Formular-Wechsel loggen
            if (typeof Logger !== 'undefined' && Logger.log) {
                Logger.log('TAB_OPEN', formName, null, { id: recordId || null, tabId: tabId });
            }

            // Menu-Button aktualisieren
            updateActiveMenuButton(formName);

            // Browser History
            updateBrowserHistory(formName, recordId);

            // WebView2 informieren
            if (TabState.isWebView2 && window.Bridge) {
                Bridge.sendEvent('navigate', { form: formName, id: recordId || null });
            }
        }

        // Zu Tab wechseln
        function switchTab(tabId) {
            const tabData = TabState.tabs.find(t => t.id === tabId);
            if (!tabData) return;

            console.log('[Shell] switchTab:', tabId, tabData.formName);

            // Alle Tabs deaktivieren
            TabState.tabs.forEach(t => {
                t.tab.classList.remove('active');
                t.iframe.classList.remove('active');
            });

            // Gewählten Tab aktivieren
            tabData.tab.classList.add('active');
            tabData.iframe.classList.add('active');
            TabState.activeTabId = tabId;

            // Menu-Button aktualisieren
            updateActiveMenuButton(tabData.formName);

            // Browser History
            updateBrowserHistory(tabData.formName, tabData.recordId);
        }

        // Tab schließen
        function closeTab(tabId) {
            const tabIndex = TabState.tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;

            const tabData = TabState.tabs[tabIndex];

            // Gepinnte Tabs können nicht geschlossen werden
            if (tabData.pinned) {
                console.log('[Shell] Tab ist gepinnt, kann nicht geschlossen werden');
                return;
            }

            console.log('[Shell] closeTab:', tabId, tabData.formName);

            // DOM-Elemente entfernen
            tabData.tab.remove();
            tabData.iframe.remove();

            // Aus State entfernen
            TabState.tabs.splice(tabIndex, 1);

            // Falls aktiver Tab geschlossen wurde: anderen aktivieren
            if (TabState.activeTabId === tabId) {
                if (TabState.tabs.length > 0) {
                    // Vorherigen Tab aktivieren, oder ersten
                    const newActiveIndex = Math.min(tabIndex, TabState.tabs.length - 1);
                    switchTab(TabState.tabs[newActiveIndex].id);
                }
            }
        }

        // Alle Tabs bis auf gepinnte schließen
        function closeAllTabs() {
            const unpinnedTabs = TabState.tabs.filter(t => !t.pinned);
            unpinnedTabs.forEach(t => closeTab(t.id));
        }

        // Tab pinnen (nicht schließbar)
        function pinTab(tabId) {
            const tabData = TabState.tabs.find(t => t.id === tabId);
            if (tabData) {
                tabData.pinned = true;
                tabData.tab.classList.add('pinned');
            }
        }

        // Menu-Button hervorheben
        function updateActiveMenuButton(formName) {
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[data-form="${formName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // Browser-URL aktualisieren
        function updateBrowserHistory(formName, recordId) {
            if (window.history && window.history.replaceState) {
                const historyUrl = recordId
                    ? `?form=${formName}&id=${recordId}`
                    : `?form=${formName}`;
                window.history.replaceState({form: formName, id: recordId}, '', historyUrl);
            }
        }

        // Wrapper für alte API (loadForm -> openTab)
        function loadForm(formName, recordId) {
            openTab(formName, recordId);
        }

    

        // =====================================================
        // IFRAME MESSAGE HANDLER
        // =====================================================
        function handleIframeMessage(event) {
            const data = event.data;
            if (!data || typeof data !== 'object') return;

            console.log('[Shell] iframe Message:', data.type);

            switch (data.type) {
                case 'NAVIGATE':
                    closeMenuPopup();
                    openTab(data.formName, data.id, data.params);
                    break;

                case 'START_VBA_BRIDGE':
                    // VBA Bridge Server starten (unsichtbar)
                    console.log('[Shell] START_VBA_BRIDGE angefordert');
                    startVBABridgeServer();
                    break;

                case 'CLOSE_MENU':
                    closeMenuPopup();
                    break;

                case 'CLOSE':
                    // Aktuellen Tab schließen
                    if (TabState.activeTabId) {
                        closeTab(TabState.activeTabId);
                    }
                    break;

                case 'REFRESH':
                    const activeTab = TabState.tabs.find(t => t.id === TabState.activeTabId);
                    if (activeTab && activeTab.iframe) {
                        activeTab.iframe.contentWindow.location.reload();
                    }
                    break;

                case 'SAVE':
                case 'DELETE':
                case 'LOAD_DATA':
                case 'SEARCH':
                    if (TabState.isWebView2 && window.Bridge) {
                        Bridge.sendEvent(data.type.toLowerCase(), data);
                    }
                    break;
            }
        }

        // =====================================================
        // UI HELPERS
        // =====================================================
        let loadingTimeout = null;

        function showLoading() {
            loadingTimeout = setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('active');
            }, 150);
        }

        function hideLoading() {
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // =====================================================
        // VBA ACTIONS (ehem. Menü 2 Funktionen)
        // =====================================================
        async function handleVBAAction(action) {
            console.log('[Shell] VBA Action:', action);

            // VBA Bridge Server URL
            const VBA_BRIDGE = 'http://localhost:5002/api/vba/execute';

            try {
                let vbaFunc = '';
                let args = [];

                switch (action) {
                    case 'telefonliste':
                        // Öffnet Bericht rpt_telefonliste
                        vbaFunc = 'DoCmd.OpenReport';
                        args = ['rpt_telefonliste', 2]; // acViewPreview = 2
                        break;

                    case 'letzterEinsatz':
                        // Öffnet Query qry_MA_letzter_Einsatz_Gueni
                        vbaFunc = 'DoCmd.OpenQuery';
                        args = ['qry_MA_letzter_Einsatz_Gueni'];
                        break;

                    case 'maStammExcel':
                        // Mitarbeiterstamm nach Excel exportieren
                        vbaFunc = 'btn_MAStamm_Excel_Click_FromHTML';
                        break;

                    case 'fcnMeldeliste':
                        // FCN Meldeliste erstellen
                        vbaFunc = 'btn_FCN_Meldeliste_Click_FromHTML';
                        break;

                    case 'fuerthNamensliste':
                        // Fürth Namensliste erstellen
                        vbaFunc = 'btn_FuerthNamensliste_Click_FromHTML';
                        break;

                    case 'subStunden':
                        // Sub Stunden Export
                        vbaFunc = 'btn_stunden_sub_Click_FromHTML';
                        break;

                    case 'stundenMA':
                        // Stunden pro Mitarbeiter
                        vbaFunc = 'btnStundenMA_Click_FromHTML';
                        break;

                    case 'loewensaalSync':
                    case 'syncAuftraege':
                        // Aufträge synchronisieren (Löwensaal)
                        vbaFunc = 'HTML_btn_LoewensaalSync_Click';
                        break;

                    case 'standwachenAnlegen':
                        // Standwachen aus E-Mail anlegen (Stawas)
                        vbaFunc = 'Email_Zu_Auftrag';
                        break;

                    case 'hirschAnlegen':
                        // Hirsch Auftrag anlegen
                        vbaFunc = 'HirschImport_Starten';
                        break;

                    case 'loewensaalSyncHP':
                        // Löwensaal Homepage synchronisieren
                        vbaFunc = 'btn_LoewensaalSyncHP_Click_FromHTML';
                        break;

                    default:
                        console.warn('[Shell] Unbekannte Action:', action);
                        alert('Funktion "' + action + '" ist noch nicht implementiert.');
                        return;
                }

                // VBA Bridge aufrufen
                const response = await fetch(VBA_BRIDGE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        function: vbaFunc,
                        args: args
                    }),
                    signal: AbortSignal.timeout(30000) // 30 Sekunden Timeout
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('[Shell] VBA Ergebnis:', result);
                    if (result.error) {
                        alert('Fehler: ' + result.error);
                    }
                } else {
                    console.error('[Shell] VBA Bridge Fehler:', response.status);
                    alert('VBA Bridge Fehler (HTTP ' + response.status + ')');
                }
            } catch (e) {
                console.error('[Shell] VBA Action Fehler:', e);
                if (e.name === 'TimeoutError') {
                    alert('Zeitüberschreitung - die Funktion dauert zu lange.');
                } else {
                    alert('VBA Bridge nicht erreichbar.\\nBitte Access öffnen und VBA Bridge starten.');
                }
            }
        }

        // =====================================================
        // MENU POPUP (Menu 2) - Legacy, wird nicht mehr benötigt
        // =====================================================
        function openMenuPopup() {
            const overlay = document.getElementById('menuPopupOverlay');
            const frame = document.getElementById('menuPopupFrame');

            frame.src = 'frm_Menuefuehrung1.html';
            overlay.classList.add('active');
            document.getElementById('btnMenu2').classList.add('active');

            console.log('[Shell] Menu Popup geöffnet');
        }

        // VBA Bridge Server starten (unsichtbar via VBS Script)
        async function startVBABridgeServer() {
            // Pruefen ob bereits laeuft (mit mehreren Versuchen)
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const health = await fetch('http://localhost:5002/api/health', {
                        method: 'GET',
                        signal: AbortSignal.timeout(2000)
                    });
                    if (health.ok) {
                        console.log('[Shell] VBA Bridge Server laeuft bereits');
                        return true;
                    }
                } catch (e) {
                    console.log('[Shell] VBA Bridge Health-Check Versuch ' + (attempt + 1) + ' fehlgeschlagen');
                    if (attempt < 2) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            console.log('[Shell] Starte VBA Bridge Server...');

            // Falls WebView2: Ueber VBA starten
            if (TabState.isWebView2 && window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'START_VBA_BRIDGE',
                    requestId: 'shell-start-vba-bridge-' + Date.now()
                }));
                // Warten und erneut pruefen
                await new Promise(resolve => setTimeout(resolve, 3000));
                try {
                    const retry = await fetch('http://localhost:5002/api/health', {
                        method: 'GET',
                        signal: AbortSignal.timeout(2000)
                    });
                    if (retry.ok) {
                        console.log('[Shell] VBA Bridge Server erfolgreich gestartet');
                        return true;
                    }
                } catch (e) {
                    console.error('[Shell] VBA Bridge Server konnte nicht gestartet werden');
                }
            }

            // Browser-Modus: Nicht-blockierender Hinweis, Navigation trotzdem fortsetzen
            // VBA Bridge ist nur fuer E-Mail-Funktionen noetig, nicht fuer Navigation
            console.warn('[Shell] VBA Bridge Server nicht erreichbar - E-Mail-Funktionen eingeschraenkt');
            console.warn('[Shell] Zum Starten: start_vba_bridge.bat ausfuehren');
            // Kein Alert - Navigation soll trotzdem funktionieren
            return false;
        }

        // VBA Bridge Server beim Shell-Start im Hintergrund prüfen und starten
        async function checkAndStartVBABridge() {
            try {
                const health = await fetch('http://localhost:5002/api/health', {
                    method: 'GET',
                    signal: AbortSignal.timeout(2000)
                });
                if (health.ok) {
                    console.log('[Shell] VBA Bridge Server bereits aktiv');
                    return true;
                }
            } catch (e) {
                console.log('[Shell] VBA Bridge Server nicht erreichbar, starte im Hintergrund...');
            }

            // Server nicht erreichbar - versuche zu starten
            // Methode 1: WebView2 (wenn via Access geöffnet)
            if (TabState.isWebView2 && window.chrome && window.chrome.webview) {
                console.log('[Shell] Starte VBA Bridge via WebView2...');
                window.chrome.webview.postMessage(JSON.stringify({
                    action: 'START_VBA_BRIDGE',
                    requestId: 'shell-auto-start-' + Date.now()
                }));
            }
            // Methode 2: API Server (Browser-Modus) - NEU!
            else {
                console.log('[Shell] Browser-Modus: Starte VBA Bridge via API Server...');
                try {
                    const startResponse = await fetch('http://localhost:5000/api/start-vba-bridge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        signal: AbortSignal.timeout(5000)
                    });
                    if (startResponse.ok) {
                        const result = await startResponse.json();
                        console.log('[Shell] VBA Bridge Start-Anfrage:', result.status);
                        if (result.status === 'already_running') {
                            console.log('[Shell] VBA Bridge läuft bereits');
                            return true;
                        }
                    }
                } catch (e) {
                    console.warn('[Shell] VBA Bridge Start via API Server fehlgeschlagen:', e.message);
                }
            }

            // Retry nach 3 Sekunden (ohne Fehler-Alert)
            setTimeout(async () => {
                try {
                    const retry = await fetch('http://localhost:5002/api/health', {
                        method: 'GET',
                        signal: AbortSignal.timeout(2000)
                    });
                    if (retry.ok) {
                        console.log('[Shell] VBA Bridge Server erfolgreich gestartet (Auto-Start)');
                    }
                } catch (e) {
                    console.warn('[Shell] VBA Bridge Auto-Start fehlgeschlagen - E-Mail-Funktionen evtl. eingeschränkt');
                }
            }, 3000);

            return false;
        }

        function closeMenuPopup(event) {
            if (event && event.target && event.target.id !== 'menuPopupOverlay') {
                return;
            }

            const overlay = document.getElementById('menuPopupOverlay');
            const frame = document.getElementById('menuPopupFrame');
            const btnMenu2 = document.getElementById('btnMenu2');

            if (overlay) overlay.classList.remove('active');
            if (frame) frame.src = 'about:blank';
            if (btnMenu2) btnMenu2.classList.remove('active');

            console.log('[Shell] Menu Popup geschlossen');
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Menu Button Handler für Formulare
            document.querySelectorAll('.menu-btn[data-form]').forEach(btn => {
                btn.addEventListener('click', function() {
                    openTab(this.dataset.form);
                });
            });

            // Menu Button Handler für VBA-Actions (ehem. Menü 2)
            document.querySelectorAll('.menu-btn[data-action]').forEach(btn => {
                btn.addEventListener('click', function() {
                    handleVBAAction(this.dataset.action);
                });
            });

            // iframe Messages
            window.addEventListener('message', handleIframeMessage);

            // Browser Back/Forward
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.form) {
                    openTab(event.state.form, event.state.id);
                }
            });

            // URL Parameter beim Start
            const urlParams = new URLSearchParams(window.location.search);
            const formParam = urlParams.get('form');
            // Unterstütze sowohl 'id' als auch 'va_id', 'ma_id', 'kd_id' (Kompatibilität)
            const idParam = urlParams.get('id') || urlParams.get('va_id') || urlParams.get('ma_id') || urlParams.get('kd_id');

            // Zusätzliche Parameter sammeln (z.B. vadatum_id, vastart_id)
            const extraParams = {};
            for (const [key, value] of urlParams.entries()) {
                if (!['form', 'id', 'va_id', 'ma_id', 'kd_id', 'shell', '_t'].includes(key)) {
                    extraParams[key] = value;
                }
            }

            // Falls formParam vorhanden: Direkt öffnen ohne Default-Tab
            if (formParam) {
                // .html-Endung entfernen falls vorhanden (openTab fügt sie wieder hinzu)
                const formName = formParam.replace(/\.html$/, '');
                openTab(formName, idParam, extraParams);
            } else {
                // Kein formParam: Default-Tab öffnen (Auftragsverwaltung, gepinnt)
                openTab('frm_va_Auftragstamm');
                pinTab(TabState.tabs[0].id);
            }

            // WebView2 Bridge initialisieren
            initWebView2Bridge();

            // VBA Bridge Server beim Start prüfen (im Hintergrund)
            checkAndStartVBABridge();

            // ESC-Taste schliesst Menu Popup
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const overlay = document.getElementById('menuPopupOverlay');
                    if (overlay.classList.contains('active')) {
                        closeMenuPopup();
                    }
                }
            });

            // Tastenkürzel für Tabs: Ctrl+W schließt Tab
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'w') {
                    e.preventDefault();
                    if (TabState.activeTabId) {
                        closeTab(TabState.activeTabId);
                    }
                }
            });

            console.log('[Shell] Tab-Navigation initialisiert');
        });
    </script>
</body>
</html>

