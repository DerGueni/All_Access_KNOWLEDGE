<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kundenstammblatt - CONSEC</title>
    <link rel="stylesheet" href="../../css/app-layout.css">
    <link rel="stylesheet" href="../../theme/consys_theme.css">
    <style>
        :root {
            --header-gray: #D0D0D0;
            --btn-beige: #D7B395;
            --btn-green: #90EE90;
            --btn-blue: #6495ED;
            --bg-white: #FFFFFF;
            --bg-gray: #F0F0F0;
            --text-dark: #000000;
            --border-gray: #A6A6A6;
            --list-width: 32%;
            --list-min-width: 360px;
            --list-max-width: 520px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-white);
        }

        body.embedded .app-sidebar { display: none; }
        body.embedded .app-main { margin-left: 0; }

        .form-header {
            background: #4316B2;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 94px;
            height: 94px;
            max-height: 94px;
        }

        .nav-arrows {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #666;
            padding: 5px;
            border-radius: 3px;
        }

        .nav-arrows-row { display: flex; gap: 2px; }

        .nav-arrow {
            width: 24px;
            height: 24px;
            background: #4a4a4a;
            border: 1px solid #333;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .nav-arrow:hover { background: #5a5a5a; }

        .header-title {
            color: #fff;
            font-size: 18px;
            font-weight: bold;
        }
        .header-meta {
            margin-left: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
            font-size: 11px;
            color: #fff;
        }
        .header-meta .version { font-weight: bold; }

        .header-nav-btns {
            display: flex;
            background: #a0a0a0;
            padding: 3px;
            border-radius: 2px;
            gap: 1px;
        }

        .header-nav-btn {
            width: 22px;
            height: 22px;
            background: white;
            border: 1px solid #666;
            cursor: pointer;
            font-size: 10px;
        }

        .header-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-left: 20px;
        }

        .header-btn {
            padding: 6px 12px;
            border: 1px solid #666;
            cursor: pointer;
            font-size: 11px;
            background: var(--btn-beige);
        }

        .header-btn.blue { background: var(--btn-blue); color: white; }
        .header-btn.delete { background: #c44; color: white; }
        .header-btn.new { background: #4a4; color: white; }

        .customer-info {
            background: var(--header-gray);
            padding: 5px 15px 10px 15px;
            display: flex;
            justify-content: center;
        }

        .customer-name-box {
            background: white;
            padding: 10px 15px;
            max-width: 600px;
            width: 100%;
            flex: 1;
        }

        .customer-firma {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .customer-contact { font-size: 14px; }

        .form-area {
            display: flex;
            flex: 1;
            position: relative;
        }

        .tab-container {
            flex: 1;
            padding: 10px;
        }

        .tab-headers {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #ccc;
            background: #e8e8e8;
        }

        .tab-header {
            padding: 6px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            margin-right: 2px;
            margin-bottom: -1px;
            background: #d0d0d0;
            font-size: 10px;
        }

        .tab-header.active {
            background: white;
            border-bottom: 1px solid white;
        }

        .tab-header:hover:not(.active) { background: #c0c0c0; }

        .tab-content {
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            padding: 15px;
            min-height: 450px;
        }

        .tab-page { display: none; }
        .tab-page.active { display: block; }

        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .form-label {
            min-width: 120px;
            width: 120px;
            font-size: 11px;
            padding-right: 10px;
            flex-shrink: 0;
        }

        .form-input {
            flex: 1;
            min-width: 0;
            height: 22px;
            border: 1px solid var(--border-gray);
            padding: 2px 5px;
            font-size: 11px;
        }

        .form-input.wide { flex: 1; max-width: none; }
        .form-input.small { width: 80px; max-width: 80px; flex: none; }

        .form-checkbox { width: 15px; height: 15px; }

        .form-select {
            flex: 1;
            min-width: 0;
            height: 22px;
            border: 1px solid var(--border-gray);
            font-size: 11px;
        }

        .two-columns { display: flex; gap: 2%; flex-wrap: wrap; }
        .column { flex: 1; min-width: 400px; }

        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f8f8;
            border: 1px solid #ddd;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .right-list {
            width: var(--list-width);
            min-width: var(--list-min-width);
            max-width: var(--list-max-width);
            border-left: 1px solid #ccc;
            background: var(--bg-white);
            display: flex;
            flex-direction: column;
        }

        .list-header {
            padding: 8px;
            background: #e8e8e8;
            border-bottom: 1px solid #ccc;
        }

        .list-options {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .list-search {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .list-search input {
            width: 120px;
            height: 22px;
            border: 1px solid var(--border-gray);
            padding: 2px 5px;
            font-size: 11px;
        }

        .list-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: auto;
        }

        .list-table th {
            background: #d0d0d0;
            padding: 4px;
            text-align: left;
            border: 1px solid #a0a0a0;
            position: sticky;
            top: 0;
        }

        .list-table td {
            padding: 3px 4px;
            border: 1px solid #d0d0d0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 0;
        }

        .list-table tr:hover { background: #e8f4e8; }
        .list-table tr.selected { background: #4a90d9; color: white; }

        .status-bar {
            background: #E8E8E8;
            color: #666;
            padding: 2px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            min-height: 19px;
            border-top: 1px solid #CCC;
        }

        /* Responsive Design */
        @media (max-width: 1366px) {
            .right-list { min-width: 200px; }
            .column { min-width: 350px; }
        }
        @media (min-width: 1920px) {
            .right-list { width: 16%; }
        }
        @media (min-width: 2560px) {
            .right-list { width: 14%; max-width: 380px; }
        }
    </style>
</head>
<body data-active-menu="kundenverwaltung" data-menu-style="access">
    <div class="app-container">
        <aside class="app-sidebar"></aside>

        <main class="app-main">
            <div class="form-header">
                <div class="nav-arrows">
                    <div class="nav-arrow" id="btnUp">▲</div>
                    <div class="nav-arrows-row">
                        <div class="nav-arrow" id="btnFirst">◄◄</div>
                        <div class="nav-arrow" id="btnPrev">◄</div>
                        <div class="nav-arrow" id="btnNext">►</div>
                        <div class="nav-arrow" id="btnLast">►►</div>
                    </div>
                    <div class="nav-arrow" id="btnDown">▼</div>
                </div>

                <span class="header-title" id="Auto_Kopfzeile0">Kundenstammblatt</span>

                <div class="header-nav-btns">
                    <button class="header-nav-btn">⏮</button>
                    <button class="header-nav-btn">◄</button>
                    <button class="header-nav-btn">►</button>
                    <button class="header-nav-btn">⏭</button>
                </div>
                <div class="header-nav-btns">
                    <button class="header-nav-btn" id="Befehl43">⏮</button>
                    <button class="header-nav-btn" id="Befehl41">◄</button>
                    <button class="header-nav-btn" id="Befehl40">►</button>
                    <button class="header-nav-btn" id="Befehl39">⏭</button>
                    <button class="header-nav-btn" id="Befehl46">⟲</button>
                </div>

                <div class="header-buttons">
                    <button class="header-btn blue">Verrechnungssätze</button>
                    <button class="header-btn blue">Umsatzauswertung</button>
                </div>

                <div style="margin-left: auto; display: flex; align-items: center; gap: 10px; color: #fff;">
                    <label>Kunden-Nr.</label>
                    <input type="text" id="kundenNr" style="width: 50px; height: 22px; text-align: center;">
                </div>

                <div class="header-buttons">
                    <button class="header-btn delete" id="mcobtnDelete">Kunden löschen</button>
                    <button class="header-btn new" id="btnNewKunde">Neuer Kunde</button>
                </div>
                <div class="header-meta">
                    <span id="lbl_Datum">--.--.----</span>
                    <span class="version" id="lbl_Version">GPT | TEST</span>
                </div>
            </div>

            <div class="customer-info">
                <div class="customer-name-box">
                    <div class="customer-firma" id="displayFirma">Firmenname</div>
                    <div class="customer-contact" id="displayContact">Ansprechpartner</div>
                    <div style="font-size:12px;margin-top:3px;" id="displayBezeichnung"></div>
                </div>
            </div>

            <div class="form-area">
                <div class="tab-container">
                    <div class="tab-headers">
                        <div class="tab-header active" data-tab="pgMain">Stammdaten</div>
                        <div class="tab-header" data-tab="pgPreise">Konditionen</div>
                        <div class="tab-header" data-tab="pgAuftrUeb">Auftragsübersicht</div>
                        <div class="tab-header" data-tab="pgAnsprech">Ansprechpartner</div>
                        <div class="tab-header" data-tab="pgAttach">Zusatzdateien</div>
                        <div class="tab-header" data-tab="pgBemerk">Bemerkungen</div>
                        <div class="tab-header" data-tab="pg_Ang">Angebote</div>
                    </div>

                    <div class="tab-content">
                        <div class="tab-page active" id="tab-pgMain">
                            <div class="checkbox-group">
                                <div class="checkbox-item"><input type="checkbox" class="form-checkbox" id="kun_IstAktiv" data-field="kun_IstAktiv" checked><label>Ist aktiv</label></div>
                                <div class="checkbox-item"><input type="checkbox" class="form-checkbox" id="kun_IstSammelRechnung" data-field="kun_IstSammelRechnung"><label>Sammelrechnung</label></div>
                                <div class="checkbox-item"><input type="checkbox" class="form-checkbox" id="kun_ans_manuell" data-field="kun_ans_manuell"><label>Anschrift manuell</label></div>
                            </div>

                            <div class="two-columns">
                                <div class="column">
                                    <div class="form-row"><label class="form-label">Firma</label><input type="text" class="form-input wide" id="kun_Firma" data-field="kun_Firma"></div>
                                    <div class="form-row"><label class="form-label">Bezeichnung</label><input type="text" class="form-input wide" id="kun_bezeichnung" data-field="kun_bezeichnung"></div>
                                    <div class="form-row"><label class="form-label">Kunden-Kürzel</label><input type="text" class="form-input wide" id="kun_Matchcode" data-field="kun_Matchcode"></div>
                                    <div class="form-row"><label class="form-label">Straße</label><input type="text" class="form-input wide" id="kun_Strasse" data-field="kun_Strasse"></div>
                                    <div class="form-row"><label class="form-label">PLZ</label><input type="text" class="form-input wide" id="kun_PLZ" data-field="kun_PLZ"></div>
                                    <div class="form-row"><label class="form-label">Ort</label><input type="text" class="form-input wide" id="kun_Ort" data-field="kun_Ort"></div>
                                    <div class="form-row"><label class="form-label">Land</label><select class="form-select" id="kun_LKZ" data-field="kun_LKZ"><option value="DE">DE</option><option value="AT">AT</option><option value="CH">CH</option></select></div>
                                    <div class="form-row"><label class="form-label">Telefon</label><input type="text" class="form-input wide" id="kun_telefon" data-field="kun_telefon"></div>
                                    <div class="form-row"><label class="form-label">Mobil</label><input type="text" class="form-input wide" id="kun_mobil" data-field="kun_mobil"></div>
                                    <div class="form-row"><label class="form-label">Telefax</label><input type="text" class="form-input wide" id="kun_telefax" data-field="kun_telefax"></div>
                                    <div class="form-row"><label class="form-label">E-Mail</label><input type="text" class="form-input wide" id="kun_email" data-field="kun_email"></div>
                                    <div class="form-row"><label class="form-label">Homepage</label><input type="text" class="form-input wide" id="kun_URL" data-field="kun_URL"></div>
                                </div>

                                <div class="column">
                                    <div class="form-row"><label class="form-label">Kreditinstitut</label><input type="text" class="form-input wide" id="kun_kreditinstitut" data-field="kun_kreditinstitut"></div>
                                    <div class="form-row"><label class="form-label">BLZ</label><input type="text" class="form-input wide" id="kun_blz" data-field="kun_blz"></div>
                                    <div class="form-row"><label class="form-label">Kontonummer</label><input type="text" class="form-input wide" id="kun_kontonummer" data-field="kun_kontonummer"></div>
                                    <div class="form-row"><label class="form-label">IBAN</label><input type="text" class="form-input wide" id="kun_iban" data-field="kun_iban"></div>
                                    <div class="form-row"><label class="form-label">BIC</label><input type="text" class="form-input wide" id="kun_bic" data-field="kun_bic"></div>
                                    <div class="form-row"><label class="form-label">UStIDNr.</label><input type="text" class="form-input wide" id="kun_ustidnr" data-field="kun_ustidnr"></div>
                                    <div class="form-row"><label class="form-label">Zahlungsbedingung</label><select class="form-select" id="kun_Zahlbed" data-field="kun_Zahlbed"><option value="6">Netto 6 Tage</option><option value="7">Netto 7 Tage</option><option value="14">Netto 14 Tage</option><option value="30">Netto 30 Tage</option></select></div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-page" id="tab-pgPreise">
                            <p style="padding:20px; color:#666;">Konditionen - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgAuftrUeb">
                            <p style="padding:20px; color:#666;">Auftragsübersicht - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgAnsprech">
                            <p style="padding:20px; color:#666;">Ansprechpartner - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgAttach">
                            <p style="padding:20px; color:#666;">Zusatzdateien - Daten werden geladen...</p>
                        </div>

                        <div class="tab-page" id="tab-pgBemerk">
                            <h3 style="margin-bottom:10px;">Bemerkungen</h3>
                            <div class="form-row">
                                <label class="form-label">Anschreiben</label>
                                <textarea class="form-input wide" id="kun_Anschreiben" data-field="kun_Anschreiben" rows="3" style="height:auto;width:500px;"></textarea>
                            </div>
                            <div class="form-row">
                                <label class="form-label">Briefkopf</label>
                                <textarea class="form-input wide" id="kun_BriefKopf" data-field="kun_BriefKopf" rows="4" style="height:auto;width:500px;"></textarea>
                            </div>
                            <div class="form-row">
                                <label class="form-label">Memo</label>
                                <textarea class="form-input wide" id="kun_memo" data-field="kun_memo" rows="8" style="height:auto;width:500px;"></textarea>
                            </div>
                        </div>

                        <div class="tab-page" id="tab-pg_Ang">
                            <p style="padding:20px; color:#666;">Angebote - Daten werden geladen...</p>
                        </div>
                    </div>
                </div>

                <div class="right-list">
                    <div class="list-header">
                        <div class="list-options">
                            <input type="checkbox" id="nurAktive" checked>
                            <label for="nurAktive">Nur Aktive</label>
                        </div>
                        <div class="list-search">
                            <label>Suche:</label>
                            <input type="text" id="searchInput">
                        </div>
                    </div>
                    <div class="list-content" tabindex="0">
                        <table class="list-table">
                            <thead>
                                <tr>
                                    <th>Nr</th>
                                    <th>Firma</th>
                                    <th>Nachname</th>
                                    <th>Vorname</th>
                                    <th>Ort</th>
                                </tr>
                            </thead>
                            <tbody id="kdListBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <footer class="app-footer">
                <span>Erstellt am: <span id="erstelltAm">-</span> von <span id="erstelltVon">-</span></span>
                <span>Geändert am: <span id="geaendertAm">-</span> von <span id="geaendertVon">-</span></span>
            </footer>
        </main>
    </div>

    <script src="../../js/sidebar.js"></script>
    <script src="../../js/api-autostart.js"></script>
    <script src="logic/access_aliases.js"></script>

    <!-- Access-ID Platzhalter (unsichtbar) -->
    <div style="display:none;">
        <input id="kun_ID" data-field="kun_Id">
        <input id="kun_firma" data-field="kun_Firma">
        <input id="kun_strasse" data-field="kun_Strasse">
        <input id="kun_plz" data-field="kun_PLZ">
        <input id="kun_ort" data-field="kun_Ort">
        <input id="kun_mobil" data-field="kun_Mobil">
        <input id="Erst_von" data-field="Erst_von">
        <input id="Erst_am" data-field="Erst_am">
        <input id="Aend_von" data-field="Aend_von">
        <input id="Aend_am" data-field="Aend_am">
        <select id="kun_IDF_PersonID" data-field="kun_IDF_PersonID"></select>
        <select id="lst_KD"></select>
        <div id="sub_KD_Standardpreise"></div>
        <div id="sub_KD_Auftragskopf"></div>
        <div id="sub_KD_Rch_Auftragspos"></div>
        <div id="sub_ZusatzDateien"></div>
        <div id="sub_Ansprechpartner"></div>
    </div>
    <script>
        const API_URL = 'http://localhost:5000/api';

        let kundenList = [];
        let currentIndex = 0;
        let currentRecord = null;

        function updateHeaderDate() {
            const lbl = document.getElementById('lbl_Datum');
            if (lbl) lbl.textContent = new Date().toLocaleDateString('de-DE');
        }

        // Tab switching
        document.querySelectorAll('.tab-header').forEach(header => {
            header.addEventListener('click', () => {
                const tabId = header.dataset.tab;
                document.querySelectorAll('.tab-header').forEach(h => h.classList.remove('active'));
                header.classList.add('active');
                document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        async function loadKunden() {
            try {
                const aktiv = document.getElementById('nurAktive').checked;
                const url = `${API_URL}/kunden?aktiv=${aktiv}`;

                const response = await fetch(url);
                const result = await response.json();
                kundenList = result.data || [];

                renderKundenList();
                if (kundenList.length > 0) {
                    await showRecord(0);
                }
            } catch (error) {
                console.error('Fehler:', error);
            }
        }

        function renderKundenList() {
            const tbody = document.getElementById('kdListBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            tbody.innerHTML = '';

            kundenList.forEach((kd, index) => {
                const firma = kd.kun_Firma || '';
                const nachname = kd.adr_Nachname || kd.kun_AP_Name || '';
                const vorname = kd.adr_Vorname || '';
                const ort = kd.kun_Ort || '';
                const searchBlob = `${firma} ${nachname} ${vorname} ${ort}`.toLowerCase();
                if (search && !searchBlob.includes(search)) return;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${kd.kun_Id || ''}</td>
                    <td>${firma}</td>
                    <td>${nachname}</td>
                    <td>${vorname}</td>
                    <td>${ort.substring(0, 8)}</td>
                `;
                tr.addEventListener('click', async () => {
                    document.querySelectorAll('.list-table tr').forEach(r => r.classList.remove('selected'));
                    tr.classList.add('selected');
                    await showRecord(index);
                });
                tbody.appendChild(tr);
            });
        }

        async function showRecord(index) {
            if (index < 0 || index >= kundenList.length) return;

            currentIndex = index;
            const kunId = kundenList[index].kun_Id;

            try {
                const response = await fetch(`${API_URL}/kunden/${kunId}`);
                const result = await response.json();
                currentRecord = result.data?.kunde || result.data || kundenList[index];
            } catch (error) {
                console.error('Fehler:', error);
                currentRecord = kundenList[index];
            }

            document.getElementById('displayFirma').textContent = currentRecord.kun_Firma || '';
            document.getElementById('displayContact').textContent = currentRecord.kun_Bezeichnung || '';
            document.getElementById('displayBezeichnung').textContent = currentRecord.kun_bezeichnung || '';
            document.getElementById('kundenNr').value = currentRecord.kun_Id || '';
            if (window.AccessAliases) {
                AccessAliases.setValue('lst_KD', currentRecord.kun_Id || '');
            }

            document.querySelectorAll('[data-field]').forEach(el => {
                const field = el.dataset.field;
                let value = currentRecord[field];

                // Clean HTML from URL field
                if (field === 'kun_URL' && value) {
                    const match = value.match(/href="([^"]+)"/);
                    value = match ? match[1] : value.replace(/<[^>]+>/g, '').trim();
                }

                if (el.type === 'checkbox') {
                    el.checked = !!value;
                } else if (el.tagName === 'SELECT') {
                    el.value = value || '';
                } else if (el.tagName === 'TEXTAREA') {
                    el.value = value || '';
                } else {
                    el.value = value || '';
                }
            });

            if (currentRecord.Erst_am) {
                const d = new Date(currentRecord.Erst_am);
                document.getElementById('erstelltAm').textContent = d.toLocaleDateString('de-DE', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'});
            }
            document.getElementById('erstelltVon').textContent = currentRecord.Erst_von || '-';

            if (currentRecord.Aend_am) {
                const d = new Date(currentRecord.Aend_am);
                document.getElementById('geaendertAm').textContent = d.toLocaleDateString('de-DE', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'});
            }
            document.getElementById('geaendertVon').textContent = currentRecord.Aend_von || '-';

            const rows = document.querySelectorAll('.list-table tbody tr');
            rows.forEach((row, i) => row.classList.toggle('selected', i === index));
            rows[index]?.scrollIntoView({ block: 'nearest' });
        }

        function clearForm() {
            document.querySelectorAll('[data-field]').forEach(el => {
                if (el.type === 'checkbox') el.checked = false;
                else el.value = '';
            });
            document.getElementById('displayFirma').textContent = '';
            document.getElementById('displayContact').textContent = '';
            document.getElementById('displayBezeichnung').textContent = '';
            document.getElementById('kundenNr').value = '';
            currentRecord = null;
        }

        async function deleteKunde() {
            if (!currentRecord?.kun_Id) {
                alert('Kein Kunde ausgewählt');
                return;
            }
            if (!confirm('Kunde wirklich löschen?')) return;
            try {
                await fetch(`${API_URL}/kunden/${currentRecord.kun_Id}`, { method: 'DELETE' });
                await loadKunden();
            } catch (error) {
                alert('Löschen fehlgeschlagen');
            }
        }

        document.getElementById('btnFirst')?.addEventListener('click', () => showRecord(0));
        document.getElementById('btnPrev')?.addEventListener('click', () => showRecord(currentIndex - 1));
        document.getElementById('btnNext')?.addEventListener('click', () => showRecord(currentIndex + 1));
        document.getElementById('btnLast')?.addEventListener('click', () => showRecord(kundenList.length - 1));
        document.getElementById('Befehl43')?.addEventListener('click', () => showRecord(0));
        document.getElementById('Befehl41')?.addEventListener('click', () => showRecord(currentIndex - 1));
        document.getElementById('Befehl40')?.addEventListener('click', () => showRecord(currentIndex + 1));
        document.getElementById('Befehl39')?.addEventListener('click', () => showRecord(kundenList.length - 1));
        document.getElementById('Befehl46')?.addEventListener('click', () => loadKunden());
        document.getElementById('mcobtnDelete')?.addEventListener('click', deleteKunde);
        document.getElementById('btnNewKunde')?.addEventListener('click', clearForm);

        document.getElementById('searchInput')?.addEventListener('input', renderKundenList);
        document.getElementById('nurAktive')?.addEventListener('change', loadKunden);
        document.querySelector('.list-content')?.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                showRecord(Math.min(currentIndex + 1, kundenList.length - 1));
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                showRecord(Math.max(currentIndex - 1, 0));
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get('embedded') === '1') {
                document.body.classList.add('embedded');
            }
            if (window.ApiAutostart) {
                await window.ApiAutostart.init();
            }
            if (window.AccessAliases) {
                AccessAliases.link('kun_strasse', 'kun_Strasse');
                AccessAliases.link('kun_plz', 'kun_PLZ');
                AccessAliases.link('kun_ort', 'kun_Ort');
                AccessAliases.link('kun_firma', 'kun_Firma');
                AccessAliases.link('kun_ID', 'kundenNr');
                AccessAliases.link('NurAktiveKD', 'nurAktive');
                AccessAliases.link('lst_KD', 'kundenNr');
            }
            updateHeaderDate();
            loadKunden();
        });
    </script>
<div id="__access_missing_controls" style="display:none">
  <input type="text" id="cboSuchPLZ" data-access-id="cboSuchPLZ" />
  <input type="text" id="Bezeichnungsfeld294" data-access-id="Bezeichnungsfeld294" />
  <input type="text" id="cboSuchOrt" data-access-id="cboSuchOrt" />
  <input type="text" id="Bezeichnungsfeld330" data-access-id="Bezeichnungsfeld330" />
  <input type="text" id="btnAlle" data-access-id="btnAlle" />
  <input type="text" id="Rechteck37" data-access-id="Rechteck37" />
  <input type="text" id="cboKDNrSuche" data-access-id="cboKDNrSuche" />
  <input type="text" id="Bezeichnungsfeld456" data-access-id="Bezeichnungsfeld456" />
  <input type="text" id="btnUmsAuswert" data-access-id="btnUmsAuswert" />
  <input type="text" id="btnRibbonAus" data-access-id="btnRibbonAus" />
  <input type="text" id="btnRibbonEin" data-access-id="btnRibbonEin" />
  <input type="text" id="btnDaBaEin" data-access-id="btnDaBaEin" />
  <input type="text" id="btnDaBaAus" data-access-id="btnDaBaAus" />
  <input type="text" id="btnAuswertung" data-access-id="btnAuswertung" />
  <input type="text" id="RegStammKunde" data-access-id="RegStammKunde" />
  <input type="text" id="pgMain" data-access-id="pgMain" />
  <input type="text" id="Bezeichnungsfeld418" data-access-id="Bezeichnungsfeld418" />
  <input type="text" id="Bezeichnungsfeld42" data-access-id="Bezeichnungsfeld42" />
  <input type="text" id="Bezeichnungsfeld237" data-access-id="Bezeichnungsfeld237" />
  <input type="text" id="Bezeichnungsfeld45" data-access-id="Bezeichnungsfeld45" />
  <input type="text" id="Bezeichnungsfeld48" data-access-id="Bezeichnungsfeld48" />
  <input type="text" id="Bezeichnungsfeld12" data-access-id="Bezeichnungsfeld12" />
  <input type="text" id="Bezeichnungsfeld51" data-access-id="Bezeichnungsfeld51" />
  <input type="text" id="Bezeichnungsfeld18" data-access-id="Bezeichnungsfeld18" />
  <input type="text" id="Bezeichnungsfeld54" data-access-id="Bezeichnungsfeld54" />
  <input type="text" id="Bezeichnungsfeld21" data-access-id="Bezeichnungsfeld21" />
  <input type="text" id="Bezeichnungsfeld57" data-access-id="Bezeichnungsfeld57" />
  <input type="text" id="Bezeichnungsfeld370" data-access-id="Bezeichnungsfeld370" />
  <input type="text" id="Bezeichnungsfeld27" data-access-id="Bezeichnungsfeld27" />
  <input type="text" id="Bezeichnungsfeld30" data-access-id="Bezeichnungsfeld30" />
  <input type="text" id="Bezeichnungsfeld372" data-access-id="Bezeichnungsfeld372" />
  <input type="text" id="Bezeichnungsfeld33" data-access-id="Bezeichnungsfeld33" />
  <input type="text" id="Bezeichnungsfeld36" data-access-id="Bezeichnungsfeld36" />
  <input type="text" id="Bezeichnungsfeld24" data-access-id="Bezeichnungsfeld24" />
  <input type="text" id="Bezeichnungsfeld214" data-access-id="Bezeichnungsfeld214" />
  <input type="text" id="Bezeichnungsfeld223" data-access-id="Bezeichnungsfeld223" />
  <input type="text" id="adr_mobil" data-access-id="adr_mobil" />
  <input type="text" id="Bezeichnungsfeld218" data-access-id="Bezeichnungsfeld218" />
  <input type="text" id="adr_eMail" data-access-id="adr_eMail" />
  <input type="text" id="Bezeichnungsfeld356" data-access-id="Bezeichnungsfeld356" />
  <input type="text" id="Anschreiben" data-access-id="Anschreiben" />
  <input type="text" id="Bezeichnungsfeld267" data-access-id="Bezeichnungsfeld267" />
  <input type="text" id="adr_telefon" data-access-id="adr_telefon" />
  <input type="text" id="Bezeichnungsfeld216" data-access-id="Bezeichnungsfeld216" />
  <input type="text" id="kun_land_vorwahl" data-access-id="kun_land_vorwahl" />
  <input type="text" id="Bezeichnungsfeld246" data-access-id="Bezeichnungsfeld246" />
  <input type="text" id="Bezeichnungsfeld63" data-access-id="Bezeichnungsfeld63" />
  <input type="text" id="kun_geloescht" data-access-id="kun_geloescht" />
  <input type="text" id="Bezeichnungsfeld212" data-access-id="Bezeichnungsfeld212" />
  <input type="text" id="pgPreise" data-access-id="pgPreise" />
  <input type="text" id="Auftragsbersicht" data-access-id="Auftragsbersicht" />
  <input type="text" id="Bezeichnungsfeld424" data-access-id="Bezeichnungsfeld424" />
  <input type="text" id="Bezeichnungsfeld426" data-access-id="Bezeichnungsfeld426" />
  <input type="text" id="KD_Ges" data-access-id="KD_Ges" />
  <input type="text" id="Bezeichnungsfeld428" data-access-id="Bezeichnungsfeld428" />
  <input type="text" id="KD_VJ" data-access-id="KD_VJ" />
  <input type="text" id="Bezeichnungsfeld430" data-access-id="Bezeichnungsfeld430" />
  <input type="text" id="KD_LJ" data-access-id="KD_LJ" />
  <input type="text" id="Bezeichnungsfeld432" data-access-id="Bezeichnungsfeld432" />
  <input type="text" id="KD_LM" data-access-id="KD_LM" />
  <input type="text" id="Bezeichnungsfeld434" data-access-id="Bezeichnungsfeld434" />
  <input type="text" id="btnAufRchPDF" data-access-id="btnAufRchPDF" />
  <input type="text" id="btnAufRchPosPDF" data-access-id="btnAufRchPosPDF" />
  <input type="text" id="btnAufEinsPDF" data-access-id="btnAufEinsPDF" />
  <input type="text" id="PosGesamtsumme" data-access-id="PosGesamtsumme" />
  <input type="text" id="Bezeichnungsfeld439" data-access-id="Bezeichnungsfeld439" />
  <input type="text" id="pg_Rch_Kopf" data-access-id="pg_Rch_Kopf" />
  <input type="text" id="Rechteck414" data-access-id="Rechteck414" />
  <input type="text" id="Bezeichnungsfeld415" data-access-id="Bezeichnungsfeld415" />
  <input type="text" id="Bezeichnungsfeld413" data-access-id="Bezeichnungsfeld413" />
  <input type="text" id="Rechteck412" data-access-id="Rechteck412" />
  <input type="text" id="Bezeichnungsfeld105" data-access-id="Bezeichnungsfeld105" />
  <input type="text" id="Bezeichnungsfeld106" data-access-id="Bezeichnungsfeld106" />
  <input type="text" id="Bezeichnungsfeld107" data-access-id="Bezeichnungsfeld107" />
  <input type="text" id="Bezeichnungsfeld411" data-access-id="Bezeichnungsfeld411" />
  <input type="text" id="Bezeichnungsfeld92" data-access-id="Bezeichnungsfeld92" />
  <input type="text" id="Bezeichnungsfeld95" data-access-id="Bezeichnungsfeld95" />
  <input type="text" id="Bezeichnungsfeld98" data-access-id="Bezeichnungsfeld98" />
  <input type="text" id="UmsNGes1" data-access-id="UmsNGes1" />
  <input type="text" id="Bezeichnungsfeld384" data-access-id="Bezeichnungsfeld384" />
  <input type="text" id="PersGes1" data-access-id="PersGes1" />
  <input type="text" id="StdGes1" data-access-id="StdGes1" />
  <input type="text" id="UmsGes1" data-access-id="UmsGes1" />
  <input type="text" id="Std51" data-access-id="Std51" />
  <input type="text" id="Pers51" data-access-id="Pers51" />
  <input type="text" id="Std61" data-access-id="Std61" />
  <input type="text" id="Pers61" data-access-id="Pers61" />
  <input type="text" id="Std71" data-access-id="Std71" />
  <input type="text" id="Pers71" data-access-id="Pers71" />
  <input type="text" id="AufAnz1" data-access-id="AufAnz1" />
  <input type="text" id="Bezeichnungsfeld392" data-access-id="Bezeichnungsfeld392" />
  <input type="text" id="UmsNGes2" data-access-id="UmsNGes2" />
  <input type="text" id="Bezeichnungsfeld388" data-access-id="Bezeichnungsfeld388" />
  <input type="text" id="AufAnz2" data-access-id="AufAnz2" />
  <input type="text" id="Bezeichnungsfeld394" data-access-id="Bezeichnungsfeld394" />
  <input type="text" id="PersGes2" data-access-id="PersGes2" />
  <input type="text" id="StdGes2" data-access-id="StdGes2" />
  <input type="text" id="UmsGes2" data-access-id="UmsGes2" />
  <input type="text" id="Std52" data-access-id="Std52" />
  <input type="text" id="Pers52" data-access-id="Pers52" />
  <input type="text" id="Std62" data-access-id="Std62" />
  <input type="text" id="Pers62" data-access-id="Pers62" />
  <input type="text" id="Std72" data-access-id="Std72" />
  <input type="text" id="Pers72" data-access-id="Pers72" />
  <input type="text" id="UmsNGes3" data-access-id="UmsNGes3" />
  <input type="text" id="Bezeichnungsfeld390" data-access-id="Bezeichnungsfeld390" />
  <input type="text" id="AufAnz3" data-access-id="AufAnz3" />
  <input type="text" id="Bezeichnungsfeld396" data-access-id="Bezeichnungsfeld396" />
  <input type="text" id="PersGes3" data-access-id="PersGes3" />
  <input type="text" id="StdGes3" data-access-id="StdGes3" />
  <input type="text" id="UmsGes3" data-access-id="UmsGes3" />
  <input type="text" id="Std53" data-access-id="Std53" />
  <input type="text" id="Pers53" data-access-id="Pers53" />
  <input type="text" id="Std63" data-access-id="Std63" />
  <input type="text" id="Pers63" data-access-id="Pers63" />
  <input type="text" id="Std73" data-access-id="Std73" />
  <input type="text" id="Pers73" data-access-id="Pers73" />
  <input type="text" id="pg_Ang" data-access-id="pg_Ang" />
  <input type="text" id="sub_Rch_Kopf_Ang" data-access-id="sub_Rch_Kopf_Ang" />
  <input type="text" id="pgAttach" data-access-id="pgAttach" />
  <input type="text" id="btnNeuAttach" data-access-id="btnNeuAttach" />
  <input type="text" id="Bezeichnungsfeld355" data-access-id="Bezeichnungsfeld355" />
  <input type="text" id="pgAnsprech" data-access-id="pgAnsprech" />
  <input type="text" id="pgBemerk" data-access-id="pgBemerk" />
  <input type="text" id="Bezeichnungsfeld253" data-access-id="Bezeichnungsfeld253" />
  <input type="text" id="Bezeichnungsfeld236" data-access-id="Bezeichnungsfeld236" />
  <input type="text" id="kun_AdressArt" data-access-id="kun_AdressArt" />
  <input type="text" id="Bezeichnungsfeld348" data-access-id="Bezeichnungsfeld348" />
  <input type="text" id="TabellenNr" data-access-id="TabellenNr" />
  <input type="text" id="Men" data-access-id="Men" />
  <input type="text" id="Bezeichnungsfeld422" data-access-id="Bezeichnungsfeld422" />
  <input type="text" id="Textschnell" data-access-id="Textschnell" />
  <input type="text" id="Bezeichnungsfeld333" data-access-id="Bezeichnungsfeld333" />
  <input type="text" id="NurAktiveKD" data-access-id="NurAktiveKD" />
  <input type="text" id="lbl_nur_aktive_anzeigen" data-access-id="lbl_nur_aktive_anzeigen" />
  <input type="text" id="cbo_Auswahl" data-access-id="cbo_Auswahl" />
  <input type="text" id="Zusatzanzeige__Bezeichnungsfeld" data-access-id="Zusatzanzeige:_Bezeichnungsfeld" />
  <input type="text" id="Text473" data-access-id="Text473" />
  <input type="text" id="Bezeichnungsfeld188" data-access-id="Bezeichnungsfeld188" />
  <input type="text" id="Bezeichnungsfeld194" data-access-id="Bezeichnungsfeld194" />
  <input type="text" id="Bezeichnungsfeld196" data-access-id="Bezeichnungsfeld196" />
  <input type="text" id="Bezeichnungsfeld198" data-access-id="Bezeichnungsfeld198" />
</div>
</body>
</html>
