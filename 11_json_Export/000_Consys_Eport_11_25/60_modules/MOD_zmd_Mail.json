{"id":"MOD_zmd_Mail","name":"zmd_Mail","kind":"standard","procedures":["Public subRC       As String","Function Anfragen(ByVal MA_ID As Integer, ByVal VA_ID As Long, _","Function setInfo(Criteria As String)","Function setze_Angefragt(MA_ID As Integer, VA_ID As Long, VADatum_ID As Long, VAStart_ID As Long) As String","Function Texte_lesen(ByVal MA_ID As String, ByVal VA_ID As String, ByVal VADatum_ID As String, ByVal VAStart_ID As String) As String","Function create_URL(MD5 As String, ByVal MA_ID As String, MAemail As String, ByVal VA_ID As String, _","Function create_Mail(ByVal MA_ID As Integer, ByVal VA_ID As Long, ByVal VADatum_ID As Long, ByVal VAStart_ID As Long, Mailtype As Integer, Optional ByVal Attachment As String) As String","subRC = Texte_lesen(MA_ID, VA_ID, VADatum_ID, VAStart_ID)","Subject = \"CONSEC Anfrage zu \" & VA_Text & \", \" & VADatum & \" in \" & VA_Ort","Subject = \"Deine Rückmeldung ist angekommen \" & VA_Text & \", \" & VADatum & \" in \" & VA_Ort 'HIER noch unterscheiden-->ABSAGE /ZUSAGE","Function create_HTML(txtfile As String) As String","Function send_Mail(Email As String, Subject As String, Body As String, Optional Attachment As String) As String","Function Dienstplan_senden(MA_ID As Integer, von As Date, bis As Date) As String","Subject = \"Dienstplan ab \" & von","Function Lohnabrechnung_ermitteln(ByVal LexID As Long, Optional Jahr As Integer, Optional Monat As Integer) As String","Function Lohnabrechnung_senden(LexID As Long, Monat As String, Jahr As String, Datei As String) As String","Subject = \"Consec Lohnabrechnung \" & Monat","Function pdf_erstellen_einsatzliste_sub(VA_ID As Long, MA_ID As Long) As String"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":["INSERT INTO tbl_Log_eMail_Sent(SendDate,Absender,Betreff,MailText,BCC,VA_ID,IstHTML)","INSERT INTO tbl_Log_eMail_Sent(SendDate,Absender,Betreff,MailText,BCC,IstHTML)"],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n    \n    'Für Mailversand\n    Const cdoSendUsingMethod = \"http://schemas.microsoft.com/cdo/configuration/sendusing\"\n    Const cdoSMTPUseSSL = \"http://schemas.microsoft.com/cdo/configuration/smtpusessl\"\n    Const cdoSendUsingPort = 2\n    Const cdoSMTPServer = \"http://schemas.microsoft.com/cdo/configuration/smtpserver\"\n    Const cdoSMTPServerPort = \"http://schemas.microsoft.com/cdo/configuration/smtpserverport\"\n    Const cdoSMTPConnectionTimeout = \"http://schemas.microsoft.com/cdo/configuration/smtpconnectiontimeout\"\n    Const cdoSMTPAuthenticate = \"http://schemas.microsoft.com/cdo/configuration/smtpauthenticate\"\n    Const cdoBasic = 1\n    Const cdoSendUserName = \"http://schemas.microsoft.com/cdo/configuration/sendusername\"\n    Const cdoSendPassword = \"http://schemas.microsoft.com/cdo/configuration/sendpassword\"\n\n\n    Public MD5         As String\n    Public subRC       As String\n    Public VName       As String\n    Public NName       As String\n    Public Email       As String\n    Public VA_Text     As String\n    Public VA_Ort      As String\n    Public VA_Objekt   As String\n    Public VADatum     As String 'Besser wäre MVA_Datum, dieses wird gelesen!\n    Public VA_Uhrzeit  As String 'Besser wäre MVA_Uhrzeit, diese wird gelesen!\n    Public VA_Ende     As String\n    Public DC          As String\n    Public TP          As String\n    Public TPZeit      As String\n    Public Sender      As String\n    \n    \n'Mitarbeiter für Veranstaltung anfragen\nFunction Anfragen(ByVal MA_ID As Integer, ByVal VA_ID As Long, _\n    ByVal VADatum_ID As Long, ByVal VAStart_ID As Long) As String\n    \nDim check           As String\nDim Status          As Integer\nDim Criteria        As String\nDim CRITERIAFORINFO As String\nDim sql             As String\n    \n'    'Texte nachlesen\n'    subRC = Texte_lesen(MA_ID, VA_ID, VADatum_ID, VAStart_ID)\n    \n    'Prüfen, ob der Mitarbeiter eine Email-Adresse hat\n    If IsNull(TLookup(\"Email\", MASTAMM, \"ID = \" & MA_ID)) Then\n        Anfragen = \">HAT KEINE EMAIL\"\n            \n    Else\n        'MD5 Hash erzeugen\n        MD5 = FnsCalculateMD5(MA_ID & VA_ID & VADatum_ID & Email)\n        \n'        'Fehler beim Lesen der Texte - > Nicht mehr gebraucht\n'        If subRC <> \"\" Then\n'            Anfragen = \"Fehler beim Lesen der Texte von MA_ID \" & MA_ID & \": \" & subRC\n'            Exit Function\n'        End If\n        \n        Criteria = \"MA_ID = \" & MA_ID & \" AND VA_ID = \" & VA_ID & _\n            \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID\n            \n        CRITERIAFORINFO = \"VA_ID = \" & VA_ID & _\n            \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID & \" AND MA_ID = 0 AND IstFraglich = False\"\n            \n        Status = TLookup(\"Status_ID\", PLANUNG, Criteria)\n        'Status 1 bis 4:  1=Geplant, 2=Benachrichtigt, 3=Zusage, 4 =Absage\n        'Zusage 3 wird gelöscht kommt zu Zugeordnet -> Prüfung , ob MA bereits zugeordnet -> prüfen, ob das vorher schon passiert, sonst einkommentieren + anpassen!\n    '    If TLookup(\"ID\", ZUORDNUNG, criteria) <> Null Then\n    '        Status = 3\n    '    endif.\n        \n        Select Case Status\n            Case 1\n                'Mitarbeiter anfragen\n                check = create_Mail(MA_ID, VA_ID, VADatum_ID, VAStart_ID, 1) & vbCrLf\n            \n                'Angefragt setzen, wenn Anfrage erfolgreich\n                If InStr(check, \"OK\") <> 0 Then Anfragen = setze_Angefragt(MA_ID, VA_ID, VADatum_ID, VAStart_ID)\n                \n                'Anfragezeitpunkt dokumentieren\n                TUpdate \"Anfragezeitpunkt = \" & DatumUhrzeitSQL(Now()), PLANUNG, Criteria\n'                SQL = \"UPDATE \" & PLANUNG & \" SET Anfragezeitpunkt = \" & DatumUhrzeitSQL(Now()) & \" WHERE \" & CRITERIA\n'                CurrentDb.Execute SQL\n                \n                'Infohaken setzen\n                setInfo (CRITERIAFORINFO)\n                \n            Case 2\n                \n                'Mitarbeiter anfragen\n                check = create_Mail(MA_ID, VA_ID, VADatum_ID, VAStart_ID, 1) & vbCrLf\n            \n                'Angefragt setzen, wenn Anfrage erfolgreich\n                If InStr(check, \"OK\") <> 0 Then Anfragen = setze_Angefragt(MA_ID, VA_ID, VADatum_ID, VAStart_ID)\n       \n                Anfragen = Anfragen & \">ERNEUT ANGEFRAGT!\"\n                \n                'Infohaken setzen -> Darf nicht, da bereits bei der ersten Anfrage ein \"Dummyhaken\" gesetzt wurde!\n                'setInfo (CRITERIAFORINFO)\n                \n            Case 3\n                Anfragen = \">BEREITS ZUGESAGT!\"\n                \n            Case 4\n                Anfragen = \">BEREITS ABGESAGT!\"\n                \n            Case Else\n                Anfragen = \">UNBEKANNTER FEHLER!\"\n            \n        End Select\n     \n        'Datei für Autmatische Antwort erzeugen\n        create_PHP MD5, Email, VADatum, VA_Uhrzeit, VA_Ende, VA_Text, VA_Ort, VA_Objekt, MA_ID\n\n    End If\n    \nEnd Function\n\n\n'IstFraglich setzen\nFunction setInfo(Criteria As String)\n\nDim rs As Recordset\n    \n    Set rs = CurrentDb.OpenRecordset(\"SELECT * FROM \" & ZUORDNUNG & \" WHERE \" & Criteria)\n    \n    If Not rs.EOF Then\n        rs.Edit\n        rs.fields(\"IstFraglich\") = True\n        rs.update\n    End If\n    rs.Close\n    Set rs = Nothing\n\nEnd Function\n\n\n'Mitarbeiter als angefragt markieren Hier ANFRAGEZEITPUNKT SETZEN!\nFunction setze_Angefragt(MA_ID As Integer, VA_ID As Long, VADatum_ID As Long, VAStart_ID As Long) As String\n\nDim Criteria As String\n\n    Criteria = \"MA_ID = \" & MA_ID & \" AND VA_ID = \" & VA_ID & _\n        \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID\n\n    'Status 1 bis 4:  1=Geplant, 2=Benachrichtigt, 3=Zusage, 4 =Absage\n    '(Zusage 3 wird gelöscht kommt zu Zugeordnet)\n    \n    If TUpdate(\"Status_ID = 2\", PLANUNG, Criteria) = \"OK\" Then\n      setze_Angefragt = \">OK\"\n      \n    Else\n      setze_Angefragt = \">FEHLER!\"\n    \n    End If\n      \nEnd Function\n    \n    \n'Texte zu IDs aus Stammdaten lesen\nFunction Texte_lesen(ByVal MA_ID As String, ByVal VA_ID As String, ByVal VADatum_ID As String, ByVal VAStart_ID As String) As String\n    \n    Email = \"\"\n    VName = \"\"\n    NName = \"\"\n    VA_Text = \"\"\n    VA_Objekt = \"\"\n    VA_Ort = \"\"\n    VADatum = \"\"\n    VA_Uhrzeit = \"\"\n    VA_Ende = \"\"\n    DC = \"\"\n    TP = \"\"\n    TPZeit = \"\"\n    Sender = \"\"\n    \nOn Error Resume Next\n\n    Email = TLookup(\"Email\", \"tbl_Ma_Mitarbeiterstamm\", \"ID=\" & MA_ID)\n    \n    'eM@il Adresse muss gepflegt sein, da mit Grundlage für md5hash\n    If err.Number <> 0 Then\n        Texte_lesen = \"Mitarbeiter \" & MA_ID & \": Emailadresse fehlt!\"\n    End If\n    \n    'Rest ist rille für weitere Verarbeitung...\n    VName = TLookup(\"Vorname\", MASTAMM, \"ID = \" & MA_ID)\n    NName = TLookup(\"Nachname\", MASTAMM, \"ID = \" & MA_ID)\n    VA_Text = TLookup(\"Auftrag\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    VA_Objekt = TLookup(\"Objekt\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    VA_Ort = TLookup(\"Ort\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    VADatum = TLookup(\"VADatum\", PLANUNG, \"VADatum_ID = \" & VADatum_ID & _\n        \" AND MA_ID = \" & MA_ID & \" AND VAStart_ID = \" & VAStart_ID)\n    VA_Uhrzeit = TLookup(\"MVA_Start\", PLANUNG, \"VADatum_ID = \" & VADatum_ID & _\n        \" AND MA_ID = \" & MA_ID & \" AND VAStart_ID = \" & VAStart_ID)\n    DC = TLookup(\"Dienstkleidung\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    VA_Ende = TLookup(\"MVA_Ende\", PLANUNG, \"VADatum_ID = \" & VADatum_ID & _\n        \" AND MA_ID = \" & MA_ID & \" AND VAStart_ID = \" & VAStart_ID)\n    TP = TLookup(\"Treffpunkt\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    TPZeit = TLookup(\"Treffp_Zeit\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    Sender = detect_sender\n\n    'Uhrzeit formatieren\n    VA_Uhrzeit = Format(VA_Uhrzeit, \"HH:MM\")\n    VA_Ende = Format(VA_Ende, \"HH:MM\")\n    TPZeit = Format(TPZeit, \"HH:MM\")\n    \n    'Autoende herausnehmen (bei 4,5h keine Endzeit)\n    If stunden(VA_Uhrzeit, VA_Ende) = \"4,5\" Then VA_Ende = \"\"\n   \nEnd Function\n\n\n'URL ERZEUGEN\nFunction create_URL(MD5 As String, ByVal MA_ID As String, MAemail As String, ByVal VA_ID As String, _\n    ByVal VADatum_ID As String, ByVal VAStart_ID As String) As String\n\n    Dim url As String\n\nOn Error GoTo err_URL\n    'Beispiel:\n    'http://noreply.consec-security.selfhost.eu/mail/index.php?MA_ID=0815&VA_ID=999&ZUSAGE=1&VADatum_ID=123123123\n    \n    url = \"http://noreply.consec-security.selfhost.eu/mail/index.php?\"\n    \n    'URL erzeugen\n    url = url & \"md5hash=\" & MD5 & \"&MA_ID=\" & MA_ID & \"&VA_ID=\" & VA_ID & _\n        \"&VADatum_ID=\" & VADatum_ID & \"&VAStart_ID=\" & VAStart_ID & \"&dress=\" & DC\n    \n    'Leerzeichen ersetzen\n    create_URL = Replace(url, \" \", \"_\")\n\n\nend_URL:\n    Exit Function\nerr_URL:\n    create_URL = err.Number & err.description\n    Resume end_URL\nEnd Function\n\n\n'Mail direkt erzeugen\n'Mailtype: 1=Anfrage, 2=Zusagebestätigung, 3=Absagebestätigung\nFunction create_Mail(ByVal MA_ID As Integer, ByVal VA_ID As Long, ByVal VADatum_ID As Long, ByVal VAStart_ID As Long, Mailtype As Integer, Optional ByVal Attachment As String) As String\n\n    Dim config  'As CDO.Configuration\n    Dim message 'As CDO.Message\n    Dim fields  'As ADODB.Fields\n\n    Dim url As String\n    Dim urlja As String\n    Dim urlnein As String\n    Dim Subject As String\n    Dim Body As String\n    Dim txtfile As String\n    Dim ZuAbsage As String\n    Dim Zusatztext As String\n    Dim Farbe As String\n    \n    'Texte nachlesen\n    subRC = Texte_lesen(MA_ID, VA_ID, VADatum_ID, VAStart_ID)\n    \n    'URL erzeugen\n    Select Case Mailtype\n        Case 1 'Anfrage\n            url = create_URL(MD5, MA_ID, Email, VA_ID, VADatum_ID, VAStart_ID)\n        \n        \n            'Fehler beim Erzeugen der URL\n            If IsNumeric(Left(url, 1)) Then\n                create_Mail = \"Fehler beim Erzeugen der URL: \" & url\n                Exit Function\n            End If\n        \n            'URLs für Zusagen und Absage\n            urlja = url & \"&ZUSAGE=1\"\n            urlnein = url & \"&ZUSAGE=0\"\n            \n            'Betreffzeile aufbauen\n            Subject = \"CONSEC Anfrage zu \" & VA_Text & \", \" & VADatum & \" in \" & VA_Ort\n        \n        Case Else ' Bestätigung\n            Subject = \"Deine Rückmeldung ist angekommen \" & VA_Text & \", \" & VADatum & \" in \" & VA_Ort 'HIER noch unterscheiden-->ABSAGE /ZUSAGE\n        \n    End Select\n    \n    \n    Select Case Mailtype\n        Case 1\n            txtfile = TXTAnf\n        Case 2\n            txtfile = TXTConf\n            ZuAbsage = \"Zusage\"\n            Farbe = \"green\"\n            Zusatztext = \"Eine Übersicht über alle Deine zugesagten Aufträge findest Du als Dienstplan im Anhang.\" & vbCrLf & vbCrLf & \"Viele Grüße\"\n        Case 3\n            txtfile = TXTConf\n            ZuAbsage = \"Absage\"\n            Farbe = \"red\"\n            Zusatztext = \"Eine Übersicht über alle Deine zugesagten Aufträge findest Du als Dienstplan im Anhang.\" & vbCrLf & vbCrLf & \"Viele Grüße\"\n    End Select\n    \n    'Mailtext aufbauen\n    Body = create_HTML(txtfile)\n    \n    'Fehler beim Erzeugen des Bodys\n    If IsNumeric(Left(Body, 1)) Then\n        create_Mail = \"Fehler beim Erzeugen des Bodys: \" & Body\n        Exit Function\n    End If\n    \n    'Variablen ersetzen\n    Body = Replace(Body, \"[A_URL_JA]\", urlja)\n    Body = Replace(Body, \"[A_URL_NEIN]\", urlnein)\n    Body = Replace(Body, \"[A_Auftr_Datum]\", VADatum)\n    Body = Replace(Body, \"[A_Auftrag]\", VA_Text)\n    Body = Replace(Body, \"[A_Ort]\", VA_Ort)\n    Body = Replace(Body, \"[A_Objekt]\", VA_Objekt)\n    Body = Replace(Body, \"[A_Start_Zeit]\", VA_Uhrzeit & \" Uhr\")\n    If VA_Ende <> \"\" Then\n        Body = Replace(Body, \"[A_End_Zeit]\", VA_Ende & \" Uhr\")\n    Else\n        Body = Replace(Body, \"[A_End_Zeit]\", VA_Ende)\n    End If\n    If TPZeit <> \"\" Then\n        Body = Replace(Body, \"[A_Treffp_Zeit]\", TPZeit & \" Uhr\")\n    Else\n        Body = Replace(Body, \"[A_Treffp_Zeit]\", TPZeit)\n    End If\n    Body = Replace(Body, \"[A_Treffpunkt]\", TP)\n    Body = Replace(Body, \"[A_Dienstkleidung]\", DC)\n    Body = Replace(Body, \"[A_Sender]\", Sender)\n    Body = Replace(Body, \"[A_Wochentag]\", Format(VADatum, \"DDD\"))\n\n    \n    'HIER noch unterscheiden\n    Body = Replace(Body, \"[A_Color]\", Farbe)\n    Body = Replace(Body, \"[A_ZUAB]\", ZuAbsage)\n    Body = Replace(Body, \"[A_Zusatztext]\", Zusatztext)\n    \n    'Debug.Print Body\n\n    Set message = CreateObject(\"CDO.Message\") 'server.CreateObject(\"CDO.Message\")\n    Set config = CreateObject(\"CDO.Configuration\") 'server.CreateObject(\"CDO.Configuration\")\n    Set fields = config.fields\n    \n    config.Load -1\n    With fields\n        .item(cdoSendUsingMethod) = cdoSendUsingPort\n        .item(cdoSMTPUseSSL).Value = False\n        .item(cdoSMTPServer).Value = \"in-v3.mailjet.com\"\n        .item(cdoSMTPServerPort).Value = 25\n        .item(cdoSMTPConnectionTimeout).Value = 10\n        .item(cdoSMTPAuthenticate).Value = cdoBasic\n        .item(cdoSendUserName).Value = SendUserName\n        .item(cdoSendPassword).Value = SendPassword\n        '.Item(cdoSendUserName).Value = \"362b265d418678568c59d793a174852f\"\n        '.Item(cdoSendPassword).Value = \"713a4cae1f305e8f10de74a11eb88f4e\"\n        .update\n    End With\n     \n    With message\n    Set .Configuration = config\n        .TO = Email\n        .FROM = \"\"\"Consec Auftragsplanung\"\" <siegert@consec-nuernberg.de>\"\n        .Subject = Subject\n        .htmlBody = Body\n        If Attachment <> \"\" Then .addAttachment Attachment\n        .Send\n    End With\n     \n     \n    'is gut\n    create_Mail = VName & \" \" & NName & \"  \" & VA_Text & \"  OK\"\n    'Log\n    CurrentDb.Execute \"INSERT INTO tbl_Log_eMail_Sent(SendDate,Absender,Betreff,MailText,BCC,VA_ID,IstHTML)\" & _\n        \" VALUES (\" & DatumUhrzeitSQL(Now) & \",'\" & Environ(\"UserName\") & \" ','\" & Subject & \"','\" & txtfile & \"','\" & Email & \"',\" & VA_ID & \",-1)\"\n    \nEnde:\n    Set fields = Nothing\n    Set message = Nothing\n    Set config = Nothing\n    Exit Function\nerr:\n    create_Mail = err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n'HTML-Body aus Textdokument einlesen\nFunction create_HTML(txtfile As String) As String\n\nDim Buffer As String\n\nOn Error GoTo Err_HTML\n\n    Open txtfile For Input As #1\n    Do\n      Line Input #1, Buffer\n      create_HTML = create_HTML & vbCrLf & Buffer\n    Loop While Not EOF(1)\n    \n    Close #1    ' Datei schließen\n\n    'Umlaute anpassen -> create_HTML\n    create_HTML = Replace(create_HTML, \"Ü\", \"&#220;\", , , vbBinaryCompare)\n    create_HTML = Replace(create_HTML, \"Ä\", \"&#196;\", , , vbBinaryCompare)\n    create_HTML = Replace(create_HTML, \"Ö\", \"&#214;\", , , vbBinaryCompare)\n    create_HTML = Replace(create_HTML, \"ü\", \"&#252;\", , , vbBinaryCompare)\n    create_HTML = Replace(create_HTML, \"ä\", \"&#228;\", , , vbBinaryCompare)\n    create_HTML = Replace(create_HTML, \"ö\", \"&#246;\", , , vbBinaryCompare)\n    create_HTML = Replace(create_HTML, \"ß\", \"&#223;\", , , vbBinaryCompare)\n    create_HTML = Replace(create_HTML, \"Ãœ\", \"&#220;\")  'Ü\n    create_HTML = Replace(create_HTML, \"Ã„\", \"&#196;\")  'Ä\n    create_HTML = Replace(create_HTML, \"Ã–\", \"&#214;\")  'Ö\n    create_HTML = Replace(create_HTML, \"Ã¼\", \"&#252;\")  'ü\n    create_HTML = Replace(create_HTML, \"Ã¤\", \"&#228;\")  'ä\n    create_HTML = Replace(create_HTML, \"Ã¶\", \"&#246;\")  'ö\n    create_HTML = Replace(create_HTML, \"ÃŸ\", \"&#223;\")  'ß\n    create_HTML = Replace(create_HTML, \"Ãœ\", \"&#220;\")  'Ü\n    create_HTML = Replace(create_HTML, \"Ã„\", \"&#196;\")  'Ä\n    create_HTML = Replace(create_HTML, \"ï\", \"\")         'Mist raus\n    create_HTML = Replace(create_HTML, \"¿\", \"\")         'Mist raus\n    create_HTML = Replace(create_HTML, \"»\", \"\")         'Mist raus\n    \nEnd_HTML:\n    Exit Function\nErr_HTML:\n    create_HTML = err.Number & \" \" & err.description\n    Resume End_HTML\nEnd Function\n\n\n'Mail erzeugen und senden\nFunction send_Mail(Email As String, Subject As String, Body As String, Optional Attachment As String) As String\n\n    Dim config  'As CDO.Configuration\n    Dim message 'As CDO.Message\n    Dim fields  'As ADODB.Fields\n\n    Set message = CreateObject(\"CDO.Message\") 'server.CreateObject(\"CDO.Message\")\n    Set config = CreateObject(\"CDO.Configuration\") 'server.CreateObject(\"CDO.Configuration\")\n    Set fields = config.fields\n   \nOn Error GoTo err\n\n    config.Load -1\n    With fields\n        .item(cdoSendUsingMethod) = cdoSendUsingPort\n        .item(cdoSMTPUseSSL).Value = False\n        .item(cdoSMTPServer).Value = SMTPServer\n        .item(cdoSMTPServerPort).Value = 25\n        .item(cdoSMTPConnectionTimeout).Value = 10\n        .item(cdoSMTPAuthenticate).Value = cdoBasic\n        .item(cdoSendUserName).Value = SendUserName\n        .item(cdoSendPassword).Value = SendPassword\n        .update\n    End With\n     \n    With message\n    Set .Configuration = config\n        .TO = Email\n        .FROM = \"\"\"Consec Auftragsplanung\"\" <siegert@consec-nuernberg.de>\"\n        .Subject = Subject\n        .htmlBody = Body\n        If Attachment <> \"\" Then .addAttachment Attachment\n        .Send\n    End With\n     \n     \n    'is gut\n    send_Mail = \"Email wurde versendet\"\n    \n    'Log\n    CurrentDb.Execute \"INSERT INTO tbl_Log_eMail_Sent(SendDate,Absender,Betreff,MailText,BCC,IstHTML)\" & _\n        \" VALUES (\" & DatumUhrzeitSQL(Now) & \",'\" & Environ(\"UserName\") & \" ','\" & Subject & \"','send_Mail','\" & Email & \"',-1)\"\n    \n    \nEnde:\n    Set fields = Nothing\n    Set message = Nothing\n    Set config = Nothing\n    Exit Function\nerr:\n    send_Mail = err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n'Dienstplan senden\nFunction Dienstplan_senden(MA_ID As Integer, von As Date, bis As Date) As String\n\nDim Subject     As String\nDim Body        As String\nDim Attachment  As String\nDim Report      As String\nDim Sender      As String\nDim Vorname     As String\nDim Email       As String\n\nOn Error GoTo err\n    \n    'Email (bei Subs Telefonnummer, bei MA Email)\n    'If TLookup(\"IstSubunternehmer\", MASTAMM, \"ID=\" & MA_ID) = False Then\n        Email = TLookup(\"Email\", MASTAMM, \"ID=\" & MA_ID)\n    'Else\n        'Email = TLookup(\"Tel_Mobil\", MASTAMM, \"ID=\" & MA_ID)\n        'Email = TLookup(\"Tel_Festnetz\", MASTAMM, \"ID=\" & MA_ID)\n    'End If\n    \n    'Vorname\n    Vorname = TLookup(\"Vorname\", MASTAMM, \"ID= \" & MA_ID)\n    \n    'Bericht\n    Report = \"rpt_MA_Dienstplan\"\n\n    'Anhang\n    Attachment = PfadTemp & \"Dienstplan_\" & von & \"-\" & bis & \".pdf\"\n\n    'Prüfen, ob Bericht geöffnet\n    If fctIsReportOpen(Report) Then\n        MsgBox \"Bitte zuerst den Bericht schließen!\"\n        Exit Function\n    End If\n\n    'Betreff\n    Subject = \"Dienstplan ab \" & von\n\n    'Mailtext\n    Body = create_HTML(TXTDienstPl)\n    Body = Replace(Body, \"[A_Vorname]\", Vorname)\n    Body = Replace(Body, \"[A_DatumAb]\", von)\n\n    Sender = detect_sender\n\n    Body = Replace(Body, \"[A_Sender]\", Sender)\n\n    'Alte Datei löschen falls noch vorhanden\n    If FileExists(Attachment) Then Kill Attachment\n\n    'Bericht im Temp-Verzeichnis als PDF sichern\n    DoCmd.OutputTo acOutputReport, Report, \"PDF\", Attachment\n\n    'Datum vermerken\n    TUpdate \"Datum_DP = \" & datumSQL(Now), MASTAMM, \"ID = \" & MA_ID\n        \n    'Fire, Captain!\n    Dienstplan_senden = send_Mail(Email, Subject, Body, Attachment)\n        \n\n\nEnde:\n    'Datei löschen\n    If FileExists(Attachment) Then Kill Attachment\n    Exit Function\nerr:\n    Dienstplan_senden = err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n\n'Lohnabrechnung_ermitteln\nFunction Lohnabrechnung_ermitteln(ByVal LexID As Long, Optional Jahr As Integer, Optional Monat As Integer) As String\n\nDim PfadAbrech  As String\nDim such        As String\nDim MonatStr    As String\nDim Datei       As String\n\n    If Jahr = 0 Then Jahr = year(Now)\n    If Monat = 0 Then Monat = Month(Now) - 1\n    MonatStr = Monat_lang(Monat)\n\n    PfadAbrech = PfadPlanungAktuell & \"A  - Lexware Datenträger\\2 - Abr Lohn\\CONSEC_Security_Veranstaltungsservice_&_\" & Jahr & \"_\" & MonatStr & \"\\\"\n    such = Jahr & \"_\" & MonatStr & \"_\" & LexID & \"_\"\n    Datei = Dir(PfadAbrech & \"*\" & such & \"*.pdf\")\n    \n    If Datei <> \"\" Then Lohnabrechnung_ermitteln = PfadAbrech & Datei\n    \nEnd Function\n\n\n'Lohnabrechnung senden\nFunction Lohnabrechnung_senden(LexID As Long, Monat As String, Jahr As String, Datei As String) As String\n\n\nDim Subject     As String\nDim Body        As String\nDim Attachment  As String\nDim Sender      As String\nDim Vorname     As String\nDim Email       As String\n\n    \n    If Datei = \"\" Then\n        Lohnabrechnung_senden = \"Keine Datei übergeben\"\n        Exit Function\n    End If\n    \n   'Email\n    Email = TLookup(\"Email\", MASTAMM, \"LEXWare_ID=\" & LexID)\n    \n    'Vorname\n    Vorname = TLookup(\"Vorname\", MASTAMM, \"LEXWare_ID= \" & LexID & \" AND IstAktiv = TRUE\")\n\n    'Anhang\n    Attachment = Datei\n\n    'Betreff\n    Subject = \"Consec Lohnabrechnung \" & Monat\n\n    'Mailtext\n    Body = create_HTML(TXTAbrechnung)\n    Body = Replace(Body, \"[A_Vorname]\", Vorname)\n    Body = Replace(Body, \"[A_Monat]\", Monat)\n    Body = Replace(Body, \"[A_Jahr]\", Jahr)\n    \n    'Absender\n    Sender = detect_sender\n    \n    'Mailtext\n    Body = Replace(Body, \"[A_Sender]\", Sender)\n\n        \n    'Fire, Captain!\n    Lohnabrechnung_senden = send_Mail(Email, Subject, Body, Attachment)\n        \nEnde:\n    Exit Function\nerr:\n    Lohnabrechnung_senden = err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n\n'PDF Einsatzliste Subunternehmer\nFunction pdf_erstellen_einsatzliste_sub(VA_ID As Long, MA_ID As Long) As String\n\nDim PDF_Datei  As String\n\n    \n    PDF_Datei = Server & \"Consys\\Dokumente\\Auftrag\\Allgemein\\\" & Nz(TLookup(\"Auftrag\", AUFTRAGSTAMM, \"ID = \" & VA_ID), \"\") & \" \" & _\n        Nz(TLookup(\"Objekt\", AUFTRAGSTAMM, \"ID = \" & VA_ID), \"\") & \" am \" & TLookup(\"VADatum\", anzTage, \"VA_ID = \" & VA_ID) & \" \" & _\n        Nz(TLookup(\"Nachname\", MASTAMM, \"ID = \" & MA_ID), \"\") & \" \" & Nz(TLookup(\"Vorname\", MASTAMM, \"ID = \" & MA_ID), \"\") & \".pdf\"\n        \n    'Properties Query Bericht\n    Call Set_Priv_Property(\"prp_Report1_MA_ID\", MA_ID)\n    Call Set_Priv_Property(\"prp_Report1_Auftrag_IstTage\", 3)\n    Call Set_Priv_Property(\"prp_Report1_Auftrag_ID\", VA_ID)\n    Call Set_Priv_Property(\"prp_Report1_Auftrag_VADatum_ID\", TLookup(\"ID\", anzTage, \"VA_ID = \" & VA_ID))\n    \n    DoCmd.OutputTo acOutputReport, \"rpt_Auftrag_Zusage\", acFormatPDF, PDF_Datei\n\n    pdf_erstellen_einsatzliste_sub = PDF_Datei\n    \nEnd Function"}
