{"id":"MOD_zmd_AuftragKopieren","name":"zmd_AuftragKopieren","kind":"standard","procedures":["Function AuftragKopieren(VA_ID As Long) As String"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":["INSERT INTO "],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\n\n\n'Datentyp Veranstaltung\nPrivate Type VA\n    Datum         As Date\n    datumSQL      As String\n    DatumID       As Long\n    StartID()     As Long 'Mehrere Start_IDs pro Tag möglich\nEnd Type\n\n\nFunction AuftragKopieren(VA_ID As Long) As String\n\nDim sql             As String\nDim rs              As Recordset\n\n'Variablen\nDim VA()            As VA\nDim f()             As Variant  'Array zum Puffern eines Datensatzes einer Tabelle\nDim c               As Integer  'Dimensionierungsvarialbe für Array f\nDim i               As Integer  'Counter für Schleifen\nDim TAG             As Integer  'Counter bei mehrtägigen Veranstaltungen\nDim Tage            As Integer  'Anzahl Veranstaltungstage\nDim Start           As Integer  'Counter Starts pro Veranstaltungstag\nDim Starts          As Integer  'Start_IDs pro Tag\nDim Entries         As Integer  'Anzahl Datensätze im Recordset\nDim VADatum         As Date\nDim ID              As Long\nDim von             As Date\nDim bis             As Date\nDim PosNr           As Integer\nDim PKWAnz          As Integer\nDim MVAStart        As Date\nDim MVAEnde         As Date\nDim MAStart         As Date\nDim MAEnde          As Date\n\nOn Error GoTo err\n    \n    'Anzahl Tage der Veranstaltung\n    Tage = TCount(\"ID\", anzTage, \"VA_ID = \" & VA_ID)\n\n    '\"Dauerauftrag\" mit freien Tagen dazwischen\n    von = TLookup(\"Dat_VA_Von\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    bis = TLookup(\"Dat_VA_Bis\", AUFTRAGSTAMM, \"ID = \" & VA_ID)\n    If Tage < bis - von Then\n        AuftragKopieren = \"Dauerläufer - bitte manuell anlegen!\"\n        GoTo Ende\n    End If\n    von = 0\n    bis = 0\n    \n    'Zeitraum neue Veranstaltung\n    von = InputBox(\"Startdatum eingeben: \", \"Veranstaltungsbeginn\")\n    \n    'Datumsprüfung\n    If von < Date Then\n        If MsgBox(\"Achtung!\" & vbCrLf & _\n            \"Datum liegt in der Vergangenheit!\" & vbCrLf & _\n            \"Trotzdem kopieren?\", vbYesNo) <> vbYes Then\n                AuftragKopieren = \"Auftrag wurde nicht kopiert\"\n                GoTo Ende\n        End If\n    End If\n    \n\n    'Ende der Veranstaltung\n    bis = von + Tage - 1 'Erster Tag = von!\n    \n    'Pro Veranstaltungstag gibt es eine VADatumID und mindestens eine VAStart_ID, die jeweils korrekt zugewiesen werden müssen!\n    'Array beginnt bei 0, der Übersicht halber bleibt dieser Eintrag leer und +1\n    ReDim VA(Tage)\n    \n    'Veranstaltungstage hinterlegen\n    For i = 1 To Tage\n        VA(i).Datum = von + i - 1\n        VA(i).datumSQL = \"#\" & year(von + i - 1) & \"-\" & Month(von + i - 1) & \"-\" & Day(von + i - 1) & \"#\"\n    Next i\n    \n    \n'###   Veranstaltung im Auftragstamm duplizieren\n\n    sql = \"SELECT * FROM \" & AUFTRAGSTAMM & \" WHERE [ID] = \" & VA_ID\n    Set rs = CurrentDb.OpenRecordset(sql)\n    c = rs.fields.Count\n    \n    ReDim f(c)\n\n    'Feldwerte puffern\n    For i = 1 To c - 1\n        f(i) = rs.fields(i)\n    Next i\n    \n    'Neuer Datensatz\n    rs.AddNew\n    \n    'gepufferte Werte übertragen\n    For i = 1 To c - 1\n         rs.fields(i) = f(i)\n         'Debug.Print rs.Fields(i).Name & \" \" & rs.Fields(i)\n    Next i\n    \n    'ID der neuen Veranstaltung holen\n    ID = rs.fields(\"ID\")\n    \n    'Einzelwerte übersteuern\n    rs.fields(\"Erst_von\") = Environ(\"UserName\")\n    rs.fields(\"Erst_am\") = Date & \" \" & Time\n    rs.fields(\"Dat_VA_Von\") = von\n    rs.fields(\"Dat_VA_Bis\") = bis\n    rs.fields(\"AnzTg\") = (bis - von) + 1\n    rs.fields(\"Aend_von\") = Null\n    rs.fields(\"Aend_am\") = Null\n    rs.fields(\"Veranst_Status_ID\") = 1\n    rs.fields(\"Rch_Dat\") = Null\n    rs.fields(\"Rch_Nr\") = Null\n    rs.fields(\"Excel_Dateiname\") = Null\n    rs.fields(\"Excel_Path\") = Null\n    rs.fields(\"Abschlussdatum\") = Null\n    \n    rs.update\n    rs.Close\n\n\n'###   Veranstaltung in tbl_VA_Start duplizieren und ID holen\n\n    'Zuordnungen nach Datum der Veranstaltungstage und Start_ID aufsteigend sortiert\n    sql = \"SELECT * FROM \" & VASTART & \" WHERE [VA_ID] = \" & VA_ID & \" ORDER BY [VADatum] ASC, [ID] ASC\"\n    Set rs = CurrentDb.OpenRecordset(sql)\n    \n    'Anzahl Spalten\n    c = rs.fields.Count\n    \n    'Alle Datensätze im Recordset registrieren\n    If rs.RecordCount <> 0 Then\n        rs.MoveLast\n        rs.MoveFirst\n    End If\n    Entries = rs.RecordCount\n\n    'Mehrere Einträge pro Tag möglich!\n    If Entries >= Tage Then\n        ReDim f(c)\n\n        'Schleife über Anzahl der Tage\n        TAG = 1\n        Start = 1\n        Starts = TCount(\"ID\", VASTART, \"VA_ID = \" & VA_ID & \" AND VADatum = \" & datumSQL(rs.fields(\"VADatum\")))\n        ReDim VA(TAG).StartID(Starts)\n        Do\n            If rs.fields(\"VADatum\") <> VADatum And VADatum <> \"00:00:00\" Then\n                TAG = TAG + 1\n                Start = 1\n                Starts = TCount(\"ID\", VASTART, \"VA_ID = \" & VA_ID & \" AND VADatum = \" & datumSQL(rs.fields(\"VADatum\")))\n                ReDim VA(TAG).StartID(Starts)\n            End If\n            VADatum = rs.fields(\"VADatum\")\n\n\n            'Feldwerte puffern\n            For i = 1 To c - 1\n                f(i) = rs.fields(i)\n            Next i\n\n            'Neuer Datensatz\n            rs.AddNew\n\n            'Schlüssel ID (VAStartID) puffern\n            VA(TAG).StartID(Start) = rs.fields(\"ID\")\n            Start = Start + 1\n\n            'gepufferte Werte übertragen\n            For i = 1 To c - 1\n                 rs.fields(i) = f(i)\n            Next i\n\n            'Einzelwerte übersteuern -> VA_Start und VA_Ende OHNE Datum!\n            rs.fields(\"VA_ID\") = ID\n            rs.fields(\"VADatum_ID\") = Null 'wird später erstellt und zugewiesen\n            rs.fields(\"VADatum\") = VA(TAG).Datum\n            If Not IsNull(rs.fields(\"MVA_Start\")) And Len(rs.fields(\"MVA_Start\")) = 19 Then rs.fields(\"MVA_Start\") = VA(TAG).Datum & \" \" & Right(rs.fields(\"MVA_Start\"), 8)\n            If Not IsNull(rs.fields(\"MVA_Ende\")) And Len(rs.fields(\"MVA_Ende\")) = 19 Then rs.fields(\"MVA_Ende\") = VA(TAG).Datum & \" \" & Right(rs.fields(\"MVA_Ende\"), 8)\n\n            rs.update\n            rs.MoveNext\n        'Erste Postion im RS = 0!\n        Loop Until rs.AbsolutePosition = Entries\n        rs.Close\n\n    'Wenn weniger Einträge als Veranstaltungstage -> Ein Eintrag pro Veranstaltungstag\n    Else\n        'Datensätze anlegen\n        For TAG = 1 To Tage\n            rs.AddNew\n            'Schlüssel ID (VAStartID) puffern\n            ReDim VA(TAG).StartID(1)\n            VA(TAG).StartID(1) = rs.fields(\"ID\")\n            rs.fields(\"VA_ID\") = ID\n            rs.fields(\"VADatum\") = VA(TAG).Datum\n            rs.update\n        Next TAG\n        rs.Close\n    End If\n\n\n'###   Veranstaltung in VA_AnzTage duplizieren\n\n    sql = \"SELECT * FROM \" & anzTage & \" WHERE [VA_ID] = \" & VA_ID\n    Set rs = CurrentDb.OpenRecordset(sql)\n    \n    'Anzahl Spalten\n    c = rs.fields.Count\n    'Alle Datensätze im Recordset registrieren\n    If rs.RecordCount <> 0 Then\n        rs.MoveLast\n        rs.MoveFirst\n    End If\n    Entries = rs.RecordCount\n    \n    'Daten nur kopieren, wenn Einträge mit der Anzahl Tage im Auftragstamm übereinstimmen!\n    '-> Ansonsten wird pro Tag ein neuer Antrag angelegt\n    If Entries = Tage Then\n        ReDim f(c)\n        \n        'Schleife über Anzahl der Tage\n        TAG = 1\n        Do\n            'Feldwerte puffern\n            For i = 1 To c - 1\n                f(i) = rs.fields(i)\n            Next i\n            \n            'Neuer Datensatz\n            rs.AddNew\n            \n            'Schlüssel ID (VADatumID) puffern\n            VA(TAG).DatumID = rs.fields(\"ID\")\n            \n            'gepufferte Werte übertragen\n            For i = 1 To c - 1\n                 rs.fields(i) = f(i)\n            Next i\n            \n            'Einzelwerte übersteuern\n            rs.fields(\"VA_ID\") = ID\n            rs.fields(\"VADatum\") = VA(TAG).Datum\n            rs.update\n            \n            'VADatum_ID in tbl_VA_Start aktualisieren (Hier Schlüssel \"ID\")\n            sql = \"UPDATE \" & VASTART & \" SET VADatum_ID = \" & VA(TAG).DatumID & \" WHERE VA_ID = \" & ID & \" AND VADatum = \" & VA(TAG).datumSQL\n            CurrentDb.Execute sql\n            \n            TAG = TAG + 1\n            rs.MoveNext\n        \n        'Erste Postion im RS = 0!\n        Loop Until rs.AbsolutePosition = Entries\n        rs.Close\n    Else\n        'Datensätze anlegen\n        For TAG = 1 To Tage\n            'VADatum = von + Tag\n            rs.AddNew\n            \n            'Schlüssel ID (VADatumID) puffern\n            VA(TAG).DatumID = rs.fields(\"ID\")\n            \n            rs.fields(\"VA_ID\") = ID\n            rs.fields(\"VADatum\") = VA(TAG).Datum\n            rs.update\n            \n            'VADatum_ID in tbl_VA_Start aktualisieren (Hier Schlüssel \"ID\")\n            sql = \"UPDATE \" & VASTART & \" SET VADatum_ID = \" & VA(TAG).DatumID & \" WHERE VA_ID = \" & ID & \" AND VADatum = \" & VA(TAG).datumSQL\n            CurrentDb.Execute sql\n            \n        Next TAG\n        rs.Close\n    End If\n\n\n'###   Veranstaltung in MA_VA_Zuordnung duplizieren -> FÜHRT ZU FEHLERN!!! -> Einträge werden eh automatisch erzeugt!!!!\n\n'    'Zuordnungen nach Datum der Veranstaltungstage und Mitarbeiter aufsteigend sortiert\n'    sql = \"SELECT * FROM \" & ZUORDNUNG & \" WHERE [VA_ID] = \" & VA_ID & \" ORDER BY [VADatum] ASC, [PosNr] ASC\"\n'    Set rs = CurrentDb.OpenRecordset(sql)\n'\n'    'Alle Datensätze im Recordset registrieren\n'    If rs.RecordCount <> 0 Then\n'        rs.MoveLast\n'        rs.MoveFirst\n'    End If\n'    Entries = rs.RecordCount\n'\n'    If Entries > 0 Then\n'\n'        'Loop über alle gefundenen Datensätze\n'        TAG = 1\n'        Start = 1\n'        VADatum = rs.Fields(\"VADatum\") 'VADatum für Abgleich neu zuweisen!\n'        Do\n'            'Nächster Start, wenn sich die Uhrzeit ändert\n'            If MAStart < rs.Fields(\"MA_Start\") And MAStart <> \"00:00:00\" Then\n'                Start = Start + 1\n'            End If\n'\n''            'Nächster Tag, wenn Positionsnummern neu beginnen  ->Funktioniert nicht, wenn nur eine Posnr pro tag!\n''            If rs.Fields(\"PosNr\") < PosNr Then\n''                Tag = Tag + 1\n''                Start = 1\n''            End If\n'            'Nächster Tag, wenn Datum wechselt\n'            If rs.Fields(\"VADatum\") <> VADatum Then\n'                TAG = TAG + 1\n'                Start = 1\n'                VADatum = rs.Fields(\"VADatum\")\n'            End If\n'            'Werte, die übernommen werden sollen -> MA_ = OHNE Datum, MVA_ = MIT Datum!\n'On Error Resume Next\n'            PosNr = rs.Fields(\"PosNr\")\n'            PKWAnz = rs.Fields(\"PKW_Anzahl\")\n'            MVAStart = VA(TAG).Datum & \" \" & Right(rs.Fields(\"MVA_Start\"), 8)\n'            MVAEnde = VA(TAG).Datum & \" \" & Right(rs.Fields(\"MVA_Ende\"), 8)\n'            If Not IsNull(rs.Fields(\"MA_Start\")) Then MAStart = Right(rs.Fields(\"MA_Start\"), 8)\n'            If Not IsNull(rs.Fields(\"MA_Ende\")) Then MAEnde = Right(rs.Fields(\"MA_Ende\"), 8)\n'On Error GoTo err\n'\n'\n''            Debug.Print \"INSERT INTO \" & ZUORDNUNG & \" (VA_ID, VADatum, PosNr, VADatum_ID, VAStart_ID, Erst_von, Erst_am, MVA_Start, MVA_Ende) VALUES (\" _\n'                & ID & \", \" & Format(VA(Tag).Datum, \"\\#yyyy-mm-dd\\#\") & \", \" & PosNr & \", \" & VA(Tag).DatumID & \", \" & VA(Tag).StartID(Start) & \", '\" & Environ(\"UserName\") _\n'                & \"', \" & Format(Now, \"\\#yyyy-mm-dd hh:nn:ss\\#\") & \", \" & Format(MVAStart, \"\\#yyyy-mm-dd hh:nn:ss\\#\") & \", \" & Format(MVAEnde, \"\\#yyyy-mm-dd hh:nn:ss\\#\") & \");\"\n''\n''            CurrentDb.Execute \"INSERT INTO \" & ZUORDNUNG & \" (VA_ID, VADatum, PosNr, VADatum_ID, VAStart_ID, Erst_von, Erst_am, MVA_Start, MVA_Ende) VALUES (\" _\n''                & ID & \", \" & Format(VA(Tag).Datum, \"\\#yyyy-mm-dd\\#\") & \", \" & PosNr & \", \" & VA(Tag).DatumID & \", \" & VA(Tag).StartID(Start) & \", '\" & Environ(\"UserName\") _\n''                & \"', \" & Format(Now, \"\\#yyyy-mm-dd hh:nn:ss\\#\") & \", \" & Format(MVAStart, \"\\#yyyy-mm-dd hh:nn:ss\\#\") & \", \" & Format(MVAEnde, \"\\#yyyy-mm-dd hh:nn:ss\\#\") & \");\"\n''\n''            If MAStart <> 0 Then TUpdate \"MA_Start = \" & Format(MAStart, \"\\#hh:nn:ss\\#\"), ZUORDNUNG, \"ID = \" & TMax(\"ID\", ZUORDNUNG, \"VA_ID = \" & ID)\n''            If MAEnde <> 0 Then TUpdate \"MA_ende = \" & Format(MAEnde, \"\\#hh:nn:ss\\#\"), ZUORDNUNG, \"ID = \" & TMax(\"ID\", ZUORDNUNG, \"VA_ID = \" & ID)\n'\n'\n'            rs.AddNew\n'\n'            'Datensatz bearbeiten\n'            rs.Fields(\"VA_ID\") = ID\n'            rs.Fields(\"VADatum\") = VA(TAG).Datum\n'            rs.Fields(\"PosNr\") = PosNr\n'            rs.Fields(\"VADatum_ID\") = VA(TAG).DatumID\n'            rs.Fields(\"VAStart_ID\") = VA(TAG).StartID(Start)\n'            rs.Fields(\"Erst_von\") = Environ(\"UserName\")\n'            rs.Fields(\"Erst_am\") = Date & \" \" & Time\n'            'rs.Fields(\"MVA_Start\") = MVAStart\n'            'If MVAEnde <> \"00:00:00\" Then rs.Fields(\"MVA_Ende\") = MVAEnde\n'            'rs.Fields(\"MA_Start\") = MAStart\n'            'If MAEnde <> \"00:00:00\" Then rs.Fields(\"MA_Ende\") = MAEnde\n'            'rs.Fields(\"PreisArt\") =\n'            'rs.Fields(\"IstFraglich\") =\n'        rs.update\n'        rs.MoveNext\n'\n'        'Erste Postion im RS = 0!\n'        Loop Until rs.AbsolutePosition = Entries\n'\n'        rs.Close\n'\n'    'Wenn keine Datensätze in MA_VA_Zuordnung sind, dann einen Datensatz pro Veranstaltungstag anlegen\n'    Else\n'        'Datensätze anlegen\n'        For TAG = 1 To Tage\n'            rs.AddNew\n'\n'            rs.Fields(\"VA_ID\") = ID\n'            rs.Fields(\"VADatum\") = VA(TAG).Datum\n'            rs.Fields(\"VADatum_ID\") = VA(TAG).DatumID\n'            rs.Fields(\"VAStart_ID\") = VA(TAG).StartID(1)\n'            rs.Fields(\"Erst_von\") = Environ(\"UserName\")\n'            rs.Fields(\"Erst_am\") = Date & \" \" & Time\n'            'rs.Fields(\"PreisArt\") =\n'            'rs.Fields(\"IstFraglich\") =\n'            rs.update\n'        Next TAG\n'        rs.Close\n'    End If\n    \n    AuftragKopieren = ID\n            \nEnde:\n    Exit Function\nerr:\n    AuftragKopieren = err.Number & \" \" & err.description\n    Resume Ende\nEnd Function\n\n"}
