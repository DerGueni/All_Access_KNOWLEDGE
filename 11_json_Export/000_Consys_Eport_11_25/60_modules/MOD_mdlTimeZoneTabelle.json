{"id":"MOD_mdlTimeZoneTabelle","name":"mdlTimeZoneTabelle","kind":"standard","procedures":["Public Function Table_Time_Load()","SubKey = \"SYSTEM\\CurrentControlSet\\Control\\TimeZoneInformation\"","SubKey = SKEY_NT","SubKey = SKEY_9X","Private Sub List1_Update(listname As String)","Function gibname(X() As Byte) As String"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":["DELETE * FROM _tblTimeZoneName;"],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"' Public Function Table_Time_Load()\n\n' ##################################################################################################################\n'               #############\n' Modul MUSS as Administrator ausgeführt werden, sonst kann man die Registry Keys mit den TimeZoneDaten nicht lesen\n'               #############\n' ##################################################################################################################\n\nOption Compare Database\nOption Explicit\n\n' Operating System version information declares\n\nPrivate Const VER_PLATFORM_WIN32_NT = 2\nPrivate Const VER_PLATFORM_WIN32_WINDOWS = 1\n\nPrivate Type OSVERSIONINFO\n  dwOSVersionInfoSize As Long\n  dwMajorVersion As Long\n  dwMinorVersion As Long\n  dwBuildNumber As Long\n  dwPlatformId As Long\n  szCSDVersion As String * 128              ' Maintenance string\nEnd Type\n\nPrivate Declare PtrSafe Function GetVersionEx Lib \"kernel32\" _\n    Alias \"GetVersionExA\" (lpVersionInformation As OSVERSIONINFO) As Long\n\n' Time Zone information declares\n\nPrivate Type SYSTEMTIME\n  wYear As Integer\n  wMonth As Integer\n  wDayOfWeek As Integer\n  wDay As Integer\n  wHour As Integer\n  wMinute As Integer\n  wSecond As Integer\n  wMilliseconds As Integer\nEnd Type\n\nPrivate Type REGTIMEZONEINFORMATION\n  Bias As Long\n  StandardBias As Long\n  DaylightBias As Long\n  StandardDate As SYSTEMTIME\n  DaylightDate As SYSTEMTIME\nEnd Type\n\nPrivate Type TIME_ZONE_INFORMATION\n  Bias As Long\n  StandardName(0 To 63) As Byte             ' used to accommodate Unicode strings\n  StandardDate As SYSTEMTIME\n  StandardBias As Long\n  DaylightName(0 To 63) As Byte             ' used to accommodate Unicode strings\n  DaylightDate As SYSTEMTIME\n  DaylightBias As Long\nEnd Type\n\nPrivate Const TIME_ZONE_ID_INVALID = &HFFFFFFFF\nPrivate Const TIME_ZONE_ID_UNKNOWN = 0\nPrivate Const TIME_ZONE_ID_STANDARD = 1\nPrivate Const TIME_ZONE_ID_DAYLIGHT = 2\n\nPrivate Declare PtrSafe Function GetTimeZoneInformation Lib \"kernel32\" _\n    (lpTimeZoneInformation As TIME_ZONE_INFORMATION) As Long\n\nPrivate Declare PtrSafe Function SetTimeZoneInformation Lib \"kernel32\" _\n    (lpTimeZoneInformation As TIME_ZONE_INFORMATION) As Long\n\n' Registry information declares\nPrivate Const REG_SZ As Long = 1\nPrivate Const REG_BINARY = 3\nPrivate Const REG_DWORD As Long = 4\n\nPrivate Const HKEY_CLASSES_ROOT = &H80000000\nPrivate Const HKEY_CURRENT_USER = &H80000001\nPrivate Const HKEY_LOCAL_MACHINE = &H80000002\nPrivate Const HKEY_USERS = &H80000003\n\nPrivate Const ERROR_SUCCESS = 0\nPrivate Const ERROR_BADDB = 1\nPrivate Const ERROR_BADKEY = 2\nPrivate Const ERROR_CANTOPEN = 3\nPrivate Const ERROR_CANTREAD = 4\nPrivate Const ERROR_CANTWRITE = 5\nPrivate Const ERROR_OUTOFMEMORY = 6\nPrivate Const ERROR_ARENA_TRASHED = 7\nPrivate Const ERROR_ACCESS_DENIED = 8\nPrivate Const ERROR_INVALID_PARAMETERS = 87\nPrivate Const ERROR_NO_MORE_ITEMS = 259\n\nPrivate Const KEY_ALL_ACCESS = &H3F\n\nPrivate Const KEY_ENUMERATE_SUB_KEYS = &H8\nPrivate Const KEY_EXECUTE = &H20019\nPrivate Const KEY_WOW64_32KEY = &H200\n\nPrivate Const REG_OPTION_NON_VOLATILE = 0\n\nPrivate Declare PtrSafe Function RegOpenKeyEx Lib \"advapi32.dll\" _\n    Alias \"RegOpenKeyExA\" ( _\n    ByVal hKey As Long, _\n    ByVal lpSubKey As String, _\n    ByVal ulOptions As Long, _\n    ByVal samDesired As Long, _\n    phkResult As Long) _\n    As Long\n\nPrivate Declare PtrSafe Function RegQueryValueEx Lib \"advapi32.dll\" _\n    Alias \"RegQueryValueExA\" ( _\n    ByVal hKey As Long, _\n    ByVal lpszValueName As String, _\n    ByVal lpdwReserved As Long, _\n    lpdwType As Long, _\n    lpData As Any, _\n    lpcbData As Long) _\n    As Long\n\nPrivate Declare PtrSafe Function RegQueryValueExString Lib \"advapi32.dll\" _\n    Alias \"RegQueryValueExA\" ( _\n    ByVal hKey As Long, _\n    ByVal lpValueName As String, _\n    ByVal lpReserved As Long, _\n    lpType As Long, _\n    ByVal lpData As String, _\n    lpcbData As Long) _\n    As Long\n\nPrivate Declare PtrSafe Function RegEnumKey Lib \"advapi32.dll\" _\n    Alias \"RegEnumKeyA\" ( _\n    ByVal hKey As Long, _\n    ByVal dwIndex As Long, _\n    ByVal lpName As String, _\n    ByVal cbName As Long) _\n    As Long\n\nPrivate Declare PtrSafe Function RegCloseKey Lib \"advapi32.dll\" ( _\n    ByVal hKey As Long) _\n    As Long\n\n' Registry Constants\nConst SKEY_NT = \"SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Time Zones\"\nConst SKEY_9X = \"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Time Zones\"\n\n' The following declaration is different from the one in the API viewer.\n' To disable implicit ANSI<->Unicode conversion, it changes the\n' variable types of lpMultiByteStr and lpWideCharStr to Any.\n'\nPrivate Declare PtrSafe Function MultiByteToWideChar Lib \"kernel32\" ( _\n    ByVal CodePage As Long, _\n    ByVal dwFlags As Long, _\n    lpMultiByteStr As Any, _\n    ByVal cchMultiByte As Long, _\n    lpWideCharStr As Any, _\n    ByVal cchWideChar As Long) As Long\n    \n    \n' The above Declare and the following Constants are used to make\n' this sample compatible with Double Byte Character Systems (DBCS).\nPrivate Const CP_ACP = 0\nPrivate Const MB_PRECOMPOSED = &H1\n\nDim SubKey As String\nDim rst As DAO.Recordset\nDim currTZ As TIME_ZONE_INFORMATION\nDim AktuelleTimeZone As String\n\nPublic Function Table_Time_Load()\n  Dim lRetVal As Long, lResult As Long, lCurIdx As Long\n  Dim lDataLen As Long, lValueLen As Long, hKeyResult As Long\n  Dim strValue As String\n  Dim osV As OSVERSIONINFO\n  Dim byteCurrName(32) As Byte\n  Dim cbStr As Long\n  Dim cch As Long\n  Dim lType As Long\n  \n  CurrentDb.Execute \"DELETE * FROM _tblTimeZoneName;\"\n  DoEvents\n  Set rst = CurrentDb.OpenRecordset(\"SELECT * FROM _tblTimeZoneName;\")\n\n  SubKey = \"SYSTEM\\CurrentControlSet\\Control\\TimeZoneInformation\"\n\n  lRetVal = RegOpenKeyEx(HKEY_LOCAL_MACHINE, SubKey, 0, _\n      KEY_ALL_ACCESS, hKeyResult)\n\n  If lRetVal = ERROR_SUCCESS Then\n\n    lCurIdx = 0\n    lDataLen = 32\n    lValueLen = 32\n\n    strValue = String(lValueLen, 0)\n       \n    lRetVal = RegQueryValueExString(hKeyResult, \"TimeZoneKeyName\", 0&, 1, _\n    strValue, lValueLen)\n   \n    If lRetVal = ERROR_SUCCESS Then\n        AktuelleTimeZone = Left(strValue, lValueLen - 1)\n    Else\n        AktuelleTimeZone = Empty\n    End If\n      \n End If\n  \n  ' Win9x and WinNT have a slightly different registry structure. Determine\n  ' the operating system and set a module variable to the correct subkey.\n\n  osV.dwOSVersionInfoSize = Len(osV)\n  Call GetVersionEx(osV)\n  If osV.dwPlatformId = VER_PLATFORM_WIN32_NT Then\n    SubKey = SKEY_NT\n  Else\n    SubKey = SKEY_9X\n  End If\n\n  lRetVal = RegOpenKeyEx(HKEY_LOCAL_MACHINE, SubKey, 0, _\n      KEY_ALL_ACCESS, hKeyResult)\n  \n  If lRetVal = ERROR_SUCCESS Then\n\n    lCurIdx = 0\n    lDataLen = 32\n    lValueLen = 32\n\n    Do\n      strValue = String(lValueLen, 0)\n      lResult = RegEnumKey(hKeyResult, lCurIdx, strValue, lDataLen)\n\n      If lResult = ERROR_SUCCESS Then\n         rst.AddNew\n'        List1.AddItem Left(strvalue, lValueLen)\n            rst!TimeZoneName = Left(strValue, lValueLen)\n            List1_Update (Left(strValue, lValueLen))\n         rst.update\n      End If\n\n      lCurIdx = lCurIdx + 1\n\n    Loop While lResult = ERROR_SUCCESS\n\n    RegCloseKey hKeyResult\n  Else\n    MsgBox \"Could not open registry key \" & lRetVal\n  End If\n  rst.Close\nEnd Function\n\nPrivate Sub List1_Update(listname As String)\n  Dim TZ As TIME_ZONE_INFORMATION\n  Dim oldTZ As TIME_ZONE_INFORMATION\n  Dim rTZI As REGTIMEZONEINFORMATION\n  Dim bytDLTName(32) As Byte, bytSTDName(32) As Byte\n  Dim cbStr As Long, dwType As Long\n  Dim lRetVal As Long, hKeyResult As Long, lngData As Long\n  Dim tmp As String\n\n  On Error Resume Next\n  \n  lRetVal = RegOpenKeyEx(HKEY_LOCAL_MACHINE, SubKey & \"\\\" & listname, _\n      0, KEY_ALL_ACCESS, hKeyResult)\n\n  If lRetVal = ERROR_SUCCESS Then\n    lRetVal = RegQueryValueEx(hKeyResult, \"TZI\", 0&, ByVal 0&, _\n        rTZI, Len(rTZI))\n\n    If lRetVal = ERROR_SUCCESS Then\n      TZ.Bias = rTZI.Bias\n      TZ.StandardBias = rTZI.StandardBias\n      TZ.DaylightBias = rTZI.DaylightBias\n      TZ.StandardDate = rTZI.StandardDate\n      TZ.DaylightDate = rTZI.DaylightDate\n      \n      cbStr = 32\n      dwType = REG_SZ\n\n      lRetVal = RegQueryValueEx(hKeyResult, \"Std\", _\n          0&, dwType, bytSTDName(0), cbStr)\n\n      If lRetVal = ERROR_SUCCESS Then\n        Call MultiByteToWideChar(CP_ACP, MB_PRECOMPOSED, _\n            bytSTDName(0), cbStr, TZ.StandardName(0), 32)\n      Else\n        RegCloseKey hKeyResult\n        Exit Sub\n      End If\n\n      cbStr = 32\n      dwType = REG_SZ\n\n      lRetVal = RegQueryValueEx(hKeyResult, \"Dlt\", _\n          0&, dwType, bytDLTName(0), cbStr)\n\n      If lRetVal = ERROR_SUCCESS Then\n        Call MultiByteToWideChar(CP_ACP, MB_PRECOMPOSED, _\n            bytDLTName(0), cbStr, TZ.DaylightName(0), 32)\n      Else\n        RegCloseKey hKeyResult\n        Exit Sub\n      End If\n\n      lRetVal = GetTimeZoneInformation(oldTZ)\n\n      If lRetVal = TIME_ZONE_ID_INVALID Then\n        MsgBox \"Error getting original TimeZone Info\"\n        RegCloseKey hKeyResult\n        Exit Sub\n      Else\n      \n      ' Neu ********\n            \nrst!Bias = TZ.Bias\nrst!StandardBias = TZ.StandardBias\nrst!DaylightBias = TZ.DaylightBias\n\nrst!StandardDate = DateSerial(TZ.StandardDate.wYear, TZ.StandardDate.wMonth, TZ.StandardDate.wDay) + _\n                   TimeSerial(TZ.StandardDate.wHour, TZ.StandardDate.wMinute, TZ.StandardDate.wSecond)\n\nrst!DaylightDate = DateSerial(TZ.DaylightDate.wYear, TZ.DaylightDate.wMonth, TZ.DaylightDate.wDay) + _\n                   TimeSerial(TZ.DaylightDate.wHour, TZ.DaylightDate.wMinute, TZ.DaylightDate.wSecond)\n    \nrst!StandardName = Trim(gibname(bytSTDName()))\nrst!DaylightName = Trim(gibname(bytDLTName()))\n\nIf AktuelleTimeZone = rst!StandardName Then\n    rst!IsCurrentTimeZone = 1\nElse\n    rst!IsCurrentTimeZone = 0\nEnd If\n'        lRetVal = SetTimeZoneInformation(TZ)\n'        MsgBox \"Time Zone Changed, Click OK to restore\"\n'        lRetVal = SetTimeZoneInformation(oldTZ)\n      End If\n    End If\n\n    RegCloseKey hKeyResult\n  End If\nEnd Sub\n\nFunction gibname(X() As Byte) As String\nDim i As Long\ngibname = \"\"\nFor i = 0 To 31\n    gibname = gibname & Chr$(X(i))\nNext i\nEnd Function\n"}
