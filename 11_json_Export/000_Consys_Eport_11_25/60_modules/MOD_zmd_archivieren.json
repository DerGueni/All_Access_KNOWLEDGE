{"id":"MOD_zmd_archivieren","name":"zmd_archivieren","kind":"standard","procedures":["Public Function archivieren() As String","Public Function archivieren_alt() As String","Function get_relations() As Relation()"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\nType Relation\n    master As String\n    slave As String\n    mfield As String\n    sfield As String\n    archivieren As String\nEnd Type\n\nPublic Function archivieren() As String\n\nDim Archiv As String\nDim sql As String\nDim DatumBis As String\nDim varreturn As Variant\nDim Table() As String\nDim i As Integer\nDim BackendDB As String\n\n    BackendDB = TLookup(\"Database\", \"MSysObjects\", \"Database IS NOT NULL\")\n    DatumBis = datumSQL(\"01.01.\" & year(Now) - 1) 'Letztes Jahr stehen lassen (-> Auftrag kopieren!)\n\n    If InStr(BackendDB, \"Test\") = 0 Then\n        Archiv = PfadProdLokal & Archiv_BE\n    Else\n        Archiv = PfadTestLokal & Archiv_BE\n    End If\n    \n    'Anzahl Tabellen\n    ReDim Table(11)\n    \n    'zu archivierenden Tabellen (ACHTUNG Reihenfolge nicht ändern!)\n    Table(0) = AUFTRAGSTAMM\n    Table(1) = anzTage\n    Table(2) = VASTART\n    Table(3) = PLANUNG\n    Table(4) = ZUORDNUNG\n    Table(5) = VAKOSTALT\n    Table(6) = VAAKTOKOPF\n    Table(7) = VAAKTOPOS\n    Table(8) = VAAKTOPOSM\n    Table(9) = NVERFUEG\n    Table(10) = MASTAMM\n    Table(11) = ZUO_STD\n    'ZEITKONTEN???!!!!\n\n    \n    'Archivieren\n    varreturn = SysCmd(acSysCmdInitMeter, \"Archiviere...\", UBound(Table))\n    For i = LBound(Table) To UBound(Table)\n        varreturn = SysCmd(acSysCmdUpdateMeter, i)\n        sql = \"INSERT INTO \" & Table(i) & \" IN '\" & Archiv & \"' SELECT * FROM \" & Table(i) & \" WHERE [ID] NOT IN (SELECT [ID] FROM \" & Table(i) & \" IN '\" & Archiv & \"')\"\n        If TableExists(Table(i)) Then CurrentDb.Execute sql\n    Next i\n    \n    \n    'Archivierte Daten aus BE enfernen\n    varreturn = SysCmd(acSysCmdInitMeter, \"Lösche archivierte Daten...\", 1)\n    \n    'Veranstaltungen (-> Löschweitergabe!)\n    sql = \"DELETE * FROM \" & AUFTRAGSTAMM & \" WHERE [Dat_VA_Von] < \" & DatumBis\n    CurrentDb.Execute sql\n    'Zeiten nicht verfügbar\n    sql = \"DELETE * FROM \" & NVERFUEG & \" WHERE [vonTag] < \" & DatumBis\n    CurrentDb.Execute sql\n    \n        \n    'Ladebalken ausblenden\n    varreturn = SysCmd(acSysCmdClearStatus)\n    \n    MsgBox \"Archivierung abgeschlossen\"\n    \nEnd Function\n\n\nPublic Function archivieren_alt() As String\n\nDim Archiv As String\nDim rs As Recordset\nDim rs2 As Recordset\nDim sql As String\nDim DatumBis As String\nDim varreturn As Variant\nDim Table() As String\nDim Tabl As String\nDim i As Integer\n\n    DatumBis = datumSQL(\"01.01.\" & year(Now))\n\n    'Archiv = PfadProd & Archiv_BE\n    Archiv = PfadTest & Archiv_BE\n    \n    \n    'Anzahl Tabellen\n    ReDim Table(10)\n    \n    'zu archivierenden Tabellen (ACHTUNG Reihenfolge nicht ändern!)\n    Table(0) = AUFTRAGSTAMM\n    Table(1) = anzTage\n    Table(2) = VASTART\n    Table(3) = PLANUNG\n    Table(4) = ZUORDNUNG\n    Table(5) = VAKOSTALT\n    Table(6) = VAAKTOKOPF\n    Table(7) = VAAKTOPOS\n    Table(8) = VAAKTOPOSM\n    Table(9) = NVERFUEG\n    Table(10) = MASTAMM\n    \n    'Ladebalken initialisieren\n    varreturn = SysCmd(acSysCmdInitMeter, \"Initialisiere...\", 1)\n    \n'=== Temporäre Tabellen löschen\n    For i = LBound(Table) To UBound(Table)\n        If TableExists(Table(i) & \"_Arc\") = True Then DoCmd.DeleteObject acTable, Table(i) & \"_Arc\"\n    Next i\n        \n   \n'=== Temporäre Tabellen erstellen\n    For i = LBound(Table) To UBound(Table)\n      DoCmd.TransferDatabase acImport, \"Microsoft Access\", PfadProd & Archiv_BE, acTable, Table(i), Table(i) & \"_Arc\", True\n    Next i\n\n\n    sql = \"SELECT * FROM \" & Table(0) & \" WHERE [Dat_VA_Von] < \" & DatumBis\n    Set rs = CurrentDb.OpenRecordset(sql)\n    \n    'Ladebalken\n    rs.MoveLast\n    rs.MoveFirst\n    varreturn = SysCmd(acSysCmdInitMeter, \"Bereite Daten für Archivierung vor...\", rs.RecordCount)\n    \n    Do\n        'Ladebalken aktualisieren\n        varreturn = SysCmd(acSysCmdUpdateMeter, rs.AbsolutePosition)\n        \n        'Auftragstamm\n        sql = \"INSERT INTO \" & Table(0) & \"_Arc SELECT * FROM \" & Table(0) & \" WHERE [ID] = \" & rs.fields(\"ID\")\n        CurrentDb.Execute sql\n        'VA_Anz_Tage\n        sql = \"INSERT INTO \" & Table(1) & \"_Arc SELECT * FROM \" & Table(1) & \" WHERE [VA_ID] = \" & rs.fields(\"ID\")\n        CurrentDb.Execute sql\n        'VA_START\n        sql = \"INSERT INTO \" & Table(2) & \"_Arc SELECT * FROM \" & Table(2) & \" WHERE [VA_ID] = \" & rs.fields(\"ID\")\n        CurrentDb.Execute sql\n        'Planung\n        sql = \"INSERT INTO \" & Table(3) & \"_Arc SELECT * FROM \" & Table(3) & \" WHERE [VA_ID] = \" & rs.fields(\"ID\")\n        CurrentDb.Execute sql\n        'Zuordnung\n        sql = \"INSERT INTO \" & Table(4) & \"_Arc SELECT * FROM \" & Table(4) & \" WHERE [VA_ID] = \" & rs.fields(\"ID\")\n        CurrentDb.Execute sql\n        'Kosten alt\n        'SQL = \"INSERT INTO \" & Table(5) & \"_Arc SELECT * FROM \" & Table(5) & \" WHERE [VA_ID] = \" & rs.Fields(\"ID\")\n        'CurrentDb.Execute SQL\n        'Aktuelles Objekt Kopf\n        sql = \"INSERT INTO \" & Table(6) & \"_Arc SELECT * FROM \" & Table(6) & \" WHERE [VA_ID] = \" & rs.fields(\"ID\")\n        CurrentDb.Execute sql\n            'Positionsdaten aktuelles Objekt\n            sql = \"SELECT * FROM \" & Table(6) & \" WHERE [VA_ID] = \" & rs.fields(\"ID\")\n            Set rs2 = CurrentDb.OpenRecordset(sql)\n            Do While Not rs2.EOF\n                'Aktuelles Objekt Posititon\n                sql = \"INSERT INTO \" & Table(7) & \"_Arc SELECT * FROM \" & Table(7) & \" WHERE [VA_Akt_Objekt_Kopf_ID] = \" & rs.fields(\"ID\")\n                CurrentDb.Execute sql\n                'Aktuelles Objekt Posititon MA\n                sql = \"INSERT INTO \" & Table(8) & \"_Arc SELECT * FROM \" & Table(8) & \" WHERE [VA_Akt_Objekt_Kopf_ID] = \" & rs.fields(\"ID\")\n                CurrentDb.Execute sql\n                \n            rs2.MoveNext\n            Loop\n            \n    rs.MoveNext\n    Loop Until rs.EOF\n    \n    'Zeiten nicht verfügbar\n    Tabl = Table(9)\n    sql = \"INSERT INTO \" & Tabl & \" IN '\" & Archiv & \"' SELECT * FROM \" & Tabl & \" WHERE [ID] NOT IN (SELECT [ID] FROM \" & Tabl & \" IN '\" & Archiv & \"')\"\n    CurrentDb.Execute sql\n    'Mitarbeiterstamm updaten\n    Tabl = Table(10)\n    sql = \"INSERT INTO \" & Tabl & \" IN '\" & Archiv & \"' SELECT * FROM \" & Tabl & \" WHERE [ID] NOT IN (SELECT [ID] FROM \" & Table(10) & \" IN '\" & Archiv & \"')\"\n    CurrentDb.Execute sql\n       \n'=== Temporäre Tabellen ins Archiv übertragen\n    varreturn = SysCmd(acSysCmdInitMeter, \"Archiviere...\", UBound(Table))\n    For i = LBound(Table) To UBound(Table)\n        varreturn = SysCmd(acSysCmdUpdateMeter, i)\n        sql = \"INSERT INTO \" & Table(0) & \" IN '\" & Archiv & \"' SELECT * FROM \" & Table(0) & \"_Arc\"\n        CurrentDb.Execute sql\n    Next i\n    \n'=== Archivierte Daten aus BE enfernen\n    varreturn = SysCmd(acSysCmdInitMeter, \"Lösche archivierte Daten...\", 1)\n    'Veranstaltungen (-> Löschweitergabe!)\n    sql = \"DELETE * FROM \" & AUFTRAGSTAMM & \" WHERE [Dat_VA_Von] < \" & DatumBis\n    CurrentDb.Execute sql\n    'Zeiten nicht verfügbar\n    sql = \"DELETE * FROM \" & NVERFUEG & \" WHERE [vonTag] < \" & DatumBis\n    CurrentDb.Execute sql\n    \n            \n'=== Temporäre Tabellen löschen\n    varreturn = SysCmd(acSysCmdInitMeter, \"Entferne temporäre Tabellen...\", UBound(Table))\n    For i = LBound(Table) To UBound(Table)\n        varreturn = SysCmd(acSysCmdUpdateMeter, i)\n        If TableExists(Table(i) & \"_Arc\") = True Then DoCmd.DeleteObject acTable, Table(i) & \"_Arc\"\n    Next i\n        \n    'Ladebalken ausblenden\n    varreturn = SysCmd(acSysCmdClearStatus)\n    Set rs = Nothing\n    Set rs2 = Nothing\n    \nEnd Function\n\n\n'Datenbankbeziehungen lesen\n'Verwendung:\n'Dim rel() As Relation\n'rel() = get_relations()\n\nFunction get_relations() As Relation()\n\nDim rel As DAO.Relation\nDim arr_rel() As Relation\nDim i As Integer\n    \n    i = 0\n    For Each rel In CurrentDb.Relations\n        ReDim Preserve arr_rel(i)\n        arr_rel(i).master = rel.Table\n        arr_rel(i).mfield = rel.fields(0).Name\n        arr_rel(i).slave = rel.ForeignTable\n        arr_rel(i).sfield = rel.fields(0).ForeignName\n        i = i + 1\n    Next rel\n      \n    get_relations = arr_rel()\n\nEnd Function\n"}
