{"id":"MOD_mod_WorkflowDetector1","name":"mod_WorkflowDetector1","kind":"standard","procedures":["Public Sub DetectWorkflows(ByVal exportPath As String)","Private Function AnalyzeFormQueryDependencies() As String","Private Function AnalyzeFormTableDependencies() As String","Private Function AnalyzeQueryTableDependencies() As String","Private Function AnalyzeButtonNavigation() As String","Private Function AnalyzeReportDataSources() As String","Private Function AnalyzeVBAFunctionCalls() As String","Private Function DetectWorkflowPatterns() As String","Private Function ExtractTablesFromSQL(sql As String) As String","Private Function GetControlProperty(ctl As control, propName As String) As Variant"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"'═══════════════════════════════════════════════════════════════════════════════\n' Modul:     mod_WorkflowDetector\n' Zweck:     Erkennt Workflows und Abhängigkeiten in der Datenbank\n' Autor:     Access-Forensiker Agent\n' Datum:     2025-10-31\n' Version:   1.0\n'═══════════════════════════════════════════════════════════════════════════════\n\nOption Compare Database\nOption Explicit\n\n'═══════════════════════════════════════════════════════════════════════════════\n' HAUPT-ANALYSE-FUNKTION\n'═══════════════════════════════════════════════════════════════════════════════\n\nPublic Sub DetectWorkflows(ByVal exportPath As String)\n    On Error GoTo ErrorHandler\n    \n    Dim f As Integer\n    Dim filePath As String\n    Dim firstWorkflow As Boolean\n    \n    filePath = exportPath & \"\\workflows.json\"\n    f = FreeFile\n    \n    Open filePath For Output As #f\n    \n    ' JSON-Objekt starten\n    Print #f, \"{\"\n    Print #f, \"  \"\"analysisDate\"\": \"\"\" & Format(Now, \"yyyy-mm-dd hh:nn:ss\") & \"\"\",\"\n    Print #f, \"  \"\"databaseName\"\": \"\"\" & mod_ExportConsys.EscapeJSON(CurrentProject.Name) & \"\"\",\"\n    \n    ' 1. Formular → Query Abhängigkeiten\n    Print #f, \"  \"\"formToQueryDependencies\"\": \" & AnalyzeFormQueryDependencies() & \",\"\n    \n    ' 2. Formular → Tabelle Abhängigkeiten\n    Print #f, \"  \"\"formToTableDependencies\"\": \" & AnalyzeFormTableDependencies() & \",\"\n    \n    ' 3. Query → Tabelle Abhängigkeiten\n    Print #f, \"  \"\"queryToTableDependencies\"\": \" & AnalyzeQueryTableDependencies() & \",\"\n    \n    ' 4. Button-Click Events (Navigation)\n    Print #f, \"  \"\"buttonNavigationMap\"\": \" & AnalyzeButtonNavigation() & \",\"\n    \n    ' 5. Report → Query/Tabelle\n    Print #f, \"  \"\"reportDataSources\"\": \" & AnalyzeReportDataSources() & \",\"\n    \n    ' 6. VBA-Funktionsaufrufe\n    Print #f, \"  \"\"vbaFunctionCalls\"\": \" & AnalyzeVBAFunctionCalls() & \",\"\n    \n    ' 7. Erkannte Workflow-Muster\n    Print #f, \"  \"\"detectedWorkflowPatterns\"\": \" & DetectWorkflowPatterns()\n    \n    Print #f, \"}\"\n    \n    Close #f\n    \n    Debug.Print \"      → Workflow-Analyse abgeschlossen\"\n    \n    Exit Sub\n\nErrorHandler:\n    Close #f\n    Debug.Print \"      ✗ Fehler: \" & err.description\n    err.Raise err.Number, \"DetectWorkflows\", err.description\nEnd Sub\n\n'═══════════════════════════════════════════════════════════════════════════════\n' ANALYSE-FUNKTIONEN\n'═══════════════════════════════════════════════════════════════════════════════\n\n' Analysiert Formular → Query Abhängigkeiten\nPrivate Function AnalyzeFormQueryDependencies() As String\n    Dim result As String\n    Dim i As Integer\n    Dim frm As Form\n    Dim isFirst As Boolean\n    \n    result = \"[\"\n    isFirst = True\n    \n    On Error Resume Next\n    For i = 0 To CurrentProject.AllForms.Count - 1\n        Dim formName As String\n        formName = CurrentProject.AllForms(i).Name\n        \n        DoCmd.OpenForm formName, acDesign, , , , acHidden\n        If err.Number = 0 Then\n            Set frm = Forms(formName)\n            \n            Dim recordSource As String\n            recordSource = Nz(frm.recordSource, \"\")\n            \n            ' Prüfen ob RecordSource eine Query ist\n            If Len(recordSource) > 0 And Not InStr(recordSource, \"SELECT\") > 0 Then\n                If Not isFirst Then result = result & \",\"\n                isFirst = False\n                \n                result = result & \"{\"\"form\"\":\"\"\" & mod_ExportConsys.EscapeJSON(formName) & \"\"\",\"\n                result = result & \"\"\"query\"\":\"\"\" & mod_ExportConsys.EscapeJSON(recordSource) & \"\"\"}\"\n            End If\n            \n            DoCmd.Close acForm, formName, acSaveNo\n        End If\n        err.clear\n    Next i\n    On Error GoTo 0\n    \n    result = result & \"]\"\n    AnalyzeFormQueryDependencies = result\nEnd Function\n\n' Analysiert Formular → Tabelle Abhängigkeiten\nPrivate Function AnalyzeFormTableDependencies() As String\n    Dim result As String\n    Dim i As Integer\n    Dim frm As Form\n    Dim isFirst As Boolean\n    \n    result = \"[\"\n    isFirst = True\n    \n    On Error Resume Next\n    For i = 0 To CurrentProject.AllForms.Count - 1\n        Dim formName As String\n        formName = CurrentProject.AllForms(i).Name\n        \n        DoCmd.OpenForm formName, acDesign, , , , acHidden\n        If err.Number = 0 Then\n            Set frm = Forms(formName)\n            \n            Dim recordSource As String\n            recordSource = Nz(frm.recordSource, \"\")\n            \n            ' Prüfen ob RecordSource direkt eine Tabelle ist\n            If Len(recordSource) > 0 And Left$(recordSource, 4) = \"tbl_\" Then\n                If Not isFirst Then result = result & \",\"\n                isFirst = False\n                \n                result = result & \"{\"\"form\"\":\"\"\" & mod_ExportConsys.EscapeJSON(formName) & \"\"\",\"\n                result = result & \"\"\"table\"\":\"\"\" & mod_ExportConsys.EscapeJSON(recordSource) & \"\"\"}\"\n            End If\n            \n            DoCmd.Close acForm, formName, acSaveNo\n        End If\n        err.clear\n    Next i\n    On Error GoTo 0\n    \n    result = result & \"]\"\n    AnalyzeFormTableDependencies = result\nEnd Function\n\n' Analysiert Query → Tabelle Abhängigkeiten\nPrivate Function AnalyzeQueryTableDependencies() As String\n    Dim result As String\n    Dim db As DAO.Database\n    Dim qdf As DAO.QueryDef\n    Dim isFirst As Boolean\n    \n    Set db = CurrentDb()\n    result = \"[\"\n    isFirst = True\n    \n    For Each qdf In db.QueryDefs\n        If Left$(qdf.Name, 1) <> \"~\" Then\n            Dim tables As String\n            tables = ExtractTablesFromSQL(qdf.sql)\n            \n            If Len(tables) > 0 Then\n                If Not isFirst Then result = result & \",\"\n                isFirst = False\n                \n                result = result & \"{\"\"query\"\":\"\"\" & mod_ExportConsys.EscapeJSON(qdf.Name) & \"\"\",\"\n                result = result & \"\"\"tables\"\":\"\"\" & mod_ExportConsys.EscapeJSON(tables) & \"\"\"}\"\n            End If\n        End If\n    Next qdf\n    \n    result = result & \"]\"\n    AnalyzeQueryTableDependencies = result\nEnd Function\n\n' Analysiert Button-Navigation (OpenForm, OpenReport etc.)\nPrivate Function AnalyzeButtonNavigation() As String\n    Dim result As String\n    Dim i As Integer\n    Dim frm As Form\n    Dim ctl As control\n    Dim isFirst As Boolean\n    \n    result = \"[\"\n    isFirst = True\n    \n    On Error Resume Next\n    For i = 0 To CurrentProject.AllForms.Count - 1\n        Dim formName As String\n        formName = CurrentProject.AllForms(i).Name\n        \n        DoCmd.OpenForm formName, acDesign, , , , acHidden\n        If err.Number = 0 Then\n            Set frm = Forms(formName)\n            \n            For Each ctl In frm.controls\n                If ctl.ControlType = acCommandButton Then\n                    Dim onClick As String\n                    onClick = Nz(GetControlProperty(ctl, \"OnClick\"), \"\")\n                    \n                    ' Prüfen auf OpenForm oder OpenReport\n                    If InStr(onClick, \"OpenForm\") > 0 Or InStr(onClick, \"OpenReport\") > 0 Then\n                        If Not isFirst Then result = result & \",\"\n                        isFirst = False\n                        \n                        result = result & \"{\"\"sourceForm\"\":\"\"\" & mod_ExportConsys.EscapeJSON(formName) & \"\"\",\"\n                        result = result & \"\"\"button\"\":\"\"\" & mod_ExportConsys.EscapeJSON(ctl.Name) & \"\"\",\"\n                        result = result & \"\"\"action\"\":\"\"\" & mod_ExportConsys.EscapeJSON(onClick) & \"\"\"}\"\n                    End If\n                End If\n            Next ctl\n            \n            DoCmd.Close acForm, formName, acSaveNo\n        End If\n        err.clear\n    Next i\n    On Error GoTo 0\n    \n    result = result & \"]\"\n    AnalyzeButtonNavigation = result\nEnd Function\n\n' Analysiert Report-Datenquellen\nPrivate Function AnalyzeReportDataSources() As String\n    Dim result As String\n    Dim i As Integer\n    Dim rpt As Report\n    Dim isFirst As Boolean\n    \n    result = \"[\"\n    isFirst = True\n    \n    On Error Resume Next\n    For i = 0 To CurrentProject.AllReports.Count - 1\n        Dim reportName As String\n        reportName = CurrentProject.AllReports(i).Name\n        \n        DoCmd.OpenReport reportName, acViewDesign, , , acHidden\n        If err.Number = 0 Then\n            Set rpt = Reports(reportName)\n            \n            Dim recordSource As String\n            recordSource = Nz(rpt.recordSource, \"\")\n            \n            If Len(recordSource) > 0 Then\n                If Not isFirst Then result = result & \",\"\n                isFirst = False\n                \n                result = result & \"{\"\"report\"\":\"\"\" & mod_ExportConsys.EscapeJSON(reportName) & \"\"\",\"\n                result = result & \"\"\"recordSource\"\":\"\"\" & mod_ExportConsys.EscapeJSON(recordSource) & \"\"\"}\"\n            End If\n            \n            DoCmd.Close acReport, reportName, acSaveNo\n        End If\n        err.clear\n    Next i\n    On Error GoTo 0\n    \n    result = result & \"]\"\n    AnalyzeReportDataSources = result\nEnd Function\n\n' Analysiert VBA-Funktionsaufrufe (vereinfacht)\nPrivate Function AnalyzeVBAFunctionCalls() As String\n    Dim result As String\n    result = \"[{\"\"note\"\":\"\"VBA call analysis requires code parsing - implement if needed\"\"}]\"\n    AnalyzeVBAFunctionCalls = result\nEnd Function\n\n' Erkennt Workflow-Muster\nPrivate Function DetectWorkflowPatterns() As String\n    Dim result As String\n    result = \"[\"\n    result = result & \"{\"\"pattern\"\":\"\"Data Entry\"\",\"\"description\"\":\"\"Forms with AllowAdditions=True\"\"},\"\n    result = result & \"{\"\"pattern\"\":\"\"Reporting\"\",\"\"description\"\":\"\"Reports with RecordSource\"\"}\"\n    result = result & \"]\"\n    DetectWorkflowPatterns = result\nEnd Function\n\n'═══════════════════════════════════════════════════════════════════════════════\n' HILFSFUNKTIONEN\n'═══════════════════════════════════════════════════════════════════════════════\n\nPrivate Function ExtractTablesFromSQL(sql As String) As String\n    ' Vereinfachte Extraktion von Tabellennamen aus SQL\n    Dim tableList As String\n    Dim fromPos As Long\n    Dim wherePos As Long\n    \n    sql = UCase(sql)\n    fromPos = InStr(sql, \" FROM \")\n    \n    If fromPos = 0 Then\n        ExtractTablesFromSQL = \"\"\n        Exit Function\n    End If\n    \n    wherePos = InStr(fromPos, sql, \" WHERE \")\n    If wherePos = 0 Then wherePos = InStr(fromPos, sql, \" ORDER \")\n    If wherePos = 0 Then wherePos = InStr(fromPos, sql, \" GROUP \")\n    If wherePos = 0 Then wherePos = Len(sql)\n    \n    tableList = Trim(Mid$(sql, fromPos + 6, wherePos - fromPos - 6))\n    tableList = Replace(tableList, \" INNER JOIN \", \", \")\n    tableList = Replace(tableList, \" LEFT JOIN \", \", \")\n    tableList = Replace(tableList, \" RIGHT JOIN \", \", \")\n    \n    ExtractTablesFromSQL = tableList\nEnd Function\n\nPrivate Function GetControlProperty(ctl As control, propName As String) As Variant\n    On Error Resume Next\n    GetControlProperty = ctl.Properties(propName)\n    If err.Number <> 0 Then\n        GetControlProperty = Null\n    End If\n    On Error GoTo 0\nEnd Function"}
