{"id":"MOD_modAIEngine","name":"modAIEngine","kind":"standard","procedures":["Private Function AI_GetRunnerRoot() As String","Private Function AI_GetInboxPath() As String","Private Function AI_GetLogFile() As String","Private Sub AI_EnsureDir(ByVal p As String)","Private Sub AI_SafeDelete(ByVal p As String)","Private Function AI_IsFormOpen(ByVal formName As String) As Boolean","Private Sub AI_ReopenIfClosed(ByVal formName As String)","Private Sub AI_EnsureHost()","Private Sub AI_Log(ByVal msg As String)","Public Sub AI_ProcessInbox()","Private Function AI_ReadFileAsCleanString(ByVal filePath As String) As String","Private Function AI_StripBOM(ByVal s As String) As String","Private Sub AI_ProcessFile(ByVal filePath As String)","Private Sub AI_DoCreateFormFromTemplate(ByVal formName As String, ByVal TemplateName As String, _","Private Sub AI_AddControlsList(ByVal formName As String, ByVal controlsList As String)","Private Sub AI_DoAddButtonEx(ByVal formName As String, ByVal btnName As String, ByVal btnCaption As String, ByVal sectionName As String)","Private Function AI_ControlExists(ByVal formName As String, ByVal ctrlName As String) As Boolean","Private Function AI_GetSectionNumberByName(ByVal sectionName As String) As Integer","Private Function AI_GetField(ByVal blob As String, ByVal key As String) As String","Private Function AI_TableHasField(ByVal tbl As String, ByVal fld As String) As Boolean","Private Function AI_FirstExistingField(ByVal tbl As String, ParamArray names()) As String","Private Function AI_ParseDate(ByVal s As String) As Date","Private Function AI_AuftragPK() As String","Private Function AI_FindAuftragId(ByVal d As Date, ByVal titel As String, ByVal Objekt As String) As Variant","Private Sub AI_EnsureAnzTag(ByVal auftragId As Variant, ByVal d As Date)","Private Sub AI_EnsureAnzTageForRange(ByVal auftragId As Variant, ByVal vonD As Date, ByVal bisD As Date)","Private Function AI_EnsureAuftrag(ByVal title As String, ByVal dFrom As Date, ByVal dTo As Date, _","Private Sub AI_InsertZuordnung(ByVal auftragId As Variant, ByVal maID As Variant, _","Private Sub AI_Action_CreateAuftrag(ByVal blob As String)","Private Sub AI_Action_CreateAuftragMulti(ByVal blob As String)","Private Sub AI_Action_AssignMA(ByVal blob As String)"],"calls":{"DoCmd.OpenForm":["frm_AIRunner_Host"],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"'=== mdl_AccessRunner =======================================================\nOption Compare Database\nOption Explicit\n\n' --- Tabellen-Konstanten ---\nPrivate Const TBL_AUF  As String = \"tbl_VA_Auftragstamm\"\nPrivate Const TBL_ZUO  As String = \"tbl_ma_va_zuordnung\"\nPrivate Const TBL_TAGE As String = \"tbl_VA_AnzTage\"\n\n' --- Versionssichere Section-Konstanten für Formulare ---\nPrivate Const AI_SEC_DETAIL      As Integer = 0\nPrivate Const AI_SEC_FORMHEADER  As Integer = 1\nPrivate Const AI_SEC_FORMFOOTER  As Integer = 2\n\n' =======================================================================\n' Pfade/Helfer\n' =======================================================================\nPrivate Function AI_GetRunnerRoot() As String\n    AI_GetRunnerRoot = Environ$(\"USERPROFILE\") & \"\\Documents\\000_Runner\"\nEnd Function\n\nPrivate Function AI_GetInboxPath() As String\n    AI_GetInboxPath = AI_GetRunnerRoot() & \"\\inbox\"\nEnd Function\n\nPrivate Function AI_GetLogFile() As String\n    AI_GetLogFile = AI_GetRunnerRoot() & \"\\logs\\access_runner_log.txt\"\nEnd Function\n\nPrivate Sub AI_EnsureDir(ByVal p As String)\n    On Error Resume Next\n    If Len(Dir(p, vbDirectory)) = 0 Then MkDir p\nEnd Sub\n\nPrivate Sub AI_SafeDelete(ByVal p As String)\n    On Error Resume Next\n    If Len(Dir(p)) > 0 Then Kill p\nEnd Sub\n\n' =======================================================================\n' Form-Utils\n' =======================================================================\nPrivate Function AI_IsFormOpen(ByVal formName As String) As Boolean\n    On Error Resume Next\n    AI_IsFormOpen = (SysCmd(acSysCmdGetObjectState, acForm, formName) And acObjStateOpen) <> 0\nEnd Function\n\nPrivate Sub AI_ReopenIfClosed(ByVal formName As String)\n    On Error Resume Next\n    If Not AI_IsFormOpen(formName) Then\n        DoCmd.OpenForm formName, acNormal\n    End If\nEnd Sub\n\nPrivate Sub AI_EnsureHost()\n    On Error Resume Next\n    If Not AI_IsFormOpen(\"frm_AIRunner_Host\") Then\n        DoCmd.OpenForm \"frm_AIRunner_Host\", , , , , acHidden\n        Forms(\"frm_AIRunner_Host\").TimerInterval = 10000\n        Forms(\"frm_AIRunner_Host\").OnTimer = \"=AI_ProcessInbox()\"\n    End If\nEnd Sub\n\n' =======================================================================\n' Logging\n' =======================================================================\nPrivate Sub AI_Log(ByVal msg As String)\n    On Error Resume Next\n    Dim f As Integer, p As String\n    p = AI_GetLogFile()\n    AI_EnsureDir AI_GetRunnerRoot()\n    AI_EnsureDir AI_GetRunnerRoot() & \"\\logs\"\n    f = FreeFile\n    Open p For Append As #f\n        Print #f, Format(Now, \"yyyy-mm-dd hh:nn:ss\"); \"  - \"; msg\n    Close #f\nEnd Sub\n\n' =======================================================================\n' TIMER-EINSTIEG\n' =======================================================================\nPublic Sub AI_ProcessInbox()\n    On Error GoTo FIN\n    Application.Echo False\n    DoCmd.SetWarnings False\n\n    ' 1) Ordner sicherstellen\n    Dim root As String, inbox As String, logs As String\n    root = AI_GetRunnerRoot()\n    inbox = AI_GetInboxPath()\n    logs = root & \"\\logs\"\n    AI_EnsureDir root\n    AI_EnsureDir inbox\n    AI_EnsureDir logs\n\n    ' 2) Merken, ob dein Main-Form offen war (z. B. Auftragsstamm)\n    Dim keepForm As String, wasOpen As Boolean\n    keepForm = \"frm_va_auftragstamm\"\n    wasOpen = AI_IsFormOpen(keepForm)\n\n    ' 3) Nur *.txt verarbeiten\n    Dim f As String, filePath As String\n    f = Dir(inbox & \"\\*.txt\")\n    If Len(f) = 0 Then GoTo FIN\n\n    Do While Len(f) > 0\n        filePath = inbox & \"\\\" & f\n        On Error Resume Next\n        AI_Log \"Processing file: \" & filePath\n        On Error GoTo PF\n\n        AI_ProcessFile filePath\n        AI_SafeDelete filePath\n\n        GoTo NEXTFILE\n\nPF:\n        AI_Log \"Fehler PROCESS_FILE: \" & err.Number & \" / \" & err.description\n        ' Datei liegen lassen, falls nötig\n\nNEXTFILE:\n        f = Dir()\n    Loop\n\nFIN:\n    DoCmd.SetWarnings True\n    Application.Echo True\n    If wasOpen Then AI_ReopenIfClosed keepForm\nEnd Sub\n\n' =======================================================================\n' Datei lesen / Normalisieren\n' =======================================================================\nPrivate Function AI_ReadFileAsCleanString(ByVal filePath As String) As String\n    On Error GoTo EH\n    Dim h As Integer, L As Long, b() As Byte, i As Long, s As String\n    h = FreeFile\n    Open filePath For Binary As #h\n        L = LOF(h)\n        If L > 0 Then\n            ReDim b(1 To L)\n            Get #h, , b\n        End If\n    Close #h\n\n    For i = LBound(b) To UBound(b)\n        If b(i) <> 0 Then s = s & Chr$(b(i))\n    Next i\n    s = Replace(s, \"ï»¿\", \"\")\n    s = Replace(s, ChrW$(&HFEFF), \"\")\n    AI_ReadFileAsCleanString = s\n    Exit Function\nEH:\n    AI_ReadFileAsCleanString = \"\"\nEnd Function\n\nPrivate Function AI_StripBOM(ByVal s As String) As String\n    If Left$(s, 3) = \"ï»¿\" Then\n        AI_StripBOM = Mid$(s, 4)\n    ElseIf Len(s) > 0 And AscW(Left$(s, 1)) = &HFEFF Then\n        AI_StripBOM = Mid$(s, 2)\n    Else\n        AI_StripBOM = s\n    End If\nEnd Function\n\n' =======================================================================\n' Instruction-Datei parsen/dispatchen\n' =======================================================================\nPrivate Sub AI_ProcessFile(ByVal filePath As String)\n    On Error GoTo EH\n\n    Dim content As String, blocks() As String, block As Variant\n    Dim lines() As String, ln As Variant\n    Dim aAction As String, aForm As String, aName As String, aCaption As String\n    Dim aTemplate As String, aControls As String, aSection As String\n\n    content = AI_ReadFileAsCleanString(filePath)\n    content = Replace(content, \"`r`n\", vbCrLf)\n    content = Replace(content, vbCr, vbLf)\n    content = Replace(content, vbLf & vbLf & vbLf, vbLf & vbLf)\n\n    blocks = Split(content, vbLf & vbLf)\n    If UBound(blocks) < 0 Then\n        ReDim blocks(0): blocks(0) = content\n    End If\n\n    For Each block In blocks\n        If Trim$(block) <> \"\" Then\n            aAction = \"\": aForm = \"\": aName = \"\": aCaption = \"\"\n            aTemplate = \"\": aControls = \"\": aSection = \"\"\n\n            lines = Split(CStr(block), vbLf)\n            For Each ln In lines\n                ln = Trim$(AI_StripBOM(ln))\n                If ln <> \"\" Then\n                    If UCase$(Left$(ln, 7)) = \"ACTION=\" Then aAction = Mid$(ln, 8)\n                    If UCase$(Left$(ln, 5)) = \"FORM=\" Then aForm = Mid$(ln, 6)\n                    If UCase$(Left$(ln, 5)) = \"NAME=\" Then aName = Mid$(ln, 6)\n                    If UCase$(Left$(ln, 8)) = \"CAPTION=\" Then aCaption = Mid$(ln, 9)\n                    If UCase$(Left$(ln, 9)) = \"TEMPLATE=\" Then aTemplate = Mid$(ln, 10)\n                    If UCase$(Left$(ln, 9)) = \"CONTROLS=\" Then aControls = Mid$(ln, 10)\n                    If UCase$(Left$(ln, 8)) = \"SECTION=\" Then aSection = Mid$(ln, 9)\n                End If\n            Next ln\n\n            Select Case UCase$(Trim$(aAction))\n\n                Case \"CREATE_FORM\"\n                    Call AI_DoCreateFormFromTemplate(aForm, aTemplate, aCaption, aControls)\n\n                Case \"ADD_BUTTON\", \"ADD_BUTTONS\"\n                    Call AI_DoAddButtonEx(aForm, aName, aCaption, aSection)\n\n                Case \"CREATE_AUFTRAG\"\n                    Call AI_Action_CreateAuftrag(block)\n\n                Case \"CREATE_AUFTRAG_MULTI\"\n                    Call AI_Action_CreateAuftragMulti(block)\n\n                Case \"ASSIGN_MA\"\n                    Call AI_Action_AssignMA(block)\n\n                Case Else\n                    If Trim$(aAction) <> \"\" Then AI_Log \"Unknown ACTION: \" & aAction\n            End Select\n        End If\n    Next block\n    Exit Sub\n\nEH:\n    AI_Log \"Fehler PROCESS_FILE: \" & err.Number & \" / \" & err.description\nEnd Sub\n\n' =======================================================================\n' Formulare/Buttons\n' =======================================================================\nPrivate Sub AI_DoCreateFormFromTemplate(ByVal formName As String, ByVal TemplateName As String, _\n                                        ByVal captionText As String, ByVal controlsList As String)\n    On Error GoTo EH\n    If formName = \"\" Then Exit Sub\n    If TemplateName = \"\" Then TemplateName = \"frm_N_template\"\n\n    Dim cleanCaption As String\n    cleanCaption = formName\n    cleanCaption = Replace(cleanCaption, \"frm_\", \"\", , , vbTextCompare)\n    cleanCaption = Replace(cleanCaption, \"_N_\", \" \", , , vbTextCompare)\n    cleanCaption = Replace(cleanCaption, \"_\", \" \")\n    If Len(Trim$(captionText)) > 0 Then cleanCaption = captionText\n\n    DoCmd.OpenForm TemplateName, acDesign\n    DoCmd.Save acForm, TemplateName\n    DoCmd.CopyObject , formName, acForm, TemplateName\n\n    DoCmd.OpenForm formName, acDesign\n    Forms(formName).caption = cleanCaption\n\n    Dim lbl As control\n    Set lbl = CreateControl(formName, acLabel, AI_SEC_FORMHEADER, , , 200, 200, 3000, 400)\n    lbl.caption = cleanCaption\n    lbl.FontBold = True\n\n    If Len(Trim$(controlsList)) > 0 Then\n        Call AI_AddControlsList(formName, controlsList)\n    End If\n\n    DoCmd.Close acForm, formName, acSaveYes\n    AI_Log \"Formular angelegt aus Template: \" & cleanCaption & \" (\" & TemplateName & \")\"\n    Exit Sub\n\nEH:\n    AI_Log \"Fehler CREATE_FORM: \" & err.Number & \" / \" & err.description\n    On Error Resume Next\n    DoCmd.Close acForm, formName, acSaveNo\nEnd Sub\n\nPrivate Sub AI_AddControlsList(ByVal formName As String, ByVal controlsList As String)\n    On Error GoTo EH\n    Dim parts() As String, i As Long, one As String\n    Dim nm As String, sec As String, p As Long\n\n    parts = Split(controlsList, \",\")\n    For i = LBound(parts) To UBound(parts)\n        one = Trim$(parts(i))\n        If one <> \"\" Then\n            p = InStr(1, one, \":\", vbTextCompare)\n            If p > 0 Then\n                nm = Trim$(Left$(one, p - 1))\n                sec = Trim$(Mid$(one, p + 1))\n                Call AI_DoAddButtonEx(formName, nm, nm, sec)\n            Else\n                Call AI_DoAddButtonEx(formName, one, one, \"Detail\")\n            End If\n        End If\n    Next i\n    Exit Sub\nEH:\n    AI_Log \"Fehler CONTROLS: \" & err.Number & \" / \" & err.description\nEnd Sub\n\nPrivate Sub AI_DoAddButtonEx(ByVal formName As String, ByVal btnName As String, ByVal btnCaption As String, ByVal sectionName As String)\n    On Error GoTo EH\n    If Len(Trim$(formName)) = 0 Then Exit Sub\n\n    Dim sectionConst As Integer\n    sectionConst = AI_GetSectionNumberByName(sectionName)\n    If sectionConst < 0 Then sectionConst = AI_SEC_DETAIL\n\n    DoCmd.OpenForm formName, acDesign\n    Dim frm As Form\n    Set frm = Forms(formName)\n\n    Dim secObj As Access.Section\n    On Error Resume Next\n    Set secObj = frm.Section(sectionConst)\n    On Error GoTo EH\n    If secObj Is Nothing Then\n        DoCmd.RunCommand acCmdFormView\n        DoCmd.RunCommand acCmdDesignView\n        Set frm = Forms(formName)\n        Set secObj = frm.Section(sectionConst)\n    End If\n    If Not secObj Is Nothing Then\n        If secObj.height < 1200 Then secObj.height = 1200\n    End If\n\n    If Len(Trim$(btnName)) = 0 Then btnName = \"cmd_AI_\" & Format(Now, \"hhmmss\")\n    If Len(Trim$(btnCaption)) = 0 Then btnCaption = \"AI\"\n\n    If AI_ControlExists(formName, btnName) Then\n        Dim base As String, n As Long\n        base = btnName: n = 1\n        Do While AI_ControlExists(formName, base & \"_\" & n)\n            n = n + 1\n        Loop\n        btnName = base & \"_\" & n\n        AI_Log \"Hinweis: Buttonname existierte bereits, benutzt: \" & btnName\n    End If\n\n    Dim lastTop As Long:   lastTop = 500\n    Dim lastLeft As Long:  lastLeft = 500\n    Dim lastH As Long:     lastH = 500\n    Dim lastW As Long:     lastW = 1800\n\n    Dim c As control, haveTemplate As Boolean\n    For Each c In frm.controls\n        If c.Section = sectionConst And c.ControlType = acCommandButton Then\n            If c.Top + c.height > lastTop Then\n                lastTop = c.Top + c.height\n                lastLeft = c.Left\n                lastH = c.height\n                lastW = c.width\n            End If\n            haveTemplate = True\n        End If\n    Next c\n    lastTop = lastTop + 120\n\n    Dim ctl As control\n    Set ctl = CreateControl(formName, acCommandButton, sectionConst, , , lastLeft, lastTop, lastW, lastH)\n    ctl.Name = btnName\n    ctl.caption = btnCaption\n\n    If haveTemplate Then\n        For Each c In frm.controls\n            If c.Section = sectionConst And c.ControlType = acCommandButton Then\n                On Error Resume Next\n                ctl.foreColor = c.foreColor\n                ctl.backColor = c.backColor\n                ctl.FontName = c.FontName\n                ctl.FontSize = c.FontSize\n                ctl.FontWeight = c.FontWeight\n                ctl.SpecialEffect = c.SpecialEffect\n                ctl.BorderColor = c.BorderColor\n                On Error GoTo EH\n                Exit For\n            End If\n        Next c\n    End If\n\n    DoCmd.Close acForm, formName, acSaveYes\n    AI_Log \"ADD_BUTTON OK: \" & formName & \" / \" & btnName & \" / \" & btnCaption & \" / sec=\" & CStr(sectionConst)\n    Exit Sub\n\nEH:\n    AI_Log \"Fehler ADD_BUTTON: \" & err.Number & \" / \" & err.description\n    On Error Resume Next\n    DoCmd.Close acForm, formName, acSaveNo\nEnd Sub\n\nPrivate Function AI_ControlExists(ByVal formName As String, ByVal ctrlName As String) As Boolean\n    On Error GoTo NX\n    Dim t As control\n    Set t = Forms(formName).controls(ctrlName)\n    AI_ControlExists = True\n    Exit Function\nNX:\n    AI_ControlExists = False\nEnd Function\n\nPrivate Function AI_GetSectionNumberByName(ByVal sectionName As String) As Integer\n    Dim s As String: s = LCase$(Trim$(sectionName))\n    Select Case s\n        Case \"formheader\", \"header\", \"kopf\", \"formularkopf\"\n            AI_GetSectionNumberByName = AI_SEC_FORMHEADER\n        Case \"detail\", \"detailbereich\", \"haupt\"\n            AI_GetSectionNumberByName = AI_SEC_DETAIL\n        Case \"formfooter\", \"footer\", \"fuß\", \"fuss\", \"formularfuß\", \"formularfuss\"\n            AI_GetSectionNumberByName = AI_SEC_FORMFOOTER\n        Case Else\n            AI_GetSectionNumberByName = -1\n    End Select\nEnd Function\n\n' =======================================================================\n' Mini-Parser / DB-Helfer\n' =======================================================================\nPrivate Function AI_GetField(ByVal blob As String, ByVal key As String) As String\n    Dim i As Long, ln As String, lines() As String, k As String\n    blob = Replace(blob, \"`r`n\", vbCrLf)\n    blob = Replace(blob, vbCr, vbLf)\n    lines = Split(blob, vbLf)\n    For i = LBound(lines) To UBound(lines)\n        ln = Trim$(lines(i))\n        If ln <> \"\" Then\n            k = UCase$(key) & \"=\"\n            If UCase$(Left$(ln, Len(k))) = k Then\n                AI_GetField = Mid$(ln, Len(k) + 1)\n                Exit Function\n            End If\n        End If\n    Next\n    AI_GetField = \"\"\nEnd Function\n\nPrivate Function AI_TableHasField(ByVal tbl As String, ByVal fld As String) As Boolean\n    Dim t As DAO.TableDef, f As DAO.field\n    On Error GoTo NX\n    Set t = CurrentDb.TableDefs(tbl)\n    For Each f In t.fields\n        If StrComp(f.Name, fld, vbTextCompare) = 0 Then AI_TableHasField = True: Exit Function\n    Next\nNX:\nEnd Function\n\nPrivate Function AI_FirstExistingField(ByVal tbl As String, ParamArray names()) As String\n    Dim i As Long\n    For i = LBound(names) To UBound(names)\n        If AI_TableHasField(tbl, CStr(names(i))) Then\n            AI_FirstExistingField = CStr(names(i))\n            Exit Function\n        End If\n    Next\n    AI_FirstExistingField = \"\"\nEnd Function\n\nPrivate Function AI_ParseDate(ByVal s As String) As Date\n    On Error Resume Next\n    If IsDate(s) Then AI_ParseDate = CDate(s) Else AI_ParseDate = 0\nEnd Function\n\n' =======================================================================\n' Auftragslogik + Tageszeilen\n' =======================================================================\nPrivate Function AI_AuftragPK() As String\n    AI_AuftragPK = AI_FirstExistingField(TBL_AUF, \"ID\", \"AuftragID\", \"VA_ID\", \"PK\", \"Auftrag_Id\")\nEnd Function\n\nPrivate Function AI_FindAuftragId(ByVal d As Date, ByVal titel As String, ByVal Objekt As String) As Variant\n    On Error GoTo EH\n    Dim pk As String: pk = AI_AuftragPK()\n    If pk = \"\" Then Exit Function\n\n    Dim sql As String, rs As DAO.Recordset\n    sql = \"SELECT \" & pk & \" FROM \" & TBL_AUF & _\n          \" WHERE Dat_VA_Von = #\" & Month(d) & \"/\" & Day(d) & \"/\" & year(d) & \"# \" & _\n          \" AND Auftrag = '\" & Replace(titel, \"'\", \"''\") & \"' \" & _\n          \" AND Objekt  = '\" & Replace(Objekt, \"'\", \"''\") & \"'\"\n    Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n    If Not rs.EOF Then AI_FindAuftragId = rs.fields(0).Value Else AI_FindAuftragId = Null\n    rs.Close\n    Exit Function\nEH:\n    AI_FindAuftragId = Null\nEnd Function\n\n' --- NEU: Tageszeilen sicherstellen ------------------------------------\nPrivate Sub AI_EnsureAnzTag(ByVal auftragId As Variant, ByVal d As Date)\n    On Error GoTo EH\n    If IsNull(auftragId) Or auftragId = 0 Or d = 0 Then Exit Sub\n\n    Dim fldVA As String, fldDatum As String, fldFlag As String\n    fldVA = AI_FirstExistingField(TBL_TAGE, \"VA_ID\", \"AuftragID\", \"VA_Auftrag_ID\", \"ID_Auftrag\", \"Auftrag_Id\")\n    fldDatum = AI_FirstExistingField(TBL_TAGE, \"VADatum\", \"VA_Datum\", \"Datum\", \"Tag\")\n    fldFlag = AI_FirstExistingField(TBL_TAGE, \"Aktiv\", \"Sichtbar\", \"Anzeigen\", \"Enabled\", \"Gültig\", \"Gueltig\")\n\n    If fldVA = \"\" Or fldDatum = \"\" Then\n        AI_Log \"ANZTAGE: Feldnamen nicht gefunden (VA/Datum).\"\n        Exit Sub\n    End If\n\n    Dim sql As String, rs As DAO.Recordset\n    sql = \"SELECT * FROM \" & TBL_TAGE & _\n          \" WHERE \" & fldVA & \"=\" & CLng(auftragId) & _\n          \" AND \" & fldDatum & \"=#\" & Month(d) & \"/\" & Day(d) & \"/\" & year(d) & \"#\"\n    Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n    If Not rs.EOF Then\n        rs.Close: Set rs = Nothing\n        Exit Sub\n    End If\n    rs.Close: Set rs = Nothing\n\n    Set rs = CurrentDb.OpenRecordset(TBL_TAGE, dbOpenDynaset)\n    rs.AddNew\n    rs.fields(fldVA).Value = CLng(auftragId)\n    rs.fields(fldDatum).Value = DateValue(d)\n    If fldFlag <> \"\" Then\n        On Error Resume Next\n        rs.fields(fldFlag).Value = True\n        On Error GoTo EH\n    End If\n    rs.update\n    rs.Close\n    Set rs = Nothing\n\n    AI_Log \"ANZTAGE OK: VA_ID=\" & auftragId & \" / \" & Format$(d, \"dd.mm.yyyy\")\n    Exit Sub\nEH:\n    AI_Log \"Fehler ANZTAGE: \" & err.Number & \" / \" & err.description\n    On Error Resume Next\n    If Not rs Is Nothing Then\n        If rs.EditMode <> dbEditNone Then rs.CancelUpdate\n        rs.Close\n    End If\n    Set rs = Nothing\nEnd Sub\n\nPrivate Sub AI_EnsureAnzTageForRange(ByVal auftragId As Variant, ByVal vonD As Date, ByVal bisD As Date)\n    Dim d As Date\n    If vonD = 0 Then Exit Sub\n    If bisD = 0 Then bisD = vonD\n    If bisD < vonD Then bisD = vonD\n    For d = DateValue(vonD) To DateValue(bisD)\n        Call AI_EnsureAnzTag(auftragId, d)\n    Next d\nEnd Sub\n' -----------------------------------------------------------------------\n\nPrivate Function AI_EnsureAuftrag(ByVal title As String, ByVal dFrom As Date, ByVal dTo As Date, _\n                                  ByVal Ort As String, ByVal Objekt As String, _\n                                  ByVal veranstId As Long) As Variant\n    On Error GoTo EH\n\n    Dim ID As Variant\n    ID = AI_FindAuftragId(dFrom, title, Objekt)\n    If Not IsNull(ID) Then\n        ' auch bei bestehendem Auftrag die Tage sicherstellen\n        Call AI_EnsureAnzTageForRange(ID, dFrom, dTo)\n        AI_EnsureAuftrag = ID\n        Exit Function\n    End If\n\n    Dim pk As String: pk = AI_AuftragPK()\n    If pk = \"\" Then AI_Log \"Auftrag PK-Feld unbekannt\": Exit Function\n\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset(TBL_AUF, dbOpenDynaset)\n    rs.AddNew\n    If AI_TableHasField(TBL_AUF, \"Dat_VA_Von\") Then rs!Dat_VA_Von = dFrom\n    If AI_TableHasField(TBL_AUF, \"Dat_VA_Bis\") Then rs!Dat_VA_Bis = IIf(dTo = 0, dFrom, dTo)\n    If AI_TableHasField(TBL_AUF, \"Auftrag\") Then rs!Auftrag = title\n    If AI_TableHasField(TBL_AUF, \"Ort\") Then rs!Ort = Ort\n    If AI_TableHasField(TBL_AUF, \"Objekt\") Then rs!Objekt = Objekt\n    If AI_TableHasField(TBL_AUF, \"VeranstalterID\") Then rs!VeranstalterID = veranstId\n    If AI_TableHasField(TBL_AUF, \"Treffpunkt\") Then rs!Treffpunkt = \"15 min vor DB vor Ort\"\n    If AI_TableHasField(TBL_AUF, \"Dienstkleidung\") Then rs!Dienstkleidung = \"Consec\"\n    If AI_TableHasField(TBL_AUF, \"Erstellt_Am\") Then rs!Erstellt_Am = Now()\n    If AI_TableHasField(TBL_AUF, \"Erstellt_Von\") Then rs!Erstellt_Von = Environ$(\"USERNAME\")\n    rs.update\n    rs.Close\n    Set rs = Nothing\n\n    ' ID erneut bestimmen und Tage anlegen\n    ID = AI_FindAuftragId(dFrom, title, Objekt)\n    AI_EnsureAuftrag = ID\n    If Not IsNull(ID) Then\n        Call AI_EnsureAnzTageForRange(ID, dFrom, dTo)\n    End If\n    Exit Function\n\nEH:\n    AI_Log \"Fehler EnsureAuftrag: \" & err.Number & \" / \" & err.description\nEnd Function\n\nPrivate Sub AI_InsertZuordnung(ByVal auftragId As Variant, ByVal maID As Variant, _\n                               ByVal von As Date, ByVal bis As Date, _\n                               ByVal rolle As String, ByVal stunden As Double)\n    On Error GoTo EH\n\n    Dim fldAuftrag As String, fldMA As String, fldVon As String, fldBis As String, fldRolle As String, fldStd As String\n    fldAuftrag = AI_FirstExistingField(TBL_ZUO, \"AuftragID\", \"VA_ID\", \"Auftrag_Id\", \"VA_Auftrag_ID\", \"ID_Auftrag\")\n    fldMA = AI_FirstExistingField(TBL_ZUO, \"MA_ID\", \"MitarbeiterID\", \"ID_MA\", \"Mitarbeiter_Id\")\n    fldVon = AI_FirstExistingField(TBL_ZUO, \"Von\", \"Dat_Von\", \"Datum_Von\", \"Beginn_Datum\")\n    fldBis = AI_FirstExistingField(TBL_ZUO, \"Bis\", \"Dat_Bis\", \"Datum_Bis\", \"Ende_Datum\")\n    fldRolle = AI_FirstExistingField(TBL_ZUO, \"Rolle\", \"Funktion\", \"Tätigkeit\")\n    fldStd = AI_FirstExistingField(TBL_ZUO, \"Stunden\", \"Std\", \"Arbeitsstunden\")\n\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset(TBL_ZUO, dbOpenDynaset)\n    rs.AddNew\n    If fldAuftrag <> \"\" Then rs.fields(fldAuftrag).Value = auftragId\n    If fldMA <> \"\" Then rs.fields(fldMA).Value = maID\n    If fldVon <> \"\" Then rs.fields(fldVon).Value = IIf(von = 0, Date, von)\n    If fldBis <> \"\" Then rs.fields(fldBis).Value = IIf(bis = 0, IIf(von = 0, Date, von), bis)\n    If fldRolle <> \"\" Then rs.fields(fldRolle).Value = rolle\n    If fldStd <> \"\" Then rs.fields(fldStd).Value = stunden\n    rs.update\n    rs.Close\n\n    AI_Log \"ZUORDNUNG OK: MA=\" & maID & \" -> AuftragID=\" & auftragId\n    Exit Sub\n\nEH:\n    AI_Log \"Fehler InsertZuordnung: \" & err.Number & \" / \" & err.description\n    On Error Resume Next\n    If Not rs Is Nothing Then\n        If rs.EditMode <> dbEditNone Then rs.CancelUpdate\n        rs.Close\n    End If\nEnd Sub\n\n' =======================================================================\n' ACTION-Handler\n' =======================================================================\nPrivate Sub AI_Action_CreateAuftrag(ByVal blob As String)\n    Dim title As String, Ort As String, Objekt As String\n    Dim veranst As Long, d As Date, ID As Variant\n\n    title = AI_GetField(blob, \"TITLE\")\n    Ort = AI_GetField(blob, \"ORT\")\n    Objekt = AI_GetField(blob, \"OBJEKT\")\n    veranst = val(AI_GetField(blob, \"VERANSTALTER_ID\"))\n    d = AI_ParseDate(AI_GetField(blob, \"DATE\"))\n\n    If title = \"\" Or d = 0 Then AI_Log \"CREATE_AUFTRAG: fehlende Felder\": Exit Sub\n\n    ID = AI_EnsureAuftrag(title, d, d, Ort, Objekt, veranst)\n    If Not IsNull(ID) Then\n        AI_Log \"CREATE_AUFTRAG OK: \" & title & \" / \" & Format(d, \"dd.mm.yyyy\") & \" / ID=\" & ID\n    Else\n        AI_Log \"CREATE_AUFTRAG: keine ID erhalten\"\n    End If\nEnd Sub\n\nPrivate Sub AI_Action_CreateAuftragMulti(ByVal blob As String)\n    Dim title As String, Ort As String, Objekt As String\n    Dim veranst As Long, d1 As Date, d2 As Date, ID As Variant\n\n    title = AI_GetField(blob, \"TITLE\")\n    Ort = AI_GetField(blob, \"ORT\")\n    Objekt = AI_GetField(blob, \"OBJEKT\")\n    veranst = val(AI_GetField(blob, \"VERANSTALTER_ID\"))\n    d1 = AI_ParseDate(AI_GetField(blob, \"DATE_FROM\"))\n    d2 = AI_ParseDate(AI_GetField(blob, \"DATE_TO\"))\n    If d2 = 0 Then d2 = d1\n\n    If title = \"\" Or d1 = 0 Then AI_Log \"CREATE_AUFTRAG_MULTI: fehlende Felder\": Exit Sub\n\n    ID = AI_EnsureAuftrag(title, d1, d2, Ort, Objekt, veranst)\n    If Not IsNull(ID) Then\n        AI_Log \"CREATE_AUFTRAG_MULTI OK: \" & title & \" / \" & _\n               Format(d1, \"dd.mm.yyyy\") & \"-\" & Format(d2, \"dd.mm.yyyy\") & \" / ID=\" & ID\n    Else\n        AI_Log \"CREATE_AUFTRAG_MULTI: keine ID erhalten\"\n    End If\nEnd Sub\n\nPrivate Sub AI_Action_AssignMA(ByVal blob As String)\n    Dim auftragId As Variant, maID As Variant\n    Dim d As Date, title As String, Objekt As String\n    Dim vonD As Date, bisD As Date, rolle As String, std As Double\n\n    auftragId = Null\n    If Len(Trim$(AI_GetField(blob, \"AUFTRAG_ID\"))) > 0 Then\n        auftragId = CLng(val(AI_GetField(blob, \"AUFTRAG_ID\")))\n    Else\n        title = AI_GetField(blob, \"TITLE\")\n        Objekt = AI_GetField(blob, \"OBJEKT\")\n        d = AI_ParseDate(AI_GetField(blob, \"DATE\"))\n        If title <> \"\" And d <> 0 And Objekt <> \"\" Then\n            auftragId = AI_FindAuftragId(d, title, Objekt)\n        End If\n    End If\n    If IsNull(auftragId) Then AI_Log \"ASSIGN_MA: Auftrag nicht gefunden\": Exit Sub\n\n    maID = CLng(val(AI_GetField(blob, \"MA_ID\")))\n    If maID = 0 Then AI_Log \"ASSIGN_MA: MA_ID fehlt\": Exit Sub\n\n    vonD = AI_ParseDate(AI_GetField(blob, \"VON\"))\n    bisD = AI_ParseDate(AI_GetField(blob, \"BIS\"))\n    rolle = AI_GetField(blob, \"ROLLE\")\n    std = val(AI_GetField(blob, \"STUNDEN\"))\n\n    ' NEU: sicherstellen, dass der Tag existiert (für die Übersicht)\n    Dim tagD As Date\n    tagD = IIf(vonD = 0, d, DateValue(vonD))\n    If Not IsNull(auftragId) And tagD <> 0 Then\n        Call AI_EnsureAnzTag(auftragId, tagD)\n    End If\n\n    Call AI_InsertZuordnung(auftragId, maID, vonD, bisD, rolle, std)\nEnd Sub\n\n'=== END mdl_AccessRunner ===================================================\n\n"}
