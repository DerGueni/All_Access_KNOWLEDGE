{"id":"MOD_mdlGetPublicIP","name":"mdlGetPublicIP","kind":"standard","procedures":["Function GetPublicIP()","Private Function DownloadFile(ByVal sURL As String, _","Private Function LocalIPAddress() As String","Private Function TrimNull(startstr As String) As String"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''\n' Copyright ©1996-2009 VBnet, Randy Birch, All Rights Reserved.\n' Some pages may also contain other copyrights by the author.\n''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''\n' Distribution: You can freely use this code in your own\n'               applications, but you may not reproduce\n'               or publish this code on any web site,\n'               online service, or distribute as source\n'               on any media without express permission.\n''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''\n'\n'I have a page at http://vbnet.mvps.org/resources/tools/getpublicip.shtml that can be used by anyone to return their public IP address. When viewed in a\n'browser the page shows only the IP with no other text making scraping the page easier than those containing other information.  Using the fast and\n'transparent URLDownloadToFile API the resulting file has a bit of html and java code in it which requires parsing, and is the subject of this demo.\n'\n'Essentially the code uses the familiar UrlDownloadToFile call, with a DeleteUrlCacheEntry call for good measure, to retrieve the file to a local file path,\n'where it is loaded into a buffer and parsed to extract the IP address string embedded in the file. All pretty straightforward, this is really the only\n'mechanism available to identify the public IP address on machines served a DHCP address by their DSL router.\n'\n''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''\n\nPrivate Const ERROR_SUCCESS As Long = 0\nPrivate Const MAX_ADAPTER_NAME_LENGTH As Long = 256\nPrivate Const MAX_ADAPTER_DESCRIPTION_LENGTH As Long = 128\nPrivate Const MAX_ADAPTER_ADDRESS_LENGTH As Long = 8\n\nPrivate Type IP_ADDRESS_STRING\n   IpAddr(0 To 15) As Byte\nEnd Type\n\nPrivate Type IP_MASK_STRING\n   IpMask(0 To 15) As Byte\nEnd Type\n\nPrivate Type IP_ADDR_STRING\n   dwNext As Long\n   IpAddress As IP_ADDRESS_STRING\n   IpMask As IP_MASK_STRING\n   dwContext As Long\nEnd Type\n\nPrivate Type IP_ADAPTER_INFO\n   dwNext As Long\n   ComboIndex As Long  'reserved\n   sAdapterName(0 To (MAX_ADAPTER_NAME_LENGTH + 3)) As Byte\n   sDescription(0 To (MAX_ADAPTER_DESCRIPTION_LENGTH + 3)) As Byte\n   dwAddressLength As Long\n   sIPAddress(0 To (MAX_ADAPTER_ADDRESS_LENGTH - 1)) As Byte\n   dwIndex As Long\n   uType As Long\n   uDhcpEnabled As Long\n   CurrentIpAddress As Long\n   IpAddressList As IP_ADDR_STRING\n   GatewayList As IP_ADDR_STRING\n   DhcpServer As IP_ADDR_STRING\n   bHaveWins As Long\n   PrimaryWinsServer As IP_ADDR_STRING\n   SecondaryWinsServer As IP_ADDR_STRING\n   LeaseObtained As Long\n   LeaseExpires As Long\nEnd Type\n\nPrivate Declare PtrSafe Function GetAdaptersInfo Lib \"iphlpapi.dll\" _\n  (pTcpTable As Any, _\n   pdwSize As Long) As Long\n   \nPrivate Declare PtrSafe Sub CopyMemory Lib \"kernel32\" _\n   Alias \"RtlMoveMemory\" _\n  (dst As Any, _\n   src As Any, _\n   ByVal bcount As Long)\n   \nPrivate Declare PtrSafe Function URLDownloadToFile Lib \"urlmon\" _\n   Alias \"URLDownloadToFileA\" _\n  (ByVal pCaller As Long, _\n   ByVal szURL As String, _\n   ByVal szFileName As String, _\n   ByVal dwReserved As Long, _\n   ByVal lpfnCB As Long) As Long\n   \nPrivate Declare PtrSafe Function DeleteUrlCacheEntry Lib \"wininet.dll\" _\n   Alias \"DeleteUrlCacheEntryA\" _\n  (ByVal lpszUrlName As String) As Long\n      \nPrivate Declare PtrSafe Function lstrlenW Lib \"kernel32\" _\n  (ByVal lpString As LongPtr) As Long\n\n\n\nFunction GetPublicIP()\n\n   Dim sSourceUrl As String\n   Dim sLocalFile As String\n   Dim hFile As Long\n   Dim buff As String\n   Dim pos1 As Long\n   Dim pos2 As Long\n   \n  'site returning IP address\n  'Telekom\n  sSourceUrl = \"http://eces.t-online.de/hotline/ip/\"\n'   sSourceUrl = \"http://vbnet.mvps.org/resources/tools/getpublicip.shtml\"\n' sSourceUrl = \"http://automation.whatismyip.com/n09230945.asp\"\n'   sSourceUrl = \"http://192.168.2.1/cgi-bin/webcm?getpage=../html/top_status.htm\"\n   sLocalFile = GetTempDir() & \"ip.txt\"\n   \n  'ensure this file does not exist in the cache\n   Call DeleteUrlCacheEntry(sSourceUrl)\n\n  'download the public IP file,\n  'read into a buffer and delete\n   If DownloadFile(sSourceUrl, sLocalFile) Then\n   \n      hFile = FreeFile\n      Open sLocalFile For Input As #hFile\n        buff = Input$(LOF(hFile), hFile)\n        If Len(Trim(Nz(buff))) > 0 Then\n            pos1 = -1\n        Else\n            pos1 = 0\n        End If\n      Close #hFile\n\n\n     'look for the IP line\n'      pos1 = InStr(buff, \"var ip =\")\n'      pos1 = InStr(buff, \"Aktiv: \")\n   \n     'if found,\n      If pos1 Then\n   \n        'get position of first and last single\n        'quotes around address (e.g. '11.22.33.44')\n'         pos1 = InStr(pos1 + 1, buff, \"'\", vbTextCompare) + 1\n         pos1 = InStr(1, buff, \"'\", vbTextCompare) + 1\n         pos2 = InStr(pos1 + 1, buff, \"'\", vbTextCompare) '- 1\n      \n'         pos1 = InStr(pos1 + 1, buff, \" \", vbTextCompare) + 1\n'         pos2 = InStr(pos1 + 1, buff, \"</\", vbTextCompare) '- 1\n      \n        'return the IP address\n         GetPublicIP = Mid$(buff, pos1, pos2 - pos1)\n        \n''        GetPublicIP = buff\n\n      Else\n      \n         GetPublicIP = \"(IP unknown)\"\n      \n      End If  'pos1\n      \n      Kill sLocalFile\n   \n   Else\n      \n      GetPublicIP = \"(No Internet)\"\n      \n   End If  'DownloadFile\n   \nEnd Function\n\n\nPrivate Function DownloadFile(ByVal sURL As String, _\n                             ByVal sLocalFile As String) As Boolean\n   \n   DownloadFile = URLDownloadToFile(0, sURL, sLocalFile, 0, 0) = ERROR_SUCCESS\n   \nEnd Function\n\n\nPrivate Function LocalIPAddress() As String\n   \n   Dim cbRequired As Long\n   Dim buff() As Byte\n   Dim ptr1 As LongPtr\n   Dim sIPAddr As String\n   Dim Adapter As IP_ADAPTER_INFO\n   \n   Call GetAdaptersInfo(ByVal 0&, cbRequired)\n\n   If cbRequired > 0 Then\n    \n      ReDim buff(0 To cbRequired - 1) As Byte\n      \n      If GetAdaptersInfo(buff(0), cbRequired) = ERROR_SUCCESS Then\n      \n        'get a pointer to the data stored in buff()\n         ptr1 = VarPtr(buff(0))\n\n         Do While (ptr1 <> 0)\n         \n           'copy the data from the pointer to the\n           'first adapter into the IP_ADAPTER_INFO type\n            CopyMemory Adapter, ByVal ptr1, LenB(Adapter)\n         \n            With Adapter\n                       \n              'the DHCP IP address is in the\n              'IpAddress.IpAddr member\n                 \n               sIPAddr = TrimNull(StrConv(.IpAddressList.IpAddress.IpAddr, vbUnicode))\n                  \n               If Len(sIPAddr) > 0 Then Exit Do\n\n               ptr1 = .dwNext\n                              \n            End With  'With Adapter\n            \n        'ptr1 is 0 when (no more adapters)\n         Loop  'Do While (ptr1 <> 0)\n\n      End If  'If GetAdaptersInfo\n   End If  'If cbRequired > 0\n\n  'return any string found\n   LocalIPAddress = sIPAddr\n   \nEnd Function\n\n\nPrivate Function TrimNull(startstr As String) As String\n\n   TrimNull = Left$(startstr, lstrlenW(StrPtr(startstr)))\n   \nEnd Function\n"}
