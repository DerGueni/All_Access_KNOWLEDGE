{"id":"MOD_zmd_Funktionen","name":"zmd_Funktionen","kind":"standard","procedures":["Function ScreenResolution()","Function Testumgebung_umschalten()","Function FE_verteilen()","Function Wait(n As Double)","Function change_BE()","Function close_timer()","Function refresh_zuoplanfe(Optional VADatum As Date, Optional DateCriteria As String, Optional SingleVA As Boolean)","Sub Access_Version()","Function DBSperren()","Function Dateiauswahl(Optional strTitle As String, Optional filter As String, Optional pfad As String) As String","Function TableExists(ByVal mytable As String) As Boolean","Function queryExists(ByVal myquery As String) As Boolean","Function SaveFile(ByVal Quelldatei As String, ByVal Zieldatei As String) As Boolean","Sub EnableShift(blnFlag As Boolean)","Function Bearbeitung_sperren(ByVal strForm As String) As Boolean","Function Bearbeitung_freigeben(ByVal strForm As String) As Boolean","Function Close_all()","Function Quit_Access()","Public Function AccObjSchliessen(ObjTyp As String, Optional strNicht As String)","Public Function fctIsTableOpen(StrName As String) As Boolean","Public Function fctIsFormOpen(StrName As String) As Boolean","Public Function fctIsReportOpen(StrName As String) As Boolean","Public Function FnSetzeAutowertZurueck(sFeld As String, sTable As String)","Function loesche_Duplikate(tabelle As String, Feld1 As String, Feld2 As String, Feld3 As String, Feld4 As String, Optional Kriterium As String) As Boolean","Sub Tabellen_ausgeben()","Function FileExists(ByVal strFile As String) As Boolean","Function Datei_in_Benutzung(ByVal Dateiname As String) As Boolean","Function aktualisiere_Stammdaten(ByVal strTabelle As String, ByVal UPDFeld As String, ByVal UPDWert As String, ByVal Feld1 As String, ByVal Wert1 As String, _","Function datumSQL(vardatum As Variant) As String","Function DatumUhrzeitSQL(vardatum As Variant) As String","Function UhrzeitSQL(vardatum As Variant) As String","Function CreateTable(ByVal strTabelle As String, ByVal strAbf As String, Optional ByVal strWherecondition As String) As String","Function Warten(ByVal MilliSekunden As Double)","Function create_PHP(MD5 As String, Mail As String, Datum As String, Zeit As String, Ende As String, Auftrag As String, Ort As String, Objekt As String, MA_ID As Integer) As String","Function writelog(Datei As String, Text As String)","Function Rückmeldeauswertung()","Function detect_sender() As String","Function check_Anzahl_MA(VA_ID As Long, VADatum_ID As Long)","Function sort_zuo_plan(VA_ID As Long, VADatum_ID As Long, tabelle As Integer)","Function upd_Vergleichszeiten(VA_ID As Long, von As Date, bis As Date) As String","Function upd_ztbl_MA_Verfuegbarkeit() As String","Function upd_qry_Verfuegbarkeit(iVerf As Long, iAnstArt As Long, iQuali As Long, iAktiv As Long, Optional iVerplantVerfuegbar As Long, Optional iNur34a As Long) As String","Function aktualisiere_Verfuegbarkeiten(VA_ID As Long, MVA_Start As Date, Optional MVA_Ende As Date)","Function einfaerben(control As control, Wert As Variant, color As String, Optional altloesch As Boolean)","Function falscheStartID()","Public Function getFreeID(ByVal tableName As String, ID_Fieldname As String) As Long","Function AusrichtungSetzen(strBericht As String, Optional blnHochformat As Boolean = True, Optional strPrinter As String)","Public Function stunden(ByVal Arbeitsbeginn As Date, ByVal Arbeitsende As Date)","Public Sub Beginn(Arbeitsbeginn)","Public Sub Ende(Arbeitsbeginn, Arbeitsende)","Public Sub Beginn24(Arbeitsbeginn)","Public Sub Ende24(Arbeitsende)","Function create_Gesamtliste()","Function correct_MA_Start_Ende_ZUO()","Public Function IsInitial(field As Variant) As Boolean","Function Feiertag(ByVal Datum As Date) As String","Function Monat_lang(Monat As Integer) As String","Function BubbleSort(ByRef strArray As Variant) As Variant()","Function select_in_array(quelle As String, field As String, WHERE As String) As Variant","Function select_in_string(quelle As String, field As String, WHERE As String) As String","Function set_values_new_ma(MA_ID As Long)","Function set_quali(MA_ID As Long, Quali_ID As Long)","Function execute_Makro(Makro As String, Optional db As String)","Public Function ExportFormToExcel(strExcelpath As String, sfm As Form)","Public Function AddWhereAndOrderByToSQL(strSQL As String, Optional strFilter As String, _","Function calc_percentage_KD_hours(kun_ID As Long, Optional Jahr As Integer, Optional Monat As Integer) As Double","Public Function CleanFilename(ByVal sFilename As String, Optional ByVal sChar As String = \"\") As String","Function Verweise_auslesen()","Sub TEST()","Function qr_erstellen(ZUO_ID As Long) As String"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":["UPDATE tbl_MA_Mitarbeiterstamm SET Email = 'Johnnystrashmail@goldmail.de'","INSERT INTO ztbl_CloseAll VALUES ('-1','-1')","DELETE * FROM ztbl_CloseAll WHERE check = TRUE","ALTER TABLE ","DROP TABLE [","DROP TABLE ","DROP TABLE ","DELETE * FROM ","DELETE FROM ","INSERT INTO zzz_CheckStartId SELECT * FROM "," INSERT INTO "],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n\nPublic Declare PtrSafe Function GetDeviceCaps Lib \"gdi32\" (ByVal hdc As Long, ByVal nIndex As Long) As Long\nPublic Declare PtrSafe Function GetDC Lib \"user32\" (ByVal hwnd As Long) As Long\nPublic Declare PtrSafe Function ReleaseDC Lib \"user32\" (ByVal hwnd As Long, ByVal hcd As Long) As Long\n\nPublic lHsize As Long, lVsize As Long\n\nConst HORZRES = 8\nConst VERTRES = 10\n\n\nFunction ScreenResolution()\n' lHsize = Anzahl der horizontalen Bildschirmzeilen\n' lVsize = Anzahl der vertikalen Bildschirmzeilen\n\nDim lRval As Long\nDim lDc   As Long\nDim hCM   As Long\nDim vCM   As Long\n\nlDc = GetDC(0&)\nlHsize = GetDeviceCaps(lDc, HORZRES)\nlVsize = GetDeviceCaps(lDc, VERTRES)\nlRval = ReleaseDC(0, lDc)\n\nhCM = lHsize / 28.35\nvCM = lVsize / 28.35\n\nEnd Function\n\n\n'Testumgebung\nFunction Testumgebung_umschalten()\n\nDim fso As Object\n    \n    'Produktivumgebung umschalten\n    switchConnectAcc PfadProdLokal & Backend\n    \n    'aktuelles Backend holen\n    Set fso = CreateObject(\"Scripting.FileSystemObject\")\n    fso.CopyFile PfadProdLokal & Backend, PfadTest & Backend, True\n    Set fso = Nothing\n    \n    'Testumgebung verbinden\n    switchConnectAcc PfadTestLokal & Backend\n\n    'ACHTUNG -> ÄNDERT ALLE MAILADRESSEN AUF TRASHMAIL\n    If InStr(CurrentDb.TableDefs(\"___Vorlagen_einlesen\").connect, \"Testumgebung\") <> 0 Then _\n        CurrentDb.Execute \"UPDATE tbl_MA_Mitarbeiterstamm SET Email = 'Johnnystrashmail@goldmail.de'\"\n    \n    MsgBox \"Frontend in Testumgebung\"\n    \nEnd Function\n\n\n'Frontend verteilen\nFunction FE_verteilen()\n\n    Const FE = \"Consys_FE.accdb\"\n    \n    Dim fso As Object\n    Dim gueni, gueni_desk, mel, reibling, pc5, pc6, pc7, wolly, kypi, Lokal As String\n    \n    'Pfade Frontends\n    gueni = FrontendsVTS & \"guenther.siegert\\\"\n    gueni_desk = Server & \"Users\\guenther.siegert\\Desktop\\\"\n    mel = FrontendsVTS & \"melanie.oberndorfer\\\"\n    reibling = FrontendsVTS & \"glaskugel\\\"\n    pc5 = FrontendsVTS & \"pc5\\\"\n    pc6 = FrontendsVTS & \"pc6\\\"\n    pc7 = FrontendsVTS & \"pc7\\\"\n    wolly = FrontendsVTS & \"wolfram.mueller\\\"\n    kypi = FrontendsVTS & \"johannes.kuypers\\\"\n    Lokal = Server & \"Database\\Frontend\\\"\n    \n    If MsgBox(\"Aktuelle Version verteilen?\", vbYesNo) = vbYes Then\n        \n        Set fso = CreateObject(\"Scripting.FileSystemObject\")\n        \n        'Produktiv verbinden (Lokal)\n        switchConnectAcc PfadProdLokal & Backend\n        \n        'Alle FEs schließen\n        CurrentDb.Execute \"INSERT INTO ztbl_CloseAll VALUES ('-1','-1')\"\n        \n        Wait 15 'Sekunden\n\n        'Application.Wait (TimeSerial(Hour(Now()), Minute(Now()), Second(Now()) + 10))\n        CurrentDb.Execute \"DELETE * FROM ztbl_CloseAll WHERE check = TRUE\"\n        \n        'gueni\n        If FileExists(gueni & FE) And Not FileExists(gueni & \"Consys_FE_\" & Date & \".accdb\") Then Name gueni & FE As gueni & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, gueni & FE\n        \n        'gueni desktop\n        If FileExists(gueni_desk & FE) And Not FileExists(gueni_desk & \"Consys_FE_\" & Date & \".accdb\") Then Name gueni_desk & FE As gueni_desk & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, gueni_desk & FE\n        \n        'mel\n        'If FileExists(mel & FE) Then Name mel & FE As mel & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, mel & FE\n        \n        'reibling\n        'If FileExists(reibling & FE) Then Name reibling & FE As reibling & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, reibling & FE\n        \n        'pc5\n        'If FileExists(pc5 & FE) Then Name pc5 & FE As pc5 & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, pc5 & FE\n        \n        'pc6\n        'If FileExists(pc5 & FE) Then Name pc5 & FE As pc5 & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, pc6 & FE\n        \n        'pc7\n        'If FileExists(pc5 & FE) Then Name pc5 & FE As pc5 & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, pc7 & FE\n        \n        'wolly\n        'If FileExists(pc5 & FE) Then Name pc5 & FE As pc5 & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, wolly & FE\n        \n        'kypi\n        If FileExists(kypi & FE) And Not FileExists(kypi & \"Consys_FE_\" & Date & \".accdb\") Then Name kypi & FE As kypi & \"Consys_FE_\" & Date & \".accdb\"\n        fso.CopyFile PfadTest & FE, kypi & FE\n        \n        'Lokal\n        fso.CopyFile PfadTestLokal & FE, Lokal & FE\n        \n        'Produktiv verbinden (Netzwerk)\n        switchConnectAcc PfadProd & Backend\n        \n        'Lokal\n        fso.CopyFile PfadTestLokal & FE, Lokal & FE\n        \n        'Testumgebung verbinden\n        switchConnectAcc PfadTestLokal & Backend\n        \n        Set fso = Nothing\n        \n        MsgBox \"Neues FE wurde erfolgreich verteilt\"\n    End If\n\nEnd Function\n\n\n'Function that wait an amount of time n in seconds\nFunction Wait(n As Double)\n\nDim TWait As Date\nDim TNow As Date\n\n    TWait = Time\n    TWait = DateAdd(\"s\", n, TWait)\n    Do Until TNow >= TWait\n         TNow = Time\n    Loop\n    \nEnd Function\n\nFunction change_BE()\n    DatenMDBWechselAcc\nEnd Function\n\nFunction close_timer()\n\nDoCmd.Close acForm, \"zfrm_Close\"\n\nEnd Function\n\n\n'Zuordnungsdaten ins FE holen\nFunction refresh_zuoplanfe(Optional VADatum As Date, Optional DateCriteria As String, Optional SingleVA As Boolean)\n\nDim NverFE          As String\nDim KorrFE          As String\nDim sql             As String\nDim whereCondition  As String 'ZUO + PLAN\nDim whereCondition2 As String 'NV Zeiten\nDim whereCondition3 As String 'Korrekturen\nDim rs              As Recordset\nDim arr             As Variant\nDim ARR_STR()       As String\nDim ZUOIDS          As String\nDim i               As Integer\nDim BackendDB       As String\nDim sqlvon          As String\nDim sqlbis          As String\n  \nOn Error Resume Next\n\n    'Nichtverfügbarkeit\n    NverFE = NVERFUEG_FE\n    \n    'Korrekturen\n    KorrFE = \"ztbl_MA_ZK_Korrekturen_FE\"\n    \n    If SingleVA = False Then\n        If DateCriteria <> \"\" Then\n            whereCondition = \" WHERE VADatum \" & DateCriteria\n            whereCondition2 = \" WHERE vonDat \" & DateCriteria\n        Else\n            'wenn kein Datum dann heute\n            If VADatum = \"00:00:00\" Then VADatum = Now()\n            \n            'Daten aktueller Monat der Veranstaltung plus 30 tage ab Veranstaltungstag\n            sqlvon = datumSQL(DateSerial(year(VADatum), Month(VADatum), 1))\n            sqlbis = datumSQL(VADatum + 30)\n            whereCondition = \" WHERE VADatum BETWEEN \" & sqlvon & \" AND \" & sqlbis\n            whereCondition2 = \" WHERE vonDat BETWEEN \" & sqlvon & \" AND \" & sqlbis\n        End If\n        \n        \n        'Zuordnungsdaten im FE löschen\n        sql = \"DELETE * FROM \" & ZUORDNUNG_FE\n        CurrentDb.Execute sql\n        \n        'Aktuelle Zuordnungen plus Zeitraum ins FE holen\n        sql = \"INSERT INTO \" & ZUORDNUNG_FE & \" SELECT * FROM \" & ZUORDNUNG & whereCondition\n        CurrentDb.Execute sql\n        \n        'Planungsdaten im FE löschen\n        sql = \"DELETE * FROM \" & PLANUNG_FE\n        CurrentDb.Execute sql\n        \n        'Aktuelle Planungen ins FE holen\n        sql = \"INSERT INTO \" & PLANUNG_FE & \" SELECT * FROM \" & PLANUNG & whereCondition\n        CurrentDb.Execute sql\n    \n        'Verfügbarkeitsdaten im FE löschen\n        sql = \"DELETE * FROM \" & NverFE\n        CurrentDb.Execute sql\n        \n        'Aktuelle Nichtverfügbarkeiten ins FE holen\n        sql = \"INSERT INTO \" & NverFE & \" SELECT * FROM tbl_MA_NVerfuegZeiten\" & whereCondition2\n        CurrentDb.Execute sql\n        \n        'Korrekturen Zeitkonten im FE löschen\n        sql = \"DELETE * FROM \" & KorrFE\n        CurrentDb.Execute sql\n    \n        'Aktuelle Korrekturen ins FE holen\n        sql = \"INSERT INTO \" & KorrFE & \" SELECT * FROM zqry_MA_ZK_Korrekturen\" & whereCondition2\n        CurrentDb.Execute sql\n        \n        'Zusatzdaten Zuordnung im FE löschen\n        sql = \"DELETE * FROM \" & ZUO_STD_FE\n        CurrentDb.Execute sql\n        \n        'Zusatzdaten Zuordnung ins FE holen\n        sql = \"SELECT [ID] FROM \" & ZUORDNUNG_FE\n        Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n        rs.MoveLast\n        rs.MoveFirst\n        arr = rs.GetRows(rs.RecordCount)\n        ReDim ARR_STR(rs.RecordCount - 1)\n        For i = 0 To UBound(arr, 2)\n            ARR_STR(i) = arr(0, i)\n        Next i\n        ZUOIDS = Join(ARR_STR, \", \")\n        sql = \"INSERT INTO \" & ZUO_STD_FE & \" SELECT * FROM \" & ZUO_STD & \" WHERE ZUO_ID IN (\" & ZUOIDS & \")\"\n        CurrentDb.Execute sql\n        \n        sql = \"SELECT [ID] FROM \" & NVERFUEG_FE\n        Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n        rs.MoveLast\n        rs.MoveFirst\n        arr = rs.GetRows(rs.RecordCount)\n        ReDim ARR_STR(rs.RecordCount - 1)\n        For i = 0 To UBound(arr, 2)\n            ARR_STR(i) = arr(0, i)\n        Next i\n        ZUOIDS = Join(ARR_STR, \", \")\n        sql = \"INSERT INTO \" & ZUO_STD_FE & \" SELECT * FROM \" & ZUO_STD & \" WHERE NV_ID IN (\" & ZUOIDS & \")\"\n        CurrentDb.Execute sql\n        \n        rs.Close\n        Set rs = Nothing\n        \n    Else ' SingleVA - einzelne Veranstaltung\n        BackendDB = TLookup(\"Database\", \"MSysObjects\", \"Database IS NOT NULL\")\n        sqlvon = datumSQL(TLookup(\"Dat_VA_Von\", \"zqry_VA_Auftragstamm\", , BackendDB))\n        sqlbis = datumSQL(TLookup(\"Dat_VA_Bis\", \"zqry_VA_Auftragstamm\", , BackendDB))\n        whereCondition2 = \" WHERE vonDat BETWEEN \" & sqlvon & \" AND \" & sqlbis\n         \n        'Zuordnungsdaten im FE löschen\n        sql = \"DELETE * FROM \" & ZUORDNUNG_FE\n        CurrentDb.Execute sql\n        \n        'Aktuelle Zuordnungen ins FE holen\n        sql = \"INSERT INTO \" & ZUORDNUNG_FE & \" SELECT * FROM zqry_MA_VA_Zuordnung IN '\" & BackendDB & \"'\"\n        CurrentDb.Execute sql\n        \n        'Planungsdaten im FE löschen\n        sql = \"DELETE * FROM \" & PLANUNG_FE\n        CurrentDb.Execute sql\n        \n        'Aktuelle Planungen ins FE holen\n        sql = \"INSERT INTO \" & PLANUNG_FE & \" SELECT * FROM zqry_MA_VA_Planung IN '\" & BackendDB & \"'\"\n        CurrentDb.Execute sql\n    \n        'Verfügbarkeitsdaten im FE löschen\n        sql = \"DELETE * FROM \" & NverFE\n        CurrentDb.Execute sql\n        \n        'Aktuelle Nichtverfügbarkeiten ins FE holen\n        sql = \"INSERT INTO \" & NverFE & \" SELECT * FROM tbl_MA_NVerfuegZeiten\" & whereCondition2\n        CurrentDb.Execute sql\n        \n        'Korrekturen Zeitkonten im FE löschen\n        sql = \"DELETE * FROM \" & KorrFE\n        CurrentDb.Execute sql\n    \n        'Aktuelle Korrekturen ins FE holen\n        sql = \"INSERT INTO \" & KorrFE & \" SELECT * FROM zqry_MA_ZK_Korrekturen\" & whereCondition2\n        CurrentDb.Execute sql\n        \n        'Zusatzdaten Zuordnung im FE löschen\n        sql = \"DELETE * FROM \" & ZUO_STD_FE\n        CurrentDb.Execute sql\n        \n        sql = \"INSERT INTO \" & ZUO_STD_FE & \" SELECT * FROM zqry_ZUO_Stunden IN '\" & BackendDB & \"'\"\n        CurrentDb.Execute sql\n        \n    End If\n    \n    'Verfügbarkeitstabelle updaten\n    Call upd_ztbl_MA_Verfuegbarkeit\n\nEnd Function\n\nSub Access_Version()\n\n    Dim RichtigeRuntime\n    Dim stRT As String\n    If SysCmd(acSysCmdRuntime) Then\n        If RichtigeRuntime Then\n            stRT = \"Runtime Echt\"\n        Else\n            stRT = \"Runtime Symulation\"\n        End If\n    Else\n        stRT = \"Normal (Vollversion)\" 'Nicht Runtime\n    End If\n\nEnd Sub\n\n\n'Datenbank sperren\nFunction DBSperren()\n\n    On Error GoTo err\n\n    'Prüfung, ob Runtime oder Vollversion\n    If Not SysCmd(acSysCmdRuntime) Then\n    \n        DoCmd.ShowToolbar \"Ribbon\", acToolbarNo\n    \n        DoCmd.NavigateTo \"acNavigationCategoryObjectType\", _\n                          \"acNavigationGroupTables\"\n                          \n        DoCmd.SelectObject acForm, vbNullString, True\n        \n        DoCmd.RunCommand acCmdWindowHide\n        \n    End If\n\n\nEnde:\n    Exit Function\n    \nerr:\n    err.clear\n    Resume Next\n        \nEnd Function\n\n\n'Filedialog zur Dateiauswahl -> bsp filter: \"WORD\", \"*.doc,*.docx\"\nFunction Dateiauswahl(Optional strTitle As String, Optional filter As String, Optional pfad As String) As String\n\n    Dim objFiledialog As Office.FileDialog\n    Set objFiledialog = Application.FileDialog(msoFileDialogOpen)\n\n    With objFiledialog\n        If pfad <> \"\" Then .InitialFileName = pfad\n        .Filters.clear\n        If filter <> \"\" Then .Filters.Add \"\", filter\n        .InitialFileName = strTitle\n        .title = strTitle\n        .AllowMultiSelect = False\n        If .Show = True Then\n            Dateiauswahl = .SelectedItems(1)\n        End If\n    End With\n\n    Set objFiledialog = Nothing\n\nEnd Function\n\n\n''Filedialog zur Dateiauswahl\n'Function DateiAuswaehlen(Optional strTitle As String) As String\n'\n'    Dim objFiledialog As FileDialog\n'    Set objFiledialog = Application.FileDialog(msoFileDialogOpen)\n'\n'    With objFiledialog\n'        .Filters.Clear\n'        .Filters.Add \"Exceldoc\", \"*.xlsm, *.xls, *.xlsx\"\n'        .InitialFileName = strTitle\n'\n'        .title = strTitle\n'        .AllowMultiSelect = False\n'        If .Show = True Then\n'            DateiAuswaehlen = .SelectedItems(1)\n'        End If\n'    End With\n'\n'    Set objFiledialog = Nothing\n'\n'End Function\n\n\n'Prüfen, ob Tabelle existiert\nFunction TableExists(ByVal mytable As String) As Boolean\n\nOn Error GoTo Fehlerbehandlung\n    Dim td As DAO.TableDef\n\n    Set td = CurrentDb.TableDefs(mytable)\n    TableExists = True\n    Exit Function\n    \nFehlerbehandlung:\n    TableExists = False\nEnd Function\n\n\n'Prüfen, ob Abfrage existiert\nFunction queryExists(ByVal myquery As String) As Boolean\n\nOn Error GoTo Fehlerbehandlung\n    Dim td As DAO.QueryDef\n\n    Set td = CurrentDb.QueryDefs(myquery)\n    queryExists = True\n    Exit Function\n    \nFehlerbehandlung:\n    queryExists = False\nEnd Function\n\n\n'Datei kopieren\nFunction SaveFile(ByVal Quelldatei As String, ByVal Zieldatei As String) As Boolean\n'Datei zur Laufzeit kopieren:\nDim objFso As Object\nSet objFso = CreateObject(\"Scripting.FileSystemObject\")\n \nOn Error GoTo Err_SaveFile\n \nobjFso.CopyFile Quelldatei, Zieldatei, True\n \nSet objFso = Nothing\n\nSaveFile = True\n \nExit_SaveFile:\nExit Function\n \nErr_SaveFile:\nSaveFile = False\nMsgBox err.description\nSet objFso = Nothing\nResume Exit_SaveFile\n \nEnd Function\n\n\n\n\n'Shift beim start unterdrücken\n'************* CODE START *************\nSub EnableShift(blnFlag As Boolean)\n\n    On Error GoTo Error_EnableShift\n\n    Dim db As DAO.Database\n    Dim prp As DAO.Property\n\n    Set db = CurrentDb\n    'Property mit übergebenem Parameter belegen\n    db.Properties!AllowByPassKey = blnFlag\n\n\nExit_EnableShift:\n    Set prp = Nothing\n    Exit Sub\n\nError_EnableShift:\n\n    'Property erzeugen, falls noch nicht vorhanden\n    If err = 3270 Then\n        Set prp = db.CreateProperty(\"AllowBypassKey\", dbBoolean, blnFlag)\n        db.Properties.append prp\n        Resume Next\n    Else\n        MsgBox \"Ausnahme Nr. \" & str(err.Number) & \" \" & err.description\n        Resume Exit_EnableShift\n    End If\n\nEnd Sub\n'************* CODE ENDE *************\n\n\n'Formular für Bearbeitung sperren\nFunction Bearbeitung_sperren(ByVal strForm As String) As Boolean\n\n    Dim ctl As control\n    \nOn Error GoTo err\n\n    'Bearbeitung Formular sperren\n    For Each ctl In Forms(strForm).controls\n        If ctl.ControlType <> 104 And ctl.ControlType <> 100 And ctl.ControlType <> 111 Then ctl.Locked = True  '104 = Command Button 100 = Label 111 = Combo Box\n    Next ctl\n    \n    Bearbeitung_sperren = True\n    \nEnde:\n    Exit Function\nerr:\n    Bearbeitung_sperren = False\n    Debug.Print err.Number & \" \" & err.description\n    Resume Ende\n\nEnd Function\n\n\n'Formular für Bearbeitung freigeben\nFunction Bearbeitung_freigeben(ByVal strForm As String) As Boolean\n\n    Dim ctl As control\n    \nOn Error GoTo err\n\n    'Bearbeitung ermöglichen\n    For Each ctl In Forms(strForm).controls\n        If ctl.Name = \"Teilnehmer\" Then\n            ctl.Locked = True\n        ElseIf ctl.ControlType <> 104 And ctl.ControlType <> 100 Then\n            ctl.Locked = False  '104 = Command Button 100 = Label\n        End If\n    \n    Next ctl\n    \n    Bearbeitung_freigeben = True\n    \nEnde:\n    Exit Function\nerr:\n    Bearbeitung_freigeben = False\n    Debug.Print err.Number & \" \" & err.description\n    Resume Ende\n\nEnd Function\n\n'Alles Schließen\nFunction Close_all()\n\n    DoCmd.SetWarnings False\n    AccObjSchliessen \"Tabelle\"\n    AccObjSchliessen \"Abfrage\"\n    AccObjSchliessen \"Formular\"\n    DoCmd.SetWarnings True\n    \nEnd Function\n\n'Access Beenden\nFunction Quit_Access()\n\n    DoCmd.SetWarnings False\n    AccObjSchliessen \"Tabelle\"\n    AccObjSchliessen \"Abfrage\"\n    AccObjSchliessen \"Formular\"\n    DoCmd.SetWarnings True\n    AccObjSchliessen \"Access\"\n    \nEnd Function\n\n\n'geöffnete Objekte schließen\nPublic Function AccObjSchliessen(ObjTyp As String, Optional strNicht As String)\n \n        ' ---------------------------------------------------------\n        '  Funktion zum Schliessen von offenen Access-Objekten\n        '  Beim Schließen werden die jeweiligen Objekte ohne\n        '  weitere Rückfrage gespeichert und anschließend\n        '  geschlossen.\n        '  Als Objekttyp \"ObjTyp\" können folgende Werte über-\n        '  geben werden:\n        '    Tabelle, Abfrage, Formular, Bericht, Makro und Modul\n        '  Zusätzlich unterstützt die Funktion das Schließen der\n        '  aktuellen Datenbank (ObjTyp=Datenbank) und das Beenden\n        '  von Access (ObjTyp=Access).\n        ' ---------------------------------------------------------\n \nOn Error GoTo fehler\n \n    Dim ConNam As String\n    Dim ConTyp As Integer\n    Dim db As DAO.Database\n    Dim ctr As Container\n    Dim X As Integer\n\n        Select Case ObjTyp\n            Case \"Tabelle\"\n                ConNam = \"Tables\"\n                ConTyp = acTable\n            Case \"Abfrage\"\n                ConNam = \"Tables\"\n                ConTyp = acQuery\n            Case \"Formular\"\n                ConNam = \"Forms\"\n                ConTyp = acForm\n            Case \"Bericht\"\n                ConNam = \"Reports\"\n                ConTyp = acReport\n            Case \"Makro\"\n                ConNam = \"Scripts\"\n                ConTyp = acMacro\n            Case \"Modul\"\n                ConNam = \"Modules\"\n                ConTyp = acModule\n            Case \"Datenbank\"\n                CloseCurrentDatabase\n            Case \"Access\"\n                Quit\n        End Select\n\n        Set db = CurrentDb\n        Set ctr = db.Containers(ConNam)\n        For X = 0 To ctr.Documents.Count - 1\n            If ctr.Documents(X).Name <> strNicht Then DoCmd.Close ConTyp, ctr.Documents(X).Name, acSaveNo\n        Next X\n \nEnde:\n    Exit Function\nfehler:\n    Debug.Print err.Number & \" \" & err.description, 16\n    Resume Next\n\nEnd Function\n\n'Prüfen, ob Tabelle geöffnet\nPublic Function fctIsTableOpen(StrName As String) As Boolean\n  fctIsTableOpen = (SysCmd(acSysCmdGetObjectState, acTable, StrName) > 0)\nEnd Function\n\n\n'Prüfen, ob Formular geöffnet\nPublic Function fctIsFormOpen(StrName As String) As Boolean\n  fctIsFormOpen = (SysCmd(acSysCmdGetObjectState, acForm, StrName) > 0)\nEnd Function\n\n\n'Prüfen, ob Bericht geöffnet\nPublic Function fctIsReportOpen(StrName As String) As Boolean\n  fctIsReportOpen = (SysCmd(acSysCmdGetObjectState, acReport, StrName) > 0)\nEnd Function\n\n\n'Autowert zurücksetzen\n'Zum Testen im Direktfenster (Strg+G; Testfenster)\n'FnSetzeAutowertZurueck \"[DeinAutowertFeld]\", \"[DeineTabelle]\"\nPublic Function FnSetzeAutowertZurueck(sFeld As String, sTable As String)\n    \n    Dim lNeu    As Long\n    \nOn Error Resume Next\n    lNeu& = Nz(TMax(sFeld$, sTable$), 0) + 1\n    CurrentDb.Execute \"ALTER TABLE \" & sTable & _\n                     \" ALTER COLUMN \" & sFeld$ & \" COUNTER(\" & lNeu& & \",1)\"\nEnd Function\n\n\n\n'Duplikate löschen\nFunction loesche_Duplikate(tabelle As String, Feld1 As String, Feld2 As String, Feld3 As String, Feld4 As String, Optional Kriterium As String) As Boolean\n\n    Dim strSQL, temp As String\n    \n    temp = tabelle & \"_temp\"\n    \nOn Error GoTo err\n    \n    'Tabelle löschen wenn vorhanden\n    If TableExists(temp) Then CurrentDb.Execute \"DROP TABLE [\" & temp & \"]\"\n    \n    \n    'Daten ohne Duplikate in temporäre Tabelle schieben\n    strSQL = \"SELECT DISTINCT [\" & Feld1 & \"], [\" & Feld2 & \"], [\" & Feld3 & \"], [\" & Feld4 & \"] INTO [\" & temp & \"] FROM [\" & tabelle & \"]\"\n    \n    CurrentDb.Execute strSQL\n    \n    \n    'Tabelle leeren\n    strSQL = \"DELETE * FROM [\" & tabelle & \"]\"\n    \n    CurrentDb.Execute strSQL\n    \n    \n    'Daten aus temporärer Tabelle in Tabelle schieben\n    strSQL = \"INSERT INTO [\" & tabelle & \"] SELECT * FROM [\" & temp & \"]\"\n    \n    CurrentDb.Execute strSQL\n    \n    \n    'temporäre Tabelle löschen\n    strSQL = \"DROP TABLE [\" & temp & \"]\"\n    \n    CurrentDb.Execute strSQL\n    \n\n    'erfolgreich\n    loesche_Duplikate = True\n\n\nEnde:\n    Exit Function\n\nerr:\n    loesche_Duplikate = False\n    Resume Ende\n    \nEnd Function\n\n\n\n'Alle Tabellen ausgeben\nSub Tabellen_ausgeben()\nDim tdf As TableDef\n\nFor Each tdf In CurrentDb.TableDefs\n    Debug.Print tdf.Name\nNext tdf\nEnd Sub\n\n\n' ###### Prüft, ob die Datei existiert\nFunction FileExists(ByVal strFile As String) As Boolean\n\nOn Error Resume Next\n\n    FileExists = (Len(Dir(strFile)) > 0)\n\nEnd Function\n\n\n'Prüfen, ob Datei besetzt\nFunction Datei_in_Benutzung(ByVal Dateiname As String) As Boolean\n    On Error Resume Next\n    Close #1\n    Open Dateiname For Random Access Read Lock Read Write As #1\n        Datei_in_Benutzung = err.Number <> 0\n    Close #1\nEnd Function\n\n\n'Stammdaten fortschreiben\nFunction aktualisiere_Stammdaten(ByVal strTabelle As String, ByVal UPDFeld As String, ByVal UPDWert As String, ByVal Feld1 As String, ByVal Wert1 As String, _\n    Optional ByVal Feld2 As String, Optional ByVal Wert2 As String, Optional ByVal Feld3 As String, Optional ByVal Wert3 As String) As String\n\n    Dim strSQL, strWherecondition As String\n    \nOn Error GoTo err\n\n    Select Case True\n        Case IsDate(Wert1)\n            strWherecondition = \" WHERE [\" & Feld1 & \"] = \" & datumSQL(Wert1)\n        Case IsNumeric(Wert1)\n            strWherecondition = \" WHERE [\" & Feld1 & \"] = \" & Wert1\n        Case Else\n            strWherecondition = \" WHERE [\" & Feld1 & \"] = '\" & Wert1 & \"'\"\n    End Select\n    \n    If Wert2 <> \"\" Then\n        Select Case True\n            Case IsDate(Wert2)\n                strWherecondition = strWherecondition & \" AND [\" & Feld2 & \"] = \" & datumSQL(Wert2)\n            Case IsNumeric(Wert2)\n                strWherecondition = strWherecondition & \" AND [\" & Feld2 & \"] = \" & Wert2\n            Case Else\n                strWherecondition = strWherecondition & \" AND [\" & Feld2 & \"] = '\" & Wert2 & \"'\"\n        End Select\n    End If\n    \n    If Wert3 <> \"\" Then\n        Select Case True\n            Case IsDate(Wert3)\n                strWherecondition = strWherecondition & \" AND [\" & Feld3 & \"] = \" & datumSQL(Wert3)\n            Case IsNumeric(Wert3)\n                strWherecondition = strWherecondition & \" AND [\" & Feld3 & \"] = \" & Wert3\n            Case Else\n                strWherecondition = strWherecondition & \" AND [\" & Feld3 & \"] = '\" & Wert3 & \"'\"\n        End Select\n    End If\n    \n    'SQL aufbauen\n    Select Case True\n        Case IsDate(UPDWert)\n            strSQL = \"UPDATE [\" & strTabelle & \"] SET [\" & UPDFeld & \"] = \" & datumSQL(UPDWert) & strWherecondition\n        Case IsNumeric(UPDWert)\n            strSQL = \"UPDATE [\" & strTabelle & \"] SET [\" & UPDFeld & \"] = \" & UPDWert & strWherecondition\n        Case Else\n            strSQL = \"UPDATE [\" & strTabelle & \"] SET [\" & UPDFeld & \"] = '\" & UPDWert & \"'\" & strWherecondition\n    End Select\n    \n    \n    \n    'SQL Anweisung ausführen (temporäre Tabelle erzeugen)\n    CurrentDb.Execute strSQL, dbFailOnError\n    \n    'erfolgreich\n    aktualisiere_Stammdaten = \"OK\"\n    \nEnde:\n    Exit Function\nerr:\n    aktualisiere_Stammdaten = err.Number & \" \" & err.description\n    Resume Ende\n    \nEnd Function\n\n'varDatum zu formatierendes Datum\n'Aufruf: \"SELECT * FROM Tabelle WHERE datDatum = \" & DatumSQL(Me!SuchDatum)\nFunction datumSQL(vardatum As Variant) As String\n ' wandelt ein Datum vom deutschen Datumsformat\n ' in einen String im VBA-Format für SQL-Anweisungen um\n    If IsDate(vardatum) Then\n        datumSQL = Format(CDate(vardatum), \"\\#yyyy-mm-dd\\#\")\n    End If\nEnd Function\n\n\nFunction DatumUhrzeitSQL(vardatum As Variant) As String\n ' wandelt ein Datum vom deutschen Datumsformat\n ' in einen String im VBA-Format für SQL-Anweisungen um\n    If IsDate(vardatum) Then\n        DatumUhrzeitSQL = Format(CDate(vardatum), \"\\#yyyy-mm-dd hh:mm:ss\\#\")\n    End If\nEnd Function\n\n\nFunction UhrzeitSQL(vardatum As Variant) As String\n ' wandelt eine Uhrzeit vom deutschen Datumsformat\n ' in einen String im VBA-Format für SQL-Anweisungen um\n    If IsDate(vardatum) Then\n        UhrzeitSQL = Format(CDate(vardatum), \"\\#hh:mm:ss\\#\")\n    End If\nEnd Function\n\n\n 'Temporäre Tabelle erzeugen\nFunction CreateTable(ByVal strTabelle As String, ByVal strAbf As String, Optional ByVal strWherecondition As String) As String\n\n    Dim strSQL As String\n    \nOn Error GoTo err\n\n    'Where-Condition anpassen\n    If strWherecondition <> \"\" Then strWherecondition = \" AND \" & strWherecondition\n    \n    'SQL aubauen\n    strSQL = \"SELECT * INTO \" & strTabelle & \" FROM \" & strAbf & strWherecondition\n\n    If TableExists(strTabelle) Then CurrentDb.Execute \"DROP TABLE \" & strTabelle, dbFailOnError\n    \n    'SQL Anweisung ausführen (temporäre Tabelle erzeugen)\n    CurrentDb.Execute strSQL, dbFailOnError\n    \n    'erfolgreich\n    CreateTable = \"OK\"\n    \nEnde:\n    Exit Function\nerr:\n    CreateTable = err.Number & \" \" & err.description\n    Resume Ende\n\nEnd Function\n\n\nFunction Warten(ByVal MilliSekunden As Double)\n \n 'Quelle: www.dbwiki.net oder www.dbwiki.de\n \nDim i As Double\nDim Ende As Double\n \n    Ende = Timer + (MilliSekunden / 1000)\n \n    'Ladebalken\n    SysCmd acSysCmdInitMeter, \"Bitte warten...\", Round(Ende - Timer)\n    DoCmd.Hourglass True\n        \n    Do While i < Ende\n      DoEvents\n      i = Timer\n      SysCmd acSysCmdUpdateMeter, Round(Ende - i)\n    Loop\n    \n    SysCmd acSysCmdRemoveMeter\n    DoCmd.Hourglass False\n    \nEnd Function\n\n\n'PHP Datei Erzeugen\nFunction create_PHP(MD5 As String, Mail As String, Datum As String, Zeit As String, Ende As String, Auftrag As String, Ort As String, Objekt As String, MA_ID As Integer) As String\n\n\n    Dim fs As Object\n    Dim f As Object\n    Dim content As String\n    \nOn Error GoTo err\n\n    content = \"<?php\" & vbCrLf & _\n              \"$email = \" & Chr(34) & Mail & Chr(34) & \";\" & vbCrLf & _\n              \"$A_Auftr_Datum = \" & Chr(34) & Format(Datum, \"DDDD\") & \", der \" & Datum & Chr(34) & \";\" & vbCrLf & _\n              \"$A_Auftr_Dienstbeginn = \" & Chr(34) & Format(Zeit, \"HH:MM\") & Chr(34) & \";\" & vbCrLf & _\n              \"$A_End_Zeit = \" & Chr(34) & Format(Ende, \"HH:MM\") & Chr(34) & \";\" & vbCrLf & _\n              \"$A_Auftrag = \" & Chr(34) & Auftrag & Chr(34) & \";\" & vbCrLf & _\n              \"$A_Ort = \" & Chr(34) & Ort & Chr(34) & \";\" & vbCrLf & _\n              \"$A_Objekt = \" & Chr(34) & Objekt & Chr(34) & \";\" & vbCrLf & _\n              \"$A_Sender = \" & Chr(34) & Environ(\"UserName\") & Chr(34) & \";\" & vbCrLf & _\n              \"$A_File = \" & Chr(34) & \"DP_\" & MA_ID & \".pdf\" & Chr(34) & \";\" & vbCrLf & _\n              \"?>\"\n\n    Set fs = CreateObject(\"Scripting.FileSystemObject\")\n    Set f = fs.CreateTextFile(PfadAwort & MD5 & \".php\", True)\n    \n    f.Write content\n    f.Close\n    \n    Set fs = Nothing\n    Set f = Nothing\n\n    Exit Function\n    \nerr:\n   ' Log\n\nEnd Function\n\n\nFunction writelog(Datei As String, Text As String)\n\nDim intFF As Integer\n\n    intFF = FreeFile\n    If Dir(Datei) = \"\" Then\n        Open Datei For Output As #intFF\n    Else\n        Open Datei For Append As #intFF\n    End If\n    Print #intFF, Text\n    Close #intFF\n\nEnd Function\n\n\n'Temporäre Tabelle für Auswertung der Antwortzeiten\nFunction Rückmeldeauswertung()\n\nDim sql As String\nDim tbl_rueck As String\nDim rst As Recordset\n\ntbl_rueck = \"ztbl_Rueckmeldezeiten\"\n\n'If fctIsTableOpen(tbl_rueck) Then DoCmd.Close acTable, tbl_rueck, acSaveNo\n'If tableExists(tbl_rueck) Then CurrentDb.Execute \"DROP TABLE \" & tbl_rueck\n\nCurrentDb.Execute \"DELETE * FROM \" & tbl_rueck\n\n'Tabelle erstellen\n'SQL = \"SELECT MA_ID, Anfragezeitpunkt, Rueckmeldezeitpunkt INTO \" & tbl_rueck & \" FROM \" & PLANUNG & _\n      \" WHERE Anfragezeitpunkt IS NOT NULL\"\nsql = \"INSERT INTO \" & tbl_rueck & \" (MA_ID, Anfragezeitpunkt, Rueckmeldezeitpunkt, Status_ID)\" & _\n      \" SELECT MA_ID, Anfragezeitpunkt, Rueckmeldezeitpunkt, Status_ID FROM \" & PLANUNG & _\n      \" WHERE Anfragezeitpunkt IS NOT NULL\"\nCurrentDb.Execute sql\n     \nsql = \"INSERT INTO \" & tbl_rueck & \" (MA_ID, Anfragezeitpunkt, Rueckmeldezeitpunkt)\" & _\n      \" SELECT MA_ID, Anfragezeitpunkt, Rueckmeldezeitpunkt FROM \" & ZUORDNUNG & _\n      \" WHERE Anfragezeitpunkt IS NOT NULL\"\nCurrentDb.Execute sql\n\n'Status zugeordnet setzen bei Zusagen  -> Nur Automatische ZU/Absagen oder auch die manuell eingetragenen?\nsql = \"UPDATE \" & tbl_rueck & \" SET Status_ID = 3 WHERE Status_ID = 0\" 'and Rueckmeldezeitpunkt IS NOT NULL\"\nCurrentDb.Execute sql\n\n''Spalten anfügen: Durchschnittliche Antwortzeit\n'SQL = \"ALTER TABLE \" & tbl_rueck & \" ADD Reaktionszeit DATE NULL\"\n'CurrentDb.Execute SQL\n\n'Antwortzeit\nSet rst = CurrentDb.OpenRecordset(tbl_rueck)\nIf rst.RecordCount <> 0 Then\n    Do\n        If Not IsNull(rst.fields(\"Anfragezeitpunkt\")) And Not IsNull(rst.fields(\"Rueckmeldezeitpunkt\")) Then\n            rst.Edit\n            rst.fields(\"Reaktionszeit\") = DateDiff(\"h\", rst.fields(\"Anfragezeitpunkt\"), rst.fields(\"Rueckmeldezeitpunkt\"))\n            rst.update\n        End If\n        rst.MoveNext\n    Loop Until rst.EOF\nEnd If\n\nrst.Close\nSet rst = Nothing\n\nEnd Function\n\n\n'Sender einer Email ermitteln\nFunction detect_sender() As String\n\nSelect Case LCase(Environ(\"UserName\"))\n        Case \"güni\"\n            detect_sender = \"Günther Siegert\"\n        Case \"guenther.siegert\"\n            detect_sender = \"Günther Siegert\"\n        Case \"user\"\n            detect_sender = \"Günther Siegert\"\n        Case \"melanie.oberndorfer\"\n            detect_sender = \"Melanie Oberndorfer\"\n        Case \"mel\"\n            detect_sender = \"Melanie Oberndorfer\"\n        Case \"sabine.reibling\"\n            detect_sender = \" i.A. Sabine Reibling\"\n        Case \"glaskugel\"\n            detect_sender = \" i.A. Sabine Reibling\"\n        Case \"pc5\"\n            detect_sender = \"i.A. Thomas Göschelbauer\"\n        Case Else\n            detect_sender = Environ(\"UserName\")\n    End Select\nEnd Function\n\n\n'Anzahl Vorbelegungssätze Prüfen\nFunction check_Anzahl_MA(VA_ID As Long, VADatum_ID As Long)\n\nDim rst             As Recordset\nDim sql             As String\nDim VAStart_ID()    As Long\nDim i               As Integer\nDim c               As Integer\nDim X               As Integer\nDim Soll            As Integer\nDim Ist             As Integer\nDim LastPos         As Integer\nDim NeuPos          As Integer\nDim VAStartCriteria As String\nDim ZuoCriteria     As String\n    \n'    'Farben löschen\n'    Call einfaerben(Forms(\"frm_va_auftragstamm\").sub_MA_VA_Zuordnung.Form.PosNr, 0, 255, True)\n    \n    'VA_Start_IDs holen\n    sql = \"SELECT ID FROM \" & VASTART & \" WHERE VA_ID = \" & VA_ID & \" AND VADatum_ID = \" & VADatum_ID & \" ORDER BY VA_Start ASC\"\n    Set rst = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n    \n    i = 1\n    ReDim VAStart_ID(i)\n    VAStart_ID(i) = rst(0)\n    Do\n        If VAStart_ID(i) <> rst(0) Then\n            i = i + 1\n            ReDim Preserve VAStart_ID(i)\n            VAStart_ID(i) = rst(0)\n        End If\n        rst.MoveNext\n    Loop Until rst.EOF\n    rst.Close\n    Set rst = Nothing\n    \n    'MA Gesamt Soll\n    Soll = TSum(\"MA_Anzahl\", VASTART, \"VADatum_ID = \" & VADatum_ID)\n    TUpdate \"TVA_Soll = \" & Soll, anzTage, \"ID = \" & VADatum_ID\n    'MA Gesamt Ist\n    Ist = TCount(\"MA_ID\", ZUORDNUNG, \"VADatum_ID = \" & VADatum_ID & \" AND MA_ID <> 0\")\n    TUpdate \"TVA_Ist = \" & Ist, anzTage, \"ID = \" & VADatum_ID\n    TUpdate \"MA_Anzahl_Ist = \" & Ist, VASTART, \"VADatum_ID = \" & VADatum_ID\n    \n    \n    'Anzahl MA pro Start_ID prüfen\n    For i = 1 To UBound(VAStart_ID)\n        Soll = TLookup(\"MA_Anzahl\", VASTART, \"ID = \" & VAStart_ID(i))\n        Ist = TCount(\"PosNr\", ZUORDNUNG, \"VA_ID = \" & VA_ID & \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID(i))\n        ZuoCriteria = \"VA_ID = \" & VA_ID & \" AND VADatum_ID = \" & VADatum_ID & \" AND VAStart_ID = \" & VAStart_ID(i)\n        \n        c = Soll - Ist\n        'wenn zu wenig Vorbelegungssätze/Mitarbeiter\n        If c > 0 Then\n            Set rst = CurrentDb.OpenRecordset(ZUORDNUNG)\n            rst.Edit\n            On Error Resume Next 'Fehler, wenn noch keine Position im Auftrag\n                LastPos = TMax(\"PosNr\", ZUORDNUNG, \"VA_ID = \" & VA_ID & \" AND VADatum_ID = \" & VADatum_ID) 'ohne VA_Start_ID, da übergreifend!!!\n            On Error GoTo 0\n            VAStartCriteria = \"VA_ID = \" & VA_ID & \" AND VADatum_ID = \" & VADatum_ID & \" AND ID = \" & VAStart_ID(i)\n            NeuPos = LastPos + 1\n            For X = 1 To c\n                 rst.AddNew\n                    rst.fields(\"VA_ID\") = VA_ID\n                    rst.fields(\"VADatum_ID\") = VADatum_ID\n                    rst.fields(\"VAStart_ID\") = VAStart_ID(i)\n                    rst.fields(\"PosNr\") = NeuPos\n                    rst.fields(\"MA_Start\") = TLookup(\"VA_Start\", VASTART, VAStartCriteria)\n                    rst.fields(\"MA_Ende\") = TLookup(\"VA_Ende\", VASTART, VAStartCriteria)\n                    rst.fields(\"Bemerkungen\") = TLookup(\"Bemerkungen\", VASTART, VAStartCriteria)\n                    rst.fields(\"Aend_von\") = Environ(\"UserName\")\n                    rst.fields(\"Aend_am\") = Now()\n                    rst.fields(\"VADatum\") = TLookup(\"VADatum\", VASTART, VAStartCriteria)\n                    rst.fields(\"MVA_Start\") = TLookup(\"MVA_Start\", VASTART, VAStartCriteria)\n                    rst.fields(\"MVA_Ende\") = TLookup(\"MVA_Ende\", VASTART, VAStartCriteria)\n                 rst.update\n                 NeuPos = NeuPos + 1\n            Next X\n            rst.Close\n            Set rst = Nothing\n        'Überschuss -> PosNr einfärben/löschen\n        Else\n            'Positionsnummern ermittlen und einzeln einfärben/löschen (wenn MA_ID = 0)\n            c = 0\n            For X = Soll + 1 To Ist\n                LastPos = TMax(\"PosNr\", ZUORDNUNG, ZuoCriteria) - c\n                If TLookup(\"MA_ID\", ZUORDNUNG, ZuoCriteria & \" AND PosNr = \" & LastPos) = 0 Then\n                    CurrentDb.Execute \"DELETE FROM \" & ZUORDNUNG & \" WHERE \" & ZuoCriteria & \" AND PosNr = \" & LastPos\n                Else\n'                    Call einfaerben(Forms(\"frm_va_auftragstamm\").sub_MA_VA_Zuordnung.Form.PosNr, LastPos, 255)\n                    c = c + 1\n                End If\n            Next X\n        End If\n    Next i\n\nEnd Function\n\n\n'Zusagen/Zuordnungen neu Sortieren\n'Laufende Nummern gehen pro VADatum_ID!\n'-> VAStart_IDs müssen nicht berücksichtigt werden!\nFunction sort_zuo_plan(VA_ID As Long, VADatum_ID As Long, tabelle As Integer)\n\nDim rst      As Recordset\nDim sql      As String\nDim i        As Integer  'Counter PosNr\nDim Criteria As String\n\n    Criteria = \"VA_ID = \" & VA_ID & \" And VADatum_ID = \" & VADatum_ID\n    \n    Select Case tabelle\n        'Sortierung der ZUORDNUNG\n        Case 1\n            ' ab mindestens zwei Datensätzen\n            If TCount(\"MA_ID\", ZUORDNUNG, Criteria) < 2 Then Exit Function\n            \n            'Zugewiesene Datensätze sortiert (Sortierfeld = Nachname, bei Vorbelegungssätzen \"ZZZ\")\n            'SQL = \"SELECT * FROM qry_Mitarbeiter_Zusage WHERE \" & CRITERIA & \" ORDER BY Beginn ASC, Sortierfeld ASC\"\n            sql = \"SELECT * FROM qry_Mitarbeiter_Zusage WHERE \" & Criteria & \" ORDER BY Beginn ASC, Ende ASC, Sortierfeld ASC\"\n            Set rst = CurrentDb.OpenRecordset(sql)\n            'Set rst = rst.Clone 'Werte merken -> nicht mehr benötigt\n            \n            If rst.RecordCount > 1 Then\n                i = 1\n                'Vorbelegungssätze mit leeren MA_IDs -> MA_ID = 0 setzen\n                sql = \"UPDATE \" & ZUORDNUNG & \" SET  MA_ID = 0 WHERE MA_ID is Null\"\n                CurrentDb.Execute sql\n                'Positionsnummern bei relevanten Datensätzen entfernen (inkl. Vorbelegungssätze MA_ID = 0)\n                sql = \"UPDATE \" & ZUORDNUNG & \" SET PosNr = '' WHERE \" & Criteria\n                CurrentDb.Execute sql\n                \n                'Positionsnummern updaten (TUpdate nötig, da rst aus Abfrage nicht editierbar!)\n                Do 'Zugewiesene\n                    TUpdate \"PosNr = \" & i, ZUORDNUNG, Criteria & \" AND MA_ID = \" & rst.fields(\"MA_ID\") & _\n                        \" AND VAStart_ID = \" & rst.fields(\"VAStart_ID\") & \" AND isNull(PosNr)\"\n                    i = i + 1\n                    rst.MoveNext\n                Loop Until rst.EOF\n            End If\n            \n            rst.Close\n            Set rst = Nothing\n            \n        'Sortierung der PLANUNG\n        Case 2\n            'Relevante Datensätze sortiert\n            sql = \"SELECT * FROM qry_Mitarbeiter_Geplant WHERE \" & Criteria & \" ORDER BY Nachname ASC\"\n            'Neue Positionsnummern einfügen\n            Set rst = CurrentDb.OpenRecordset(sql)\n            Set rst = rst.Clone 'Werte merken\n            \n            If rst.RecordCount > 1 Then\n                'Positionsnummern bei relevanten Datensätzen entfernen\n                sql = \"UPDATE \" & PLANUNG & \" SET PosNr = '' WHERE \" & Criteria\n                CurrentDb.Execute sql\n                \n                i = 1\n                Do\n                    TUpdate \"PosNr = \" & i, PLANUNG, Criteria & \" AND MA_ID = \" & rst.fields(\"MA_ID\") & _\n                        \" AND VAStart_ID = \" & rst.fields(\"VAStart_ID\") & \" AND isNull(PosNr)\"\n                    rst.MoveNext\n                    i = i + 1\n                Loop Until rst.EOF\n                rst.Close\n                Set rst = Nothing\n                \n                \n                'Absagen hinten anfügen\n                sql = \"SELECT * FROM \" & PLANUNG & \" WHERE \" & Criteria & \" AND Status_ID = 4\"\n                \n                'Neue Positionsnummern einfügen\n                Set rst = CurrentDb.OpenRecordset(sql)\n                ' i wird fortgestetzt!\n                If rst.RecordCount > 0 Then\n                    Do\n                        rst.Edit\n                        rst.fields(\"PosNr\") = i\n                        rst.update\n                        rst.MoveNext\n                        i = i + 1\n                    Loop Until rst.EOF\n                End If\n                rst.Close\n            End If\n            Set rst = Nothing\n            \n    End Select\n    \nEnd Function\n\n\n'Hier werden die Vergleichszeiten aufgebaut\nFunction upd_Vergleichszeiten(VA_ID As Long, von As Date, bis As Date) As String\n\nDim sql         As String\nDim tbl_FE      As String\nDim tbl_BE      As String\nDim BackendDB   As String\nDim sqlStart    As String\nDim sqlEnde     As String\nDim rc          As String\n\nOn Error GoTo err\n\n    BackendDB = TLookup(\"Database\", \"MSysObjects\", \"Database IS NOT NULL\")\n    sqlStart = DateTimeForSQL(DateAdd(\"n\", 0, von))\n    sqlEnde = DateTimeForSQL(DateAdd(\"n\", 0, bis))\n    tbl_FE = \"tbltmp_Vergleichszeiten\"\n    tbl_BE = \"ztbltmp_Vergleichszeiten\"\n    \n    'Frontend\n    sql = \"DELETE * FROM \" & tbl_FE\n    CurrentDb.Execute sql\n    \n    sql = \"\"\n    sql = sql & \"INSERT INTO \" & tbl_FE & \" ( VGL_Start, VGL_Ende, VGL_VA_ID )\"\n    sql = sql & \" SELECT \" & sqlStart & \", \" & sqlEnde & \", \" & VA_ID & \" AS Ausdr1\"\n    sql = sql & \" FROM _tblInternalSystemFE;\"\n    CurrentDb.Execute (sql)\n    DoEvents\n    \n    'Backend\n    sql = \"DELETE * FROM \" & tbl_BE & \" IN '\" & BackendDB & \"'\"\n    CurrentDb.Execute sql\n    \n    sql = \"INSERT INTO \" & tbl_BE & \" IN '\" & BackendDB & \"' SELECT * FROM \" & tbl_FE\n    CurrentDb.Execute sql\n    \n    upd_Vergleichszeiten = upd_ztbl_MA_Verfuegbarkeit\n    \n    Exit Function\n\nerr:\n    upd_Vergleichszeiten = err.Number & \" \" & err.description\n\nEnd Function\n\n'Verfügbarkeiten aus dem Backend holen\nFunction upd_ztbl_MA_Verfuegbarkeit() As String\n\nDim BackendDB   As String\nDim tbl         As String\nDim QRY         As String\nDim sql         As String\n\nOn Error GoTo err\n\n    BackendDB = TLookup(\"Database\", \"MSysObjects\", \"Database IS NOT NULL\")\n    tbl = \"ztbl_MA_Verfuegbarkeit\"\n    QRY = \"zqry_MA_Auswahl_Alle\"\n    \n    sql = \"DELETE * FROM \" & tbl\n    CurrentDb.Execute sql\n    \n    sql = \"INSERT INTO \" & tbl & \"(MA_ID, Beginn, Ende, Grund)\" & _\n            \" SELECT ID, Beginn, Ende, Grund FROM \" & QRY & \" IN '\" & BackendDB & \"'\" & _\n            \" WHERE ID <> 0;\"\n    \n    CurrentDb.Execute sql\n    \n    Exit Function\n    \nerr:\n    upd_ztbl_MA_Verfuegbarkeit = err.Number & \" \" & err.description\n    \nEnd Function\n\n\n'Hier wird die Query zur Verfügbarkeit aufgebaut (SQL)\nFunction upd_qry_Verfuegbarkeit(iVerf As Long, iAnstArt As Long, iQuali As Long, iAktiv As Long, Optional iVerplantVerfuegbar As Long, Optional iNur34a As Long) As String\n\nDim sql         As String\nDim QRY         As String\nDim anstArt     As String\nDim tbl         As String\n\n    QRY = \"zqry_MA_Verfuegbarkeit\"\n\n    sql = \"SELECT * FROM \" & QRY\n\n    'Weitere Kriterien aufbauen\n    If iQuali <> 1 And iAnstArt = 9 Then\n        sql = sql & \"_Quali WHERE Quali_ID = \" & iQuali\n    ElseIf iQuali = 1 And iAnstArt <> 9 Then\n        sql = sql & \" WHERE (Anstellungsart_ID = \" & iAnstArt\n    ElseIf iQuali <> 1 And iAnstArt <> 9 Then\n        sql = sql & \"_Quali WHERE Quali_ID = \" & iQuali & \" AND (Anstellungsart_ID = \" & iAnstArt\n    Else\n        sql = sql & \" WHERE 1 = 1\"\n    End If\n\n    If iAnstArt = 13 Then\n        sql = sql & \" OR Anstellungsart_ID = 5 OR Anstellungsart_ID = 3)\"\n    ElseIf InStr(sql, \"Anstellung\") <> 0 Then\n        sql = sql & \")\"\n    End If\n    \n    'Aktiv?\n    If iAktiv = True Then sql = sql & \" AND istAktiv = \" & iAktiv\n    \n    'Verfügbar regulär\n    If iVerf = True And iVerplantVerfuegbar = False Then sql = sql & \" AND istVerfuegbar = \" & iVerf\n    \n    'Planung = verfügbar\n    If iVerf = True And iVerplantVerfuegbar = True Then sql = sql & \" AND ( istVerfuegbar = \" & iVerf & \" OR istVerplant = \" & iVerplantVerfuegbar & \")\"\n    \n    'Nur 34a\n    If iNur34a = True Then sql = sql & \" AND Hat_keine_34a = True\"\n    \n    sql = sql & \" ORDER BY Name\"\n    \n    upd_qry_Verfuegbarkeit = sql\n\nEnd Function\n\n'Aktualisierung der Verfügbarkeiten Variante 1\n'Geschwindigkeitsoptimierung: \"Z\"-Abfragen laufen schneller... wenn Verfügbarkeiten nicht mehr passen, dann \"Z\"s rückbauen\nFunction aktualisiere_Verfuegbarkeiten(VA_ID As Long, MVA_Start As Date, Optional MVA_Ende As Date)\n\nDim strSQL As String\nDim iVerfueg As Long\nDim stmplng As Single\n\nDim dttemp As Date\nDim dttempst As Date\n\n\n'Me!VADatum_ID.RowSource = \"SELECT tbl_VA_AnzTage.ID, tbl_VA_AnzTage.VADatum FROM tbl_VA_AnzTage WHERE (((tbl_VA_AnzTage.VA_ID) = \" & VA_ID & \"));\"\n'Me!VAStart_ID.RowSource = \"SELECT tbl_VA_Start.ID, tbl_VA_Start.VA_Start, tbl_VA_Start.VA_Ende FROM tbl_VA_Start WHERE (((tbl_VA_Start.VA_ID) = \" & VA_ID & \")) ORDER BY VA_Start;\"\n\n\nCurrentDb.Execute (\"UPDATE tbltmp_MA_Verfueg_tmp SET tbltmp_MA_Verfueg_tmp.IstVerfuegbar = -1;\")\n\nIf Len(Trim(Nz(MVA_Ende))) = 0 Then\n    stmplng = Get_Priv_Property(\"prp_VA_Start_AutoLaenge\") / 24\n    dttemp = MVA_Start + stmplng\nElse\n    dttemp = MVA_Ende\nEnd If\n\ndttempst = MVA_Start\n\nCall zfCreateQuery_Verplant(dttempst, dttemp)\nDoEvents\niVerfueg = Nz(TCount(\"MA_ID\", \"zqry_VV_tmp_belegt\"), 0)\n\nDoEvents\nCurrentDb.Execute (\"DELETE * FROM tbltmp_VV_Belegt\")\nIf iVerfueg > 0 Then\n    CurrentDb.Execute (\"zqryVV_tmp_belegt_ADD\")\n    CurrentDb.Execute (\"qry_VV_Upd_Verfueg_All\")\nEnd If\n\nCurrentDb.Execute (\"UPDATE tbltmp_MA_Verfueg_tmp SET tbltmp_MA_Verfueg_tmp.IstVerfuegbar = -1 Where IstSubunternehmer = True;\")\n\nEnd Function\n\n'Control einfärben / Spalte Farbig markieren\nFunction einfaerben(control As control, Wert As Variant, color As String, Optional altloesch As Boolean)\n\nDim fcd As FormatCondition\n\nOn Error Resume Next\n\n    If altloesch = True Then control.FormatConditions.Delete\n    \n    Set fcd = control.FormatConditions.Add(acFieldValue, acEqual, Wert)\n        fcd.backColor = color\n    Set fcd = Nothing\n\n\nEnd Function\n\n\nFunction falscheStartID()\n\n    Dim rst As Recordset\n    Dim DatumID As Long\n    Dim startzeit As Date\n    Dim StartID As Long\n\n    Set rst = CurrentDb.OpenRecordset(\"SELECT * FROM \" & ZUORDNUNG & \" ORDER BY VADatum_ID, MA_Start\")\n    \n    DatumID = rst.fields(\"VADatum_ID\")\n    startzeit = rst.fields(\"MA_Start\")\n    StartID = rst.fields(\"VAStart_ID\")\n    \n    Do\n    'StartID gleich obwohl andere Startzeit\n    If rst.fields(\"VADatum_ID\") = DatumID And rst.fields(\"Ma_Start\") <> startzeit And rst.fields(\"VAStart_ID\") = StartID Then\n        CurrentDb.Execute \"INSERT INTO zzz_CheckStartId SELECT * FROM \" & ZUORDNUNG\n    End If\n    \n    If rst.fields(\"VADatum_ID\") <> DatumID Then\n        DatumID = rst.fields(\"VADatum_ID\")\n        startzeit = rst.fields(\"MA_Start\")\n        StartID = rst.fields(\"VAStart_ID\")\n    End If\n    If rst.fields(\"MA_Start\") <> startzeit Then\n        startzeit = rst.fields(\"MA_Start\")\n        StartID = rst.fields(\"VAStart_ID\")\n    End If\n    \n    rst.MoveNext\n    Loop Until rst.EOF\n\nEnd Function\n\n\n'Nächste (kleinste) freie Nummer/ID einer Tabelle ermitteln\nPublic Function getFreeID(ByVal tableName As String, ID_Fieldname As String) As Long\n    Dim sql As String\n    Dim rs As Recordset\n\n    sql = \"\"\n    sql = sql & \"SELECT nz(Min(t.\" + ID_Fieldname + \"),0)+1 AS FreeID \"\n    sql = sql & \"FROM \" + tableName + \" AS t \"\n    sql = sql & \"WHERE Nz((SELECT Min(p.\" + ID_Fieldname + \") \"\n    sql = sql & \"          FROM \" + tableName + \" AS p \"\n    sql = sql & \"          Where p.\" + ID_Fieldname + \">t.\" + ID_Fieldname + \") \"\n    sql = sql & \"          - [t].[\" + ID_Fieldname + \"], 2) > 1;\"\n\n     Set rs = CurrentDb.OpenRecordset(sql, dbOpenSnapshot)\n\n    getFreeID = rs!FreeID\n\n    rs.Close\n    Set rs = Nothing\n\nEnd Function\n\n\n'Ausrichtung Bericht Seitenansicht\nFunction AusrichtungSetzen(strBericht As String, Optional blnHochformat As Boolean = True, Optional strPrinter As String)\n    Const DM_HOCHFORMAT = 1\n    Const DM_QUERFORMAT = 2\n    Dim GeraeteZF       As str_DEVMODE\n    Dim DM              As type_DEVMODE\n    Dim strGeraetemodus As String\n    Dim rpt             As Report\n   \n    ' Den Bericht in der Entwurfsansicht öffnen.\n    DoCmd.OpenReport strBericht$, acDesign\n    Set rpt = Reports(strBericht$)\n    If Not IsNull(rpt.PrtDevMode) Then\n        strGeraetemodus$ = rpt.PrtDevMode\n        GeraeteZF.strGZF$ = strGeraetemodus$\n        LSet DM = GeraeteZF\n        ' Das Element Fields initialisieren.\n        DM.lngFields& = DM.lngFields& Or DM.intOrientation%\n        If blnHochformat Then\n            DM.intOrientation% = DM_HOCHFORMAT\n          Else\n            DM.intOrientation% = DM_QUERFORMAT\n        End If\n        LSet GeraeteZF = DM                    ' Die Eigenschaft aktualisieren\n        Mid(strGeraetemodus$, 1, 94) = GeraeteZF.strGZF$\n        rpt.PrtDevMode = strGeraetemodus$\n    End If\n    'Drucker setzen\n    If strPrinter <> \"\" Then rpt.Printer = Application.Printers(strPrinter)\n    DoCmd.Close acReport, strBericht$, acSaveYes           ' Bericht speichern\nEnd Function\n\n\n'STUNDEN -> gibt Stunden auch bei Tageswechsel korrekt zurück\n'Test: ?stunden(\"16:30:00\",\"21:15:00\")\nPublic Function stunden(ByVal Arbeitsbeginn As Date, ByVal Arbeitsende As Date)\n    Call Ende(Arbeitsbeginn, Arbeitsende)\n    stunden = Round(Arbeitsende - Arbeitsbeginn, 2)\nEnd Function\n\nPublic Sub Beginn(Arbeitsbeginn)\n    Call Beginn24(Arbeitsbeginn)\n    Arbeitsbeginn = IIf(Arbeitsbeginn < 6, Arbeitsbeginn + 24, Arbeitsbeginn)\nEnd Sub\n\nPublic Sub Ende(Arbeitsbeginn, Arbeitsende)\n    Call Beginn24(Arbeitsbeginn)\n    Call Ende24(Arbeitsende)\n    Arbeitsende = IIf(Arbeitsende < Arbeitsbeginn, Arbeitsende + 24, Arbeitsende)\nEnd Sub\n\nPublic Sub Beginn24(Arbeitsbeginn)\n    Arbeitsbeginn = Arbeitsbeginn * 24\nEnd Sub\n\nPublic Sub Ende24(Arbeitsende)\n    Arbeitsende = Arbeitsende * 24\nEnd Sub\n\n\nFunction create_Gesamtliste()\n    \nDim Liste As String\nDim rst As Recordset\nDim sql As String\n    \n    Liste = \"ztbl_Gesamtliste\"\n    \n    sql = \"DELETE * FROM  \" & Liste\n    CurrentDb.Execute sql\n    \n    sql = \"INSERT INTO \" & Liste & _\n        \" (ID, Datum, Auftrag) SELECT [ID], [Dat_VA_Von], [Auftrag] + ', ' + [Ort] + ', ' + [Objekt] FROM \" & AUFTRAGSTAMM '& _\n        \" WHERE [Dat_VA_Von] > \" & Datum_von\n    CurrentDb.Execute sql\n    \n    Set rst = CurrentDb.OpenRecordset(Liste)\n    \n    Do\n        rst.Edit\n        rst.fields(\"Std_Brutto\") = TSum(\"MA_brutto_std2\", ZUORDNUNG, \"VA_ID = \" & rst.fields(\"ID\"))\n        rst.fields(\"Std_Netto\") = TSum(\"MA_netto_std2\", ZUORDNUNG, \"VA_ID = \" & rst.fields(\"ID\"))\n        rst.fields(\"Anzahl_MA\") = TLookup(\"MA_Anzahl_Ist\", VASTART, \"VA_ID = \" & rst.fields(\"ID\"))\n        'rst.Fields(\"Personalkosten\") = rst.Fields(\"Std_Netto\")\n        'rst.Fields(\"Umsatz\") =\n        'rst.Fields(\"Fahrtkosten_KD\") =\n        'rst.Fields(\"Fahrtkosten_MA\") =\n        'rst.Fields(\"Ertrag_Brutto-Netto\") =\n        'rst.Fields(\"Ertrag_tba\") =\n        'rst.Fields(\"Ertrag_FK\") =\n        'rst.Fields(\"Rohertrag\") =\n        'rst.Fields(\"Gesamtertrag\") =\n        \n        rst.update\n        rst.MoveNext\n    \n    Loop Until rst.EOF\n    \n'    Datum\n'    Auftrag Ort Location\n'1   Std. brutto Summevon tbl_ma_va_zuordnung.MA_brutto_std2\n'2   Std. netto  Summevon tbl_ma_va_zuordnung.MA_netto_std2\n'3   Anzah MA    Summevon tbl_va_start.MA_Anzahl\n'4   Personalkosten Summevon([tbl_ma_va_zuordnung.MA_Netto_Std2] * [Kosten_pro_MAStunde])\n'5   Umsatz  Summevon ([tbl_ma_va_zuordnung.MA_Brutto_Std2]*[tbl_KD_Standardpreise.StdPreis])  mit Bedingung Preisart_ID = 1\n'6   Fahrtkosten KD  Summevon ([tbl_va_Auftragstamm.Fahrtkosten]*[tbl_va_Auftragstamm.PKW_Anzahl])\n'7   Fahrtkosten MA  Summevon tbl_ma_va_Zuordnung.PKW\n'8   Ertrag Brutto - Netto   5-4\n'9   Ertrag tba  Summevon tbl_ma_va_zuordnung.MA_ID mit Bedingung MA_ID = 1001\n'10  Ertrag FK   6-7\n'11  Rohertrag 8 + 10\n'12  Gesamtertrag 8 + 9 + 10\n\n\n\n\n    Set rst = Nothing\n    \nEnd Function\n\n\nFunction correct_MA_Start_Ende_ZUO()\n\nDim rst As Recordset\n    \n    Set rst = CurrentDb.OpenRecordset(ZUORDNUNG)\n    \n    Do\n\n        If Len(rst.fields(\"MA_Start\")) <> 8 Or Len(rst.fields(\"MA_Ende\")) <> 8 Then\n            Debug.Print Len(rst.fields(\"MA_Start\")) & \"  \" & Len(rst.fields(\"MA_Ende\")) & \"  \" & rst.fields(\"VA_ID\") & \"  \" & rst.fields(\"MA_ID\")\n            rst.Edit\n            If Not IsNull(rst.fields(\"MA_Start\")) Then rst.fields(\"MA_Start\") = Right(rst.fields(\"MA_Start\"), 8)\n            If Not IsNull(rst.fields(\"MA_Ende\")) Then rst.fields(\"MA_Ende\") = Right(rst.fields(\"MA_Ende\"), 8)\n            rst.update\n        End If\n        rst.MoveNext\n    Loop Until rst.EOF\n\n    Set rst = CurrentDb.OpenRecordset(PLANUNG)\n    \n    Do\n\n        If Len(rst.fields(\"VA_Start\")) <> 8 Or Len(rst.fields(\"VA_Ende\")) <> 8 Then\n            Debug.Print Len(rst.fields(\"VA_Start\")) & \"  \" & Len(rst.fields(\"VA_Ende\")) & \"  \" & rst.fields(\"VA_ID\") & \"  \" & rst.fields(\"MA_ID\")\n            rst.Edit\n            If Not IsNull(rst.fields(\"VA_Start\")) Then rst.fields(\"VA_Start\") = Right(rst.fields(\"VA_Start\"), 8)\n            If Not IsNull(rst.fields(\"VA_Ende\")) Then\n                If Len(rst.fields(\"VA_Ende\") = 10) Then\n                    rst.fields(\"VA_Ende\") = \"00:00:00\"\n                Else\n                    rst.fields(\"VA_Ende\") = Right(rst.fields(\"VA_Ende\"), 8)\n                End If\n            End If\n            rst.update\n        End If\n        rst.MoveNext\n    Loop Until rst.EOF\nEnd Function\n\n'Feldwertprüfung intial\nPublic Function IsInitial(field As Variant) As Boolean\n\n    If IsNull(field) Or field = \"\" Or field = 0 Then IsInitial = True\n\nEnd Function\n\n\nFunction Feiertag(ByVal Datum As Date) As String\n'TEST: ?feiertag(\"25.12.2050\")\n'NUR GESETZLICHE FEIERTAGE IN BAYERN\n\nDim intjahr As Integer\nDim X As Integer, Y As Date\nDim intI As Integer, arrDatum(1 To 20)  As Date, arrText(1 To 20) As String\n  \nOn Error Resume Next\n\n    intjahr = VBA.year(Datum)\n    'Ostersonntag ermitteln\n    X = (((255 - 11 * (intjahr Mod 19)) - 21) Mod 30) + 21\n    Y = DateSerial(intjahr, 3, 1) + X + (X > 48) + 6 - _\n        ((intjahr + intjahr \\ 4 + X + (X > 48) + 1) Mod 7)\n    intI = 0\n    \n    'VARIABEL\n    'intI = intI + 1: arrDatum(intI) = y - 48:  arrText(intI) = \"Rosenmontag\"\n    intI = intI + 1: arrDatum(intI) = Y - 2: arrText(intI) = \"Karfreitag\"\n    intI = intI + 1: arrDatum(intI) = Y: arrText(intI) = \"Ostersonntag\"\n    intI = intI + 1: arrDatum(intI) = Y + 1: arrText(intI) = \"Ostermontag\"\n    intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 5, 1): arrText(intI) = \"Tag der Arbeit\"\n    intI = intI + 1: arrDatum(intI) = Y + 39: arrText(intI) = \"Christi Himmelfahrt\"\n    intI = intI + 1: arrDatum(intI) = Y + 49:  arrText(intI) = \"Pfingstsonntag\"\n    intI = intI + 1: arrDatum(intI) = Y + 50: arrText(intI) = \"Pfingstmontag\"\n    intI = intI + 1: arrDatum(intI) = Y + 60: arrText(intI) = \"Fronleichnam\"\n    'FIX:\n    intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 1, 1): arrText(intI) = \"Neujahr\"\n    intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 1, 6):  arrText(intI) = \"Hl. drei Könige\"\n    intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 10, 3):  arrText(intI) = \"Tag der deutschen Einheit\"\n    intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 11, 1):  arrText(intI) = \"Allerheiligen\"\n    'intI = intI + 1 :arrDatum(intI) = DateSerial(intjahr, 12, 24):  arrText(intI) = \"Heiligabend\"\n    intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 12, 25):  arrText(intI) = \"1. Weihnachtstag\"\n    intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 12, 26):  arrText(intI) = \"2. Weihnachtstag\"\n    'intI = intI + 1: arrDatum(intI) = DateSerial(intjahr, 12, 31):  arrText(intI) = \"Silvester\"\n    \n    For intI = LBound(arrDatum) To intI\n        If Datum = arrDatum(intI) Then\n            Feiertag = arrText(intI)\n        End If\n    Next\n\nEnd Function\n\n'Monat aus Zahl\nFunction Monat_lang(Monat As Integer) As String\n    \n    Select Case Monat\n        Case 1\n            Monat_lang = \"Januar\"\n        Case 2\n            Monat_lang = \"Februar\"\n        Case 3\n            Monat_lang = \"März\"\n        Case 4\n            Monat_lang = \"April\"\n        Case 5\n            Monat_lang = \"Mai\"\n        Case 6\n            Monat_lang = \"Juni\"\n        Case 7\n            Monat_lang = \"Juli\"\n        Case 8\n            Monat_lang = \"August\"\n        Case 9\n            Monat_lang = \"September\"\n        Case 10\n            Monat_lang = \"Oktober\"\n        Case 11\n            Monat_lang = \"November\"\n        Case 12\n            Monat_lang = \"Dezember\"\n    End Select\n    \nEnd Function\n\n\n'Array Sortieren\nFunction BubbleSort(ByRef strArray As Variant) As Variant()\n    'sortieren von String Array\n    'eindimensionale Array\n    'Bubble-Sortier-Verfahren\n   Dim z       As Long\n   Dim i       As Long\n   Dim strWert As Variant\n     \n    For z = UBound(strArray) - 1 To LBound(strArray) Step -1\n        For i = LBound(strArray) To z\n            If LCase(strArray(i)) > LCase(strArray(i + 1)) Then\n                strWert = strArray(i)\n                strArray(i) = strArray(i + 1)\n                strArray(i + 1) = strWert\n            End If\n        Next i\n    Next z\n     \n    BubbleSort = strArray\n     \nEnd Function\n\n'Feldwerte einer Tabelle oder Abfrage in Array selektieren => Array muss vom Typ Variant sein!\nFunction select_in_array(quelle As String, field As String, WHERE As String) As Variant\n\nDim sql     As String\nDim rs      As Recordset\nDim arr     As Variant\nDim tmp()   As Variant\nDim i       As Integer\n\nOn Error GoTo err\n\n    sql = \"SELECT \" & field & \" FROM \" & quelle & \" WHERE \" & WHERE\n    Set rs = CurrentDb.OpenRecordset(sql)\n    rs.MoveLast\n    rs.MoveFirst\n    arr = rs.GetRows(rs.RecordCount)\n    rs.Close\n    Set rs = Nothing\n    \n    'Werte in String schreiben\n    For i = LBound(arr, 2) To UBound(arr, 2)\n        ReDim Preserve tmp(i)\n        tmp(i) = arr(0, i)\n    Next i\n    \nEnde:\n    select_in_array = tmp\n    Exit Function\nerr:\n    Resume Ende\nEnd Function\n\n\n'Feldwerte einer Tabelle oder Abfrage als String ausgeben\nFunction select_in_string(quelle As String, field As String, WHERE As String) As String\n\nDim sql As String\nDim rs  As Recordset\nDim arr As Variant\nDim i   As Integer\n\nOn Error GoTo err\n\n    sql = \"SELECT \" & field & \" FROM \" & quelle & \" WHERE \" & WHERE\n    Set rs = CurrentDb.OpenRecordset(sql)\n    rs.MoveLast\n    rs.MoveFirst\n    arr = rs.GetRows(rs.RecordCount)\n    rs.Close\n    Set rs = Nothing\n    \n    'Werte in String schreiben\n    For i = LBound(arr, 2) To UBound(arr, 2)\n        select_in_string = select_in_string & arr(0, i) & \",\"\n    Next i\n\n    'letztes Komma entfernen\n    select_in_string = Left(select_in_string, Len(select_in_string) - 1)\n    \nEnde:\n    Exit Function\nerr:\n    select_in_string = 0\n    Resume Ende\nEnd Function\n\n\n'Standardwerte bei neuem Mitarbeiter\nFunction set_values_new_ma(MA_ID As Long)\n\nDim rs  As Recordset\nDim sql As String\n\n    sql = \"SELECT * FROM \" & MASTAMM & \" WHERE ID = \" & MA_ID\n    \n    Set rs = CurrentDb.OpenRecordset(sql)\n    rs.Edit\n    \n    rs.fields(\"Eintrittsdatum\") = Left(Now, 10)\n    rs.fields(\"Bezuege_gezahlt_als\") = \"Stundenlohn\"\n    \n    rs.update\n    rs.Close\n    Set rs = Nothing\n\nEnd Function\n\n\n'Qualifikation für Mitarbeiter eintragen\nFunction set_quali(MA_ID As Long, Quali_ID As Long)\n\nDim tbl As String\n\n    tbl = \"tbl_MA_Einsatz_Zuo\"\n\n    If TCount(\"*\", tbl, \"MA_ID = \" & MA_ID & \" AND Quali_ID = \" & Quali_ID) = 0 Then _\n        CurrentDb.Execute \" INSERT INTO \" & tbl & \"(MA_ID, Quali_ID) VALUES (\" & MA_ID & \",\" & Quali_ID & \")\"\n\nEnd Function\n\n'Makro im Backend / in anderer DB ausführen\nFunction execute_Makro(Makro As String, Optional db As String)\n\nDim ShellExec   As String\n\n    If IsInitial(db) Then db = TLookup(\"Database\", \"MSysObjects\", \"Database IS NOT NULL\")\n    ShellExec = \"C:\\Program Files\\Microsoft Office\\root\\Office16\\MSACCESS.EXE /EMBEDDING \" & db & \" /x \" & Makro\n    Shell ShellExec\n\nEnd Function\n\n\n'Formular nach Excel exportieren\nPublic Function ExportFormToExcel(strExcelpath As String, sfm As Form)\n     Dim db As DAO.Database\n     Dim qdf As QueryDef\n     Dim strQuery As String\n     Dim strSQL As String\n     Dim strFilter As String\n     Dim strOrderBy As String\n     Dim strRecordsource As String\n     On Error Resume Next\n     Kill strExcelpath\n     On Error GoTo 0\n     Set db = CurrentDb\n     strQuery = \"qryTemp\"\n     If Left(sfm.recordSource, 6) = \"SELECT\" Then\n         strSQL = sfm.recordSource\n     Else\n         strSQL = \"SELECT * FROM \" & sfm.recordSource\n     End If\n     If sfm.FilterOn = True Then\n         strFilter = sfm.filter\n     End If\n     If sfm.OrderByOn = True Then\n         strOrderBy = sfm.OrderBy\n     End If\n     strSQL = AddWhereAndOrderByToSQL(strSQL, strFilter, strOrderBy)\n     Set qdf = db.CreateQueryDef(strQuery, strSQL)\n     DoCmd.TransferSpreadsheet acExport, acSpreadsheetTypeExcel12Xml, strQuery, strExcelpath, True\n     db.QueryDefs.Delete strQuery\nEnd Function\n\nPublic Function AddWhereAndOrderByToSQL(strSQL As String, Optional strFilter As String, _\n         Optional strOrderBy As String) As String\n     Dim strTemp As String\n     strTemp = strSQL\n     If Not Len(strFilter) = 0 Then\n         If InStr(1, strTemp, \"WHERE\") = 0 Then\n             If InStr(1, strTemp, \"ORDER BY\") = 0 Then\n                 strTemp = strTemp & \" WHERE \" & strFilter\n             Else\n                 strTemp = Replace(strTemp, \" ORDER BY \", \" WHERE \" & strFilter & \" ORDER BY \")\n             End If\n         Else\n             If InStr(1, strTemp, \"ORDER BY\") = 0 Then\n                 strTemp = strTemp & \" AND \" & strFilter\n             Else\n                 strTemp = Replace(strTemp, \" ORDER BY \", \" AND \" & strFilter & \" ORDER BY \")\n             End If\n         End If\n     End If\n     If Not Len(strOrderBy) = 0 Then\n         If InStr(1, strTemp, \" ORDER BY \") = 0 Then\n             strTemp = strTemp & \" ORDER BY \" & strOrderBy\n         Else\n             strTemp = strTemp & \", \" & strOrderBy\n         End If\n     End If\n     AddWhereAndOrderByToSQL = strTemp\nEnd Function\n\nFunction calc_percentage_KD_hours(kun_ID As Long, Optional Jahr As Integer, Optional Monat As Integer) As Double\n\nDim QRY         As String\nDim WHERE       As String\nDim StundenGes  As Double\nDim StundenRel  As Double\n\nOn Error Resume Next\n\n    QRY = \"zqry_KD_Gesamtstunden_Datum\"\n    \n    If Not IsInitial(Jahr) Then\n        WHERE = \"Jahr = \" & Jahr\n        If Not IsInitial(Monat) Then WHERE = WHERE & \" AND Monat = \" & Monat\n    End If\n\n    StundenGes = TSum(\"SummevonMA_Brutto_Std2\", QRY, WHERE)\n    StundenRel = TSum(\"SummevonMA_Brutto_Std2\", QRY, WHERE & \" AND kun_Id = \" & kun_ID)\n    \n    calc_percentage_KD_hours = (StundenRel / StundenGes) * 100\n    calc_percentage_KD_hours = Round(calc_percentage_KD_hours, 2)\n\nEnd Function\n\n'Replace Characters - Sonderzeichen ersetzen\n'-> Verweise: Microsoft VBScript Regular Expression 5.5\nPublic Function CleanFilename(ByVal sFilename As String, Optional ByVal sChar As String = \"\") As String\nDim oRegExp As RegExp\n    Set oRegExp = New RegExp\n    With oRegExp\n    .IgnoreCase = True\n    .Global = True\n    .MultiLine = True\n    .Pattern = \"[\\\\/:?*^\"\"|]\"\n    ' alle nicht zulässigen Zeichen ersetzen\n    CleanFilename = .Replace(sFilename, sChar)\n    End With\n    Set oRegExp = Nothing\nEnd Function\n\n'Function Rech_Nr_fuellen()\n'\n'Dim rst As Recordset\n'\n'Set rst = CurrentDb.OpenRecordset(ZUORDNUNG)\n'\n'Do\n'    If InStr(rst.Fields(\"Bemerkungen\"), \"Berechnet\") Then Debug.Print rst.Fields(\"VA_ID\") & \"_\" & TUpdate(\"Rech_NR = '\" & Mid(rst.Fields(\"Bemerkungen\"), 11, Len(rst.Fields(\"Bemerkungen\"))) & \"'\", AUFTRAGSTAMM, \"ID = \" & rst.Fields(\"VA_ID\"))\n'\n'    rst.MoveNext\n'Loop Until rst.EOF\n'\n'End Function\n\n\n''NICHT MEHR BENÖTIGT\n'Function zuocheck_ecatt()\n'\n'    Dim rst As Recordset\n'\n'    Set rst = CurrentDb.OpenRecordset(ZUORDNUNG)\n'\n'    Do\n'\n'        rst.Edit\n'        rst.Fields(\"Bemerkungen\") = TLookup(\"Nachname\", MASTAMM, \"ID = \" & rst.Fields(\"MA_ID\"))\n'        Debug.Print rst.Fields(\"Bemerkungen\")\n'        rst.Update\n'        rst.MoveNext\n'\n'    Loop Until rst.EOF\n'\n'    rst.Close\n'    Set rst = Nothing\n'\n'End Function\n\n\n\n'Function update_Zeitpunkte()\n'\n'Dim SQL\n'\n'SQL = \"UPDATE tbl_MA_VA_Planung AS A \" & _\n'      \"INNER JOIN ztbl_Sync AS N \" & _\n'      \"ON A.VA_ID = N.VA_ID \" & _\n'      \"AND A.MA_ID = N.MA_ID \" & _\n'      \"AND A.VADatum_ID = N.VADatum_ID \" & _\n'      \"AND A.VAStart_ID = N.VAStart_ID \" & _\n'      \"Set A.Anfragezeitpunkt = N.Anfragezeitpunkt\"\n'\n'\n''CurrentDb.Execute SQL\n'\n'\n'SQL = \"UPDATE tbl_MA_VA_Zuordnung AS A \" & _\n'      \"INNER JOIN ztbl_Sync AS N \" & _\n'      \"ON A.VA_ID = N.VA_ID \" & _\n'      \"AND A.MA_ID = N.MA_ID \" & _\n'      \"AND A.VADatum_ID = N.VADatum_ID \" & _\n'      \"AND A.VAStart_ID = N.VAStart_ID \" & _\n'      \"Set A.Anfragezeitpunkt = N.Anfragezeitpunkt\"\n'\n'\n''CurrentDb.Execute SQL\n'\n'\n'End Function\n\n\n'EXTRAS-> VERWEISE\nFunction Verweise_auslesen()\nDim ref As Reference\n\nOn Error Resume Next\n\n     For Each ref In References\n        Debug.Print \"Name:     \" & ref.Name\n        'Debug.Print \"BuildIn:  \" & ref.BuiltIn\n        Debug.Print \"FullPath: \" & ref.FullPath\n        'Debug.Print \"GUID:     \" & ref.GUID\n        Debug.Print \"IsBroken: \" & ref.IsBroken\n        'Debug.Print \"Kind:     \" & ref.Kind\n        'Debug.Print \"Major:    \" & ref.Major\n        'Debug.Print \"Minor:    \" & ref.Minor\n        \n        Debug.Print \"\"\n     Next ref\n     \nEnd Function\n\n\nSub TEST()\n\nDim rs As Recordset\nDim sql As String\nDim tbl As String\n\nOn Error Resume Next\n\n    sql = \"SELECT * FROM MsysObjects\"\n\n    Set rs = CurrentDb.OpenRecordset(sql)\n    Do While Not rs.EOF\n    \n        tbl = rs.fields(\"Name\")\n        If InStr(tbl, \"tbltmp_\") <> 0 Then DoCmd.OpenTable tbl\n        rs.MoveNext\n    Loop\n    \nEnd Sub\n\nFunction qr_erstellen(ZUO_ID As Long) As String\n\nDim PDF_Datei   As String\nDim MA_ID       As Long\nDim VA_ID       As Long\nDim Name        As String\nDim Bemerkungen As String\nDim Info        As String\nDim title       As String\nDim data        As String\nDim Text        As String\nDim text2       As String\n\n    MA_ID = TLookup(\"MA_ID\", ZUORDNUNG, \"ID=\" & ZUO_ID)\n    VA_ID = TLookup(\"VA_ID\", ZUORDNUNG, \"ID=\" & ZUO_ID)\n    \n    Name = Nz(TLookup(\"Nachname\", MASTAMM, \"ID=\" & MA_ID), \"\") & \" \" & Nz(TLookup(\"Vorname\", MASTAMM, \"ID=\" & MA_ID), \"\")\n    Bemerkungen = Nz(TLookup(\"Bemerkungen\", ZUORDNUNG, \"ID=\" & ZUO_ID), \"\")\n    Info = Nz(TLookup(\"Info\", ZUORDNUNG, \"ID=\" & ZUO_ID), \"\")\n    \n    title = Nz(TLookup(\"Auftrag\", AUFTRAGSTAMM, \"ID = \" & VA_ID), \"\") & \", \" & Nz(TLookup(\"Ort\", AUFTRAGSTAMM, \"ID=\" & VA_ID), \"\") & \", \" & Nz(TLookup(\"Objekt\", AUFTRAGSTAMM, \"ID = \" & VA_ID), \"\")\n    data = ZUO_ID\n    Text = Name & vbCrLf & Bemerkungen & vbCrLf & Info\n        \n    text2 = CleanFilename(Name & \" \" & Bemerkungen & \" \" & Info)\n    PDF_Datei = PfadTempFiles & title & \" \" & text2 & \".pdf\"\n    \n    Call Set_Priv_Property(\"prp_qr_title\", title)\n    Call Set_Priv_Property(\"prp_qr_data\", data)\n    Call Set_Priv_Property(\"prp_qr_text\", Text)\n    \n    DoCmd.OutputTo acOutputReport, \"zrpt_QR_Code\", acFormatPDF, PDF_Datei\n\n    qr_erstellen = PDF_Datei\n    \nEnd Function"}
