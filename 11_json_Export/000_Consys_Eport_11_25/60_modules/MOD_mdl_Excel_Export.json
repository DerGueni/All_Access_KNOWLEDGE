{"id":"MOD_mdl_Excel_Export","name":"mdl_Excel_Export","kind":"standard","procedures":["Function fXL_Export_Auftrag(VA_ID As Long, XLPfad As String, XLName As String)","Function FCreate_Dienstplan_Excel_Send(Art As Long)","Function FCreate_Dienstplan_Excel(Art As Long, Optional bVisible As Boolean = True)","Function fxltstEz()","Function FCreate_Dienstplan_MA_Einzel_Excel(iMA_ID As Long, ByVal startdt As Date)"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\nDim xl As New clsExcel\n\nFunction fXL_Export_Auftrag(VA_ID As Long, XLPfad As String, XLName As String)\n\nDim iAnzMA As Long\nDim iAnzZeiten As Long\nDim iAnzPg As Long\nDim iAnzZl As Long\nDim xlVorlage As String\nDim wkb As Object\nDim iZeile As Long\nDim iSpalte As Long\nDim imaxzwi As Long\n\nDim strCol As String\nDim strColName As String\n\nDim datvgl As Date\n\nDim SheetnameArr() As String\n\nDim rg\nDim i As Long\nDim iLst As Long\nDim iZlLst As Long\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, DAOARRAY_Name1, iZl As Long, iCol As Long\nDim ArrFill_DAO_OK2 As Boolean, recsetSQL2 As String, iZLMax2 As Long, iColMax2 As Long, DAOARRAY2, iZl2 As Long, iCol2 As Long\n\nxlVorlage = Get_Priv_Property(\"prp_XL_DocVorlage\")\n\niAnzMA = Nz(TCount(\"*\", \"tbl_MA_VA_Zuordnung\", \"VA_ID = \" & VA_ID), 0)\niAnzZeiten = Nz(TCount(\"*\", \"tbl_VA_Start\", \"VA_ID = \" & VA_ID), 0)\niAnzPg = iAnzMA \\ 41\niAnzZl = iAnzZeiten - 3\nIf iAnzZl < 0 Then iAnzZl = 0\n\nSet wkb = xl.XL_Wkb_Add(xlVorlage)\nSleep 20\nDoEvents\nReDim SheetnameArr(iAnzPg)\nSheetnameArr(0) = \"Liste\"\n\nxl.XL_Visible True\n\nIf iAnzPg > 0 Then\n\n    wkb.Sheets(\"Liste (2)\").Visible = True\n    DoEvents\n    wkb.Sheets(\"Liste (2)\").Name = \"Liste 2\"\n    SheetnameArr(1) = \"Liste 2\"\n    Select Case iAnzPg\n        Case 2\n            wkb.Sheets(\"Liste (3)\").Visible = True\n            wkb.Sheets(\"Liste (3)\").Name = \"Liste 3\"\n            SheetnameArr(2) = \"Liste 3\"\n    \n        Case 3\n            wkb.Sheets(\"Liste (3)\").Visible = True\n            wkb.Sheets(\"Liste (3)\").Name = \"Liste 3\"\n             \n            wkb.Sheets(\"Liste 3\").Copy after:=wkb.Sheets(\"Liste 3\")\n            wkb.Sheets(\"Liste 3 (2)\").Name = \"Liste 4\"\n        \n            SheetnameArr(2) = \"Liste 3\"\n            SheetnameArr(3) = \"Liste 4\"\n        \n        Case 4\n            wkb.Sheets(\"Liste (3)\").Visible = True\n            wkb.Sheets(\"Liste (3)\").Name = \"Liste 3\"\n             \n            wkb.Sheets(\"Liste 3\").Copy after:=wkb.Sheets(\"Liste 3\")\n            wkb.Sheets(\"Liste 3 (2)\").Name = \"Liste 4\"\n            \n            wkb.Sheets(\"Liste 4\").Copy after:=wkb.Sheets(\"Liste 4\")\n            wkb.Sheets(\"Liste 4 (2)\").Name = \"Liste 5\"\n        \n            SheetnameArr(2) = \"Liste 3\"\n            SheetnameArr(3) = \"Liste 4\"\n            SheetnameArr(4) = \"Liste 5\"\n            \n    End Select\nEnd If\n\n'Teil 1 Kopf schreiben\n'#####################\n\nrecsetSQL1 = \"SELECT * FROM qry_Excel_Export_Teil1 WHERE VA_ID = \" & VA_ID\nrecsetSQL2 = \"Select * FROM qry_Excel_Sel_Import_Felder WHERE TabTyp = 1\"\n\nArrFill_DAO_OK1 = ArrFill_DAO(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1, DAOARRAY_Name1)\nArrFill_DAO_OK2 = ArrFill_DAO_Acc(recsetSQL2, iZLMax2, iColMax2, DAOARRAY2)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n\ndatvgl = CDate(DAOARRAY1(1, 0))\n\niZl = 0  ' Teil 1 nur eine Zeile\nIf ArrFill_DAO_OK1 Then\n    For iLst = 0 To UBound(SheetnameArr)\n        xl.SelectSheet (SheetnameArr(iLst))\n        For iCol = 0 To iColMax1\n            strCol = CStr(Nz(DAOARRAY1(iCol, iZl)))\n            strColName = CStr(Nz(DAOARRAY_Name1(iCol, 0)))\n            For i = 0 To iZLMax2\n                If CStr(DAOARRAY2(1, i)) = strColName Then\n                    Exit For\n                End If\n            Next i\n            If i <= iZLMax2 Then\n                If CStr(DAOARRAY2(1, i)) = strColName Then\n                    iSpalte = CLng(DAOARRAY2(3, i))\n                    iZeile = CLng(DAOARRAY2(4, i))\n                    Debug.Print strColName, strCol, iSpalte, iZeile\n                    \n                    'If strColName = \"Sicherheitspersonal\" Then Stop\n                    \n                    Set rg = xl.SetRange(iZeile, iSpalte, iZeile, iSpalte)\n                    rg(1, 1) = strCol\n                End If\n            End If\n        Next iCol\n    Next iLst\nEnd If\n    \nSet DAOARRAY1 = Nothing\nSet DAOARRAY_Name1 = Nothing\nSet DAOARRAY2 = Nothing\n    \n'Teil 3 MA schreiben\n'#####################\n\n\nrecsetSQL1 = \"SELECT * FROM qry_Excel_Export_Teil3 WHERE VA_ID = \" & VA_ID & \" ORDER BY VADatum, PosNr\"\nrecsetSQL2 = \"Select * FROM qry_Excel_Sel_Import_Felder WHERE TabTyp = 3\"\n\nArrFill_DAO_OK1 = ArrFill_DAO(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1, DAOARRAY_Name1)\nArrFill_DAO_OK2 = ArrFill_DAO_Acc(recsetSQL2, iZLMax2, iColMax2, DAOARRAY2)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n\niZl = 0\nIf ArrFill_DAO_OK1 Then\n    For iLst = 0 To UBound(SheetnameArr)\n        xl.SelectSheet (SheetnameArr(iLst))\n        For iZlLst = 0 To 45                 'ANZAHL NUTZZEILEN IN DER EINSATZLISTE\n            If iZl > iZLMax1 Then Exit For\n            For iCol = 1 To iColMax1\n                strCol = CStr(Nz(DAOARRAY1(iCol, iZl)))\n                strColName = CStr(Nz(DAOARRAY_Name1(iCol, 0)))\n                If strColName = \"VA_Datumstr\" Then\n                    If CDate(strCol) = datvgl And Not (iLst > 0 And iZlLst = 0) Then\n                        strCol = \"\"\n                    Else\n                        datvgl = CDate(strCol)\n                    End If\n                End If\n                If strColName = \"Beginnstr\" Or strColName = \"Endestr\" Then\n                    If strCol = \"00:00\" Then strCol = \"24:00\"\n                End If\n                For i = 0 To iZLMax2\n                    If CStr(DAOARRAY2(1, i)) = strColName Then\n                        Exit For\n                    End If\n                Next i\n                If i <= iZLMax2 Then\n                    If Not (strColName = \"VA_Datumstr\" And iLst = 0 And iZl = 0) Then\n                        If CStr(DAOARRAY2(1, i)) = strColName Then\n                            iSpalte = CLng(DAOARRAY2(3, i))\n                            iZeile = CLng(DAOARRAY2(4, i)) + iZlLst\n                            Set rg = xl.SetRange(iZeile, iSpalte, iZeile, iSpalte)\n                            rg(1, 1) = strCol\n                        End If\n                    End If\n                End If\n            Next iCol\n            iZl = iZl + 1\n        Next iZlLst\n    Next iLst\nEnd If\n    \nSet DAOARRAY1 = Nothing\nSet DAOARRAY_Name1 = Nothing\nSet DAOARRAY2 = Nothing\n    \n'Teil 2 Schichten schreiben\n'##########################\n\nrecsetSQL1 = \"SELECT * FROM qry_Excel_Export_Teil2 WHERE VA_ID = \" & VA_ID & \" ORDER BY vonStr, BisStr\"\nrecsetSQL2 = \"Select * FROM qry_Excel_Sel_Import_Felder WHERE TabTyp = 2\"\n\nArrFill_DAO_OK1 = ArrFill_DAO(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1, DAOARRAY_Name1)\nArrFill_DAO_OK2 = ArrFill_DAO_Acc(recsetSQL2, iZLMax2, iColMax2, DAOARRAY2)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n\nIf ArrFill_DAO_OK1 Then\n    For iLst = 0 To UBound(SheetnameArr)\n        imaxzwi = iZLMax1\n        If imaxzwi > 2 Then imaxzwi = 2\n        For iZl = 0 To imaxzwi\n           xl.SelectSheet (SheetnameArr(iLst))\n           For iCol = 1 To iColMax1\n               strCol = CStr(Nz(DAOARRAY1(iCol, iZl)))\n               strColName = CStr(Nz(DAOARRAY_Name1(iCol, 0)))\n               For i = 0 To iZLMax2\n                   If CStr(DAOARRAY2(1, i)) = strColName Then\n                       Exit For\n                   End If\n               Next i\n               If i <= iZLMax2 Then\n                   If CStr(DAOARRAY2(1, i)) = strColName Then\n                       iSpalte = CLng(DAOARRAY2(3, i))\n                       iZeile = CLng(DAOARRAY2(4, i))\n                       Debug.Print strColName, strCol, iSpalte, iZeile\n                       \n    '                   If strColName = \"Std_satz_KD_1_Nettostr\" Then Stop\n                       \n                       Set rg = xl.SetRange(iZeile, iSpalte, iZeile, iSpalte)\n                       rg(1, 1) = strCol\n                   End If\n               End If\n           Next iCol\n        Next iZl\n    Next iLst\nEnd If\n\nSet DAOARRAY1 = Nothing\nSet DAOARRAY_Name1 = Nothing\nSet DAOARRAY2 = Nothing\n    \nxl.XL_actWkb_SaveAs (XLPfad & XLName)\n'XL.XL_Close_Sure\nCurrentDb.Execute (\"UPDATE tbl_VA_Auftragstamm SET tbl_VA_Auftragstamm.Excel_Dateiname = '\" & XLName & \"', tbl_VA_Auftragstamm.Excel_Path = '\" & XLPfad & \"' WHERE (((tbl_VA_Auftragstamm.ID)=\" & VA_ID & \"));\")\n\nEnd Function\nFunction FCreate_Dienstplan_Excel_Send(Art As Long)\nDim dt As Date\nDim strdoc As String\nDim strPfad As String\n\nFCreate_Dienstplan_Excel Art, True\n\n\nIf Art = 1 Then  ' Objekt\n    dt = TLookup(\"Startdat\", \"tbltmp_DP_Grund_2\")\n    strdoc = \"DP_Obj_\" & Format(dt, \"dd.mm.yy\", 2, 2) & \".xlsm\"\nElseIf Art = 2 Then  ' MA\n    dt = TLookup(\"Startdat\", \"tbltmp_DP_MA_Grund_FI\")\n    strdoc = \"DP_MA_\" & Format(dt, \"dd.mm.yy\", 2, 2) & \".xlsm\"\nEnd If\n\nstrPfad = Get_Priv_Property(\"prp_CONSYS_GrundPfad\") & TLookup(\"Pfad\", \"_tblEigeneFirma_Pfade\", \"ID = 13\")\n\nIf File_exist(strPfad & strdoc) Then Kill strPfad & strdoc\nDoEvents\n\nxl.XL_actWkb_SaveAs (strPfad & strdoc)\n'XL.XL_Close_Sure\n\nDoEvents\n\nDoCmd.OpenForm (\"frmOff_Outlook_aufrufen\")\nForm_frmOff_Outlook_aufrufen.VAOpen (strPfad & strdoc)\n\nEnd Function\n\nFunction FCreate_Dienstplan_Excel(Art As Long, Optional bVisible As Boolean = True)\n' 1 = Objekt - tbltmp_DP_Grund\n' 2 = MA    - tbltmp_DP_MA_Grund\n\nDim strVgl As String\n\nDim wkb As Object\nDim sht As Object\n\nDim iUdl As Long\nDim i As Long\nDim j As Long\nDim k As Long\nDim dt As Date\nDim iXl As Long\nDim bFrag As Boolean\n\nDim iAnzMA As Long\nDim iAnzZeiten As Long\nDim iAnzPg As Long\nDim iAnzZl As Long\nDim xlVorlage As String\nDim iZeile As Long\nDim iSpalte As Long\nDim imaxzwi As Long\n\nDim strCol As String\nDim strColName As String\n\nDim datvgl As Date\n\nDim SheetnameArr() As String\n\nDim rg\nDim iLst As Long\nDim iZlLst As Long\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, DAOARRAY_Name1, iZl As Long, iCol As Long\n'Dim ArrFill_DAO_OK2 As Boolean, recsetSQL2 As String, iZLMax2 As Long, iColMax2 As Long, DAOARRAY2, iZl2 As Long, iCol2 As Long\n\n'Start in Spalte 5\n    'Zuo_Id\n    'MA_ID\n    'Name\n    'fraglich\n    'von\n    'bis\n'Spalte 1 = Startdat\n\n'Datum von bis C2\n'dat B3, E3, H3, K3, N3, Q3, T3\n'MA zweifelhaft andere Farbe\n\n'On Error Resume Next\n\nIf Art = 1 Then  ' Objekt\n    recsetSQL1 = \"SELECT * FROM tbltmp_DP_Grund_2 ORDER BY ID\"\n    xlVorlage = Get_Priv_Property(\"prp_XL_DienstObjVorlage\")\n\n    'Spalte 2 = ObjOrt\n    'Spalte 3 = ObjOrt_Anzeige\n    \n    'Zwischen den Objekten DICKER Strich\n    'NV Objekte grau\n    'Unbesetzte Obj gelb\n\nElseIf Art = 2 Then  ' MA\n    recsetSQL1 = \"SELECT * FROM tbltmp_DP_MA_Grund_FI ORDER BY ID\"\n    xlVorlage = Get_Priv_Property(\"prp_XL_DienstMAVorlage\")\n    'Spalte 2 = MA_ID\n    'Spalte 3 = MAName\n\nEnd If\n\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\n\nSet wkb = xl.XL_Wkb_Add(xlVorlage)\nSleep 20\nDoEvents\n\nxl.XL_Visible bVisible\nxl.SelectSheet\n\niZl = 0\nIf ArrFill_DAO_OK1 Then\n\n'######## Header\n\n' Datumswerte setzen\n'dat B3, E3, H3, K3, N3, Q3, T3\n    dt = CDate(DAOARRAY1(1, 0))\n    j = 2\n    For i = 0 To 6\n        Set rg = xl.SetRange(3, j, 3, j)\n        rg(1, 1) = Format(dt + i, \"ddd. dd.mm.yy\", 2, 2)\n        j = j + 3\n    Next i\n    'Datum von bis C2\n    Set rg = xl.SetRange(2, 2, 2, 2)\n    rg(1, 1) = Format(dt, \"dd.mm.\", 2, 2) & \" - \" & Format(dt + 6, \"dd.mm.yy\", 2, 2)\n    \n'####### Pro Zeile\n    \n    For iZl = 0 To iZLMax1\n        iXl = iZl + 4\n        Set rg = xl.SetRange(iXl, 1, iXl, 1)\n        rg(1, 1) = CStr(DAOARRAY1(3, iZl))\n\n        'Testen ob neues Objekt beginnt - iUdl = 1 wenn ja\n        If iZl < iZLMax1 Then\n            If CStr(DAOARRAY1(2, iZl)) <> CStr(DAOARRAY1(2, iZl + 1)) Then\n                iUdl = 1\n            Else\n                iUdl = 0\n            End If\n        Else\n            iUdl = 1\n        End If\n        \n        ' j = Startpunkt in Tabelle Feld Name ( Erster Wert 0)\n        ' k = Startpunkt in XL Feld Name ( Erster Wert 1)\n        j = 7\n        k = 2\n        For i = 1 To 7\n            'Namen von und bis setzen\n            Set rg = xl.SetRange(iXl, k, iXl, k)\n            rg(1, 1) = CStr(Nz(DAOARRAY1(j, iZl)))\n            Set rg = xl.SetRange(iXl, k + 1, iXl, k + 1)\n            rg(1, 1) = CStr(Nz(DAOARRAY1(j + 2, iZl)))\n            Set rg = xl.SetRange(iXl, k + 2, iXl, k + 2)\n            rg(1, 1) = CStr(Nz(DAOARRAY1(j + 3, iZl)))\n            \n            ' Wenn MA fraglich, orange markieren\n            bFrag = DAOARRAY1(j + 1, iZl)\n            If bFrag Then\n                Set rg = xl.SetRange(iXl, k, iXl, k)\n                    \n                With rg.Interior\n                    .Pattern = 1\n                    .PatternColorIndex = -4105\n            '        .Color = 65535  ' Gelb\n '                   .Color = 49407  ' Orange\n                    .color = 16766999 ' Türkisblau\n                    .TintAndShade = 0\n                    .PatternTintAndShade = 0\n                End With\n                \n            End If\n            \n            If Art = 1 Then  ' Nur bei Objekt - Nicht bei MA\n                'Fehlende MA gelb markieren\n                If CLng(Nz(DAOARRAY1(j - 2, iZl), 0)) > 0 And CLng(Nz(DAOARRAY1(j - 1, iZl), 0)) = 0 Then\n                    Set rg = xl.SetRange(iXl, k, iXl, k)\n                \n                    With rg.Interior\n                        .Pattern = 1\n                        .PatternColorIndex = -4105\n                        .color = 10092543  ' Hellgelb\n                '        .Color = 49407  ' Orange\n                        .TintAndShade = 0\n                        .PatternTintAndShade = 0\n                    End With\n            \n                End If\n                \n                'Undef grau markieren\n                If CLng(Nz(DAOARRAY1(j - 2, iZl), 0)) = 0 And CLng(Nz(DAOARRAY1(j - 1, iZl), 0)) = 0 Then\n                    If IsNull(DAOARRAY1(j - 2, iZl)) Then\n                        Set rg = xl.SetRange(iXl, k, iXl, k + 2)\n                \n                        With rg.Interior\n                             .Pattern = 1          ' = 1\n                             .PatternColorIndex = -4105   ' = -4105\n                             .ThemeColor = 1    ' = 1\n                             .TintAndShade = -0.14996795556505\n                             .PatternTintAndShade = 0\n                         End With\n            \n'                    ElseIf DAOARRAY1(j - 2, iZl) = 0 Then\n                    End If\n            \n                End If\n               \n                ' Begremzumgslinie Objekt\n                If iUdl = 1 Then\n                    Set rg = xl.SetRange(iXl, 1, iXl, 22)\n                    With rg.Borders(9)  ' = 9\n                       .LineStyle = 1  ' = 1\n                       .ColorIndex = 0\n                       .TintAndShade = 0\n                       .Weight = 4  ' = 4\n                    End With\n                End If\n        \n            End If\n            j = j + 6\n            k = k + 3\n        Next i\n    \n    Next iZl\n    ' Begremzumgslinie Objekt am Ende\n    Set rg = xl.SetRange(iZLMax1 + 4, 1, iZLMax1 + 4, 22)\n    With rg.Borders(9)  ' = 9\n       .LineStyle = 1  ' = 1\n       .ColorIndex = 0\n       .TintAndShade = 0\n       .Weight = 4  ' = 4\n    End With\n    \n    'Nach letzter Reihe alles löschen\n    Set rg = xl.SetRangeToLastRow(iZLMax1 + 5)\n    rg.Delete\n\n    Set DAOARRAY1 = Nothing\n\n    xl.XL_Visible True\n\nEnd If\n\nEnd Function\n\nFunction fxltstEz()\n'Call FCreate_Dienstplan_MA_Einzel_Excel(152, #11/16/2015#)\nCall FCreate_Dienstplan_MA_Einzel_Excel(152, #11/23/2015#)\nEnd Function\n\n\nFunction FCreate_Dienstplan_MA_Einzel_Excel(iMA_ID As Long, ByVal startdt As Date)\n' 1 = Objekt - tbltmp_DP_Grund\n' 2 = MA    - tbltmp_DP_MA_Grund\n\nDim strVgl As String\n\nDim wkb As Object\nDim sht As Object\n\nDim iUdl As Long\nDim i As Long\nDim j As Long\nDim k As Long\nDim dt As Date\nDim iXl As Long\nDim bFrag As Boolean\n\nDim iAnzMA As Long\nDim iAnzZeiten As Long\nDim iAnzPg As Long\nDim iAnzZl As Long\nDim xlVorlage As String\nDim iZeile As Long\nDim iSpalte As Long\nDim imaxzwi As Long\n\nDim strCol As String\nDim strColName As String\n\nDim datvgl As Date\nDim enddt As Date\nDim iKW As Long\n\nDim SheetnameArr() As String\n\nDim rg\nDim iLst As Long\nDim iZlLst As Long\nDim iwkday As Long\nDim ixlCol As Long\nDim xlrow As Long\nDim ixlrowstart As Long\n\niwkday = Weekday(startdt, 2)\nstartdt = startdt - iwkday + 1\nenddt = startdt + 6\niKW = TLookup(\"KW_D\", \"_tblAlleTage\", \"dtDatum = \" & SQLDatum(startdt))\n\nDim ArrFill_DAO_OK1 As Boolean, recsetSQL1 As String, iZLMax1 As Long, iColMax1 As Long, DAOARRAY1, DAOARRAY_Name1, iZl As Long, iCol As Long\n'Dim ArrFill_DAO_OK2 As Boolean, recsetSQL2 As String, iZLMax2 As Long, iColMax2 As Long, DAOARRAY2, iZl2 As Long, iCol2 As Long\n\n\n'    C2 Name\n'    E2  KW nn\n'    F2  12.11.2015 - 19.11.2015\n'\n'    B bis H Wochentage Mo bis So\n'\n'    B3  Mo.12.10.\n'\n'    Wiederholen so oft Aufträge pro Tag\n'\n'    B4 Auftrag\n'    B5 Ort\n'    B6 Location\n'    B7  Gesamtanz MA pro Schicht\n'    B8 Dienstbeginn\n'    B9 Ende\n'    B10 Treffp Zeit\n'    B11 Treffp.Ort\n'    B12 Dienstkleidung\n'    B13 - leer - Fahrer zum Einsatzort  (default selbst)\n'    B14 - leer - Position am Einsatzort\n'    B15 -leer - Aufgabenbeschreibung\n'    B16 Auftraggeber\n'    B17 Ansprechpartner\n'    B18 - leer Zusatzinformation\n'\n'    B19 leer\n'\n'    B20 - 34 Auftrag 2 ...\n'\n'    B35 leer\n'\n'    B36 - 50 Auftrag 3\n\n\n'On Error Resume Next\n\n    recsetSQL1 = \"SELECT * FROM qry_MA_VA_EinzelExcel_Alle WHERE MA_ID = \" & iMA_ID & \" AND VADatum BETWEEN \" & SQLDatum(startdt) & \" AND \" & SQLDatum(enddt) & \" ORDER BY MA_ID, VADatum, MA_Start\"\n    xlVorlage = Get_Priv_Property(\"prp_XL_DienstMAVorlage_Einzel\")\n\n    'Spalte 2 = ObjOrt\n    'Spalte 3 = ObjOrt_Anzeige\n    \n    'Zwischen den Objekten DICKER Strich\n    'NV Objekte grau\n    'Unbesetzte Obj gelb\n\nArrFill_DAO_OK1 = ArrFill_DAO_Acc(recsetSQL1, iZLMax1, iColMax1, DAOARRAY1)\n'Info:   'AccessArray(iSpalte,iZeile) <0, 0>\nIf ArrFill_DAO_OK1 Then\n\n    Set wkb = xl.XL_Wkb_Add(xlVorlage)\n    Sleep 20\n    DoEvents\n    \n    xl.XL_Visible True\n    xl.SelectSheet\n    \n    iZl = 0\n    \n'  qry_MA_VA_EinzelExcel_Alle\n\n'######## Header\n\n'    C2 Name\n'    E2  KW nn\n'    F2  12.11. - 19.11.2015\n'\n'    B bis H Wochentage Mo bis So\n\n' Datumswerte setzen\n'dat B3 bis H3\n\n'Woche\n    Set rg = xl.SetRange(2, 5, 2, 5)  ' Row Column\n    rg(1, 1) = \" KW \" & iKW\n    \n'Zeitraum\n    Set rg = xl.SetRange(2, 6, 2, 6)  ' Row Column\n    rg(1, 1) = Format(startdt, \"dd.mm.\", 2, 2) & \" - \" & Format(enddt, \"dd.mm.yy\", 2, 2)\n    \n 'Wochentage\n    dt = startdt\n    j = 2\n    For i = 0 To 6\n        Set rg = xl.SetRange(3, 2 + i, 3, 2 + i)  ' Row Column\n        rg(1, 1) = Format(dt + i, \"ddd. dd.mm.\", 2, 2)\n        j = j + 1\n    Next i\n    \n'####### Pro Zeile\n    \n'qry_MA_VA_EinzelExcel_Alle\n'Field Name\n'==========\n' 0            VA_ID          4            Long Integer\n' 1            VADatum_ID     4            Long Integer\n' 2            VAStart_ID     4            Long Integer\n' 3            MA_ID          4            Long Integer\n' 4            VADatum        8            Date/Time\n' 5            MA_Start       8            Date/Time\n' 6            MA_Ende        8            Date/Time\n' 7            MA_Anzahl      4            Long Integer\n' 8            IstSubunternehmer            1            Yes/No\n' 9            Name           10           Text\n' 10           Auftrag        10           Text\n' 11           Ort            10           Text\n' 12           Objekt         10           Text\n' 13           VA_Treffpunkt  10           Text\n' 14           Treffpunkt     10           Text\n' 15           VA_Zeitpunkt   8            Date/Time\n' 16           Treffp_Zeit    8            Date/Time\n' 17           Dienstkleidung               10           Text\n' 18           kun_Firma      10           Text\n' 19           Ansprechpartner              10           Text\n'==========\n\n'    B4 Auftrag\n'    B5 Ort\n'    B6 Location\n'    B7  Gesamtanz MA pro Schicht\n'    B8 Dienstbeginn\n'    B9 Ende\n'    B10 Treffp Zeit\n'    B11 Treffp.Ort\n'    B12 Dienstkleidung\n'    B13 - leer - Fahrer zum Einsatzort  (default selbst)\n'    B14 - leer - Position am Einsatzort\n'    B15 -leer - Aufgabenbeschreibung\n'    B16 Auftraggeber\n'    B17 Ansprechpartner\n'    B18 - leer Zusatzinformation\n\n    datvgl = DateSerial(1990, 1, 1)\n'    datvgl = CDate(DAOARRAY1(4, iZl))\n'Name C2\n    Set rg = xl.SetRange(2, 3, 2, 3)  ' Row Column\n    rg(1, 1) = CStr(DAOARRAY1(9, iZl))\n\n    ixlrowstart = 4\n    k = ixlrowstart\n    \n    For iZl = 0 To iZLMax1\n        \n        iwkday = Weekday(CDate(DAOARRAY1(4, iZl)), 2)\n\n        ixlCol = 1 + iwkday\n\n        If CDate(DAOARRAY1(4, iZl)) = datvgl Then\n            ixlrowstart = ixlrowstart + 16\n            If k < ixlrowstart Then k = ixlrowstart\n        Else\n            ixlrowstart = 4\n            datvgl = CDate(DAOARRAY1(4, iZl))\n        End If\n\n'    B4 Auftrag - 10\n        xlrow = ixlrowstart\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = CStr(Nz(DAOARRAY1(10, iZl)))\n\n'    B5 Ort - 11\n        xlrow = ixlrowstart + 1\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = CStr(Nz(DAOARRAY1(11, iZl)))\n\n'    B6 Location - 12\n        xlrow = ixlrowstart + 2\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = CStr(Nz(DAOARRAY1(12, iZl)))\n\n'    B7  Gesamtanz MA pro Schicht - 7\n        xlrow = ixlrowstart + 3\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = CLng(Nz(DAOARRAY1(7, iZl), 0))\n\n'    B8 Dienstbeginn - 5\n        xlrow = ixlrowstart + 4\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = Format(CDate(DAOARRAY1(5, iZl)), \"hh:nn\") & \" h\"\n\n'    B9 Ende - 6\n        xlrow = ixlrowstart + 5\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        If Len(Trim(Nz(DAOARRAY1(6, iZl)))) > 0 Then\n            rg(1, 1) = Format(CDate(DAOARRAY1(6, iZl)), \"hh:nn\") & \" h\"\n        End If\n\n'    B10 Treffp Zeit  15 + 16 - Sonderlocke\n        xlrow = ixlrowstart + 6\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        If Len(Trim(Nz(DAOARRAY1(15, iZl)))) = 0 Then\n            If Len(Trim(Nz(DAOARRAY1(16, iZl)))) > 0 Then\n                rg(1, 1) = Format(CDate(DAOARRAY1(16, iZl)), \"hh:nn\") & \" h\"\n            End If\n        Else\n            rg(1, 1) = Format(CDate(DAOARRAY1(15, iZl)), \"hh:nn\") & \" h\"\n        End If\n\n'    B11 Treffp.Ort  13 + 14 - Sonderlocke\n        xlrow = ixlrowstart + 7\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        If Len(Trim(Nz(DAOARRAY1(13, iZl)))) = 0 Then\n            rg(1, 1) = CStr(Nz(DAOARRAY1(14, iZl)))\n        Else\n            rg(1, 1) = CStr(Nz(DAOARRAY1(13, iZl)))\n        End If\n        \n'    B12 Dienstkleidung - 17\n        xlrow = ixlrowstart + 8\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = CStr(Nz(DAOARRAY1(17, iZl)))\n\n'    B13 - leer - Fahrer zum Einsatzort  (default selbst)\n'    B14 - leer - Position am Einsatzort\n'    B15 -leer - Aufgabenbeschreibung\n'    B16 Auftraggeber - 18\n        xlrow = ixlrowstart + 10\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = CStr(Nz(DAOARRAY1(18, iZl)))\n\n'    B17 Ansprechpartner - 19\n        xlrow = ixlrowstart + 11\n        Set rg = xl.SetRange(xlrow, ixlCol, xlrow, ixlCol)  ' Row Column\n        rg(1, 1) = CStr(Nz(DAOARRAY1(19, iZl)))\n\n'    B18 - leer Zusatzinformation\n\n    Next iZl\n\n'Ende löschen\n    j = k + 12\n    Set rg = xl.SetRangeToLastRow(j)\n    rg.Delete\n'\n    Set DAOARRAY1 = Nothing\n'\nElse\n    MsgBox \"Keine Schichten für diese Woche vorhanden\"\nEnd If\n\nEnd Function"}
