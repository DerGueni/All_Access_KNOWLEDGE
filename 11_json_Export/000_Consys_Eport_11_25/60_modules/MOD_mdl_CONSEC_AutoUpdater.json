{"id":"MOD_mdl_CONSEC_AutoUpdater","name":"mdl_CONSEC_AutoUpdater","kind":"standard","procedures":["Public Sub AutoUpdate()","Public Sub UpdateModuleCode(moduleName As String, newCode As String)","Public Sub UpdateSingleFunction(moduleName As String, functionName As String, newFunctionCode As String)","Public Sub HotReload()","Public Function GenerateFixCode(errorDescription As String) As String","Private Function GenerateSyntaxFix() As String","Private Function GenerateVariableFix(errorDesc As String) As String","Private Function GenerateObjectFix() As String","Public Sub StartFileWatcher()","Public Sub StopFileWatcher()","Private Sub WatcherLoop()","Public Sub CheckForUpdates()","Private Sub ApplyCodeUpdate(filePath As String)","Private Function FindFunctionStart(codeModule As Object, functionName As String) As Long","Private Function FindFunctionEnd(codeModule As Object, startLine As Long) As Long","Private Function ExtractModuleName(content As String) As String","Private Function ExtractModuleCode(content As String) As String","Private Function ExtractValue(content As String, key As String) As String","Private Function ExtractFunctionCode(content As String) As String","Private Function SafeRefName(ByVal ref As Access.Reference) As String","Private Sub CreateSampleUpdateFile()","Public Sub QuickFix(moduleName As String, lineNumber As Long)","Public Sub DevConsole()","Public Sub InstallAutoUpdater()"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"' CONSEC AUTO-UPDATER\n' ================================================\n' Automatisches Update von VBA-Code ohne Import/Export\n' Selbst-modifizierender Code für schnelle Entwicklung\n' ================================================\n\nOption Compare Database\nOption Explicit\n\n' ===== Sleep für Watcher (32/64-Bit) =====\n#If VBA7 Then\n    Private Declare PtrSafe Sub Sleep Lib \"kernel32\" (ByVal dwMilliseconds As LongPtr)\n#Else\n    Private Declare Sub Sleep Lib \"kernel32\" (ByVal dwMilliseconds As Long)\n#End If\n\nPrivate mWatching As Boolean   ' Steuerung für File-Watcher\n\n' ========================================\n' AUTO-UPDATE HAUPTFUNKTION\n' ========================================\n\nPublic Sub AutoUpdate()\n    Debug.Print \"=== CONSEC AUTO-UPDATE ===\"\n    Debug.Print \"Start: \" & Now()\n\n    Dim updatePath As String\n    updatePath = CurrentProject.path & \"\\CONSEC_UPDATE.txt\"\n\n    If Dir(updatePath) <> \"\" Then\n        Debug.Print \"Update-Datei gefunden!\"\n        ApplyCodeUpdate updatePath\n    Else\n        Debug.Print \"Keine Update-Datei gefunden.\"\n        Debug.Print \"Erstelle Beispiel-Update-Datei...\"\n        CreateSampleUpdateFile\n    End If\nEnd Sub\n\n' ========================================\n' SELBST-MODIFIZIERENDER CODE-UPDATER\n' ========================================\n\nPublic Sub UpdateModuleCode(moduleName As String, newCode As String)\n    ' ACHTUNG: Diese Funktion modifiziert VBA-Code zur Laufzeit!\n    Dim vbProj As Object\n    Dim vbcomp As Object\n    Dim codeModule As Object\n\n    Set vbProj = Application.VBE.ActiveVBProject\n\n    For Each vbcomp In vbProj.VBComponents\n        If vbcomp.Name = moduleName Then\n            Set codeModule = vbcomp.codeModule\n\n            If codeModule.CountOfLines > 0 Then\n                codeModule.DeleteLines 1, codeModule.CountOfLines\n            End If\n\n            codeModule.AddFromString newCode\n            Debug.Print \"? Modul \" & moduleName & \" aktualisiert!\"\n            Exit Sub\n        End If\n    Next\n\n    Set vbcomp = vbProj.VBComponents.Add(1) ' 1 = vbext_ct_StdModule\n    vbcomp.Name = moduleName\n    vbcomp.codeModule.AddFromString newCode\n    Debug.Print \"? Neues Modul \" & moduleName & \" erstellt!\"\nEnd Sub\n\n' ========================================\n' DYNAMISCHER FUNKTIONS-UPDATER\n' ========================================\n\nPublic Sub UpdateSingleFunction(moduleName As String, functionName As String, newFunctionCode As String)\n    Dim vbProj As Object\n    Dim vbcomp As Object\n    Dim codeModule As Object\n    Dim startLine As Long\n    Dim endLine As Long\n\n    Set vbProj = Application.VBE.ActiveVBProject\n\n    For Each vbcomp In vbProj.VBComponents\n        If vbcomp.Name = moduleName Then\n            Set codeModule = vbcomp.codeModule\n\n            startLine = FindFunctionStart(codeModule, functionName)\n            If startLine > 0 Then\n                endLine = FindFunctionEnd(codeModule, startLine)\n                codeModule.DeleteLines startLine, endLine - startLine + 1\n                codeModule.InsertLines startLine, newFunctionCode\n                Debug.Print \"? Funktion \" & functionName & \" aktualisiert!\"\n            Else\n                codeModule.InsertLines codeModule.CountOfLines + 1, vbCrLf & newFunctionCode\n                Debug.Print \"? Funktion \" & functionName & \" hinzugefügt!\"\n            End If\n            Exit Sub\n        End If\n    Next\n\n    Debug.Print \"? Modul \" & moduleName & \" nicht gefunden!\"\nEnd Sub\n\n' ========================================\n' HOT-RELOAD SYSTEM\n' ========================================\nPublic Sub HotReload()\n    On Error GoTo EH\n    Debug.Print \"? HOT-RELOAD...\"\n\n    ' Kompiliere alle Module\n    DoCmd.RunCommand acCmdCompileAndSaveAllModules\n\n    ' --- References prüfen/aufräumen ---\n    Dim ref As Access.Reference\n    Dim removed As Long\n    On Error Resume Next\n    For Each ref In Access.Application.References\n        If ref.IsBroken Then\n            Debug.Print \"• Entferne defekten Verweis: \" & SafeRefName(ref)\n            Access.Application.References.Remove ref\n            removed = removed + 1\n        End If\n    Next ref\n    On Error GoTo 0\n    If removed = 0 Then\n        Debug.Print \"• Keine defekten Verweise gefunden.\"\n    Else\n        Debug.Print \"• \" & removed & \" defekte(r) Verweis(e) entfernt.\"\n    End If\n    ' (Kein References.Refresh in Access vorhanden)\n\n    Debug.Print \"? Hot-Reload abgeschlossen!\"\n    Exit Sub\nEH:\n    Debug.Print \"? Hot-Reload-Fehler: \" & err.Number & \" - \" & err.description\n    err.clear\nEnd Sub\n\n' ========================================\n' CODE-GENERATOR FÜR FIXES\n' ========================================\n\nPublic Function GenerateFixCode(errorDescription As String) As String\n    Dim fixCode As String\n\n    Select Case True\n        Case InStr(errorDescription, \"Syntaxfehler\") > 0\n            fixCode = GenerateSyntaxFix()\n\n        Case InStr(errorDescription, \"Variable nicht definiert\") > 0\n            fixCode = GenerateVariableFix(errorDescription)\n\n        Case InStr(errorDescription, \"Objekt erforderlich\") > 0\n            fixCode = GenerateObjectFix()\n\n        Case Else\n            fixCode = \"' Fix für: \" & errorDescription & vbCrLf & _\n                      \"' TODO: Manueller Fix erforderlich\"\n    End Select\n\n    GenerateFixCode = fixCode\nEnd Function\n\nPrivate Function GenerateSyntaxFix() As String\n    GenerateSyntaxFix = \"' Syntax-Fix\" & vbCrLf & _\n                        \"' Prüfe Zeilenfortsetzungen (_)\" & vbCrLf & _\n                        \"' Prüfe Anführungszeichen\" & vbCrLf & _\n                        \"' Prüfe Klammern\"\nEnd Function\n\nPrivate Function GenerateVariableFix(errorDesc As String) As String\n    Dim varName As String\n    varName = \"unbekannt\" ' Hier könnte Parsing erfolgen\n    GenerateVariableFix = \"Dim \" & varName & \" As Variant\"\nEnd Function\n\nPrivate Function GenerateObjectFix() As String\n    GenerateObjectFix = \"Set obj = CreateObject(\"\"ClassName\"\")\"\nEnd Function\n\n' ========================================\n' FILE-WATCHER FÜR AUTO-UPDATE (Access-kompatibel)\n' ========================================\n\nPublic Sub StartFileWatcher()\n    If mWatching Then\n        Debug.Print \"File-Watcher läuft bereits.\"\n        Exit Sub\n    End If\n\n    mWatching = True\n    Debug.Print \"??? File-Watcher gestartet...\"\n    WatcherLoop\nEnd Sub\n\nPublic Sub StopFileWatcher()\n    mWatching = False\n    Debug.Print \"File-Watcher gestoppt.\"\nEnd Sub\n\nPrivate Sub WatcherLoop()\n    Do While mWatching\n        CheckForUpdates\n        DoEvents\n        Sleep 10000          ' 10 Sekunden\n        DoEvents\n    Loop\nEnd Sub\n\nPublic Sub CheckForUpdates()\n    Static lastModified As Date\n    Dim updatePath As String\n    Dim currentModified As Date\n\n    updatePath = CurrentProject.path & \"\\CONSEC_UPDATE.txt\"\n\n    If Dir(updatePath) <> \"\" Then\n        currentModified = FileDateTime(updatePath)\n        If currentModified > lastModified Then\n            Debug.Print \"?? Update erkannt!\"\n            ApplyCodeUpdate updatePath\n            lastModified = currentModified\n        End If\n    End If\nEnd Sub\n\n' ========================================\n' UPDATE VON DATEI ANWENDEN\n' ========================================\n\nPrivate Sub ApplyCodeUpdate(filePath As String)\n    Dim fileNum As Integer\n    Dim fileContent As String\n    Dim lineText As String\n\n    fileNum = FreeFile\n    Open filePath For Input As #fileNum\n    fileContent = \"\"\n    Do While Not EOF(fileNum)\n        Line Input #fileNum, lineText\n        fileContent = fileContent & lineText & vbCrLf\n    Loop\n    Close #fileNum\n\n    If InStr(fileContent, \"[MODULE]\") > 0 Then\n        Dim moduleName As String\n        Dim moduleCode As String\n        moduleName = ExtractModuleName(fileContent)\n        moduleCode = ExtractModuleCode(fileContent)\n        UpdateModuleCode moduleName, moduleCode\n\n    ElseIf InStr(fileContent, \"[FUNCTION]\") > 0 Then\n        Dim funcModule As String\n        Dim funcName As String\n        Dim funcCode As String\n        funcModule = ExtractValue(fileContent, \"MODULE:\")\n        funcName = ExtractValue(fileContent, \"FUNCTION:\")\n        funcCode = ExtractFunctionCode(fileContent)\n        UpdateSingleFunction funcModule, funcName, funcCode\n    End If\n\n    HotReload\nEnd Sub\n\n' ========================================\n' HILFSFUNKTIONEN\n' ========================================\n\nPrivate Function FindFunctionStart(codeModule As Object, functionName As String) As Long\n    Dim i As Long, lineText As String\n    For i = 1 To codeModule.CountOfLines\n        lineText = codeModule.lines(i, 1)\n        If InStr(1, lineText, \"Function \" & functionName, vbTextCompare) > 0 Or _\n           InStr(1, lineText, \"Sub \" & functionName, vbTextCompare) > 0 Then\n            FindFunctionStart = i\n            Exit Function\n        End If\n    Next i\n    FindFunctionStart = 0\nEnd Function\n\nPrivate Function FindFunctionEnd(codeModule As Object, startLine As Long) As Long\n    Dim i As Long, lineText As String\n    For i = startLine + 1 To codeModule.CountOfLines\n        lineText = codeModule.lines(i, 1)\n        If InStr(1, lineText, \"End Function\", vbTextCompare) > 0 Or _\n           InStr(1, lineText, \"End Sub\", vbTextCompare) > 0 Then\n            FindFunctionEnd = i\n            Exit Function\n        End If\n    Next i\n    FindFunctionEnd = codeModule.CountOfLines\nEnd Function\n\nPrivate Function ExtractModuleName(content As String) As String\n    Dim startPos As Long, endPos As Long\n    startPos = InStr(content, \"[MODULE]\") + 8\n    endPos = InStr(startPos, content, vbCrLf)\n    If startPos > 8 And endPos > startPos Then\n        ExtractModuleName = Trim(Mid$(content, startPos, endPos - startPos))\n    Else\n        ExtractModuleName = \"mdl_Updated\"\n    End If\nEnd Function\n\nPrivate Function ExtractModuleCode(content As String) As String\n    Dim startPos As Long\n    startPos = InStr(content, \"[CODE]\") + 6\n    If startPos > 6 Then\n        ExtractModuleCode = Mid$(content, startPos)\n    Else\n        ExtractModuleCode = content\n    End If\nEnd Function\n\nPrivate Function ExtractValue(content As String, key As String) As String\n    Dim startPos As Long, endPos As Long\n    startPos = InStr(content, key) + Len(key)\n    endPos = InStr(startPos, content, vbCrLf)\n    If startPos > Len(key) And endPos > startPos Then\n        ExtractValue = Trim(Mid$(content, startPos, endPos - startPos))\n    Else\n        ExtractValue = \"\"\n    End If\nEnd Function\n\nPrivate Function ExtractFunctionCode(content As String) As String\n    Dim startPos As Long\n    startPos = InStr(content, \"[CODE]\") + 6\n    If startPos > 6 Then\n        ExtractFunctionCode = Mid$(content, startPos)\n    Else\n        ExtractFunctionCode = \"\"\n    End If\nEnd Function\n\nPrivate Function SafeRefName(ByVal ref As Access.Reference) As String\n    On Error Resume Next\n    SafeRefName = ref.Name\n    If err.Number <> 0 Or Len(SafeRefName) = 0 Then\n        SafeRefName = \"(unbekannt)\"\n        err.clear\n    End If\n    On Error GoTo 0\nEnd Function\n\n' ========================================\n' TEST-UPDATE ERSTELLEN\n' ========================================\n\nPrivate Sub CreateSampleUpdateFile()\n    Dim filePath As String\n    Dim fileNum As Integer\n    Dim sampleContent As String\n\n    filePath = CurrentProject.path & \"\\CONSEC_UPDATE.txt\"\n\n    sampleContent = \"[FUNCTION]\" & vbCrLf & _\n                    \"MODULE:mdl_CONSEC_AI_DEBUG\" & vbCrLf & _\n                    \"FUNCTION:TestUpdate\" & vbCrLf & _\n                    \"[CODE]\" & vbCrLf & _\n                    \"Public Function TestUpdate() As String\" & vbCrLf & _\n                    \"    TestUpdate = \"\"Update wurde angewendet: \"\" & Now()\" & vbCrLf & _\n                    \"    Debug.Print TestUpdate\" & vbCrLf & _\n                    \"End Function\"\n\n    fileNum = FreeFile\n    Open filePath For Output As #fileNum\n    Print #fileNum, sampleContent\n    Close #fileNum\n\n    Debug.Print \"? Beispiel-Update-Datei erstellt: \" & filePath\n    MsgBox \"Update-Datei erstellt!\" & vbCrLf & vbCrLf & _\n           \"Bearbeiten Sie: \" & filePath & vbCrLf & _\n           \"Dann rufen Sie AutoUpdate auf\", vbInformation\nEnd Sub\n\n' ========================================\n' QUICK-FIX FUNKTIONEN\n' ========================================\n\nPublic Sub QuickFix(moduleName As String, lineNumber As Long)\n    Dim vbProj As Object\n    Dim vbcomp As Object\n    Dim codeModule As Object\n    Dim errorLine As String\n\n    Set vbProj = Application.VBE.ActiveVBProject\n\n    For Each vbcomp In vbProj.VBComponents\n        If vbcomp.Name = moduleName Then\n            Set codeModule = vbcomp.codeModule\n            errorLine = codeModule.lines(lineNumber, 1)\n\n            Debug.Print \"Fehlerhafte Zeile: \" & errorLine\n\n            If InStr(errorLine, \" & _\") > 0 And Len(Trim$(codeModule.lines(lineNumber + 1, 1))) = 0 Then\n                codeModule.ReplaceLine lineNumber, Replace$(errorLine, \" & _\", \"\")\n                Debug.Print \"? Fixed: Überflüssigen Fortsetzungs-Operator entfernt\"\n            ElseIf InStr(errorLine, \"\"\"\") = 0 And InStr(errorLine, \"=\") > 0 Then\n                Debug.Print \"?? Mögliches Problem mit Anführungszeichen\"\n            End If\n            Exit Sub\n        End If\n    Next\nEnd Sub\n\n' ========================================\n' ENTWICKLER-KONSOLE\n' ========================================\n\nPublic Sub DevConsole()\n    Dim cmd As String\n    Do\n        cmd = InputBox(\"Dev-Konsole (help für Hilfe, exit zum Beenden):\", \"CONSEC Dev Console\", \"help\")\n        Select Case LCase$(cmd)\n            Case \"help\"\n                MsgBox \"Befehle:\" & vbCrLf & _\n                       \"update - Code-Update anwenden\" & vbCrLf & _\n                       \"reload - Hot-Reload\" & vbCrLf & _\n                       \"watch - File-Watcher starten\" & vbCrLf & _\n                       \"stop - File-Watcher stoppen\" & vbCrLf & _\n                       \"test - Test ausführen\" & vbCrLf & _\n                       \"exit - Beenden\", vbInformation\n\n            Case \"update\": AutoUpdate\n            Case \"reload\": HotReload\n            Case \"watch\":  StartFileWatcher\n            Case \"stop\":   StopFileWatcher\n            Case \"test\":   Debug.Print \"Test: \" & Now()\n            Case \"exit\", \"\": Exit Do\n            Case Else: Debug.Print \"Unbekannter Befehl: \" & cmd\n        End Select\n    Loop\n    Debug.Print \"Dev-Konsole beendet\"\nEnd Sub\n\n' ========================================\n' INSTALLATION\n' ========================================\n\nPublic Sub InstallAutoUpdater()\n    MsgBox \"CONSEC Auto-Updater installiert!\" & vbCrLf & vbCrLf & _\n           \"Verwendung:\" & vbCrLf & _\n           \"1. AutoUpdate - Update von Datei\" & vbCrLf & _\n           \"2. StartFileWatcher/StopFileWatcher - Auto-Überwachung\" & vbCrLf & _\n           \"3. DevConsole - Entwickler-Konsole\" & vbCrLf & vbCrLf & _\n           \"WICHTIG: In den Einstellungen 'Zugriff auf das VBA-Projekt vertrauen' aktivieren!\", vbInformation\n    CreateSampleUpdateFile\nEnd Sub\n\n"}
