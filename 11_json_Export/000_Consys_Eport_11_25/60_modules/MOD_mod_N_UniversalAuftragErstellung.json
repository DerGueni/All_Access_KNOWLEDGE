{"id":"MOD_mod_N_UniversalAuftragErstellung","name":"mod_N_UniversalAuftragErstellung","kind":"standard","procedures":["Private Function DatumFuerSQL(ByVal Datum As Date) As String","Public Function AuftragErstellen( _","Private Sub GarantiereOrtFeld(ByVal AuftragsID As Long, ByVal sollOrt As String)","Private Sub AktiviereAuftragBooleanFelder(ByVal AuftragsID As Long)","Private Sub ErstelleSchichten( _","Private Function GetKundenID(ByVal kundenName As String) As Long","Private Function SQLSafe(ByVal Text As String) As String","Public Function ValidiereAuftrag(ByVal AuftragsID As Long) As String","Public Function KorrigiereAuftragBooleans(ByVal AuftragsID As Long) As String","Public Function KorrigiereLetztenAuftrag() As String"],"calls":{"DoCmd.OpenForm":[],"DoCmd.OpenReport":[],"DoCmd.RunSQL":[],"CurrentDb.Execute":[],"DLookup":[],"DCount":[],"DMax":[],"DMin":[]},"source":"Option Compare Database\nOption Explicit\n\n' ================================================================================================\n' MODUL: mod_N_UniversalAuftragErstellung\n' ZWECK: Universelle Auftragserstellung für Consys mit externem Zugriff\n' VERSION: 3.1 - DATUMSFORMAT KORRIGIERT\n' ================================================================================================\n' ÄNDERUNGEN V3.1:\n' - KRITISCHER FIX: Datumsformat für SQL korrigiert (mm/dd/yyyy)\n' - Garantiert Sichtbarkeit in qry_lst_Row_Auftrag\n' - Verbesserte tbl_VA_AnzTage Erstellung (TVA_Soll = 1)\n' ================================================================================================\n\n' ================================================================================================\n' HILFSFUNKTION: Konvertiert Datum für Access SQL (MM/DD/YYYY)\n' ================================================================================================\nPrivate Function DatumFuerSQL(ByVal Datum As Date) As String\n    DatumFuerSQL = Month(Datum) & \"/\" & Day(Datum) & \"/\" & year(Datum)\nEnd Function\n\n' ================================================================================================\n' HAUPTFUNKTION: Erstellt einen kompletten Auftrag mit allen Abhängigkeiten\n' ================================================================================================\nPublic Function AuftragErstellen( _\n    ByVal auftragsName As String, _\n    ByVal objektName As String, _\n    ByVal ortName As String, _\n    ByVal DatumVon As Date, _\n    Optional ByVal DatumBis As Date = 0, _\n    Optional ByVal auftraggeber As String = \"\", _\n    Optional ByVal Treffpunkt As String = \"\", _\n    Optional ByVal schichten As String = \"\", _\n    Optional ByVal statusID As Integer = 1, _\n    Optional ByVal Ersteller As String = \"\" _\n) As String\n\nOn Error GoTo ErrorHandler\n\n    ' PARAMETER-VALIDIERUNG\n    If Len(Trim(auftragsName)) = 0 Then\n        AuftragErstellen = \"FEHLER: Auftragsname ist erforderlich\"\n        Exit Function\n    End If\n    \n    If Len(Trim(objektName)) = 0 Then objektName = auftragsName\n    If Len(Trim(ortName)) = 0 Then ortName = \"N/A\"\n    If DatumBis = 0 Then DatumBis = DatumVon\n    If Len(Trim(Ersteller)) = 0 Then Ersteller = Environ(\"UserName\")\n    \n    If DatumVon > DatumBis Then\n        AuftragErstellen = \"FEHLER: DatumVon muss vor DatumBis liegen\"\n        Exit Function\n    End If\n    \n    Debug.Print String(60, \"-\")\n    Debug.Print \"? Erstelle Auftrag: \" & auftragsName\n    Debug.Print \"  Objekt: \" & objektName\n    Debug.Print \"  Ort: \" & ortName\n    Debug.Print \"  Datum: \" & Format(DatumVon, \"dd.mm.yyyy\") & \" bis \" & Format(DatumBis, \"dd.mm.yyyy\")\n    \n    ' SCHRITT 1: HAUPTAUFTRAG ERSTELLEN\n    Dim anzTage As Integer\n    anzTage = DateDiff(\"d\", DatumVon, DatumBis) + 1\n    \n    Dim sql As String\n    sql = \"INSERT INTO tbl_VA_Auftragstamm \" & _\n          \"(Auftrag, Objekt, Ort, Dat_VA_Von, Dat_VA_Bis, AnzTg, \" & _\n          \"Veranstalter_ID, Treffpunkt, Erst_von, Erst_am, Veranst_Status_ID) \" & _\n          \"VALUES (\" & _\n          \"'\" & SQLSafe(auftragsName) & \"', \" & _\n          \"'\" & SQLSafe(objektName) & \"', \" & _\n          \"'\" & SQLSafe(ortName) & \"', \" & _\n          \"#\" & DatumFuerSQL(DatumVon) & \"#, \" & _\n          \"#\" & DatumFuerSQL(DatumBis) & \"#, \" & _\n          anzTage & \", \"\n    \n    If Len(Trim(auftraggeber)) > 0 Then\n        Dim kundenID As Long\n        kundenID = GetKundenID(auftraggeber)\n        If kundenID > 0 Then\n            sql = sql & kundenID & \", \"\n        Else\n            sql = sql & \"NULL, \"\n        End If\n    Else\n        sql = sql & \"NULL, \"\n    End If\n    \n    sql = sql & \"'\" & SQLSafe(Treffpunkt) & \"', \" & _\n          \"'\" & Ersteller & \"', \" & _\n          \"Now(), \" & statusID & \")\"\n    \n    Debug.Print \"  ? Erstelle Auftragstamm-Eintrag...\"\n    CurrentDb.Execute sql, dbFailOnError\n    Debug.Print \"  ? Auftragstamm erstellt\"\n    \n    ' SCHRITT 2: AUFTRAG-ID ERMITTELN\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT MAX(ID) AS NewID FROM tbl_VA_Auftragstamm \" & _\n        \"WHERE Auftrag = '\" & SQLSafe(auftragsName) & \"' \" & _\n        \"AND Erst_von = '\" & Ersteller & \"'\")\n    \n    Dim AuftragsID As Long\n    If Not rs.EOF Then AuftragsID = Nz(rs.fields(\"NewID\").Value, 0)\n    rs.Close\n    \n    If AuftragsID = 0 Then\n        AuftragErstellen = \"FEHLER: Auftrag-ID nicht ermittelt\"\n        Exit Function\n    End If\n    \n    Debug.Print \"  ? Auftrag-ID ermittelt: \" & AuftragsID\n    \n    ' SCHRITT 2a: ORT-FELD VALIDIEREN\n    Call GarantiereOrtFeld(AuftragsID, ortName)\n    \n    ' SCHRITT 2b: BOOLEAN-FELDER AKTIVIEREN\n    Call AktiviereAuftragBooleanFelder(AuftragsID)\n    \n    ' SCHRITT 3: VERANSTALTUNGSTAGE ERSTELLEN\n    Debug.Print \"  ? Erstelle Veranstaltungstage (\" & anzTage & \" Tage)...\"\n    \n    Dim aktDatum As Date\n    Dim vaDatumIDs As Collection\n    Set vaDatumIDs = New Collection\n    Dim tagNr As Integer\n    \n    tagNr = 0\n    For aktDatum = DatumVon To DatumBis\n        tagNr = tagNr + 1\n        \n        sql = \"INSERT INTO tbl_VA_AnzTage (VA_ID, VADatum, TVA_Soll, TVA_Ist) \" & _\n              \"VALUES (\" & AuftragsID & \", \" & _\n              \"#\" & DatumFuerSQL(aktDatum) & \"#, 1, 0)\"\n        CurrentDb.Execute sql, dbFailOnError\n        \n        Set rs = CurrentDb.OpenRecordset( _\n            \"SELECT ID FROM tbl_VA_AnzTage \" & _\n            \"WHERE VA_ID = \" & AuftragsID & \" \" & _\n            \"AND VADatum = #\" & DatumFuerSQL(aktDatum) & \"#\")\n        \n        If Not rs.EOF Then\n            vaDatumIDs.Add rs.fields(\"ID\").Value, Format(aktDatum, \"yyyy-mm-dd\")\n            Debug.Print \"    Tag \" & tagNr & \": \" & Format(aktDatum, \"dd.mm.yyyy\") & \" (ID: \" & rs.fields(\"ID\").Value & \")\"\n        End If\n        rs.Close\n    Next aktDatum\n    \n    Debug.Print \"  ? \" & vaDatumIDs.Count & \" Veranstaltungstage erstellt\"\n    \n    ' SCHRITT 4: SCHICHTEN ERSTELLEN\n    If Len(Trim(schichten)) > 0 Then\n        Debug.Print \"  ? Erstelle Schichten: \" & schichten\n        Call ErstelleSchichten(AuftragsID, vaDatumIDs, schichten, DatumVon, Ersteller)\n        Debug.Print \"  ? Schichten erstellt\"\n    End If\n    \n    ' SCHRITT 5: VALIDIERUNG\n    Debug.Print \"  ? Finale Validierung...\"\n    Dim validierung As String\n    validierung = ValidiereAuftrag(AuftragsID)\n    Debug.Print \"  \" & validierung\n    \n    Debug.Print \"? Auftrag komplett erstellt (ID: \" & AuftragsID & \")\"\n    Debug.Print String(60, \"-\")\n    \n    AuftragErstellen = \"SUCCESS|\" & AuftragsID & \"|\" & auftragsName\n    Exit Function\n\nErrorHandler:\n    Debug.Print \"? FEHLER beim Erstellen: \" & err.Number & \" - \" & err.description\n    AuftragErstellen = \"FEHLER: \" & err.Number & \" - \" & err.description\nEnd Function\n\n' ================================================================================================\n' HILFSFUNKTIONEN\n' ================================================================================================\nPrivate Sub GarantiereOrtFeld(ByVal AuftragsID As Long, ByVal sollOrt As String)\nOn Error Resume Next\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT Ort, Objekt FROM tbl_VA_Auftragstamm WHERE ID = \" & AuftragsID, dbOpenDynaset)\n    \n    If Not rs.EOF Then\n        If Len(Trim(Nz(rs!Ort, \"\"))) = 0 Then\n            rs.Edit\n            If Len(Trim(sollOrt)) > 0 Then\n                rs!Ort = sollOrt\n            ElseIf Len(Trim(Nz(rs!Objekt, \"\"))) > 0 Then\n                rs!Ort = rs!Objekt\n            Else\n                rs!Ort = \"N/A\"\n            End If\n            rs.update\n        End If\n    End If\n    rs.Close\nEnd Sub\n\nPrivate Sub AktiviereAuftragBooleanFelder(ByVal AuftragsID As Long)\nOn Error Resume Next\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT * FROM tbl_VA_Auftragstamm WHERE ID = \" & AuftragsID, dbOpenDynaset)\n    \n    If Not rs.EOF Then\n        Dim i As Integer\n        Dim hatUpdate As Boolean\n        hatUpdate = False\n        \n        For i = 0 To rs.fields.Count - 1\n            If rs.fields(i).Type = dbBoolean Then\n                If Not hatUpdate Then\n                    rs.Edit\n                    hatUpdate = True\n                End If\n                rs.fields(i).Value = True\n            End If\n        Next i\n        \n        If hatUpdate Then rs.update\n    End If\n    rs.Close\nEnd Sub\n\nPrivate Sub ErstelleSchichten( _\n    ByVal AuftragsID As Long, _\n    ByVal vaDatumIDs As Collection, _\n    ByVal schichtDefinition As String, _\n    ByVal basisDatum As Date, _\n    ByVal Ersteller As String)\n    \nOn Error GoTo ErrorHandler\n    \n    Dim schichtTeile() As String\n    schichtTeile = Split(schichtDefinition, \",\")\n    \n    Dim teil As Variant\n    Dim PosNr As Integer: PosNr = 1\n    \n    For Each teil In schichtTeile\n        teil = Trim(teil)\n        \n        Dim Anzahl As Integer: Anzahl = 1\n        Dim zeitBereich As String\n        \n        If InStr(teil, \"x \") > 0 Then\n            Anzahl = CInt(Split(teil, \"x \")(0))\n            zeitBereich = Trim(Split(teil, \"x \")(1))\n        Else\n            zeitBereich = teil\n        End If\n        \n        If InStr(zeitBereich, \"-\") > 0 Then\n            Dim startzeit As String, endzeit As String\n            startzeit = Trim(Split(zeitBereich, \"-\")(0))\n            endzeit = Trim(Split(zeitBereich, \"-\")(1))\n            \n            Dim i As Integer, j As Integer\n            For j = 0 To vaDatumIDs.Count - 1\n                Dim aktDatum As Date\n                aktDatum = DateAdd(\"d\", j, basisDatum)\n                Dim datumKey As String\n                datumKey = Format(aktDatum, \"yyyy-mm-dd\")\n                \n                Dim vaDatumID As Long\n                vaDatumID = vaDatumIDs(datumKey)\n                \n                For i = 1 To Anzahl\n                    Dim sql As String\n                    sql = \"INSERT INTO tbl_VA_Start \" & _\n                          \"(VA_ID, VADatum_ID, VADatum, MA_Anzahl, \" & _\n                          \"VA_Start, VA_Ende, MVA_Start, MVA_Ende) \" & _\n                          \"VALUES (\" & _\n                          AuftragsID & \", \" & vaDatumID & \", \" & _\n                          \"#\" & DatumFuerSQL(aktDatum) & \"#, 1, \" & _\n                          \"#\" & startzeit & \":00#, #\" & endzeit & \":00#, \" & _\n                          \"#\" & DatumFuerSQL(aktDatum) & \" \" & startzeit & \":00#, \" & _\n                          \"#\" & DatumFuerSQL(aktDatum) & \" \" & endzeit & \":00#)\"\n                    \n                    CurrentDb.Execute sql, dbFailOnError\n                    \n                    Dim rs As DAO.Recordset\n                    Set rs = CurrentDb.OpenRecordset( _\n                        \"SELECT MAX(ID) AS NewID FROM tbl_VA_Start WHERE VA_ID = \" & AuftragsID)\n                    \n                    Dim vaStartID As Long\n                    If Not rs.EOF Then vaStartID = Nz(rs.fields(\"NewID\").Value, 0)\n                    rs.Close\n                    \n                    If vaStartID > 0 Then\n                        sql = \"INSERT INTO tbl_MA_VA_Zuordnung \" & _\n                              \"(VA_ID, VADatum_ID, VAStart_ID, VADatum, PosNr, \" & _\n                              \"MVA_Start, MVA_Ende, Erst_von, Erst_am) \" & _\n                              \"VALUES (\" & _\n                              AuftragsID & \", \" & vaDatumID & \", \" & vaStartID & \", \" & _\n                              \"#\" & DatumFuerSQL(aktDatum) & \"#, \" & PosNr & \", \" & _\n                              \"#\" & DatumFuerSQL(aktDatum) & \" \" & startzeit & \":00#, \" & _\n                              \"#\" & DatumFuerSQL(aktDatum) & \" \" & endzeit & \":00#, \" & _\n                              \"'\" & Ersteller & \"', Now())\"\n                        \n                        CurrentDb.Execute sql, dbFailOnError\n                        PosNr = PosNr + 1\n                    End If\n                Next i\n            Next j\n        End If\n    Next teil\n    \n    Exit Sub\nErrorHandler:\n    Debug.Print \"Schicht-Fehler: \" & err.description\nEnd Sub\n\nPrivate Function GetKundenID(ByVal kundenName As String) As Long\nOn Error Resume Next\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT kun_Id FROM tbl_KD_Kundenstamm \" & _\n        \"WHERE kun_Firma LIKE '%\" & SQLSafe(kundenName) & \"%'\")\n    \n    If Not rs.EOF Then\n        GetKundenID = rs.fields(\"kun_Id\").Value\n    Else\n        GetKundenID = 0\n    End If\n    rs.Close\nEnd Function\n\nPrivate Function SQLSafe(ByVal Text As String) As String\n    SQLSafe = Replace(Text, \"'\", \"''\")\nEnd Function\n\nPublic Function ValidiereAuftrag(ByVal AuftragsID As Long) As String\nOn Error GoTo ErrorHandler\n    Dim rs As DAO.Recordset\n    Dim fehler As String: fehler = \"\"\n    \n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT Ort FROM tbl_VA_Auftragstamm WHERE ID = \" & AuftragsID)\n    If Not rs.EOF Then\n        If Len(Trim(Nz(rs!Ort, \"\"))) = 0 Then fehler = fehler & \"Ort leer; \"\n    End If\n    rs.Close\n    \n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT COUNT(*) AS Anzahl FROM tbl_VA_AnzTage WHERE VA_ID = \" & AuftragsID)\n    If rs!Anzahl = 0 Then fehler = fehler & \"Keine AnzTage; \"\n    rs.Close\n    \n    If Len(fehler) > 0 Then\n        ValidiereAuftrag = \"WARNUNG: \" & fehler\n    Else\n        ValidiereAuftrag = \"SUCCESS\"\n    End If\n    Exit Function\nErrorHandler:\n    ValidiereAuftrag = \"FEHLER: \" & err.description\nEnd Function\n\nPublic Function KorrigiereAuftragBooleans(ByVal AuftragsID As Long) As String\nOn Error GoTo ErrorHandler\n    Call AktiviereAuftragBooleanFelder(AuftragsID)\n    Call GarantiereOrtFeld(AuftragsID, \"\")\n    \n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset( _\n        \"SELECT COUNT(*) AS Anzahl FROM tbl_VA_AnzTage WHERE VA_ID = \" & AuftragsID)\n    \n    If rs!Anzahl = 0 Then\n        KorrigiereAuftragBooleans = \"WARNUNG: Keine AnzTage\"\n    Else\n        KorrigiereAuftragBooleans = \"SUCCESS\"\n    End If\n    rs.Close\n    Exit Function\nErrorHandler:\n    KorrigiereAuftragBooleans = \"FEHLER: \" & err.description\nEnd Function\n\nPublic Function KorrigiereLetztenAuftrag() As String\nOn Error GoTo ErrorHandler\n    Dim rs As DAO.Recordset\n    Set rs = CurrentDb.OpenRecordset(\"SELECT MAX(ID) AS LastID FROM tbl_VA_Auftragstamm\")\n    If Not rs.EOF Then\n        KorrigiereLetztenAuftrag = KorrigiereAuftragBooleans(rs.fields(\"LastID\").Value)\n    Else\n        KorrigiereLetztenAuftrag = \"FEHLER: Kein Auftrag gefunden\"\n    End If\n    rs.Close\n    Exit Function\nErrorHandler:\n    KorrigiereLetztenAuftrag = \"FEHLER: \" & err.description\nEnd Function\n\n"}
